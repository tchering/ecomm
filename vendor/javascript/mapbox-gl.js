// mapbox-gl@3.10.0 downloaded from https://ga.jspm.io/npm:mapbox-gl@3.10.0/dist/mapbox-gl.js

var F=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var Ae={};(function(F,Oe){Ae=Oe()})(0,(function(){var Ae,Oe,Fe;function define(F,Ve){if(Ae)if(Oe){var qe="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+Ae+")(sharedChunk); ("+Oe+")(sharedChunk); self.onerror = null;";var pt={};Ae(pt);Fe=Ve(pt);typeof window!=="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(Fe.workerUrl=window.URL.createObjectURL(new Blob([qe],{type:"text/javascript"})))}else Oe=Ve;else Ae=Ve}define(["exports"],(function(Ae){function e(F){return F&&F.__esModule&&Object.prototype.hasOwnProperty.call(F,"default")?F.default:F}var Oe,Fe={},Ve={};function a(){if(Oe)return Ve;Oe=1,Object.defineProperty(Ve,"__esModule",{value:!0}),Ve.setMatrixArrayType=function(F){Ve.ARRAY_TYPE=Ae=F},Ve.toRadian=function(F){return F*qe},Ve.equals=function(Ae,Oe){return Math.abs(Ae-Oe)<=F*Math.max(1,Math.abs(Ae),Math.abs(Oe))},Ve.RANDOM=Ve.ARRAY_TYPE=Ve.EPSILON=void 0;var F=1e-6;Ve.EPSILON=F;var Ae="undefined"!=typeof Float32Array?Float32Array:Array;Ve.ARRAY_TYPE=Ae;var Fe=Math.random;Ve.RANDOM=Fe;var qe=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var F=0,Ae=arguments.length;Ae--;)F+=arguments[Ae]*arguments[Ae];return Math.sqrt(F)}),Ve}var qe,pt={};function l(){if(qe)return pt;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}qe=1,Object.defineProperty(pt,"__esModule",{value:!0}),pt.create=function(){var Ae=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(Ae[1]=0,Ae[2]=0),Ae[0]=1,Ae[3]=1,Ae},pt.clone=function(Ae){var Oe=new F.ARRAY_TYPE(4);return Oe[0]=Ae[0],Oe[1]=Ae[1],Oe[2]=Ae[2],Oe[3]=Ae[3],Oe},pt.copy=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F[3]=Ae[3],F},pt.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F},pt.fromValues=function(Ae,Oe,Fe,Ve){var qe=new F.ARRAY_TYPE(4);return qe[0]=Ae,qe[1]=Oe,qe[2]=Fe,qe[3]=Ve,qe},pt.set=function(F,Ae,Oe,Fe,Ve){return F[0]=Ae,F[1]=Oe,F[2]=Fe,F[3]=Ve,F},pt.transpose=function(F,Ae){if(F===Ae){var Oe=Ae[1];F[1]=Ae[2],F[2]=Oe}else F[0]=Ae[0],F[1]=Ae[2],F[2]=Ae[1],F[3]=Ae[3];return F},pt.invert=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Oe*qe-Ve*Fe;return pt?(F[0]=qe*(pt=1/pt),F[1]=-Fe*pt,F[2]=-Ve*pt,F[3]=Oe*pt,F):null},pt.adjoint=function(F,Ae){var Oe=Ae[0];return F[0]=Ae[3],F[1]=-Ae[1],F[2]=-Ae[2],F[3]=Oe,F},pt.determinant=function(F){return F[0]*F[3]-F[2]*F[1]},pt.multiply=n,pt.rotate=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Math.sin(Oe),zt=Math.cos(Oe);return F[0]=Fe*zt+qe*vt,F[1]=Ve*zt+pt*vt,F[2]=Fe*-vt+qe*zt,F[3]=Ve*-vt+pt*zt,F},pt.scale=function(F,Ae,Oe){var Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Oe[0],vt=Oe[1];return F[0]=Ae[0]*pt,F[1]=Fe*pt,F[2]=Ve*vt,F[3]=qe*vt,F},pt.fromRotation=function(F,Ae){var Oe=Math.sin(Ae),Fe=Math.cos(Ae);return F[0]=Fe,F[1]=Oe,F[2]=-Oe,F[3]=Fe,F},pt.fromScaling=function(F,Ae){return F[0]=Ae[0],F[1]=0,F[2]=0,F[3]=Ae[1],F},pt.str=function(F){return"mat2("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},pt.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3])},pt.LDU=function(F,Ae,Oe,Fe){return F[2]=Fe[2]/Fe[0],Oe[0]=Fe[0],Oe[1]=Fe[1],Oe[3]=Fe[3]-F[2]*Oe[1],[F,Ae,Oe]},pt.add=function(F,Ae,Oe){return F[0]=Ae[0]+Oe[0],F[1]=Ae[1]+Oe[1],F[2]=Ae[2]+Oe[2],F[3]=Ae[3]+Oe[3],F},pt.subtract=i,pt.exactEquals=function(F,Ae){return F[0]===Ae[0]&&F[1]===Ae[1]&&F[2]===Ae[2]&&F[3]===Ae[3]},pt.equals=function(Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Oe[0],zt=Oe[1],ri=Oe[2],xi=Oe[3];return Math.abs(Fe-vt)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(vt))&&Math.abs(Ve-zt)<=F.EPSILON*Math.max(1,Math.abs(Ve),Math.abs(zt))&&Math.abs(qe-ri)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(ri))&&Math.abs(pt-xi)<=F.EPSILON*Math.max(1,Math.abs(pt),Math.abs(xi))},pt.multiplyScalar=function(F,Ae,Oe){return F[0]=Ae[0]*Oe,F[1]=Ae[1]*Oe,F[2]=Ae[2]*Oe,F[3]=Ae[3]*Oe,F},pt.multiplyScalarAndAdd=function(F,Ae,Oe,Fe){return F[0]=Ae[0]+Oe[0]*Fe,F[1]=Ae[1]+Oe[1]*Fe,F[2]=Ae[2]+Oe[2]*Fe,F[3]=Ae[3]+Oe[3]*Fe,F},pt.sub=pt.mul=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Ae=r(void 0);if(Ae&&Ae.has(F))return Ae.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ve in F)if("default"!==Ve&&Object.prototype.hasOwnProperty.call(F,Ve)){var qe=Fe?Object.getOwnPropertyDescriptor(F,Ve):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,Ve,qe):Oe[Ve]=F[Ve]}return Oe.default=F,Ae&&Ae.set(F,Oe),Oe}(a());function r(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Ae})(F)}function n(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Oe[0],zt=Oe[1],ri=Oe[2],xi=Oe[3];return F[0]=Fe*vt+qe*zt,F[1]=Ve*vt+pt*zt,F[2]=Fe*ri+qe*xi,F[3]=Ve*ri+pt*xi,F}function i(F,Ae,Oe){return F[0]=Ae[0]-Oe[0],F[1]=Ae[1]-Oe[1],F[2]=Ae[2]-Oe[2],F[3]=Ae[3]-Oe[3],F}return pt.mul=n,pt.sub=i,pt}var vt,zt={};function h(){if(vt)return zt;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}vt=1,Object.defineProperty(zt,"__esModule",{value:!0}),zt.create=function(){var Ae=new F.ARRAY_TYPE(6);return F.ARRAY_TYPE!=Float32Array&&(Ae[1]=0,Ae[2]=0,Ae[4]=0,Ae[5]=0),Ae[0]=1,Ae[3]=1,Ae},zt.clone=function(Ae){var Oe=new F.ARRAY_TYPE(6);return Oe[0]=Ae[0],Oe[1]=Ae[1],Oe[2]=Ae[2],Oe[3]=Ae[3],Oe[4]=Ae[4],Oe[5]=Ae[5],Oe},zt.copy=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F[3]=Ae[3],F[4]=Ae[4],F[5]=Ae[5],F},zt.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F[4]=0,F[5]=0,F},zt.fromValues=function(Ae,Oe,Fe,Ve,qe,pt){var vt=new F.ARRAY_TYPE(6);return vt[0]=Ae,vt[1]=Oe,vt[2]=Fe,vt[3]=Ve,vt[4]=qe,vt[5]=pt,vt},zt.set=function(F,Ae,Oe,Fe,Ve,qe,pt){return F[0]=Ae,F[1]=Oe,F[2]=Fe,F[3]=Ve,F[4]=qe,F[5]=pt,F},zt.invert=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Ae[4],vt=Ae[5],zt=Oe*qe-Fe*Ve;return zt?(F[0]=qe*(zt=1/zt),F[1]=-Fe*zt,F[2]=-Ve*zt,F[3]=Oe*zt,F[4]=(Ve*vt-qe*pt)*zt,F[5]=(Fe*pt-Oe*vt)*zt,F):null},zt.determinant=function(F){return F[0]*F[3]-F[1]*F[2]},zt.multiply=n,zt.rotate=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Math.sin(Oe),xi=Math.cos(Oe);return F[0]=Fe*xi+qe*ri,F[1]=Ve*xi+pt*ri,F[2]=Fe*-ri+qe*xi,F[3]=Ve*-ri+pt*xi,F[4]=vt,F[5]=zt,F},zt.scale=function(F,Ae,Oe){var Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Ae[4],vt=Ae[5],zt=Oe[0],ri=Oe[1];return F[0]=Ae[0]*zt,F[1]=Fe*zt,F[2]=Ve*ri,F[3]=qe*ri,F[4]=pt,F[5]=vt,F},zt.translate=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Oe[0],xi=Oe[1];return F[0]=Fe,F[1]=Ve,F[2]=qe,F[3]=pt,F[4]=Fe*ri+qe*xi+vt,F[5]=Ve*ri+pt*xi+zt,F},zt.fromRotation=function(F,Ae){var Oe=Math.sin(Ae),Fe=Math.cos(Ae);return F[0]=Fe,F[1]=Oe,F[2]=-Oe,F[3]=Fe,F[4]=0,F[5]=0,F},zt.fromScaling=function(F,Ae){return F[0]=Ae[0],F[1]=0,F[2]=0,F[3]=Ae[1],F[4]=0,F[5]=0,F},zt.fromTranslation=function(F,Ae){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F[4]=Ae[0],F[5]=Ae[1],F},zt.str=function(F){return"mat2d("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+")"},zt.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],1)},zt.add=function(F,Ae,Oe){return F[0]=Ae[0]+Oe[0],F[1]=Ae[1]+Oe[1],F[2]=Ae[2]+Oe[2],F[3]=Ae[3]+Oe[3],F[4]=Ae[4]+Oe[4],F[5]=Ae[5]+Oe[5],F},zt.subtract=i,zt.multiplyScalar=function(F,Ae,Oe){return F[0]=Ae[0]*Oe,F[1]=Ae[1]*Oe,F[2]=Ae[2]*Oe,F[3]=Ae[3]*Oe,F[4]=Ae[4]*Oe,F[5]=Ae[5]*Oe,F},zt.multiplyScalarAndAdd=function(F,Ae,Oe,Fe){return F[0]=Ae[0]+Oe[0]*Fe,F[1]=Ae[1]+Oe[1]*Fe,F[2]=Ae[2]+Oe[2]*Fe,F[3]=Ae[3]+Oe[3]*Fe,F[4]=Ae[4]+Oe[4]*Fe,F[5]=Ae[5]+Oe[5]*Fe,F},zt.exactEquals=function(F,Ae){return F[0]===Ae[0]&&F[1]===Ae[1]&&F[2]===Ae[2]&&F[3]===Ae[3]&&F[4]===Ae[4]&&F[5]===Ae[5]},zt.equals=function(Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Oe[0],xi=Oe[1],bi=Oe[2],wi=Oe[3],dr=Oe[4],jr=Oe[5];return Math.abs(Fe-ri)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(ri))&&Math.abs(Ve-xi)<=F.EPSILON*Math.max(1,Math.abs(Ve),Math.abs(xi))&&Math.abs(qe-bi)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(bi))&&Math.abs(pt-wi)<=F.EPSILON*Math.max(1,Math.abs(pt),Math.abs(wi))&&Math.abs(vt-dr)<=F.EPSILON*Math.max(1,Math.abs(vt),Math.abs(dr))&&Math.abs(zt-jr)<=F.EPSILON*Math.max(1,Math.abs(zt),Math.abs(jr))},zt.sub=zt.mul=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Ae=r(void 0);if(Ae&&Ae.has(F))return Ae.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ve in F)if("default"!==Ve&&Object.prototype.hasOwnProperty.call(F,Ve)){var qe=Fe?Object.getOwnPropertyDescriptor(F,Ve):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,Ve,qe):Oe[Ve]=F[Ve]}return Oe.default=F,Ae&&Ae.set(F,Oe),Oe}(a());function r(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Ae})(F)}function n(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Oe[0],xi=Oe[1],bi=Oe[2],wi=Oe[3],dr=Oe[4],jr=Oe[5];return F[0]=Fe*ri+qe*xi,F[1]=Ve*ri+pt*xi,F[2]=Fe*bi+qe*wi,F[3]=Ve*bi+pt*wi,F[4]=Fe*dr+qe*jr+vt,F[5]=Ve*dr+pt*jr+zt,F}function i(F,Ae,Oe){return F[0]=Ae[0]-Oe[0],F[1]=Ae[1]-Oe[1],F[2]=Ae[2]-Oe[2],F[3]=Ae[3]-Oe[3],F[4]=Ae[4]-Oe[4],F[5]=Ae[5]-Oe[5],F}return zt.mul=n,zt.sub=i,zt}var ri,xi={};function d(){if(ri)return xi;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}ri=1,Object.defineProperty(xi,"__esModule",{value:!0}),xi.create=function(){var Ae=new F.ARRAY_TYPE(9);return F.ARRAY_TYPE!=Float32Array&&(Ae[1]=0,Ae[2]=0,Ae[3]=0,Ae[5]=0,Ae[6]=0,Ae[7]=0),Ae[0]=1,Ae[4]=1,Ae[8]=1,Ae},xi.fromMat4=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F[3]=Ae[4],F[4]=Ae[5],F[5]=Ae[6],F[6]=Ae[8],F[7]=Ae[9],F[8]=Ae[10],F},xi.clone=function(Ae){var Oe=new F.ARRAY_TYPE(9);return Oe[0]=Ae[0],Oe[1]=Ae[1],Oe[2]=Ae[2],Oe[3]=Ae[3],Oe[4]=Ae[4],Oe[5]=Ae[5],Oe[6]=Ae[6],Oe[7]=Ae[7],Oe[8]=Ae[8],Oe},xi.copy=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F[3]=Ae[3],F[4]=Ae[4],F[5]=Ae[5],F[6]=Ae[6],F[7]=Ae[7],F[8]=Ae[8],F},xi.fromValues=function(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri){var xi=new F.ARRAY_TYPE(9);return xi[0]=Ae,xi[1]=Oe,xi[2]=Fe,xi[3]=Ve,xi[4]=qe,xi[5]=pt,xi[6]=vt,xi[7]=zt,xi[8]=ri,xi},xi.set=function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri){return F[0]=Ae,F[1]=Oe,F[2]=Fe,F[3]=Ve,F[4]=qe,F[5]=pt,F[6]=vt,F[7]=zt,F[8]=ri,F},xi.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=1,F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},xi.transpose=function(F,Ae){if(F===Ae){var Oe=Ae[1],Fe=Ae[2],Ve=Ae[5];F[1]=Ae[3],F[2]=Ae[6],F[3]=Oe,F[5]=Ae[7],F[6]=Fe,F[7]=Ve}else F[0]=Ae[0],F[1]=Ae[3],F[2]=Ae[6],F[3]=Ae[1],F[4]=Ae[4],F[5]=Ae[7],F[6]=Ae[2],F[7]=Ae[5],F[8]=Ae[8];return F},xi.invert=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Ae[4],vt=Ae[5],zt=Ae[6],ri=Ae[7],xi=Ae[8],bi=xi*pt-vt*ri,wi=-xi*qe+vt*zt,dr=ri*qe-pt*zt,jr=Oe*bi+Fe*wi+Ve*dr;return jr?(F[0]=bi*(jr=1/jr),F[1]=(-xi*Fe+Ve*ri)*jr,F[2]=(vt*Fe-Ve*pt)*jr,F[3]=wi*jr,F[4]=(xi*Oe-Ve*zt)*jr,F[5]=(-vt*Oe+Ve*qe)*jr,F[6]=dr*jr,F[7]=(-ri*Oe+Fe*zt)*jr,F[8]=(pt*Oe-Fe*qe)*jr,F):null},xi.adjoint=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Ae[4],vt=Ae[5],zt=Ae[6],ri=Ae[7],xi=Ae[8];return F[0]=pt*xi-vt*ri,F[1]=Ve*ri-Fe*xi,F[2]=Fe*vt-Ve*pt,F[3]=vt*zt-qe*xi,F[4]=Oe*xi-Ve*zt,F[5]=Ve*qe-Oe*vt,F[6]=qe*ri-pt*zt,F[7]=Fe*zt-Oe*ri,F[8]=Oe*pt-Fe*qe,F},xi.determinant=function(F){var Ae=F[3],Oe=F[4],Fe=F[5],Ve=F[6],qe=F[7],pt=F[8];return F[0]*(pt*Oe-Fe*qe)+F[1]*(-pt*Ae+Fe*Ve)+F[2]*(qe*Ae-Oe*Ve)},xi.multiply=n,xi.translate=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Ae[6],xi=Ae[7],bi=Ae[8],wi=Oe[0],dr=Oe[1];return F[0]=Fe,F[1]=Ve,F[2]=qe,F[3]=pt,F[4]=vt,F[5]=zt,F[6]=wi*Fe+dr*pt+ri,F[7]=wi*Ve+dr*vt+xi,F[8]=wi*qe+dr*zt+bi,F},xi.rotate=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Ae[6],xi=Ae[7],bi=Ae[8],wi=Math.sin(Oe),dr=Math.cos(Oe);return F[0]=dr*Fe+wi*pt,F[1]=dr*Ve+wi*vt,F[2]=dr*qe+wi*zt,F[3]=dr*pt-wi*Fe,F[4]=dr*vt-wi*Ve,F[5]=dr*zt-wi*qe,F[6]=ri,F[7]=xi,F[8]=bi,F},xi.scale=function(F,Ae,Oe){var Fe=Oe[0],Ve=Oe[1];return F[0]=Fe*Ae[0],F[1]=Fe*Ae[1],F[2]=Fe*Ae[2],F[3]=Ve*Ae[3],F[4]=Ve*Ae[4],F[5]=Ve*Ae[5],F[6]=Ae[6],F[7]=Ae[7],F[8]=Ae[8],F},xi.fromTranslation=function(F,Ae){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=1,F[5]=0,F[6]=Ae[0],F[7]=Ae[1],F[8]=1,F},xi.fromRotation=function(F,Ae){var Oe=Math.sin(Ae),Fe=Math.cos(Ae);return F[0]=Fe,F[1]=Oe,F[2]=0,F[3]=-Oe,F[4]=Fe,F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},xi.fromScaling=function(F,Ae){return F[0]=Ae[0],F[1]=0,F[2]=0,F[3]=0,F[4]=Ae[1],F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},xi.fromMat2d=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=0,F[3]=Ae[2],F[4]=Ae[3],F[5]=0,F[6]=Ae[4],F[7]=Ae[5],F[8]=1,F},xi.fromQuat=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Oe+Oe,vt=Fe+Fe,zt=Ve+Ve,ri=Oe*pt,xi=Fe*pt,bi=Fe*vt,wi=Ve*pt,dr=Ve*vt,jr=Ve*zt,Qr=qe*pt,Xn=qe*vt,ho=qe*zt;return F[0]=1-bi-jr,F[3]=xi-ho,F[6]=wi+Xn,F[1]=xi+ho,F[4]=1-ri-jr,F[7]=dr-Qr,F[2]=wi-Xn,F[5]=dr+Qr,F[8]=1-ri-bi,F},xi.normalFromMat4=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Ae[4],vt=Ae[5],zt=Ae[6],ri=Ae[7],xi=Ae[8],bi=Ae[9],wi=Ae[10],dr=Ae[11],jr=Ae[12],Qr=Ae[13],Xn=Ae[14],ho=Ae[15],yo=Oe*vt-Fe*pt,zo=Oe*zt-Ve*pt,ko=Oe*ri-qe*pt,Uo=Fe*zt-Ve*vt,ia=Fe*ri-qe*vt,_a=Ve*ri-qe*zt,Ma=xi*Qr-bi*jr,Ea=xi*Xn-wi*jr,Ia=xi*ho-dr*jr,rl=bi*Xn-wi*Qr,Sl=bi*ho-dr*Qr,Il=wi*ho-dr*Xn,Kl=yo*Il-zo*Sl+ko*rl+Uo*Ia-ia*Ea+_a*Ma;return Kl?(F[0]=(vt*Il-zt*Sl+ri*rl)*(Kl=1/Kl),F[1]=(zt*Ia-pt*Il-ri*Ea)*Kl,F[2]=(pt*Sl-vt*Ia+ri*Ma)*Kl,F[3]=(Ve*Sl-Fe*Il-qe*rl)*Kl,F[4]=(Oe*Il-Ve*Ia+qe*Ea)*Kl,F[5]=(Fe*Ia-Oe*Sl-qe*Ma)*Kl,F[6]=(Qr*_a-Xn*ia+ho*Uo)*Kl,F[7]=(Xn*ko-jr*_a-ho*zo)*Kl,F[8]=(jr*ia-Qr*ko+ho*yo)*Kl,F):null},xi.projection=function(F,Ae,Oe){return F[0]=2/Ae,F[1]=0,F[2]=0,F[3]=0,F[4]=-2/Oe,F[5]=0,F[6]=-1,F[7]=1,F[8]=1,F},xi.str=function(F){return"mat3("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+", "+F[8]+")"},xi.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8])},xi.add=function(F,Ae,Oe){return F[0]=Ae[0]+Oe[0],F[1]=Ae[1]+Oe[1],F[2]=Ae[2]+Oe[2],F[3]=Ae[3]+Oe[3],F[4]=Ae[4]+Oe[4],F[5]=Ae[5]+Oe[5],F[6]=Ae[6]+Oe[6],F[7]=Ae[7]+Oe[7],F[8]=Ae[8]+Oe[8],F},xi.subtract=i,xi.multiplyScalar=function(F,Ae,Oe){return F[0]=Ae[0]*Oe,F[1]=Ae[1]*Oe,F[2]=Ae[2]*Oe,F[3]=Ae[3]*Oe,F[4]=Ae[4]*Oe,F[5]=Ae[5]*Oe,F[6]=Ae[6]*Oe,F[7]=Ae[7]*Oe,F[8]=Ae[8]*Oe,F},xi.multiplyScalarAndAdd=function(F,Ae,Oe,Fe){return F[0]=Ae[0]+Oe[0]*Fe,F[1]=Ae[1]+Oe[1]*Fe,F[2]=Ae[2]+Oe[2]*Fe,F[3]=Ae[3]+Oe[3]*Fe,F[4]=Ae[4]+Oe[4]*Fe,F[5]=Ae[5]+Oe[5]*Fe,F[6]=Ae[6]+Oe[6]*Fe,F[7]=Ae[7]+Oe[7]*Fe,F[8]=Ae[8]+Oe[8]*Fe,F},xi.exactEquals=function(F,Ae){return F[0]===Ae[0]&&F[1]===Ae[1]&&F[2]===Ae[2]&&F[3]===Ae[3]&&F[4]===Ae[4]&&F[5]===Ae[5]&&F[6]===Ae[6]&&F[7]===Ae[7]&&F[8]===Ae[8]},xi.equals=function(Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Ae[6],xi=Ae[7],bi=Ae[8],wi=Oe[0],dr=Oe[1],jr=Oe[2],Qr=Oe[3],Xn=Oe[4],ho=Oe[5],yo=Oe[6],zo=Oe[7],ko=Oe[8];return Math.abs(Fe-wi)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(wi))&&Math.abs(Ve-dr)<=F.EPSILON*Math.max(1,Math.abs(Ve),Math.abs(dr))&&Math.abs(qe-jr)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(jr))&&Math.abs(pt-Qr)<=F.EPSILON*Math.max(1,Math.abs(pt),Math.abs(Qr))&&Math.abs(vt-Xn)<=F.EPSILON*Math.max(1,Math.abs(vt),Math.abs(Xn))&&Math.abs(zt-ho)<=F.EPSILON*Math.max(1,Math.abs(zt),Math.abs(ho))&&Math.abs(ri-yo)<=F.EPSILON*Math.max(1,Math.abs(ri),Math.abs(yo))&&Math.abs(xi-zo)<=F.EPSILON*Math.max(1,Math.abs(xi),Math.abs(zo))&&Math.abs(bi-ko)<=F.EPSILON*Math.max(1,Math.abs(bi),Math.abs(ko))},xi.sub=xi.mul=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Ae=r(void 0);if(Ae&&Ae.has(F))return Ae.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ve in F)if("default"!==Ve&&Object.prototype.hasOwnProperty.call(F,Ve)){var qe=Fe?Object.getOwnPropertyDescriptor(F,Ve):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,Ve,qe):Oe[Ve]=F[Ve]}return Oe.default=F,Ae&&Ae.set(F,Oe),Oe}(a());function r(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Ae})(F)}function n(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Ae[6],xi=Ae[7],bi=Ae[8],wi=Oe[0],dr=Oe[1],jr=Oe[2],Qr=Oe[3],Xn=Oe[4],ho=Oe[5],yo=Oe[6],zo=Oe[7],ko=Oe[8];return F[0]=wi*Fe+dr*pt+jr*ri,F[1]=wi*Ve+dr*vt+jr*xi,F[2]=wi*qe+dr*zt+jr*bi,F[3]=Qr*Fe+Xn*pt+ho*ri,F[4]=Qr*Ve+Xn*vt+ho*xi,F[5]=Qr*qe+Xn*zt+ho*bi,F[6]=yo*Fe+zo*pt+ko*ri,F[7]=yo*Ve+zo*vt+ko*xi,F[8]=yo*qe+zo*zt+ko*bi,F}function i(F,Ae,Oe){return F[0]=Ae[0]-Oe[0],F[1]=Ae[1]-Oe[1],F[2]=Ae[2]-Oe[2],F[3]=Ae[3]-Oe[3],F[4]=Ae[4]-Oe[4],F[5]=Ae[5]-Oe[5],F[6]=Ae[6]-Oe[6],F[7]=Ae[7]-Oe[7],F[8]=Ae[8]-Oe[8],F}return xi.mul=n,xi.sub=i,xi}var bi,wi={};function g(){if(bi)return wi;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}bi=1,Object.defineProperty(wi,"__esModule",{value:!0}),wi.create=function(){var Ae=new F.ARRAY_TYPE(16);return F.ARRAY_TYPE!=Float32Array&&(Ae[1]=0,Ae[2]=0,Ae[3]=0,Ae[4]=0,Ae[6]=0,Ae[7]=0,Ae[8]=0,Ae[9]=0,Ae[11]=0,Ae[12]=0,Ae[13]=0,Ae[14]=0),Ae[0]=1,Ae[5]=1,Ae[10]=1,Ae[15]=1,Ae},wi.clone=function(Ae){var Oe=new F.ARRAY_TYPE(16);return Oe[0]=Ae[0],Oe[1]=Ae[1],Oe[2]=Ae[2],Oe[3]=Ae[3],Oe[4]=Ae[4],Oe[5]=Ae[5],Oe[6]=Ae[6],Oe[7]=Ae[7],Oe[8]=Ae[8],Oe[9]=Ae[9],Oe[10]=Ae[10],Oe[11]=Ae[11],Oe[12]=Ae[12],Oe[13]=Ae[13],Oe[14]=Ae[14],Oe[15]=Ae[15],Oe},wi.copy=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F[3]=Ae[3],F[4]=Ae[4],F[5]=Ae[5],F[6]=Ae[6],F[7]=Ae[7],F[8]=Ae[8],F[9]=Ae[9],F[10]=Ae[10],F[11]=Ae[11],F[12]=Ae[12],F[13]=Ae[13],F[14]=Ae[14],F[15]=Ae[15],F},wi.fromValues=function(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn){var ho=new F.ARRAY_TYPE(16);return ho[0]=Ae,ho[1]=Oe,ho[2]=Fe,ho[3]=Ve,ho[4]=qe,ho[5]=pt,ho[6]=vt,ho[7]=zt,ho[8]=ri,ho[9]=xi,ho[10]=bi,ho[11]=wi,ho[12]=dr,ho[13]=jr,ho[14]=Qr,ho[15]=Xn,ho},wi.set=function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn){return F[0]=Ae,F[1]=Oe,F[2]=Fe,F[3]=Ve,F[4]=qe,F[5]=pt,F[6]=vt,F[7]=zt,F[8]=ri,F[9]=xi,F[10]=bi,F[11]=wi,F[12]=dr,F[13]=jr,F[14]=Qr,F[15]=Xn,F},wi.identity=n,wi.transpose=function(F,Ae){if(F===Ae){var Oe=Ae[1],Fe=Ae[2],Ve=Ae[3],qe=Ae[6],pt=Ae[7],vt=Ae[11];F[1]=Ae[4],F[2]=Ae[8],F[3]=Ae[12],F[4]=Oe,F[6]=Ae[9],F[7]=Ae[13],F[8]=Fe,F[9]=qe,F[11]=Ae[14],F[12]=Ve,F[13]=pt,F[14]=vt}else F[0]=Ae[0],F[1]=Ae[4],F[2]=Ae[8],F[3]=Ae[12],F[4]=Ae[1],F[5]=Ae[5],F[6]=Ae[9],F[7]=Ae[13],F[8]=Ae[2],F[9]=Ae[6],F[10]=Ae[10],F[11]=Ae[14],F[12]=Ae[3],F[13]=Ae[7],F[14]=Ae[11],F[15]=Ae[15];return F},wi.invert=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Ae[4],vt=Ae[5],zt=Ae[6],ri=Ae[7],xi=Ae[8],bi=Ae[9],wi=Ae[10],dr=Ae[11],jr=Ae[12],Qr=Ae[13],Xn=Ae[14],ho=Ae[15],yo=Oe*vt-Fe*pt,zo=Oe*zt-Ve*pt,ko=Oe*ri-qe*pt,Uo=Fe*zt-Ve*vt,ia=Fe*ri-qe*vt,_a=Ve*ri-qe*zt,Ma=xi*Qr-bi*jr,Ea=xi*Xn-wi*jr,Ia=xi*ho-dr*jr,rl=bi*Xn-wi*Qr,Sl=bi*ho-dr*Qr,Il=wi*ho-dr*Xn,Kl=yo*Il-zo*Sl+ko*rl+Uo*Ia-ia*Ea+_a*Ma;return Kl?(F[0]=(vt*Il-zt*Sl+ri*rl)*(Kl=1/Kl),F[1]=(Ve*Sl-Fe*Il-qe*rl)*Kl,F[2]=(Qr*_a-Xn*ia+ho*Uo)*Kl,F[3]=(wi*ia-bi*_a-dr*Uo)*Kl,F[4]=(zt*Ia-pt*Il-ri*Ea)*Kl,F[5]=(Oe*Il-Ve*Ia+qe*Ea)*Kl,F[6]=(Xn*ko-jr*_a-ho*zo)*Kl,F[7]=(xi*_a-wi*ko+dr*zo)*Kl,F[8]=(pt*Sl-vt*Ia+ri*Ma)*Kl,F[9]=(Fe*Ia-Oe*Sl-qe*Ma)*Kl,F[10]=(jr*ia-Qr*ko+ho*yo)*Kl,F[11]=(bi*ko-xi*ia-dr*yo)*Kl,F[12]=(vt*Ea-pt*rl-zt*Ma)*Kl,F[13]=(Oe*rl-Fe*Ea+Ve*Ma)*Kl,F[14]=(Qr*zo-jr*Uo-Xn*yo)*Kl,F[15]=(xi*Uo-bi*zo+wi*yo)*Kl,F):null},wi.adjoint=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Ae[4],vt=Ae[5],zt=Ae[6],ri=Ae[7],xi=Ae[8],bi=Ae[9],wi=Ae[10],dr=Ae[11],jr=Ae[12],Qr=Ae[13],Xn=Ae[14],ho=Ae[15];return F[0]=vt*(wi*ho-dr*Xn)-bi*(zt*ho-ri*Xn)+Qr*(zt*dr-ri*wi),F[1]=-(Fe*(wi*ho-dr*Xn)-bi*(Ve*ho-qe*Xn)+Qr*(Ve*dr-qe*wi)),F[2]=Fe*(zt*ho-ri*Xn)-vt*(Ve*ho-qe*Xn)+Qr*(Ve*ri-qe*zt),F[3]=-(Fe*(zt*dr-ri*wi)-vt*(Ve*dr-qe*wi)+bi*(Ve*ri-qe*zt)),F[4]=-(pt*(wi*ho-dr*Xn)-xi*(zt*ho-ri*Xn)+jr*(zt*dr-ri*wi)),F[5]=Oe*(wi*ho-dr*Xn)-xi*(Ve*ho-qe*Xn)+jr*(Ve*dr-qe*wi),F[6]=-(Oe*(zt*ho-ri*Xn)-pt*(Ve*ho-qe*Xn)+jr*(Ve*ri-qe*zt)),F[7]=Oe*(zt*dr-ri*wi)-pt*(Ve*dr-qe*wi)+xi*(Ve*ri-qe*zt),F[8]=pt*(bi*ho-dr*Qr)-xi*(vt*ho-ri*Qr)+jr*(vt*dr-ri*bi),F[9]=-(Oe*(bi*ho-dr*Qr)-xi*(Fe*ho-qe*Qr)+jr*(Fe*dr-qe*bi)),F[10]=Oe*(vt*ho-ri*Qr)-pt*(Fe*ho-qe*Qr)+jr*(Fe*ri-qe*vt),F[11]=-(Oe*(vt*dr-ri*bi)-pt*(Fe*dr-qe*bi)+xi*(Fe*ri-qe*vt)),F[12]=-(pt*(bi*Xn-wi*Qr)-xi*(vt*Xn-zt*Qr)+jr*(vt*wi-zt*bi)),F[13]=Oe*(bi*Xn-wi*Qr)-xi*(Fe*Xn-Ve*Qr)+jr*(Fe*wi-Ve*bi),F[14]=-(Oe*(vt*Xn-zt*Qr)-pt*(Fe*Xn-Ve*Qr)+jr*(Fe*zt-Ve*vt)),F[15]=Oe*(vt*wi-zt*bi)-pt*(Fe*wi-Ve*bi)+xi*(Fe*zt-Ve*vt),F},wi.determinant=function(F){var Ae=F[0],Oe=F[1],Fe=F[2],Ve=F[3],qe=F[4],pt=F[5],vt=F[6],zt=F[7],ri=F[8],xi=F[9],bi=F[10],wi=F[11],dr=F[12],jr=F[13],Qr=F[14],Xn=F[15];return(Ae*pt-Oe*qe)*(bi*Xn-wi*Qr)-(Ae*vt-Fe*qe)*(xi*Xn-wi*jr)+(Ae*zt-Ve*qe)*(xi*Qr-bi*jr)+(Oe*vt-Fe*pt)*(ri*Xn-wi*dr)-(Oe*zt-Ve*pt)*(ri*Qr-bi*dr)+(Fe*zt-Ve*vt)*(ri*jr-xi*dr)},wi.multiply=i,wi.translate=function(F,Ae,Oe){var Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr=Oe[0],Xn=Oe[1],ho=Oe[2];return Ae===F?(F[12]=Ae[0]*Qr+Ae[4]*Xn+Ae[8]*ho+Ae[12],F[13]=Ae[1]*Qr+Ae[5]*Xn+Ae[9]*ho+Ae[13],F[14]=Ae[2]*Qr+Ae[6]*Xn+Ae[10]*ho+Ae[14],F[15]=Ae[3]*Qr+Ae[7]*Xn+Ae[11]*ho+Ae[15]):(Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Ae[6],xi=Ae[7],bi=Ae[8],wi=Ae[9],dr=Ae[10],jr=Ae[11],F[0]=Fe=Ae[0],F[1]=Ve,F[2]=qe,F[3]=pt,F[4]=vt,F[5]=zt,F[6]=ri,F[7]=xi,F[8]=bi,F[9]=wi,F[10]=dr,F[11]=jr,F[12]=Fe*Qr+vt*Xn+bi*ho+Ae[12],F[13]=Ve*Qr+zt*Xn+wi*ho+Ae[13],F[14]=qe*Qr+ri*Xn+dr*ho+Ae[14],F[15]=pt*Qr+xi*Xn+jr*ho+Ae[15]),F},wi.scale=function(F,Ae,Oe){var Fe=Oe[0],Ve=Oe[1],qe=Oe[2];return F[0]=Ae[0]*Fe,F[1]=Ae[1]*Fe,F[2]=Ae[2]*Fe,F[3]=Ae[3]*Fe,F[4]=Ae[4]*Ve,F[5]=Ae[5]*Ve,F[6]=Ae[6]*Ve,F[7]=Ae[7]*Ve,F[8]=Ae[8]*qe,F[9]=Ae[9]*qe,F[10]=Ae[10]*qe,F[11]=Ae[11]*qe,F[12]=Ae[12],F[13]=Ae[13],F[14]=Ae[14],F[15]=Ae[15],F},wi.rotate=function(Ae,Oe,Fe,Ve){var qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko,Uo,ia,_a,Ma,Ea,Ia,rl,Sl,Il=Ve[0],Kl=Ve[1],Jl=Ve[2],Ql=Math.hypot(Il,Kl,Jl);return Ql<F.EPSILON?null:(Il*=Ql=1/Ql,Kl*=Ql,Jl*=Ql,qe=Math.sin(Fe),pt=Math.cos(Fe),ri=Oe[1],xi=Oe[2],bi=Oe[3],dr=Oe[5],jr=Oe[6],Qr=Oe[7],ho=Oe[9],yo=Oe[10],zo=Oe[11],ko=Il*Il*(vt=1-pt)+pt,_a=Il*Kl*vt-Jl*qe,Ma=Kl*Kl*vt+pt,Ea=Jl*Kl*vt+Il*qe,Ia=Il*Jl*vt+Kl*qe,rl=Kl*Jl*vt-Il*qe,Sl=Jl*Jl*vt+pt,Ae[0]=(zt=Oe[0])*ko+(wi=Oe[4])*(Uo=Kl*Il*vt+Jl*qe)+(Xn=Oe[8])*(ia=Jl*Il*vt-Kl*qe),Ae[1]=ri*ko+dr*Uo+ho*ia,Ae[2]=xi*ko+jr*Uo+yo*ia,Ae[3]=bi*ko+Qr*Uo+zo*ia,Ae[4]=zt*_a+wi*Ma+Xn*Ea,Ae[5]=ri*_a+dr*Ma+ho*Ea,Ae[6]=xi*_a+jr*Ma+yo*Ea,Ae[7]=bi*_a+Qr*Ma+zo*Ea,Ae[8]=zt*Ia+wi*rl+Xn*Sl,Ae[9]=ri*Ia+dr*rl+ho*Sl,Ae[10]=xi*Ia+jr*rl+yo*Sl,Ae[11]=bi*Ia+Qr*rl+zo*Sl,Oe!==Ae&&(Ae[12]=Oe[12],Ae[13]=Oe[13],Ae[14]=Oe[14],Ae[15]=Oe[15]),Ae)},wi.rotateX=function(F,Ae,Oe){var Fe=Math.sin(Oe),Ve=Math.cos(Oe),qe=Ae[4],pt=Ae[5],vt=Ae[6],zt=Ae[7],ri=Ae[8],xi=Ae[9],bi=Ae[10],wi=Ae[11];return Ae!==F&&(F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F[3]=Ae[3],F[12]=Ae[12],F[13]=Ae[13],F[14]=Ae[14],F[15]=Ae[15]),F[4]=qe*Ve+ri*Fe,F[5]=pt*Ve+xi*Fe,F[6]=vt*Ve+bi*Fe,F[7]=zt*Ve+wi*Fe,F[8]=ri*Ve-qe*Fe,F[9]=xi*Ve-pt*Fe,F[10]=bi*Ve-vt*Fe,F[11]=wi*Ve-zt*Fe,F},wi.rotateY=function(F,Ae,Oe){var Fe=Math.sin(Oe),Ve=Math.cos(Oe),qe=Ae[0],pt=Ae[1],vt=Ae[2],zt=Ae[3],ri=Ae[8],xi=Ae[9],bi=Ae[10],wi=Ae[11];return Ae!==F&&(F[4]=Ae[4],F[5]=Ae[5],F[6]=Ae[6],F[7]=Ae[7],F[12]=Ae[12],F[13]=Ae[13],F[14]=Ae[14],F[15]=Ae[15]),F[0]=qe*Ve-ri*Fe,F[1]=pt*Ve-xi*Fe,F[2]=vt*Ve-bi*Fe,F[3]=zt*Ve-wi*Fe,F[8]=qe*Fe+ri*Ve,F[9]=pt*Fe+xi*Ve,F[10]=vt*Fe+bi*Ve,F[11]=zt*Fe+wi*Ve,F},wi.rotateZ=function(F,Ae,Oe){var Fe=Math.sin(Oe),Ve=Math.cos(Oe),qe=Ae[0],pt=Ae[1],vt=Ae[2],zt=Ae[3],ri=Ae[4],xi=Ae[5],bi=Ae[6],wi=Ae[7];return Ae!==F&&(F[8]=Ae[8],F[9]=Ae[9],F[10]=Ae[10],F[11]=Ae[11],F[12]=Ae[12],F[13]=Ae[13],F[14]=Ae[14],F[15]=Ae[15]),F[0]=qe*Ve+ri*Fe,F[1]=pt*Ve+xi*Fe,F[2]=vt*Ve+bi*Fe,F[3]=zt*Ve+wi*Fe,F[4]=ri*Ve-qe*Fe,F[5]=xi*Ve-pt*Fe,F[6]=bi*Ve-vt*Fe,F[7]=wi*Ve-zt*Fe,F},wi.fromTranslation=function(F,Ae){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=Ae[0],F[13]=Ae[1],F[14]=Ae[2],F[15]=1,F},wi.fromScaling=function(F,Ae){return F[0]=Ae[0],F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=Ae[1],F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=Ae[2],F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},wi.fromRotation=function(Ae,Oe,Fe){var Ve,qe,pt,vt=Fe[0],zt=Fe[1],ri=Fe[2],xi=Math.hypot(vt,zt,ri);return xi<F.EPSILON?null:(vt*=xi=1/xi,zt*=xi,ri*=xi,Ve=Math.sin(Oe),qe=Math.cos(Oe),Ae[0]=vt*vt*(pt=1-qe)+qe,Ae[1]=zt*vt*pt+ri*Ve,Ae[2]=ri*vt*pt-zt*Ve,Ae[3]=0,Ae[4]=vt*zt*pt-ri*Ve,Ae[5]=zt*zt*pt+qe,Ae[6]=ri*zt*pt+vt*Ve,Ae[7]=0,Ae[8]=vt*ri*pt+zt*Ve,Ae[9]=zt*ri*pt-vt*Ve,Ae[10]=ri*ri*pt+qe,Ae[11]=0,Ae[12]=0,Ae[13]=0,Ae[14]=0,Ae[15]=1,Ae)},wi.fromXRotation=function(F,Ae){var Oe=Math.sin(Ae),Fe=Math.cos(Ae);return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=Fe,F[6]=Oe,F[7]=0,F[8]=0,F[9]=-Oe,F[10]=Fe,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},wi.fromYRotation=function(F,Ae){var Oe=Math.sin(Ae),Fe=Math.cos(Ae);return F[0]=Fe,F[1]=0,F[2]=-Oe,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=Oe,F[9]=0,F[10]=Fe,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},wi.fromZRotation=function(F,Ae){var Oe=Math.sin(Ae),Fe=Math.cos(Ae);return F[0]=Fe,F[1]=Oe,F[2]=0,F[3]=0,F[4]=-Oe,F[5]=Fe,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},wi.fromRotationTranslation=s,wi.fromQuat2=function(Ae,Oe){var Fe=new F.ARRAY_TYPE(3),Ve=-Oe[0],qe=-Oe[1],pt=-Oe[2],vt=Oe[3],zt=Oe[4],ri=Oe[5],xi=Oe[6],bi=Oe[7],wi=Ve*Ve+qe*qe+pt*pt+vt*vt;return wi>0?(Fe[0]=2*(zt*vt+bi*Ve+ri*pt-xi*qe)/wi,Fe[1]=2*(ri*vt+bi*qe+xi*Ve-zt*pt)/wi,Fe[2]=2*(xi*vt+bi*pt+zt*qe-ri*Ve)/wi):(Fe[0]=2*(zt*vt+bi*Ve+ri*pt-xi*qe),Fe[1]=2*(ri*vt+bi*qe+xi*Ve-zt*pt),Fe[2]=2*(xi*vt+bi*pt+zt*qe-ri*Ve)),s(Ae,Oe,Fe),Ae},wi.getTranslation=function(F,Ae){return F[0]=Ae[12],F[1]=Ae[13],F[2]=Ae[14],F},wi.getScaling=o,wi.getRotation=function(Ae,Oe){var Fe=new F.ARRAY_TYPE(3);o(Fe,Oe);var Ve=1/Fe[0],qe=1/Fe[1],pt=1/Fe[2],vt=Oe[0]*Ve,zt=Oe[1]*qe,ri=Oe[2]*pt,xi=Oe[4]*Ve,bi=Oe[5]*qe,wi=Oe[6]*pt,dr=Oe[8]*Ve,jr=Oe[9]*qe,Qr=Oe[10]*pt,Xn=vt+bi+Qr,ho=0;return Xn>0?(ho=2*Math.sqrt(Xn+1),Ae[3]=.25*ho,Ae[0]=(wi-jr)/ho,Ae[1]=(dr-ri)/ho,Ae[2]=(zt-xi)/ho):vt>bi&&vt>Qr?(ho=2*Math.sqrt(1+vt-bi-Qr),Ae[3]=(wi-jr)/ho,Ae[0]=.25*ho,Ae[1]=(zt+xi)/ho,Ae[2]=(dr+ri)/ho):bi>Qr?(ho=2*Math.sqrt(1+bi-vt-Qr),Ae[3]=(dr-ri)/ho,Ae[0]=(zt+xi)/ho,Ae[1]=.25*ho,Ae[2]=(wi+jr)/ho):(ho=2*Math.sqrt(1+Qr-vt-bi),Ae[3]=(zt-xi)/ho,Ae[0]=(dr+ri)/ho,Ae[1]=(wi+jr)/ho,Ae[2]=.25*ho),Ae},wi.fromRotationTranslationScale=function(F,Ae,Oe,Fe){var Ve=Ae[0],qe=Ae[1],pt=Ae[2],vt=Ae[3],zt=Ve+Ve,ri=qe+qe,xi=pt+pt,bi=Ve*zt,wi=Ve*ri,dr=Ve*xi,jr=qe*ri,Qr=qe*xi,Xn=pt*xi,ho=vt*zt,yo=vt*ri,zo=vt*xi,ko=Fe[0],Uo=Fe[1],ia=Fe[2];return F[0]=(1-(jr+Xn))*ko,F[1]=(wi+zo)*ko,F[2]=(dr-yo)*ko,F[3]=0,F[4]=(wi-zo)*Uo,F[5]=(1-(bi+Xn))*Uo,F[6]=(Qr+ho)*Uo,F[7]=0,F[8]=(dr+yo)*ia,F[9]=(Qr-ho)*ia,F[10]=(1-(bi+jr))*ia,F[11]=0,F[12]=Oe[0],F[13]=Oe[1],F[14]=Oe[2],F[15]=1,F},wi.fromRotationTranslationScaleOrigin=function(F,Ae,Oe,Fe,Ve){var qe=Ae[0],pt=Ae[1],vt=Ae[2],zt=Ae[3],ri=qe+qe,xi=pt+pt,bi=vt+vt,wi=qe*ri,dr=qe*xi,jr=qe*bi,Qr=pt*xi,Xn=pt*bi,ho=vt*bi,yo=zt*ri,zo=zt*xi,ko=zt*bi,Uo=Fe[0],ia=Fe[1],_a=Fe[2],Ma=Ve[0],Ea=Ve[1],Ia=Ve[2],rl=(1-(Qr+ho))*Uo,Sl=(dr+ko)*Uo,Il=(jr-zo)*Uo,Kl=(dr-ko)*ia,Jl=(1-(wi+ho))*ia,Ql=(Xn+yo)*ia,ec=(jr+zo)*_a,tc=(Xn-yo)*_a,cc=(1-(wi+Qr))*_a;return F[0]=rl,F[1]=Sl,F[2]=Il,F[3]=0,F[4]=Kl,F[5]=Jl,F[6]=Ql,F[7]=0,F[8]=ec,F[9]=tc,F[10]=cc,F[11]=0,F[12]=Oe[0]+Ma-(rl*Ma+Kl*Ea+ec*Ia),F[13]=Oe[1]+Ea-(Sl*Ma+Jl*Ea+tc*Ia),F[14]=Oe[2]+Ia-(Il*Ma+Ql*Ea+cc*Ia),F[15]=1,F},wi.fromQuat=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Oe+Oe,vt=Fe+Fe,zt=Ve+Ve,ri=Oe*pt,xi=Fe*pt,bi=Fe*vt,wi=Ve*pt,dr=Ve*vt,jr=Ve*zt,Qr=qe*pt,Xn=qe*vt,ho=qe*zt;return F[0]=1-bi-jr,F[1]=xi+ho,F[2]=wi-Xn,F[3]=0,F[4]=xi-ho,F[5]=1-ri-jr,F[6]=dr+Qr,F[7]=0,F[8]=wi+Xn,F[9]=dr-Qr,F[10]=1-ri-bi,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},wi.frustum=function(F,Ae,Oe,Fe,Ve,qe,pt){var vt=1/(Oe-Ae),zt=1/(Ve-Fe),ri=1/(qe-pt);return F[0]=2*qe*vt,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=2*qe*zt,F[6]=0,F[7]=0,F[8]=(Oe+Ae)*vt,F[9]=(Ve+Fe)*zt,F[10]=(pt+qe)*ri,F[11]=-1,F[12]=0,F[13]=0,F[14]=pt*qe*2*ri,F[15]=0,F},wi.perspectiveNO=l,wi.perspectiveZO=function(F,Ae,Oe,Fe,Ve){var qe,pt=1/Math.tan(Ae/2);return F[0]=pt/Oe,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=pt,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[11]=-1,F[12]=0,F[13]=0,F[15]=0,null!=Ve&&Ve!==1/0?(F[10]=Ve*(qe=1/(Fe-Ve)),F[14]=Ve*Fe*qe):(F[10]=-1,F[14]=-Fe),F},wi.perspectiveFromFieldOfView=function(F,Ae,Oe,Fe){var Ve=Math.tan(Ae.upDegrees*Math.PI/180),qe=Math.tan(Ae.downDegrees*Math.PI/180),pt=Math.tan(Ae.leftDegrees*Math.PI/180),vt=Math.tan(Ae.rightDegrees*Math.PI/180),zt=2/(pt+vt),ri=2/(Ve+qe);return F[0]=zt,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=ri,F[6]=0,F[7]=0,F[8]=-(pt-vt)*zt*.5,F[9]=(Ve-qe)*ri*.5,F[10]=Fe/(Oe-Fe),F[11]=-1,F[12]=0,F[13]=0,F[14]=Fe*Oe/(Oe-Fe),F[15]=0,F},wi.orthoNO=u,wi.orthoZO=function(F,Ae,Oe,Fe,Ve,qe,pt){var vt=1/(Ae-Oe),zt=1/(Fe-Ve),ri=1/(qe-pt);return F[0]=-2*vt,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=-2*zt,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=ri,F[11]=0,F[12]=(Ae+Oe)*vt,F[13]=(Ve+Fe)*zt,F[14]=qe*ri,F[15]=1,F},wi.lookAt=function(Ae,Oe,Fe,Ve){var qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr=Oe[0],Xn=Oe[1],ho=Oe[2],yo=Ve[0],zo=Ve[1],ko=Ve[2],Uo=Fe[0],ia=Fe[1],_a=Fe[2];return Math.abs(Qr-Uo)<F.EPSILON&&Math.abs(Xn-ia)<F.EPSILON&&Math.abs(ho-_a)<F.EPSILON?n(Ae):(bi=Qr-Uo,wi=Xn-ia,dr=ho-_a,qe=zo*(dr*=jr=1/Math.hypot(bi,wi,dr))-ko*(wi*=jr),pt=ko*(bi*=jr)-yo*dr,vt=yo*wi-zo*bi,(jr=Math.hypot(qe,pt,vt))?(qe*=jr=1/jr,pt*=jr,vt*=jr):(qe=0,pt=0,vt=0),zt=wi*vt-dr*pt,ri=dr*qe-bi*vt,xi=bi*pt-wi*qe,(jr=Math.hypot(zt,ri,xi))?(zt*=jr=1/jr,ri*=jr,xi*=jr):(zt=0,ri=0,xi=0),Ae[0]=qe,Ae[1]=zt,Ae[2]=bi,Ae[3]=0,Ae[4]=pt,Ae[5]=ri,Ae[6]=wi,Ae[7]=0,Ae[8]=vt,Ae[9]=xi,Ae[10]=dr,Ae[11]=0,Ae[12]=-(qe*Qr+pt*Xn+vt*ho),Ae[13]=-(zt*Qr+ri*Xn+xi*ho),Ae[14]=-(bi*Qr+wi*Xn+dr*ho),Ae[15]=1,Ae)},wi.targetTo=function(F,Ae,Oe,Fe){var Ve=Ae[0],qe=Ae[1],pt=Ae[2],vt=Fe[0],zt=Fe[1],ri=Fe[2],xi=Ve-Oe[0],bi=qe-Oe[1],wi=pt-Oe[2],dr=xi*xi+bi*bi+wi*wi;dr>0&&(xi*=dr=1/Math.sqrt(dr),bi*=dr,wi*=dr);var jr=zt*wi-ri*bi,Qr=ri*xi-vt*wi,Xn=vt*bi-zt*xi;return(dr=jr*jr+Qr*Qr+Xn*Xn)>0&&(jr*=dr=1/Math.sqrt(dr),Qr*=dr,Xn*=dr),F[0]=jr,F[1]=Qr,F[2]=Xn,F[3]=0,F[4]=bi*Xn-wi*Qr,F[5]=wi*jr-xi*Xn,F[6]=xi*Qr-bi*jr,F[7]=0,F[8]=xi,F[9]=bi,F[10]=wi,F[11]=0,F[12]=Ve,F[13]=qe,F[14]=pt,F[15]=1,F},wi.str=function(F){return"mat4("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+", "+F[8]+", "+F[9]+", "+F[10]+", "+F[11]+", "+F[12]+", "+F[13]+", "+F[14]+", "+F[15]+")"},wi.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8],F[9],F[10],F[11],F[12],F[13],F[14],F[15])},wi.add=function(F,Ae,Oe){return F[0]=Ae[0]+Oe[0],F[1]=Ae[1]+Oe[1],F[2]=Ae[2]+Oe[2],F[3]=Ae[3]+Oe[3],F[4]=Ae[4]+Oe[4],F[5]=Ae[5]+Oe[5],F[6]=Ae[6]+Oe[6],F[7]=Ae[7]+Oe[7],F[8]=Ae[8]+Oe[8],F[9]=Ae[9]+Oe[9],F[10]=Ae[10]+Oe[10],F[11]=Ae[11]+Oe[11],F[12]=Ae[12]+Oe[12],F[13]=Ae[13]+Oe[13],F[14]=Ae[14]+Oe[14],F[15]=Ae[15]+Oe[15],F},wi.subtract=c,wi.multiplyScalar=function(F,Ae,Oe){return F[0]=Ae[0]*Oe,F[1]=Ae[1]*Oe,F[2]=Ae[2]*Oe,F[3]=Ae[3]*Oe,F[4]=Ae[4]*Oe,F[5]=Ae[5]*Oe,F[6]=Ae[6]*Oe,F[7]=Ae[7]*Oe,F[8]=Ae[8]*Oe,F[9]=Ae[9]*Oe,F[10]=Ae[10]*Oe,F[11]=Ae[11]*Oe,F[12]=Ae[12]*Oe,F[13]=Ae[13]*Oe,F[14]=Ae[14]*Oe,F[15]=Ae[15]*Oe,F},wi.multiplyScalarAndAdd=function(F,Ae,Oe,Fe){return F[0]=Ae[0]+Oe[0]*Fe,F[1]=Ae[1]+Oe[1]*Fe,F[2]=Ae[2]+Oe[2]*Fe,F[3]=Ae[3]+Oe[3]*Fe,F[4]=Ae[4]+Oe[4]*Fe,F[5]=Ae[5]+Oe[5]*Fe,F[6]=Ae[6]+Oe[6]*Fe,F[7]=Ae[7]+Oe[7]*Fe,F[8]=Ae[8]+Oe[8]*Fe,F[9]=Ae[9]+Oe[9]*Fe,F[10]=Ae[10]+Oe[10]*Fe,F[11]=Ae[11]+Oe[11]*Fe,F[12]=Ae[12]+Oe[12]*Fe,F[13]=Ae[13]+Oe[13]*Fe,F[14]=Ae[14]+Oe[14]*Fe,F[15]=Ae[15]+Oe[15]*Fe,F},wi.exactEquals=function(F,Ae){return F[0]===Ae[0]&&F[1]===Ae[1]&&F[2]===Ae[2]&&F[3]===Ae[3]&&F[4]===Ae[4]&&F[5]===Ae[5]&&F[6]===Ae[6]&&F[7]===Ae[7]&&F[8]===Ae[8]&&F[9]===Ae[9]&&F[10]===Ae[10]&&F[11]===Ae[11]&&F[12]===Ae[12]&&F[13]===Ae[13]&&F[14]===Ae[14]&&F[15]===Ae[15]},wi.equals=function(Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Ae[6],xi=Ae[7],bi=Ae[8],wi=Ae[9],dr=Ae[10],jr=Ae[11],Qr=Ae[12],Xn=Ae[13],ho=Ae[14],yo=Ae[15],zo=Oe[0],ko=Oe[1],Uo=Oe[2],ia=Oe[3],_a=Oe[4],Ma=Oe[5],Ea=Oe[6],Ia=Oe[7],rl=Oe[8],Sl=Oe[9],Il=Oe[10],Kl=Oe[11],Jl=Oe[12],Ql=Oe[13],ec=Oe[14],tc=Oe[15];return Math.abs(Fe-zo)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(zo))&&Math.abs(Ve-ko)<=F.EPSILON*Math.max(1,Math.abs(Ve),Math.abs(ko))&&Math.abs(qe-Uo)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(Uo))&&Math.abs(pt-ia)<=F.EPSILON*Math.max(1,Math.abs(pt),Math.abs(ia))&&Math.abs(vt-_a)<=F.EPSILON*Math.max(1,Math.abs(vt),Math.abs(_a))&&Math.abs(zt-Ma)<=F.EPSILON*Math.max(1,Math.abs(zt),Math.abs(Ma))&&Math.abs(ri-Ea)<=F.EPSILON*Math.max(1,Math.abs(ri),Math.abs(Ea))&&Math.abs(xi-Ia)<=F.EPSILON*Math.max(1,Math.abs(xi),Math.abs(Ia))&&Math.abs(bi-rl)<=F.EPSILON*Math.max(1,Math.abs(bi),Math.abs(rl))&&Math.abs(wi-Sl)<=F.EPSILON*Math.max(1,Math.abs(wi),Math.abs(Sl))&&Math.abs(dr-Il)<=F.EPSILON*Math.max(1,Math.abs(dr),Math.abs(Il))&&Math.abs(jr-Kl)<=F.EPSILON*Math.max(1,Math.abs(jr),Math.abs(Kl))&&Math.abs(Qr-Jl)<=F.EPSILON*Math.max(1,Math.abs(Qr),Math.abs(Jl))&&Math.abs(Xn-Ql)<=F.EPSILON*Math.max(1,Math.abs(Xn),Math.abs(Ql))&&Math.abs(ho-ec)<=F.EPSILON*Math.max(1,Math.abs(ho),Math.abs(ec))&&Math.abs(yo-tc)<=F.EPSILON*Math.max(1,Math.abs(yo),Math.abs(tc))},wi.sub=wi.mul=wi.ortho=wi.perspective=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Ae=r(void 0);if(Ae&&Ae.has(F))return Ae.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ve in F)if("default"!==Ve&&Object.prototype.hasOwnProperty.call(F,Ve)){var qe=Fe?Object.getOwnPropertyDescriptor(F,Ve):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,Ve,qe):Oe[Ve]=F[Ve]}return Oe.default=F,Ae&&Ae.set(F,Oe),Oe}(a());function r(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Ae})(F)}function n(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F}function i(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Ae[6],xi=Ae[7],bi=Ae[8],wi=Ae[9],dr=Ae[10],jr=Ae[11],Qr=Ae[12],Xn=Ae[13],ho=Ae[14],yo=Ae[15],zo=Oe[0],ko=Oe[1],Uo=Oe[2],ia=Oe[3];return F[0]=zo*Fe+ko*vt+Uo*bi+ia*Qr,F[1]=zo*Ve+ko*zt+Uo*wi+ia*Xn,F[2]=zo*qe+ko*ri+Uo*dr+ia*ho,F[3]=zo*pt+ko*xi+Uo*jr+ia*yo,F[4]=(zo=Oe[4])*Fe+(ko=Oe[5])*vt+(Uo=Oe[6])*bi+(ia=Oe[7])*Qr,F[5]=zo*Ve+ko*zt+Uo*wi+ia*Xn,F[6]=zo*qe+ko*ri+Uo*dr+ia*ho,F[7]=zo*pt+ko*xi+Uo*jr+ia*yo,F[8]=(zo=Oe[8])*Fe+(ko=Oe[9])*vt+(Uo=Oe[10])*bi+(ia=Oe[11])*Qr,F[9]=zo*Ve+ko*zt+Uo*wi+ia*Xn,F[10]=zo*qe+ko*ri+Uo*dr+ia*ho,F[11]=zo*pt+ko*xi+Uo*jr+ia*yo,F[12]=(zo=Oe[12])*Fe+(ko=Oe[13])*vt+(Uo=Oe[14])*bi+(ia=Oe[15])*Qr,F[13]=zo*Ve+ko*zt+Uo*wi+ia*Xn,F[14]=zo*qe+ko*ri+Uo*dr+ia*ho,F[15]=zo*pt+ko*xi+Uo*jr+ia*yo,F}function s(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Fe+Fe,zt=Ve+Ve,ri=qe+qe,xi=Fe*vt,bi=Fe*zt,wi=Fe*ri,dr=Ve*zt,jr=Ve*ri,Qr=qe*ri,Xn=pt*vt,ho=pt*zt,yo=pt*ri;return F[0]=1-(dr+Qr),F[1]=bi+yo,F[2]=wi-ho,F[3]=0,F[4]=bi-yo,F[5]=1-(xi+Qr),F[6]=jr+Xn,F[7]=0,F[8]=wi+ho,F[9]=jr-Xn,F[10]=1-(xi+dr),F[11]=0,F[12]=Oe[0],F[13]=Oe[1],F[14]=Oe[2],F[15]=1,F}function o(F,Ae){var Oe=Ae[4],Fe=Ae[5],Ve=Ae[6],qe=Ae[8],pt=Ae[9],vt=Ae[10];return F[0]=Math.hypot(Ae[0],Ae[1],Ae[2]),F[1]=Math.hypot(Oe,Fe,Ve),F[2]=Math.hypot(qe,pt,vt),F}function l(F,Ae,Oe,Fe,Ve){var qe,pt=1/Math.tan(Ae/2);return F[0]=pt/Oe,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=pt,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[11]=-1,F[12]=0,F[13]=0,F[15]=0,null!=Ve&&Ve!==1/0?(F[10]=(Ve+Fe)*(qe=1/(Fe-Ve)),F[14]=2*Ve*Fe*qe):(F[10]=-1,F[14]=-2*Fe),F}function u(F,Ae,Oe,Fe,Ve,qe,pt){var vt=1/(Ae-Oe),zt=1/(Fe-Ve),ri=1/(qe-pt);return F[0]=-2*vt,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=-2*zt,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=2*ri,F[11]=0,F[12]=(Ae+Oe)*vt,F[13]=(Ve+Fe)*zt,F[14]=(pt+qe)*ri,F[15]=1,F}function c(F,Ae,Oe){return F[0]=Ae[0]-Oe[0],F[1]=Ae[1]-Oe[1],F[2]=Ae[2]-Oe[2],F[3]=Ae[3]-Oe[3],F[4]=Ae[4]-Oe[4],F[5]=Ae[5]-Oe[5],F[6]=Ae[6]-Oe[6],F[7]=Ae[7]-Oe[7],F[8]=Ae[8]-Oe[8],F[9]=Ae[9]-Oe[9],F[10]=Ae[10]-Oe[10],F[11]=Ae[11]-Oe[11],F[12]=Ae[12]-Oe[12],F[13]=Ae[13]-Oe[13],F[14]=Ae[14]-Oe[14],F[15]=Ae[15]-Oe[15],F}return wi.perspective=l,wi.ortho=u,wi.mul=i,wi.sub=c,wi}var dr,jr={},Qr={};function _(){if(dr)return Qr;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}dr=1,Object.defineProperty(Qr,"__esModule",{value:!0}),Qr.create=n,Qr.clone=function(Ae){var Oe=new F.ARRAY_TYPE(3);return Oe[0]=Ae[0],Oe[1]=Ae[1],Oe[2]=Ae[2],Oe},Qr.length=i,Qr.fromValues=function(Ae,Oe,Fe){var Ve=new F.ARRAY_TYPE(3);return Ve[0]=Ae,Ve[1]=Oe,Ve[2]=Fe,Ve},Qr.copy=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F},Qr.set=function(F,Ae,Oe,Fe){return F[0]=Ae,F[1]=Oe,F[2]=Fe,F},Qr.add=function(F,Ae,Oe){return F[0]=Ae[0]+Oe[0],F[1]=Ae[1]+Oe[1],F[2]=Ae[2]+Oe[2],F},Qr.subtract=s,Qr.multiply=o,Qr.divide=l,Qr.ceil=function(F,Ae){return F[0]=Math.ceil(Ae[0]),F[1]=Math.ceil(Ae[1]),F[2]=Math.ceil(Ae[2]),F},Qr.floor=function(F,Ae){return F[0]=Math.floor(Ae[0]),F[1]=Math.floor(Ae[1]),F[2]=Math.floor(Ae[2]),F},Qr.min=function(F,Ae,Oe){return F[0]=Math.min(Ae[0],Oe[0]),F[1]=Math.min(Ae[1],Oe[1]),F[2]=Math.min(Ae[2],Oe[2]),F},Qr.max=function(F,Ae,Oe){return F[0]=Math.max(Ae[0],Oe[0]),F[1]=Math.max(Ae[1],Oe[1]),F[2]=Math.max(Ae[2],Oe[2]),F},Qr.round=function(F,Ae){return F[0]=Math.round(Ae[0]),F[1]=Math.round(Ae[1]),F[2]=Math.round(Ae[2]),F},Qr.scale=function(F,Ae,Oe){return F[0]=Ae[0]*Oe,F[1]=Ae[1]*Oe,F[2]=Ae[2]*Oe,F},Qr.scaleAndAdd=function(F,Ae,Oe,Fe){return F[0]=Ae[0]+Oe[0]*Fe,F[1]=Ae[1]+Oe[1]*Fe,F[2]=Ae[2]+Oe[2]*Fe,F},Qr.distance=u,Qr.squaredDistance=c,Qr.squaredLength=h,Qr.negate=function(F,Ae){return F[0]=-Ae[0],F[1]=-Ae[1],F[2]=-Ae[2],F},Qr.inverse=function(F,Ae){return F[0]=1/Ae[0],F[1]=1/Ae[1],F[2]=1/Ae[2],F},Qr.normalize=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Oe*Oe+Fe*Fe+Ve*Ve;return qe>0&&(qe=1/Math.sqrt(qe)),F[0]=Ae[0]*qe,F[1]=Ae[1]*qe,F[2]=Ae[2]*qe,F},Qr.dot=p,Qr.cross=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Oe[0],vt=Oe[1],zt=Oe[2];return F[0]=Ve*zt-qe*vt,F[1]=qe*pt-Fe*zt,F[2]=Fe*vt-Ve*pt,F},Qr.lerp=function(F,Ae,Oe,Fe){var Ve=Ae[0],qe=Ae[1],pt=Ae[2];return F[0]=Ve+Fe*(Oe[0]-Ve),F[1]=qe+Fe*(Oe[1]-qe),F[2]=pt+Fe*(Oe[2]-pt),F},Qr.hermite=function(F,Ae,Oe,Fe,Ve,qe){var pt=qe*qe,vt=pt*(2*qe-3)+1,zt=pt*(qe-2)+qe,ri=pt*(qe-1),xi=pt*(3-2*qe);return F[0]=Ae[0]*vt+Oe[0]*zt+Fe[0]*ri+Ve[0]*xi,F[1]=Ae[1]*vt+Oe[1]*zt+Fe[1]*ri+Ve[1]*xi,F[2]=Ae[2]*vt+Oe[2]*zt+Fe[2]*ri+Ve[2]*xi,F},Qr.bezier=function(F,Ae,Oe,Fe,Ve,qe){var pt=1-qe,vt=pt*pt,zt=qe*qe,ri=vt*pt,xi=3*qe*vt,bi=3*zt*pt,wi=zt*qe;return F[0]=Ae[0]*ri+Oe[0]*xi+Fe[0]*bi+Ve[0]*wi,F[1]=Ae[1]*ri+Oe[1]*xi+Fe[1]*bi+Ve[1]*wi,F[2]=Ae[2]*ri+Oe[2]*xi+Fe[2]*bi+Ve[2]*wi,F},Qr.random=function(Ae,Oe){Oe=Oe||1;var Fe=2*F.RANDOM()*Math.PI,Ve=2*F.RANDOM()-1,qe=Math.sqrt(1-Ve*Ve)*Oe;return Ae[0]=Math.cos(Fe)*qe,Ae[1]=Math.sin(Fe)*qe,Ae[2]=Ve*Oe,Ae},Qr.transformMat4=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Oe[3]*Fe+Oe[7]*Ve+Oe[11]*qe+Oe[15];return F[0]=(Oe[0]*Fe+Oe[4]*Ve+Oe[8]*qe+Oe[12])/(pt=pt||1),F[1]=(Oe[1]*Fe+Oe[5]*Ve+Oe[9]*qe+Oe[13])/pt,F[2]=(Oe[2]*Fe+Oe[6]*Ve+Oe[10]*qe+Oe[14])/pt,F},Qr.transformMat3=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2];return F[0]=Fe*Oe[0]+Ve*Oe[3]+qe*Oe[6],F[1]=Fe*Oe[1]+Ve*Oe[4]+qe*Oe[7],F[2]=Fe*Oe[2]+Ve*Oe[5]+qe*Oe[8],F},Qr.transformQuat=function(F,Ae,Oe){var Fe=Oe[0],Ve=Oe[1],qe=Oe[2],pt=Ae[0],vt=Ae[1],zt=Ae[2],ri=Ve*zt-qe*vt,xi=qe*pt-Fe*zt,bi=Fe*vt-Ve*pt,wi=Ve*bi-qe*xi,dr=qe*ri-Fe*bi,jr=Fe*xi-Ve*ri,Qr=2*Oe[3];return xi*=Qr,bi*=Qr,dr*=2,jr*=2,F[0]=pt+(ri*=Qr)+(wi*=2),F[1]=vt+xi+dr,F[2]=zt+bi+jr,F},Qr.rotateX=function(F,Ae,Oe,Fe){var Ve=[],qe=[];return Ve[0]=Ae[0]-Oe[0],Ve[1]=Ae[1]-Oe[1],Ve[2]=Ae[2]-Oe[2],qe[0]=Ve[0],qe[1]=Ve[1]*Math.cos(Fe)-Ve[2]*Math.sin(Fe),qe[2]=Ve[1]*Math.sin(Fe)+Ve[2]*Math.cos(Fe),F[0]=qe[0]+Oe[0],F[1]=qe[1]+Oe[1],F[2]=qe[2]+Oe[2],F},Qr.rotateY=function(F,Ae,Oe,Fe){var Ve=[],qe=[];return Ve[0]=Ae[0]-Oe[0],Ve[1]=Ae[1]-Oe[1],Ve[2]=Ae[2]-Oe[2],qe[0]=Ve[2]*Math.sin(Fe)+Ve[0]*Math.cos(Fe),qe[1]=Ve[1],qe[2]=Ve[2]*Math.cos(Fe)-Ve[0]*Math.sin(Fe),F[0]=qe[0]+Oe[0],F[1]=qe[1]+Oe[1],F[2]=qe[2]+Oe[2],F},Qr.rotateZ=function(F,Ae,Oe,Fe){var Ve=[],qe=[];return Ve[0]=Ae[0]-Oe[0],Ve[1]=Ae[1]-Oe[1],Ve[2]=Ae[2]-Oe[2],qe[0]=Ve[0]*Math.cos(Fe)-Ve[1]*Math.sin(Fe),qe[1]=Ve[0]*Math.sin(Fe)+Ve[1]*Math.cos(Fe),qe[2]=Ve[2],F[0]=qe[0]+Oe[0],F[1]=qe[1]+Oe[1],F[2]=qe[2]+Oe[2],F},Qr.angle=function(F,Ae){var Oe=F[0],Fe=F[1],Ve=F[2],qe=Ae[0],pt=Ae[1],vt=Ae[2],zt=Math.sqrt(Oe*Oe+Fe*Fe+Ve*Ve)*Math.sqrt(qe*qe+pt*pt+vt*vt),ri=zt&&p(F,Ae)/zt;return Math.acos(Math.min(Math.max(ri,-1),1))},Qr.zero=function(F){return F[0]=0,F[1]=0,F[2]=0,F},Qr.str=function(F){return"vec3("+F[0]+", "+F[1]+", "+F[2]+")"},Qr.exactEquals=function(F,Ae){return F[0]===Ae[0]&&F[1]===Ae[1]&&F[2]===Ae[2]},Qr.equals=function(Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Oe[0],vt=Oe[1],zt=Oe[2];return Math.abs(Fe-pt)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(pt))&&Math.abs(Ve-vt)<=F.EPSILON*Math.max(1,Math.abs(Ve),Math.abs(vt))&&Math.abs(qe-zt)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(zt))},Qr.forEach=Qr.sqrLen=Qr.len=Qr.sqrDist=Qr.dist=Qr.div=Qr.mul=Qr.sub=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Ae=r(void 0);if(Ae&&Ae.has(F))return Ae.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ve in F)if("default"!==Ve&&Object.prototype.hasOwnProperty.call(F,Ve)){var qe=Fe?Object.getOwnPropertyDescriptor(F,Ve):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,Ve,qe):Oe[Ve]=F[Ve]}return Oe.default=F,Ae&&Ae.set(F,Oe),Oe}(a());function r(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Ae})(F)}function n(){var Ae=new F.ARRAY_TYPE(3);return F.ARRAY_TYPE!=Float32Array&&(Ae[0]=0,Ae[1]=0,Ae[2]=0),Ae}function i(F){return Math.hypot(F[0],F[1],F[2])}function s(F,Ae,Oe){return F[0]=Ae[0]-Oe[0],F[1]=Ae[1]-Oe[1],F[2]=Ae[2]-Oe[2],F}function o(F,Ae,Oe){return F[0]=Ae[0]*Oe[0],F[1]=Ae[1]*Oe[1],F[2]=Ae[2]*Oe[2],F}function l(F,Ae,Oe){return F[0]=Ae[0]/Oe[0],F[1]=Ae[1]/Oe[1],F[2]=Ae[2]/Oe[2],F}function u(F,Ae){return Math.hypot(Ae[0]-F[0],Ae[1]-F[1],Ae[2]-F[2])}function c(F,Ae){var Oe=Ae[0]-F[0],Fe=Ae[1]-F[1],Ve=Ae[2]-F[2];return Oe*Oe+Fe*Fe+Ve*Ve}function h(F){var Ae=F[0],Oe=F[1],Fe=F[2];return Ae*Ae+Oe*Oe+Fe*Fe}function p(F,Ae){return F[0]*Ae[0]+F[1]*Ae[1]+F[2]*Ae[2]}Qr.sub=s,Qr.mul=o,Qr.div=l,Qr.dist=u,Qr.sqrDist=c,Qr.len=i,Qr.sqrLen=h;var Ae,Oe=(Ae=n(),function(F,Oe,Fe,Ve,qe,pt){var vt,zt;for(Oe||(Oe=3),Fe||(Fe=0),zt=Ve?Math.min(Ve*Oe+Fe,F.length):F.length,vt=Fe;vt<zt;vt+=Oe)Ae[0]=F[vt],Ae[1]=F[vt+1],Ae[2]=F[vt+2],qe(Ae,Ae,pt),F[vt]=Ae[0],F[vt+1]=Ae[1],F[vt+2]=Ae[2];return F});return Qr.forEach=Oe,Qr}var Xn,ho,yo={};function S(){if(Xn)return yo;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Xn=1,Object.defineProperty(yo,"__esModule",{value:!0}),yo.create=n,yo.clone=function(Ae){var Oe=new F.ARRAY_TYPE(4);return Oe[0]=Ae[0],Oe[1]=Ae[1],Oe[2]=Ae[2],Oe[3]=Ae[3],Oe},yo.fromValues=function(Ae,Oe,Fe,Ve){var qe=new F.ARRAY_TYPE(4);return qe[0]=Ae,qe[1]=Oe,qe[2]=Fe,qe[3]=Ve,qe},yo.copy=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F[3]=Ae[3],F},yo.set=function(F,Ae,Oe,Fe,Ve){return F[0]=Ae,F[1]=Oe,F[2]=Fe,F[3]=Ve,F},yo.add=function(F,Ae,Oe){return F[0]=Ae[0]+Oe[0],F[1]=Ae[1]+Oe[1],F[2]=Ae[2]+Oe[2],F[3]=Ae[3]+Oe[3],F},yo.subtract=i,yo.multiply=s,yo.divide=o,yo.ceil=function(F,Ae){return F[0]=Math.ceil(Ae[0]),F[1]=Math.ceil(Ae[1]),F[2]=Math.ceil(Ae[2]),F[3]=Math.ceil(Ae[3]),F},yo.floor=function(F,Ae){return F[0]=Math.floor(Ae[0]),F[1]=Math.floor(Ae[1]),F[2]=Math.floor(Ae[2]),F[3]=Math.floor(Ae[3]),F},yo.min=function(F,Ae,Oe){return F[0]=Math.min(Ae[0],Oe[0]),F[1]=Math.min(Ae[1],Oe[1]),F[2]=Math.min(Ae[2],Oe[2]),F[3]=Math.min(Ae[3],Oe[3]),F},yo.max=function(F,Ae,Oe){return F[0]=Math.max(Ae[0],Oe[0]),F[1]=Math.max(Ae[1],Oe[1]),F[2]=Math.max(Ae[2],Oe[2]),F[3]=Math.max(Ae[3],Oe[3]),F},yo.round=function(F,Ae){return F[0]=Math.round(Ae[0]),F[1]=Math.round(Ae[1]),F[2]=Math.round(Ae[2]),F[3]=Math.round(Ae[3]),F},yo.scale=function(F,Ae,Oe){return F[0]=Ae[0]*Oe,F[1]=Ae[1]*Oe,F[2]=Ae[2]*Oe,F[3]=Ae[3]*Oe,F},yo.scaleAndAdd=function(F,Ae,Oe,Fe){return F[0]=Ae[0]+Oe[0]*Fe,F[1]=Ae[1]+Oe[1]*Fe,F[2]=Ae[2]+Oe[2]*Fe,F[3]=Ae[3]+Oe[3]*Fe,F},yo.distance=l,yo.squaredDistance=u,yo.length=c,yo.squaredLength=h,yo.negate=function(F,Ae){return F[0]=-Ae[0],F[1]=-Ae[1],F[2]=-Ae[2],F[3]=-Ae[3],F},yo.inverse=function(F,Ae){return F[0]=1/Ae[0],F[1]=1/Ae[1],F[2]=1/Ae[2],F[3]=1/Ae[3],F},yo.normalize=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Oe*Oe+Fe*Fe+Ve*Ve+qe*qe;return pt>0&&(pt=1/Math.sqrt(pt)),F[0]=Oe*pt,F[1]=Fe*pt,F[2]=Ve*pt,F[3]=qe*pt,F},yo.dot=function(F,Ae){return F[0]*Ae[0]+F[1]*Ae[1]+F[2]*Ae[2]+F[3]*Ae[3]},yo.cross=function(F,Ae,Oe,Fe){var Ve=Oe[0]*Fe[1]-Oe[1]*Fe[0],qe=Oe[0]*Fe[2]-Oe[2]*Fe[0],pt=Oe[0]*Fe[3]-Oe[3]*Fe[0],vt=Oe[1]*Fe[2]-Oe[2]*Fe[1],zt=Oe[1]*Fe[3]-Oe[3]*Fe[1],ri=Oe[2]*Fe[3]-Oe[3]*Fe[2],xi=Ae[0],bi=Ae[1],wi=Ae[2],dr=Ae[3];return F[0]=bi*ri-wi*zt+dr*vt,F[1]=-xi*ri+wi*pt-dr*qe,F[2]=xi*zt-bi*pt+dr*Ve,F[3]=-xi*vt+bi*qe-wi*Ve,F},yo.lerp=function(F,Ae,Oe,Fe){var Ve=Ae[0],qe=Ae[1],pt=Ae[2],vt=Ae[3];return F[0]=Ve+Fe*(Oe[0]-Ve),F[1]=qe+Fe*(Oe[1]-qe),F[2]=pt+Fe*(Oe[2]-pt),F[3]=vt+Fe*(Oe[3]-vt),F},yo.random=function(Ae,Oe){var Fe,Ve,qe,pt,vt,zt;Oe=Oe||1;do{vt=(Fe=2*F.RANDOM()-1)*Fe+(Ve=2*F.RANDOM()-1)*Ve}while(vt>=1);do{zt=(qe=2*F.RANDOM()-1)*qe+(pt=2*F.RANDOM()-1)*pt}while(zt>=1);var ri=Math.sqrt((1-vt)/zt);return Ae[0]=Oe*Fe,Ae[1]=Oe*Ve,Ae[2]=Oe*qe*ri,Ae[3]=Oe*pt*ri,Ae},yo.transformMat4=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3];return F[0]=Oe[0]*Fe+Oe[4]*Ve+Oe[8]*qe+Oe[12]*pt,F[1]=Oe[1]*Fe+Oe[5]*Ve+Oe[9]*qe+Oe[13]*pt,F[2]=Oe[2]*Fe+Oe[6]*Ve+Oe[10]*qe+Oe[14]*pt,F[3]=Oe[3]*Fe+Oe[7]*Ve+Oe[11]*qe+Oe[15]*pt,F},yo.transformQuat=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Oe[0],vt=Oe[1],zt=Oe[2],ri=Oe[3],xi=ri*Fe+vt*qe-zt*Ve,bi=ri*Ve+zt*Fe-pt*qe,wi=ri*qe+pt*Ve-vt*Fe,dr=-pt*Fe-vt*Ve-zt*qe;return F[0]=xi*ri+dr*-pt+bi*-zt-wi*-vt,F[1]=bi*ri+dr*-vt+wi*-pt-xi*-zt,F[2]=wi*ri+dr*-zt+xi*-vt-bi*-pt,F[3]=Ae[3],F},yo.zero=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=0,F},yo.str=function(F){return"vec4("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},yo.exactEquals=function(F,Ae){return F[0]===Ae[0]&&F[1]===Ae[1]&&F[2]===Ae[2]&&F[3]===Ae[3]},yo.equals=function(Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Oe[0],zt=Oe[1],ri=Oe[2],xi=Oe[3];return Math.abs(Fe-vt)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(vt))&&Math.abs(Ve-zt)<=F.EPSILON*Math.max(1,Math.abs(Ve),Math.abs(zt))&&Math.abs(qe-ri)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(ri))&&Math.abs(pt-xi)<=F.EPSILON*Math.max(1,Math.abs(pt),Math.abs(xi))},yo.forEach=yo.sqrLen=yo.len=yo.sqrDist=yo.dist=yo.div=yo.mul=yo.sub=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Ae=r(void 0);if(Ae&&Ae.has(F))return Ae.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ve in F)if("default"!==Ve&&Object.prototype.hasOwnProperty.call(F,Ve)){var qe=Fe?Object.getOwnPropertyDescriptor(F,Ve):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,Ve,qe):Oe[Ve]=F[Ve]}return Oe.default=F,Ae&&Ae.set(F,Oe),Oe}(a());function r(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Ae})(F)}function n(){var Ae=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(Ae[0]=0,Ae[1]=0,Ae[2]=0,Ae[3]=0),Ae}function i(F,Ae,Oe){return F[0]=Ae[0]-Oe[0],F[1]=Ae[1]-Oe[1],F[2]=Ae[2]-Oe[2],F[3]=Ae[3]-Oe[3],F}function s(F,Ae,Oe){return F[0]=Ae[0]*Oe[0],F[1]=Ae[1]*Oe[1],F[2]=Ae[2]*Oe[2],F[3]=Ae[3]*Oe[3],F}function o(F,Ae,Oe){return F[0]=Ae[0]/Oe[0],F[1]=Ae[1]/Oe[1],F[2]=Ae[2]/Oe[2],F[3]=Ae[3]/Oe[3],F}function l(F,Ae){return Math.hypot(Ae[0]-F[0],Ae[1]-F[1],Ae[2]-F[2],Ae[3]-F[3])}function u(F,Ae){var Oe=Ae[0]-F[0],Fe=Ae[1]-F[1],Ve=Ae[2]-F[2],qe=Ae[3]-F[3];return Oe*Oe+Fe*Fe+Ve*Ve+qe*qe}function c(F){return Math.hypot(F[0],F[1],F[2],F[3])}function h(F){var Ae=F[0],Oe=F[1],Fe=F[2],Ve=F[3];return Ae*Ae+Oe*Oe+Fe*Fe+Ve*Ve}yo.sub=i,yo.mul=s,yo.div=o,yo.dist=l,yo.sqrDist=u,yo.len=c,yo.sqrLen=h;var Ae,Oe=(Ae=n(),function(F,Oe,Fe,Ve,qe,pt){var vt,zt;for(Oe||(Oe=4),Fe||(Fe=0),zt=Ve?Math.min(Ve*Oe+Fe,F.length):F.length,vt=Fe;vt<zt;vt+=Oe)Ae[0]=F[vt],Ae[1]=F[vt+1],Ae[2]=F[vt+2],Ae[3]=F[vt+3],qe(Ae,Ae,pt),F[vt]=Ae[0],F[vt+1]=Ae[1],F[vt+2]=Ae[2],F[vt+3]=Ae[3];return F});return yo.forEach=Oe,yo}function I(){if(ho)return jr;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}ho=1,Object.defineProperty(jr,"__esModule",{value:!0}),jr.create=l,jr.identity=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F},jr.setAxisAngle=u,jr.getAxisAngle=function(Ae,Oe){var Fe=2*Math.acos(Oe[3]),Ve=Math.sin(Fe/2);return Ve>F.EPSILON?(Ae[0]=Oe[0]/Ve,Ae[1]=Oe[1]/Ve,Ae[2]=Oe[2]/Ve):(Ae[0]=1,Ae[1]=0,Ae[2]=0),Fe},jr.getAngle=function(F,Ae){var Oe=qe(F,Ae);return Math.acos(2*Oe*Oe-1)},jr.multiply=c,jr.rotateX=function(F,Ae,Oe){Oe*=.5;var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Math.sin(Oe),zt=Math.cos(Oe);return F[0]=Fe*zt+pt*vt,F[1]=Ve*zt+qe*vt,F[2]=qe*zt-Ve*vt,F[3]=pt*zt-Fe*vt,F},jr.rotateY=function(F,Ae,Oe){Oe*=.5;var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Math.sin(Oe),zt=Math.cos(Oe);return F[0]=Fe*zt-qe*vt,F[1]=Ve*zt+pt*vt,F[2]=qe*zt+Fe*vt,F[3]=pt*zt-Ve*vt,F},jr.rotateZ=function(F,Ae,Oe){Oe*=.5;var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Math.sin(Oe),zt=Math.cos(Oe);return F[0]=Fe*zt+Ve*vt,F[1]=Ve*zt-Fe*vt,F[2]=qe*zt+pt*vt,F[3]=pt*zt-qe*vt,F},jr.calculateW=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2];return F[0]=Oe,F[1]=Fe,F[2]=Ve,F[3]=Math.sqrt(Math.abs(1-Oe*Oe-Fe*Fe-Ve*Ve)),F},jr.exp=h,jr.ln=p,jr.pow=function(F,Ae,Oe){return p(F,Ae),Ve(F,F,Oe),h(F,F),F},jr.slerp=f,jr.random=function(Ae){var Oe=F.RANDOM(),Fe=F.RANDOM(),Ve=F.RANDOM(),qe=Math.sqrt(1-Oe),pt=Math.sqrt(Oe);return Ae[0]=qe*Math.sin(2*Math.PI*Fe),Ae[1]=qe*Math.cos(2*Math.PI*Fe),Ae[2]=pt*Math.sin(2*Math.PI*Ve),Ae[3]=pt*Math.cos(2*Math.PI*Ve),Ae},jr.invert=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Oe*Oe+Fe*Fe+Ve*Ve+qe*qe,vt=pt?1/pt:0;return F[0]=-Oe*vt,F[1]=-Fe*vt,F[2]=-Ve*vt,F[3]=qe*vt,F},jr.conjugate=function(F,Ae){return F[0]=-Ae[0],F[1]=-Ae[1],F[2]=-Ae[2],F[3]=Ae[3],F},jr.fromMat3=m,jr.fromEuler=function(F,Ae,Oe,Fe){var Ve=.5*Math.PI/180;Ae*=Ve,Oe*=Ve,Fe*=Ve;var qe=Math.sin(Ae),pt=Math.cos(Ae),vt=Math.sin(Oe),zt=Math.cos(Oe),ri=Math.sin(Fe),xi=Math.cos(Fe);return F[0]=qe*zt*xi-pt*vt*ri,F[1]=pt*vt*xi+qe*zt*ri,F[2]=pt*zt*ri-qe*vt*xi,F[3]=pt*zt*xi+qe*vt*ri,F},jr.str=function(F){return"quat("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},jr.setAxes=jr.sqlerp=jr.rotationTo=jr.equals=jr.exactEquals=jr.normalize=jr.sqrLen=jr.squaredLength=jr.len=jr.length=jr.lerp=jr.dot=jr.scale=jr.mul=jr.add=jr.set=jr.copy=jr.fromValues=jr.clone=void 0;var F=o(a()),Ae=o(d()),Oe=o(_()),Fe=o(S());function s(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(s=function(F){return F?Oe:Ae})(F)}function o(F,Ae){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Oe=s(Ae);if(Oe&&Oe.has(F))return Oe.get(F);var Fe={},Ve=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var qe in F)if("default"!==qe&&Object.prototype.hasOwnProperty.call(F,qe)){var pt=Ve?Object.getOwnPropertyDescriptor(F,qe):null;pt&&(pt.get||pt.set)?Object.defineProperty(Fe,qe,pt):Fe[qe]=F[qe]}return Fe.default=F,Oe&&Oe.set(F,Fe),Fe}function l(){var Ae=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(Ae[0]=0,Ae[1]=0,Ae[2]=0),Ae[3]=1,Ae}function u(F,Ae,Oe){Oe*=.5;var Fe=Math.sin(Oe);return F[0]=Fe*Ae[0],F[1]=Fe*Ae[1],F[2]=Fe*Ae[2],F[3]=Math.cos(Oe),F}function c(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Oe[0],zt=Oe[1],ri=Oe[2],xi=Oe[3];return F[0]=Fe*xi+pt*vt+Ve*ri-qe*zt,F[1]=Ve*xi+pt*zt+qe*vt-Fe*ri,F[2]=qe*xi+pt*ri+Fe*zt-Ve*vt,F[3]=pt*xi-Fe*vt-Ve*zt-qe*ri,F}function h(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Math.sqrt(Oe*Oe+Fe*Fe+Ve*Ve),vt=Math.exp(qe),zt=pt>0?vt*Math.sin(pt)/pt:0;return F[0]=Oe*zt,F[1]=Fe*zt,F[2]=Ve*zt,F[3]=vt*Math.cos(pt),F}function p(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Ae[2],qe=Ae[3],pt=Math.sqrt(Oe*Oe+Fe*Fe+Ve*Ve),vt=pt>0?Math.atan2(pt,qe)/pt:0;return F[0]=Oe*vt,F[1]=Fe*vt,F[2]=Ve*vt,F[3]=.5*Math.log(Oe*Oe+Fe*Fe+Ve*Ve+qe*qe),F}function f(Ae,Oe,Fe,Ve){var qe,pt,vt,zt,ri,xi=Oe[0],bi=Oe[1],wi=Oe[2],dr=Oe[3],jr=Fe[0],Qr=Fe[1],Xn=Fe[2],ho=Fe[3];return(pt=xi*jr+bi*Qr+wi*Xn+dr*ho)<0&&(pt=-pt,jr=-jr,Qr=-Qr,Xn=-Xn,ho=-ho),1-pt>F.EPSILON?(qe=Math.acos(pt),vt=Math.sin(qe),zt=Math.sin((1-Ve)*qe)/vt,ri=Math.sin(Ve*qe)/vt):(zt=1-Ve,ri=Ve),Ae[0]=zt*xi+ri*jr,Ae[1]=zt*bi+ri*Qr,Ae[2]=zt*wi+ri*Xn,Ae[3]=zt*dr+ri*ho,Ae}function m(F,Ae){var Oe,Fe=Ae[0]+Ae[4]+Ae[8];if(Fe>0)Oe=Math.sqrt(Fe+1),F[3]=.5*Oe,F[0]=(Ae[5]-Ae[7])*(Oe=.5/Oe),F[1]=(Ae[6]-Ae[2])*Oe,F[2]=(Ae[1]-Ae[3])*Oe;else{var Ve=0;Ae[4]>Ae[0]&&(Ve=1),Ae[8]>Ae[3*Ve+Ve]&&(Ve=2);var qe=(Ve+1)%3,pt=(Ve+2)%3;Oe=Math.sqrt(Ae[3*Ve+Ve]-Ae[3*qe+qe]-Ae[3*pt+pt]+1),F[Ve]=.5*Oe,F[3]=(Ae[3*qe+pt]-Ae[3*pt+qe])*(Oe=.5/Oe),F[qe]=(Ae[3*qe+Ve]+Ae[3*Ve+qe])*Oe,F[pt]=(Ae[3*pt+Ve]+Ae[3*Ve+pt])*Oe}return F}jr.clone=Fe.clone,jr.fromValues=Fe.fromValues,jr.copy=Fe.copy,jr.set=Fe.set,jr.add=Fe.add,jr.mul=c;var Ve=Fe.scale;jr.scale=Ve;var qe=Fe.dot;jr.dot=qe,jr.lerp=Fe.lerp;var pt=Fe.length;jr.length=pt,jr.len=pt;var vt=Fe.squaredLength;jr.squaredLength=vt,jr.sqrLen=vt;var zt=Fe.normalize;jr.normalize=zt,jr.exactEquals=Fe.exactEquals,jr.equals=Fe.equals;var ri,xi,bi,wi=(ri=Oe.create(),xi=Oe.fromValues(1,0,0),bi=Oe.fromValues(0,1,0),function(F,Ae,Fe){var Ve=Oe.dot(Ae,Fe);return Ve<-.999999?(Oe.cross(ri,xi,Ae),Oe.len(ri)<1e-6&&Oe.cross(ri,bi,Ae),Oe.normalize(ri,ri),u(F,ri,Math.PI),F):Ve>.999999?(F[0]=0,F[1]=0,F[2]=0,F[3]=1,F):(Oe.cross(ri,Ae,Fe),F[0]=ri[0],F[1]=ri[1],F[2]=ri[2],F[3]=1+Ve,zt(F,F))});jr.rotationTo=wi;var dr,Qr,Xn=(dr=l(),Qr=l(),function(F,Ae,Oe,Fe,Ve,qe){return f(dr,Ae,Ve,qe),f(Qr,Oe,Fe,qe),f(F,dr,Qr,2*qe*(1-qe)),F});jr.sqlerp=Xn;var yo,zo=(yo=Ae.create(),function(F,Ae,Oe,Fe){return yo[0]=Oe[0],yo[3]=Oe[1],yo[6]=Oe[2],yo[1]=Fe[0],yo[4]=Fe[1],yo[7]=Fe[2],yo[2]=-Ae[0],yo[5]=-Ae[1],yo[8]=-Ae[2],zt(F,m(F,yo))});return jr.setAxes=zo,jr}var zo,ko={};function E(){if(zo)return ko;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}zo=1,Object.defineProperty(ko,"__esModule",{value:!0}),ko.create=function(){var Ae=new F.ARRAY_TYPE(8);return F.ARRAY_TYPE!=Float32Array&&(Ae[0]=0,Ae[1]=0,Ae[2]=0,Ae[4]=0,Ae[5]=0,Ae[6]=0,Ae[7]=0),Ae[3]=1,Ae},ko.clone=function(Ae){var Oe=new F.ARRAY_TYPE(8);return Oe[0]=Ae[0],Oe[1]=Ae[1],Oe[2]=Ae[2],Oe[3]=Ae[3],Oe[4]=Ae[4],Oe[5]=Ae[5],Oe[6]=Ae[6],Oe[7]=Ae[7],Oe},ko.fromValues=function(Ae,Oe,Fe,Ve,qe,pt,vt,zt){var ri=new F.ARRAY_TYPE(8);return ri[0]=Ae,ri[1]=Oe,ri[2]=Fe,ri[3]=Ve,ri[4]=qe,ri[5]=pt,ri[6]=vt,ri[7]=zt,ri},ko.fromRotationTranslationValues=function(Ae,Oe,Fe,Ve,qe,pt,vt){var zt=new F.ARRAY_TYPE(8);zt[0]=Ae,zt[1]=Oe,zt[2]=Fe,zt[3]=Ve;var ri=.5*qe,xi=.5*pt,bi=.5*vt;return zt[4]=ri*Ve+xi*Fe-bi*Oe,zt[5]=xi*Ve+bi*Ae-ri*Fe,zt[6]=bi*Ve+ri*Oe-xi*Ae,zt[7]=-ri*Ae-xi*Oe-bi*Fe,zt},ko.fromRotationTranslation=o,ko.fromTranslation=function(F,Ae){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=.5*Ae[0],F[5]=.5*Ae[1],F[6]=.5*Ae[2],F[7]=0,F},ko.fromRotation=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F[3]=Ae[3],F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},ko.fromMat4=function(Fe,Ve){var qe=Ae.create();Oe.getRotation(qe,Ve);var pt=new F.ARRAY_TYPE(3);return Oe.getTranslation(pt,Ve),o(Fe,qe,pt),Fe},ko.copy=l,ko.identity=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},ko.set=function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){return F[0]=Ae,F[1]=Oe,F[2]=Fe,F[3]=Ve,F[4]=qe,F[5]=pt,F[6]=vt,F[7]=zt,F},ko.getDual=function(F,Ae){return F[0]=Ae[4],F[1]=Ae[5],F[2]=Ae[6],F[3]=Ae[7],F},ko.setDual=function(F,Ae){return F[4]=Ae[0],F[5]=Ae[1],F[6]=Ae[2],F[7]=Ae[3],F},ko.getTranslation=function(F,Ae){var Oe=Ae[4],Fe=Ae[5],Ve=Ae[6],qe=Ae[7],pt=-Ae[0],vt=-Ae[1],zt=-Ae[2],ri=Ae[3];return F[0]=2*(Oe*ri+qe*pt+Fe*zt-Ve*vt),F[1]=2*(Fe*ri+qe*vt+Ve*pt-Oe*zt),F[2]=2*(Ve*ri+qe*zt+Oe*vt-Fe*pt),F},ko.translate=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=.5*Oe[0],zt=.5*Oe[1],ri=.5*Oe[2],xi=Ae[4],bi=Ae[5],wi=Ae[6],dr=Ae[7];return F[0]=Fe,F[1]=Ve,F[2]=qe,F[3]=pt,F[4]=pt*vt+Ve*ri-qe*zt+xi,F[5]=pt*zt+qe*vt-Fe*ri+bi,F[6]=pt*ri+Fe*zt-Ve*vt+wi,F[7]=-Fe*vt-Ve*zt-qe*ri+dr,F},ko.rotateX=function(F,Oe,Fe){var Ve=-Oe[0],qe=-Oe[1],pt=-Oe[2],vt=Oe[3],zt=Oe[4],ri=Oe[5],xi=Oe[6],bi=Oe[7],wi=zt*vt+bi*Ve+ri*pt-xi*qe,dr=ri*vt+bi*qe+xi*Ve-zt*pt,jr=xi*vt+bi*pt+zt*qe-ri*Ve,Qr=bi*vt-zt*Ve-ri*qe-xi*pt;return Ae.rotateX(F,Oe,Fe),F[4]=wi*(vt=F[3])+Qr*(Ve=F[0])+dr*(pt=F[2])-jr*(qe=F[1]),F[5]=dr*vt+Qr*qe+jr*Ve-wi*pt,F[6]=jr*vt+Qr*pt+wi*qe-dr*Ve,F[7]=Qr*vt-wi*Ve-dr*qe-jr*pt,F},ko.rotateY=function(F,Oe,Fe){var Ve=-Oe[0],qe=-Oe[1],pt=-Oe[2],vt=Oe[3],zt=Oe[4],ri=Oe[5],xi=Oe[6],bi=Oe[7],wi=zt*vt+bi*Ve+ri*pt-xi*qe,dr=ri*vt+bi*qe+xi*Ve-zt*pt,jr=xi*vt+bi*pt+zt*qe-ri*Ve,Qr=bi*vt-zt*Ve-ri*qe-xi*pt;return Ae.rotateY(F,Oe,Fe),F[4]=wi*(vt=F[3])+Qr*(Ve=F[0])+dr*(pt=F[2])-jr*(qe=F[1]),F[5]=dr*vt+Qr*qe+jr*Ve-wi*pt,F[6]=jr*vt+Qr*pt+wi*qe-dr*Ve,F[7]=Qr*vt-wi*Ve-dr*qe-jr*pt,F},ko.rotateZ=function(F,Oe,Fe){var Ve=-Oe[0],qe=-Oe[1],pt=-Oe[2],vt=Oe[3],zt=Oe[4],ri=Oe[5],xi=Oe[6],bi=Oe[7],wi=zt*vt+bi*Ve+ri*pt-xi*qe,dr=ri*vt+bi*qe+xi*Ve-zt*pt,jr=xi*vt+bi*pt+zt*qe-ri*Ve,Qr=bi*vt-zt*Ve-ri*qe-xi*pt;return Ae.rotateZ(F,Oe,Fe),F[4]=wi*(vt=F[3])+Qr*(Ve=F[0])+dr*(pt=F[2])-jr*(qe=F[1]),F[5]=dr*vt+Qr*qe+jr*Ve-wi*pt,F[6]=jr*vt+Qr*pt+wi*qe-dr*Ve,F[7]=Qr*vt-wi*Ve-dr*qe-jr*pt,F},ko.rotateByQuatAppend=function(F,Ae,Oe){var Fe=Oe[0],Ve=Oe[1],qe=Oe[2],pt=Oe[3],vt=Ae[0],zt=Ae[1],ri=Ae[2],xi=Ae[3];return F[0]=vt*pt+xi*Fe+zt*qe-ri*Ve,F[1]=zt*pt+xi*Ve+ri*Fe-vt*qe,F[2]=ri*pt+xi*qe+vt*Ve-zt*Fe,F[3]=xi*pt-vt*Fe-zt*Ve-ri*qe,F[4]=(vt=Ae[4])*pt+(xi=Ae[7])*Fe+(zt=Ae[5])*qe-(ri=Ae[6])*Ve,F[5]=zt*pt+xi*Ve+ri*Fe-vt*qe,F[6]=ri*pt+xi*qe+vt*Ve-zt*Fe,F[7]=xi*pt-vt*Fe-zt*Ve-ri*qe,F},ko.rotateByQuatPrepend=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Oe[0],zt=Oe[1],ri=Oe[2],xi=Oe[3];return F[0]=Fe*xi+pt*vt+Ve*ri-qe*zt,F[1]=Ve*xi+pt*zt+qe*vt-Fe*ri,F[2]=qe*xi+pt*ri+Fe*zt-Ve*vt,F[3]=pt*xi-Fe*vt-Ve*zt-qe*ri,F[4]=Fe*(xi=Oe[7])+pt*(vt=Oe[4])+Ve*(ri=Oe[6])-qe*(zt=Oe[5]),F[5]=Ve*xi+pt*zt+qe*vt-Fe*ri,F[6]=qe*xi+pt*ri+Fe*zt-Ve*vt,F[7]=pt*xi-Fe*vt-Ve*zt-qe*ri,F},ko.rotateAroundAxis=function(Ae,Oe,Fe,Ve){if(Math.abs(Ve)<F.EPSILON)return l(Ae,Oe);var qe=Math.hypot(Fe[0],Fe[1],Fe[2]);Ve*=.5;var pt=Math.sin(Ve),vt=pt*Fe[0]/qe,zt=pt*Fe[1]/qe,ri=pt*Fe[2]/qe,xi=Math.cos(Ve),bi=Oe[0],wi=Oe[1],dr=Oe[2],jr=Oe[3];Ae[0]=bi*xi+jr*vt+wi*ri-dr*zt,Ae[1]=wi*xi+jr*zt+dr*vt-bi*ri,Ae[2]=dr*xi+jr*ri+bi*zt-wi*vt,Ae[3]=jr*xi-bi*vt-wi*zt-dr*ri;var Qr=Oe[4],Xn=Oe[5],ho=Oe[6],yo=Oe[7];return Ae[4]=Qr*xi+yo*vt+Xn*ri-ho*zt,Ae[5]=Xn*xi+yo*zt+ho*vt-Qr*ri,Ae[6]=ho*xi+yo*ri+Qr*zt-Xn*vt,Ae[7]=yo*xi-Qr*vt-Xn*zt-ho*ri,Ae},ko.add=function(F,Ae,Oe){return F[0]=Ae[0]+Oe[0],F[1]=Ae[1]+Oe[1],F[2]=Ae[2]+Oe[2],F[3]=Ae[3]+Oe[3],F[4]=Ae[4]+Oe[4],F[5]=Ae[5]+Oe[5],F[6]=Ae[6]+Oe[6],F[7]=Ae[7]+Oe[7],F},ko.multiply=u,ko.scale=function(F,Ae,Oe){return F[0]=Ae[0]*Oe,F[1]=Ae[1]*Oe,F[2]=Ae[2]*Oe,F[3]=Ae[3]*Oe,F[4]=Ae[4]*Oe,F[5]=Ae[5]*Oe,F[6]=Ae[6]*Oe,F[7]=Ae[7]*Oe,F},ko.lerp=function(F,Ae,Oe,Ve){var qe=1-Ve;return Fe(Ae,Oe)<0&&(Ve=-Ve),F[0]=Ae[0]*qe+Oe[0]*Ve,F[1]=Ae[1]*qe+Oe[1]*Ve,F[2]=Ae[2]*qe+Oe[2]*Ve,F[3]=Ae[3]*qe+Oe[3]*Ve,F[4]=Ae[4]*qe+Oe[4]*Ve,F[5]=Ae[5]*qe+Oe[5]*Ve,F[6]=Ae[6]*qe+Oe[6]*Ve,F[7]=Ae[7]*qe+Oe[7]*Ve,F},ko.invert=function(F,Ae){var Oe=qe(Ae);return F[0]=-Ae[0]/Oe,F[1]=-Ae[1]/Oe,F[2]=-Ae[2]/Oe,F[3]=Ae[3]/Oe,F[4]=-Ae[4]/Oe,F[5]=-Ae[5]/Oe,F[6]=-Ae[6]/Oe,F[7]=Ae[7]/Oe,F},ko.conjugate=function(F,Ae){return F[0]=-Ae[0],F[1]=-Ae[1],F[2]=-Ae[2],F[3]=Ae[3],F[4]=-Ae[4],F[5]=-Ae[5],F[6]=-Ae[6],F[7]=Ae[7],F},ko.normalize=function(F,Ae){var Oe=qe(Ae);if(Oe>0){Oe=Math.sqrt(Oe);var Fe=Ae[0]/Oe,Ve=Ae[1]/Oe,pt=Ae[2]/Oe,vt=Ae[3]/Oe,zt=Ae[4],ri=Ae[5],xi=Ae[6],bi=Ae[7],wi=Fe*zt+Ve*ri+pt*xi+vt*bi;F[0]=Fe,F[1]=Ve,F[2]=pt,F[3]=vt,F[4]=(zt-Fe*wi)/Oe,F[5]=(ri-Ve*wi)/Oe,F[6]=(xi-pt*wi)/Oe,F[7]=(bi-vt*wi)/Oe}return F},ko.str=function(F){return"quat2("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+")"},ko.exactEquals=function(F,Ae){return F[0]===Ae[0]&&F[1]===Ae[1]&&F[2]===Ae[2]&&F[3]===Ae[3]&&F[4]===Ae[4]&&F[5]===Ae[5]&&F[6]===Ae[6]&&F[7]===Ae[7]},ko.equals=function(Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Ae[4],zt=Ae[5],ri=Ae[6],xi=Ae[7],bi=Oe[0],wi=Oe[1],dr=Oe[2],jr=Oe[3],Qr=Oe[4],Xn=Oe[5],ho=Oe[6],yo=Oe[7];return Math.abs(Fe-bi)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(bi))&&Math.abs(Ve-wi)<=F.EPSILON*Math.max(1,Math.abs(Ve),Math.abs(wi))&&Math.abs(qe-dr)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(dr))&&Math.abs(pt-jr)<=F.EPSILON*Math.max(1,Math.abs(pt),Math.abs(jr))&&Math.abs(vt-Qr)<=F.EPSILON*Math.max(1,Math.abs(vt),Math.abs(Qr))&&Math.abs(zt-Xn)<=F.EPSILON*Math.max(1,Math.abs(zt),Math.abs(Xn))&&Math.abs(ri-ho)<=F.EPSILON*Math.max(1,Math.abs(ri),Math.abs(ho))&&Math.abs(xi-yo)<=F.EPSILON*Math.max(1,Math.abs(xi),Math.abs(yo))},ko.sqrLen=ko.squaredLength=ko.len=ko.length=ko.dot=ko.mul=ko.setReal=ko.getReal=void 0;var F=s(a()),Ae=s(I()),Oe=s(g());function i(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(i=function(F){return F?Oe:Ae})(F)}function s(F,Ae){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Oe=i(Ae);if(Oe&&Oe.has(F))return Oe.get(F);var Fe={},Ve=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var qe in F)if("default"!==qe&&Object.prototype.hasOwnProperty.call(F,qe)){var pt=Ve?Object.getOwnPropertyDescriptor(F,qe):null;pt&&(pt.get||pt.set)?Object.defineProperty(Fe,qe,pt):Fe[qe]=F[qe]}return Fe.default=F,Oe&&Oe.set(F,Fe),Fe}function o(F,Ae,Oe){var Fe=.5*Oe[0],Ve=.5*Oe[1],qe=.5*Oe[2],pt=Ae[0],vt=Ae[1],zt=Ae[2],ri=Ae[3];return F[0]=pt,F[1]=vt,F[2]=zt,F[3]=ri,F[4]=Fe*ri+Ve*zt-qe*vt,F[5]=Ve*ri+qe*pt-Fe*zt,F[6]=qe*ri+Fe*vt-Ve*pt,F[7]=-Fe*pt-Ve*vt-qe*zt,F}function l(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F[2]=Ae[2],F[3]=Ae[3],F[4]=Ae[4],F[5]=Ae[5],F[6]=Ae[6],F[7]=Ae[7],F}function u(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Ae[2],pt=Ae[3],vt=Oe[4],zt=Oe[5],ri=Oe[6],xi=Oe[7],bi=Ae[4],wi=Ae[5],dr=Ae[6],jr=Ae[7],Qr=Oe[0],Xn=Oe[1],ho=Oe[2],yo=Oe[3];return F[0]=Fe*yo+pt*Qr+Ve*ho-qe*Xn,F[1]=Ve*yo+pt*Xn+qe*Qr-Fe*ho,F[2]=qe*yo+pt*ho+Fe*Xn-Ve*Qr,F[3]=pt*yo-Fe*Qr-Ve*Xn-qe*ho,F[4]=Fe*xi+pt*vt+Ve*ri-qe*zt+bi*yo+jr*Qr+wi*ho-dr*Xn,F[5]=Ve*xi+pt*zt+qe*vt-Fe*ri+wi*yo+jr*Xn+dr*Qr-bi*ho,F[6]=qe*xi+pt*ri+Fe*zt-Ve*vt+dr*yo+jr*ho+bi*Xn-wi*Qr,F[7]=pt*xi-Fe*vt-Ve*zt-qe*ri+jr*yo-bi*Qr-wi*Xn-dr*ho,F}ko.getReal=Ae.copy,ko.setReal=Ae.copy,ko.mul=u;var Fe=Ae.dot;ko.dot=Fe;var Ve=Ae.length;ko.length=Ve,ko.len=Ve;var qe=Ae.squaredLength;return ko.squaredLength=qe,ko.sqrLen=qe,ko}var Uo,ia,_a={};function C(){if(Uo)return _a;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Uo=1,Object.defineProperty(_a,"__esModule",{value:!0}),_a.create=n,_a.clone=function(Ae){var Oe=new F.ARRAY_TYPE(2);return Oe[0]=Ae[0],Oe[1]=Ae[1],Oe},_a.fromValues=function(Ae,Oe){var Fe=new F.ARRAY_TYPE(2);return Fe[0]=Ae,Fe[1]=Oe,Fe},_a.copy=function(F,Ae){return F[0]=Ae[0],F[1]=Ae[1],F},_a.set=function(F,Ae,Oe){return F[0]=Ae,F[1]=Oe,F},_a.add=function(F,Ae,Oe){return F[0]=Ae[0]+Oe[0],F[1]=Ae[1]+Oe[1],F},_a.subtract=i,_a.multiply=s,_a.divide=o,_a.ceil=function(F,Ae){return F[0]=Math.ceil(Ae[0]),F[1]=Math.ceil(Ae[1]),F},_a.floor=function(F,Ae){return F[0]=Math.floor(Ae[0]),F[1]=Math.floor(Ae[1]),F},_a.min=function(F,Ae,Oe){return F[0]=Math.min(Ae[0],Oe[0]),F[1]=Math.min(Ae[1],Oe[1]),F},_a.max=function(F,Ae,Oe){return F[0]=Math.max(Ae[0],Oe[0]),F[1]=Math.max(Ae[1],Oe[1]),F},_a.round=function(F,Ae){return F[0]=Math.round(Ae[0]),F[1]=Math.round(Ae[1]),F},_a.scale=function(F,Ae,Oe){return F[0]=Ae[0]*Oe,F[1]=Ae[1]*Oe,F},_a.scaleAndAdd=function(F,Ae,Oe,Fe){return F[0]=Ae[0]+Oe[0]*Fe,F[1]=Ae[1]+Oe[1]*Fe,F},_a.distance=l,_a.squaredDistance=u,_a.length=c,_a.squaredLength=h,_a.negate=function(F,Ae){return F[0]=-Ae[0],F[1]=-Ae[1],F},_a.inverse=function(F,Ae){return F[0]=1/Ae[0],F[1]=1/Ae[1],F},_a.normalize=function(F,Ae){var Oe=Ae[0],Fe=Ae[1],Ve=Oe*Oe+Fe*Fe;return Ve>0&&(Ve=1/Math.sqrt(Ve)),F[0]=Ae[0]*Ve,F[1]=Ae[1]*Ve,F},_a.dot=function(F,Ae){return F[0]*Ae[0]+F[1]*Ae[1]},_a.cross=function(F,Ae,Oe){var Fe=Ae[0]*Oe[1]-Ae[1]*Oe[0];return F[0]=F[1]=0,F[2]=Fe,F},_a.lerp=function(F,Ae,Oe,Fe){var Ve=Ae[0],qe=Ae[1];return F[0]=Ve+Fe*(Oe[0]-Ve),F[1]=qe+Fe*(Oe[1]-qe),F},_a.random=function(Ae,Oe){Oe=Oe||1;var Fe=2*F.RANDOM()*Math.PI;return Ae[0]=Math.cos(Fe)*Oe,Ae[1]=Math.sin(Fe)*Oe,Ae},_a.transformMat2=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1];return F[0]=Oe[0]*Fe+Oe[2]*Ve,F[1]=Oe[1]*Fe+Oe[3]*Ve,F},_a.transformMat2d=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1];return F[0]=Oe[0]*Fe+Oe[2]*Ve+Oe[4],F[1]=Oe[1]*Fe+Oe[3]*Ve+Oe[5],F},_a.transformMat3=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1];return F[0]=Oe[0]*Fe+Oe[3]*Ve+Oe[6],F[1]=Oe[1]*Fe+Oe[4]*Ve+Oe[7],F},_a.transformMat4=function(F,Ae,Oe){var Fe=Ae[0],Ve=Ae[1];return F[0]=Oe[0]*Fe+Oe[4]*Ve+Oe[12],F[1]=Oe[1]*Fe+Oe[5]*Ve+Oe[13],F},_a.rotate=function(F,Ae,Oe,Fe){var Ve=Ae[0]-Oe[0],qe=Ae[1]-Oe[1],pt=Math.sin(Fe),vt=Math.cos(Fe);return F[0]=Ve*vt-qe*pt+Oe[0],F[1]=Ve*pt+qe*vt+Oe[1],F},_a.angle=function(F,Ae){var Oe=F[0],Fe=F[1],Ve=Ae[0],qe=Ae[1],pt=Math.sqrt(Oe*Oe+Fe*Fe)*Math.sqrt(Ve*Ve+qe*qe);return Math.acos(Math.min(Math.max(pt&&(Oe*Ve+Fe*qe)/pt,-1),1))},_a.zero=function(F){return F[0]=0,F[1]=0,F},_a.str=function(F){return"vec2("+F[0]+", "+F[1]+")"},_a.exactEquals=function(F,Ae){return F[0]===Ae[0]&&F[1]===Ae[1]},_a.equals=function(Ae,Oe){var Fe=Ae[0],Ve=Ae[1],qe=Oe[0],pt=Oe[1];return Math.abs(Fe-qe)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(qe))&&Math.abs(Ve-pt)<=F.EPSILON*Math.max(1,Math.abs(Ve),Math.abs(pt))},_a.forEach=_a.sqrLen=_a.sqrDist=_a.dist=_a.div=_a.mul=_a.sub=_a.len=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Ae=r(void 0);if(Ae&&Ae.has(F))return Ae.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Ve in F)if("default"!==Ve&&Object.prototype.hasOwnProperty.call(F,Ve)){var qe=Fe?Object.getOwnPropertyDescriptor(F,Ve):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,Ve,qe):Oe[Ve]=F[Ve]}return Oe.default=F,Ae&&Ae.set(F,Oe),Oe}(a());function r(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Ae})(F)}function n(){var Ae=new F.ARRAY_TYPE(2);return F.ARRAY_TYPE!=Float32Array&&(Ae[0]=0,Ae[1]=0),Ae}function i(F,Ae,Oe){return F[0]=Ae[0]-Oe[0],F[1]=Ae[1]-Oe[1],F}function s(F,Ae,Oe){return F[0]=Ae[0]*Oe[0],F[1]=Ae[1]*Oe[1],F}function o(F,Ae,Oe){return F[0]=Ae[0]/Oe[0],F[1]=Ae[1]/Oe[1],F}function l(F,Ae){return Math.hypot(Ae[0]-F[0],Ae[1]-F[1])}function u(F,Ae){var Oe=Ae[0]-F[0],Fe=Ae[1]-F[1];return Oe*Oe+Fe*Fe}function c(F){return Math.hypot(F[0],F[1])}function h(F){var Ae=F[0],Oe=F[1];return Ae*Ae+Oe*Oe}_a.len=c,_a.sub=i,_a.mul=s,_a.div=o,_a.dist=l,_a.sqrDist=u,_a.sqrLen=h;var Ae,Oe=(Ae=n(),function(F,Oe,Fe,Ve,qe,pt){var vt,zt;for(Oe||(Oe=2),Fe||(Fe=0),zt=Ve?Math.min(Ve*Oe+Fe,F.length):F.length,vt=Fe;vt<zt;vt+=Oe)Ae[0]=F[vt],Ae[1]=F[vt+1],qe(Ae,Ae,pt),F[vt]=Ae[0],F[vt+1]=Ae[1];return F});return _a.forEach=Oe,_a}function V(){if(ia)return Fe;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}ia=1,Object.defineProperty(Fe,"__esModule",{value:!0}),Fe.vec4=Fe.vec3=Fe.vec2=Fe.quat2=Fe.quat=Fe.mat4=Fe.mat3=Fe.mat2d=Fe.mat2=Fe.glMatrix=void 0;var F=x(a());Fe.glMatrix=F;var Ae=x(l());Fe.mat2=Ae;var Oe=x(h());Fe.mat2d=Oe;var Ve=x(d());Fe.mat3=Ve;var qe=x(g());Fe.mat4=qe;var pt=x(I());Fe.quat=pt;var vt=x(E());Fe.quat2=vt;var zt=x(C());Fe.vec2=zt;var ri=x(_());Fe.vec3=ri;var xi=x(S());function y(F){if("function"!=typeof WeakMap)return null;var Ae=new WeakMap,Oe=new WeakMap;return(y=function(F){return F?Oe:Ae})(F)}function x(F,Ae){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Oe=y(Ae);if(Oe&&Oe.has(F))return Oe.get(F);var Fe={},Ve=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var qe in F)if("default"!==qe&&Object.prototype.hasOwnProperty.call(F,qe)){var pt=Ve?Object.getOwnPropertyDescriptor(F,qe):null;pt&&(pt.get||pt.set)?Object.defineProperty(Fe,qe,pt):Fe[qe]=F[qe]}return Fe.default=F,Oe&&Oe.set(F,Fe),Fe}return Fe.vec4=xi,Fe}var Ma,Ea,Ia,rl,Sl=V(),Il=function(){if(Ea)return Ma;function t(Ae,Oe,Fe,Ve){(this||F).cx=3*Ae,(this||F).bx=3*(Fe-Ae)-(this||F).cx,(this||F).ax=1-(this||F).cx-(this||F).bx,(this||F).cy=3*Oe,(this||F).by=3*(Ve-Oe)-(this||F).cy,(this||F).ay=1-(this||F).cy-(this||F).by,(this||F).p1x=Ae,(this||F).p1y=Oe,(this||F).p2x=Fe,(this||F).p2y=Ve}return Ea=1,Ma=t,t.prototype={sampleCurveX:function(Ae){return(((this||F).ax*Ae+(this||F).bx)*Ae+(this||F).cx)*Ae},sampleCurveY:function(Ae){return(((this||F).ay*Ae+(this||F).by)*Ae+(this||F).cy)*Ae},sampleCurveDerivativeX:function(Ae){return(3*(this||F).ax*Ae+2*(this||F).bx)*Ae+(this||F).cx},solveCurveX:function(F,Ae){if(void 0===Ae&&(Ae=1e-6),F<0)return 0;if(F>1)return 1;for(var Oe=F,Fe=0;Fe<8;Fe++){var Ve=this.sampleCurveX(Oe)-F;if(Math.abs(Ve)<Ae)return Oe;var qe=this.sampleCurveDerivativeX(Oe);if(Math.abs(qe)<1e-6)break;Oe-=Ve/qe}var pt=0,vt=1;for(Oe=F,Fe=0;Fe<20&&(Ve=this.sampleCurveX(Oe),!(Math.abs(Ve-F)<Ae));Fe++)F>Ve?pt=Oe:vt=Oe,Oe=.5*(vt-pt)+pt;return Oe},solve:function(F,Ae){return this.sampleCurveY(this.solveCurveX(F,Ae))}},Ma}(),Kl=e(Il);function j(){if(rl)return Ia;function t(Ae,Oe){(this||F).x=Ae,(this||F).y=Oe}return rl=1,Ia=t,t.prototype={clone:function(){return new t((this||F).x,(this||F).y)},add:function(F){return this.clone()._add(F)},sub:function(F){return this.clone()._sub(F)},multByPoint:function(F){return this.clone()._multByPoint(F)},divByPoint:function(F){return this.clone()._divByPoint(F)},mult:function(F){return this.clone()._mult(F)},div:function(F){return this.clone()._div(F)},rotate:function(F){return this.clone()._rotate(F)},rotateAround:function(F,Ae){return this.clone()._rotateAround(F,Ae)},matMult:function(F){return this.clone()._matMult(F)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt((this||F).x*(this||F).x+(this||F).y*(this||F).y)},equals:function(Ae){return(this||F).x===Ae.x&&(this||F).y===Ae.y},dist:function(F){return Math.sqrt(this.distSqr(F))},distSqr:function(Ae){var Oe=Ae.x-(this||F).x,Fe=Ae.y-(this||F).y;return Oe*Oe+Fe*Fe},angle:function(){return Math.atan2((this||F).y,(this||F).x)},angleTo:function(Ae){return Math.atan2((this||F).y-Ae.y,(this||F).x-Ae.x)},angleWith:function(F){return this.angleWithSep(F.x,F.y)},angleWithSep:function(Ae,Oe){return Math.atan2((this||F).x*Oe-(this||F).y*Ae,(this||F).x*Ae+(this||F).y*Oe)},_matMult:function(Ae){var Oe=Ae[2]*(this||F).x+Ae[3]*(this||F).y;return(this||F).x=Ae[0]*(this||F).x+Ae[1]*(this||F).y,(this||F).y=Oe,this||F},_add:function(Ae){return(this||F).x+=Ae.x,(this||F).y+=Ae.y,this||F},_sub:function(Ae){return(this||F).x-=Ae.x,(this||F).y-=Ae.y,this||F},_mult:function(Ae){return(this||F).x*=Ae,(this||F).y*=Ae,this||F},_div:function(Ae){return(this||F).x/=Ae,(this||F).y/=Ae,this||F},_multByPoint:function(Ae){return(this||F).x*=Ae.x,(this||F).y*=Ae.y,this||F},_divByPoint:function(Ae){return(this||F).x/=Ae.x,(this||F).y/=Ae.y,this||F},_unit:function(){return this._div(this.mag()),this||F},_perp:function(){var Ae=(this||F).y;return(this||F).y=(this||F).x,(this||F).x=-Ae,this||F},_rotate:function(Ae){var Oe=Math.cos(Ae),Fe=Math.sin(Ae),Ve=Fe*(this||F).x+Oe*(this||F).y;return(this||F).x=Oe*(this||F).x-Fe*(this||F).y,(this||F).y=Ve,this||F},_rotateAround:function(Ae,Oe){var Fe=Math.cos(Ae),Ve=Math.sin(Ae),qe=Oe.y+Ve*((this||F).x-Oe.x)+Fe*((this||F).y-Oe.y);return(this||F).x=Oe.x+Fe*((this||F).x-Oe.x)-Ve*((this||F).y-Oe.y),(this||F).y=qe,this||F},_round:function(){return(this||F).x=Math.round((this||F).x),(this||F).y=Math.round((this||F).y),this||F}},t.convert=function(F){return F instanceof t?F:Array.isArray(F)?new t(F[0],F[1]):F},Ia}var Jl=e(j());function $(F,Ae){if(Array.isArray(F)){if(!Array.isArray(Ae)||F.length!==Ae.length)return!1;for(let Oe=0;Oe<F.length;Oe++)if(!$(F[Oe],Ae[Oe]))return!1;return!0}if("object"==typeof F&&null!==F&&null!==Ae){if("object"!=typeof Ae)return!1;if(Object.keys(F).length!==Object.keys(Ae).length)return!1;for(const Oe in F)if(!$(F[Oe],Ae[Oe]))return!1;return!0}return F===Ae}const Ql=Math.PI/180,ec=180/Math.PI;function X(F){return F*Ql}function Z(F){return F*ec}const tc=[[0,0],[1,0],[1,1],[0,1]];function W(F){if(F<=0)return 0;if(F>=1)return 1;const Ae=F*F,Oe=Ae*F;return 4*(F<.5?Oe:3*(F-Ae)+Oe-.75)}function K(F,Ae,Oe,Fe){const Ve=new Kl(F,Ae,Oe,Fe);return function(F){return Ve.solve(F)}}const cc=K(.25,.1,.25,1);function Q(F,Ae,Oe){return Math.min(Oe,Math.max(Ae,F))}function tt(F,Ae,Oe){return(Oe=Q((Oe-F)/(Ae-F),0,1))*Oe*(3-2*Oe)}function et(F,Ae,Oe){const Fe=Oe-Ae,Ve=((F-Ae)%Fe+Fe)%Fe+Ae;return Ve===Ae?Oe:Ve}function rt(F,Ae,Oe){if(!F.length)return Oe(null,[]);let Fe=F.length;const Ve=new Array(F.length);let qe=null;F.forEach(((F,pt)=>{Ae(F,((F,Ae)=>{F&&(qe=F),Ve[pt]=Ae,0==--Fe&&Oe(qe,Ve)}))}))}function nt(F,...Ae){for(const Oe of Ae)for(const Ae in Oe)F[Ae]=Oe[Ae];return F}let uc=1;function at(){return uc++}function st(F){return F<=1?1:Math.pow(2,Math.ceil(Math.log(F)/Math.LN2))}function ot(F,Ae){F.forEach((F=>{Ae[F]&&(Ae[F]=Ae[F].bind(Ae))}))}function lt(F,Ae){return-1!==F.indexOf(Ae,F.length-Ae.length)}function ut(Ae,Oe,Fe){const Ve={};for(const Fe in Ae)Ve[Fe]=Oe.call(this||F,Ae[Fe],Fe,Ae);return Ve}function ct(Ae,Oe,Fe){const Ve={};for(const Fe in Ae)Oe.call(this||F,Ae[Fe],Fe,Ae)&&(Ve[Fe]=Ae[Fe]);return Ve}function ht(F){return Array.isArray(F)?F.map(ht):"object"==typeof F&&F?ut(F,ht):F}const jc={};function ft(F){jc[F]||("undefined"!=typeof console&&console.warn(F),jc[F]=!0)}function dt(F,Ae,Oe){return(Oe.y-F.y)*(Ae.x-F.x)>(Ae.y-F.y)*(Oe.x-F.x)}function mt(F){let Ae=0;for(let Oe,Fe,Ve=0,qe=F.length,pt=qe-1;Ve<qe;pt=Ve++)Oe=F[Ve],Fe=F[pt],Ae+=(Fe.x-Oe.x)*(Oe.y+Fe.y);return Ae}function yt([F,Ae,Oe]){const Fe=X(Ae+90),Ve=X(Oe);return{x:F*Math.cos(Fe)*Math.sin(Ve),y:F*Math.sin(Fe)*Math.sin(Ve),z:F*Math.cos(Ve),azimuthal:Ae,polar:Oe}}function gt(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function xt(F){const Ae={};if(F.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((F,Oe,Fe,Ve)=>{const qe=Fe||Ve;return Ae[Oe]=!qe||qe.toLowerCase(),""})),Ae["max-age"]){const F=parseInt(Ae["max-age"],10);isNaN(F)?delete Ae["max-age"]:Ae["max-age"]=F}return Ae}let Gc=null;function bt(F,Ae){return[F[4*Ae],F[4*Ae+1],F[4*Ae+2],F[4*Ae+3]]}function _t(F,Ae,Oe,Fe){for(;Ae<Oe;){const Ve=Ae+Oe>>1;F[Ve]<Fe?Ae=Ve+1:Oe=Ve}return Ae}function wt(F,Ae,Oe,Fe){for(;Ae<Oe;){const Ve=Ae+Oe>>1;F[Ve]<=Fe?Ae=Ve+1:Oe=Ve}return Ae}function Mt(F){return F>0?1/(1.001-F):1+F}function At(F){return F>0?1-1/(1.001-F):-F}const qc={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!qc.API_URL)return null;try{const F=new URL(qc.API_URL);return"api.mapbox.cn"===F.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===F.hostname?"https://events.mapbox.com/events/v2":null}catch(F){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function It(F){return qc.API_URL_REGEX.test(F)}function Pt(F){return qc.API_SPRITE_REGEX.test(F)}let $c,Hc,Wc,Kc,Jc,Qc;function Vt(){return null==$c&&($c=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),$c}const eh={now:()=>void 0!==Kc?Kc:performance.now(),setNow(F){Kc=F},restoreNow(){Kc=void 0},frame(F){const Ae=requestAnimationFrame(F);return{cancel:()=>cancelAnimationFrame(Ae)}},getImageData(F,Ae=0){const{width:Oe,height:Fe}=F;Jc||(Jc=document.createElement("canvas"));const Ve=Jc.getContext("2d",{willReadFrequently:!0});if(!Ve)throw new Error("failed to create canvas 2d context");return(Oe>Jc.width||Fe>Jc.height)&&(Jc.width=Oe,Jc.height=Fe),Ve.clearRect(-Ae,-Ae,Oe+2*Ae,Fe+2*Ae),Ve.drawImage(F,0,0,Oe,Fe),Ve.getImageData(-Ae,-Ae,Oe+2*Ae,Fe+2*Ae)},resolveURL:F=>(Hc||(Hc=document.createElement("a")),Hc.href=F,Hc.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==Wc&&(Wc=window.matchMedia("(prefers-reduced-motion: reduce)")),Wc.matches)},hasCanvasFingerprintNoise(){if(void 0!==Qc)return Qc;if(!Vt())return Qc=!1,!1;const F=new OffscreenCanvas(85,1),Ae=F.getContext("2d",{willReadFrequently:!0});let Oe=0;for(let Fe=0;Fe<F.width;++Fe)Ae.fillStyle=`rgba(${Oe++},${Oe++},${Oe++}, 255)`,Ae.fillRect(Fe,0,1,1);const Fe=Ae.getImageData(0,0,F.width,F.height);Oe=0;for(let F=0;F<Fe.data.length;++F)if(F%4!=3&&Oe++!==Fe.data[F])return Qc=!0,!0;return Qc=!1,!1}};function Lt(F,Ae){const Oe=F.indexOf("?");if(Oe<0)return`${F}?${new URLSearchParams(Ae).toString()}`;const Fe=new URLSearchParams(F.slice(Oe));for(const F in Ae)Fe.set(F,Ae[F]);return`${F.slice(0,Oe)}?${Fe.toString()}`}function Rt(F,Ae={persistentParams:[]}){const Oe=F.indexOf("?");if(Oe<0)return F;const Fe=new URLSearchParams,Ve=new URLSearchParams(F.slice(Oe));for(const F of Ae.persistentParams){const Ae=Ve.get(F);Ae&&Fe.set(F,Ae)}const qe=Fe.toString();return`${F.slice(0,Oe)}${qe.length>0?`?${qe}`:""}`}const th="mapbox-tiles";let ih=500,rh=50;const nh=["language","worldview","jobid"];let oh,sh;function $t(){try{return caches}catch(F){}}function Gt(){const F=$t();F&&null==oh&&(oh=F.open(th))}let ah=1/0;const lh={supported:!1,testSupport:function(F){!vh&&fh&&(Th?Qt(F):uh=F)}};let uh,fh,vh=!1,Th=!1;const Ch="undefined"!=typeof self?self:{};function Qt(F){const Ae=F.createTexture();F.bindTexture(F.TEXTURE_2D,Ae);try{if(F.texImage2D(F.TEXTURE_2D,0,F.RGBA,F.RGBA,F.UNSIGNED_BYTE,fh),F.isContextLost())return;lh.supported=!0}catch(F){}F.deleteTexture(Ae),vh=!0}Ch.document&&(fh=Ch.document.createElement("img"),fh.onload=function(){uh&&Qt(uh),uh=null,Th=!0},fh.onerror=function(){vh=!0,uh=null},fh.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Dh={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(Dh);class ee extends Error{constructor(F,Ae,Oe){401===Ae&&It(Oe)&&(F+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(F),this.status=Ae,this.url=Oe}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Rh=gt()?()=>self.worker&&self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href;const ne=function(F,Ae){if(!(/^file:/.test(Oe=F.url)||/^file:/.test(Rh())&&!/^\w+:/.test(Oe))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(F,Ae){const Oe=new AbortController,Fe=new Request(F.url,{method:F.method||"GET",body:F.body,credentials:F.credentials,headers:F.headers,referrer:Rh(),referrerPolicy:F.referrerPolicy,signal:Oe.signal});let Ve=!1,qe=!1;const pt=(vt=Fe.url).indexOf("sku=")>0&&It(vt);var vt;"json"===F.type&&Fe.headers.set("Accept","application/json");const l=(Oe,Ve,vt)=>{if(qe)return;if(Oe&&"SecurityError"!==Oe.message&&ft(Oe.toString()),Ve&&vt)return u(Ve);const zt=Date.now();fetch(Fe).then((Oe=>{if(Oe.ok){const F=pt?Oe.clone():null;return u(Oe,F,zt)}return Ae(new ee(Oe.statusText,Oe.status,F.url))})).catch((Oe=>{"AbortError"!==Oe.name&&Ae(new Error(`${Oe.message} ${F.url}`))}))},u=(Oe,pt,vt)=>{("arrayBuffer"===F.type?Oe.arrayBuffer():"json"===F.type?Oe.json():Oe.text()).then((F=>{qe||(pt&&vt&&function(F,Ae,Oe){if(Gt(),null==oh)return;const Fe=xt(Ae.headers.get("Cache-Control")||"");if(Fe["no-store"])return;const Ve={status:Ae.status,statusText:Ae.statusText,headers:new Headers};Ae.headers.forEach(((F,Ae)=>Ve.headers.set(Ae,F))),Fe["max-age"]&&Ve.headers.set("Expires",new Date(Oe+1e3*Fe["max-age"]).toUTCString());const qe=Ve.headers.get("Expires");if(!qe)return;if(new Date(qe).getTime()-Oe<42e4)return;let pt=Rt(F.url,{persistentParams:nh});if(206===Ae.status){const Ae=F.headers.get("Range");if(!Ae)return;Ve.status=200,pt=Lt(pt,{range:Ae})}!function(F,Ae){if(void 0===sh)try{new Response(new ReadableStream),sh=!0}catch(F){sh=!1}sh?Ae(F.body):F.blob().then(Ae)}(Ae,(F=>{const Oe=new Response(200!==(Fe=Ae.status)&&404!==Fe&&[101,103,204,205,304].includes(Fe)?null:F,Ve);var Fe;Gt(),null!=oh&&oh.then((F=>F.put(pt,Oe))).catch((F=>ft(F.message)))}))}(Fe,pt,vt),Ve=!0,Ae(null,F,Oe.headers.get("Cache-Control"),Oe.headers.get("Expires")))})).catch((F=>{qe||Ae(new Error(F.message))}))};return pt?function(F,Ae){if(Gt(),null==oh)return Ae(null);oh.then((Oe=>{let Fe=Rt(F.url,{persistentParams:nh});const Ve=F.headers.get("Range");Ve&&(Fe=Lt(Fe,{range:Ve})),Oe.match(Fe).then((F=>{const Ve=function(F){if(!F)return!1;const Ae=new Date(F.headers.get("Expires")||0),Oe=xt(F.headers.get("Cache-Control")||"");return Ae>Date.now()&&!Oe["no-cache"]}(F);Oe.delete(Fe),Ve&&Oe.put(Fe,F.clone()),Ae(null,F,Ve)})).catch(Ae)})).catch(Ae)}(Fe,l):l(null,null),{cancel:()=>{qe=!0,Ve||Oe.abort()}}}(F,Ae);if(gt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",F,Ae,void 0,!0)}var Oe;return function(F,Ae){const Oe=new XMLHttpRequest;Oe.open(F.method||"GET",F.url,!0),"arrayBuffer"===F.type&&(Oe.responseType="arraybuffer");for(const Ae in F.headers)Oe.setRequestHeader(Ae,F.headers[Ae]);return"json"===F.type&&(Oe.responseType="text",Oe.setRequestHeader("Accept","application/json")),Oe.withCredentials="include"===F.credentials,Oe.onerror=()=>{Ae(new Error(Oe.statusText))},Oe.onload=()=>{if((Oe.status>=200&&Oe.status<300||0===Oe.status)&&null!==Oe.response){let Fe=Oe.response;if("json"===F.type)try{Fe=JSON.parse(Oe.response)}catch(F){return Ae(F)}Ae(null,Fe,Oe.getResponseHeader("Cache-Control"),Oe.getResponseHeader("Expires"))}else Ae(new ee(Oe.statusText,Oe.status,F.url))},Oe.send(F.body),{cancel:()=>Oe.abort()}}(F,Ae)},ie=function(F,Ae){return ne(nt(F,{type:"arrayBuffer"}),Ae)};function ae(F){const Ae=document.createElement("a");return Ae.href=F,Ae.protocol===location.protocol&&Ae.host===location.host}const Lh="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Oh,Fh;Oh=[],Fh=0;const ue=function(Ae,Oe){if(lh.supported&&(Ae.headers||(Ae.headers={}),Ae.headers.accept="image/webp,*/*"),Fh>=qc.MAX_PARALLEL_IMAGE_REQUESTS){const Fe={requestParameters:Ae,callback:Oe,cancelled:!1,cancel(){(this||F).cancelled=!0}};return Oh.push(Fe),Fe}Fh++;let Fe=!1;const n=()=>{if(!Fe)for(Fe=!0,Fh--;Oh.length&&Fh<qc.MAX_PARALLEL_IMAGE_REQUESTS;){const F=Oh.shift(),{requestParameters:Ae,callback:Oe,cancelled:Fe}=F;Fe||(F.cancel=ue(Ae,Oe).cancel)}},Ve=ie(Ae,((F,Ae,Fe,Ve)=>{n(),F?Oe(F):Ae&&(self.createImageBitmap?function(F,Ae){const Oe=new Blob([new Uint8Array(F)],{type:"image/png"});createImageBitmap(Oe).then((F=>{Ae(null,F)})).catch((F=>{Ae(new Error(`Could not load image because of ${F.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(Ae,((F,Ae)=>Oe(F,Ae,Fe,Ve))):function(F,Ae){const Oe=new Image;Oe.onload=()=>{Ae(null,Oe),URL.revokeObjectURL(Oe.src),Oe.onload=null,requestAnimationFrame((()=>{Oe.src=Lh}))},Oe.onerror=()=>Ae(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const Fe=new Blob([new Uint8Array(F)],{type:"image/png"});Oe.src=F.byteLength?URL.createObjectURL(Fe):Lh}(Ae,((F,Ae)=>Oe(F,Ae,Fe,Ve))))}));return{cancel:()=>{Ve.cancel(),n()}}};var Vh,Zh,eu,tu={exports:{}},ou={exports:{}},su={exports:{}},lu=function(){if(eu)return tu.exports;eu=1;var F=(Vh||(Vh=1,ou.exports=function(F,Ae){var Oe,Fe,Ve,qe,pt,vt,zt,ri;for(Fe=F.length-(Oe=3&F.length),Ve=Ae,pt=3432918353,vt=461845907,ri=0;ri<Fe;)zt=255&F.charCodeAt(ri)|(255&F.charCodeAt(++ri))<<8|(255&F.charCodeAt(++ri))<<16|(255&F.charCodeAt(++ri))<<24,++ri,Ve=27492+(65535&(qe=5*(65535&(Ve=(Ve^=zt=(65535&(zt=(zt=(65535&zt)*pt+(((zt>>>16)*pt&65535)<<16)&4294967295)<<15|zt>>>17))*vt+(((zt>>>16)*vt&65535)<<16)&4294967295)<<13|Ve>>>19))+((5*(Ve>>>16)&65535)<<16)&4294967295))+((58964+(qe>>>16)&65535)<<16);switch(zt=0,Oe){case 3:zt^=(255&F.charCodeAt(ri+2))<<16;case 2:zt^=(255&F.charCodeAt(ri+1))<<8;case 1:Ve^=zt=(65535&(zt=(zt=(65535&(zt^=255&F.charCodeAt(ri)))*pt+(((zt>>>16)*pt&65535)<<16)&4294967295)<<15|zt>>>17))*vt+(((zt>>>16)*vt&65535)<<16)&4294967295}return Ve^=F.length,Ve=2246822507*(65535&(Ve^=Ve>>>16))+((2246822507*(Ve>>>16)&65535)<<16)&4294967295,Ve=3266489909*(65535&(Ve^=Ve>>>13))+((3266489909*(Ve>>>16)&65535)<<16)&4294967295,(Ve^=Ve>>>16)>>>0}),ou.exports),Ae=(Zh||(Zh=1,su.exports=function(F,Ae){for(var Oe,Fe=F.length,Ve=Ae^Fe,qe=0;Fe>=4;)Oe=1540483477*(65535&(Oe=255&F.charCodeAt(qe)|(255&F.charCodeAt(++qe))<<8|(255&F.charCodeAt(++qe))<<16|(255&F.charCodeAt(++qe))<<24))+((1540483477*(Oe>>>16)&65535)<<16),Ve=1540483477*(65535&Ve)+((1540483477*(Ve>>>16)&65535)<<16)^(Oe=1540483477*(65535&(Oe^=Oe>>>24))+((1540483477*(Oe>>>16)&65535)<<16)),Fe-=4,++qe;switch(Fe){case 3:Ve^=(255&F.charCodeAt(qe+2))<<16;case 2:Ve^=(255&F.charCodeAt(qe+1))<<8;case 1:Ve=1540483477*(65535&(Ve^=255&F.charCodeAt(qe)))+((1540483477*(Ve>>>16)&65535)<<16)}return Ve=1540483477*(65535&(Ve^=Ve>>>13))+((1540483477*(Ve>>>16)&65535)<<16),(Ve^=Ve>>>15)>>>0}),su.exports);return tu.exports=F,tu.exports.murmur3=F,tu.exports.murmur2=Ae,tu.exports}(),cu=e(lu);class xe{constructor(F,...Ae){nt(this,Ae[0]||{}),this.type=F}}class ve extends xe{constructor(F,Ae={}){super("error",nt({error:F},Ae))}}function be(F,Ae,Oe){Oe[F]&&-1!==Oe[F].indexOf(Ae)||(Oe[F]=Oe[F]||[],Oe[F].push(Ae))}function _e(F,Ae,Oe){if(Oe&&Oe[F]){const Fe=Oe[F].indexOf(Ae);-1!==Fe&&Oe[F].splice(Fe,1)}}class we{on(F,Ae){return this._listeners=this._listeners||{},be(F,Ae,this._listeners),this}off(F,Ae){return _e(F,Ae,this._listeners),_e(F,Ae,this._oneTimeListeners),this}once(F,Ae){return Ae?(this._oneTimeListeners=this._oneTimeListeners||{},be(F,Ae,this._oneTimeListeners),this):new Promise((Ae=>this.once(F,Ae)))}fire(F,Ae){const Oe="string"==typeof F?new xe(F,Ae):F,Fe=Oe.type;if(this.listens(Fe)){Oe.target=this;const F=this._listeners&&this._listeners[Fe]?this._listeners[Fe].slice():[];for(const Ae of F)Ae.call(this,Oe);const Ae=this._oneTimeListeners&&this._oneTimeListeners[Fe]?this._oneTimeListeners[Fe].slice():[];for(const F of Ae)_e(Fe,F,this._oneTimeListeners),F.call(this,Oe);const Ve=this._eventedParent;Ve&&(nt(Oe,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),Ve.fire(Oe))}else Oe instanceof ve&&console.error(Oe.error);return this}listens(F){return!!(this._listeners&&this._listeners[F]&&this._listeners[F].length>0||this._oneTimeListeners&&this._oneTimeListeners[F]&&this._oneTimeListeners[F].length>0||this._eventedParent&&this._eventedParent.listens(F))}setEventedParent(F,Ae){return this._eventedParent=F,this._eventedParentData=Ae,this}}var uu,bu={},Bu=function(){if(uu)return bu;uu=1;var F={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(F){return(F=Math.round(F))<0?0:F>255?255:F}function r(F){return e("%"===F[F.length-1]?parseFloat(F)/100*255:parseInt(F))}function n(F){return(Ae="%"===F[F.length-1]?parseFloat(F)/100:parseFloat(F))<0?0:Ae>1?1:Ae;var Ae}function i(F,Ae,Oe){return Oe<0?Oe+=1:Oe>1&&(Oe-=1),6*Oe<1?F+(Ae-F)*Oe*6:2*Oe<1?Ae:3*Oe<2?F+(Ae-F)*(2/3-Oe)*6:F}try{bu.parseCSSColor=function(Ae){var Oe,Fe=Ae.replace(/ /g,"").toLowerCase();if(Fe in F)return F[Fe].slice();if("#"===Fe[0])return 4===Fe.length?(Oe=parseInt(Fe.substr(1),16))>=0&&Oe<=4095?[(3840&Oe)>>4|(3840&Oe)>>8,240&Oe|(240&Oe)>>4,15&Oe|(15&Oe)<<4,1]:null:7===Fe.length&&(Oe=parseInt(Fe.substr(1),16))>=0&&Oe<=16777215?[(16711680&Oe)>>16,(65280&Oe)>>8,255&Oe,1]:null;var Ve=Fe.indexOf("("),qe=Fe.indexOf(")");if(-1!==Ve&&qe+1===Fe.length){var pt=Fe.substr(0,Ve),vt=Fe.substr(Ve+1,qe-(Ve+1)).split(","),zt=1;switch(pt){case"rgba":if(4!==vt.length)return null;zt=n(vt.pop());case"rgb":return 3!==vt.length?null:[r(vt[0]),r(vt[1]),r(vt[2]),zt];case"hsla":if(4!==vt.length)return null;zt=n(vt.pop());case"hsl":if(3!==vt.length)return null;var ri=(parseFloat(vt[0])%360+360)%360/360,xi=n(vt[1]),bi=n(vt[2]),wi=bi<=.5?bi*(xi+1):bi+xi-bi*xi,dr=2*bi-wi;return[e(255*i(dr,wi,ri+1/3)),e(255*i(dr,wi,ri)),e(255*i(dr,wi,ri-1/3)),zt];default:return null}}return null}}catch(F){}return bu}();class Ie{constructor(F,Ae,Oe,Fe=1){this.r=F,this.g=Ae,this.b=Oe,this.a=Fe}static parse(F){if(!F)return;if(F instanceof Ie)return F;if("string"!=typeof F)return;const Ae=Bu.parseCSSColor(F);return Ae?new Ie(Ae[0]/255*Ae[3],Ae[1]/255*Ae[3],Ae[2]/255*Ae[3],Ae[3]):void 0}toStringPremultipliedAlpha(){const[F,Ae,Oe,Fe]=0===this.a?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(F)},${Math.round(Ae)},${Math.round(Oe)},${Fe})`}toString(){const[F,Ae,Oe,Fe]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*F)},${Math.round(255*Ae)},${Math.round(255*Oe)},${Fe})`}toRenderColor(F){const{r:Ae,g:Oe,b:Fe,a:Ve}=this;return new Pe(F,Ae,Oe,Fe,Ve)}clone(){return new Ie(this.r,this.g,this.b,this.a)}}class Pe{constructor(F,Ae,Oe,Fe,Ve){if(F){const qe=F.image.height,pt=qe*qe;Ae=0===Ve?0:Ae/Ve*(qe-1),Oe=0===Ve?0:Oe/Ve*(qe-1),Fe=0===Ve?0:Fe/Ve*(qe-1);const vt=Math.floor(Ae),zt=Math.floor(Oe),ri=Math.floor(Fe),xi=Math.ceil(Ae),bi=Math.ceil(Oe),wi=Math.ceil(Fe),dr=Ae-vt,jr=Oe-zt,Qr=Fe-ri,Xn=F.image.data,ho=4*(vt+zt*pt+ri*qe),yo=4*(vt+zt*pt+wi*qe),zo=4*(vt+bi*pt+ri*qe),ko=4*(vt+bi*pt+wi*qe),Uo=4*(xi+zt*pt+ri*qe),ia=4*(xi+zt*pt+wi*qe),_a=4*(xi+bi*pt+ri*qe),Ma=4*(xi+bi*pt+wi*qe);if(ho<0||Ma>=Xn.length)throw new Error("out of range");this.r=ze(ze(ze(Xn[ho],Xn[yo],Qr),ze(Xn[zo],Xn[ko],Qr),jr),ze(ze(Xn[Uo],Xn[ia],Qr),ze(Xn[_a],Xn[Ma],Qr),jr),dr)/255*Ve,this.g=ze(ze(ze(Xn[ho+1],Xn[yo+1],Qr),ze(Xn[zo+1],Xn[ko+1],Qr),jr),ze(ze(Xn[Uo+1],Xn[ia+1],Qr),ze(Xn[_a+1],Xn[Ma+1],Qr),jr),dr)/255*Ve,this.b=ze(ze(ze(Xn[ho+2],Xn[yo+2],Qr),ze(Xn[zo+2],Xn[ko+2],Qr),jr),ze(ze(Xn[Uo+2],Xn[ia+2],Qr),ze(Xn[_a+2],Xn[Ma+2],Qr),jr),dr)/255*Ve,this.a=Ve}else this.r=Ae,this.g=Oe,this.b=Fe,this.a=Ve}toArray(){const{r:F,g:Ae,b:Oe,a:Fe}=this;return 0===Fe?[0,0,0,0]:[255*F/Fe,255*Ae/Fe,255*Oe/Fe,Fe]}toHslaArray(){if(0===this.a)return[0,0,0,0];const{r:F,g:Ae,b:Oe,a:Fe}=this,Ve=Math.min(Math.max(F/Fe,0),1),qe=Math.min(Math.max(Ae/Fe,0),1),pt=Math.min(Math.max(Oe/Fe,0),1),vt=Math.min(Ve,qe,pt),zt=Math.max(Ve,qe,pt),ri=(vt+zt)/2;if(vt===zt)return[0,0,100*ri,Fe];const xi=zt-vt,bi=ri>.5?xi/(2-zt-vt):xi/(zt+vt);let wi=0;return zt===Ve?wi=(qe-pt)/xi+(qe<pt?6:0):zt===qe?wi=(pt-Ve)/xi+2:zt===pt&&(wi=(Ve-qe)/xi+4),wi*=60,[Math.min(Math.max(wi,0),360),Math.min(Math.max(100*bi,0),100),Math.min(Math.max(100*ri,0),100),Fe]}toArray01(){const{r:F,g:Ae,b:Oe,a:Fe}=this;return 0===Fe?[0,0,0,0]:[F/Fe,Ae/Fe,Oe/Fe,Fe]}toArray01Scaled(F){const{r:Ae,g:Oe,b:Fe,a:Ve}=this;return 0===Ve?[0,0,0]:[Ae/Ve*F,Oe/Ve*F,Fe/Ve*F]}toArray01PremultipliedAlpha(){const{r:F,g:Ae,b:Oe,a:Fe}=this;return[F,Ae,Oe,Fe]}toArray01Linear(){const{r:F,g:Ae,b:Oe,a:Fe}=this;return 0===Fe?[0,0,0,0]:[Math.pow(F/Fe,2.2),Math.pow(Ae/Fe,2.2),Math.pow(Oe/Fe,2.2),Fe]}}function ze(F,Ae,Oe){return F*(1-Oe)+Ae*Oe}function Ee(F,Ae,Oe){return F.map(((F,Fe)=>ze(F,Ae[Fe],Oe)))}Ie.black=new Ie(0,0,0,1),Ie.white=new Ie(1,1,1,1),Ie.transparent=new Ie(0,0,0,0),Ie.red=new Ie(1,0,0,1),Ie.blue=new Ie(0,0,1,1);var Uu=Object.freeze({__proto__:null,array:Ee,color:function(F,Ae,Oe){return new Ie(ze(F.r,Ae.r,Oe),ze(F.g,Ae.g,Oe),ze(F.b,Ae.b,Oe),ze(F.a,Ae.a,Oe))},number:ze});function Te(F,...Ae){for(const Oe of Ae)for(const Ae in Oe)F[Ae]=Oe[Ae];return F}class Be extends Error{constructor(F,Ae){super(Ae),this.message=Ae,this.key=F}}class Ce{constructor(F,Ae=[]){this.parent=F,this.bindings={};for(const[F,Oe]of Ae)this.bindings[F]=Oe}concat(F){return new Ce(this,F)}get(F){if(this.bindings[F])return this.bindings[F];if(this.parent)return this.parent.get(F);throw new Error(`${F} not found in scope.`)}has(F){return!!this.bindings[F]||!!this.parent&&this.parent.has(F)}}const ju={kind:"null"},qu={kind:"number"},Zu={kind:"string"},$u={kind:"boolean"},Hu={kind:"color"},Ju={kind:"object"},Qu={kind:"value"},cd={kind:"collator"},ud={kind:"formatted"},dd={kind:"resolvedImage"};function $e(F,Ae){return{kind:"array",itemType:F,N:Ae}}function Ge(F){if("array"===F.kind){const Ae=Ge(F.itemType);return"number"==typeof F.N?`array<${Ae}, ${F.N}>`:"value"===F.itemType.kind?"array":`array<${Ae}>`}return F.kind}const md=[ju,qu,Zu,$u,Hu,ud,Ju,$e(Qu),dd];function Xe(F,Ae){if("error"===Ae.kind)return null;if("array"===F.kind){if("array"===Ae.kind&&(0===Ae.N&&"value"===Ae.itemType.kind||!Xe(F.itemType,Ae.itemType))&&("number"!=typeof F.N||F.N===Ae.N))return null}else{if(F.kind===Ae.kind)return null;if("value"===F.kind)for(const F of md)if(!Xe(F,Ae))return null}return`Expected ${Ge(F)} but found ${Ge(Ae)} instead.`}function Ze(F,Ae){return Ae.some((Ae=>Ae.kind===F.kind))}function He(F,Ae){return Ae.some((Ae=>"null"===Ae?null===F:"array"===Ae?Array.isArray(F):"object"===Ae?F&&!Array.isArray(F)&&"object"==typeof F:Ae===typeof F))}class We{constructor(F,Ae,Oe){this.sensitivity=F?Ae?"variant":"case":Ae?"accent":"base",this.locale=Oe,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(F,Ae){return this.collator.compare(F,Ae)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Ke{constructor(F,Ae,Oe,Fe,Ve){this.text=F.normalize?F.normalize():F,this.image=Ae,this.scale=Oe,this.fontStack=Fe,this.textColor=Ve}}class Je{constructor(F){this.sections=F}static fromString(F){return new Je([new Ke(F,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((F=>0!==F.text.length||F.image&&F.image.namePrimary))}static factory(F){return F instanceof Je?F:Je.fromString(F)}toString(){return 0===this.sections.length?"":this.sections.map((F=>F.text)).join("")}serialize(){const F=["format"];for(const Ae of this.sections){if(Ae.image){F.push(["image",Ae.image.namePrimary]);continue}F.push(Ae.text);const Oe={};Ae.fontStack&&(Oe["text-font"]=["literal",Ae.fontStack.split(",")]),Ae.scale&&(Oe["font-scale"]=Ae.scale),Ae.textColor&&(Oe["text-color"]=["rgba"].concat(Ae.textColor.toRenderColor(null).toArray())),F.push(Oe)}return F}}class Qe{constructor(F,Ae){if(this.id=F,this.options=Ae||{params:{}},this.options.transform){const{a:F,b:Ae,c:Oe,d:Fe,e:Ve,f:qe}=this.options.transform;this.options.transform=new DOMMatrix([F,Ae,Oe,Fe,Ve,qe])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}static deserializeId(F){return JSON.parse(F).id}static deserializeFromString(F){const Ae=JSON.parse(F),{a:Oe,b:Fe,c:Ve,d:qe,e:pt,f:vt}=Ae.options.transform;return new DOMMatrix([Oe,Fe,Ve,qe,pt,vt]),new Qe(Ae.id,Ae.options)}scaleSelf(F){return this.options.transform=this.options.transform.scale(F),this}serialize(){const F={id:this.id};this.options&&(F.options=this.options);const{a:Ae,b:Oe,c:Fe,d:Ve,e:qe,f:pt}=this.options.transform;return F.options.transform={a:Ae,b:Oe,c:Fe,d:Ve,e:qe,f:pt},JSON.stringify(F)}}class tr{constructor(F){this.namePrimary=F.namePrimary,F.nameSecondary&&(this.nameSecondary=F.nameSecondary),F.optionsPrimary&&(this.optionsPrimary=F.optionsPrimary),F.optionsSecondary&&(this.optionsSecondary=F.optionsSecondary),this.available=F.available}toString(){return this.namePrimary&&this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}getPrimary(){return new Qe(this.namePrimary,{params:this.optionsPrimary&&this.optionsPrimary.params||{}})}getSerializedPrimary(){return this.getPrimary().serialize()}getSecondary(){return this.nameSecondary?new Qe(this.nameSecondary,{params:this.optionsSecondary&&this.optionsSecondary.params||{}}):null}static from(F){return"string"==typeof F?tr.build(F):F}static build(F,Ae,Oe,Fe){return F?new tr({namePrimary:F,nameSecondary:Ae,optionsPrimary:Oe,optionsSecondary:Fe,available:!1}):null}}function er(F,Ae,Oe,Fe){return"number"==typeof F&&F>=0&&F<=255&&"number"==typeof Ae&&Ae>=0&&Ae<=255&&"number"==typeof Oe&&Oe>=0&&Oe<=255?void 0===Fe||"number"==typeof Fe&&Fe>=0&&Fe<=1?null:`Invalid rgba value [${[F,Ae,Oe,Fe].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof Fe?[F,Ae,Oe,Fe]:[F,Ae,Oe]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function rr(F){if(null===F)return!0;if("string"==typeof F)return!0;if("boolean"==typeof F)return!0;if("number"==typeof F)return!0;if(F instanceof Ie)return!0;if(F instanceof We)return!0;if(F instanceof Je)return!0;if(F instanceof tr)return!0;if(Array.isArray(F)){for(const Ae of F)if(!rr(Ae))return!1;return!0}if("object"==typeof F){for(const Ae in F)if(!rr(F[Ae]))return!1;return!0}return!1}function nr(F){if(null===F)return ju;if("string"==typeof F)return Zu;if("boolean"==typeof F)return $u;if("number"==typeof F)return qu;if(F instanceof Ie)return Hu;if(F instanceof We)return cd;if(F instanceof Je)return ud;if(F instanceof tr)return dd;if(Array.isArray(F)){const Ae=F.length;let Oe;for(const Ae of F){const F=nr(Ae);if(Oe){if(Oe===F)continue;Oe=Qu;break}Oe=F}return $e(Oe||Qu,Ae)}return Ju}function ir(F){const Ae=typeof F;return null===F?"":"string"===Ae||"number"===Ae||"boolean"===Ae?String(F):F instanceof Ie?F.toStringPremultipliedAlpha():F instanceof Je||F instanceof tr?F.toString():JSON.stringify(F)}class ar{constructor(F,Ae){this.type=F,this.value=Ae}static parse(F,Ae){if(2!==F.length)return Ae.error(`'literal' expression requires exactly one argument, but found ${F.length-1} instead.`);if(!rr(F[1]))return Ae.error("invalid value");const Oe=F[1];let Fe=nr(Oe);const Ve=Ae.expectedType;return"array"!==Fe.kind||0!==Fe.N||!Ve||"array"!==Ve.kind||"number"==typeof Ve.N&&0!==Ve.N||(Fe=Ve),new ar(Fe,Oe)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Ie?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof Je?this.value.serialize():this.value}}class sr{constructor(F){this.name="ExpressionEvaluationError",this.message=F}toJSON(){return this.message}}const Td={string:Zu,number:qu,boolean:$u,object:Ju};class lr{constructor(F,Ae){this.type=F,this.args=Ae}static parse(F,Ae){if(F.length<2)return Ae.error("Expected at least one argument.");let Oe,Fe=1;const Ve=F[0];if("array"===Ve){let Ve,qe;if(F.length>2){const Oe=F[1];if("string"!=typeof Oe||!(Oe in Td)||"object"===Oe)return Ae.error('The item type argument of "array" must be one of string, number, boolean',1);Ve=Td[Oe],Fe++}else Ve=Qu;if(F.length>3){if(null!==F[2]&&("number"!=typeof F[2]||F[2]<0||F[2]!==Math.floor(F[2])))return Ae.error('The length argument to "array" must be a positive integer literal',2);qe=F[2],Fe++}Oe=$e(Ve,qe)}else Oe=Td[Ve];const qe=[];for(;Fe<F.length;Fe++){const Oe=Ae.parse(F[Fe],Fe,Qu);if(!Oe)return null;qe.push(Oe)}return new lr(Oe,qe)}evaluate(F){for(let Ae=0;Ae<this.args.length;Ae++){const Oe=this.args[Ae].evaluate(F);if(!Xe(this.type,nr(Oe)))return Oe;if(Ae===this.args.length-1)throw new sr(`The expression ${JSON.stringify(this.args[Ae].serialize())} evaluated to ${Ge(nr(Oe))} but was expected to be of type ${Ge(this.type)}.`)}return null}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every((F=>F.outputDefined()))}serialize(){const F=this.type,Ae=[F.kind];if("array"===F.kind){const Oe=F.itemType;if("string"===Oe.kind||"number"===Oe.kind||"boolean"===Oe.kind){Ae.push(Oe.kind);const Fe=F.N;("number"==typeof Fe||this.args.length>1)&&Ae.push(Fe)}}return Ae.concat(this.args.map((F=>F.serialize())))}}class ur{constructor(F){this.type=ud,this.sections=F}static parse(F,Ae){if(F.length<2)return Ae.error("Expected at least one argument.");const Oe=F[1];if(!Array.isArray(Oe)&&"object"==typeof Oe)return Ae.error("First argument must be an image or text section.");const Fe=[];let Ve=!1;for(let Oe=1;Oe<=F.length-1;++Oe){const qe=F[Oe];if(Ve&&"object"==typeof qe&&!Array.isArray(qe)){Ve=!1;let F=null;if(qe["font-scale"]&&(F=Ae.parseObjectValue(qe["font-scale"],Oe,"font-scale",qu),!F))return null;let pt=null;if(qe["text-font"]&&(pt=Ae.parseObjectValue(qe["text-font"],Oe,"text-font",$e(Zu)),!pt))return null;let vt=null;if(qe["text-color"]&&(vt=Ae.parseObjectValue(qe["text-color"],Oe,"text-color",Hu),!vt))return null;const zt=Fe[Fe.length-1];zt.scale=F,zt.font=pt,zt.textColor=vt}else{const qe=Ae.parse(F[Oe],Oe,Qu);if(!qe)return null;const pt=qe.type.kind;if("string"!==pt&&"value"!==pt&&"null"!==pt&&"resolvedImage"!==pt)return Ae.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");Ve=!0,Fe.push({content:qe,scale:null,font:null,textColor:null})}}return new ur(Fe)}evaluate(F){return new Je(this.sections.map((Ae=>{const Oe=Ae.content.evaluate(F);return nr(Oe)===dd?new Ke("",Oe,null,null,null):new Ke(ir(Oe),null,Ae.scale?Ae.scale.evaluate(F):null,Ae.font?Ae.font.evaluate(F).join(","):null,Ae.textColor?Ae.textColor.evaluate(F):null)})))}eachChild(F){for(const Ae of this.sections)F(Ae.content),Ae.scale&&F(Ae.scale),Ae.font&&F(Ae.font),Ae.textColor&&F(Ae.textColor)}outputDefined(){return!1}serialize(){const F=["format"];for(const Ae of this.sections){F.push(Ae.content.serialize());const Oe={};Ae.scale&&(Oe["font-scale"]=Ae.scale.serialize()),Ae.font&&(Oe["text-font"]=Ae.font.serialize()),Ae.textColor&&(Oe["text-color"]=Ae.textColor.serialize()),F.push(Oe)}return F}}class cr{constructor(F,Ae,Oe,Fe){this._imageWarnHistory={},this.type=dd,this.inputPrimary=F,this.inputSecondary=Ae,this.inputPrimaryParams=Oe,this.inputSecondaryParams=Fe}static parse(F,Ae){if(F.length<2)return Ae.error("Expected two or more arguments.");let Oe=1;const Fe=[];function i(){if(Oe<F.length){const Ve=Ae.parse(F[Oe],Oe++,Zu);return Ve?(Fe.push({image:Ve,options:void 0}),!0):(Ae.error(Fe.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function a(){if(Oe<F.length){if(null===(Ve=F[Oe])||"object"!=typeof Ve||Array.isArray(Ve))return!0;const qe=F[Oe].params,pt=Ae.concat(Oe);if(!qe)return Oe++,!0;if("object"!=typeof qe||qe.constructor!==Object)return pt.error('Image options "params" should be an object'),!1;const vt={},zt=pt.concat(void 0,"params");for(const F in qe){if(!F)return zt.error("Image parameter name should be non-empty"),!1;const Ae=zt.concat(void 0,F).parse(qe[F],void 0,Hu,void 0,{typeAnnotation:"coerce"});if(!Ae)return!1;vt[F]=Ae}return Fe[Fe.length-1].options=vt,Oe++,!0}var Ve;return!0}for(let F=0;F<2;F++)if(!i()||!a())return;return new cr(Fe[0].image,Fe[1]?Fe[1].image:void 0,Fe[0].options,Fe[1]?Fe[1].options:void 0)}evaluateParams(F,Ae){const Oe={};if(Ae){for(const Fe in Ae)if(Ae[Fe])try{const Ve=Ae[Fe].evaluate(F),qe=`Ignoring image parameter "${Fe}" with semi-transparent color ${Ve.toString()}`;if(1!==Ve.a){this._imageWarnHistory[qe]||(console.warn(qe),this._imageWarnHistory[qe]=!0);continue}Oe[Fe]=Ve}catch(F){continue}if(0!==Object.keys(Oe).length)return{params:Oe}}}evaluate(F){const Ae=tr.build(this.inputPrimary.evaluate(F),this.inputSecondary?this.inputSecondary.evaluate(F):void 0,this.inputPrimaryParams?this.evaluateParams(F,this.inputPrimaryParams):void 0,this.inputSecondaryParams?this.evaluateParams(F,this.inputSecondaryParams):void 0);return Ae&&F.availableImages&&(Ae.available=F.availableImages.indexOf(Ae.namePrimary)>-1,Ae.nameSecondary&&Ae.available&&F.availableImages&&(Ae.available=F.availableImages.indexOf(Ae.nameSecondary)>-1)),Ae}eachChild(F){if(F(this.inputPrimary),this.inputPrimaryParams)for(const Ae in this.inputPrimaryParams)this.inputPrimaryParams[Ae]&&F(this.inputPrimaryParams[Ae]);if(this.inputSecondary&&(F(this.inputSecondary),this.inputSecondaryParams))for(const Ae in this.inputSecondaryParams)this.inputSecondaryParams[Ae]&&F(this.inputSecondaryParams[Ae])}outputDefined(){return!1}serializeParams(F){const Ae={};if(F){for(const Oe in F)F[Oe]&&(Ae[Oe]=F[Oe].serialize());return{params:Ae}}}serialize(){const F=["image",this.inputPrimary.serialize()];return this.inputPrimaryParams&&F.push(this.serializeParams(this.inputPrimaryParams)),this.inputSecondary&&(F.push(this.inputSecondary.serialize()),this.inputSecondaryParams&&F.push(this.serializeParams(this.inputSecondaryParams))),F}}function hr(F){return F instanceof Number?"number":F instanceof String?"string":F instanceof Boolean?"boolean":Array.isArray(F)?"array":null===F?"null":typeof F}const Ed={"to-boolean":$u,"to-color":Hu,"to-number":qu,"to-string":Zu};class fr{constructor(F,Ae){this.type=F,this.args=Ae}static parse(F,Ae){if(F.length<2)return Ae.error("Expected at least one argument.");const Oe=F[0],Fe=[];let Ve=ju;if("to-array"===Oe){if(!Array.isArray(F[1]))return null;const Oe=F[1].length;if(Ae.expectedType){if("array"!==Ae.expectedType.kind)return Ae.error(`Expected ${Ae.expectedType.kind} but found array.`);Ve=$e(Ae.expectedType.itemType,Oe)}else{if(!(Oe>0&&rr(F[1][0])))return null;Ve=$e(nr(F[1][0]),Oe)}for(let qe=0;qe<Oe;qe++){const Oe=F[1][qe];let pt;if("array"===hr(Oe))pt=Ae.parse(Oe,void 0,Ve.itemType);else{const F=hr(Oe);if(F!==Ve.itemType.kind)return Ae.error(`Expected ${Ve.itemType.kind} but found ${F}.`);pt=Ae.registry.literal.parse(["literal",void 0===Oe?null:Oe],Ae)}if(!pt)return null;Fe.push(pt)}}else{if(("to-boolean"===Oe||"to-string"===Oe)&&2!==F.length)return Ae.error("Expected one argument.");Ve=Ed[Oe];for(let Oe=1;Oe<F.length;Oe++){const Ve=Ae.parse(F[Oe],Oe,Qu);if(!Ve)return null;Fe.push(Ve)}}return new fr(Ve,Fe)}evaluate(F){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(F));if("color"===this.type.kind){let Ae,Oe;for(const Fe of this.args){if(Ae=Fe.evaluate(F),Oe=null,Ae instanceof Ie)return Ae;if("string"==typeof Ae){const Oe=F.parseColor(Ae);if(Oe)return Oe}else if(Array.isArray(Ae)&&(Oe=Ae.length<3||Ae.length>4?`Invalid rbga value ${JSON.stringify(Ae)}: expected an array containing either three or four numeric values.`:er(Ae[0],Ae[1],Ae[2],Ae[3]),!Oe))return new Ie(Ae[0]/255,Ae[1]/255,Ae[2]/255,Ae[3])}throw new sr(Oe||`Could not parse color from value '${"string"==typeof Ae?Ae:String(JSON.stringify(Ae))}'`)}if("number"===this.type.kind){let Ae=null;for(const Oe of this.args){if(Ae=Oe.evaluate(F),null===Ae)return 0;const Fe=Number(Ae);if(!isNaN(Fe))return Fe}throw new sr(`Could not convert ${JSON.stringify(Ae)} to number.`)}return"formatted"===this.type.kind?Je.fromString(ir(this.args[0].evaluate(F))):"resolvedImage"===this.type.kind?tr.build(ir(this.args[0].evaluate(F))):"array"===this.type.kind?this.args.map((Ae=>Ae.evaluate(F))):ir(this.args[0].evaluate(F))}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every((F=>F.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new ur([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new cr(this.args[0]).serialize();const F="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((Ae=>{F.push(Ae.serialize())})),F}}const Ad=["Unknown","Point","LineString","Polygon"];class mr{constructor(F,Ae){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=F,this.options=Ae}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Ad[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(F){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const F=this.featureDistanceData.center,Ae=this.featureDistanceData.scale,{x:Oe,y:Fe}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(Oe*Ae-F[0])+this.featureDistanceData.bearing[1]*(Fe*Ae-F[1])}return 0}parseColor(F){let Ae=this._parseColorCache[F];return Ae||(Ae=this._parseColorCache[F]=Ie.parse(F)),Ae}getConfig(F){return this.options?this.options.get(F):null}}class yr{constructor(F,Ae,Oe,Fe,Ve){this.name=F,this.type=Ae,this._evaluate=Oe,this.args=Fe,this._overloadIndex=Ve}evaluate(F){if(!this._evaluate){const F=yr.definitions[this.name];this._evaluate=Array.isArray(F)?F[2]:F.overloads[this._overloadIndex][1]}return this._evaluate(F,this.args)}eachChild(F){this.args.forEach(F)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((F=>F.serialize())))}static parse(F,Ae){const Oe=F[0],Fe=yr.definitions[Oe];if(!Fe)return Ae.error(`Unknown expression "${Oe}". If you wanted a literal array, use ["literal", [...]].`,0);const Ve=Array.isArray(Fe)?Fe[0]:Fe.type,qe=Array.isArray(Fe)?[[Fe[1],Fe[2]]]:Fe.overloads,pt=[];let vt=null,zt=-1;for(const[Fe,ri]of qe){if(Array.isArray(Fe)&&Fe.length!==F.length-1)continue;pt.push(Fe),zt++,vt=new lp(Ae.registry,Ae.path,null,Ae.scope,void 0,Ae._scope,Ae.options);const qe=[];let xi=!1;for(let Ae=1;Ae<F.length;Ae++){const Oe=F[Ae],Ve=Array.isArray(Fe)?Fe[Ae-1]:Fe.type,pt=vt.parse(Oe,1+qe.length,Ve);if(!pt){xi=!0;break}qe.push(pt)}if(!xi)if(Array.isArray(Fe)&&Fe.length!==qe.length)vt.error(`Expected ${Fe.length} arguments, but found ${qe.length} instead.`);else{for(let F=0;F<qe.length;F++){const Ae=Array.isArray(Fe)?Fe[F]:Fe.type,Oe=qe[F];vt.concat(F+1).checkSubtype(Ae,Oe.type)}if(0===vt.errors.length)return new yr(Oe,Ve,ri,qe,zt)}}if(1===pt.length)Ae.errors.push(...vt.errors);else{const Oe=(pt.length?pt:qe.map((([F])=>F))).map(gr).join(" | "),Fe=[];for(let Oe=1;Oe<F.length;Oe++){const Ve=Ae.parse(F[Oe],1+Fe.length);if(!Ve)return null;Fe.push(Ge(Ve.type))}Ae.error(`Expected arguments of type ${Oe}, but found (${Fe.join(", ")}) instead.`)}return null}static register(F,Ae){yr.definitions=Ae;for(const Oe in Ae)F[Oe]=yr}}function gr(F){return Array.isArray(F)?`(${F.map(Ge).join(", ")})`:`(${Ge(F.type)}...)`}class xr{constructor(F,Ae,Oe){this.type=cd,this.locale=Oe,this.caseSensitive=F,this.diacriticSensitive=Ae}static parse(F,Ae){if(2!==F.length)return Ae.error("Expected one argument.");const Oe=F[1];if("object"!=typeof Oe||Array.isArray(Oe))return Ae.error("Collator options argument must be an object.");const Fe=void 0===Oe["case-sensitive"]?Ae.parse(!1,1,$u):Ae.parseObjectValue(Oe["case-sensitive"],1,"case-sensitive",$u);if(!Fe)return null;const Ve=void 0===Oe["diacritic-sensitive"]?Ae.parse(!1,1,$u):Ae.parseObjectValue(Oe["diacritic-sensitive"],1,"diacritic-sensitive",$u);if(!Ve)return null;let qe=null;return Oe.locale&&(qe=Ae.parseObjectValue(Oe.locale,1,"locale",Zu),!qe)?null:new xr(Fe,Ve,qe)}evaluate(F){return new We(this.caseSensitive.evaluate(F),this.diacriticSensitive.evaluate(F),this.locale?this.locale.evaluate(F):null)}eachChild(F){F(this.caseSensitive),F(this.diacriticSensitive),this.locale&&F(this.locale)}outputDefined(){return!1}serialize(){const F={};return F["case-sensitive"]=this.caseSensitive.serialize(),F["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(F.locale=this.locale.serialize()),["collator",F]}}function vr(F,Ae,Oe=0,Fe=F.length-1,Ve=_r){for(;Fe>Oe;){if(Fe-Oe>600){const qe=Fe-Oe+1,pt=Ae-Oe+1,vt=Math.log(qe),zt=.5*Math.exp(2*vt/3),ri=.5*Math.sqrt(vt*zt*(qe-zt)/qe)*(pt-qe/2<0?-1:1);vr(F,Ae,Math.max(Oe,Math.floor(Ae-pt*zt/qe+ri)),Math.min(Fe,Math.floor(Ae+(qe-pt)*zt/qe+ri)),Ve)}const qe=F[Ae];let pt=Oe,vt=Fe;for(br(F,Oe,Ae),Ve(F[Fe],qe)>0&&br(F,Oe,Fe);pt<vt;){for(br(F,pt,vt),pt++,vt--;Ve(F[pt],qe)<0;)pt++;for(;Ve(F[vt],qe)>0;)vt--}0===Ve(F[Oe],qe)?br(F,Oe,vt):(vt++,br(F,vt,Fe)),vt<=Ae&&(Oe=vt+1),Ae<=vt&&(Fe=vt-1)}}function br(F,Ae,Oe){const Fe=F[Ae];F[Ae]=F[Oe],F[Oe]=Fe}function _r(F,Ae){return F<Ae?-1:F>Ae?1:0}function wr(F){let Ae=0;for(let Oe,Fe,Ve=0,qe=F.length,pt=qe-1;Ve<qe;pt=Ve++)Oe=F[Ve],Fe=F[pt],Ae+=(Fe.x-Oe.x)*(Oe.y+Fe.y);return Ae}function Mr(F,Ae){F[0]=Math.min(F[0],Ae[0]),F[1]=Math.min(F[1],Ae[1]),F[2]=Math.max(F[2],Ae[0]),F[3]=Math.max(F[3],Ae[1])}function Ar(F,Ae){return!(F[0]<=Ae[0]||F[2]>=Ae[2]||F[1]<=Ae[1]||F[3]>=Ae[3])}function Sr(F,Ae,Oe){const Fe=F[0]-Ae[0],Ve=F[1]-Ae[1],qe=F[0]-Oe[0],pt=F[1]-Oe[1];return Fe*pt-qe*Ve==0&&Fe*qe<=0&&Ve*pt<=0}function Ir(F,Ae,Oe=!1){let Fe=!1;for(let vt=0,zt=Ae.length;vt<zt;vt++){const zt=Ae[vt];for(let Ae=0,vt=zt.length,ri=vt-1;Ae<vt;ri=Ae++){const vt=zt[ri],xi=zt[Ae];if(Sr(F,vt,xi))return Oe;(qe=vt)[1]>(Ve=F)[1]!=(pt=xi)[1]>Ve[1]&&Ve[0]<(pt[0]-qe[0])*(Ve[1]-qe[1])/(pt[1]-qe[1])+qe[0]&&(Fe=!Fe)}}var Ve,qe,pt;return Fe}function Pr(F,Ae,Oe,Fe){const Ve=Fe[0]-Oe[0],qe=Fe[1]-Oe[1],pt=(F[0]-Oe[0])*qe-Ve*(F[1]-Oe[1]),vt=(Ae[0]-Oe[0])*qe-Ve*(Ae[1]-Oe[1]);return pt>0&&vt<0||pt<0&&vt>0}function zr(F,Ae,Oe,Fe){return 0!=(Ve=[Fe[0]-Oe[0],Fe[1]-Oe[1]])[0]*(qe=[Ae[0]-F[0],Ae[1]-F[1]])[1]-Ve[1]*qe[0]&&!(!Pr(F,Ae,Oe,Fe)||!Pr(Oe,Fe,F,Ae));var Ve,qe}const Pd=8192;function kr(F,Ae){const Oe=(180+F[0])/360,Fe=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+F[1]*Math.PI/360)))/360,Ve=Math.pow(2,Ae.z);return[Math.round(Oe*Ve*Pd),Math.round(Fe*Ve*Pd)]}function Tr(F,Ae){for(let Oe=0;Oe<Ae.length;Oe++)if(Ir(F,Ae[Oe]))return!0;return!1}function Br(F,Ae,Oe){for(const Fe of Oe)for(let Oe=0,Ve=Fe.length,qe=Ve-1;Oe<Ve;qe=Oe++)if(zr(F,Ae,Fe[qe],Fe[Oe]))return!0;return!1}function Cr(F,Ae){for(let Oe=0;Oe<F.length;++Oe)if(!Ir(F[Oe],Ae))return!1;for(let Oe=0;Oe<F.length-1;++Oe)if(Br(F[Oe],F[Oe+1],Ae))return!1;return!0}function Vr(F,Ae){for(let Oe=0;Oe<Ae.length;Oe++)if(Cr(F,Ae[Oe]))return!0;return!1}function Dr(F,Ae,Oe){const Fe=[];for(let Ve=0;Ve<F.length;Ve++){const qe=[];for(let Fe=0;Fe<F[Ve].length;Fe++){const pt=kr(F[Ve][Fe],Oe);Mr(Ae,pt),qe.push(pt)}Fe.push(qe)}return Fe}function Lr(F,Ae,Oe){const Fe=[];for(let Ve=0;Ve<F.length;Ve++){const qe=Dr(F[Ve],Ae,Oe);Fe.push(qe)}return Fe}function Rr(F,Ae,Oe,Fe){if(F[0]<Oe[0]||F[0]>Oe[2]){const Ae=.5*Fe;let Ve=F[0]-Oe[0]>Ae?-Fe:Oe[0]-F[0]>Ae?Fe:0;0===Ve&&(Ve=F[0]-Oe[2]>Ae?-Fe:Oe[2]-F[0]>Ae?Fe:0),F[0]+=Ve}Mr(Ae,F)}function Fr(F,Ae,Oe,Fe){const Ve=Math.pow(2,Fe.z)*Pd,qe=[Fe.x*Pd,Fe.y*Pd],pt=[];if(!F)return pt;for(const Fe of F)for(const F of Fe){const Fe=[F.x+qe[0],F.y+qe[1]];Rr(Fe,Ae,Oe,Ve),pt.push(Fe)}return pt}function Or(F,Ae,Oe,Fe){const Ve=Math.pow(2,Fe.z)*Pd,qe=[Fe.x*Pd,Fe.y*Pd],pt=[];if(!F)return pt;for(const Oe of F){const F=[];for(const Fe of Oe){const Oe=[Fe.x+qe[0],Fe.y+qe[1]];Mr(Ae,Oe),F.push(Oe)}pt.push(F)}if(Ae[2]-Ae[0]<=Ve/2){(vt=Ae)[0]=vt[1]=1/0,vt[2]=vt[3]=-1/0;for(const F of pt)for(const Fe of F)Rr(Fe,Ae,Oe,Ve)}var vt;return pt}class Nr{constructor(F,Ae){this.type=$u,this.geojson=F,this.geometries=Ae}static parse(F,Ae){if(2!==F.length)return Ae.error(`'within' expression requires exactly one argument, but found ${F.length-1} instead.`);if(rr(F[1])){const Ae=F[1];if("FeatureCollection"===Ae.type)for(let F=0;F<Ae.features.length;++F){const Oe=Ae.features[F].geometry.type;if("Polygon"===Oe||"MultiPolygon"===Oe)return new Nr(Ae,Ae.features[F].geometry)}else if("Feature"===Ae.type){const F=Ae.geometry.type;if("Polygon"===F||"MultiPolygon"===F)return new Nr(Ae,Ae.geometry)}else if("Polygon"===Ae.type||"MultiPolygon"===Ae.type)return new Nr(Ae,Ae)}return Ae.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(F){if(null!=F.geometry()&&null!=F.canonicalID()){if("Point"===F.geometryType())return function(F,Ae){const Oe=[1/0,1/0,-1/0,-1/0],Fe=[1/0,1/0,-1/0,-1/0],Ve=F.canonicalID();if(!Ve)return!1;if("Polygon"===Ae.type){const qe=Dr(Ae.coordinates,Fe,Ve),pt=Fr(F.geometry(),Oe,Fe,Ve);if(!Ar(Oe,Fe))return!1;for(const F of pt)if(!Ir(F,qe))return!1}if("MultiPolygon"===Ae.type){const qe=Lr(Ae.coordinates,Fe,Ve),pt=Fr(F.geometry(),Oe,Fe,Ve);if(!Ar(Oe,Fe))return!1;for(const F of pt)if(!Tr(F,qe))return!1}return!0}(F,this.geometries);if("LineString"===F.geometryType())return function(F,Ae){const Oe=[1/0,1/0,-1/0,-1/0],Fe=[1/0,1/0,-1/0,-1/0],Ve=F.canonicalID();if(!Ve)return!1;if("Polygon"===Ae.type){const qe=Dr(Ae.coordinates,Fe,Ve),pt=Or(F.geometry(),Oe,Fe,Ve);if(!Ar(Oe,Fe))return!1;for(const F of pt)if(!Cr(F,qe))return!1}if("MultiPolygon"===Ae.type){const qe=Lr(Ae.coordinates,Fe,Ve),pt=Or(F.geometry(),Oe,Fe,Ve);if(!Ar(Oe,Fe))return!1;for(const F of pt)if(!Vr(F,qe))return!1}return!0}(F,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const zd={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},kd=1/298.257223563,Fd=kd*(2-kd),Nd=Math.PI/180;class Gr{static fromTile(F,Ae,Oe){const Fe=Math.PI*(1-2*(F+.5)/Math.pow(2,Ae)),Ve=Math.atan(.5*(Math.exp(Fe)-Math.exp(-Fe)))/Nd;return new Gr(Ve,Oe)}static get units(){return zd}constructor(F,Ae){if(void 0===F)throw new Error("No latitude given.");if(Ae&&!zd[Ae])throw new Error(`Unknown unit ${Ae}. Use one of: ${Object.keys(zd).join(", ")}`);const Oe=6378.137*Nd*(Ae?zd[Ae]:1),Fe=Math.cos(F*Nd),Ve=1/(1-Fd*(1-Fe*Fe)),qe=Math.sqrt(Ve);this.kx=Oe*qe*Fe,this.ky=Oe*qe*Ve*(1-Fd)}distance(F,Ae){const Oe=Zr(F[0]-Ae[0])*this.kx,Fe=(F[1]-Ae[1])*this.ky;return Math.sqrt(Oe*Oe+Fe*Fe)}bearing(F,Ae){const Oe=Zr(Ae[0]-F[0])*this.kx;return Math.atan2(Oe,(Ae[1]-F[1])*this.ky)/Nd}destination(F,Ae,Oe){const Fe=Oe*Nd;return this.offset(F,Math.sin(Fe)*Ae,Math.cos(Fe)*Ae)}offset(F,Ae,Oe){return[F[0]+Ae/this.kx,F[1]+Oe/this.ky]}lineDistance(F){let Ae=0;for(let Oe=0;Oe<F.length-1;Oe++)Ae+=this.distance(F[Oe],F[Oe+1]);return Ae}area(F){let Ae=0;for(let Oe=0;Oe<F.length;Oe++){const Fe=F[Oe];for(let F=0,Ve=Fe.length,qe=Ve-1;F<Ve;qe=F++)Ae+=Zr(Fe[F][0]-Fe[qe][0])*(Fe[F][1]+Fe[qe][1])*(Oe?-1:1)}return Math.abs(Ae)/2*this.kx*this.ky}along(F,Ae){let Oe=0;if(Ae<=0)return F[0];for(let Fe=0;Fe<F.length-1;Fe++){const Ve=F[Fe],qe=F[Fe+1],pt=this.distance(Ve,qe);if(Oe+=pt,Oe>Ae)return Xr(Ve,qe,(Ae-(Oe-pt))/pt)}return F[F.length-1]}pointToSegmentDistance(F,Ae,Oe){let[Fe,Ve]=Ae,qe=Zr(Oe[0]-Fe)*this.kx,pt=(Oe[1]-Ve)*this.ky;if(0!==qe||0!==pt){const Ae=(Zr(F[0]-Fe)*this.kx*qe+(F[1]-Ve)*this.ky*pt)/(qe*qe+pt*pt);Ae>1?(Fe=Oe[0],Ve=Oe[1]):Ae>0&&(Fe+=qe/this.kx*Ae,Ve+=pt/this.ky*Ae)}return qe=Zr(F[0]-Fe)*this.kx,pt=(F[1]-Ve)*this.ky,Math.sqrt(qe*qe+pt*pt)}pointOnLine(F,Ae){let Oe=1/0,Fe=F[0][0],Ve=F[0][1],qe=0,pt=0;for(let vt=0;vt<F.length-1;vt++){let zt=F[vt][0],ri=F[vt][1],xi=Zr(F[vt+1][0]-zt)*this.kx,bi=(F[vt+1][1]-ri)*this.ky,wi=0;0===xi&&0===bi||(wi=(Zr(Ae[0]-zt)*this.kx*xi+(Ae[1]-ri)*this.ky*bi)/(xi*xi+bi*bi),wi>1?(zt=F[vt+1][0],ri=F[vt+1][1]):wi>0&&(zt+=xi/this.kx*wi,ri+=bi/this.ky*wi)),xi=Zr(Ae[0]-zt)*this.kx,bi=(Ae[1]-ri)*this.ky;const dr=xi*xi+bi*bi;dr<Oe&&(Oe=dr,Fe=zt,Ve=ri,qe=vt,pt=wi)}return{point:[Fe,Ve],index:qe,t:Math.max(0,Math.min(1,pt))}}lineSlice(F,Ae,Oe){let Fe=this.pointOnLine(Oe,F),Ve=this.pointOnLine(Oe,Ae);if(Fe.index>Ve.index||Fe.index===Ve.index&&Fe.t>Ve.t){const F=Fe;Fe=Ve,Ve=F}const qe=[Fe.point],pt=Fe.index+1,vt=Ve.index;!Yr(Oe[pt],qe[0])&&pt<=vt&&qe.push(Oe[pt]);for(let F=pt+1;F<=vt;F++)qe.push(Oe[F]);return Yr(Oe[vt],Ve.point)||qe.push(Ve.point),qe}lineSliceAlong(F,Ae,Oe){let Fe=0;const Ve=[];for(let qe=0;qe<Oe.length-1;qe++){const pt=Oe[qe],vt=Oe[qe+1],zt=this.distance(pt,vt);if(Fe+=zt,Fe>F&&0===Ve.length&&Ve.push(Xr(pt,vt,(F-(Fe-zt))/zt)),Fe>=Ae)return Ve.push(Xr(pt,vt,(Ae-(Fe-zt))/zt)),Ve;Fe>F&&Ve.push(vt)}return Ve}bufferPoint(F,Ae){const Oe=Ae/this.ky,Fe=Ae/this.kx;return[F[0]-Fe,F[1]-Oe,F[0]+Fe,F[1]+Oe]}bufferBBox(F,Ae){const Oe=Ae/this.ky,Fe=Ae/this.kx;return[F[0]-Fe,F[1]-Oe,F[2]+Fe,F[3]+Oe]}insideBBox(F,Ae){return Zr(F[0]-Ae[0])>=0&&Zr(F[0]-Ae[2])<=0&&F[1]>=Ae[1]&&F[1]<=Ae[3]}}function Yr(F,Ae){return F[0]===Ae[0]&&F[1]===Ae[1]}function Xr(F,Ae,Oe){const Fe=Zr(Ae[0]-F[0]);return[F[0]+Fe*Oe,F[1]+(Ae[1]-F[1])*Oe]}function Zr(F){for(;F<-180;)F+=360;for(;F>180;)F-=360;return F}class Hr{constructor(F=[],Ae=(F,Ae)=>F<Ae?-1:F>Ae?1:0){if(this.data=F,this.length=this.data.length,this.compare=Ae,this.length>0)for(let F=(this.length>>1)-1;F>=0;F--)this._down(F)}push(F){this.data.push(F),this._up(this.length++)}pop(){if(0===this.length)return;const F=this.data[0],Ae=this.data.pop();return--this.length>0&&(this.data[0]=Ae,this._down(0)),F}peek(){return this.data[0]}_up(F){const{data:Ae,compare:Oe}=this,Fe=Ae[F];for(;F>0;){const Ve=F-1>>1,qe=Ae[Ve];if(Oe(Fe,qe)>=0)break;Ae[F]=qe,F=Ve}Ae[F]=Fe}_down(F){const{data:Ae,compare:Oe}=this,Fe=this.length>>1,Ve=Ae[F];for(;F<Fe;){let Fe=1+(F<<1);const qe=Fe+1;if(qe<this.length&&Oe(Ae[qe],Ae[Fe])<0&&(Fe=qe),Oe(Ae[Fe],Ve)>=0)break;Ae[F]=Ae[Fe],F=Fe}Ae[F]=Ve}}var Vd=8192;function Kr(F,Ae){return Ae.dist-F.dist}const Gd=100,Yd=50;function tn(F){const Ae=[1/0,1/0,-1/0,-1/0];if(Ae.length!==F.length)return!1;for(let Oe=0;Oe<Ae.length;Oe++)if(Ae[Oe]!==F[Oe])return!1;return!0}function en(F){return F[1]-F[0]+1}function rn(F,Ae){const Oe=F[1]>=F[0]&&F[1]<Ae;return Oe||console.warn("Distance Expression: Index is out of range"),Oe}function nn(F,Ae){if(F[0]>F[1])return[null,null];const Oe=en(F);if(Ae){if(2===Oe)return[F,null];const Ae=Math.floor(Oe/2);return[[F[0],F[0]+Ae],[F[0]+Ae,F[1]]]}{if(1===Oe)return[F,null];const Ae=Math.floor(Oe/2)-1;return[[F[0],F[0]+Ae],[F[0]+Ae+1,F[1]]]}}function an(F,Ae){const Oe=[1/0,1/0,-1/0,-1/0];if(!rn(Ae,F.length))return Oe;for(let Fe=Ae[0];Fe<=Ae[1];++Fe)Mr(Oe,F[Fe]);return Oe}function sn(F){const Ae=[1/0,1/0,-1/0,-1/0];for(let Oe=0;Oe<F.length;++Oe)for(let Fe=0;Fe<F[Oe].length;++Fe)Mr(Ae,F[Oe][Fe]);return Ae}function on(F,Ae,Oe){if(tn(F)||tn(Ae))return NaN;let Fe=0,Ve=0;return F[2]<Ae[0]&&(Fe=Ae[0]-F[2]),F[0]>Ae[2]&&(Fe=F[0]-Ae[2]),F[1]>Ae[3]&&(Ve=F[1]-Ae[3]),F[3]<Ae[1]&&(Ve=Ae[1]-F[3]),Oe.distance([0,0],[Fe,Ve])}function ln(F){return 360*F-180}function un(F){return 360/Math.PI*Math.atan(Math.exp((180-360*F)*Math.PI/180))-90}function cn(F,Ae){const Oe=Math.pow(2,Ae.z),Fe=(F.y/Vd+Ae.y)/Oe;return[ln((F.x/Vd+Ae.x)/Oe),un(Fe)]}function hn(F,Ae){const Oe=[];for(let Fe=0;Fe<F.length;++Fe)Oe.push(cn(F[Fe],Ae));return Oe}function pn(F,Ae,Oe){const Fe=Oe.pointOnLine(Ae,F).point;return Oe.distance(F,Fe)}function fn(F,Ae,Oe,Fe,Ve){const qe=Oe.slice(Fe[0],Fe[1]+1);let pt=1/0;for(let Oe=Ae[0];Oe<=Ae[1];++Oe)if(0===(pt=Math.min(pt,pn(F[Oe],qe,Ve))))return 0;return pt}function dn(F,Ae,Oe,Fe,Ve){const qe=Math.min(Ve.pointToSegmentDistance(F,Oe,Fe),Ve.pointToSegmentDistance(Ae,Oe,Fe)),pt=Math.min(Ve.pointToSegmentDistance(Oe,F,Ae),Ve.pointToSegmentDistance(Fe,F,Ae));return Math.min(qe,pt)}function mn(F,Ae,Oe,Fe,Ve){if(!rn(Ae,F.length)||!rn(Fe,Oe.length))return NaN;let qe=1/0;for(let pt=Ae[0];pt<Ae[1];++pt)for(let Ae=Fe[0];Ae<Fe[1];++Ae){if(zr(F[pt],F[pt+1],Oe[Ae],Oe[Ae+1]))return 0;qe=Math.min(qe,dn(F[pt],F[pt+1],Oe[Ae],Oe[Ae+1],Ve))}return qe}function yn(F,Ae,Oe,Fe,Ve){if(!rn(Ae,F.length)||!rn(Fe,Oe.length))return NaN;let qe=1/0;for(let pt=Ae[0];pt<=Ae[1];++pt)for(let Ae=Fe[0];Ae<=Fe[1];++Ae)if(0===(qe=Math.min(qe,Ve.distance(F[pt],Oe[Ae]))))return qe;return qe}function gn(F,Ae,Oe){if(Ir(F,Ae,!0))return 0;let Fe=1/0;for(const Ve of Ae){const Ae=Ve.length;if(Ae<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(Ve[0]!==Ve[Ae-1]&&0===(Fe=Math.min(Fe,Oe.pointToSegmentDistance(F,Ve[Ae-1],Ve[0]))))return Fe;if(0===(Fe=Math.min(Fe,pn(F,Ve,Oe))))return Fe}return Fe}function xn(F,Ae,Oe,Fe){if(!rn(Ae,F.length))return NaN;for(let Fe=Ae[0];Fe<=Ae[1];++Fe)if(Ir(F[Fe],Oe,!0))return 0;let Ve=1/0;for(let qe=Ae[0];qe<Ae[1];++qe)for(const Ae of Oe)for(let Oe=0,pt=Ae.length,vt=pt-1;Oe<pt;vt=Oe++){if(zr(F[qe],F[qe+1],Ae[vt],Ae[Oe]))return 0;Ve=Math.min(Ve,dn(F[qe],F[qe+1],Ae[vt],Ae[Oe],Fe))}return Ve}function vn(F,Ae){for(const Oe of F)for(let F=0;F<=Oe.length-1;++F)if(Ir(Oe[F],Ae,!0))return!0;return!1}function bn(F,Ae,Oe,Fe=1/0){const Ve=sn(F),qe=sn(Ae);if(Fe!==1/0&&on(Ve,qe,Oe)>=Fe)return Fe;if(Ar(Ve,qe)){if(vn(F,Ae))return 0}else if(vn(Ae,F))return 0;let pt=Fe;for(const Fe of F)for(let F=0,Ve=Fe.length,qe=Ve-1;F<Ve;qe=F++)for(const Ve of Ae)for(let Ae=0,vt=Ve.length,zt=vt-1;Ae<vt;zt=Ae++){if(zr(Fe[qe],Fe[F],Ve[zt],Ve[Ae]))return 0;pt=Math.min(pt,dn(Fe[qe],Fe[F],Ve[zt],Ve[Ae],Oe))}return pt}function _n(F,Ae,Oe,Fe,Ve,qe,pt){if(null===qe||null===pt)return;const vt=on(an(Fe,qe),an(Ve,pt),Oe);vt<Ae&&F.push({dist:vt,range1:qe,range2:pt})}function wn(F,Ae,Oe,Fe,Ve=1/0){let qe=Math.min(Fe.distance(F[0],Oe[0][0]),Ve);if(0===qe)return qe;const pt=new Hr([{dist:0,range1:[0,F.length-1],range2:[0,0]}],Kr),vt=Ae?Yd:Gd,zt=sn(Oe);for(;pt.length;){const Ve=pt.pop();if(Ve.dist>=qe)continue;const ri=Ve.range1;if(en(ri)<=vt){if(!rn(ri,F.length))return NaN;if(Ae){const Ae=xn(F,ri,Oe,Fe);if(0===(qe=Math.min(qe,Ae)))return qe}else for(let Ae=ri[0];Ae<=ri[1];++Ae){const Ve=gn(F[Ae],Oe,Fe);if(0===(qe=Math.min(qe,Ve)))return qe}}else{const Oe=nn(ri,Ae);if(null!==Oe[0]){const Ae=on(an(F,Oe[0]),zt,Fe);Ae<qe&&pt.push({dist:Ae,range1:Oe[0],range2:[0,0]})}if(null!==Oe[1]){const Ae=on(an(F,Oe[1]),zt,Fe);Ae<qe&&pt.push({dist:Ae,range1:Oe[1],range2:[0,0]})}}}return qe}function Mn(F,Ae,Oe,Fe,Ve,qe=1/0){let pt=Math.min(qe,Ve.distance(F[0],Oe[0]));if(0===pt)return pt;const vt=new Hr([{dist:0,range1:[0,F.length-1],range2:[0,Oe.length-1]}],Kr),zt=Ae?Yd:Gd,ri=Fe?Yd:Gd;for(;vt.length;){const qe=vt.pop();if(qe.dist>=pt)continue;const xi=qe.range1,bi=qe.range2;if(en(xi)<=zt&&en(bi)<=ri){if(!rn(xi,F.length)||!rn(bi,Oe.length))return NaN;if(Ae&&Fe?pt=Math.min(pt,mn(F,xi,Oe,bi,Ve)):Ae||Fe?Ae&&!Fe?pt=Math.min(pt,fn(Oe,bi,F,xi,Ve)):!Ae&&Fe&&(pt=Math.min(pt,fn(F,xi,Oe,bi,Ve))):pt=Math.min(pt,yn(F,xi,Oe,bi,Ve)),0===pt)return pt}else{const qe=nn(xi,Ae),zt=nn(bi,Fe);_n(vt,pt,Ve,F,Oe,qe[0],zt[0]),_n(vt,pt,Ve,F,Oe,qe[0],zt[1]),_n(vt,pt,Ve,F,Oe,qe[1],zt[0]),_n(vt,pt,Ve,F,Oe,qe[1],zt[1])}}return pt}function An(F,Ae,Oe,Fe,Ve=1/0){let qe=Ve;const pt=an(F,[0,F.length-1]);for(const Ve of Oe)if(!(qe!==1/0&&on(pt,an(Ve,[0,Ve.length-1]),Fe)>=qe)&&(qe=Math.min(qe,Mn(F,Ae,Ve,!0,Fe,qe)),0===qe))return qe;return qe}function Sn(F,Ae,Oe,Fe,Ve=1/0){let qe=Ve;const pt=an(F,[0,F.length-1]);for(const Ve of Oe){if(qe!==1/0&&on(pt,sn(Ve),Fe)>=qe)continue;const Oe=wn(F,Ae,Ve,Fe,qe);if(isNaN(Oe))return Oe;if(0===(qe=Math.min(qe,Oe)))return qe}return qe}function In(F){return"Point"===F||"MultiPoint"===F||"LineString"===F||"MultiLineString"===F||"Polygon"===F||"MultiPolygon"===F}class Pn{constructor(F,Ae){this.type=qu,this.geojson=F,this.geometries=Ae}static parse(F,Ae){if(2!==F.length)return Ae.error(`'distance' expression requires either one argument, but found ' ${F.length-1} instead.`);if(rr(F[1])){const Ae=F[1];if("FeatureCollection"===Ae.type){for(let F=0;F<Ae.features.length;++F)if(In(Ae.features[F].geometry.type))return new Pn(Ae,Ae.features[F].geometry)}else if("Feature"===Ae.type){if(In(Ae.geometry.type))return new Pn(Ae,Ae.geometry)}else if(In(Ae.type))return new Pn(Ae,Ae)}return Ae.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(F){const Ae=F.geometry(),Oe=F.canonicalID();if(null!=Ae&&null!=Oe){if("Point"===F.geometryType())return function(F,Ae,Oe){const Fe=[];for(const Oe of F)for(const F of Oe)Fe.push(cn(F,Ae));const Ve=new Gr(Fe[0][1],"meters");return"Point"===Oe.type||"MultiPoint"===Oe.type||"LineString"===Oe.type?Mn(Fe,!1,"Point"===Oe.type?[Oe.coordinates]:Oe.coordinates,"LineString"===Oe.type,Ve):"MultiLineString"===Oe.type?An(Fe,!1,Oe.coordinates,Ve):"Polygon"===Oe.type||"MultiPolygon"===Oe.type?Sn(Fe,!1,"Polygon"===Oe.type?[Oe.coordinates]:Oe.coordinates,Ve):null}(Ae,Oe,this.geometries);if("LineString"===F.geometryType())return function(F,Ae,Oe){const Fe=[];for(const Oe of F){const F=[];for(const Fe of Oe)F.push(cn(Fe,Ae));Fe.push(F)}const Ve=new Gr(Fe[0][0][1],"meters");if("Point"===Oe.type||"MultiPoint"===Oe.type||"LineString"===Oe.type)return An("Point"===Oe.type?[Oe.coordinates]:Oe.coordinates,"LineString"===Oe.type,Fe,Ve);if("MultiLineString"===Oe.type){let F=1/0;for(let Ae=0;Ae<Oe.coordinates.length;Ae++){const qe=An(Oe.coordinates[Ae],!0,Fe,Ve,F);if(isNaN(qe))return qe;if(0===(F=Math.min(F,qe)))return F}return F}if("Polygon"===Oe.type||"MultiPolygon"===Oe.type){let F=1/0;for(let Ae=0;Ae<Fe.length;Ae++){const qe=Sn(Fe[Ae],!0,"Polygon"===Oe.type?[Oe.coordinates]:Oe.coordinates,Ve,F);if(isNaN(qe))return qe;if(0===(F=Math.min(F,qe)))return F}return F}return null}(Ae,Oe,this.geometries);if("Polygon"===F.geometryType())return function(F,Ae,Oe){const Fe=[];for(const Oe of function(F){const Ae=F.length;if(Ae<=1)return[F];const Oe=[];let Fe,Ve;for(let qe=0;qe<Ae;qe++){const Ae=wr(F[qe]);0!==Ae&&(F[qe].area=Math.abs(Ae),void 0===Ve&&(Ve=Ae<0),Ve===Ae<0?(Fe&&Oe.push(Fe),Fe=[F[qe]]):Fe.push(F[qe]))}return Fe&&Oe.push(Fe),Oe}(F)){const F=[];for(let Fe=0;Fe<Oe.length;++Fe)F.push(hn(Oe[Fe],Ae));Fe.push(F)}const Ve=new Gr(Fe[0][0][0][1],"meters");if("Point"===Oe.type||"MultiPoint"===Oe.type||"LineString"===Oe.type)return Sn("Point"===Oe.type?[Oe.coordinates]:Oe.coordinates,"LineString"===Oe.type,Fe,Ve);if("MultiLineString"===Oe.type){let F=1/0;for(let Ae=0;Ae<Oe.coordinates.length;Ae++){const qe=Sn(Oe.coordinates[Ae],!0,Fe,Ve,F);if(isNaN(qe))return qe;if(0===(F=Math.min(F,qe)))return F}return F}return"Polygon"===Oe.type||"MultiPolygon"===Oe.type?function(F,Ae,Oe){let Fe=1/0;for(const Ve of F)for(const F of Ae){const Ae=bn(Ve,F,Oe,Fe);if(isNaN(Ae))return Ae;if(0===(Fe=Math.min(Fe,Ae)))return Fe}return Fe}("Polygon"===Oe.type?[Oe.coordinates]:Oe.coordinates,Fe,Ve):null}(Ae,Oe,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function zn(F,Ae){switch(F){case"string":return ir(Ae);case"number":return+Ae;case"boolean":return!!Ae;case"color":return Ie.parse(Ae);case"formatted":return Je.fromString(ir(Ae));case"resolvedImage":return tr.build(ir(Ae))}return Ae}function En(F,Ae,Oe,Fe){return void 0!==Fe&&(F=Fe*Math.round(F/Fe)),void 0!==Ae&&F<Ae&&(F=Ae),void 0!==Oe&&F>Oe&&(F=Oe),F}class kn{constructor(F,Ae,Oe){this.type=F,this.key=Ae,this.scope=Oe}static parse(F,Ae){let Oe=Ae.expectedType;if(null==Oe&&(Oe=Qu),F.length<2||F.length>3)return Ae.error("Invalid number of arguments for 'config' expression.");const Fe=Ae.parse(F[1],1);if(!(Fe instanceof ar))return Ae.error("Key name of 'config' expression must be a string literal.");if(F.length>=3){const Ve=Ae.parse(F[2],2);return Ve instanceof ar?new kn(Oe,ir(Fe.value),ir(Ve.value)):Ae.error("Scope of 'config' expression must be a string literal.")}return new kn(Oe,ir(Fe.value))}evaluate(F){const Ae=[this.key,this.scope,F.scope].filter(Boolean).join(""),Oe=F.getConfig(Ae);if(!Oe)return null;const{type:Fe,value:Ve,values:qe,minValue:pt,maxValue:vt,stepValue:zt}=Oe,ri=Oe.default.evaluate(F);let xi=ri;if(Ve){const Ae=F.scope;F.scope=(Ae||"").split("").slice(1).join(""),xi=Ve.evaluate(F),F.scope=Ae}return Fe&&(xi=zn(Fe,xi)),void 0===xi||void 0===pt&&void 0===vt&&void 0===zt||("number"==typeof xi?xi=En(xi,pt,vt,zt):Array.isArray(xi)&&(xi=xi.map((F=>"number"==typeof F?En(F,pt,vt,zt):F)))),void 0!==Ve&&void 0!==xi&&qe&&!qe.includes(xi)&&(xi=ri,Fe&&(xi=zn(Fe,xi))),(Fe&&Fe!==this.type||void 0!==xi&&nr(xi)!==this.type)&&(xi=zn(this.type.kind,xi)),xi}eachChild(){}outputDefined(){return!1}serialize(){const F=["config",this.key];return this.scope&&F.concat(this.key),F}}function Tn(F){if(F instanceof yr){if("get"===F.name&&1===F.args.length)return!1;if("feature-state"===F.name)return!1;if("has"===F.name&&1===F.args.length)return!1;if("properties"===F.name||"geometry-type"===F.name||"id"===F.name)return!1;if(/^filter-/.test(F.name))return!1}if(F instanceof Nr)return!1;if(F instanceof Pn)return!1;let Ae=!0;return F.eachChild((F=>{Ae&&!Tn(F)&&(Ae=!1)})),Ae}function Bn(F){if(F instanceof yr&&"feature-state"===F.name)return!1;let Ae=!0;return F.eachChild((F=>{Ae&&!Bn(F)&&(Ae=!1)})),Ae}function Cn(F){if(F instanceof kn)return new Set([F.key]);let Ae=new Set;return F.eachChild((F=>{Ae=new Set([...Ae,...Cn(F)])})),Ae}function Vn(F,Ae){if(F instanceof yr&&Ae.indexOf(F.name)>=0)return!1;let Oe=!0;return F.eachChild((F=>{Oe&&!Vn(F,Ae)&&(Oe=!1)})),Oe}class Dn{constructor(F,Ae){this.type=Ae.type,this.name=F,this.boundExpression=Ae}static parse(F,Ae){if(2!==F.length||"string"!=typeof F[1])return Ae.error("'var' expression requires exactly one string literal argument.");const Oe=F[1];return Ae.scope.has(Oe)?new Dn(Oe,Ae.scope.get(Oe)):Ae.error(`Unknown variable "${Oe}". Make sure "${Oe}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(F){return this.boundExpression.evaluate(F)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ln{constructor(F,Ae=[],Oe,Fe=new Ce,Ve=[],qe,pt){this.registry=F,this.path=Ae,this.key=Ae.map((F=>"string"==typeof F?`['${F}']`:`[${F}]`)).join(""),this.scope=Fe,this.errors=Ve,this.expectedType=Oe,this._scope=qe,this.options=pt}parse(F,Ae,Oe,Fe,Ve={}){return Ae||Oe?this.concat(Ae,null,Oe,Fe)._parse(F,Ve):this._parse(F,Ve)}parseObjectValue(F,Ae,Oe,Fe,Ve,qe={}){return this.concat(Ae,Oe,Fe,Ve)._parse(F,qe)}_parse(F,Ae){function r(F,Ae,Oe){return"assert"===Oe?new lr(Ae,[F]):"coerce"===Oe?new fr(Ae,[F]):F}if(null!==F&&"string"!=typeof F&&"boolean"!=typeof F&&"number"!=typeof F||(F=["literal",F]),Array.isArray(F)){if(0===F.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const Oe="string"==typeof F[0]?this.registry[F[0]]:void 0;if(Oe){let Fe=Oe.parse(F,this);if(!Fe)return null;if(this.expectedType){const F=this.expectedType,Oe=Fe.type;if("string"!==F.kind&&"number"!==F.kind&&"boolean"!==F.kind&&"object"!==F.kind&&"array"!==F.kind||"value"!==Oe.kind)if("color"!==F.kind&&"formatted"!==F.kind&&"resolvedImage"!==F.kind||"value"!==Oe.kind&&"string"!==Oe.kind){if(this.checkSubtype(F,Oe))return null}else Fe=r(Fe,F,Ae.typeAnnotation||"coerce");else Fe=r(Fe,F,Ae.typeAnnotation||"assert")}if(!(Fe instanceof ar)&&"resolvedImage"!==Fe.type.kind&&Fn(Fe)){const Ae=new mr(this._scope,this.options);try{Fe=new ar(Fe.type,Fe.evaluate(Ae))}catch(F){return this.error(F.message),null}}return Fe}return fr.parse(["to-array",F],this)}return this.error(void 0===F?"'undefined' value invalid. Use null instead.":"object"==typeof F?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof F} instead.`)}concat(F,Ae,Oe,Fe){let Ve="number"==typeof F?this.path.concat(F):this.path;Ve="string"==typeof Ae?Ve.concat(Ae):Ve;const qe=Fe?this.scope.concat(Fe):this.scope;return new Ln(this.registry,Ve,Oe||null,qe,this.errors,this._scope,this.options)}error(F,...Ae){const Oe=`${this.key}${Ae.map((F=>`[${F}]`)).join("")}`;this.errors.push(new Be(Oe,F))}checkSubtype(F,Ae){const Oe=Xe(F,Ae);return Oe&&this.error(Oe),Oe}}var lp=Ln;function Fn(F){if(F instanceof Dn)return Fn(F.boundExpression);if(F instanceof yr&&"error"===F.name)return!1;if(F instanceof xr)return!1;if(F instanceof Nr)return!1;if(F instanceof Pn)return!1;if(F instanceof kn)return!1;const Ae=F instanceof fr||F instanceof lr;let Oe=!0;return F.eachChild((F=>{Oe=Ae?Oe&&Fn(F):Oe&&F instanceof ar})),!!Oe&&Tn(F)&&Vn(F,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function On(F,Ae){const Oe=F.length-1;let Fe,Ve,qe=0,pt=Oe,vt=0;for(;qe<=pt;)if(vt=Math.floor((qe+pt)/2),Fe=F[vt],Ve=F[vt+1],Fe<=Ae){if(vt===Oe||Ae<Ve)return vt;qe=vt+1}else{if(!(Fe>Ae))throw new sr("Input is not a number.");pt=vt-1}return 0}class Nn{constructor(F,Ae,Oe){this.type=F,this.input=Ae,this.labels=[],this.outputs=[];for(const[F,Ae]of Oe)this.labels.push(F),this.outputs.push(Ae)}static parse(F,Ae){if(F.length-1<4)return Ae.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if((F.length-1)%2!=0)return Ae.error("Expected an even number of arguments.");const Oe=Ae.parse(F[1],1,qu);if(!Oe)return null;const Fe=[];let Ve=null;Ae.expectedType&&"value"!==Ae.expectedType.kind&&(Ve=Ae.expectedType);for(let Oe=1;Oe<F.length;Oe+=2){const qe=1===Oe?-1/0:F[Oe],pt=F[Oe+1],vt=Oe,zt=Oe+1;if("number"!=typeof qe)return Ae.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',vt);if(Fe.length&&Fe[Fe.length-1][0]>=qe)return Ae.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',vt);const ri=Ae.parse(pt,zt,Ve);if(!ri)return null;Ve=Ve||ri.type,Fe.push([qe,ri])}return new Nn(Ve,Oe,Fe)}evaluate(F){const Ae=this.labels,Oe=this.outputs;if(1===Ae.length)return Oe[0].evaluate(F);const Fe=this.input.evaluate(F);if(Fe<=Ae[0])return Oe[0].evaluate(F);const Ve=Ae.length;return Fe>=Ae[Ve-1]?Oe[Ve-1].evaluate(F):Oe[On(Ae,Fe)].evaluate(F)}eachChild(F){F(this.input);for(const Ae of this.outputs)F(Ae)}outputDefined(){return this.outputs.every((F=>F.outputDefined()))}serialize(){const F=["step",this.input.serialize()];for(let Ae=0;Ae<this.labels.length;Ae++)Ae>0&&F.push(this.labels[Ae]),F.push(this.outputs[Ae].serialize());return F}}const up=.95047,dp=1.08883,fp=4/29,mp=6/29,_p=3*mp*mp,gp=mp*mp*mp,yp=Math.PI/180,xp=180/Math.PI;function Hn(F){return F>gp?Math.pow(F,1/3):F/_p+fp}function Wn(F){return F>mp?F*F*F:_p*(F-fp)}function Kn(F){return 255*(F<=.0031308?12.92*F:1.055*Math.pow(F,1/2.4)-.055)}function Jn(F){return(F/=255)<=.04045?F/12.92:Math.pow((F+.055)/1.055,2.4)}function Qn(F){const Ae=Jn(F.r),Oe=Jn(F.g),Fe=Jn(F.b),Ve=Hn((.4124564*Ae+.3575761*Oe+.1804375*Fe)/up),qe=Hn((.2126729*Ae+.7151522*Oe+.072175*Fe)/1);return{l:116*qe-16,a:500*(Ve-qe),b:200*(qe-Hn((.0193339*Ae+.119192*Oe+.9503041*Fe)/dp)),alpha:F.a}}function ti(F){let Ae=(F.l+16)/116,Oe=isNaN(F.a)?Ae:Ae+F.a/500,Fe=isNaN(F.b)?Ae:Ae-F.b/200;return Ae=1*Wn(Ae),Oe=up*Wn(Oe),Fe=dp*Wn(Fe),new Ie(Kn(3.2404542*Oe-1.5371385*Ae-.4985314*Fe),Kn(-.969266*Oe+1.8760108*Ae+.041556*Fe),Kn(.0556434*Oe-.2040259*Ae+1.0572252*Fe),F.alpha)}function ei(F,Ae,Oe){const Fe=Ae-F;return F+Oe*(Fe>180||Fe<-180?Fe-360*Math.round(Fe/360):Fe)}const vp={forward:Qn,reverse:ti,interpolate:function(F,Ae,Oe){return{l:ze(F.l,Ae.l,Oe),a:ze(F.a,Ae.a,Oe),b:ze(F.b,Ae.b,Oe),alpha:ze(F.alpha,Ae.alpha,Oe)}}},wp={forward:function(F){const{l:Ae,a:Oe,b:Fe}=Qn(F),Ve=Math.atan2(Fe,Oe)*xp;return{h:Ve<0?Ve+360:Ve,c:Math.sqrt(Oe*Oe+Fe*Fe),l:Ae,alpha:F.a}},reverse:function(F){const Ae=F.h*yp,Oe=F.c;return ti({l:F.l,a:Math.cos(Ae)*Oe,b:Math.sin(Ae)*Oe,alpha:F.alpha})},interpolate:function(F,Ae,Oe){return{h:ei(F.h,Ae.h,Oe),c:ze(F.c,Ae.c,Oe),l:ze(F.l,Ae.l,Oe),alpha:ze(F.alpha,Ae.alpha,Oe)}}};var Mp=Object.freeze({__proto__:null,hcl:wp,lab:vp});class ai{constructor(F,Ae,Oe,Fe,Ve,qe){this.type=F,this.operator=Ae,this.interpolation=Oe,this.input=Fe,this.dynamicStops=Ve,this.labels=[],this.outputs=[];for(const[F,Ae]of qe)this.labels.push(F),this.outputs.push(Ae)}static interpolationFactor(F,Ae,Oe,Fe){let Ve=0;if("exponential"===F.name)Ve=si(Ae,F.base,Oe,Fe);else if("linear"===F.name)Ve=si(Ae,1,Oe,Fe);else if("cubic-bezier"===F.name){const qe=F.controlPoints;Ve=new Kl(qe[0],qe[1],qe[2],qe[3]).solve(si(Ae,1,Oe,Fe))}return Ve}static parse(F,Ae){let[Oe,Fe,Ve,...qe]=F;if(!Array.isArray(Fe)||0===Fe.length)return Ae.error("Expected an interpolation type expression.",1);if("linear"===Fe[0])Fe={name:"linear"};else if("exponential"===Fe[0]){const F=Fe[1];if("number"!=typeof F)return Ae.error("Exponential interpolation requires a numeric base.",1,1);Fe={name:"exponential",base:F}}else{if("cubic-bezier"!==Fe[0])return Ae.error(`Unknown interpolation type ${String(Fe[0])}`,1,0);{const F=Fe.slice(1);if(4!==F.length||F.some((F=>"number"!=typeof F||F<0||F>1)))return Ae.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);Fe={name:"cubic-bezier",controlPoints:F}}}if(F.length-1<3)return Ae.error(`Expected at least 3 arguments, but found only ${F.length-1}.`);if(F.length-1>3&&(F.length-1)%2!=0)return Ae.error("Expected an even number of arguments.");if(Ve=Ae.parse(Ve,2,qu),!Ve)return null;const pt=[];let vt=null;if("interpolate-hcl"===Oe||"interpolate-lab"===Oe?vt=Hu:Ae.expectedType&&"value"!==Ae.expectedType.kind&&(vt=Ae.expectedType),F.length-1==3){const F=Ae.parse(qe[0],3,Qu);return F?new ai(vt,Oe,Fe,Ve,F,pt):null}for(let F=0;F<qe.length;F+=2){const Oe=qe[F],Fe=qe[F+1],Ve=F+3,zt=F+4;if("number"!=typeof Oe)return Ae.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',Ve);if(pt.length&&pt[pt.length-1][0]>=Oe)return Ae.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',Ve);const ri=Ae.parse(Fe,zt,vt);if(!ri)return null;vt=vt||ri.type,pt.push([Oe,ri])}return"number"===vt.kind||"color"===vt.kind||"array"===vt.kind&&"number"===vt.itemType.kind&&"number"==typeof vt.N?new ai(vt,Oe,Fe,Ve,null,pt):Ae.error(`Type ${Ge(vt)} is not interpolatable.`)}evaluate(F){let Ae=this.labels,Oe=this.outputs;if(this.dynamicStops){const Fe=this.dynamicStops.evaluate(F);if(Fe.length%2!=0)throw new sr("Expected an even number of arguments.");Ae=[],Oe=[];for(let F=0;F<Fe.length;F+=2){const Ve=Fe[F],qe=new ar(qu,Fe[F+1]);if("number"!=typeof Ve)throw new sr('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.');if(Ae.length&&Ae[Ae.length-1]>=Ve)throw new sr('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.');Ae.push(Ve),Oe.push(qe)}if(0===Ae.length)throw new sr("Expected at least one input/output pair.")}if(1===Ae.length)return Oe[0].evaluate(F);const Fe=this.input.evaluate(F);if(Fe<=Ae[0])return Oe[0].evaluate(F);const Ve=Ae.length;if(Fe>=Ae[Ve-1])return Oe[Ve-1].evaluate(F);const qe=On(Ae,Fe),pt=ai.interpolationFactor(this.interpolation,Fe,Ae[qe],Ae[qe+1]),vt=Oe[qe].evaluate(F),zt=Oe[qe+1].evaluate(F);return"interpolate"===this.operator?Uu[this.type.kind.toLowerCase()](vt,zt,pt):"interpolate-hcl"===this.operator?wp.reverse(wp.interpolate(wp.forward(vt),wp.forward(zt),pt)):vp.reverse(vp.interpolate(vp.forward(vt),vp.forward(zt),pt))}eachChild(F){F(this.input);for(const Ae of this.outputs)F(Ae)}outputDefined(){return this.outputs.every((F=>F.outputDefined()))}serialize(){let F;F="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const Ae=[this.operator,F,this.input.serialize()];if(this.dynamicStops)Ae.push(this.dynamicStops.serialize());else for(let F=0;F<this.labels.length;F++)Ae.push(this.labels[F],this.outputs[F].serialize());return Ae}}function si(F,Ae,Oe,Fe){const Ve=Fe-Oe,qe=F-Oe;return 0===Ve?0:1===Ae?qe/Ve:(Math.pow(Ae,qe)-1)/(Math.pow(Ae,Ve)-1)}class oi{constructor(F,Ae){this.type=F,this.args=Ae}static parse(F,Ae){if(F.length<2)return Ae.error("Expectected at least one argument.");let Oe=null;const Fe=Ae.expectedType;Fe&&"value"!==Fe.kind&&(Oe=Fe);const Ve=[];for(const Fe of F.slice(1)){const F=Ae.parse(Fe,1+Ve.length,Oe,void 0,{typeAnnotation:"omit"});if(!F)return null;Oe=Oe||F.type,Ve.push(F)}const qe=Fe&&Ve.some((F=>Xe(Fe,F.type)));return new oi(qe?Qu:Oe,Ve)}evaluate(F){let Ae,Oe=null,Fe=0;for(const Ve of this.args){if(Fe++,Oe=Ve.evaluate(F),Oe&&Oe instanceof tr&&!Oe.available&&(Ae||(Ae=Oe),Oe=null,Fe===this.args.length))return Ae;if(null!==Oe)break}return Oe}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every((F=>F.outputDefined()))}serialize(){const F=["coalesce"];return this.eachChild((Ae=>{F.push(Ae.serialize())})),F}}class li{constructor(F,Ae){this.type=Ae.type,this.bindings=[].concat(F),this.result=Ae}evaluate(F){return this.result.evaluate(F)}eachChild(F){for(const Ae of this.bindings)F(Ae[1]);F(this.result)}static parse(F,Ae){if(F.length<4)return Ae.error(`Expected at least 3 arguments, but found ${F.length-1} instead.`);const Oe=[];for(let Fe=1;Fe<F.length-1;Fe+=2){const Ve=F[Fe];if("string"!=typeof Ve)return Ae.error(`Expected string, but found ${typeof Ve} instead.`,Fe);if(/[^a-zA-Z0-9_]/.test(Ve))return Ae.error("Variable names must contain only alphanumeric characters or '_'.",Fe);const qe=Ae.parse(F[Fe+1],Fe+1);if(!qe)return null;Oe.push([Ve,qe])}const Fe=Ae.parse(F[F.length-1],F.length-1,Ae.expectedType,Oe);return Fe?new li(Oe,Fe):null}outputDefined(){return this.result.outputDefined()}serialize(){const F=["let"];for(const[Ae,Oe]of this.bindings)F.push(Ae,Oe.serialize());return F.push(this.result.serialize()),F}}class ui{constructor(F,Ae,Oe){this.type=F,this.index=Ae,this.input=Oe}static parse(F,Ae){if(3!==F.length)return Ae.error(`Expected 2 arguments, but found ${F.length-1} instead.`);const Oe=Ae.parse(F[1],1,qu),Fe=Ae.parse(F[2],2,$e(Ae.expectedType||Qu));return Oe&&Fe?new ui(Fe.type.itemType,Oe,Fe):null}evaluate(F){const Ae=this.index.evaluate(F),Oe=this.input.evaluate(F);if(Ae<0)throw new sr(`Array index out of bounds: ${Ae} < 0.`);if(Ae>Oe.length-1)throw new sr(`Array index out of bounds: ${Ae} > ${Oe.length-1}.`);if(Ae===Math.floor(Ae))return Oe[Ae];const Fe=Math.floor(Ae),Ve=Math.ceil(Ae),qe=Oe[Fe],pt=Oe[Ve];if("number"!=typeof qe||"number"!=typeof pt)throw new sr(`Cannot interpolate between non-number values at index ${Ae}.`);const vt=Ae-Fe;return qe*(1-vt)+pt*vt}eachChild(F){F(this.index),F(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class ci{constructor(F,Ae){this.type=$u,this.needle=F,this.haystack=Ae}static parse(F,Ae){if(3!==F.length)return Ae.error(`Expected 2 arguments, but found ${F.length-1} instead.`);const Oe=Ae.parse(F[1],1,Qu),Fe=Ae.parse(F[2],2,Qu);return Oe&&Fe?Ze(Oe.type,[$u,Zu,qu,ju,Qu])?new ci(Oe,Fe):Ae.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ge(Oe.type)} instead`):null}evaluate(F){const Ae=this.needle.evaluate(F),Oe=this.haystack.evaluate(F);if(null==Oe)return!1;if(!He(Ae,["boolean","string","number","null"]))throw new sr(`Expected first argument to be of type boolean, string, number or null, but found ${Ge(nr(Ae))} instead.`);if(!He(Oe,["string","array"]))throw new sr(`Expected second argument to be of type array or string, but found ${Ge(nr(Oe))} instead.`);return Oe.indexOf(Ae)>=0}eachChild(F){F(this.needle),F(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class hi{constructor(F,Ae,Oe){this.type=qu,this.needle=F,this.haystack=Ae,this.fromIndex=Oe}static parse(F,Ae){if(F.length<=2||F.length>=5)return Ae.error(`Expected 3 or 4 arguments, but found ${F.length-1} instead.`);const Oe=Ae.parse(F[1],1,Qu),Fe=Ae.parse(F[2],2,Qu);if(!Oe||!Fe)return null;if(!Ze(Oe.type,[$u,Zu,qu,ju,Qu]))return Ae.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ge(Oe.type)} instead`);if(4===F.length){const Ve=Ae.parse(F[3],3,qu);return Ve?new hi(Oe,Fe,Ve):null}return new hi(Oe,Fe)}evaluate(F){const Ae=this.needle.evaluate(F),Oe=this.haystack.evaluate(F);if(!He(Ae,["boolean","string","number","null"]))throw new sr(`Expected first argument to be of type boolean, string, number or null, but found ${Ge(nr(Ae))} instead.`);if(!He(Oe,["string","array"]))throw new sr(`Expected second argument to be of type array or string, but found ${Ge(nr(Oe))} instead.`);if(this.fromIndex){const Fe=this.fromIndex.evaluate(F);return Oe.indexOf(Ae,Fe)}return Oe.indexOf(Ae)}eachChild(F){F(this.needle),F(this.haystack),this.fromIndex&&F(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const F=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),F]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class pi{constructor(F,Ae,Oe,Fe,Ve,qe){this.inputType=F,this.type=Ae,this.input=Oe,this.cases=Fe,this.outputs=Ve,this.otherwise=qe}static parse(F,Ae){if(F.length<5)return Ae.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if(F.length%2!=1)return Ae.error("Expected an even number of arguments.");let Oe,Fe;Ae.expectedType&&"value"!==Ae.expectedType.kind&&(Fe=Ae.expectedType);const Ve={},qe=[];for(let pt=2;pt<F.length-1;pt+=2){let vt=F[pt];const zt=F[pt+1];Array.isArray(vt)||(vt=[vt]);const ri=Ae.concat(pt);if(0===vt.length)return ri.error("Expected at least one branch label.");for(const F of vt){if("number"!=typeof F&&"string"!=typeof F)return ri.error("Branch labels must be numbers or strings.");if("number"==typeof F&&Math.abs(F)>Number.MAX_SAFE_INTEGER)return ri.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof F&&Math.floor(F)!==F)return ri.error("Numeric branch labels must be integer values.");if(Oe){if(ri.checkSubtype(Oe,nr(F)))return null}else Oe=nr(F);if(void 0!==Ve[String(F)])return ri.error("Branch labels must be unique.");Ve[String(F)]=qe.length}const xi=Ae.parse(zt,pt,Fe);if(!xi)return null;Fe=Fe||xi.type,qe.push(xi)}const pt=Ae.parse(F[1],1,Qu);if(!pt)return null;const vt=Ae.parse(F[F.length-1],F.length-1,Fe);return vt?"value"!==pt.type.kind&&Ae.concat(1).checkSubtype(Oe,pt.type)?null:new pi(Oe,Fe,pt,Ve,qe,vt):null}evaluate(F){const Ae=this.input.evaluate(F);return(nr(Ae)===this.inputType&&this.outputs[this.cases[Ae]]||this.otherwise).evaluate(F)}eachChild(F){F(this.input),this.outputs.forEach(F),F(this.otherwise)}outputDefined(){return this.outputs.every((F=>F.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const F=["match",this.input.serialize()],Ae=Object.keys(this.cases).sort(),Oe=[],Fe={};for(const F of Ae){const Ae=Fe[this.cases[F]];void 0===Ae?(Fe[this.cases[F]]=Oe.length,Oe.push([this.cases[F],[F]])):Oe[Ae][1].push(F)}const i=F=>"number"===this.inputType.kind?Number(F):F;for(const[Ae,Fe]of Oe)F.push(1===Fe.length?i(Fe[0]):Fe.map(i)),F.push(this.outputs[Ae].serialize());return F.push(this.otherwise.serialize()),F}}class fi{constructor(F,Ae,Oe){this.type=F,this.branches=Ae,this.otherwise=Oe}static parse(F,Ae){if(F.length<4)return Ae.error(`Expected at least 3 arguments, but found only ${F.length-1}.`);if(F.length%2!=0)return Ae.error("Expected an odd number of arguments.");let Oe;Ae.expectedType&&"value"!==Ae.expectedType.kind&&(Oe=Ae.expectedType);const Fe=[];for(let Ve=1;Ve<F.length-1;Ve+=2){const qe=Ae.parse(F[Ve],Ve,$u);if(!qe)return null;const pt=Ae.parse(F[Ve+1],Ve+1,Oe);if(!pt)return null;Fe.push([qe,pt]),Oe=Oe||pt.type}const Ve=Ae.parse(F[F.length-1],F.length-1,Oe);return Ve?new fi(Oe,Fe,Ve):null}evaluate(F){for(const[Ae,Oe]of this.branches)if(Ae.evaluate(F))return Oe.evaluate(F);return this.otherwise.evaluate(F)}eachChild(F){for(const[Ae,Oe]of this.branches)F(Ae),F(Oe);F(this.otherwise)}outputDefined(){return this.branches.every((([F,Ae])=>Ae.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const F=["case"];return this.eachChild((Ae=>{F.push(Ae.serialize())})),F}}class di{constructor(F,Ae,Oe,Fe){this.type=F,this.input=Ae,this.beginIndex=Oe,this.endIndex=Fe}static parse(F,Ae){if(F.length<=2||F.length>=5)return Ae.error(`Expected 3 or 4 arguments, but found ${F.length-1} instead.`);const Oe=Ae.parse(F[1],1,Qu),Fe=Ae.parse(F[2],2,qu);if(!Oe||!Fe)return null;if(!Ze(Oe.type,[$e(Qu),Zu,Qu]))return Ae.error(`Expected first argument to be of type array or string, but found ${Ge(Oe.type)} instead`);if(4===F.length){const Ve=Ae.parse(F[3],3,qu);return Ve?new di(Oe.type,Oe,Fe,Ve):null}return new di(Oe.type,Oe,Fe)}evaluate(F){const Ae=this.input.evaluate(F),Oe=this.beginIndex.evaluate(F);if(!He(Ae,["string","array"]))throw new sr(`Expected first argument to be of type array or string, but found ${Ge(nr(Ae))} instead.`);if(this.endIndex){const Fe=this.endIndex.evaluate(F);return Ae.slice(Oe,Fe)}return Ae.slice(Oe)}eachChild(F){F(this.input),F(this.beginIndex),this.endIndex&&F(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const F=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),F]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function mi(F,Ae){return"=="===F||"!="===F?"boolean"===Ae.kind||"string"===Ae.kind||"number"===Ae.kind||"null"===Ae.kind||"value"===Ae.kind:"string"===Ae.kind||"number"===Ae.kind||"value"===Ae.kind}function yi(F,Ae,Oe,Fe){return 0===Fe.compare(Ae,Oe)}function gi(F,Ae,Oe){const Fe="=="!==F&&"!="!==F;return class i{constructor(F,Ae,Oe){this.type=$u,this.lhs=F,this.rhs=Ae,this.collator=Oe,this.hasUntypedArgument="value"===F.type.kind||"value"===Ae.type.kind}static parse(F,Ae){if(3!==F.length&&4!==F.length)return Ae.error("Expected two or three arguments.");const Oe=F[0];let Ve=Ae.parse(F[1],1,Qu);if(!Ve)return null;if(!mi(Oe,Ve.type))return Ae.concat(1).error(`"${Oe}" comparisons are not supported for type '${Ge(Ve.type)}'.`);let qe=Ae.parse(F[2],2,Qu);if(!qe)return null;if(!mi(Oe,qe.type))return Ae.concat(2).error(`"${Oe}" comparisons are not supported for type '${Ge(qe.type)}'.`);if(Ve.type.kind!==qe.type.kind&&"value"!==Ve.type.kind&&"value"!==qe.type.kind)return Ae.error(`Cannot compare types '${Ge(Ve.type)}' and '${Ge(qe.type)}'.`);Fe&&("value"===Ve.type.kind&&"value"!==qe.type.kind?Ve=new lr(qe.type,[Ve]):"value"!==Ve.type.kind&&"value"===qe.type.kind&&(qe=new lr(Ve.type,[qe])));let pt=null;if(4===F.length){if("string"!==Ve.type.kind&&"string"!==qe.type.kind&&"value"!==Ve.type.kind&&"value"!==qe.type.kind)return Ae.error("Cannot use collator to compare non-string types.");if(pt=Ae.parse(F[3],3,cd),!pt)return null}return new i(Ve,qe,pt)}evaluate(Ve){const qe=this.lhs.evaluate(Ve),pt=this.rhs.evaluate(Ve);if(Fe&&this.hasUntypedArgument){const Ae=nr(qe),Oe=nr(pt);if(Ae.kind!==Oe.kind||"string"!==Ae.kind&&"number"!==Ae.kind)throw new sr(`Expected arguments for "${F}" to be (string, string) or (number, number), but found (${Ae.kind}, ${Oe.kind}) instead.`)}if(this.collator&&!Fe&&this.hasUntypedArgument){const F=nr(qe),Oe=nr(pt);if("string"!==F.kind||"string"!==Oe.kind)return Ae(Ve,qe,pt)}return this.collator?Oe(Ve,qe,pt,this.collator.evaluate(Ve)):Ae(Ve,qe,pt)}eachChild(F){F(this.lhs),F(this.rhs),this.collator&&F(this.collator)}outputDefined(){return!0}serialize(){const Ae=[F];return this.eachChild((F=>{Ae.push(F.serialize())})),Ae}}}const Ip=gi("==",(function(F,Ae,Oe){return Ae===Oe}),yi),Pp=gi("!=",(function(F,Ae,Oe){return Ae!==Oe}),(function(F,Ae,Oe,Fe){return!yi(0,Ae,Oe,Fe)})),Rp=gi("<",(function(F,Ae,Oe){return Ae<Oe}),(function(F,Ae,Oe,Fe){return Fe.compare(Ae,Oe)<0})),Op=gi(">",(function(F,Ae,Oe){return Ae>Oe}),(function(F,Ae,Oe,Fe){return Fe.compare(Ae,Oe)>0})),Np=gi("<=",(function(F,Ae,Oe){return Ae<=Oe}),(function(F,Ae,Oe,Fe){return Fe.compare(Ae,Oe)<=0})),Vp=gi(">=",(function(F,Ae,Oe){return Ae>=Oe}),(function(F,Ae,Oe,Fe){return Fe.compare(Ae,Oe)>=0}));class Ai{constructor(F,Ae,Oe,Fe,Ve,qe){this.type=Zu,this.number=F,this.locale=Ae,this.currency=Oe,this.unit=Fe,this.minFractionDigits=Ve,this.maxFractionDigits=qe}static parse(F,Ae){if(3!==F.length)return Ae.error("Expected two arguments.");const Oe=Ae.parse(F[1],1,qu);if(!Oe)return null;const Fe=F[2];if("object"!=typeof Fe||Array.isArray(Fe))return Ae.error("NumberFormat options argument must be an object.");let Ve=null;if(Fe.locale&&(Ve=Ae.parseObjectValue(Fe.locale,2,"locale",Zu),!Ve))return null;let qe=null;if(Fe.currency&&(qe=Ae.parseObjectValue(Fe.currency,2,"currency",Zu),!qe))return null;let pt=null;if(Fe.unit&&(pt=Ae.parseObjectValue(Fe.unit,2,"unit",Zu),!pt))return null;let vt=null;if(Fe["min-fraction-digits"]&&(vt=Ae.parseObjectValue(Fe["min-fraction-digits"],2,"min-fraction-digits",qu),!vt))return null;let zt=null;return Fe["max-fraction-digits"]&&(zt=Ae.parseObjectValue(Fe["max-fraction-digits"],2,"max-fraction-digits",qu),!zt)?null:new Ai(Oe,Ve,qe,pt,vt,zt)}evaluate(F){return new Intl.NumberFormat(this.locale?this.locale.evaluate(F):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(F):void 0,unit:this.unit?this.unit.evaluate(F):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(F):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(F):void 0}).format(this.number.evaluate(F))}eachChild(F){F(this.number),this.locale&&F(this.locale),this.currency&&F(this.currency),this.unit&&F(this.unit),this.minFractionDigits&&F(this.minFractionDigits),this.maxFractionDigits&&F(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const F={};return this.locale&&(F.locale=this.locale.serialize()),this.currency&&(F.currency=this.currency.serialize()),this.unit&&(F.unit=this.unit.serialize()),this.minFractionDigits&&(F["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(F["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),F]}}class Si{constructor(F){this.type=qu,this.input=F}static parse(F,Ae){if(2!==F.length)return Ae.error(`Expected 1 argument, but found ${F.length-1} instead.`);const Oe=Ae.parse(F[1],1);return Oe?"array"!==Oe.type.kind&&"string"!==Oe.type.kind&&"value"!==Oe.type.kind?Ae.error(`Expected argument of type string or array, but found ${Ge(Oe.type)} instead.`):new Si(Oe):null}evaluate(F){const Ae=this.input.evaluate(F);if("string"==typeof Ae)return Ae.length;if(Array.isArray(Ae))return Ae.length;throw new sr(`Expected value to be of type string or array, but found ${Ge(nr(Ae))} instead.`)}eachChild(F){F(this.input)}outputDefined(){return!1}serialize(){const F=["length"];return this.eachChild((Ae=>{F.push(Ae.serialize())})),F}}function Ii(F){return function(){F=1831565813+(F|=0)|0;let Ae=Math.imul(F^F>>>15,1|F);return Ae=Ae+Math.imul(Ae^Ae>>>7,61|Ae)^Ae,((Ae^Ae>>>14)>>>0)/4294967296}}const Up={"==":Ip,"!=":Pp,">":Op,"<":Rp,">=":Vp,"<=":Np,array:lr,at:ui,boolean:lr,case:fi,coalesce:oi,collator:xr,format:ur,image:cr,in:ci,"index-of":hi,interpolate:ai,"interpolate-hcl":ai,"interpolate-lab":ai,length:Si,let:li,literal:ar,match:pi,number:lr,"number-format":Ai,object:lr,slice:di,step:Nn,string:lr,"to-boolean":fr,"to-color":fr,"to-number":fr,"to-string":fr,var:Dn,within:Nr,distance:Pn,config:kn};function zi(F,[Ae,Oe,Fe,Ve]){Ae=Ae.evaluate(F),Oe=Oe.evaluate(F),Fe=Fe.evaluate(F);const qe=Ve?Ve.evaluate(F):1,pt=er(Ae,Oe,Fe,qe);if(pt)throw new sr(pt);return new Ie(Ae/255*qe,Oe/255*qe,Fe/255*qe,qe)}function Ei(F,[Ae,Oe,Fe,Ve]){Ae=Ae.evaluate(F),Oe=Oe.evaluate(F),Fe=Fe.evaluate(F);const qe=Ve?Ve.evaluate(F):1,pt=function(F,Ae,Oe,Fe){return"number"==typeof F&&F>=0&&F<=360?"number"==typeof Ae&&Ae>=0&&Ae<=100&&"number"==typeof Oe&&Oe>=0&&Oe<=100?void 0===Fe||"number"==typeof Fe&&Fe>=0&&Fe<=1?null:`Invalid hsla value [${[F,Ae,Oe,Fe].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof Fe?[F,Ae,Oe,Fe]:[F,Ae,Oe]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof Fe?[F,Ae,Oe,Fe]:[F,Ae,Oe]).join(", ")}]: 'h' must be between 0 and 360.`}(Ae,Oe,Fe,qe);if(pt)throw new sr(pt);const vt=`hsla(${Ae}, ${Oe}%, ${Fe}%, ${qe})`,zt=Ie.parse(vt);if(!zt)throw new sr(`Failed to parse HSLA color: ${vt}`);return zt}function ki(F,Ae){return F in Ae}function Ti(F,Ae){const Oe=Ae[F];return void 0===Oe?null:Oe}function Bi(F){return{type:F}}function Ci(F){return{result:"success",value:F}}function Vi(F){return{result:"error",value:F}}function Di(F,Ae){return!!F&&!!F.parameters&&F.parameters.indexOf(Ae)>-1}function Li(F){return"data-driven"===F["property-type"]}function Ri(F){return Di(F.expression,"measure-light")}function Fi(F){return Di(F.expression,"zoom")}function Oi(F){return!!F.expression&&F.expression.interpolated}function Ni(F){return"object"==typeof F&&null!==F&&!Array.isArray(F)}function Ui(F){return F}function ji(F,Ae){const Oe="color"===Ae.type,Fe=F.stops&&"object"==typeof F.stops[0][0],Ve=Fe||!(Fe||void 0!==F.property),qe=F.type||(Oi(Ae)?"exponential":"interval");if(Oe&&((F=Te({},F)).stops&&(F.stops=F.stops.map((F=>[F[0],Ie.parse(F[1])]))),F.default=Ie.parse(F.default?F.default:Ae.default)),F.colorSpace&&"rgb"!==F.colorSpace&&!Mp[F.colorSpace])throw new Error(`Unknown color space: ${F.colorSpace}`);let pt,vt,zt;if("exponential"===qe)pt=Yi;else if("interval"===qe)pt=Gi;else if("categorical"===qe){pt=$i,vt=Object.create(null);for(const Ae of F.stops)vt[Ae[0]]=Ae[1];zt=typeof F.stops[0][0]}else{if("identity"!==qe)throw new Error(`Unknown function type "${qe}"`);pt=Xi}if(Fe){const Oe={},Fe=[];for(let Ae=0;Ae<F.stops.length;Ae++){const Ve=F.stops[Ae],qe=Ve[0].zoom;void 0===Oe[qe]&&(Oe[qe]={zoom:qe,type:F.type,property:F.property,default:F.default,stops:[]},Fe.push(qe)),Oe[qe].stops.push([Ve[0].value,Ve[1]])}const Ve=[];for(const F of Fe)Ve.push([Oe[F].zoom,ji(Oe[F],Ae)]);const qe={name:"linear"};return{kind:"composite",interpolationType:qe,interpolationFactor:ai.interpolationFactor.bind(void 0,qe),zoomStops:Ve.map((F=>F[0])),evaluate:({zoom:Oe},Fe)=>Yi({stops:Ve,base:F.base},Ae,Oe).evaluate(Oe,Fe)}}if(Ve){const Oe="exponential"===qe?{name:"exponential",base:void 0!==F.base?F.base:1}:null;return{kind:"camera",interpolationType:Oe,interpolationFactor:ai.interpolationFactor.bind(void 0,Oe),zoomStops:F.stops.map((F=>F[0])),evaluate:({zoom:Oe})=>pt(F,Ae,Oe,vt,zt)}}return{kind:"source",evaluate(Oe,Fe){const Ve=Fe&&Fe.properties?Fe.properties[F.property]:void 0;return void 0===Ve?qi(F.default,Ae.default):pt(F,Ae,Ve,vt,zt)}}}function qi(F,Ae,Oe){return void 0!==F?F:void 0!==Ae?Ae:void 0!==Oe?Oe:void 0}function $i(F,Ae,Oe,Fe,Ve){return qi(typeof Oe===Ve?Fe[Oe]:void 0,F.default,Ae.default)}function Gi(F,Ae,Oe){if("number"!==hr(Oe))return qi(F.default,Ae.default);const Fe=F.stops.length;if(1===Fe)return F.stops[0][1];if(Oe<=F.stops[0][0])return F.stops[0][1];if(Oe>=F.stops[Fe-1][0])return F.stops[Fe-1][1];const Ve=On(F.stops.map((F=>F[0])),Oe);return F.stops[Ve][1]}function Yi(F,Ae,Oe){const Fe=void 0!==F.base?F.base:1;if("number"!==hr(Oe))return qi(F.default,Ae.default);const Ve=F.stops.length;if(1===Ve)return F.stops[0][1];if(Oe<=F.stops[0][0])return F.stops[0][1];if(Oe>=F.stops[Ve-1][0])return F.stops[Ve-1][1];const qe=On(F.stops.map((F=>F[0])),Oe),pt=function(F,Ae,Oe,Fe){const Ve=Fe-Oe,qe=F-Oe;return 0===Ve?0:1===Ae?qe/Ve:(Math.pow(Ae,qe)-1)/(Math.pow(Ae,Ve)-1)}(Oe,Fe,F.stops[qe][0],F.stops[qe+1][0]),vt=F.stops[qe][1],zt=F.stops[qe+1][1];let ri=Uu[Ae.type]||Ui;if(F.colorSpace&&"rgb"!==F.colorSpace){const Ae=Mp[F.colorSpace];ri=(F,Oe)=>Ae.reverse(Ae.interpolate(Ae.forward(F),Ae.forward(Oe),pt))}return"function"==typeof vt.evaluate?{evaluate(...F){const Ae=vt.evaluate.apply(void 0,F),Oe=zt.evaluate.apply(void 0,F);if(void 0!==Ae&&void 0!==Oe)return ri(Ae,Oe,pt)}}:ri(vt,zt,pt)}function Xi(F,Ae,Oe){return"color"===Ae.type?Oe=Ie.parse(Oe):"formatted"===Ae.type?Oe=Je.fromString(Oe.toString()):"resolvedImage"===Ae.type?Oe=tr.build(Oe.toString()):hr(Oe)===Ae.type||"enum"===Ae.type&&Ae.values[Oe]||(Oe=void 0),qi(Oe,F.default,Ae.default)}yr.register(Up,{error:[{kind:"error"},[Zu],(F,[Ae])=>{throw new sr(Ae.evaluate(F))}],typeof:[Zu,[Qu],(F,[Ae])=>Ge(nr(Ae.evaluate(F)))],"to-rgba":[$e(qu,4),[Hu],(F,[Ae])=>Ae.evaluate(F).toRenderColor(null).toArray()],"to-hsla":[$e(qu,4),[Hu],(F,[Ae])=>Ae.evaluate(F).toRenderColor(null).toHslaArray()],rgb:[Hu,[qu,qu,qu],zi],rgba:[Hu,[qu,qu,qu,qu],zi],hsl:[Hu,[qu,qu,qu],Ei],hsla:[Hu,[qu,qu,qu,qu],Ei],has:{type:$u,overloads:[[[Zu],(F,[Ae])=>ki(Ae.evaluate(F),F.properties())],[[Zu,Ju],(F,[Ae,Oe])=>ki(Ae.evaluate(F),Oe.evaluate(F))]]},get:{type:Qu,overloads:[[[Zu],(F,[Ae])=>Ti(Ae.evaluate(F),F.properties())],[[Zu,Ju],(F,[Ae,Oe])=>Ti(Ae.evaluate(F),Oe.evaluate(F))]]},"feature-state":[Qu,[Zu],(F,[Ae])=>Ti(Ae.evaluate(F),F.featureState||{})],properties:[Ju,[],F=>F.properties()],"geometry-type":[Zu,[],F=>F.geometryType()],id:[Qu,[],F=>F.id()],zoom:[qu,[],F=>F.globals.zoom],pitch:[qu,[],F=>F.globals.pitch||0],"distance-from-center":[qu,[],F=>F.distanceFromCenter()],"measure-light":[qu,[Zu],(F,[Ae])=>F.measureLight(Ae.evaluate(F))],"heatmap-density":[qu,[],F=>F.globals.heatmapDensity||0],"line-progress":[qu,[],F=>F.globals.lineProgress||0],"raster-value":[qu,[],F=>F.globals.rasterValue||0],"raster-particle-speed":[qu,[],F=>F.globals.rasterParticleSpeed||0],"sky-radial-progress":[qu,[],F=>F.globals.skyRadialProgress||0],accumulated:[Qu,[],F=>void 0===F.globals.accumulated?null:F.globals.accumulated],"+":[qu,Bi(qu),(F,Ae)=>{let Oe=0;for(const Fe of Ae)Oe+=Fe.evaluate(F);return Oe}],"*":[qu,Bi(qu),(F,Ae)=>{let Oe=1;for(const Fe of Ae)Oe*=Fe.evaluate(F);return Oe}],"-":{type:qu,overloads:[[[qu,qu],(F,[Ae,Oe])=>Ae.evaluate(F)-Oe.evaluate(F)],[[qu],(F,[Ae])=>-Ae.evaluate(F)]]},"/":[qu,[qu,qu],(F,[Ae,Oe])=>Ae.evaluate(F)/Oe.evaluate(F)],"%":[qu,[qu,qu],(F,[Ae,Oe])=>Ae.evaluate(F)%Oe.evaluate(F)],ln2:[qu,[],()=>Math.LN2],pi:[qu,[],()=>Math.PI],e:[qu,[],()=>Math.E],"^":[qu,[qu,qu],(F,[Ae,Oe])=>Math.pow(Ae.evaluate(F),Oe.evaluate(F))],sqrt:[qu,[qu],(F,[Ae])=>Math.sqrt(Ae.evaluate(F))],log10:[qu,[qu],(F,[Ae])=>Math.log(Ae.evaluate(F))/Math.LN10],ln:[qu,[qu],(F,[Ae])=>Math.log(Ae.evaluate(F))],log2:[qu,[qu],(F,[Ae])=>Math.log(Ae.evaluate(F))/Math.LN2],sin:[qu,[qu],(F,[Ae])=>Math.sin(Ae.evaluate(F))],cos:[qu,[qu],(F,[Ae])=>Math.cos(Ae.evaluate(F))],tan:[qu,[qu],(F,[Ae])=>Math.tan(Ae.evaluate(F))],asin:[qu,[qu],(F,[Ae])=>Math.asin(Ae.evaluate(F))],acos:[qu,[qu],(F,[Ae])=>Math.acos(Ae.evaluate(F))],atan:[qu,[qu],(F,[Ae])=>Math.atan(Ae.evaluate(F))],min:[qu,Bi(qu),(F,Ae)=>Math.min(...Ae.map((Ae=>Ae.evaluate(F))))],max:[qu,Bi(qu),(F,Ae)=>Math.max(...Ae.map((Ae=>Ae.evaluate(F))))],abs:[qu,[qu],(F,[Ae])=>Math.abs(Ae.evaluate(F))],round:[qu,[qu],(F,[Ae])=>{const Oe=Ae.evaluate(F);return Oe<0?-Math.round(-Oe):Math.round(Oe)}],floor:[qu,[qu],(F,[Ae])=>Math.floor(Ae.evaluate(F))],ceil:[qu,[qu],(F,[Ae])=>Math.ceil(Ae.evaluate(F))],"filter-==":[$u,[Zu,Qu],(F,[Ae,Oe])=>F.properties()[Ae.value]===Oe.value],"filter-id-==":[$u,[Qu],(F,[Ae])=>F.id()===Ae.value],"filter-type-==":[$u,[Zu],(F,[Ae])=>F.geometryType()===Ae.value],"filter-<":[$u,[Zu,Qu],(F,[Ae,Oe])=>{const Fe=F.properties()[Ae.value],Ve=Oe.value;return typeof Fe==typeof Ve&&Fe<Ve}],"filter-id-<":[$u,[Qu],(F,[Ae])=>{const Oe=F.id(),Fe=Ae.value;return typeof Oe==typeof Fe&&Oe<Fe}],"filter->":[$u,[Zu,Qu],(F,[Ae,Oe])=>{const Fe=F.properties()[Ae.value],Ve=Oe.value;return typeof Fe==typeof Ve&&Fe>Ve}],"filter-id->":[$u,[Qu],(F,[Ae])=>{const Oe=F.id(),Fe=Ae.value;return typeof Oe==typeof Fe&&Oe>Fe}],"filter-<=":[$u,[Zu,Qu],(F,[Ae,Oe])=>{const Fe=F.properties()[Ae.value],Ve=Oe.value;return typeof Fe==typeof Ve&&Fe<=Ve}],"filter-id-<=":[$u,[Qu],(F,[Ae])=>{const Oe=F.id(),Fe=Ae.value;return typeof Oe==typeof Fe&&Oe<=Fe}],"filter->=":[$u,[Zu,Qu],(F,[Ae,Oe])=>{const Fe=F.properties()[Ae.value],Ve=Oe.value;return typeof Fe==typeof Ve&&Fe>=Ve}],"filter-id->=":[$u,[Qu],(F,[Ae])=>{const Oe=F.id(),Fe=Ae.value;return typeof Oe==typeof Fe&&Oe>=Fe}],"filter-has":[$u,[Qu],(F,[Ae])=>Ae.value in F.properties()],"filter-has-id":[$u,[],F=>null!==F.id()&&void 0!==F.id()],"filter-type-in":[$u,[$e(Zu)],(F,[Ae])=>Ae.value.indexOf(F.geometryType())>=0],"filter-id-in":[$u,[$e(Qu)],(F,[Ae])=>Ae.value.indexOf(F.id())>=0],"filter-in-small":[$u,[Zu,$e(Qu)],(F,[Ae,Oe])=>Oe.value.indexOf(F.properties()[Ae.value])>=0],"filter-in-large":[$u,[Zu,$e(Qu)],(F,[Ae,Oe])=>function(F,Ae,Oe,Fe){for(;Oe<=Fe;){const Ve=Oe+Fe>>1;if(Ae[Ve]===F)return!0;Ae[Ve]>F?Fe=Ve-1:Oe=Ve+1}return!1}(F.properties()[Ae.value],Oe.value,0,Oe.value.length-1)],all:{type:$u,overloads:[[[$u,$u],(F,[Ae,Oe])=>Ae.evaluate(F)&&Oe.evaluate(F)],[Bi($u),(F,Ae)=>{for(const Oe of Ae)if(!Oe.evaluate(F))return!1;return!0}]]},any:{type:$u,overloads:[[[$u,$u],(F,[Ae,Oe])=>Ae.evaluate(F)||Oe.evaluate(F)],[Bi($u),(F,Ae)=>{for(const Oe of Ae)if(Oe.evaluate(F))return!0;return!1}]]},"!":[$u,[$u],(F,[Ae])=>!Ae.evaluate(F)],"is-supported-script":[$u,[Zu],(F,[Ae])=>{const Oe=F.globals&&F.globals.isSupportedScript;return!Oe||Oe(Ae.evaluate(F))}],upcase:[Zu,[Zu],(F,[Ae])=>Ae.evaluate(F).toUpperCase()],downcase:[Zu,[Zu],(F,[Ae])=>Ae.evaluate(F).toLowerCase()],concat:[Zu,Bi(Qu),(F,Ae)=>Ae.map((Ae=>ir(Ae.evaluate(F)))).join("")],"resolved-locale":[Zu,[cd],(F,[Ae])=>Ae.evaluate(F).resolvedLocale()],random:[qu,[qu,qu,Qu],(F,Ae)=>{const[Oe,Fe,Ve]=Ae.map((Ae=>Ae.evaluate(F)));if(Oe>Fe)return Oe;if(Oe===Fe)return Oe;let qe;if("string"==typeof Ve)qe=function(F){let Ae=0;if(0===F.length)return Ae;for(let Oe=0;Oe<F.length;Oe++)Ae=(Ae<<5)-Ae+F.charCodeAt(Oe),Ae|=0;return Ae}(Ve);else{if("number"!=typeof Ve)throw new sr(`Invalid seed input: ${Ve}`);qe=Ve}return Oe+Ii(qe)()*(Fe-Oe)}]});class Zi{constructor(F,Ae,Oe,Fe){this.expression=F,this._warningHistory={},this._evaluator=new mr(Oe,Fe),this._defaultValue=Ae?function(F){return"color"===F.type&&(Ni(F.default)||Array.isArray(F.default))?new Ie(0,0,0,0):"color"===F.type?Ie.parse(F.default)||null:void 0===F.default?null:F.default}(Ae):null,this._enumValues=Ae&&"enum"===Ae.type?Ae.values:null,this.configDependencies=Cn(F)}evaluateWithoutErrorHandling(F,Ae,Oe,Fe,Ve,qe,pt,vt){return this._evaluator.globals=F,this._evaluator.feature=Ae,this._evaluator.featureState=Oe,this._evaluator.canonical=Fe||null,this._evaluator.availableImages=Ve||null,this._evaluator.formattedSection=qe,this._evaluator.featureTileCoord=pt||null,this._evaluator.featureDistanceData=vt||null,this.expression.evaluate(this._evaluator)}evaluate(F,Ae,Oe,Fe,Ve,qe,pt,vt){this._evaluator.globals=F,this._evaluator.feature=Ae||null,this._evaluator.featureState=Oe||null,this._evaluator.canonical=Fe||null,this._evaluator.availableImages=Ve||null,this._evaluator.formattedSection=qe||null,this._evaluator.featureTileCoord=pt||null,this._evaluator.featureDistanceData=vt||null;try{const F=this.expression.evaluate(this._evaluator);if(null==F||"number"==typeof F&&F!=F)return this._defaultValue;if(this._enumValues&&!(F in this._enumValues))throw new sr(`Expected value to be one of ${Object.keys(this._enumValues).map((F=>JSON.stringify(F))).join(", ")}, but found ${JSON.stringify(F)} instead.`);return F}catch(F){return this._warningHistory[F.message]||(this._warningHistory[F.message]=!0,"undefined"!=typeof console&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${F.message}`)),this._defaultValue}}}function Hi(F){return Array.isArray(F)&&F.length>0&&"string"==typeof F[0]&&F[0]in Up}function Wi(F,Ae,Oe,Fe){const Ve=new lp(Up,[],Ae?function(F){const Ae={color:Hu,string:Zu,number:qu,enum:Zu,boolean:$u,formatted:ud,resolvedImage:dd};return"array"===F.type?$e(Ae[F.value]||Qu,F.length):Ae[F.type]}(Ae):void 0,void 0,void 0,Oe,Fe),qe=Ve.parse(F,void 0,void 0,void 0,Ae&&"string"===Ae.type?{typeAnnotation:"coerce"}:void 0);return qe?Ci(new Zi(qe,Ae,Oe,Fe)):Vi(Ve.errors)}class Ki{constructor(F,Ae,Oe,Fe){this.kind=F,this._styleExpression=Ae,this.isLightConstant=Oe,this.isLineProgressConstant=Fe,this.isStateDependent="constant"!==F&&!Bn(Ae.expression),this.configDependencies=Cn(Ae.expression)}evaluateWithoutErrorHandling(F,Ae,Oe,Fe,Ve,qe){return this._styleExpression.evaluateWithoutErrorHandling(F,Ae,Oe,Fe,Ve,qe)}evaluate(F,Ae,Oe,Fe,Ve,qe){return this._styleExpression.evaluate(F,Ae,Oe,Fe,Ve,qe)}}class Ji{constructor(F,Ae,Oe,Fe,Ve,qe){this.kind=F,this.zoomStops=Oe,this._styleExpression=Ae,this.isStateDependent="camera"!==F&&!Bn(Ae.expression),this.isLightConstant=Ve,this.isLineProgressConstant=qe,this.configDependencies=Cn(Ae.expression),this.interpolationType=Fe}evaluateWithoutErrorHandling(F,Ae,Oe,Fe,Ve,qe){return this._styleExpression.evaluateWithoutErrorHandling(F,Ae,Oe,Fe,Ve,qe)}evaluate(F,Ae,Oe,Fe,Ve,qe){return this._styleExpression.evaluate(F,Ae,Oe,Fe,Ve,qe)}interpolationFactor(F,Ae,Oe){return this.interpolationType?ai.interpolationFactor(this.interpolationType,F,Ae,Oe):0}}function Qi(F,Ae,Oe,Fe){if("error"===(F=Wi(F,Ae,Oe,Fe)).result)return F;const Ve=F.value.expression,qe=Tn(Ve);if(!qe&&!Li(Ae))return Vi([new Be("","data expressions not supported")]);const pt=Vn(Ve,["zoom","pitch","distance-from-center"]);if(!pt&&!Fi(Ae))return Vi([new Be("","zoom expressions not supported")]);const vt=Vn(Ve,["measure-light"]);if(!vt&&!Ri(Ae))return Vi([new Be("","measure-light expression not supported")]);const zt=Vn(Ve,["line-progress"]);if(!zt&&!function(F){return Di(F.expression,"line-progress")}(Ae))return Vi([new Be("","line-progress expression not supported")]);const ri=Ae.expression&&Ae.expression.relaxZoomRestriction,xi=ea(Ve);return xi||pt||ri?xi instanceof Be?Vi([xi]):xi instanceof ai&&!Oi(Ae)?Vi([new Be("",'"interpolate" expressions cannot be used with this property')]):Ci(xi?new Ji(qe&&zt?"camera":"composite",F.value,xi.labels,xi instanceof ai?xi.interpolation:void 0,vt,zt):new Ki(qe&&zt?"constant":"source",F.value,vt,zt)):Vi([new Be("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class ta{constructor(F,Ae){this._parameters=F,this._specification=Ae,Te(this,ji(this._parameters,this._specification))}static deserialize(F){return new ta(F._parameters,F._specification)}static serialize(F){return{_parameters:F._parameters,_specification:F._specification}}}function ea(F){let Ae=null;if(F instanceof li)Ae=ea(F.result);else if(F instanceof oi){for(const Oe of F.args)if(Ae=ea(Oe),Ae)break}else(F instanceof Nn||F instanceof ai)&&F.input instanceof yr&&"zoom"===F.input.name&&(Ae=F);return Ae instanceof Be||F.eachChild((F=>{const Oe=ea(F);Oe instanceof Be?Ae=Oe:Ae&&Oe&&Ae!==Oe&&(Ae=new Be("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),Ae}var jp,Gp,qp=function(){if(Gp)return jp;Gp=1,jp=e;var Ae=3;function e(Oe,Fe,Ve){var qe=(this||F).cells=[];if(Oe instanceof ArrayBuffer){(this||F).arrayBuffer=Oe;var pt=new Int32Array((this||F).arrayBuffer);Oe=pt[0],(this||F).d=(Fe=pt[1])+2*(Ve=pt[2]);for(var vt=0;vt<(this||F).d*(this||F).d;vt++){var zt=pt[Ae+vt],ri=pt[Ae+vt+1];qe.push(zt===ri?null:pt.subarray(zt,ri))}var xi=pt[Ae+qe.length+1];(this||F).keys=pt.subarray(pt[Ae+qe.length],xi),(this||F).bboxes=pt.subarray(xi),(this||F).insert=(this||F)._insertReadonly}else{(this||F).d=Fe+2*Ve;for(var bi=0;bi<(this||F).d*(this||F).d;bi++)qe.push([]);(this||F).keys=[],(this||F).bboxes=[]}(this||F).n=Fe,(this||F).extent=Oe,(this||F).padding=Ve,(this||F).scale=Fe/Oe,(this||F).uid=0;var wi=Ve/Fe*Oe;(this||F).min=-wi,(this||F).max=Oe+wi}return e.prototype.insert=function(Ae,Oe,Fe,Ve,qe){this._forEachCell(Oe,Fe,Ve,qe,(this||F)._insertCell,(this||F).uid++),(this||F).keys.push(Ae),(this||F).bboxes.push(Oe),(this||F).bboxes.push(Fe),(this||F).bboxes.push(Ve),(this||F).bboxes.push(qe)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(Ae,Oe,Fe,Ve,qe,pt){(this||F).cells[qe].push(pt)},e.prototype.query=function(Ae,Oe,Fe,Ve,qe){var pt=(this||F).min,vt=(this||F).max;if(Ae<=pt&&Oe<=pt&&vt<=Fe&&vt<=Ve&&!qe)return Array.prototype.slice.call((this||F).keys);var zt=[];return this._forEachCell(Ae,Oe,Fe,Ve,(this||F)._queryCell,zt,{},qe),zt},e.prototype._queryCell=function(Ae,Oe,Fe,Ve,qe,pt,vt,zt){var ri=(this||F).cells[qe];if(null!==ri)for(var xi=(this||F).keys,bi=(this||F).bboxes,wi=0;wi<ri.length;wi++){var dr=ri[wi];if(void 0===vt[dr]){var jr=4*dr;(zt?zt(bi[jr+0],bi[jr+1],bi[jr+2],bi[jr+3]):Ae<=bi[jr+2]&&Oe<=bi[jr+3]&&Fe>=bi[jr+0]&&Ve>=bi[jr+1])?(vt[dr]=!0,pt.push(xi[dr])):vt[dr]=!1}}},e.prototype._forEachCell=function(Ae,Oe,Fe,Ve,qe,pt,vt,zt){for(var ri=this._convertToCellCoord(Ae),xi=this._convertToCellCoord(Oe),bi=this._convertToCellCoord(Fe),wi=this._convertToCellCoord(Ve),dr=ri;dr<=bi;dr++)for(var jr=xi;jr<=wi;jr++){var Qr=(this||F).d*jr+dr;if((!zt||zt(this._convertFromCellCoord(dr),this._convertFromCellCoord(jr),this._convertFromCellCoord(dr+1),this._convertFromCellCoord(jr+1)))&&qe.call(this||F,Ae,Oe,Fe,Ve,Qr,pt,vt,zt))return}},e.prototype._convertFromCellCoord=function(Ae){return(Ae-(this||F).padding)/(this||F).scale},e.prototype._convertToCellCoord=function(Ae){return Math.max(0,Math.min((this||F).d-1,Math.floor(Ae*(this||F).scale)+(this||F).padding))},e.prototype.toArrayBuffer=function(){if((this||F).arrayBuffer)return(this||F).arrayBuffer;for(var Oe=(this||F).cells,Fe=Ae+(this||F).cells.length+1+1,Ve=0,qe=0;qe<(this||F).cells.length;qe++)Ve+=(this||F).cells[qe].length;var pt=new Int32Array(Fe+Ve+(this||F).keys.length+(this||F).bboxes.length);pt[0]=(this||F).extent,pt[1]=(this||F).n,pt[2]=(this||F).padding;for(var vt=Fe,zt=0;zt<Oe.length;zt++){var ri=Oe[zt];pt[Ae+zt]=vt,pt.set(ri,vt),vt+=ri.length}return pt[Ae+Oe.length]=vt,pt.set((this||F).keys,vt),pt[Ae+Oe.length+1]=vt+=(this||F).keys.length,pt.set((this||F).bboxes,vt),vt+=(this||F).bboxes.length,pt.buffer},jp}(),Zp=e(qp);const $p={};function oa(F,Ae,Oe={}){Object.defineProperty(F,"_classRegistryKey",{value:Ae,writable:!1}),$p[Ae]={klass:F,omit:Oe.omit||[]}}oa(Object,"Object"),Zp.serialize=function(F,Ae){const Oe=F.toArrayBuffer();return Ae&&Ae.add(Oe),{buffer:Oe}},Zp.deserialize=function(F){return new Zp(F.buffer)},Object.defineProperty(Zp,"name",{value:"Grid"}),oa(Zp,"Grid"),"undefined"!=typeof DOMMatrix&&oa(DOMMatrix,"DOMMatrix"),oa(Ie,"Color"),oa(Error,"Error"),oa(Je,"Formatted"),oa(Ke,"FormattedSection"),oa(ee,"AJAXError"),oa(tr,"ResolvedImage"),oa(ta,"StylePropertyFunction"),oa(Zi,"StyleExpression",{omit:["_evaluator"]}),oa(Qe,"ImageIdWithOptions"),oa(Ji,"ZoomDependentExpression"),oa(Ki,"ZoomConstantExpression"),oa(yr,"CompoundExpression",{omit:["_evaluate"]});for(const F in Up)$p[Up[F]._classRegistryKey]||oa(Up[F],`Expression${F}`);function la(F){return F&&"undefined"!=typeof ArrayBuffer&&(F instanceof ArrayBuffer||F.constructor&&"ArrayBuffer"===F.constructor.name)}function ua(F){return self.ImageBitmap&&F instanceof ImageBitmap}function ca(F,Ae){if(null==F||"boolean"==typeof F||"number"==typeof F||"string"==typeof F||F instanceof Boolean||F instanceof Number||F instanceof String||F instanceof Date||F instanceof RegExp)return F;if(la(F)||ua(F))return Ae&&Ae.add(F),F;if(ArrayBuffer.isView(F))return Ae&&Ae.add(F.buffer),F;if(F instanceof ImageData)return Ae&&Ae.add(F.data.buffer),F;if(Array.isArray(F)){const Oe=[];for(const Fe of F)Oe.push(ca(Fe,Ae));return Oe}if(F instanceof Map){const Ae={$name:"Map"};for(const[Oe,Fe]of F.entries())Ae[Oe]=ca(Fe);return Ae}if(F instanceof Set){const Ae={$name:"Set"};let Oe=0;for(const Fe of F.values())Ae[++Oe]=ca(Fe);return Ae}if("object"==typeof F){const Oe=F.constructor,Fe=Oe._classRegistryKey;if(!Fe)throw new Error(`Can't serialize object of unregistered class "${Fe}".`);const Ve=Oe.serialize?Oe.serialize(F,Ae):{};if(!Oe.serialize){for(const Oe in F)F.hasOwnProperty(Oe)&&($p[Fe].omit.indexOf(Oe)>=0||(Ve[Oe]=ca(F[Oe],Ae)));F instanceof Error&&(Ve.message=F.message)}if(Ve.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==Fe&&(Ve.$name=Fe),Ve}throw new Error("can't serialize object of type "+typeof F)}function ha(F){if(null==F||"boolean"==typeof F||"number"==typeof F||"string"==typeof F||F instanceof Boolean||F instanceof Number||F instanceof String||F instanceof Date||F instanceof RegExp||la(F)||ua(F)||ArrayBuffer.isView(F)||F instanceof ImageData)return F;if(Array.isArray(F))return F.map(ha);if("object"==typeof F){const Ae=F.$name||"Object";if("Map"===Ae){const Ae=new Map;for(const Oe of Object.keys(F))"$name"!==Oe&&Ae.set(Oe,ha(F[Oe]));return Ae}if("Set"===Ae){const Ae=new Set;for(const Oe of Object.keys(F))"$name"!==Oe&&Ae.add(ha(F[Oe]));return Ae}const{klass:Oe}=$p[Ae];if(!Oe)throw new Error(`Can't deserialize unregistered class "${Ae}".`);if(Oe.deserialize)return Oe.deserialize(F);const Fe=Object.create(Oe.prototype);for(const Ae of Object.keys(F))"$name"!==Ae&&(Fe[Ae]=ha(F[Ae]));return Fe}throw new Error("can't deserialize object of type "+typeof F)}const Hp={"Latin-1 Supplement":F=>F>=128&&F<=255,Arabic:F=>F>=1536&&F<=1791,"Arabic Supplement":F=>F>=1872&&F<=1919,"Arabic Extended-A":F=>F>=2208&&F<=2303,"Hangul Jamo":F=>F>=4352&&F<=4607,"Unified Canadian Aboriginal Syllabics":F=>F>=5120&&F<=5759,Khmer:F=>F>=6016&&F<=6143,"Unified Canadian Aboriginal Syllabics Extended":F=>F>=6320&&F<=6399,"General Punctuation":F=>F>=8192&&F<=8303,"Letterlike Symbols":F=>F>=8448&&F<=8527,"Number Forms":F=>F>=8528&&F<=8591,"Miscellaneous Technical":F=>F>=8960&&F<=9215,"Control Pictures":F=>F>=9216&&F<=9279,"Optical Character Recognition":F=>F>=9280&&F<=9311,"Enclosed Alphanumerics":F=>F>=9312&&F<=9471,"Geometric Shapes":F=>F>=9632&&F<=9727,"Miscellaneous Symbols":F=>F>=9728&&F<=9983,"Miscellaneous Symbols and Arrows":F=>F>=11008&&F<=11263,"CJK Radicals Supplement":F=>F>=11904&&F<=12031,"Kangxi Radicals":F=>F>=12032&&F<=12255,"Ideographic Description Characters":F=>F>=12272&&F<=12287,"CJK Symbols and Punctuation":F=>F>=12288&&F<=12351,Hiragana:F=>F>=12352&&F<=12447,Katakana:F=>F>=12448&&F<=12543,Bopomofo:F=>F>=12544&&F<=12591,"Hangul Compatibility Jamo":F=>F>=12592&&F<=12687,Kanbun:F=>F>=12688&&F<=12703,"Bopomofo Extended":F=>F>=12704&&F<=12735,"CJK Strokes":F=>F>=12736&&F<=12783,"Katakana Phonetic Extensions":F=>F>=12784&&F<=12799,"Enclosed CJK Letters and Months":F=>F>=12800&&F<=13055,"CJK Compatibility":F=>F>=13056&&F<=13311,"CJK Unified Ideographs Extension A":F=>F>=13312&&F<=19903,"Yijing Hexagram Symbols":F=>F>=19904&&F<=19967,"CJK Unified Ideographs":F=>F>=19968&&F<=40959,"Yi Syllables":F=>F>=40960&&F<=42127,"Yi Radicals":F=>F>=42128&&F<=42191,"Hangul Jamo Extended-A":F=>F>=43360&&F<=43391,"Hangul Syllables":F=>F>=44032&&F<=55215,"Hangul Jamo Extended-B":F=>F>=55216&&F<=55295,"Private Use Area":F=>F>=57344&&F<=63743,"CJK Compatibility Ideographs":F=>F>=63744&&F<=64255,"Arabic Presentation Forms-A":F=>F>=64336&&F<=65023,"Vertical Forms":F=>F>=65040&&F<=65055,"CJK Compatibility Forms":F=>F>=65072&&F<=65103,"Small Form Variants":F=>F>=65104&&F<=65135,"Arabic Presentation Forms-B":F=>F>=65136&&F<=65279,"Halfwidth and Fullwidth Forms":F=>F>=65280&&F<=65519,Osage:F=>F>=66736&&F<=66815,"CJK Unified Ideographs Extension B":F=>F>=131072&&F<=173791};function fa(F){for(const Ae of F)if(ya(Ae.charCodeAt(0)))return!0;return!1}function da(F){for(const Ae of F)if(!ma(Ae.charCodeAt(0)))return!1;return!0}function ma(F){return!(Hp.Arabic(F)||Hp["Arabic Supplement"](F)||Hp["Arabic Extended-A"](F)||Hp["Arabic Presentation Forms-A"](F)||Hp["Arabic Presentation Forms-B"](F))}function ya(F){return!(746!==F&&747!==F&&(F<4352||!(Hp["Bopomofo Extended"](F)||Hp.Bopomofo(F)||Hp["CJK Compatibility Forms"](F)&&!(F>=65097&&F<=65103)||Hp["CJK Compatibility Ideographs"](F)||Hp["CJK Compatibility"](F)||Hp["CJK Radicals Supplement"](F)||Hp["CJK Strokes"](F)||!(!Hp["CJK Symbols and Punctuation"](F)||F>=12296&&F<=12305||F>=12308&&F<=12319||12336===F)||Hp["CJK Unified Ideographs Extension A"](F)||Hp["CJK Unified Ideographs"](F)||Hp["Enclosed CJK Letters and Months"](F)||Hp["Hangul Compatibility Jamo"](F)||Hp["Hangul Jamo Extended-A"](F)||Hp["Hangul Jamo Extended-B"](F)||Hp["Hangul Jamo"](F)||Hp["Hangul Syllables"](F)||Hp.Hiragana(F)||Hp["Ideographic Description Characters"](F)||Hp.Kanbun(F)||Hp["Kangxi Radicals"](F)||Hp["Katakana Phonetic Extensions"](F)||Hp.Katakana(F)&&12540!==F||!(!Hp["Halfwidth and Fullwidth Forms"](F)||65288===F||65289===F||65293===F||F>=65306&&F<=65310||65339===F||65341===F||65343===F||F>=65371&&F<=65503||65507===F||F>=65512&&F<=65519)||!(!Hp["Small Form Variants"](F)||F>=65112&&F<=65118||F>=65123&&F<=65126)||Hp["Unified Canadian Aboriginal Syllabics"](F)||Hp["Unified Canadian Aboriginal Syllabics Extended"](F)||Hp["Vertical Forms"](F)||Hp["Yijing Hexagram Symbols"](F)||Hp["Yi Syllables"](F)||Hp["Yi Radicals"](F))))}function ga(F){return!(ya(F)||function(F){return!!(Hp["Latin-1 Supplement"](F)&&(167===F||169===F||174===F||177===F||188===F||189===F||190===F||215===F||247===F)||Hp["General Punctuation"](F)&&(8214===F||8224===F||8225===F||8240===F||8241===F||8251===F||8252===F||8258===F||8263===F||8264===F||8265===F||8273===F)||Hp["Letterlike Symbols"](F)||Hp["Number Forms"](F)||Hp["Miscellaneous Technical"](F)&&(F>=8960&&F<=8967||F>=8972&&F<=8991||F>=8996&&F<=9e3||9003===F||F>=9085&&F<=9114||F>=9150&&F<=9165||9167===F||F>=9169&&F<=9179||F>=9186&&F<=9215)||Hp["Control Pictures"](F)&&9251!==F||Hp["Optical Character Recognition"](F)||Hp["Enclosed Alphanumerics"](F)||Hp["Geometric Shapes"](F)||Hp["Miscellaneous Symbols"](F)&&!(F>=9754&&F<=9759)||Hp["Miscellaneous Symbols and Arrows"](F)&&(F>=11026&&F<=11055||F>=11088&&F<=11097||F>=11192&&F<=11243)||Hp["CJK Symbols and Punctuation"](F)||Hp.Katakana(F)||Hp["Private Use Area"](F)||Hp["CJK Compatibility Forms"](F)||Hp["Small Form Variants"](F)||Hp["Halfwidth and Fullwidth Forms"](F)||8734===F||8756===F||8757===F||F>=9984&&F<=10087||F>=10102&&F<=10131||65532===F||65533===F)}(F))}function xa(F){return F>=1424&&F<=2303||Hp["Arabic Presentation Forms-A"](F)||Hp["Arabic Presentation Forms-B"](F)}function va(F,Ae){return!(!Ae&&xa(F)||F>=2304&&F<=3583||F>=3840&&F<=4255||Hp.Khmer(F))}function ba(F){for(const Ae of F)if(xa(Ae.charCodeAt(0)))return!0;return!1}const Xp="deferred",Yp="loading",tf="loaded";let rf=null,of="unavailable",sf=null;const Pa=function(F){F&&"string"==typeof F&&F.indexOf("NetworkError")>-1&&(of="error"),rf&&rf(F)};function za(){lf.fire(new xe("pluginStateChange",{pluginStatus:of,pluginURL:sf}))}const lf=new we,ka=function(){return of},Ta=function(){if(of!==Xp||!sf)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");of=Yp,za(),sf&&ie({url:sf},(F=>{F?Pa(F):(of=tf,za())}))},uf={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>of===tf||null!=uf.applyArabicShaping,isLoading:()=>of===Yp,setState(F){of=F.pluginStatus,sf=F.pluginURL},isParsed:()=>null!=uf.applyArabicShaping&&null!=uf.processBidirectionalText&&null!=uf.processStyledBidirectionalText,getPluginURL:()=>sf};class Ca{constructor(F,Ae){this.zoom=F,Ae?(this.now=Ae.now,this.fadeDuration=Ae.fadeDuration,this.transition=Ae.transition,this.pitch=Ae.pitch,this.brightness=Ae.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(F){return function(F,Ae){for(const Oe of F)if(!va(Oe.charCodeAt(0),Ae))return!1;return!0}(F,uf.isLoaded())}}class Va{constructor(F,Ae,Oe,Fe){this.property=F,this.value=Ae,this.expression=function(F,Ae,Oe,Fe){if(Ni(F))return new ta(F,Ae);if(Hi(F)||Array.isArray(F)&&F.length>0){const Ve=Qi(F,Ae,Oe,Fe);if("error"===Ve.result)throw new Error(Ve.value.map((F=>`${F.key}: ${F.message}`)).join(", "));return Ve.value}{let Oe=F;return"string"==typeof F&&"color"===Ae.type&&(Oe=Ie.parse(F)),{kind:"constant",configDependencies:new Set,evaluate:()=>Oe}}}(void 0===Ae?F.specification.default:Ae,F.specification,Oe,Fe)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(F,Ae,Oe){return this.property.possiblyEvaluate(this,F,Ae,Oe)}}class Da{constructor(F,Ae,Oe){this.property=F,this.value=new Va(F,void 0,Ae,Oe)}transitioned(F,Ae){return new Ra(this.property,this.value,Ae,nt({},F.transition,this.transition),F.now)}untransitioned(){return new Ra(this.property,this.value,null,{},0)}}class La{constructor(F,Ae,Oe){this._properties=F,this._values=Object.create(F.defaultTransitionablePropertyValues),this._scope=Ae,this._options=Oe,this.configDependencies=new Set}getValue(F){return ht(this._values[F].value.value)}setValue(F,Ae){this._values.hasOwnProperty(F)||(this._values[F]=new Da(this._values[F].property,this._scope,this._options)),this._values[F].value=new Va(this._values[F].property,null===Ae?void 0:ht(Ae),this._scope,this._options),this._values[F].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[F].value.expression.configDependencies]))}setTransitionOrValue(F,Ae){Ae&&(this._options=Ae);const Oe=this._properties.properties;if(F)for(const Ae in F){const Fe=F[Ae];if(lt(Ae,"-transition")){const F=Ae.slice(0,-11);Oe[F]&&this.setTransition(F,Fe)}else Oe.hasOwnProperty(Ae)&&this.setValue(Ae,Fe)}}getTransition(F){return ht(this._values[F].transition)}setTransition(F,Ae){this._values.hasOwnProperty(F)||(this._values[F]=new Da(this._values[F].property)),this._values[F].transition=ht(Ae)||void 0}serialize(){const F={};for(const Ae of Object.keys(this._values)){const Oe=this.getValue(Ae);void 0!==Oe&&(F[Ae]=Oe);const Fe=this.getTransition(Ae);void 0!==Fe&&(F[`${Ae}-transition`]=Fe)}return F}transitioned(F,Ae){const Oe=new Fa(this._properties);for(const Fe of Object.keys(this._values))Oe._values[Fe]=this._values[Fe].transitioned(F,Ae._values[Fe]);return Oe}untransitioned(){const F=new Fa(this._properties);for(const Ae of Object.keys(this._values))F._values[Ae]=this._values[Ae].untransitioned();return F}}class Ra{constructor(F,Ae,Oe,Fe,Ve){const qe=Fe.delay||0,pt=Fe.duration||0;Ve=Ve||0,this.property=F,this.value=Ae,this.begin=Ve+qe,this.end=this.begin+pt,F.specification.transition&&(Fe.delay||Fe.duration)&&(this.prior=Oe)}possiblyEvaluate(F,Ae,Oe){const Fe=F.now||0,Ve=this.value.possiblyEvaluate(F,Ae,Oe),qe=this.prior;if(qe){if(Fe>this.end)return this.prior=null,Ve;if(this.value.isDataDriven())return this.prior=null,Ve;if(Fe<this.begin)return qe.possiblyEvaluate(F,Ae,Oe);{const pt=(Fe-this.begin)/(this.end-this.begin);return this.property.interpolate(qe.possiblyEvaluate(F,Ae,Oe),Ve,W(pt))}}return Ve}}class Fa{constructor(F){this._properties=F,this._values=Object.create(F.defaultTransitioningPropertyValues)}possiblyEvaluate(F,Ae,Oe){const Fe=new Ua(this._properties);for(const Ve of Object.keys(this._values))Fe._values[Ve]=this._values[Ve].possiblyEvaluate(F,Ae,Oe);return Fe}hasTransition(){for(const F of Object.keys(this._values))if(this._values[F].prior)return!0;return!1}}class Oa{constructor(F,Ae,Oe){this._properties=F,this._values=Object.create(F.defaultPropertyValues),this._scope=Ae,this._options=Oe,this.configDependencies=new Set}getValue(F){return ht(this._values[F].value)}setValue(F,Ae){this._values[F]=new Va(this._values[F].property,null===Ae?void 0:ht(Ae),this._scope,this._options),this._values[F].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[F].expression.configDependencies]))}serialize(){const F={};for(const Ae of Object.keys(this._values)){const Oe=this.getValue(Ae);void 0!==Oe&&(F[Ae]=Oe)}return F}possiblyEvaluate(F,Ae,Oe){const Fe=new Ua(this._properties);for(const Ve of Object.keys(this._values))Fe._values[Ve]=this._values[Ve].possiblyEvaluate(F,Ae,Oe);return Fe}}class Na{constructor(F,Ae,Oe){this.property=F,this.value=Ae,this.parameters=Oe}isConstant(){return"constant"===this.value.kind}constantOr(F){return"constant"===this.value.kind?this.value.value:F}evaluate(F,Ae,Oe,Fe){return this.property.evaluate(this.value,this.parameters,F,Ae,Oe,Fe)}}class Ua{constructor(F){this._properties=F,this._values=Object.create(F.defaultPossiblyEvaluatedValues)}get(F){return this._values[F]}}class ja{constructor(F){this.specification=F}possiblyEvaluate(F,Ae){return F.expression.evaluate(Ae)}interpolate(F,Ae,Oe){const Fe=Uu[this.specification.type];return Fe?Fe(F,Ae,Oe):F}}class qa{constructor(F,Ae){this.specification=F,this.overrides=Ae}possiblyEvaluate(F,Ae,Oe,Fe){return new Na(this,"constant"===F.expression.kind||"camera"===F.expression.kind?{kind:"constant",value:F.expression.evaluate(Ae,null,{},Oe,Fe)}:F.expression,Ae)}interpolate(F,Ae,Oe){if("constant"!==F.value.kind||"constant"!==Ae.value.kind)return F;if(void 0===F.value.value||void 0===Ae.value.value)return new Na(this,{kind:"constant",value:void 0},F.parameters);const Fe=Uu[this.specification.type];return Fe?new Na(this,{kind:"constant",value:Fe(F.value.value,Ae.value.value,Oe)},F.parameters):F}evaluate(F,Ae,Oe,Fe,Ve,qe){return"constant"===F.kind?F.value:F.evaluate(Ae,Oe,Fe,Ve,qe)}}class $a{constructor(F){this.specification=F}possiblyEvaluate(F,Ae,Oe,Fe){return!!F.expression.evaluate(Ae,null,{},Oe,Fe)}interpolate(){return!1}}class Ga{constructor(F){this.properties=F,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const Ae=new Ca(0,{});for(const Oe in F){const Fe=F[Oe];Fe.specification.overridable&&this.overridableProperties.push(Oe);const Ve=this.defaultPropertyValues[Oe]=new Va(Fe,void 0),qe=this.defaultTransitionablePropertyValues[Oe]=new Da(Fe);this.defaultTransitioningPropertyValues[Oe]=qe.untransitioned(),this.defaultPossiblyEvaluatedValues[Oe]=Ve.possiblyEvaluate(Ae)}}}oa(qa,"DataDrivenProperty"),oa(ja,"DataConstantProperty"),oa($a,"ColorRampProperty");var pf=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow","experimental":true},"rain":{"type":"rain","experimental":true},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor","experimental":true},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"metadata":{"experimental":true,"type":"*"},"selectors":{"experimental":true,"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"experimental":true,"type":"string","required":true},"properties":{"experimental":true,"type":"selectorProperty","required":false},"featureNamespace":{"experimental":true,"type":"string","required":false},"_uniqueFeatureID":{"experimental":true,"type":"boolean","private":true,"required":false}},"selectorProperty":{"experimental":true,"*":{"experimental":true,"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-quality":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]},"experimental":true},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant"},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","experimental":true,"private":true,"expression":{},"property-type":"data-constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"line-cross-slope":{"type":"number","experimental":true,"expression":{},"property-type":"constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","experimental":true,"private":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.4,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","property-type":"data-constant","default":0.71,"minimum":0,"maximum":5,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.57,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","property-type":"data-constant","default":0.7,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}},"buildingFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"flat","property-type":"data-constant"},"fill-extrusion-base-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"terrain","property-type":"data-constant"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"experimental":true,"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"*"}}}');function Xa(F){return F instanceof Number||F instanceof String||F instanceof Boolean?F.valueOf():F}function Za(F){if(Array.isArray(F))return F.map(Za);if(F instanceof Object&&!(F instanceof Number||F instanceof String||F instanceof Boolean)){const Ae={};for(const Oe in F)Ae[Oe]=Za(F[Oe]);return Ae}return Xa(F)}function Ha(F){if(!0===F||!1===F)return!0;if(!Array.isArray(F)||0===F.length)return!1;switch(F[0]){case"has":return F.length>=2&&"$id"!==F[1]&&"$type"!==F[1];case"in":return F.length>=3&&("string"!=typeof F[1]||Array.isArray(F[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==F.length||Array.isArray(F[1])||Array.isArray(F[2]);case"any":case"all":for(const Ae of F.slice(1))if(!Ha(Ae)&&"boolean"!=typeof Ae)return!1;return!0;default:return!0}}function Wa(F,Ae="",Oe=null,Fe="fill"){if(null==F)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Ha(F)||(F=ns(F));const Ve=F;let qe=!0;try{qe=function(F){if(!Qa(F))return F;let Ae=Za(F);return Ja(Ae),Ae=Ka(Ae),Ae}(Ve)}catch(F){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(Ve,null,2)}\n        `)}let pt=null,vt=null;if("background"!==Fe&&"sky"!==Fe&&"slot"!==Fe){vt=pf[`filter_${Fe}`];const F=Wi(qe,vt,Ae,Oe);if("error"===F.result)throw new Error(F.value.map((F=>`${F.key}: ${F.message}`)).join(", "));pt=(Ae,Oe,Fe)=>F.value.evaluate(Ae,Oe,{},Fe)}let zt=null,ri=null;if(qe!==Ve){const F=Wi(Ve,vt,Ae,Oe);if("error"===F.result)throw new Error(F.value.map((F=>`${F.key}: ${F.message}`)).join(", "));zt=(Ae,Oe,Fe,Ve,qe)=>F.value.evaluate(Ae,Oe,{},Fe,void 0,void 0,Ve,qe),ri=!Tn(F.value.expression)}return{filter:pt,dynamicFilter:zt||void 0,needGeometry:rs(qe),needFeature:!!ri}}function Ka(F){if(!Array.isArray(F))return F;const Ae=function(F){if(ff.has(F[0]))for(let Ae=1;Ae<F.length;Ae++)if(Qa(F[Ae]))return!0;return F}(F);return!0===Ae?Ae:Ae.map((F=>Ka(F)))}function Ja(F){let Ae=!1;const Oe=[];if("case"===F[0]){for(let Fe=1;Fe<F.length-1;Fe+=2)Ae=Ae||Qa(F[Fe]),Oe.push(F[Fe+1]);Oe.push(F[F.length-1])}else if("match"===F[0]){Ae=Ae||Qa(F[1]);for(let Ae=2;Ae<F.length-1;Ae+=2)Oe.push(F[Ae+1]);Oe.push(F[F.length-1])}else if("step"===F[0]){Ae=Ae||Qa(F[1]);for(let Ae=1;Ae<F.length-1;Ae+=2)Oe.push(F[Ae+1])}Ae&&(F.length=0,F.push("any",...Oe));for(let Ae=1;Ae<F.length;Ae++)Ja(F[Ae])}function Qa(F){if(!Array.isArray(F))return!1;if("pitch"===(Ae=F[0])||"distance-from-center"===Ae)return!0;var Ae;for(let Ae=1;Ae<F.length;Ae++)if(Qa(F[Ae]))return!0;return!1}const ff=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function es(F,Ae){return F<Ae?-1:F>Ae?1:0}function rs(F){if(!Array.isArray(F))return!1;if("within"===F[0]||"distance"===F[0])return!0;for(let Ae=1;Ae<F.length;Ae++)if(rs(F[Ae]))return!0;return!1}function ns(F){if(!F)return!0;const Ae=F[0];return F.length<=1?"any"!==Ae:"=="===Ae?is(F[1],F[2],"=="):"!="===Ae?os(is(F[1],F[2],"==")):"<"===Ae||">"===Ae||"<="===Ae||">="===Ae?is(F[1],F[2],Ae):"any"===Ae?(Oe=F.slice(1),["any"].concat(Oe.map(ns))):"all"===Ae?["all"].concat(F.slice(1).map(ns)):"none"===Ae?["all"].concat(F.slice(1).map(ns).map(os)):"in"===Ae?as(F[1],F.slice(2)):"!in"===Ae?os(as(F[1],F.slice(2))):"has"===Ae?ss(F[1]):"!has"!==Ae||os(ss(F[1]));var Oe}function is(F,Ae,Oe){switch(F){case"$type":return[`filter-type-${Oe}`,Ae];case"$id":return[`filter-id-${Oe}`,Ae];default:return[`filter-${Oe}`,F,Ae]}}function as(F,Ae){if(0===Ae.length)return!1;switch(F){case"$type":return["filter-type-in",["literal",Ae]];case"$id":return["filter-id-in",["literal",Ae]];default:return Ae.length>200&&!Ae.some((F=>typeof F!=typeof Ae[0]))?["filter-in-large",F,["literal",Ae.sort(es)]]:["filter-in-small",F,["literal",Ae]]}}function ss(F){switch(F){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",F]}}function os(F){return["!",F]}const gf="";function us(F,Ae){return Ae?`${F}${gf}${Ae}`:F}const xf="-transition",wf=new Set(["fill","line","background","hillshade","raster"]);class ps extends we{constructor(F,Ae,Oe,Fe,Ve){if(super(),this.id=F.id,this.fqid=us(this.id,Oe),this.type=F.type,this.scope=Oe,this.lut=Fe,this.options=Ve,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,"custom"!==F.type){if(this.metadata=F.metadata,this.minzoom=F.minzoom,this.maxzoom=F.maxzoom,F.type&&"background"!==F.type&&"sky"!==F.type&&"slot"!==F.type){this.source=F.source,this.sourceLayer=F["source-layer"],this.filter=F.filter;const Ae=Wi(this.filter,pf[`filter_${F.type}`]);"error"!==Ae.result&&(this.configDependencies=new Set([...this.configDependencies,...Ae.value.configDependencies]))}if(F.slot&&(this.slot=F.slot),Ae.layout&&(this._unevaluatedLayout=new Oa(Ae.layout,this.scope,Ve),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),Ae.paint){this._transitionablePaint=new La(Ae.paint,this.scope,Ve);for(const Ae in F.paint)this.setPaintProperty(Ae,F.paint[Ae]);for(const Ae in F.layout)this.setLayoutProperty(Ae,F.layout[Ae]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ua(Ae.paint)}}}onAdd(F){}onRemove(F){}isDraped(F){return!this.is3D()&&wf.has(this.type)}getLayoutProperty(F){return"visibility"===F?this.visibility:this._unevaluatedLayout.getValue(F)}setLayoutProperty(F,Ae){if("custom"===this.type&&"visibility"===F)return void(this.visibility=Ae);const Oe=this._unevaluatedLayout;Oe._properties.properties[F]&&(Oe.setValue(F,Ae),this.configDependencies=new Set([...this.configDependencies,...Oe.configDependencies]),"visibility"===F&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(F){return lt(F,xf)?this._transitionablePaint.getTransition(F.slice(0,-11)):this._transitionablePaint.getValue(F)}setPaintProperty(F,Ae){const Oe=this._transitionablePaint,Fe=Oe._properties.properties;if(lt(F,xf)){const Ve=F.slice(0,-11);return Fe[Ve]&&Oe.setTransition(Ve,Ae||void 0),!1}if(!Fe[F])return!1;const Ve=Oe._values[F],qe=Ve.value.isDataDriven(),pt=Ve.value;Oe.setValue(F,Ae),this.configDependencies=new Set([...this.configDependencies,...Oe.configDependencies]),this._handleSpecialPaintPropertyUpdate(F);const vt=Oe._values[F].value,zt=vt.isDataDriven(),ri=lt(F,"pattern")||"line-dasharray"===F;return zt||qe||ri||this._handleOverridablePaintPropertyUpdate(F,pt,vt)}_handleSpecialPaintPropertyUpdate(F){}getProgramIds(){return null}getDefaultProgramParams(F,Ae,Oe){return null}_handleOverridablePaintPropertyUpdate(F,Ae,Oe){return!1}isHidden(F){return!!(this.minzoom&&F<this.minzoom)||!!(this.maxzoom&&F>=this.maxzoom)||"none"===this.visibility}updateTransitions(F){this._transitioningPaint=this._transitionablePaint.transitioned(F,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(F,Ae){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(F,void 0,Ae)),this.paint=this._transitioningPaint.possiblyEvaluate(F,void 0,Ae)}serialize(){return ct({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},((F,Ae)=>!(void 0===F||"layout"===Ae&&!Object.keys(F).length||"paint"===Ae&&!Object.keys(F).length)))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const F in this.paint._values){const Ae=this.paint.get(F);if(Ae instanceof Na&&Li(Ae.property.specification)&&("source"===Ae.value.kind||"composite"===Ae.value.kind)&&Ae.value.isStateDependent)return!0}return!1}compileFilter(F){this._filterCompiled||(this._featureFilter=Wa(this.filter,this.scope,F),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(F){this._stats&&("shadow"===F.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(F){}queryIntersectsFeature(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){}}const Mf={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class ds{constructor(F,Ae){this._structArray=F,this._pos1=Ae*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class ms{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(F,Ae){return F._trim(),Ae&&(F.isTransferred=!0,Ae.add(F.arrayBuffer)),{length:F.length,arrayBuffer:F.arrayBuffer}}static deserialize(F){const Ae=Object.create(this.prototype);return Ae.arrayBuffer=F.arrayBuffer,Ae.length=F.length,Ae.capacity=F.arrayBuffer.byteLength/Ae.bytesPerElement,Ae._refreshViews(),Ae}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(F){this.reserve(F),this.length=F}reserve(F){if(F>this.capacity){this.capacity=Math.max(F,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const Ae=this.uint8;this._refreshViews(),Ae&&this.uint8.set(Ae)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...F){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...F){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function ys(F,Ae=1){let Oe=0,Fe=0;return{members:F.map((F=>{const Ve=Mf[F.type].BYTES_PER_ELEMENT,qe=Oe=gs(Oe,Math.max(Ae,Ve)),pt=F.components||1;return Fe=Math.max(Fe,Ve),Oe+=Ve*pt,{name:F.name,type:F.type,components:pt,offset:qe}})),size:gs(Oe,Math.max(Fe,Ae)),alignment:Ae}}function gs(F,Ae){return Math.ceil(F/Ae)*Ae}class xs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Ae){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Ae)}emplace(F,Ae,Oe){const Fe=2*F;return this.int16[Fe+0]=Ae,this.int16[Fe+1]=Oe,F}}xs.prototype.bytesPerElement=4,oa(xs,"StructArrayLayout2i4");class vs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Ae,Oe)}emplace(F,Ae,Oe,Fe){const Ve=3*F;return this.int16[Ve+0]=Ae,this.int16[Ve+1]=Oe,this.int16[Ve+2]=Fe,F}}vs.prototype.bytesPerElement=6,oa(vs,"StructArrayLayout3i6");class bs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe){const Ve=this.length;return this.resize(Ve+1),this.emplace(Ve,F,Ae,Oe,Fe)}emplace(F,Ae,Oe,Fe,Ve){const qe=4*F;return this.int16[qe+0]=Ae,this.int16[qe+1]=Oe,this.int16[qe+2]=Fe,this.int16[qe+3]=Ve,F}}bs.prototype.bytesPerElement=8,oa(bs,"StructArrayLayout4i8");class _s extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Ae,Oe,Fe,Ve)}emplace(F,Ae,Oe,Fe,Ve,qe){const pt=5*F;return this.int16[pt+0]=Ae,this.int16[pt+1]=Oe,this.int16[pt+2]=Fe,this.int16[pt+3]=Ve,this.int16[pt+4]=qe,F}}_s.prototype.bytesPerElement=10,oa(_s,"StructArrayLayout5i10");class ws extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt){const vt=this.length;return this.resize(vt+1),this.emplace(vt,F,Ae,Oe,Fe,Ve,qe,pt)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=6*F,ri=12*F,xi=3*F;return this.int16[zt+0]=Ae,this.int16[zt+1]=Oe,this.uint8[ri+4]=Fe,this.uint8[ri+5]=Ve,this.uint8[ri+6]=qe,this.uint8[ri+7]=pt,this.float32[xi+2]=vt,F}}ws.prototype.bytesPerElement=12,oa(ws,"StructArrayLayout2i4ub1f12");class Ms extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Ae,Oe)}emplace(F,Ae,Oe,Fe){const Ve=3*F;return this.float32[Ve+0]=Ae,this.float32[Ve+1]=Oe,this.float32[Ve+2]=Fe,F}}Ms.prototype.bytesPerElement=12,oa(Ms,"StructArrayLayout3f12");class As extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Ae,Oe,Fe,Ve)}emplace(F,Ae,Oe,Fe,Ve,qe){const pt=6*F,vt=3*F;return this.uint16[pt+0]=Ae,this.uint16[pt+1]=Oe,this.uint16[pt+2]=Fe,this.uint16[pt+3]=Ve,this.float32[vt+2]=qe,F}}As.prototype.bytesPerElement=12,oa(As,"StructArrayLayout4ui1f12");class Ss extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe){const Ve=this.length;return this.resize(Ve+1),this.emplace(Ve,F,Ae,Oe,Fe)}emplace(F,Ae,Oe,Fe,Ve){const qe=4*F;return this.uint16[qe+0]=Ae,this.uint16[qe+1]=Oe,this.uint16[qe+2]=Fe,this.uint16[qe+3]=Ve,F}}Ss.prototype.bytesPerElement=8,oa(Ss,"StructArrayLayout4ui8");class Is extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe){const pt=this.length;return this.resize(pt+1),this.emplace(pt,F,Ae,Oe,Fe,Ve,qe)}emplace(F,Ae,Oe,Fe,Ve,qe,pt){const vt=6*F;return this.int16[vt+0]=Ae,this.int16[vt+1]=Oe,this.int16[vt+2]=Fe,this.int16[vt+3]=Ve,this.int16[vt+4]=qe,this.int16[vt+5]=pt,F}}Is.prototype.bytesPerElement=12,oa(Is,"StructArrayLayout6i12");class Ps extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi){const wi=this.length;return this.resize(wi+1),this.emplace(wi,F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi){const dr=12*F;return this.int16[dr+0]=Ae,this.int16[dr+1]=Oe,this.int16[dr+2]=Fe,this.int16[dr+3]=Ve,this.uint16[dr+4]=qe,this.uint16[dr+5]=pt,this.uint16[dr+6]=vt,this.uint16[dr+7]=zt,this.int16[dr+8]=ri,this.int16[dr+9]=xi,this.int16[dr+10]=bi,this.int16[dr+11]=wi,F}}Ps.prototype.bytesPerElement=24,oa(Ps,"StructArrayLayout4i4ui4i24");class zs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe){const pt=this.length;return this.resize(pt+1),this.emplace(pt,F,Ae,Oe,Fe,Ve,qe)}emplace(F,Ae,Oe,Fe,Ve,qe,pt){const vt=10*F,zt=5*F;return this.int16[vt+0]=Ae,this.int16[vt+1]=Oe,this.int16[vt+2]=Fe,this.float32[zt+2]=Ve,this.float32[zt+3]=qe,this.float32[zt+4]=pt,F}}zs.prototype.bytesPerElement=20,oa(zs,"StructArrayLayout3i3f20");class Es extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe){const Ve=this.length;return this.resize(Ve+1),this.emplace(Ve,F,Ae,Oe,Fe)}emplace(F,Ae,Oe,Fe,Ve){const qe=4*F;return this.float32[qe+0]=Ae,this.float32[qe+1]=Oe,this.float32[qe+2]=Fe,this.float32[qe+3]=Ve,F}}Es.prototype.bytesPerElement=16,oa(Es,"StructArrayLayout4f16");class ks extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,F)}emplace(F,Ae){return this.uint32[1*F+0]=Ae,F}}ks.prototype.bytesPerElement=4,oa(ks,"StructArrayLayout1ul4");class Ts extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Ae){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Ae)}emplace(F,Ae,Oe){const Fe=2*F;return this.uint16[Fe+0]=Ae,this.uint16[Fe+1]=Oe,F}}Ts.prototype.bytesPerElement=4,oa(Ts,"StructArrayLayout2ui4");class Bs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi){const dr=this.length;return this.resize(dr+1),this.emplace(dr,F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr){const jr=20*F,Qr=10*F;return this.int16[jr+0]=Ae,this.int16[jr+1]=Oe,this.int16[jr+2]=Fe,this.int16[jr+3]=Ve,this.int16[jr+4]=qe,this.float32[Qr+3]=pt,this.float32[Qr+4]=vt,this.float32[Qr+5]=zt,this.float32[Qr+6]=ri,this.int16[jr+14]=xi,this.uint32[Qr+8]=bi,this.uint16[jr+18]=wi,this.uint16[jr+19]=dr,F}}Bs.prototype.bytesPerElement=40,oa(Bs,"StructArrayLayout5i4f1i1ul2ui40");class Cs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt){const vt=this.length;return this.resize(vt+1),this.emplace(vt,F,Ae,Oe,Fe,Ve,qe,pt)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=8*F;return this.int16[zt+0]=Ae,this.int16[zt+1]=Oe,this.int16[zt+2]=Fe,this.int16[zt+4]=Ve,this.int16[zt+5]=qe,this.int16[zt+6]=pt,this.int16[zt+7]=vt,F}}Cs.prototype.bytesPerElement=16,oa(Cs,"StructArrayLayout3i2i2i16");class Vs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Ae,Oe,Fe,Ve)}emplace(F,Ae,Oe,Fe,Ve,qe){const pt=4*F,vt=8*F;return this.float32[pt+0]=Ae,this.float32[pt+1]=Oe,this.float32[pt+2]=Fe,this.int16[vt+6]=Ve,this.int16[vt+7]=qe,F}}Vs.prototype.bytesPerElement=16,oa(Vs,"StructArrayLayout2f1f2i16");class Ds extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe){const pt=this.length;return this.resize(pt+1),this.emplace(pt,F,Ae,Oe,Fe,Ve,qe)}emplace(F,Ae,Oe,Fe,Ve,qe,pt){const vt=20*F,zt=5*F;return this.uint8[vt+0]=Ae,this.uint8[vt+1]=Oe,this.float32[zt+1]=Fe,this.float32[zt+2]=Ve,this.float32[zt+3]=qe,this.float32[zt+4]=pt,F}}Ds.prototype.bytesPerElement=20,oa(Ds,"StructArrayLayout2ub4f20");class Ls extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Ae,Oe)}emplace(F,Ae,Oe,Fe){const Ve=3*F;return this.uint16[Ve+0]=Ae,this.uint16[Ve+1]=Oe,this.uint16[Ve+2]=Fe,F}}Ls.prototype.bytesPerElement=6,oa(Ls,"StructArrayLayout3ui6");class Rs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko){const Uo=this.length;return this.resize(Uo+1),this.emplace(Uo,F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko,Uo){const ia=30*F,_a=15*F,Ma=60*F;return this.int16[ia+0]=Ae,this.int16[ia+1]=Oe,this.int16[ia+2]=Fe,this.float32[_a+2]=Ve,this.float32[_a+3]=qe,this.uint16[ia+8]=pt,this.uint16[ia+9]=vt,this.uint32[_a+5]=zt,this.uint32[_a+6]=ri,this.uint32[_a+7]=xi,this.uint16[ia+16]=bi,this.uint16[ia+17]=wi,this.uint16[ia+18]=dr,this.float32[_a+10]=jr,this.float32[_a+11]=Qr,this.uint8[Ma+48]=Xn,this.uint8[Ma+49]=ho,this.uint8[Ma+50]=yo,this.uint32[_a+13]=zo,this.int16[ia+28]=ko,this.uint8[Ma+58]=Uo,F}}Rs.prototype.bytesPerElement=60,oa(Rs,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Fs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko,Uo,ia,_a,Ma,Ea,Ia,rl,Sl,Il,Kl,Jl){const Ql=this.length;return this.resize(Ql+1),this.emplace(Ql,F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko,Uo,ia,_a,Ma,Ea,Ia,rl,Sl,Il,Kl,Jl)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko,Uo,ia,_a,Ma,Ea,Ia,rl,Sl,Il,Kl,Jl,Ql){const ec=20*F,tc=40*F,cc=80*F;return this.float32[ec+0]=Ae,this.float32[ec+1]=Oe,this.int16[tc+4]=Fe,this.int16[tc+5]=Ve,this.int16[tc+6]=qe,this.int16[tc+7]=pt,this.int16[tc+8]=vt,this.int16[tc+9]=zt,this.int16[tc+10]=ri,this.int16[tc+11]=xi,this.int16[tc+12]=bi,this.uint16[tc+13]=wi,this.uint16[tc+14]=dr,this.uint16[tc+15]=jr,this.uint16[tc+16]=Qr,this.uint16[tc+17]=Xn,this.uint16[tc+18]=ho,this.uint16[tc+19]=yo,this.uint16[tc+20]=zo,this.uint16[tc+21]=ko,this.uint16[tc+22]=Uo,this.uint16[tc+23]=ia,this.uint16[tc+24]=_a,this.uint16[tc+25]=Ma,this.uint16[tc+26]=Ea,this.uint16[tc+27]=Ia,this.uint32[ec+14]=rl,this.float32[ec+15]=Sl,this.float32[ec+16]=Il,this.float32[ec+17]=Kl,this.float32[ec+18]=Jl,this.uint8[cc+76]=Ql,F}}Fs.prototype.bytesPerElement=80,oa(Fs,"StructArrayLayout2f9i15ui1ul4f1ub80");class Os extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,F)}emplace(F,Ae){return this.float32[1*F+0]=Ae,F}}Os.prototype.bytesPerElement=4,oa(Os,"StructArrayLayout1f4");class Ns extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Ae,Oe,Fe,Ve)}emplace(F,Ae,Oe,Fe,Ve,qe){const pt=5*F;return this.float32[pt+0]=Ae,this.float32[pt+1]=Oe,this.float32[pt+2]=Fe,this.float32[pt+3]=Ve,this.float32[pt+4]=qe,F}}Ns.prototype.bytesPerElement=20,oa(Ns,"StructArrayLayout5f20");class Us extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt){const vt=this.length;return this.resize(vt+1),this.emplace(vt,F,Ae,Oe,Fe,Ve,qe,pt)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=7*F;return this.float32[zt+0]=Ae,this.float32[zt+1]=Oe,this.float32[zt+2]=Fe,this.float32[zt+3]=Ve,this.float32[zt+4]=qe,this.float32[zt+5]=pt,this.float32[zt+6]=vt,F}}Us.prototype.bytesPerElement=28,oa(Us,"StructArrayLayout7f28");class js extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi){const bi=this.length;return this.resize(bi+1),this.emplace(bi,F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi){const wi=11*F;return this.float32[wi+0]=Ae,this.float32[wi+1]=Oe,this.float32[wi+2]=Fe,this.float32[wi+3]=Ve,this.float32[wi+4]=qe,this.float32[wi+5]=pt,this.float32[wi+6]=vt,this.float32[wi+7]=zt,this.float32[wi+8]=ri,this.float32[wi+9]=xi,this.float32[wi+10]=bi,F}}js.prototype.bytesPerElement=44,oa(js,"StructArrayLayout11f44");class qs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri=this.length;return this.resize(ri+1),this.emplace(ri,F,Ae,Oe,Fe,Ve,qe,pt,vt,zt)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri){const xi=9*F;return this.float32[xi+0]=Ae,this.float32[xi+1]=Oe,this.float32[xi+2]=Fe,this.float32[xi+3]=Ve,this.float32[xi+4]=qe,this.float32[xi+5]=pt,this.float32[xi+6]=vt,this.float32[xi+7]=zt,this.float32[xi+8]=ri,F}}qs.prototype.bytesPerElement=36,oa(qs,"StructArrayLayout9f36");class $s extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Ae)}emplace(F,Ae,Oe){const Fe=2*F;return this.float32[Fe+0]=Ae,this.float32[Fe+1]=Oe,F}}$s.prototype.bytesPerElement=8,oa($s,"StructArrayLayout2f8");class Gs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe){const Ve=this.length;return this.resize(Ve+1),this.emplace(Ve,F,Ae,Oe,Fe)}emplace(F,Ae,Oe,Fe,Ve){const qe=6*F;return this.uint32[3*F+0]=Ae,this.uint16[qe+2]=Oe,this.uint16[qe+3]=Fe,this.uint16[qe+4]=Ve,F}}Gs.prototype.bytesPerElement=12,oa(Gs,"StructArrayLayout1ul3ui12");class Ys extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,F)}emplace(F,Ae){return this.uint16[1*F+0]=Ae,F}}Ys.prototype.bytesPerElement=2,oa(Ys,"StructArrayLayout1ui2");class Xs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr){const Xn=this.length;return this.resize(Xn+1),this.emplace(Xn,F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn){const ho=16*F;return this.float32[ho+0]=Ae,this.float32[ho+1]=Oe,this.float32[ho+2]=Fe,this.float32[ho+3]=Ve,this.float32[ho+4]=qe,this.float32[ho+5]=pt,this.float32[ho+6]=vt,this.float32[ho+7]=zt,this.float32[ho+8]=ri,this.float32[ho+9]=xi,this.float32[ho+10]=bi,this.float32[ho+11]=wi,this.float32[ho+12]=dr,this.float32[ho+13]=jr,this.float32[ho+14]=Qr,this.float32[ho+15]=Xn,F}}Xs.prototype.bytesPerElement=64,oa(Xs,"StructArrayLayout16f64");class Zs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Ae,Oe,Fe,Ve,qe,pt){const vt=this.length;return this.resize(vt+1),this.emplace(vt,F,Ae,Oe,Fe,Ve,qe,pt)}emplace(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=10*F,ri=5*F;return this.uint16[zt+0]=Ae,this.uint16[zt+1]=Oe,this.uint16[zt+2]=Fe,this.uint16[zt+3]=Ve,this.float32[ri+2]=qe,this.float32[ri+3]=pt,this.float32[ri+4]=vt,F}}Zs.prototype.bytesPerElement=20,oa(Zs,"StructArrayLayout4ui3f20");class Hs extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,F)}emplace(F,Ae){return this.int16[1*F+0]=Ae,F}}Hs.prototype.bytesPerElement=2,oa(Hs,"StructArrayLayout1i2");class Ws extends ms{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(F){const Ae=this.length;return this.resize(Ae+1),this.emplace(Ae,F)}emplace(F,Ae){return this.uint8[1*F+0]=Ae,F}}Ws.prototype.bytesPerElement=1,oa(Ws,"StructArrayLayout1ub1");class Ks extends ds{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}Ks.prototype.size=40;class Js extends Bs{get(F){return new Ks(this,F)}}oa(Js,"CollisionBoxArray");class Qs extends ds{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(F){this._structArray.uint8[this._pos1+49]=F}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(F){this._structArray.uint8[this._pos1+50]=F}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(F){this._structArray.uint32[this._pos4+13]=F}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(F){this._structArray.uint8[this._pos1+58]=F}}Qs.prototype.size=60;class to extends Rs{get(F){return new Qs(this,F)}}oa(to,"PlacedSymbolArray");class eo extends ds{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(F){this._structArray.uint32[this._pos4+14]=F}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(F){this._structArray.float32[this._pos4+18]=F}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}eo.prototype.size=80;class ro extends Fs{get(F){return new eo(this,F)}}oa(ro,"SymbolInstanceArray");class no extends Os{getoffsetX(F){return this.float32[1*F+0]}}oa(no,"GlyphOffsetArray");class io extends xs{getx(F){return this.int16[2*F+0]}gety(F){return this.int16[2*F+1]}}oa(io,"SymbolLineVertexArray");class ao extends ds{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}ao.prototype.size=12;class so extends Gs{get(F){return new ao(this,F)}}oa(so,"FeatureIndexArray");class oo extends Ts{geta_centroid_pos0(F){return this.uint16[2*F+0]}geta_centroid_pos1(F){return this.uint16[2*F+1]}}oa(oo,"FillExtrusionCentroidArray");class lo extends ds{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}lo.prototype.size=6;class uo extends vs{get(F){return new lo(this,F)}}oa(uo,"FillExtrusionWallArray");const qf=ys([{name:"a_pos",components:2,type:"Int16"}],4),Hf=ys([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class po{constructor(F=[]){this.segments=F}_prepareSegment(F,Ae,Oe,Fe){let Ve=this.segments[this.segments.length-1];return F>po.MAX_VERTEX_ARRAY_LENGTH&&ft(`Max vertices per segment is ${po.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${F}`),(!Ve||Ve.vertexLength+F>po.MAX_VERTEX_ARRAY_LENGTH||Ve.sortKey!==Fe)&&(Ve={vertexOffset:Ae,primitiveOffset:Oe,vertexLength:0,primitiveLength:0},void 0!==Fe&&(Ve.sortKey=Fe),this.segments.push(Ve)),Ve}prepareSegment(F,Ae,Oe,Fe){return this._prepareSegment(F,Ae.length,Oe.length,Fe)}get(){return this.segments}destroy(){for(const F of this.segments)for(const Ae in F.vaos)F.vaos[Ae].destroy()}static simpleSegment(F,Ae,Oe,Fe){return new po([{vertexOffset:F,primitiveOffset:Ae,vertexLength:Oe,primitiveLength:Fe,vaos:{},sortKey:0}])}}function fo(F,Ae){return 256*(F=Q(Math.floor(F),0,255))+Q(Math.floor(Ae),0,255)}po.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,oa(po,"SegmentVector");const Wf=ys([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),Yf=ys([{name:"a_dash",components:4,type:"Uint16"}]);class go{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(F,Ae,Oe,Fe){this.ids.push(xo(F)),this.positions.push(Ae,Oe,Fe)}eachPosition(F,Ae){const Oe=xo(F);let Fe=0,Ve=this.ids.length-1;for(;Fe<Ve;){const F=Fe+Ve>>1;this.ids[F]>=Oe?Ve=F:Fe=F+1}for(;this.ids[Fe]===Oe;)Ae(this.positions[3*Fe],this.positions[3*Fe+1],this.positions[3*Fe+2]),Fe++}static serialize(F,Ae){const Oe=new Float64Array(F.ids),Fe=new Uint32Array(F.positions);return vo(Oe,Fe,0,Oe.length-1),Ae&&(Ae.add(Oe.buffer),Ae.add(Fe.buffer)),{ids:Oe,positions:Fe}}static deserialize(F){const Ae=new go;let Oe;Ae.ids=F.ids,Ae.positions=F.positions;for(const F of Ae.ids)F!==Oe&&Ae.uniqueIds.push(F),Oe=F;return Ae.indexed=!0,Ae}}function xo(F){const Ae=+F;return!isNaN(Ae)&&Number.MIN_SAFE_INTEGER<=Ae&&Ae<=Number.MAX_SAFE_INTEGER?Ae:cu(String(F))}function vo(F,Ae,Oe,Fe){for(;Oe<Fe;){const Ve=F[Oe+Fe>>1];let qe=Oe-1,pt=Fe+1;for(;;){do{qe++}while(F[qe]<Ve);do{pt--}while(F[pt]>Ve);if(qe>=pt)break;bo(F,qe,pt),bo(Ae,3*qe,3*pt),bo(Ae,3*qe+1,3*pt+1),bo(Ae,3*qe+2,3*pt+2)}pt-Oe<Fe-pt?(vo(F,Ae,Oe,pt),Oe=pt+1):(vo(F,Ae,pt+1,Fe),Fe=pt)}}function bo(F,Ae,Oe){const Fe=F[Ae];F[Ae]=F[Oe],F[Oe]=Fe}oa(go,"FeaturePositionMap");class _o{constructor(F){this.gl=F.gl,this.initialized=!1}fetchUniformLocation(F,Ae){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(F,Ae),this.initialized=!0),!!this.location}set(F,Ae,Oe){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class wo extends _o{constructor(F){super(F),this.current=0}set(F,Ae,Oe){this.fetchUniformLocation(F,Ae)&&this.current!==Oe&&(this.current=Oe,this.gl.uniform1i(this.location,Oe))}}class Mo extends _o{constructor(F){super(F),this.current=0}set(F,Ae,Oe){this.fetchUniformLocation(F,Ae)&&this.current!==Oe&&(this.current=Oe,this.gl.uniform1f(this.location,Oe))}}class Ao extends _o{constructor(F){super(F),this.current=[0,0]}set(F,Ae,Oe){this.fetchUniformLocation(F,Ae)&&(Oe[0]===this.current[0]&&Oe[1]===this.current[1]||(this.current=Oe,this.gl.uniform2f(this.location,Oe[0],Oe[1])))}}class So extends _o{constructor(F){super(F),this.current=[0,0,0]}set(F,Ae,Oe){this.fetchUniformLocation(F,Ae)&&(Oe[0]===this.current[0]&&Oe[1]===this.current[1]&&Oe[2]===this.current[2]||(this.current=Oe,this.gl.uniform3f(this.location,Oe[0],Oe[1],Oe[2])))}}class Io extends _o{constructor(F){super(F),this.current=[0,0,0,0]}set(F,Ae,Oe){this.fetchUniformLocation(F,Ae)&&(Oe[0]===this.current[0]&&Oe[1]===this.current[1]&&Oe[2]===this.current[2]&&Oe[3]===this.current[3]||(this.current=Oe,this.gl.uniform4f(this.location,Oe[0],Oe[1],Oe[2],Oe[3])))}}class Po extends _o{constructor(F){super(F),this.current=Ie.transparent.toRenderColor(null)}set(F,Ae,Oe){this.fetchUniformLocation(F,Ae)&&(Oe.r===this.current.r&&Oe.g===this.current.g&&Oe.b===this.current.b&&Oe.a===this.current.a||(this.current=Oe,this.gl.uniform4f(this.location,Oe.r,Oe.g,Oe.b,Oe.a)))}}const Jf=new Float32Array(16);class Eo extends _o{constructor(F){super(F),this.current=Jf}set(F,Ae,Oe){if(this.fetchUniformLocation(F,Ae)){if(Oe[12]!==this.current[12]||Oe[0]!==this.current[0])return this.current=Oe,void this.gl.uniformMatrix4fv(this.location,!1,Oe);for(let F=1;F<16;F++)if(Oe[F]!==this.current[F]){this.current=Oe,this.gl.uniformMatrix4fv(this.location,!1,Oe);break}}}}const em=new Float32Array(9),rm=new Float32Array(4);class Bo extends _o{constructor(F){super(F),this.current=rm}set(F,Ae,Oe){if(this.fetchUniformLocation(F,Ae))for(let F=0;F<4;F++)if(Oe[F]!==this.current[F]){this.current=Oe,this.gl.uniformMatrix2fv(this.location,!1,Oe);break}}}function Co(F){return[fo(255*F.r,255*F.g),fo(255*F.b,255*F.a)]}class Vo{constructor(F,Ae,Oe,Fe){this.value=F,this.uniformNames=Ae.map((F=>`u_${F}`)),this.type=Oe,this.context=Fe}setUniform(F,Ae,Oe,Fe,Ve){const qe=Fe.constantOr(this.value);Ae.set(F,Ve,qe instanceof Ie?qe.toRenderColor(this.ignoreLut?null:this.context.lut):qe)}getBinding(F,Ae){return"color"===this.type?new Po(F):new Mo(F)}}class Do{constructor(F,Ae){this.uniformNames=Ae.map((F=>`u_${F}`)),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(F){this.pixelRatio=F.pixelRatio||1,this.pattern=F.tl.concat(F.br)}setUniform(F,Ae,Oe,Fe,Ve){const qe="u_pattern"===Ve||"u_dash"===Ve?this.pattern:"u_pixel_ratio"===Ve?this.pixelRatio:null;qe&&Ae.set(F,Ve,qe)}getBinding(F,Ae){return"u_pattern"===Ae||"u_dash"===Ae?new Io(F):new Mo(F)}}class Lo{constructor(F,Ae,Oe,Fe){this.expression=F,this.type=Oe,this.maxValue=0,this.paintVertexAttributes=Ae.map((F=>({name:`a_${F}`,type:"Float32",components:"color"===Oe?2:1,offset:0}))),this.paintVertexArray=new Fe}populatePaintArray(F,Ae,Oe,Fe,Ve,qe,pt){const vt=this.paintVertexArray.length,zt="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate(new Ca(0,{brightness:qe}),Ae,{},Ve,Fe,pt):"constant"===this.expression.kind&&this.expression.value;!this.lutExpression||"composite"!==this.lutExpression.kind&&"source"!==this.lutExpression.kind||(this.ignoreLut="none"===this.lutExpression.evaluate(new Ca(0,{brightness:qe}),Ae,{},Ve,Fe,pt)),this.paintVertexArray.resize(F),this._setPaintValue(vt,F,zt,this.context)}updatePaintArray(F,Ae,Oe,Fe,Ve,qe,pt){const vt="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate({zoom:0,brightness:pt},Oe,Fe,void 0,Ve):"constant"===this.expression.kind&&this.expression.value;!this.lutExpression||"composite"!==this.lutExpression.kind&&"source"!==this.lutExpression.kind||(this.ignoreLut="none"===this.lutExpression.evaluate({zoom:0,brightness:pt},Oe,Fe,void 0,Ve)),this._setPaintValue(F,Ae,vt,this.context)}_setPaintValue(F,Ae,Oe,Fe){if("color"===this.type){const Ve=Co(Oe.toRenderColor(this.ignoreLut?null:Fe.lut));for(let Oe=F;Oe<Ae;Oe++)this.paintVertexArray.emplace(Oe,Ve[0],Ve[1])}else{for(let Fe=F;Fe<Ae;Fe++)this.paintVertexArray.emplace(Fe,Oe);this.maxValue=Math.max(this.maxValue,Math.abs(Oe))}}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&"constant"!==this.lutExpression.kind&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||"constant"!==this.expression.kind&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ro{constructor(F,Ae,Oe,Fe,Ve,qe){this.expression=F,this.uniformNames=Ae.map((F=>`u_${F}_t`)),this.type=Oe,this.useIntegerZoom=Fe,this.context=Ve,this.maxValue=0,this.paintVertexAttributes=Ae.map((F=>({name:`a_${F}`,type:"Float32",components:"color"===Oe?4:2,offset:0}))),this.paintVertexArray=new qe}populatePaintArray(F,Ae,Oe,Fe,Ve,qe,pt){const vt=this.expression.evaluate(new Ca(this.context.zoom,{brightness:qe}),Ae,{},Ve,Fe,pt),zt=this.expression.evaluate(new Ca(this.context.zoom+1,{brightness:qe}),Ae,{},Ve,Fe,pt);!this.lutExpression||"composite"!==this.lutExpression.kind&&"source"!==this.lutExpression.kind||(this.ignoreLut="none"===this.lutExpression.evaluate(new Ca(this.context.zoom,{brightness:qe}),Ae,{},Ve,Fe,pt));const ri=this.paintVertexArray.length;this.paintVertexArray.resize(F),this._setPaintValue(ri,F,vt,zt,this.context)}updatePaintArray(F,Ae,Oe,Fe,Ve,qe,pt){const vt=this.expression.evaluate({zoom:this.context.zoom,brightness:pt},Oe,Fe,void 0,Ve),zt=this.expression.evaluate({zoom:this.context.zoom+1,brightness:pt},Oe,Fe,void 0,Ve);!this.lutExpression||"composite"!==this.lutExpression.kind&&"source"!==this.lutExpression.kind||(this.ignoreLut="none"===this.lutExpression.evaluate({zoom:this.context.zoom,brightness:pt},Oe,Fe,void 0,Ve)),this._setPaintValue(F,Ae,vt,zt,this.context)}_setPaintValue(F,Ae,Oe,Fe,Ve){if("color"===this.type){const Fe=Co(Oe.toRenderColor(this.ignoreLut?null:Ve.lut)),qe=Co(Oe.toRenderColor(this.ignoreLut?null:Ve.lut));for(let Oe=F;Oe<Ae;Oe++)this.paintVertexArray.emplace(Oe,Fe[0],Fe[1],qe[0],qe[1])}else{for(let Ve=F;Ve<Ae;Ve++)this.paintVertexArray.emplace(Ve,Oe,Fe);this.maxValue=Math.max(this.maxValue,Math.abs(Oe),Math.abs(Fe))}}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(F,Ae,Oe,Fe,Ve){const qe=this.useIntegerZoom?Math.floor(Oe.zoom):Oe.zoom,pt=Q(this.expression.interpolationFactor(qe,this.context.zoom,this.context.zoom+1),0,1);Ae.set(F,Ve,pt)}getBinding(F,Ae){return new Mo(F)}}class Fo{constructor(F,Ae,Oe,Fe,Ve){this.expression=F,this.layerId=Ve,this.paintVertexAttributes=("array"===Oe?Yf:Wf).members;for(let F=0;F<Ae.length;++F);this.paintVertexArray=new Fe}populatePaintArray(F,Ae,Oe,Fe){const Ve=this.paintVertexArray.length;this.paintVertexArray.resize(F),this._setPaintValues(Ve,F,Ae.patterns&&Ae.patterns[this.layerId],Oe)}updatePaintArray(F,Ae,Oe,Fe,Ve,qe,pt){this._setPaintValues(F,Ae,Oe.patterns&&Oe.patterns[this.layerId],qe)}_setPaintValues(F,Ae,Oe,Fe){if(!Fe||!Oe)return;const Ve=Fe[Oe];if(!Ve)return;const{tl:qe,br:pt,pixelRatio:vt}=Ve;for(let Oe=F;Oe<Ae;Oe++)this.paintVertexArray.emplace(Oe,qe[0],qe[1],pt[0],pt[1],vt)}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Oo{constructor(F,Ae,Oe=()=>!0){this.binders={},this._buffers=[],this.context=Ae;const Fe=[];for(const Ve in F.paint._values){const qe=F.paint.get(Ve),pt=F.paint.get(`${Ve}-use-theme`);if(Ve.endsWith("-use-theme"))continue;if(!Oe(Ve))continue;if(!(qe instanceof Na&&Li(qe.property.specification)))continue;const vt=jo(Ve,F.type),zt=qe.value,ri=qe.property.specification.type,xi=!!qe.property.useIntegerZoom,bi="line-dasharray"===Ve||Ve.endsWith("pattern"),wi="line-dasharray"===Ve&&"constant"!==F.layout.get("line-cap").value.kind||pt&&"constant"!==pt.value.kind;if("constant"!==zt.kind||wi)if("source"===zt.kind||wi||bi){const Ae=Go(Ve,ri,"source");this.binders[Ve]=bi?new Fo(zt,vt,ri,Ae,F.id):new Lo(zt,vt,ri,Ae),Fe.push(`/a_${Ve}`)}else{const F=Go(Ve,ri,"composite");this.binders[Ve]=new Ro(zt,vt,ri,xi,Ae,F),Fe.push(`/z_${Ve}`)}else this.binders[Ve]=bi?new Do(zt.value,vt):new Vo(zt.value,vt,ri,Ae),Fe.push(`/u_${Ve}`);pt&&(this.binders[Ve].ignoreLut="none"===pt.constantOr("default"),this.binders[Ve].lutExpression=pt.value,this.binders[Ve].checkUseTheme=!0)}this.cacheKey=Fe.sort().join("")}getMaxValue(F){const Ae=this.binders[F];return Ae instanceof Lo||Ae instanceof Ro?Ae.maxValue:0}populatePaintArrays(F,Ae,Oe,Fe,Ve,qe,pt){for(const vt in this.binders){const zt=this.binders[vt];zt.context=this.context,zt instanceof Lo||zt instanceof Ro||zt instanceof Fo?zt.populatePaintArray(F,Ae,Oe,Fe,Ve,qe,pt):zt.lutExpression&&zt instanceof Vo&&zt.lutExpression&&("composite"===zt.lutExpression.kind||"source"===zt.lutExpression.kind)&&(zt.ignoreLut="none"===zt.lutExpression.evaluate(new Ca(0,{brightness:qe}),Ae,{},Ve,Fe,pt))}}setConstantPatternPositions(F){for(const Ae in this.binders){const Oe=this.binders[Ae];Oe instanceof Do&&Oe.setConstantPatternPositions(F)}}updatePaintArrays(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){let ri=!1;const xi=Object.keys(F),bi=0!==xi.length&&!vt,wi=bi?xi:Ae.uniqueIds;this.context.lut=Ve.lut;for(const vt in this.binders){const xi=this.binders[vt];if(xi.context=this.context,(xi instanceof Lo||xi instanceof Ro||xi instanceof Fo)&&xi.expression&&xi.expression.kind&&"constant"!==xi.expression.kind&&(!0===xi.expression.isStateDependent||!1===xi.expression.isLightConstant)){const dr=Ve.paint.get(vt);xi.expression=dr.value;for(const Oe of wi){const Ve=F[Oe.toString()];Ae.eachPosition(Oe,((F,Ae,Oe)=>{const vt=Fe.feature(F);xi.updatePaintArray(Ae,Oe,vt,Ve,qe,pt,zt)}))}if(!bi)for(const Ae of Oe.uniqueIds){const Ve=F[Ae.toString()];Oe.eachPosition(Ae,((F,Ae,Oe)=>{const vt=Fe.feature(F);xi.updatePaintArray(Ae,Oe,vt,Ve,qe,pt,zt)}))}ri=!0}}return ri}defines(){const F=[];for(const Ae in this.binders){const Oe=this.binders[Ae];(Oe instanceof Vo||Oe instanceof Do)&&F.push(...Oe.uniformNames.map((F=>`#define HAS_UNIFORM_${F}`)))}return F}getBinderAttributes(){const F=[];for(const Ae in this.binders){const Oe=this.binders[Ae];if(Oe instanceof Lo||Oe instanceof Ro||Oe instanceof Fo)for(let Ae=0;Ae<Oe.paintVertexAttributes.length;Ae++)F.push(Oe.paintVertexAttributes[Ae].name)}return F}getBinderUniforms(){const F=[];for(const Ae in this.binders){const Oe=this.binders[Ae];if(Oe instanceof Vo||Oe instanceof Do||Oe instanceof Ro)for(const Ae of Oe.uniformNames)F.push(Ae)}return F}getPaintVertexBuffers(){return this._buffers}getUniforms(F){const Ae=[];for(const Oe in this.binders){const Fe=this.binders[Oe];if(Fe instanceof Vo||Fe instanceof Do||Fe instanceof Ro)for(const Ve of Fe.uniformNames)Ae.push({name:Ve,property:Oe,binding:Fe.getBinding(F,Ve)})}return Ae}setUniforms(F,Ae,Oe,Fe,Ve){for(const{name:Ae,property:qe,binding:pt}of Oe){if(this.binders[qe].checkUseTheme&&this.binders[qe]instanceof Vo){const F=Fe.get(`${qe}-use-theme`);F.isConstant()&&(this.binders[qe].ignoreLut="none"===F.constantOr("default"))}this.binders[qe].setUniform(F,pt,Ve,Fe.get(qe),Ae)}}updatePaintBuffers(){this._buffers=[];for(const F in this.binders){const Ae=this.binders[F];(Ae instanceof Lo||Ae instanceof Ro||Ae instanceof Fo)&&Ae.paintVertexBuffer&&this._buffers.push(Ae.paintVertexBuffer)}}upload(F){for(const Ae in this.binders){const Oe=this.binders[Ae];(Oe instanceof Lo||Oe instanceof Ro||Oe instanceof Fo)&&Oe.upload(F)}this.updatePaintBuffers()}destroy(){for(const F in this.binders){const Ae=this.binders[F];(Ae instanceof Lo||Ae instanceof Ro||Ae instanceof Fo)&&Ae.destroy()}}}class No{constructor(F,Ae,Oe=()=>!0){this.programConfigurations={};for(const Fe of F)this.programConfigurations[Fe.id]=new Oo(Fe,Ae,Oe);this.needsUpload=!1,this._featureMap=new go,this._featureMapWithoutIds=new go,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(F,Ae,Oe,Fe,Ve,qe,pt,vt){for(const Oe in this.programConfigurations)this.programConfigurations[Oe].populatePaintArrays(F,Ae,Fe,Ve,qe,pt,vt);void 0!==Ae.id?this._featureMap.add(Ae.id,Oe,this._bufferOffset,F):(this._featureMapWithoutIds.add(this._idlessCounter,Oe,this._bufferOffset,F),this._idlessCounter+=1),this._bufferOffset=F,this.needsUpload=!0}updatePaintArrays(F,Ae,Oe,Fe,Ve,qe,pt){for(const vt of Oe)this.needsUpload=this.programConfigurations[vt.id].updatePaintArrays(F,this._featureMap,this._featureMapWithoutIds,Ae,vt,Fe,Ve,qe,pt||0)||this.needsUpload}get(F){return this.programConfigurations[F]}upload(F){if(this.needsUpload){for(const Ae in this.programConfigurations)this.programConfigurations[Ae].upload(F);this.needsUpload=!1}}destroy(){for(const F in this.programConfigurations)this.programConfigurations[F].destroy()}}const nm={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function jo(F,Ae){return nm[F]||[F.replace(`${Ae}-`,"").replace(/-/g,"_")]}const om={"line-pattern":{source:As,composite:As},"fill-pattern":{source:As,composite:As},"fill-extrusion-pattern":{source:As,composite:As},"line-dasharray":{source:Ss,composite:Ss}},lm={color:{source:$s,composite:Es},number:{source:Os,composite:$s}};function Go(F,Ae,Oe){const Fe=om[F];return Fe&&Fe[Oe]||lm[Ae][Oe]}oa(Vo,"ConstantBinder"),oa(Do,"PatternConstantBinder"),oa(Lo,"SourceExpressionBinder"),oa(Fo,"PatternCompositeBinder"),oa(Ro,"CompositeExpressionBinder"),oa(Oo,"ProgramConfiguration",{omit:["_buffers"]}),oa(No,"ProgramConfigurationSet");const cm=Vd/Math.PI/2,hm=5,um=6,bm=16383,wm=64,Sm=[wm,32,16],Mm=-cm,Im=cm;function tl(F,Ae,Oe,Fe=cm){return Oe=X(Oe),[F*Math.sin(Oe)*Fe,-Ae*Fe,F*Math.cos(Oe)*Fe]}function el(F,Ae,Oe){return tl(Math.cos(X(F)),Math.sin(X(F)),Ae,Oe)}const Am=6371008.8,Cm=2*Math.PI*Am;class il{constructor(F,Ae){if(isNaN(F)||isNaN(Ae))throw new Error(`Invalid LngLat object: (${F}, ${Ae})`);if(this.lng=+F,this.lat=+Ae,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new il(et(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(F){const Ae=Math.PI/180,Oe=this.lat*Ae,Fe=F.lat*Ae,Ve=Math.sin(Oe)*Math.sin(Fe)+Math.cos(Oe)*Math.cos(Fe)*Math.cos((F.lng-this.lng)*Ae);return Am*Math.acos(Math.min(Ve,1))}toBounds(F=0){const Ae=360*F/40075017,Oe=Ae/Math.cos(Math.PI/180*this.lat);return new al({lng:this.lng-Oe,lat:this.lat-Ae},{lng:this.lng+Oe,lat:this.lat+Ae})}toEcef(F){return el(this.lat,this.lng,cm+F*cm/Am)}static convert(F){if(F instanceof il)return F;if(Array.isArray(F)&&(2===F.length||3===F.length))return new il(Number(F[0]),Number(F[1]));if(!Array.isArray(F)&&"object"==typeof F&&null!==F)return new il(Number("lng"in F?F.lng:F.lon),Number(F.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class al{constructor(F,Ae){if(F)if(Ae)this.setSouthWest(F).setNorthEast(Ae);else if(4===F.length){const Ae=F;this.setSouthWest([Ae[0],Ae[1]]).setNorthEast([Ae[2],Ae[3]])}else{const Ae=F;this.setSouthWest(Ae[0]).setNorthEast(Ae[1])}}setNorthEast(F){return this._ne=F instanceof il?new il(F.lng,F.lat):il.convert(F),this}setSouthWest(F){return this._sw=F instanceof il?new il(F.lng,F.lat):il.convert(F),this}extend(F){const Ae=this._sw,Oe=this._ne;let Fe,Ve;if(F instanceof il)Fe=F,Ve=F;else{if(!(F instanceof al))return Array.isArray(F)?4===F.length||F.every(Array.isArray)?this.extend(al.convert(F)):this.extend(il.convert(F)):"object"==typeof F&&null!==F&&F.hasOwnProperty("lat")&&(F.hasOwnProperty("lon")||F.hasOwnProperty("lng"))?this.extend(il.convert(F)):this;if(Fe=F._sw,Ve=F._ne,!Fe||!Ve)return this}return Ae||Oe?(Ae.lng=Math.min(Fe.lng,Ae.lng),Ae.lat=Math.min(Fe.lat,Ae.lat),Oe.lng=Math.max(Ve.lng,Oe.lng),Oe.lat=Math.max(Ve.lat,Oe.lat)):(this._sw=new il(Fe.lng,Fe.lat),this._ne=new il(Ve.lng,Ve.lat)),this}getCenter(){return new il((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new il(this.getWest(),this.getNorth())}getSouthEast(){return new il(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(F){const{lng:Ae,lat:Oe}=il.convert(F);let Fe=this._sw.lng<=Ae&&Ae<=this._ne.lng;return this._sw.lng>this._ne.lng&&(Fe=this._sw.lng>=Ae&&Ae>=this._ne.lng),this._sw.lat<=Oe&&Oe<=this._ne.lat&&Fe}static convert(F){if(F)return F instanceof al?F:new al(F)}}const Nm=0,Um=25.5;function ll(F){return Cm*Math.cos(F*Math.PI/180)}function ul(F){return(180+F)/360}function cl(F){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+F*Math.PI/360)))/360}function hl(F,Ae){return F/ll(Ae)}function pl(F){return 360*F-180}function fl(F){return 360/Math.PI*Math.atan(Math.exp((180-360*F)*Math.PI/180))-90}function dl(F,Ae){return F*ll(fl(Ae))}const jm=85.051129;function yl(F){return Math.cos(X(Q(F,-jm,jm)))}function gl(F,Ae){const Oe=Q(Ae,Nm,Um),Fe=Math.pow(2,Oe);return yl(F)*Cm/(512*Fe)}function xl(F){return 1/Math.cos(F*Math.PI/180)}function vl(F,Ae=0){const Oe=Math.exp(Math.PI*(1-(F.y+Ae/Vd)/(1<<F.z)*2));return 80150034*Oe/(Oe*Oe+1)/Vd/(1<<F.z)}class bl{constructor(F,Ae,Oe=0){this.x=+F,this.y=+Ae,this.z=+Oe}static fromLngLat(F,Ae=0){const Oe=il.convert(F);return new bl(ul(Oe.lng),cl(Oe.lat),hl(Ae,Oe.lat))}toLngLat(){return new il(pl(this.x),fl(this.y))}toAltitude(){return dl(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Cm*xl(fl(this.y))}}function _l(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri=(Ae+Fe)/2,xi=(Oe+Ve)/2,bi=new Jl(ri,xi);vt(bi),function(F,Ae,Oe,Fe,Ve,qe){const pt=Oe-Ve,vt=Fe-qe;return Math.abs((Fe-Ae)*pt-(Oe-F)*vt)/Math.hypot(pt,vt)}(bi.x,bi.y,qe.x,qe.y,pt.x,pt.y)>=zt?(_l(F,Ae,Oe,ri,xi,qe,bi,vt,zt),_l(F,ri,xi,Fe,Ve,bi,pt,vt,zt)):F.push(pt)}function wl(F,Ae,Oe){let Fe=F[0],Ve=Fe.x,qe=Fe.y;Ae(Fe);const pt=[Fe];for(let vt=1;vt<F.length;vt++){const zt=F[vt],{x:ri,y:xi}=zt;Ae(zt),_l(pt,Ve,qe,ri,xi,Fe,zt,Ae,Oe),Ve=ri,qe=xi,Fe=zt}return pt}function Ml(F,Ae,Oe,Fe){if(Fe(Ae,Oe)){const Ve=Ae.add(Oe)._mult(.5);Ml(F,Ae,Ve,Fe),Ml(F,Ve,Oe,Fe)}else F.push(Oe)}function Al(F,Ae){let Oe=F[0];const Fe=[Oe];for(let Ve=1;Ve<F.length;Ve++){const qe=F[Ve];Ml(Fe,Oe,qe,Ae),Oe=qe}return Fe}const Gm=Math.pow(2,14)-1,qm=-Gm-1;function Pl(F,Ae){const Oe=Math.round(F.x*Ae),Fe=Math.round(F.y*Ae);return F.x=Q(Oe,qm,Gm),F.y=Q(Fe,qm,Gm),(Oe<F.x||Oe>F.x+1||Fe<F.y||Fe>F.y+1)&&ft("Geometry exceeds allowed extent, reduce your vector tile buffer size"),F}function zl(F,Ae,Oe){const Fe=F.loadGeometry(),Ve=F.extent,qe=Vd/Ve;if(Ae&&Oe&&Oe.projection.isReprojectedInTileSpace){const qe=1<<Ae.z,{scale:pt,x:vt,y:zt,projection:ri}=Oe,c=F=>{const Oe=pl((Ae.x+F.x/Ve)/qe),Fe=fl((Ae.y+F.y/Ve)/qe),xi=ri.project(Oe,Fe);F.x=(xi.x*pt-vt)*Ve,F.y=(xi.y*pt-zt)*Ve};for(let Ae=0;Ae<Fe.length;Ae++)if(1!==F.type)Fe[Ae]=wl(Fe[Ae],c,1);else{const F=[];for(const Oe of Fe[Ae])Oe.x<0||Oe.x>=Ve||Oe.y<0||Oe.y>=Ve||(c(Oe),F.push(Oe));Fe[Ae]=F}}for(const F of Fe)for(const Ae of F)Pl(Ae,qe);return Fe}function El(F,Ae){return{type:F.type,id:F.id,properties:F.properties,geometry:Ae?zl(F):[]}}function kl(F,Ae,Oe,Fe,Ve){F.emplaceBack(2*Ae+(Fe+1)/2,2*Oe+(Ve+1)/2)}function Tl(F,Ae,Oe){const Fe=16384;F.emplaceBack(Ae.x,Ae.y,Ae.z,Oe[0]*Fe,Oe[1]*Fe,Oe[2]*Fe)}class Bl{constructor(F){this.zoom=F.zoom,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.projection=F.projection,this.layoutVertexArray=new xs,this.indexArray=new Ls,this.segments=new po,this.programConfigurations=new No(F.layers,{zoom:F.zoom,lut:F.lut}),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id))}updateFootprints(F,Ae){}populate(F,Ae,Oe,Fe){const Ve=this.layers[0],qe=[];let pt=null;"circle"===Ve.type&&(pt=Ve.layout.get("circle-sort-key"));for(const{feature:Ae,id:Ve,index:vt,sourceLayerIndex:zt}of F){const F=this.layers[0]._featureFilter.needGeometry,ri=El(Ae,F);if(!this.layers[0]._featureFilter.filter(new Ca(this.zoom),ri,Oe))continue;const xi=pt?pt.evaluate(ri,{},Oe):void 0,bi={id:Ve,properties:Ae.properties,type:Ae.type,sourceLayerIndex:zt,index:vt,geometry:F?ri.geometry:zl(Ae,Oe,Fe),patterns:{},sortKey:xi};qe.push(bi)}pt&&qe.sort(((F,Ae)=>F.sortKey-Ae.sortKey));let vt=null;"globe"===Fe.projection.name&&(this.globeExtVertexArray=new Is,vt=Fe.projection);for(const Fe of qe){const{geometry:Ve,index:qe,sourceLayerIndex:pt}=Fe,zt=F[qe].feature;this.addFeature(Fe,Ve,qe,Ae.availableImages,Oe,vt,Ae.brightness),Ae.featureIndex.insert(zt,Ve,qe,pt,this.index)}}update(F,Ae,Oe,Fe,Ve,qe,pt){this.programConfigurations.updatePaintArrays(F,Ae,Ve,Oe,Fe,qe,pt)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,qf.members),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=F.createVertexBuffer(this.globeExtVertexArray,Hf.members))),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(F,Ae,Oe,Fe,Ve,qe,pt){for(const Oe of Ae)for(const Ae of Oe){const Oe=Ae.x,Fe=Ae.y;if(Oe<0||Oe>=Vd||Fe<0||Fe>=Vd)continue;if(qe){const F=qe.projectTilePoint(Oe,Fe,Ve),Ae=qe.upVector(Ve,Oe,Fe),pt=this.globeExtVertexArray;Tl(pt,F,Ae),Tl(pt,F,Ae),Tl(pt,F,Ae),Tl(pt,F,Ae)}const pt=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,F.sortKey),vt=pt.vertexLength;kl(this.layoutVertexArray,Oe,Fe,-1,-1),kl(this.layoutVertexArray,Oe,Fe,1,-1),kl(this.layoutVertexArray,Oe,Fe,1,1),kl(this.layoutVertexArray,Oe,Fe,-1,1),this.indexArray.emplaceBack(vt,vt+1,vt+2),this.indexArray.emplaceBack(vt,vt+2,vt+3),pt.vertexLength+=4,pt.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Oe,{},Fe,Ve,pt)}}function Cl(F,Ae){for(let Oe=0;Oe<F.length;Oe++)if(jl(Ae,F[Oe]))return!0;for(let Oe=0;Oe<Ae.length;Oe++)if(jl(F,Ae[Oe]))return!0;return!!Rl(F,Ae)}function Vl(F,Ae,Oe){return!!jl(F,Ae)||!!Ol(Ae,F,Oe)}function Dl(F,Ae){if(1===F.length)return Ul(Ae,F[0]);for(let Oe=0;Oe<Ae.length;Oe++){const Fe=Ae[Oe];for(let Ae=0;Ae<Fe.length;Ae++)if(jl(F,Fe[Ae]))return!0}for(let Oe=0;Oe<F.length;Oe++)if(Ul(Ae,F[Oe]))return!0;for(let Oe=0;Oe<Ae.length;Oe++)if(Rl(F,Ae[Oe]))return!0;return!1}function Ll(F,Ae,Oe){if(F.length>1){if(Rl(F,Ae))return!0;for(let Fe=0;Fe<Ae.length;Fe++)if(Ol(Ae[Fe],F,Oe))return!0}for(let Fe=0;Fe<F.length;Fe++)if(Ol(F[Fe],Ae,Oe))return!0;return!1}function Rl(F,Ae){if(0===F.length||0===Ae.length)return!1;for(let Oe=0;Oe<F.length-1;Oe++){const Fe=F[Oe],Ve=F[Oe+1];for(let F=0;F<Ae.length-1;F++)if(Fl(Fe,Ve,Ae[F],Ae[F+1]))return!0}return!1}function Fl(F,Ae,Oe,Fe){return dt(F,Oe,Fe)!==dt(Ae,Oe,Fe)&&dt(F,Ae,Oe)!==dt(F,Ae,Fe)}function Ol(F,Ae,Oe){const Fe=Oe*Oe;if(1===Ae.length)return F.distSqr(Ae[0])<Fe;for(let Oe=1;Oe<Ae.length;Oe++)if(Nl(F,Ae[Oe-1],Ae[Oe])<Fe)return!0;return!1}function Nl(F,Ae,Oe){const Fe=Ae.distSqr(Oe);if(0===Fe)return F.distSqr(Ae);const Ve=((F.x-Ae.x)*(Oe.x-Ae.x)+(F.y-Ae.y)*(Oe.y-Ae.y))/Fe;return F.distSqr(Ve<0?Ae:Ve>1?Oe:Oe.sub(Ae)._mult(Ve)._add(Ae))}function Ul(F,Ae){let Oe,Fe,Ve,qe=!1;for(let pt=0;pt<F.length;pt++){Oe=F[pt];for(let F=0,pt=Oe.length-1;F<Oe.length;pt=F++)Fe=Oe[F],Ve=Oe[pt],Fe.y>Ae.y!=Ve.y>Ae.y&&Ae.x<(Ve.x-Fe.x)*(Ae.y-Fe.y)/(Ve.y-Fe.y)+Fe.x&&(qe=!qe)}return qe}function jl(F,Ae){let Oe=!1;for(let Fe=0,Ve=F.length-1;Fe<F.length;Ve=Fe++){const qe=F[Fe],pt=F[Ve];qe.y>Ae.y!=pt.y>Ae.y&&Ae.x<(pt.x-qe.x)*(Ae.y-qe.y)/(pt.y-qe.y)+qe.x&&(Oe=!Oe)}return Oe}function ql(F,Ae,Oe,Fe,Ve){for(const qe of F)if(Ae<=qe.x&&Oe<=qe.y&&Fe>=qe.x&&Ve>=qe.y)return!0;const qe=[new Jl(Ae,Oe),new Jl(Ae,Ve),new Jl(Fe,Ve),new Jl(Fe,Oe)];if(F.length>2)for(const Ae of qe)if(jl(F,Ae))return!0;for(let Ae=0;Ae<F.length-1;Ae++)if($l(F[Ae],F[Ae+1],qe))return!0;return!1}function $l(F,Ae,Oe){const Fe=Oe[0],Ve=Oe[2];if(F.x<Fe.x&&Ae.x<Fe.x||F.x>Ve.x&&Ae.x>Ve.x||F.y<Fe.y&&Ae.y<Fe.y||F.y>Ve.y&&Ae.y>Ve.y)return!1;const qe=dt(F,Ae,Oe[0]);return qe!==dt(F,Ae,Oe[1])||qe!==dt(F,Ae,Oe[2])||qe!==dt(F,Ae,Oe[3])}function Gl(F,Ae,Oe,Fe,Ve,qe){let pt=Ae.y-F.y,vt=F.x-Ae.x;if(qe=qe||0){const F=pt*pt+vt*vt;if(0===F)return!0;const Ae=Math.sqrt(F);pt/=Ae,vt/=Ae}return!((Oe.x-F.x)*pt+(Oe.y-F.y)*vt-qe<0||(Fe.x-F.x)*pt+(Fe.y-F.y)*vt-qe<0||(Ve.x-F.x)*pt+(Ve.y-F.y)*vt-qe<0)}function Yl(F,Ae,Oe,Fe,Ve,qe,pt){return!(Gl(F,Ae,Fe,Ve,qe,pt)||Gl(Ae,Oe,Fe,Ve,qe,pt)||Gl(Oe,F,Fe,Ve,qe,pt)||Gl(Fe,Ve,F,Ae,Oe,pt)||Gl(Ve,qe,F,Ae,Oe,pt)||Gl(qe,Fe,F,Ae,Oe,pt))}function Xl(F,Ae,Oe){const Fe=Ae.paint.get(F).value;return"constant"===Fe.kind?Fe.value:Oe.programConfigurations.get(Ae.id).getMaxValue(F)}function Zl(F){return Math.sqrt(F[0]*F[0]+F[1]*F[1])}function Hl(F,Ae,Oe,Fe,Ve){if(!Ae[0]&&!Ae[1])return F;const qe=Jl.convert(Ae)._mult(Ve);"viewport"===Oe&&qe._rotate(-Fe);const pt=[];for(let Ae=0;Ae<F.length;Ae++)pt.push(F[Ae].sub(qe));return pt}function Wl(F,Ae,Oe,Fe){const Ve=Jl.convert(F)._mult(Fe);return"viewport"===Ae&&Ve._rotate(-Oe),Ve}let $m,Xm;oa(Bl,"CircleBucket",{omit:["layers"]});var Ym,Qm={exports:{}},e_=(Ym||(Ym=1,function(F,Ae){!function(F){function e(F,Ae,Oe){var Fe=r(256*F,256*(Ae=Math.pow(2,Oe)-Ae-1),Oe),Ve=r(256*(F+1),256*(Ae+1),Oe);return Fe[0]+","+Fe[1]+","+Ve[0]+","+Ve[1]}function r(F,Ae,Oe){var Fe=2*Math.PI*6378137/256/Math.pow(2,Oe);return[F*Fe-2*Math.PI*6378137/2,Ae*Fe-2*Math.PI*6378137/2]}F.getURL=function(F,Ae,Oe,Fe,Ve,qe){return qe=qe||{},F+"?"+["bbox="+e(Oe,Fe,Ve),"format="+(qe.format||"image/png"),"service="+(qe.service||"WMS"),"version="+(qe.version||"1.1.1"),"request="+(qe.request||"GetMap"),"srs="+(qe.srs||"EPSG:3857"),"width="+(qe.width||256),"height="+(qe.height||256),"layers="+Ae].join("&")},F.getTileBBox=e,F.getMercCoords=r,Object.defineProperty(F,"__esModule",{value:!0})}(Ae)}(0,Qm.exports)),Qm.exports);class ru{constructor(F,Ae,Oe){this.z=F,this.x=Ae,this.y=Oe,this.key=au(0,F,F,Ae,Oe)}equals(F){return this.z===F.z&&this.x===F.x&&this.y===F.y}url(F,Ae){const Oe=e_.getTileBBox(this.x,this.y,this.z),Fe=function(F,Ae,Oe){let Fe,Ve="";for(let qe=F;qe>0;qe--)Fe=1<<qe-1,Ve+=(Ae&Fe?1:0)+(Oe&Fe?2:0);return Ve}(this.z,this.x,this.y);return F[(this.x+this.y)%F.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===Ae?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",Fe).replace("{bbox-epsg-3857}",Oe)}toString(){return`${this.z}/${this.x}/${this.y}`}}class nu{constructor(F,Ae){this.wrap=F,this.canonical=Ae,this.key=au(F,Ae.z,Ae.z,Ae.x,Ae.y)}}class iu{constructor(F,Ae,Oe,Fe,Ve){this.overscaledZ=F,this.wrap=Ae,this.canonical=new ru(Oe,+Fe,+Ve),this.key=0===Ae&&F===Oe?this.canonical.key:au(Ae,F,Oe,Fe,Ve)}equals(F){return this.overscaledZ===F.overscaledZ&&this.wrap===F.wrap&&this.canonical.equals(F.canonical)}scaledTo(F){const Ae=this.canonical.z-F;return F>this.canonical.z?new iu(F,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new iu(F,this.wrap,F,this.canonical.x>>Ae,this.canonical.y>>Ae)}calculateScaledKey(F,Ae=!0){if(this.overscaledZ===F&&Ae)return this.key;if(F>this.canonical.z)return au(this.wrap*+Ae,F,this.canonical.z,this.canonical.x,this.canonical.y);{const Oe=this.canonical.z-F;return au(this.wrap*+Ae,F,F,this.canonical.x>>Oe,this.canonical.y>>Oe)}}isChildOf(F){if(F.wrap!==this.wrap)return!1;const Ae=this.canonical.z-F.canonical.z;return 0===F.overscaledZ||F.overscaledZ<this.overscaledZ&&F.canonical.z<this.canonical.z&&F.canonical.x===this.canonical.x>>Ae&&F.canonical.y===this.canonical.y>>Ae}children(F){if(this.overscaledZ>=F)return[new iu(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const Ae=this.canonical.z+1,Oe=2*this.canonical.x,Fe=2*this.canonical.y;return[new iu(Ae,this.wrap,Ae,Oe,Fe),new iu(Ae,this.wrap,Ae,Oe+1,Fe),new iu(Ae,this.wrap,Ae,Oe,Fe+1),new iu(Ae,this.wrap,Ae,Oe+1,Fe+1)]}isLessThan(F){return this.wrap<F.wrap||!(this.wrap>F.wrap)&&(this.overscaledZ<F.overscaledZ||!(this.overscaledZ>F.overscaledZ)&&(this.canonical.x<F.canonical.x||!(this.canonical.x>F.canonical.x)&&this.canonical.y<F.canonical.y))}wrapped(){return new iu(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(F){return new iu(this.overscaledZ,F,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new nu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function au(F,Ae,Oe,Fe,Ve){const qe=1<<Math.min(Oe,22);let pt=qe*(Ve%qe)+Fe%qe;return F&&Oe<22&&(pt+=qe*qe*((F<0?-2*F-1:2*F)%(1<<2*(22-Oe)))),16*(32*pt+Oe)+(Ae-Oe)}const t_=[F=>{let Ae=F.canonical.x-1,Oe=F.wrap;return Ae<0&&(Ae=(1<<F.canonical.z)-1,Oe--),new iu(F.overscaledZ,Oe,F.canonical.z,Ae,F.canonical.y)},F=>{let Ae=F.canonical.x+1,Oe=F.wrap;return Ae===1<<F.canonical.z&&(Ae=0,Oe++),new iu(F.overscaledZ,Oe,F.canonical.z,Ae,F.canonical.y)},F=>new iu(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,(0===F.canonical.y?1<<F.canonical.z:F.canonical.y)-1),F=>new iu(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y===(1<<F.canonical.z)-1?0:F.canonical.y+1)];oa(ru,"CanonicalTileID"),oa(iu,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const i_=ys([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:r_}=i_,n_=ys([{name:"a_pos_3",components:3,type:"Int16"}]);var o_=ys([{name:"a_pos",type:"Int16",components:2}]);class hu{constructor(F,Ae){this.pos=F,this.dir=Ae}intersectsPlane(F,Ae,Oe){const Fe=Sl.vec3.dot(Ae,this.dir);if(Math.abs(Fe)<1e-6)return!1;const Ve=((F[0]-this.pos[0])*Ae[0]+(F[1]-this.pos[1])*Ae[1]+(F[2]-this.pos[2])*Ae[2])/Fe;return Oe[0]=this.pos[0]+this.dir[0]*Ve,Oe[1]=this.pos[1]+this.dir[1]*Ve,Oe[2]=this.pos[2]+this.dir[2]*Ve,!0}closestPointOnSphere(F,Ae,Oe){if(Sl.vec3.equals(this.pos,F)||0===Ae)return Oe[0]=Oe[1]=Oe[2]=0,!1;const[Fe,Ve,qe]=this.dir,pt=this.pos[0]-F[0],vt=this.pos[1]-F[1],zt=this.pos[2]-F[2],ri=Fe*Fe+Ve*Ve+qe*qe,xi=2*(pt*Fe+vt*Ve+zt*qe),bi=xi*xi-4*ri*(pt*pt+vt*vt+zt*zt-Ae*Ae);if(bi<0){const F=Math.max(-xi/2,0),ri=pt+Fe*F,bi=vt+Ve*F,wi=zt+qe*F,dr=Math.hypot(ri,bi,wi);return Oe[0]=ri*Ae/dr,Oe[1]=bi*Ae/dr,Oe[2]=wi*Ae/dr,!1}{const F=(-xi-Math.sqrt(bi))/(2*ri);if(F<0){const F=Math.hypot(pt,vt,zt);return Oe[0]=pt*Ae/F,Oe[1]=vt*Ae/F,Oe[2]=zt*Ae/F,!1}return Oe[0]=pt+Fe*F,Oe[1]=vt+Ve*F,Oe[2]=zt+qe*F,!0}}}class pu{constructor(F,Ae,Oe,Fe,Ve){this.TL=F,this.TR=Ae,this.BR=Oe,this.BL=Fe,this.horizon=Ve}static fromInvProjectionMatrix(F,Ae,Oe){const Fe=[-1,1,1],Ve=[1,1,1],qe=[1,-1,1],pt=[-1,-1,1],vt=Sl.vec3.transformMat4(Fe,Fe,F),zt=Sl.vec3.transformMat4(Ve,Ve,F),ri=Sl.vec3.transformMat4(qe,qe,F),xi=Sl.vec3.transformMat4(pt,pt,F);return new pu(vt,zt,ri,xi,Ae/Oe)}}function fu(F,Ae,Oe){let Fe=1/0,Ve=-1/0;const qe=[];for(const pt of F){Sl.vec3.sub(qe,pt,Ae);const F=Sl.vec3.dot(qe,Oe);Fe=Math.min(Fe,F),Ve=Math.max(Ve,F)}return[Fe,Ve]}function du(F,Ae){let Oe=!0;for(let Fe=0;Fe<F.planes.length;Fe++){const Ve=F.planes[Fe];let qe=0;for(let F=0;F<Ae.length;F++)qe+=Sl.vec3.dot(Ve,Ae[F])+Ve[3]>=0;if(0===qe)return 0;qe!==Ae.length&&(Oe=!1)}return Oe?2:1}function mu(F,Ae){for(const Oe of F.projections){const Fe=fu(Ae,F.points[0],Oe.axis);if(Oe.projection[1]<Fe[0]||Oe.projection[0]>Fe[1])return 0}return 1}function yu(F,Ae){let Oe=0;const Fe=[0,0,0,0];for(let Ve=0;Ve<F.length;Ve++)Fe[0]=F[Ve][0],Fe[1]=F[Ve][1],Fe[2]=F[Ve][2],Fe[3]=1,Sl.vec4.dot(Fe,Ae)>=0&&Oe++;return Oe}class gu{constructor(F,Ae){this.points=F||new Array(8).fill([0,0,0]),this.planes=Ae||new Array(6).fill([0,0,0,0]),this.bounds=xu.fromPoints(this.points),this.projections=[],this.frustumEdges=[Sl.vec3.sub([],this.points[2],this.points[3]),Sl.vec3.sub([],this.points[0],this.points[3]),Sl.vec3.sub([],this.points[4],this.points[0]),Sl.vec3.sub([],this.points[5],this.points[1]),Sl.vec3.sub([],this.points[6],this.points[2]),Sl.vec3.sub([],this.points[7],this.points[3])];for(const F of this.frustumEdges){const Ae=[0,-F[2],F[1]],Oe=[F[2],0,-F[0]];this.projections.push({axis:Ae,projection:fu(this.points,this.points[0],Ae)}),this.projections.push({axis:Oe,projection:fu(this.points,this.points[0],Oe)})}}static fromInvProjectionMatrix(F,Ae,Oe,Fe){const Ve=Math.pow(2,Oe),qe=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((Oe=>{const qe=Sl.vec4.transformMat4([],Oe,F),pt=1/qe[3]/Ae*Ve;return Sl.vec4.mul(qe,qe,[pt,pt,Fe?1/qe[3]:pt,pt])})),pt=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((F=>{const Ae=Sl.vec3.sub([],qe[F[0]],qe[F[1]]),Oe=Sl.vec3.sub([],qe[F[2]],qe[F[1]]),Fe=Sl.vec3.normalize([],Sl.vec3.cross([],Ae,Oe)),Ve=-Sl.vec3.dot(Fe,qe[F[1]]);return Fe.concat(Ve)})),vt=[];for(let F=0;F<qe.length;F++)vt.push([qe[F][0],qe[F][1],qe[F][2]]);return new gu(vt,pt)}intersectsPrecise(F,Ae,Oe){for(let Oe=0;Oe<Ae.length;Oe++)if(!yu(F,Ae[Oe]))return 0;for(let Ae=0;Ae<this.planes.length;Ae++)if(!yu(F,this.planes[Ae]))return 0;for(const Ae of Oe)for(const Oe of this.frustumEdges){const Fe=Sl.vec3.cross([],Ae,Oe),Ve=Sl.vec3.length(Fe);if(0===Ve)continue;Sl.vec3.scale(Fe,Fe,1/Ve);const qe=fu(this.points,this.points[0],Fe),pt=fu(F,this.points[0],Fe);if(qe[0]>pt[1]||pt[0]>qe[1])return 0}return 1}containsPoint(F){for(const Ae of this.planes){const Oe=Ae[3];if(Sl.vec3.dot([Ae[0],Ae[1],Ae[2]],F)+Oe<0)return!1}return!0}}class xu{static fromPoints(F){const Ae=[1/0,1/0,1/0],Oe=[-1/0,-1/0,-1/0];for(const Fe of F)Sl.vec3.min(Ae,Ae,Fe),Sl.vec3.max(Oe,Oe,Fe);return new xu(Ae,Oe)}static fromTileIdAndHeight(F,Ae,Oe){const Fe=1<<F.canonical.z,Ve=F.canonical.x,qe=F.canonical.y;return new xu([Ve/Fe,qe/Fe,Ae],[(Ve+1)/Fe,(qe+1)/Fe,Oe])}static applyTransform(F,Ae){const Oe=F.getCorners();for(let F=0;F<Oe.length;++F)Sl.vec3.transformMat4(Oe[F],Oe[F],Ae);return xu.fromPoints(Oe)}static applyTransformFast(F,Ae){const Oe=[Ae[12],Ae[13],Ae[14]],Fe=[...Oe];for(let Ve=0;Ve<3;Ve++)for(let qe=0;qe<3;qe++){const pt=Ae[4*qe+Ve],vt=pt*F.min[qe],zt=pt*F.max[qe];Oe[Ve]+=Math.min(vt,zt),Fe[Ve]+=Math.max(vt,zt)}return new xu(Oe,Fe)}static projectAabbCorners(F,Ae){const Oe=F.getCorners();for(let F=0;F<Oe.length;++F)Sl.vec3.transformMat4(Oe[F],Oe[F],Ae);return Oe}constructor(F,Ae){this.min=F,this.max=Ae,this.center=Sl.vec3.scale([],Sl.vec3.add([],this.min,this.max),.5)}quadrant(F){const Ae=[F%2==0,F<2],Oe=Sl.vec3.clone(this.min),Fe=Sl.vec3.clone(this.max);for(let F=0;F<Ae.length;F++)Oe[F]=Ae[F]?this.min[F]:this.center[F],Fe[F]=Ae[F]?this.center[F]:this.max[F];return Fe[2]=this.max[2],new xu(Oe,Fe)}distanceX(F){return Math.max(Math.min(this.max[0],F[0]),this.min[0])-F[0]}distanceY(F){return Math.max(Math.min(this.max[1],F[1]),this.min[1])-F[1]}distanceZ(F){return Math.max(Math.min(this.max[2],F[2]),this.min[2])-F[2]}getCorners(){const F=this.min,Ae=this.max;return[[F[0],F[1],F[2]],[Ae[0],F[1],F[2]],[Ae[0],Ae[1],F[2]],[F[0],Ae[1],F[2]],[F[0],F[1],Ae[2]],[Ae[0],F[1],Ae[2]],[Ae[0],Ae[1],Ae[2]],[F[0],Ae[1],Ae[2]]]}intersects(F){return this.intersectsAabb(F.bounds)?du(F,this.getCorners()):0}intersectsFlat(F){return this.intersectsAabb(F.bounds)?du(F,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(F,Ae){return Ae||this.intersects(F)?mu(F,this.getCorners()):0}intersectsPreciseFlat(F,Ae){return Ae||this.intersectsFlat(F)?mu(F,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(F){for(let Ae=0;Ae<3;++Ae)if(this.min[Ae]>F.max[Ae]||F.min[Ae]>this.max[Ae])return!1;return!0}intersectsAabbXY(F){return!(this.min[0]>F.max[0]||F.min[0]>this.max[0]||this.min[1]>F.max[1]||F.min[1]>this.max[1])}encapsulate(F){for(let Ae=0;Ae<3;Ae++)this.min[Ae]=Math.min(this.min[Ae],F.min[Ae]),this.max[Ae]=Math.max(this.max[Ae],F.max[Ae])}encapsulatePoint(F){for(let Ae=0;Ae<3;Ae++)this.min[Ae]=Math.min(this.min[Ae],F[Ae]),this.max[Ae]=Math.max(this.max[Ae],F[Ae])}closestPoint(F){return[Math.max(Math.min(this.max[0],F[0]),this.min[0]),Math.max(Math.min(this.max[1],F[1]),this.min[1]),Math.max(Math.min(this.max[2],F[2]),this.min[2])]}}function vu(F){return F*cm/Am}oa(xu,"Aabb");const s_=[new xu([Mm,Mm,Mm],[Im,Im,Im]),new xu([Mm,Mm,Mm],[0,0,Im]),new xu([0,Mm,Mm],[Im,0,Im]),new xu([Mm,0,Mm],[0,Im,Im]),new xu([0,0,Mm],[Im,Im,Im])];function _u(F,Ae,Oe,Fe=!0){const Ve=Sl.vec3.scale([],F._camera.position,F.worldSize),qe=[Ae,Oe,1,1];Sl.vec4.transformMat4(qe,qe,F.pixelMatrixInverse),Sl.vec4.scale(qe,qe,1/qe[3]);const pt=Sl.vec3.sub([],qe,Ve),vt=Sl.vec3.normalize([],pt),zt=F.globeMatrix,ri=[zt[12],zt[13],zt[14]],xi=Sl.vec3.sub([],ri,Ve),bi=Sl.vec3.length(xi),wi=Sl.vec3.normalize([],xi),dr=F.worldSize/(2*Math.PI),jr=Sl.vec3.dot(wi,vt),Qr=Math.asin(dr/bi);if(Qr<Math.acos(jr)){if(!Fe)return null;const F=[],Ae=[];Sl.vec3.scale(F,vt,bi/jr),Sl.vec3.normalize(Ae,Sl.vec3.sub(Ae,F,xi)),Sl.vec3.normalize(vt,Sl.vec3.add(vt,xi,Sl.vec3.scale(vt,Ae,Math.tan(Qr)*bi)))}const Xn=[];new hu(Ve,vt).closestPointOnSphere(ri,dr,Xn);const ho=Sl.vec3.normalize([],bt(zt,0)),yo=Sl.vec3.normalize([],bt(zt,1)),zo=Sl.vec3.normalize([],bt(zt,2)),ko=Sl.vec3.dot(ho,Xn),Uo=Sl.vec3.dot(yo,Xn),ia=Sl.vec3.dot(zo,Xn),_a=Z(Math.asin(-Uo/dr));let Ma=Z(Math.atan2(ko,ia));Ma=F.center.lng+function(F,Ae){const Oe=(Ae-F+180)%360-180;return Oe<-180?Oe+360:Oe}(F.center.lng,Ma);const Ea=ul(Ma),Ia=Q(cl(_a),0,1);return new bl(Ea,Ia)}class wu{constructor(F,Ae,Oe){this.a=Sl.vec3.sub([],F,Oe),this.b=Sl.vec3.sub([],Ae,Oe),this.center=Oe;const Fe=Sl.vec3.normalize([],this.a),Ve=Sl.vec3.normalize([],this.b);this.angle=Math.acos(Sl.vec3.dot(Fe,Ve))}}function Mu(F,Ae){if(0===F.angle)return null;let Oe;return Oe=0===F.a[Ae]?1/F.angle*.5*Math.PI:1/F.angle*Math.atan(F.b[Ae]/F.a[Ae]/Math.sin(F.angle)-1/Math.tan(F.angle)),Oe<0||Oe>1?null:function(F,Ae,Oe,Fe){const Ve=Math.sin(Oe);return F*(Math.sin((1-Fe)*Oe)/Ve)+Ae*(Math.sin(Fe*Oe)/Ve)}(F.a[Ae],F.b[Ae],F.angle,Q(Oe,0,1))+F.center[Ae]}function Au(F){if(F.z<=1)return s_[F.z+2*F.y+F.x];const Ae=Eu(zu(F));return xu.fromPoints(Ae)}function Su(F,Ae,Oe){return Sl.vec3.scale(F,F,1-Oe),Sl.vec3.scaleAndAdd(F,F,Ae,Oe)}function Iu(F,Ae,Oe){for(const Fe of F)Sl.vec3.transformMat4(Fe,Fe,Ae),Sl.vec3.scale(Fe,Fe,Oe)}function Pu(F,Ae,Oe,Fe){const Ve=Ae/F.worldSize,qe=F.globeMatrix;if(Oe.z<=1){const F=Au(Oe).getCorners();return Iu(F,qe,Ve),xu.fromPoints(F)}const pt=zu(Oe,Fe),vt=Eu(pt,cm+vu(F._tileCoverLift));Iu(vt,qe,Ve);const zt=Number.MAX_VALUE,ri=[-zt,-zt,-zt],xi=[zt,zt,zt];if(pt.contains(F.center)){for(const F of vt)Sl.vec3.min(xi,xi,F),Sl.vec3.max(ri,ri,F);ri[2]=0;const Ae=F.point,Oe=[Ae.x*Ve,Ae.y*Ve,0];return Sl.vec3.min(xi,xi,Oe),Sl.vec3.max(ri,ri,Oe),new xu(xi,ri)}if(F._tileCoverLift>0){for(const F of vt)Sl.vec3.min(xi,xi,F),Sl.vec3.max(ri,ri,F);return new xu(xi,ri)}const bi=[qe[12]*Ve,qe[13]*Ve,qe[14]*Ve],wi=pt.getCenter(),dr=Q(F.center.lat,-jm,jm),jr=Q(wi.lat,-jm,jm),Qr=ul(F.center.lng),Xn=cl(dr);let ho=Qr-ul(wi.lng);const yo=Xn-cl(jr);ho>.5?ho-=1:ho<-.5&&(ho+=1);let zo=0;if(Math.abs(ho)>Math.abs(yo))zo=ho>=0?1:3;else{zo=yo>=0?0:2;const F=[qe[4]*Ve,qe[5]*Ve,qe[6]*Ve],Ae=-Math.sin(X(yo>=0?pt.getSouth():pt.getNorth()))*cm;Sl.vec3.scaleAndAdd(bi,bi,F,Ae)}const ko=vt[zo],Uo=vt[(zo+1)%4],ia=new wu(ko,Uo,bi),_a=[Mu(ia,0)||ko[0],Mu(ia,1)||ko[1],Mu(ia,2)||ko[2]],Ma=Fu(F.zoom);if(Ma>0){const Fe=function({x:F,y:Ae,z:Oe},Fe,Ve,qe,pt){const vt=1/(1<<Oe);let zt=F*vt,ri=zt+vt,xi=Ae*vt,bi=xi+vt,wi=0;const dr=(zt+ri)/2-qe;return dr>.5?wi=-1:dr<-.5&&(wi=1),zt=((zt+wi)*Fe-(qe*=Fe))*Ve+qe,ri=((ri+wi)*Fe-qe)*Ve+qe,xi=(xi*Fe-(pt*=Fe))*Ve+pt,bi=(bi*Fe-pt)*Ve+pt,[[zt,bi,0],[ri,bi,0],[ri,xi,0],[zt,xi,0]]}(Oe,Ae,F._pixelsPerMercatorPixel,Qr,Xn);for(let F=0;F<vt.length;F++)Su(vt[F],Fe[F],Ma);const Ve=Sl.vec3.add([],Fe[zo],Fe[(zo+1)%4]);Sl.vec3.scale(Ve,Ve,.5),Su(_a,Ve,Ma)}for(const F of vt)Sl.vec3.min(xi,xi,F),Sl.vec3.max(ri,ri,F);return xi[2]=Math.min(ko[2],Uo[2]),Sl.vec3.min(xi,xi,_a),Sl.vec3.max(ri,ri,_a),new xu(xi,ri)}function zu({x:F,y:Ae,z:Oe},Fe=!1){const Ve=1/(1<<Oe),qe=new il(pl(F*Ve),Ae===(1<<Oe)-1&&Fe?-90:fl((Ae+1)*Ve)),pt=new il(pl((F+1)*Ve),0===Ae&&Fe?90:fl(Ae*Ve));return new al(qe,pt)}function Eu(F,Ae=cm){const Oe=X(F.getNorth()),Fe=X(F.getSouth()),Ve=Math.cos(Oe),qe=Math.cos(Fe),pt=Math.sin(Oe),vt=Math.sin(Fe),zt=F.getWest(),ri=F.getEast();return[tl(qe,vt,zt,Ae),tl(qe,vt,ri,Ae),tl(Ve,pt,ri,Ae),tl(Ve,pt,zt,Ae)]}function ku(F,Ae,Oe,Fe){const Ve=1<<Oe.z,qe=(F/Vd+Oe.x)/Ve;return el(fl((Ae/Vd+Oe.y)/Ve),pl(qe),Fe)}function Tu({min:F,max:Ae}){return bm/Math.max(Ae[0]-F[0],Ae[1]-F[1],Ae[2]-F[2])}const a_=new Float64Array(16);function Cu(F){const Ae=Tu(F),Oe=Sl.mat4.fromScaling(a_,[Ae,Ae,Ae]);return Sl.mat4.translate(Oe,Oe,Sl.vec3.negate([],F.min))}function Vu(F){const Ae=Sl.mat4.fromTranslation(a_,F.min),Oe=1/Tu(F);return Sl.mat4.scale(Ae,Ae,[Oe,Oe,Oe])}function Du(F){const Ae=Vd/(2*Math.PI);return F/(2*Math.PI)/Ae}function Lu(F,Ae){return Vd/(512*Math.pow(2,F))*Tu(Au(Ae))}function Ru(F,Ae,Oe,Fe,Ve){const qe=Du(Oe),pt=[F,Ae,-Oe/(2*Math.PI)],vt=Sl.mat4.identity(new Float64Array(16));return Sl.mat4.translate(vt,vt,pt),Sl.mat4.scale(vt,vt,[qe,qe,qe]),Sl.mat4.rotateX(vt,vt,X(-Ve)),Sl.mat4.rotateY(vt,vt,X(-Fe)),vt}function Fu(F){return tt(hm,um,F)}function Ou(F,Ae){const Oe=el(Ae.lat,Ae.lng),Fe=function(F){const Ae=el(F._center.lat,F._center.lng),Oe=Sl.vec3.fromValues(0,1,0);let Fe=Sl.vec3.cross([],Oe,Ae);const Ve=Sl.mat4.fromRotation([],-F.angle,Ae);Fe=Sl.vec3.transformMat4(Fe,Fe,Ve),Sl.mat4.fromRotation(Ve,-F._pitch,Fe);const qe=Sl.vec3.normalize([],Ae);return Sl.vec3.scale(qe,qe,vu(F.cameraToCenterDistance/F.pixelsPerMeter)),Sl.vec3.transformMat4(qe,qe,Ve),Sl.vec3.add([],Ae,qe)}(F),Ve=Sl.vec3.subtract([],Fe,Oe);return Sl.vec3.angle(Ve,Oe)}function Nu(F,Ae){return Ou(F,Ae)>Math.PI/2*1.01}const l_=X(85),c_=Math.cos(l_),h_=Math.sin(l_),u_=Sl.mat4.create(),Gu=F=>{const Ae=[];return"map"===F.paint.get("circle-pitch-alignment")&&Ae.push("PITCH_WITH_MAP"),"map"===F.paint.get("circle-pitch-scale")&&Ae.push("SCALE_WITH_MAP"),Ae};function Yu(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){if(qe&&F.queryGeometry.isAboveHorizon)return!1;qe&&(zt*=F.pixelToTileUnitsFactor);const ri=F.tileID.canonical,xi=Oe.projection.upVectorScale(ri,Oe.center.lat,Oe.worldSize).metersToTile;for(const bi of Ae)for(const Ae of bi){const bi=Ae.add(vt),wi=Ve&&Oe.elevation?Oe.elevation.exaggeration()*Ve.getElevationAt(bi.x,bi.y,!0):0,dr=Oe.projection.projectTilePoint(bi.x,bi.y,ri);if(wi>0){const F=Oe.projection.upVector(ri,bi.x,bi.y);dr.x+=F[0]*xi*wi,dr.y+=F[1]*xi*wi,dr.z+=F[2]*xi*wi}const jr=qe?bi:Xu(dr.x,dr.y,dr.z,Fe),Qr=qe?F.tilespaceRays.map((F=>Wu(F,wi))):F.queryGeometry.screenGeometry,Xn=Sl.vec4.transformMat4([],[dr.x,dr.y,dr.z,1],Fe);if(!pt&&qe?zt*=Xn[3]/Oe.cameraToCenterDistance:pt&&!qe&&(zt*=Oe.cameraToCenterDistance/Xn[3]),qe){const F=fl((Ae.y/Vd+ri.y)/(1<<ri.z));zt/=Oe.projection.pixelsPerMeter(F,1)/hl(1,F)}if(Vl(Qr,jr,zt))return!0}return!1}function Xu(F,Ae,Oe,Fe){const Ve=Sl.vec4.transformMat4([],[F,Ae,Oe,1],Fe);return new Jl(Ve[0]/Ve[3],Ve[1]/Ve[3])}const d_=Sl.vec3.fromValues(0,0,0),p_=Sl.vec3.fromValues(0,0,1);function Wu(F,Ae){const Oe=Sl.vec3.create();return d_[2]=Ae,F.intersectsPlane(d_,p_,Oe),new Jl(Oe[0],Oe[1])}class Ku extends Bl{}let f_,m_,__,g_;function rc(F,{width:Ae,height:Oe},Fe,Ve){if(Ve){if(Ve instanceof Uint8ClampedArray)Ve=new Uint8Array(Ve.buffer);else if(Ve.length!==Ae*Oe*Fe)throw new RangeError("mismatched image size")}else Ve=new Uint8Array(Ae*Oe*Fe);return F.width=Ae,F.height=Oe,F.data=Ve,F}function nc(F,Ae,Oe){const{width:Fe,height:Ve}=Ae;Fe===F.width&&Ve===F.height||(ic(F,Ae,{x:0,y:0},{x:0,y:0},{width:Math.min(F.width,Fe),height:Math.min(F.height,Ve)},Oe,null),F.width=Fe,F.height=Ve,F.data=Ae.data)}function ic(F,Ae,Oe,Fe,Ve,qe,pt,vt){if(0===Ve.width||0===Ve.height)return Ae;if(Ve.width>F.width||Ve.height>F.height||Oe.x>F.width-Ve.width||Oe.y>F.height-Ve.height)throw new RangeError("out of range source coordinates for image copy");if(Ve.width>Ae.width||Ve.height>Ae.height||Fe.x>Ae.width-Ve.width||Fe.y>Ae.height-Ve.height)throw new RangeError("out of range destination coordinates for image copy");const zt=F.data,ri=Ae.data,xi=4===qe&&vt;for(let vt=0;vt<Ve.height;vt++){const bi=((Oe.y+vt)*F.width+Oe.x)*qe,wi=((Fe.y+vt)*Ae.width+Fe.x)*qe;if(xi)for(let F=0;F<Ve.width;F++){const Ae=bi+F*qe+3,Oe=wi+F*qe;ri[Oe+0]=255,ri[Oe+1]=255,ri[Oe+2]=255,ri[Oe+3]=zt[Ae]}else if(pt)for(let F=0;F<Ve.width;F++){const Ae=bi+F*qe,Oe=wi+F*qe,Fe=zt[Ae+3],Ve=new Ie(zt[Ae+0]/255*Fe,zt[Ae+1]/255*Fe,zt[Ae+2]/255*Fe,Fe).toRenderColor(pt).toArray();ri[Oe+0]=Ve[0],ri[Oe+1]=Ve[1],ri[Oe+2]=Ve[2],ri[Oe+3]=Ve[3]}else for(let F=0;F<Ve.width*qe;F++)ri[wi+F]=zt[bi+F]}return Ae}oa(Ku,"HeatmapBucket",{omit:["layers"]});class ac{constructor(F,Ae){rc(this,F,1,Ae)}resize(F){nc(this,new ac(F),1)}clone(){return new ac({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(F,Ae,Oe,Fe,Ve){ic(F,Ae,Oe,Fe,Ve,1,null)}}class sc{constructor(F,Ae){rc(this,F,4,Ae)}resize(F){nc(this,new sc(F),4)}replace(F,Ae){Ae?this.data.set(F):this.data=F instanceof Uint8ClampedArray?new Uint8Array(F.buffer):F}clone(){return new sc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(F,Ae,Oe,Fe,Ve,qe,pt){ic(F,Ae,Oe,Fe,Ve,4,qe,pt)}}class oc{constructor(F,Ae){this.width=F.width,this.height=F.height,this.data=Ae instanceof Uint8Array?new Float32Array(Ae.buffer):Ae}}function lc(F){const Ae={},Oe=F.resolution||256,Fe=F.clips?F.clips.length:1,Ve=F.image||new sc({width:Oe,height:Fe}),a=(Oe,Fe,qe)=>{Ae[F.evaluationKey]=qe;const pt=F.expression.evaluate(Ae);pt&&(Ve.data[Oe+Fe+0]=Math.floor(255*pt.r/pt.a),Ve.data[Oe+Fe+1]=Math.floor(255*pt.g/pt.a),Ve.data[Oe+Fe+2]=Math.floor(255*pt.b/pt.a),Ve.data[Oe+Fe+3]=Math.floor(255*pt.a))};if(F.clips)for(let Ae=0,Ve=0;Ae<Fe;++Ae,Ve+=4*Oe)for(let Fe=0,qe=0;Fe<Oe;Fe++,qe+=4){const pt=Fe/(Oe-1),{start:vt,end:zt}=F.clips[Ae];a(Ve,qe,vt*(1-pt)+zt*pt)}else for(let F=0,Ae=0;F<Oe;F++,Ae+=4)a(0,Ae,F/(Oe-1));return Ve}oa(ac,"AlphaImage"),oa(sc,"RGBAImage");const y_=ys([{name:"a_pos",components:2,type:"Int16"}],4),{members:x_}=y_;function hc(F,Ae,Oe=2){const Fe=Ae&&Ae.length,Ve=Fe?Ae[0]*Oe:F.length;let qe=pc(F,0,Ve,Oe,!0);const pt=[];if(!qe||qe.next===qe.prev)return pt;let vt,zt,ri;if(Fe&&(qe=function(F,Ae,Oe,Fe){const Ve=[];for(let Oe=0,qe=Ae.length;Oe<qe;Oe++){const pt=pc(F,Ae[Oe]*Fe,Oe<qe-1?Ae[Oe+1]*Fe:F.length,Fe,!1);pt===pt.next&&(pt.steiner=!0),Ve.push(Mc(pt))}Ve.sort(vc);for(let F=0;F<Ve.length;F++)Oe=bc(Ve[F],Oe);return Oe}(F,Ae,qe,Oe)),F.length>80*Oe){vt=1/0,zt=1/0;let Ae=-1/0,Fe=-1/0;for(let qe=Oe;qe<Ve;qe+=Oe){const Oe=F[qe],Ve=F[qe+1];Oe<vt&&(vt=Oe),Ve<zt&&(zt=Ve),Oe>Ae&&(Ae=Oe),Ve>Fe&&(Fe=Ve)}ri=Math.max(Ae-vt,Fe-zt),ri=0!==ri?32767/ri:0}return dc(qe,pt,Oe,vt,zt,ri,0),pt}function pc(F,Ae,Oe,Fe,Ve){let qe;if(Ve===function(F,Ae,Oe,Fe){let Ve=0;for(let qe=Ae,pt=Oe-Fe;qe<Oe;qe+=Fe)Ve+=(F[pt]-F[qe])*(F[qe+1]+F[pt+1]),pt=qe;return Ve}(F,Ae,Oe,Fe)>0)for(let Ve=Ae;Ve<Oe;Ve+=Fe)qe=Cc(Ve/Fe|0,F[Ve],F[Ve+1],qe);else for(let Ve=Oe-Fe;Ve>=Ae;Ve-=Fe)qe=Cc(Ve/Fe|0,F[Ve],F[Ve+1],qe);return qe&&Pc(qe,qe.next)&&(Vc(qe),qe=qe.next),qe}function fc(F,Ae){if(!F)return F;Ae||(Ae=F);let Oe,Fe=F;do{if(Oe=!1,Fe.steiner||!Pc(Fe,Fe.next)&&0!==Ic(Fe.prev,Fe,Fe.next))Fe=Fe.next;else{if(Vc(Fe),Fe=Ae=Fe.prev,Fe===Fe.next)break;Oe=!0}}while(Oe||Fe!==Ae);return Ae}function dc(F,Ae,Oe,Fe,Ve,qe,pt){if(!F)return;!pt&&qe&&function(F,Ae,Oe,Fe){let Ve=F;do{0===Ve.z&&(Ve.z=wc(Ve.x,Ve.y,Ae,Oe,Fe)),Ve.prevZ=Ve.prev,Ve.nextZ=Ve.next,Ve=Ve.next}while(Ve!==F);Ve.prevZ.nextZ=null,Ve.prevZ=null,function(F){let Ae,Oe=1;do{let Fe,Ve=F;F=null;let qe=null;for(Ae=0;Ve;){Ae++;let pt=Ve,vt=0;for(let F=0;F<Oe&&(vt++,pt=pt.nextZ,pt);F++);let zt=Oe;for(;vt>0||zt>0&&pt;)0!==vt&&(0===zt||!pt||Ve.z<=pt.z)?(Fe=Ve,Ve=Ve.nextZ,vt--):(Fe=pt,pt=pt.nextZ,zt--),qe?qe.nextZ=Fe:F=Fe,Fe.prevZ=qe,qe=Fe;Ve=pt}qe.nextZ=null,Oe*=2}while(Ae>1)}(Ve)}(F,Fe,Ve,qe);let vt=F;for(;F.prev!==F.next;){const zt=F.prev,ri=F.next;if(qe?yc(F,Fe,Ve,qe):mc(F))Ae.push(zt.i,F.i,ri.i),Vc(F),F=ri.next,vt=ri.next;else if((F=ri)===vt){pt?1===pt?dc(F=gc(fc(F),Ae),Ae,Oe,Fe,Ve,qe,2):2===pt&&xc(F,Ae,Oe,Fe,Ve,qe):dc(fc(F),Ae,Oe,Fe,Ve,qe,1);break}}}function mc(F){const Ae=F.prev,Oe=F,Fe=F.next;if(Ic(Ae,Oe,Fe)>=0)return!1;const Ve=Ae.x,qe=Oe.x,pt=Fe.x,vt=Ae.y,zt=Oe.y,ri=Fe.y,xi=Ve<qe?Ve<pt?Ve:pt:qe<pt?qe:pt,bi=vt<zt?vt<ri?vt:ri:zt<ri?zt:ri,wi=Ve>qe?Ve>pt?Ve:pt:qe>pt?qe:pt,dr=vt>zt?vt>ri?vt:ri:zt>ri?zt:ri;let jr=Fe.next;for(;jr!==Ae;){if(jr.x>=xi&&jr.x<=wi&&jr.y>=bi&&jr.y<=dr&&Ac(Ve,vt,qe,zt,pt,ri,jr.x,jr.y)&&Ic(jr.prev,jr,jr.next)>=0)return!1;jr=jr.next}return!0}function yc(F,Ae,Oe,Fe){const Ve=F.prev,qe=F,pt=F.next;if(Ic(Ve,qe,pt)>=0)return!1;const vt=Ve.x,zt=qe.x,ri=pt.x,xi=Ve.y,bi=qe.y,wi=pt.y,dr=vt<zt?vt<ri?vt:ri:zt<ri?zt:ri,jr=xi<bi?xi<wi?xi:wi:bi<wi?bi:wi,Qr=vt>zt?vt>ri?vt:ri:zt>ri?zt:ri,Xn=xi>bi?xi>wi?xi:wi:bi>wi?bi:wi,ho=wc(dr,jr,Ae,Oe,Fe),yo=wc(Qr,Xn,Ae,Oe,Fe);let zo=F.prevZ,ko=F.nextZ;for(;zo&&zo.z>=ho&&ko&&ko.z<=yo;){if(zo.x>=dr&&zo.x<=Qr&&zo.y>=jr&&zo.y<=Xn&&zo!==Ve&&zo!==pt&&Ac(vt,xi,zt,bi,ri,wi,zo.x,zo.y)&&Ic(zo.prev,zo,zo.next)>=0)return!1;if(zo=zo.prevZ,ko.x>=dr&&ko.x<=Qr&&ko.y>=jr&&ko.y<=Xn&&ko!==Ve&&ko!==pt&&Ac(vt,xi,zt,bi,ri,wi,ko.x,ko.y)&&Ic(ko.prev,ko,ko.next)>=0)return!1;ko=ko.nextZ}for(;zo&&zo.z>=ho;){if(zo.x>=dr&&zo.x<=Qr&&zo.y>=jr&&zo.y<=Xn&&zo!==Ve&&zo!==pt&&Ac(vt,xi,zt,bi,ri,wi,zo.x,zo.y)&&Ic(zo.prev,zo,zo.next)>=0)return!1;zo=zo.prevZ}for(;ko&&ko.z<=yo;){if(ko.x>=dr&&ko.x<=Qr&&ko.y>=jr&&ko.y<=Xn&&ko!==Ve&&ko!==pt&&Ac(vt,xi,zt,bi,ri,wi,ko.x,ko.y)&&Ic(ko.prev,ko,ko.next)>=0)return!1;ko=ko.nextZ}return!0}function gc(F,Ae){let Oe=F;do{const Fe=Oe.prev,Ve=Oe.next.next;!Pc(Fe,Ve)&&zc(Fe,Oe,Oe.next,Ve)&&Tc(Fe,Ve)&&Tc(Ve,Fe)&&(Ae.push(Fe.i,Oe.i,Ve.i),Vc(Oe),Vc(Oe.next),Oe=F=Ve),Oe=Oe.next}while(Oe!==F);return fc(Oe)}function xc(F,Ae,Oe,Fe,Ve,qe){let pt=F;do{let F=pt.next.next;for(;F!==pt.prev;){if(pt.i!==F.i&&Sc(pt,F)){let vt=Bc(pt,F);return pt=fc(pt,pt.next),vt=fc(vt,vt.next),dc(pt,Ae,Oe,Fe,Ve,qe,0),void dc(vt,Ae,Oe,Fe,Ve,qe,0)}F=F.next}pt=pt.next}while(pt!==F)}function vc(F,Ae){return F.x-Ae.x}function bc(F,Ae){const Oe=function(F,Ae){let Oe=Ae;const Fe=F.x,Ve=F.y;let qe,pt=-1/0;do{if(Ve<=Oe.y&&Ve>=Oe.next.y&&Oe.next.y!==Oe.y){const F=Oe.x+(Ve-Oe.y)*(Oe.next.x-Oe.x)/(Oe.next.y-Oe.y);if(F<=Fe&&F>pt&&(pt=F,qe=Oe.x<Oe.next.x?Oe:Oe.next,F===Fe))return qe}Oe=Oe.next}while(Oe!==Ae);if(!qe)return null;const vt=qe,zt=qe.x,ri=qe.y;let xi=1/0;Oe=qe;do{if(Fe>=Oe.x&&Oe.x>=zt&&Fe!==Oe.x&&Ac(Ve<ri?Fe:pt,Ve,zt,ri,Ve<ri?pt:Fe,Ve,Oe.x,Oe.y)){const Ae=Math.abs(Ve-Oe.y)/(Fe-Oe.x);Tc(Oe,F)&&(Ae<xi||Ae===xi&&(Oe.x>qe.x||Oe.x===qe.x&&_c(qe,Oe)))&&(qe=Oe,xi=Ae)}Oe=Oe.next}while(Oe!==vt);return qe}(F,Ae);if(!Oe)return Ae;const Fe=Bc(Oe,F);return fc(Fe,Fe.next),fc(Oe,Oe.next)}function _c(F,Ae){return Ic(F.prev,F,Ae.prev)<0&&Ic(Ae.next,F,F.next)<0}function wc(F,Ae,Oe,Fe,Ve){return(F=1431655765&((F=858993459&((F=252645135&((F=16711935&((F=(F-Oe)*Ve|0)|F<<8))|F<<4))|F<<2))|F<<1))|(Ae=1431655765&((Ae=858993459&((Ae=252645135&((Ae=16711935&((Ae=(Ae-Fe)*Ve|0)|Ae<<8))|Ae<<4))|Ae<<2))|Ae<<1))<<1}function Mc(F){let Ae=F,Oe=F;do{(Ae.x<Oe.x||Ae.x===Oe.x&&Ae.y<Oe.y)&&(Oe=Ae),Ae=Ae.next}while(Ae!==F);return Oe}function Ac(F,Ae,Oe,Fe,Ve,qe,pt,vt){return(Ve-pt)*(Ae-vt)>=(F-pt)*(qe-vt)&&(F-pt)*(Fe-vt)>=(Oe-pt)*(Ae-vt)&&(Oe-pt)*(qe-vt)>=(Ve-pt)*(Fe-vt)}function Sc(F,Ae){return F.next.i!==Ae.i&&F.prev.i!==Ae.i&&!function(F,Ae){let Oe=F;do{if(Oe.i!==F.i&&Oe.next.i!==F.i&&Oe.i!==Ae.i&&Oe.next.i!==Ae.i&&zc(Oe,Oe.next,F,Ae))return!0;Oe=Oe.next}while(Oe!==F);return!1}(F,Ae)&&(Tc(F,Ae)&&Tc(Ae,F)&&function(F,Ae){let Oe=F,Fe=!1;const Ve=(F.x+Ae.x)/2,qe=(F.y+Ae.y)/2;do{Oe.y>qe!=Oe.next.y>qe&&Oe.next.y!==Oe.y&&Ve<(Oe.next.x-Oe.x)*(qe-Oe.y)/(Oe.next.y-Oe.y)+Oe.x&&(Fe=!Fe),Oe=Oe.next}while(Oe!==F);return Fe}(F,Ae)&&(Ic(F.prev,F,Ae.prev)||Ic(F,Ae.prev,Ae))||Pc(F,Ae)&&Ic(F.prev,F,F.next)>0&&Ic(Ae.prev,Ae,Ae.next)>0)}function Ic(F,Ae,Oe){return(Ae.y-F.y)*(Oe.x-Ae.x)-(Ae.x-F.x)*(Oe.y-Ae.y)}function Pc(F,Ae){return F.x===Ae.x&&F.y===Ae.y}function zc(F,Ae,Oe,Fe){const Ve=kc(Ic(F,Ae,Oe)),qe=kc(Ic(F,Ae,Fe)),pt=kc(Ic(Oe,Fe,F)),vt=kc(Ic(Oe,Fe,Ae));return Ve!==qe&&pt!==vt||!(0!==Ve||!Ec(F,Oe,Ae))||!(0!==qe||!Ec(F,Fe,Ae))||!(0!==pt||!Ec(Oe,F,Fe))||!(0!==vt||!Ec(Oe,Ae,Fe))}function Ec(F,Ae,Oe){return Ae.x<=Math.max(F.x,Oe.x)&&Ae.x>=Math.min(F.x,Oe.x)&&Ae.y<=Math.max(F.y,Oe.y)&&Ae.y>=Math.min(F.y,Oe.y)}function kc(F){return F>0?1:F<0?-1:0}function Tc(F,Ae){return Ic(F.prev,F,F.next)<0?Ic(F,Ae,F.next)>=0&&Ic(F,F.prev,Ae)>=0:Ic(F,Ae,F.prev)<0||Ic(F,F.next,Ae)<0}function Bc(F,Ae){const Oe=Dc(F.i,F.x,F.y),Fe=Dc(Ae.i,Ae.x,Ae.y),Ve=F.next,qe=Ae.prev;return F.next=Ae,Ae.prev=F,Oe.next=Ve,Ve.prev=Oe,Fe.next=Oe,Oe.prev=Fe,qe.next=Fe,Fe.prev=qe,Fe}function Cc(F,Ae,Oe,Fe){const Ve=Dc(F,Ae,Oe);return Fe?(Ve.next=Fe.next,Ve.prev=Fe,Fe.next.prev=Ve,Fe.next=Ve):(Ve.prev=Ve,Ve.next=Ve),Ve}function Vc(F){F.next.prev=F.prev,F.prev.next=F.next,F.prevZ&&(F.prevZ.nextZ=F.nextZ),F.nextZ&&(F.nextZ.prevZ=F.prevZ)}function Dc(F,Ae,Oe){return{i:F,x:Ae,y:Oe,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Lc(F,Ae){const Oe=F.length;if(Oe<=1)return[F];const Fe=[];let Ve,qe;for(let Ae=0;Ae<Oe;Ae++){const Oe=mt(F[Ae]);0!==Oe&&(F[Ae].area=Math.abs(Oe),void 0===qe&&(qe=Oe<0),qe===Oe<0?(Ve&&Fe.push(Ve),Ve=[F[Ae]]):Ve.push(F[Ae]))}if(Ve&&Fe.push(Ve),Ae>1)for(let F=0;F<Fe.length;F++)Fe[F].length<=Ae||(vr(Fe[F],Ae,1,Fe[F].length-1,Rc),Fe[F]=Fe[F].slice(0,Ae));return Fe}function Rc(F,Ae){return Ae.area-F.area}function Fc(F,Ae,Oe=1){if(!F)return null;const Fe="string"==typeof F?F:F.getPrimary().id;Ae[Fe]||(Ae[Fe]=[]);const Ve=tr.from(Fe).getPrimary().scaleSelf(Oe);return Ae[Fe].push(Ve),Ve.serialize()}function Oc(F,Ae,Oe,Fe){const Ve=Fe.patternDependencies;let qe=!1;for(const Fe of Ae){const Ae=Fe.paint.get(`${F}-pattern`);Ae.isConstant()||(qe=!0),Fc(Ae.constantOr(null),Ve,Oe)&&(qe=!0)}return qe}function Nc(F,Ae,Oe,Fe,Ve,qe){const pt=qe.patternDependencies;for(const vt of Ae){const Ae=vt.paint.get(`${F}-pattern`).value;if("constant"!==Ae.kind){let F=Ae.evaluate({zoom:Fe},Oe,{},qe.availableImages);F=F&&F.name?F.name:F;const zt=Fc(F,pt,Ve);zt&&(Oe.patterns[vt.id]=zt)}}return Oe}class Uc{constructor(F){this.zoom=F.zoom,this.pixelRatio=F.pixelRatio,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new xs,this.indexArray=new Ls,this.indexArray2=new Ts,this.programConfigurations=new No(F.layers,{zoom:F.zoom,lut:F.lut}),this.segments=new po,this.segments2=new po,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.projection=F.projection}updateFootprints(F,Ae){}populate(F,Ae,Oe,Fe){this.hasPattern=Oc("fill",this.layers,this.pixelRatio,Ae);const Ve=this.layers[0].layout.get("fill-sort-key"),qe=[];for(const{feature:pt,id:vt,index:zt,sourceLayerIndex:ri}of F){const F=this.layers[0]._featureFilter.needGeometry,xi=El(pt,F);if(!this.layers[0]._featureFilter.filter(new Ca(this.zoom),xi,Oe))continue;const bi=Ve?Ve.evaluate(xi,{},Oe,Ae.availableImages):void 0,wi={id:vt,properties:pt.properties,type:pt.type,sourceLayerIndex:ri,index:zt,geometry:F?xi.geometry:zl(pt,Oe,Fe),patterns:{},sortKey:bi};qe.push(wi)}Ve&&qe.sort(((F,Ae)=>F.sortKey-Ae.sortKey));for(const Fe of qe){const{geometry:Ve,index:qe,sourceLayerIndex:pt}=Fe;if(this.hasPattern){const F=Nc("fill",this.layers,Fe,this.zoom,this.pixelRatio,Ae);this.patternFeatures.push(F)}else this.addFeature(Fe,Ve,qe,Oe,{},Ae.availableImages,Ae.brightness,Ae.elevationFeatures);Ae.featureIndex.insert(F[qe].feature,Ve,qe,pt,this.index)}}update(F,Ae,Oe,Fe,Ve,qe,pt){this.programConfigurations.updatePaintArrays(F,Ae,Ve,Oe,Fe,qe,pt)}addFeatures(F,Ae,Oe,Fe,Ve,qe){for(const Ve of this.patternFeatures)this.addFeature(Ve,Ve.geometry,Ve.index,Ae,Oe,Fe,qe,F.elevationFeatures)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,x_),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.indexBuffer2=F.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(F,Ae,Oe,Fe,Ve,qe=[],pt,vt){for(const F of Lc(Ae,500)){let Ae=0;for(const Oe of F)Ae+=Oe.length;const Oe=this.segments.prepareSegment(Ae,this.layoutVertexArray,this.indexArray),Fe=Oe.vertexLength,Ve=[],qe=[];for(const Ae of F){if(0===Ae.length)continue;Ae!==F[0]&&qe.push(Ve.length/2);const Oe=this.segments2.prepareSegment(Ae.length,this.layoutVertexArray,this.indexArray2),Fe=Oe.vertexLength;this.layoutVertexArray.emplaceBack(Ae[0].x,Ae[0].y),this.indexArray2.emplaceBack(Fe+Ae.length-1,Fe),Ve.push(Ae[0].x),Ve.push(Ae[0].y);for(let F=1;F<Ae.length;F++)this.layoutVertexArray.emplaceBack(Ae[F].x,Ae[F].y),this.indexArray2.emplaceBack(Fe+F-1,Fe+F),Ve.push(Ae[F].x),Ve.push(Ae[F].y);Oe.vertexLength+=Ae.length,Oe.primitiveLength+=Ae.length}const pt=hc(Ve,qe);for(let F=0;F<pt.length;F+=3)this.indexArray.emplaceBack(Fe+pt[F],Fe+pt[F+1],Fe+pt[F+2]);Oe.vertexLength+=Ae,Oe.primitiveLength+=pt.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Oe,Ve,qe,Fe,pt)}}let v_,b_,w_,T_;oa(Uc,"FillBucket",{omit:["layers","patternFeatures"]});class Yc{constructor(F,Ae,Oe,Fe){if(this.triangleCount=Ae.length/3,this.min=new Jl(0,0),this.max=new Jl(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===F.length)return;const[Ve,qe]=[F[0].clone(),F[0].clone()];for(let Ae=1;Ae<F.length;++Ae){const Oe=F[Ae];Ve.x=Math.min(Ve.x,Oe.x),Ve.y=Math.min(Ve.y,Oe.y),qe.x=Math.max(qe.x,Oe.x),qe.y=Math.max(qe.y,Oe.y)}if(Fe){const F=Math.ceil(Math.max(qe.x-Ve.x,qe.y-Ve.y)/Fe);Oe=Math.max(Oe,F)}if(0===Oe)return;this.min=Ve,this.max=qe;const pt=this.max.sub(this.min);pt.x=Math.max(pt.x,1),pt.y=Math.max(pt.y,1);const vt=Math.max(pt.x,pt.y)/Oe;this.cellsX=Math.max(1,Math.ceil(pt.x/vt)),this.cellsY=Math.max(1,Math.ceil(pt.y/vt)),this.xScale=1/vt,this.yScale=1/vt;const zt=[];for(let Oe=0;Oe<this.triangleCount;Oe++){const Fe=F[Ae[3*Oe+0]].sub(this.min),Ve=F[Ae[3*Oe+1]].sub(this.min),qe=F[Ae[3*Oe+2]].sub(this.min),pt=Xc(Math.floor(Math.min(Fe.x,Ve.x,qe.x)),this.xScale,this.cellsX),ri=Xc(Math.floor(Math.max(Fe.x,Ve.x,qe.x)),this.xScale,this.cellsX),xi=Xc(Math.floor(Math.min(Fe.y,Ve.y,qe.y)),this.yScale,this.cellsY),bi=Xc(Math.floor(Math.max(Fe.y,Ve.y,qe.y)),this.yScale,this.cellsY),wi=new Jl(0,0),dr=new Jl(0,0),jr=new Jl(0,0),Qr=new Jl(0,0);for(let F=xi;F<=bi;++F){wi.y=dr.y=F*vt,jr.y=Qr.y=(F+1)*vt;for(let Ae=pt;Ae<=ri;++Ae)wi.x=jr.x=Ae*vt,dr.x=Qr.x=(Ae+1)*vt,(Yl(Fe,Ve,qe,wi,dr,Qr)||Yl(Fe,Ve,qe,wi,Qr,jr))&&zt.push({cellIdx:F*this.cellsX+Ae,triIdx:Oe})}}if(0===zt.length)return;zt.sort(((F,Ae)=>F.cellIdx-Ae.cellIdx||F.triIdx-Ae.triIdx));let ri=0;for(;ri<zt.length;){const F=zt[ri].cellIdx,Ae={start:this.payload.length,len:0};for(;ri<zt.length&&zt[ri].cellIdx===F;)++Ae.len,this.payload.push(zt[ri++].triIdx);this.cells[F]=Ae}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(F,Ae){if(0===this.triangleCount||0===this.cells.length)return;if(F.x>this.max.x||this.min.x>F.x||F.y>this.max.y||this.min.y>F.y)return;const Oe=Xc(F.x-this.min.x,this.xScale,this.cellsX),Fe=Xc(F.y-this.min.y,this.yScale,this.cellsY),Ve=this.cells[Fe*this.cellsX+Oe];if(Ve){this._lazyInitLookup();for(let F=0;F<Ve.len;F++){const Oe=this.payload[Ve.start+F],Fe=Math.floor(Oe/8),qe=1<<Oe%8;if(!(this.lookup[Fe]&qe)&&(this.lookup[Fe]|=qe,Ae.push(Oe),Ae.length===this.triangleCount))return}}}query(F,Ae,Oe){if(0===this.triangleCount||0===this.cells.length)return;if(F.x>this.max.x||this.min.x>Ae.x)return;if(F.y>this.max.y||this.min.y>Ae.y)return;this._lazyInitLookup();const Fe=Xc(F.x-this.min.x,this.xScale,this.cellsX),Ve=Xc(Ae.x-this.min.x,this.xScale,this.cellsX),qe=Xc(F.y-this.min.y,this.yScale,this.cellsY),pt=Xc(Ae.y-this.min.y,this.yScale,this.cellsY);for(let F=qe;F<=pt;F++)for(let Ae=Fe;Ae<=Ve;Ae++){const Fe=this.cells[F*this.cellsX+Ae];if(Fe)for(let F=0;F<Fe.len;F++){const Ae=this.payload[Fe.start+F],Ve=Math.floor(Ae/8),qe=1<<Ae%8;if(!(this.lookup[Ve]&qe)&&(this.lookup[Ve]|=qe,Oe.push(Ae),Oe.length===this.triangleCount))return}}}}function Xc(F,Ae,Oe){return Math.max(0,Math.min(Oe-1,Math.floor(F*Ae)))}oa(Yc,"TriangleGridIndex");class Zc{constructor(F){this.zoom=F.zoom,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.footprints=[]}updateFootprints(F,Ae){for(const Oe of this.footprints)Ae.push({footprint:Oe,id:F})}populate(F,Ae,Oe,Fe){const Ve=[];for(const{feature:Ae,id:qe,index:pt,sourceLayerIndex:vt}of F){const F=this.layers[0]._featureFilter.needGeometry,zt=El(Ae,F);if(!this.layers[0]._featureFilter.filter(new Ca(this.zoom),zt,Oe))continue;const ri={id:qe,properties:Ae.properties,type:Ae.type,sourceLayerIndex:vt,index:pt,geometry:F?zt.geometry:zl(Ae,Oe,Fe),patterns:{}};Ve.push(ri)}for(const Fe of Ve){const{geometry:Ve,index:qe,sourceLayerIndex:pt}=Fe;this.addFeature(Fe,Ve,qe,Oe,{},Ae.availableImages,Ae.brightness),Ae.featureIndex.insert(F[qe].feature,Ve,qe,pt,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(F){}update(F,Ae,Oe,Fe,Ve,qe,pt){}destroy(){}addFeature(F,Ae,Oe,Fe,Ve,qe=[],pt){for(const F of Lc(Ae,2)){const Ae=[],Oe=[],Fe=[],Ve=new Jl(1/0,1/0),qe=new Jl(-1/0,-1/0);for(const pt of F)if(0!==pt.length){pt!==F[0]&&Fe.push(Oe.length/2);for(let F=0;F<pt.length;F++)Oe.push(pt[F].x),Oe.push(pt[F].y),Ae.push(pt[F]),Ve.x=Math.min(Ve.x,pt[F].x),Ve.y=Math.min(Ve.y,pt[F].y),qe.x=Math.max(qe.x,pt[F].x),qe.y=Math.max(qe.y,pt[F].y)}const pt=hc(Oe,Fe),vt=new Yc(Ae,pt,8,256);this.footprints.push({vertices:Ae,indices:pt,grid:vt,min:Ve,max:qe})}}}oa(Zc,"ClipBucket",{omit:["layers"]});const S_=ys([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),M_=ys([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),E_=ys([{name:"a_centroid_pos",components:2,type:"Uint16"}]),I_=ys([{name:"a_join_normal_inside",components:3,type:"Int16"}]),A_=ys([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),C_=ys([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:P_}=S_;var z_,D_,R_,L_,k_,O_,F_,B_={};function ch(){if(D_)return z_;D_=1;var Ae=j();function e(Ae,Oe,Fe,Ve,qe){(this||F).properties={},(this||F).extent=Fe,(this||F).type=0,(this||F)._pbf=Ae,(this||F)._geometry=-1,(this||F)._keys=Ve,(this||F)._values=qe,Ae.readFields(r,this||F,Oe)}function r(F,Ae,Oe){1==F?Ae.id=Oe.readVarint():2==F?function(F,Ae){for(var Oe=F.readVarint()+F.pos;F.pos<Oe;){var Fe=Ae._keys[F.readVarint()],Ve=Ae._values[F.readVarint()];Ae.properties[Fe]=Ve}}(Oe,Ae):3==F?Ae.type=Oe.readVarint():4==F&&(Ae._geometry=Oe.pos)}function n(F){for(var Ae,Oe,Fe=0,Ve=0,qe=F.length,pt=qe-1;Ve<qe;pt=Ve++)Fe+=((Oe=F[pt]).x-(Ae=F[Ve]).x)*(Ae.y+Oe.y);return Fe}return z_=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var Oe=(this||F)._pbf;Oe.pos=(this||F)._geometry;for(var Fe,Ve=Oe.readVarint()+Oe.pos,qe=1,pt=0,vt=0,zt=0,ri=[];Oe.pos<Ve;){if(pt<=0){var xi=Oe.readVarint();qe=7&xi,pt=xi>>3}if(pt--,1===qe||2===qe)vt+=Oe.readSVarint(),zt+=Oe.readSVarint(),1===qe&&(Fe&&ri.push(Fe),Fe=[]),Fe.push(new Ae(vt,zt));else{if(7!==qe)throw new Error("unknown command "+qe);Fe&&Fe.push(Fe[0].clone())}}return Fe&&ri.push(Fe),ri},e.prototype.bbox=function(){var Ae=(this||F)._pbf;Ae.pos=(this||F)._geometry;for(var Oe=Ae.readVarint()+Ae.pos,Fe=1,Ve=0,qe=0,pt=0,vt=1/0,zt=-1/0,ri=1/0,xi=-1/0;Ae.pos<Oe;){if(Ve<=0){var bi=Ae.readVarint();Fe=7&bi,Ve=bi>>3}if(Ve--,1===Fe||2===Fe)(qe+=Ae.readSVarint())<vt&&(vt=qe),qe>zt&&(zt=qe),(pt+=Ae.readSVarint())<ri&&(ri=pt),pt>xi&&(xi=pt);else if(7!==Fe)throw new Error("unknown command "+Fe)}return[vt,ri,zt,xi]},e.prototype.toGeoJSON=function(Ae,Oe,Fe){var Ve,qe,pt=(this||F).extent*Math.pow(2,Fe),vt=(this||F).extent*Ae,zt=(this||F).extent*Oe,ri=this.loadGeometry(),xi=e.types[(this||F).type];function p(F){for(var Ae=0;Ae<F.length;Ae++){var Oe=F[Ae];F[Ae]=[360*(Oe.x+vt)/pt-180,360/Math.PI*Math.atan(Math.exp((180-360*(Oe.y+zt)/pt)*Math.PI/180))-90]}}switch((this||F).type){case 1:var bi=[];for(Ve=0;Ve<ri.length;Ve++)bi[Ve]=ri[Ve][0];p(ri=bi);break;case 2:for(Ve=0;Ve<ri.length;Ve++)p(ri[Ve]);break;case 3:for(ri=function(F){var Ae=F.length;if(Ae<=1)return[F];for(var Oe,Fe,Ve=[],qe=0;qe<Ae;qe++){var pt=n(F[qe]);0!==pt&&(void 0===Fe&&(Fe=pt<0),Fe===pt<0?(Oe&&Ve.push(Oe),Oe=[F[qe]]):Oe.push(F[qe]))}return Oe&&Ve.push(Oe),Ve}(ri),Ve=0;Ve<ri.length;Ve++)for(qe=0;qe<ri[Ve].length;qe++)p(ri[Ve][qe])}1===ri.length?ri=ri[0]:xi="Multi"+xi;var wi={type:"Feature",geometry:{type:xi,coordinates:ri},properties:(this||F).properties};return"id"in(this||F)&&(wi.id=(this||F).id),wi},z_}function hh(){if(L_)return R_;L_=1;var Ae=ch();function e(Ae,Oe){(this||F).version=1,(this||F).name=null,(this||F).extent=4096,(this||F).length=0,(this||F)._pbf=Ae,(this||F)._keys=[],(this||F)._values=[],(this||F)._features=[],Ae.readFields(r,this||F,Oe),(this||F).length=(this||F)._features.length}function r(F,Ae,Oe){15===F?Ae.version=Oe.readVarint():1===F?Ae.name=Oe.readString():5===F?Ae.extent=Oe.readVarint():2===F?Ae._features.push(Oe.pos):3===F?Ae._keys.push(Oe.readString()):4===F&&Ae._values.push(function(F){for(var Ae=null,Oe=F.readVarint()+F.pos;F.pos<Oe;){var Fe=F.readVarint()>>3;Ae=1===Fe?F.readString():2===Fe?F.readFloat():3===Fe?F.readDouble():4===Fe?F.readVarint64():5===Fe?F.readVarint():6===Fe?F.readSVarint():7===Fe?F.readBoolean():null}return Ae}(Oe))}return R_=e,e.prototype.feature=function(Oe){if(Oe<0||Oe>=(this||F)._features.length)throw new Error("feature index out of bounds");(this||F)._pbf.pos=(this||F)._features[Oe];var Fe=(this||F)._pbf.readVarint()+(this||F)._pbf.pos;return new Ae((this||F)._pbf,Fe,(this||F).extent,(this||F)._keys,(this||F)._values)},R_}function ph(){return F_||(F_=1,B_.VectorTile=function(){if(O_)return k_;O_=1;var Ae=hh();function e(F,Oe,Fe){if(3===F){var Ve=new Ae(Fe,Fe.readVarint()+Fe.pos);Ve.length&&(Oe[Ve.name]=Ve)}}return k_=function(Ae,Oe){(this||F).layers=Ae.readFields(e,{},Oe)},k_}(),B_.VectorTileFeature=ch(),B_.VectorTileLayer=hh()),B_}var N_=ph();class dh extends Jl{constructor(F,Ae,Oe){super(F,Ae),this.z=Oe}}class mh extends dh{constructor(F,Ae,Oe,Fe){super(F,Ae,Oe),this.w=Fe}}function yh(F,Ae,Oe,Fe){const Ve=[],qe=0===Fe?(F,Ae,Oe,Fe,Ve,qe)=>{F.push(new Jl(qe,Oe+(qe-Ae)/(Fe-Ae)*(Ve-Oe)))}:(F,Ae,Oe,Fe,Ve,qe)=>{F.push(new Jl(Ae+(qe-Oe)/(Ve-Oe)*(Fe-Ae),qe))};for(const pt of F){const F=[];for(const Ve of pt){if(Ve.length<=2)continue;const pt=[];for(let F=0;F<Ve.length-1;F++){const vt=Ve[F].x,zt=Ve[F].y,ri=Ve[F+1].x,xi=Ve[F+1].y,bi=0===Fe?vt:zt,wi=0===Fe?ri:xi;bi<Ae?wi>Ae&&qe(pt,vt,zt,ri,xi,Ae):bi>Oe?wi<Oe&&qe(pt,vt,zt,ri,xi,Oe):pt.push(Ve[F]),wi<Ae&&bi>=Ae&&qe(pt,vt,zt,ri,xi,Ae),wi>Oe&&bi<=Oe&&qe(pt,vt,zt,ri,xi,Oe)}let vt=Ve[Ve.length-1];const zt=0===Fe?vt.x:vt.y;zt>=Ae&&zt<=Oe&&pt.push(vt),pt.length&&(vt=pt[pt.length-1],pt[0].x===vt.x&&pt[0].y===vt.y||pt.push(pt[0]),F.push(pt))}F.length&&Ve.push(F)}return Ve}function gh(F,Ae,Oe,Fe){const Ve="x"===Oe?"y":"x",qe=(Fe-F[Oe])/(Ae[Oe]-F[Oe]);F[Ve]=F[Ve]+(Ae[Ve]-F[Ve])*qe,F[Oe]=Fe,F.hasOwnProperty("z")&&(F.z=ze(F.z,Ae.z,qe)),F.hasOwnProperty("w")&&(F.w=ze(F.w,Ae.w,qe))}function xh(F,Ae,Oe,Fe){const Ve=Oe,qe=Fe;for(const Oe of["x","y"]){let Fe=F,pt=Ae;Fe[Oe]>=pt[Oe]&&(Fe=Ae,pt=F),Fe[Oe]<Ve&&pt[Oe]>Ve&&gh(Fe,pt,Oe,Ve),Fe[Oe]<qe&&pt[Oe]>qe&&gh(pt,Fe,Oe,qe)}}const V_=Number.MAX_SAFE_INTEGER;function bh(F,Ae,Oe,Fe){return F.order<Ae||F.order===V_||!(F.clipMask&Oe)||function(F,Ae){return 0!==Ae.length&&void 0===Ae.find((Ae=>Ae===F))}(Fe,F.clipScope)}function _h(F,Ae){return F.x-Ae.x||F.y-Ae.y}function wh(F,Ae){return 0===_h(F.min,Ae.min)&&0===_h(F.max,Ae.max)}function Mh(F,Ae){return!(F.min.x>Ae.max.x||F.max.x<Ae.min.x||F.min.y>Ae.max.y||F.max.y<Ae.min.y)}function Ah(F,Ae){if(F.length!==Ae.length)return!1;for(let Oe=0;Oe<F.length;Oe++)if(F[Oe].sourceId!==Ae[Oe].sourceId||!wh(F[Oe],Ae[Oe])||F[Oe].order!==Ae[Oe].order||F[Oe].clipMask!==Ae[Oe].clipMask||!$(F[Oe].clipScope,Ae[Oe].clipScope))return!1;return!0}function Sh(F,Ae,Oe){const Fe=1/Vd,Ve=1/(1<<Oe.canonical.z),qe=(Ae.x*Fe+Oe.canonical.x)*Ve+Oe.wrap,pt=(Ae.y*Fe+Oe.canonical.y)*Ve;return{min:new Jl((F.x*Fe+Oe.canonical.x)*Ve+Oe.wrap,(F.y*Fe+Oe.canonical.y)*Ve),max:new Jl(qe,pt)}}function Ih(F,Ae,Oe){const Fe=1<<Oe.canonical.z,Ve=((Ae.x-Oe.wrap)*Fe-Oe.canonical.x)*Vd,qe=(Ae.y*Fe-Oe.canonical.y)*Vd;return{min:new Jl(((F.x-Oe.wrap)*Fe-Oe.canonical.x)*Vd,(F.y*Fe-Oe.canonical.y)*Vd),max:new Jl(Ve,qe)}}function Ph(F,Ae,Oe,Fe,Ve,qe,pt){const vt=F.indices,zt=F.vertices,ri=[];for(let xi=Fe;xi<Fe+Ve;xi+=3){const Fe=Ae[Oe[xi+0]+qe],Ve=Ae[Oe[xi+1]+qe],bi=Ae[Oe[xi+2]+qe],wi=Math.min(Fe.x,Ve.x,bi.x),dr=Math.max(Fe.x,Ve.x,bi.x),jr=Math.min(Fe.y,Ve.y,bi.y),Qr=Math.max(Fe.y,Ve.y,bi.y);ri.length=0,F.grid.query(new Jl(wi,jr),new Jl(dr,Qr),ri);for(let F=0;F<ri.length;F++){const Ae=ri[F];if(Yl(zt[vt[3*Ae+0]],zt[vt[3*Ae+1]],zt[vt[3*Ae+2]],Fe,Ve,bi,pt))return!0}}return!1}function zh(F,Ae,Oe,Fe){if(!F||!Oe)return!1;let Ve=F.vertices;if(!Ae.canonical.equals(Fe.canonical)||Ae.wrap!==Fe.wrap){if(Oe.vertices.length<F.vertices.length)return zh(Oe,Fe,F,Ae);const qe=Ae.canonical,pt=Fe.canonical,vt=Math.pow(2,pt.z-qe.z);Ve=F.vertices.map((F=>new Jl((F.x+qe.x*Vd)*vt-pt.x*Vd,(F.y+qe.y*Vd)*vt-pt.y*Vd)))}return Ph(Oe,Ve,F.indices,0,F.indices.length,0,0)}function Eh(F,Ae,Oe,Fe){const Ve=Math.pow(2,Fe.z-Oe.z);return new Jl((F+Oe.x*Vd)*Ve-Fe.x*Vd,(Ae+Oe.y*Vd)*Ve-Fe.y*Vd)}function kh(F,Ae){const Oe=[];Ae.grid.queryPoint(F,Oe);const Fe=Ae.indices,Ve=Ae.vertices;for(let Ae=0;Ae<Oe.length;Ae++){const qe=Oe[Ae];if(jl([Ve[Fe[3*qe+0]],Ve[Fe[3*qe+1]],Ve[Fe[3*qe+2]]],F))return!0}return!1}const U_=[new Jl(0,0),new Jl(Vd,0),new Jl(Vd,Vd),new Jl(0,Vd)];function Bh(F,Ae){const Oe=[];let Fe=[];if(!Ae||F.length<2)return[F];if(2===F.length)return $l(F[0],F[1],U_)?[F]:[];for(let Ae=0;Ae<F.length+2;Ae++){const Ve=F[Ae%F.length],qe=F[(Ae+1)%F.length],pt=$l(0===Ae?F[F.length-1]:F[(Ae-1)%F.length],Ve,U_),vt=$l(Ve,qe,U_),zt=pt||vt;zt&&Fe.push(Ve),zt&&vt||Fe.length>0&&(Fe.length>1&&Oe.push(Fe),Fe=[])}return Fe.length>1&&Oe.push(Fe),Oe}const j_=N_.VectorTileFeature.types,G_=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],q_=["fill-extrusion-flood-light-ground-radius"],Z_=Math.pow(2,13),$_=Math.pow(2,15)-1,H_=new Jl(0,1),W_=2147483648;function Nh(F,Ae,Oe,Fe,Ve,qe,pt,vt){F.emplaceBack((Ae<<1)+pt,(Oe<<1)+qe,(Math.floor(Fe*Z_)<<1)+Ve,Math.round(vt))}function Uh(F,Ae,Oe){F.emplaceBack(Ae.x*Vd,Ae.y*Vd,Oe?1:0)}function jh(F,Ae,Oe,Fe,Ve,qe){F.emplaceBack(Ae.x,Ae.y,(Oe.x<<1)+Fe,(Oe.y<<1)+Ve,qe)}function qh(F,Ae,Oe){const Fe=16384;F.emplaceBack(Ae.x,Ae.y,Ae.z,Oe[0]*Fe,Oe[1]*Fe,Oe[2]*Fe)}class $h{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Gh{constructor(){this.centroidXY=new Jl(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Jl(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Jl(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new Jl(this.max.x-this.min.x,this.max.y-this.min.y)}}class Yh{constructor(){this.acc=new Jl(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(F,Ae){F.min.x===Number.MAX_VALUE&&(F.min.x=F.max.x=Ae.x,F.min.y=F.max.y=Ae.y)}appendEdge(F,Ae,Oe){this.accCount++,this.acc._add(Ae);let Fe=!!this.borders;Ae.x<F.min.x?(F.min.x=Ae.x,Fe=!0):Ae.x>F.max.x&&(F.max.x=Ae.x,Fe=!0),Ae.y<F.min.y?(F.min.y=Ae.y,Fe=!0):Ae.y>F.max.y&&(F.max.y=Ae.y,Fe=!0),((0===Ae.x||Ae.x===Vd)&&Ae.x===Oe.x)!=((0===Ae.y||Ae.y===Vd)&&Ae.y===Oe.y)&&this.processBorderOverlap(Ae,Oe),Fe&&this.checkBorderIntersection(Ae,Oe)}checkBorderIntersection(F,Ae){Ae.x<0!=F.x<0&&this.addBorderIntersection(0,ze(Ae.y,F.y,(0-Ae.x)/(F.x-Ae.x))),Ae.x>Vd!=F.x>Vd&&this.addBorderIntersection(1,ze(Ae.y,F.y,(Vd-Ae.x)/(F.x-Ae.x))),Ae.y<0!=F.y<0&&this.addBorderIntersection(2,ze(Ae.x,F.x,(0-Ae.y)/(F.y-Ae.y))),Ae.y>Vd!=F.y>Vd&&this.addBorderIntersection(3,ze(Ae.x,F.x,(Vd-Ae.y)/(F.y-Ae.y)))}addBorderIntersection(F,Ae){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const Oe=this.borders[F];Ae<Oe[0]&&(Oe[0]=Ae),Ae>Oe[1]&&(Oe[1]=Ae)}processBorderOverlap(F,Ae){if(F.x===Ae.x){if(F.y===Ae.y)return;const Oe=0===F.x?0:1;this.addBorderIntersection(Oe,Ae.y),this.addBorderIntersection(Oe,F.y)}else{const Oe=0===F.y?2:3;this.addBorderIntersection(Oe,Ae.x),this.addBorderIntersection(Oe,F.x)}}centroid(){return 0===this.accCount?new Jl(0,0):new Jl(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((F,Ae)=>F+ +(Ae[0]!==Number.MAX_VALUE)),0):0}}function Xh(F,Ae){const Oe=F.add(Ae)._unit(),Fe=Q(F.x*Oe.x+F.y*Oe.y,-1,1);var Ve,qe,pt;return pt=Math.acos(Fe),Math.min(4,Math.max(-4,Math.tan(pt)))/4*$_*((Ve=F).x*(qe=Ae).y-Ve.y*qe.x<0?-1:1)}const X_=[F=>F.x<0,F=>F.x>Vd,F=>F.y<0,F=>F.y>Vd];function Hh(F,Ae,Oe,Fe){const Ve=[4];if(0===Fe)return Ve;Oe._mult(Fe);const qe=F.sub(Oe),pt=Ae.sub(Oe),vt=[F,Ae,qe,pt];for(let F=0;F<4;F++)for(const Ae of vt)if(X_[F](Ae)){Ve.push(F);break}return Ve}class Wh{constructor(F){this.vertexArray=new _s,this.indexArray=new Ls,this.programConfigurations=new No(F.layers,{zoom:F.zoom,lut:F.lut},(F=>q_.includes(F))),this._segments=new po,this.hiddenByLandmarkVertexArray=new Ws,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new po}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(F,Ae,Oe,Fe=!1){const Ve=F.length;if(Ve>2){let qe=Math.max(0,this._segments.get().length-1);const pt=this._segments._prepareSegment(4*Ve,this.vertexArray.length,2*this._segmentToGroundQuads[qe].length);let vt;qe!==this._segments.get().length-1&&(qe++,this._segmentToGroundQuads[qe]=[],this._segmentToRegionTriCounts[qe]=[0,0,0,0,0]);{const Ae=F[0],Oe=F[1];vt=Xh(Ae.sub(F[Ve-1])._perp()._unit(),Oe.sub(Ae)._perp()._unit())}for(let zt=0;zt<Ve;zt++){const ri=zt===Ve-1?0:zt+1,xi=F[zt],bi=F[ri],wi=F[ri===Ve-1?0:ri+1],dr=bi.sub(xi)._perp()._unit(),jr=Xh(dr,wi.sub(bi)._perp()._unit()),Qr=vt,Xn=jr;if(ep(xi,bi,Ae)||Fe&&rp(xi,Ae)&&rp(bi,Ae)){vt=jr;continue}const ho=pt.vertexLength;jh(this.vertexArray,xi,bi,1,1,Qr),jh(this.vertexArray,xi,bi,1,0,Qr),jh(this.vertexArray,xi,bi,0,1,Xn),jh(this.vertexArray,xi,bi,0,0,Xn),pt.vertexLength+=4;const yo=Hh(xi,bi,dr,Oe);for(const F of yo)this._segmentToGroundQuads[qe].push({id:ho,region:F}),this._segmentToRegionTriCounts[qe][F]+=2,pt.primitiveLength+=2;vt=jr}}}prepareBorderSegments(){if(!this.hasData())return;const F=this._segments.get(),Ae=F.length;for(let F=0;F<Ae;F++)this._segmentToGroundQuads[F].sort(((F,Ae)=>F.region-Ae.region));for(let Oe=0;Oe<Ae;Oe++){const Ae=this._segmentToGroundQuads[Oe],Fe=F[Oe],Ve=this._segmentToRegionTriCounts[Oe];Ve.reduce(((F,Ae)=>F+Ae),0);let qe=0;for(let F=0;F<=4;F++){const Ae=Ve[F];if(0!==Ae){let Oe=this.regionSegments[F];Oe||(Oe=this.regionSegments[F]=new po);const Ve={vertexOffset:Fe.vertexOffset,primitiveOffset:Fe.primitiveOffset+qe,vertexLength:Fe.vertexLength,primitiveLength:Ae};Oe.get().push(Ve)}qe+=Ae}for(let F=0;F<Ae.length;F++){const Oe=Ae[F].id;this.indexArray.emplaceBack(Oe,Oe+1,Oe+3),this.indexArray.emplaceBack(Oe,Oe+3,Oe+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(F,Ae,Oe,Fe,Ve,qe){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,F,Ae,Oe,Fe,Ve,qe)}upload(F){this.hasData()&&(this.vertexBuffer=F.createVertexBuffer(this.vertexArray,M_.members),this.indexBuffer=F.createIndexBuffer(this.indexArray))}uploadPaintProperties(F){this.hasData()&&this.programConfigurations.upload(F)}update(F,Ae,Oe,Fe,Ve,qe,pt){this.hasData()&&this.programConfigurations.updatePaintArrays(F,Ae,Oe,Fe,Ve,qe,pt)}updateHiddenByLandmark(F){if(!this.hasData())return;const Ae=F.groundVertexCount+F.groundVertexArrayOffset;if(0===F.groundVertexCount)return;const Oe=F.flags&W_?1:0;for(let Fe=F.groundVertexArrayOffset;Fe<Ae;++Fe)this.hiddenByLandmarkVertexArray.emplace(Fe,Oe);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(F){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=F.createVertexBuffer(this.hiddenByLandmarkVertexArray,A_.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let F=0;F<=4;F++){const Ae=this.regionSegments[F];Ae&&Ae.destroy()}}}}class Kh{constructor(F){this.zoom=F.zoom,this.canonical=F.canonical,this.overscaling=F.overscaling,this.layers=F.layers,this.pixelRatio=F.pixelRatio,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=F.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Ls,this.footprintVertices=new xs,this.footprintSegments=[],this.layoutVertexArray=new bs,this.centroidVertexArray=new oo,this.wallVertexArray=new uo,this.indexArray=new Ls,this.programConfigurations=new No(F.layers,{zoom:F.zoom,lut:F.lut},(F=>G_.includes(F))),this.segments=new po,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.groundEffect=new Wh(F),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(F,Ae){}populate(F,Ae,Oe,Fe){this.features=[],this.hasPattern=Oc("fill-extrusion",this.layers,this.pixelRatio,Ae),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=vl(Oe),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1);for(const{feature:Ve,id:qe,index:pt,sourceLayerIndex:vt}of F){const F=this.layers[0]._featureFilter.needGeometry,zt=El(Ve,F);if(!this.layers[0]._featureFilter.filter(new Ca(this.zoom),zt,Oe))continue;const ri={id:qe,sourceLayerIndex:vt,index:pt,geometry:F?zt.geometry:zl(Ve,Oe,Fe),properties:Ve.properties,type:Ve.type,patterns:{}},xi=this.layoutVertexArray.length,bi="Polygon"===j_[ri.type];if(this.hasPattern)this.features.push(Nc("fill-extrusion",this.layers,ri,this.zoom,this.pixelRatio,Ae));else if(this.wallMode)for(const F of ri.geometry)for(const Ve of Bh(F,bi))this.addFeature(ri,[Ve],pt,Oe,{},Ae.availableImages,Fe,Ae.brightness);else this.addFeature(ri,ri.geometry,pt,Oe,{},Ae.availableImages,Fe,Ae.brightness);Ae.featureIndex.insert(Ve,ri.geometry,pt,vt,this.index,xi)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(F,Ae,Oe,Fe,Ve,qe){for(const F of this.features){const pt="Polygon"===j_[F.type],{geometry:vt}=F;if(this.wallMode)for(const zt of vt)for(const vt of Bh(zt,pt))this.addFeature(F,[vt],F.index,Ae,Oe,Fe,Ve,qe);else this.addFeature(F,vt,F.index,Ae,Oe,Fe,Ve,qe)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(F,Ae,Oe,Fe,Ve,qe,pt){this.programConfigurations.updatePaintArrays(F,Ae,Ve,Oe,Fe,qe,pt),this.groundEffect.update(F,Ae,Ve,Oe,Fe,qe,pt)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,P_),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.wallVertexBuffer=F.createVertexBuffer(this.wallVertexArray,I_.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=F.createVertexBuffer(this.layoutVertexExtArray,C_.members,!0)),this.groundEffect.upload(F)),this.groundEffect.uploadPaintProperties(F),this.programConfigurations.upload(F),this.uploaded=!0}uploadCentroid(F){this.groundEffect.uploadHiddenByLandmark(F),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=F.createVertexBuffer(this.centroidVertexArray,E_.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(F,{})/this.tileToMeter,ri=[new Jl(0,0),new Jl(Vd,Vd)],xi=pt.projection,bi="globe"===xi.name,wi=this.wallMode||"Polygon"===j_[F.type],dr=new Yh;dr.centroidDataIndex=this.centroidData.length;const jr=new Gh,Qr=this.layers[0].paint.get("fill-extrusion-base").evaluate(F,{},Fe)<=0,Xn=this.layers[0].paint.get("fill-extrusion-height").evaluate(F,{},Fe);let ho;if(jr.height=Xn,jr.vertexArrayOffset=this.layoutVertexArray.length,jr.groundVertexArrayOffset=this.groundEffect.vertexArray.length,bi&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Is),this.wallMode){if(bi)return void ft("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==Ae.length)return;ho=function(F){const Ae=F[0].x===F[F.length-1].x&&F[0].y===F[F.length-1].y,Oe=function(F){let Ae=0;const Oe=F.length;for(let Fe=0;Fe<Oe;Fe++)Ae+=(F[(Fe+1)%Oe].x-F[Fe].x)*(F[(Fe+1)%Oe].y+F[Fe].y);return Ae>=0}(F);Oe||(F=F.reverse());const Fe={geometry:[],joinNormals:[],indices:[]},Ve=[],qe=[],pt=[];let vt=F.length;for(;vt>=2&&F[vt-1].equals(F[vt-2]);)vt--;if(vt<(Ae?3:2))return Fe;let zt,ri,xi,bi,wi,dr=0;for(;dr<vt-1&&F[dr].equals(F[dr+1]);)dr++;Ae&&(zt=F[vt-2],wi=F[dr].sub(zt)._unit()._perp());for(let Oe=dr;Oe<vt;Oe++){if(xi=Oe===vt-1?Ae?F[dr+1]:void 0:F[Oe+1],xi&&F[Oe].equals(xi))continue;wi&&(bi=wi),zt&&(ri=zt),zt=F[Oe],wi=xi?xi.sub(zt)._unit()._perp():bi,bi=bi||wi;let Fe=bi.add(wi);0===Fe.x&&0===Fe.y||Fe._unit();const jr=Fe.x*wi.x+Fe.y*wi.y,Qr=0!==jr?1/jr:1/0,Xn=bi.x*wi.y-bi.y*wi.x>0;let ho="miter";const yo=2;"miter"===ho&&Qr>yo&&(ho="bevel"),"bevel"===ho&&(Qr>100&&(ho="flipbevel"),Qr<yo&&(ho="miter"));const v=(F,Ae,Oe,Fe)=>{const vt=new Jl(F.x,F.y),zt=new Jl(F.x,F.y);vt.x+=Ae.x*Fe,vt.y+=Ae.y*Fe,zt.x-=Ae.x*Math.max(Oe,1),zt.y-=Ae.y*Math.max(Oe,1),pt.push(Ae),Ve.push(vt),qe.push(zt)};if("miter"===ho)Fe._mult(Qr),v(zt,Fe,0,0);else if("flipbevel"===ho)Fe=wi.mult(-1),v(zt,Fe,0,0),v(zt,Fe.mult(-1),0,0);else{const F=-Math.sqrt(Qr*Qr-1),Ae=Xn?F:0,Oe=Xn?0:F;ri&&v(zt,bi,Ae,Oe),xi&&v(zt,wi,Ae,Oe)}}Fe.geometry=[...Ve,...qe.reverse(),Ve[0]],Fe.joinNormals=[...pt,...pt.reverse(),pt[pt.length-1]];const jr=Fe.geometry.length-1;for(let F=0;F<jr/2;F++)if(F+1<jr/2){let Ae=F,Oe=F+1,Ve=jr-1-F,qe=jr-2-F;Ae=0===Ae?jr-1:Ae-1,Oe=0===Oe?jr-1:Oe-1,Ve=0===Ve?jr-1:Ve-1,qe=0===qe?jr-1:qe-1,Fe.indices.push(Ve),Fe.indices.push(Oe),Fe.indices.push(Ae),Fe.indices.push(Ve),Fe.indices.push(qe),Fe.indices.push(Oe)}return Fe}(Ae[0]),Ae=[ho.geometry]}const x=(F,Ae)=>F<(Ae.length-1)/2||F===Ae.length-1,yo=this.wallMode?[Ae]:Lc(Ae,500);for(let F=yo.length-1;F>=0;F--){const Ae=yo[F];(0===Ae.length||(zo=Ae[0]).every((F=>F.x<=0))||zo.every((F=>F.x>=Vd))||zo.every((F=>F.y<=0))||zo.every((F=>F.y>=Vd)))&&yo.splice(F,1)}var zo;let ko;if(bi)ko=sp(yo,ri,Fe);else{ko=[];for(const F of yo)ko.push({polygon:F,bounds:ri})}const Uo=wi?this.edgeRadius:0,ia=Uo>0&&this.zoom<17,A=(F,Ae)=>{if(0===F.length)return!1;const Oe=F[F.length-1];return Ae.x===Oe.x&&Ae.y===Oe.y};for(const{polygon:F,bounds:Ae}of ko){let Oe=0,Ve=0;for(const Ae of F)wi&&!Ae[0].equals(Ae[Ae.length-1])&&Ae.push(Ae[0]),Ve+=wi?Ae.length-1:Ae.length;const qe=this.segments.prepareSegment((wi?5:4)*Ve,this.layoutVertexArray,this.indexArray);jr.footprintSegIdx<0&&(jr.footprintSegIdx=this.footprintSegments.length),jr.polygonSegIdx<0&&(jr.polygonSegIdx=this.polygonSegments.length);const pt={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},vt=new $h;if(vt.vertexOffset=this.footprintVertices.length,vt.indexOffset=3*this.footprintIndices.length,vt.ringIndices=[],wi){const Ve=[],pt=[];Oe=qe.vertexLength;for(let Oe=0;Oe<F.length;Oe++){const ri=F[Oe];ri.length&&0!==Oe&&pt.push(Ve.length/2);const wi=[];let dr,jr;dr=ri[1].sub(ri[0])._perp()._unit(),vt.ringIndices.push(ri.length-1);for(let F=1;F<ri.length;F++){const Ae=ri[F],Oe=ri[F===ri.length-1?1:F+1],pt=Ae.clone();if(Uo){jr=Oe.sub(Ae)._perp()._unit();const F=dr.add(jr)._unit(),Fe=Uo*Math.min(4,1/(dr.x*F.x+dr.y*F.y));pt.x+=Fe*F.x,pt.y+=Fe*F.y,pt.x=Math.round(pt.x),pt.y=Math.round(pt.y),dr=jr}if(!Qr||0!==Uo&&!ia||A(wi,pt)||wi.push(pt),Nh(this.layoutVertexArray,pt.x,pt.y,0,0,1,1,0),this.wallMode){const Ae=x(F,ri);Uh(this.wallVertexArray,ho.joinNormals[F],!Ae)}qe.vertexLength++,this.footprintVertices.emplaceBack(Ae.x,Ae.y),Ve.push(Ae.x,Ae.y),bi&&qh(this.layoutVertexExtArray,xi.projectTilePoint(pt.x,pt.y,Fe),xi.upVector(Fe,pt.x,pt.y))}Qr&&(0===Uo||ia)&&(0!==wi.length&&A(wi,wi[0])&&wi.pop(),this.groundEffect.addData(wi,Ae,zt))}const ri=this.wallMode?ho.indices:hc(Ve,pt);for(let F=0;F<ri.length;F+=3)this.footprintIndices.emplaceBack(vt.vertexOffset+ri[F+0],vt.vertexOffset+ri[F+1],vt.vertexOffset+ri[F+2]),this.indexArray.emplaceBack(Oe+ri[F],Oe+ri[F+2],Oe+ri[F+1]),qe.primitiveLength++;vt.indexCount+=ri.length,vt.vertexCount+=this.footprintVertices.length-vt.vertexOffset}for(let Ve=0;Ve<F.length;Ve++){const pt=F[Ve];dr.startRing(jr,pt[0]);let vt=pt.length>4&&np(pt[pt.length-2],pt[0],pt[1]),ri=Uo?Qh(pt[pt.length-2],pt[0],pt[1],Uo):0;const Xn=[];let yo,zo,ko;zo=pt[1].sub(pt[0])._perp()._unit();let ia=!0;for(let F=1,Ve=0;F<pt.length;F++){let zt=pt[F-1],wi=pt[F];const _a=pt[F===pt.length-1?1:F+1];if(dr.appendEdge(jr,wi,zt),ep(wi,zt,Ae)){Uo&&(zo=_a.sub(wi)._perp()._unit(),ia=!ia);continue}const Ma=wi.sub(zt)._perp(),Ea=Ma.x/(Math.abs(Ma.x)+Math.abs(Ma.y)),Ia=Ma.y>0?1:0,rl=zt.dist(wi);if(Ve+rl>32768&&(Ve=0),Uo){ko=_a.sub(wi)._perp()._unit();let F=tp(zt,wi,_a,Jh(zo,ko),Uo);isNaN(F)&&(F=0);const Ae=wi.sub(zt)._unit();zt=zt.add(Ae.mult(ri))._round(),wi=wi.add(Ae.mult(-F))._round(),ri=F,zo=ko,Qr&&this.zoom>=17&&(A(Xn,zt)||Xn.push(zt),A(Xn,wi)||Xn.push(wi))}const Sl=qe.vertexLength,Il=pt.length>4&&np(zt,wi,_a);let Kl=ip(Ve,vt,ia);if(Nh(this.layoutVertexArray,zt.x,zt.y,Ea,Ia,0,0,Kl),Nh(this.layoutVertexArray,zt.x,zt.y,Ea,Ia,0,1,Kl),this.wallMode){const Ae=x(F-1,pt),Oe=ho.joinNormals[F-1];Uh(this.wallVertexArray,Oe,Ae),Uh(this.wallVertexArray,Oe,Ae)}if(Ve+=rl,Kl=ip(Ve,Il,!ia),vt=Il,Nh(this.layoutVertexArray,wi.x,wi.y,Ea,Ia,0,0,Kl),Nh(this.layoutVertexArray,wi.x,wi.y,Ea,Ia,0,1,Kl),this.wallMode){const Ae=x(F,pt),Oe=ho.joinNormals[F];Uh(this.wallVertexArray,Oe,Ae),Uh(this.wallVertexArray,Oe,Ae)}if(qe.vertexLength+=4,this.indexArray.emplaceBack(Sl+0,Sl+1,Sl+2),this.indexArray.emplaceBack(Sl+1,Sl+3,Sl+2),qe.primitiveLength+=2,Uo){const Fe=Oe+(1===F?pt.length-2:F-2),Ve=1===F?Oe:Fe+1;if(this.indexArray.emplaceBack(Sl+1,Fe,Sl+3),this.indexArray.emplaceBack(Fe,Ve,Sl+3),qe.primitiveLength+=2,void 0===yo&&(yo=Sl),!ep(_a,pt[F],Ae)){const Ae=F===pt.length-1?yo:qe.vertexLength;this.indexArray.emplaceBack(Sl+2,Sl+3,Ae),this.indexArray.emplaceBack(Sl+3,Ae+1,Ae),this.indexArray.emplaceBack(Sl+3,Ve,Ae+1),qe.primitiveLength+=3}ia=!ia}if(bi){const F=this.layoutVertexExtArray,Ae=xi.projectTilePoint(zt.x,zt.y,Fe),Oe=xi.projectTilePoint(wi.x,wi.y,Fe),Ve=xi.upVector(Fe,zt.x,zt.y),qe=xi.upVector(Fe,wi.x,wi.y);qh(F,Ae,Ve),qh(F,Ae,Ve),qh(F,Oe,qe),qh(F,Oe,qe)}}wi&&(Oe+=pt.length-1),Qr&&Uo&&this.zoom>=17&&(0!==Xn.length&&A(Xn,Xn[0])&&Xn.pop(),this.groundEffect.addData(Xn,Ae,zt,Uo>0))}this.footprintSegments.push(vt),pt.triangleCount=this.indexArray.length-pt.triangleArrayOffset,this.polygonSegments.push(pt),++jr.footprintSegLen,++jr.polygonSegLen}if(jr.vertexCount=this.layoutVertexArray.length-jr.vertexArrayOffset,jr.groundVertexCount=this.groundEffect.vertexArray.length-jr.groundVertexArrayOffset,0!==jr.vertexCount){if(jr.centroidXY=dr.borders?H_:this.encodeCentroid(dr,jr),this.centroidData.push(jr),dr.borders){this.featuresOnBorder.push(dr);const F=this.featuresOnBorder.length-1;for(let Ae=0;Ae<dr.borders.length;Ae++)dr.borders[Ae][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Ae].push(F)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Oe,Ve,qe,Fe,vt),this.groundEffect.addPaintPropertiesData(F,Oe,Ve,qe,Fe,vt),this.maxHeight=Math.max(this.maxHeight,Xn)}}sortBorders(){for(let F=0;F<this.borderFeatureIndices.length;F++)this.borderFeatureIndices[F].sort(((Ae,Oe)=>this.featuresOnBorder[Ae].borders[F][0]-this.featuresOnBorder[Oe].borders[F][0]))}splitToSubtiles(){const F=[];for(let Ae=0;Ae<this.centroidData.length;Ae++){const Oe=this.centroidData[Ae],Fe=+(Oe.min.y+Oe.max.y>Vd),Ve=2*Fe+(+(Oe.min.x+Oe.max.x>Vd)^Fe);for(let Fe=0;Fe<Oe.polygonSegLen;Fe++){const qe=Oe.polygonSegIdx+Fe;F.push({centroidIdx:Ae,subtile:Ve,polygonSegmentIdx:qe,triangleSegmentIdx:this.polygonSegments[qe].triangleSegIdx})}}const Ae=new Ls;F.sort(((F,Ae)=>F.triangleSegmentIdx===Ae.triangleSegmentIdx?F.subtile-Ae.subtile:F.triangleSegmentIdx-Ae.triangleSegmentIdx));let Oe=0,Fe=0,Ve=0;for(const Ae of F){if(Ae.triangleSegmentIdx!==Oe)break;Ve++}const qe=F.length;for(;Fe!==F.length;){Oe=F[Fe].triangleSegmentIdx;let pt=0,vt=Fe,zt=Fe;for(let Ae=vt;Ae<Ve&&F[Ae].subtile===pt;Ae++)zt++;for(;vt!==Ve;){const Fe=F[vt];pt=Fe.subtile;const qe=this.centroidData[Fe.centroidIdx].min.clone(),ri=this.centroidData[Fe.centroidIdx].max.clone(),xi={vertexOffset:this.segments.segments[Oe].vertexOffset,primitiveOffset:Ae.length,vertexLength:this.segments.segments[Oe].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let Oe=vt;Oe<zt;Oe++){const Fe=F[Oe],Ve=this.polygonSegments[Fe.polygonSegmentIdx],pt=this.centroidData[Fe.centroidIdx].min,vt=this.centroidData[Fe.centroidIdx].max,zt=this.indexArray.uint16;for(let F=Ve.triangleArrayOffset;F<Ve.triangleArrayOffset+Ve.triangleCount;F++)Ae.emplaceBack(zt[3*F],zt[3*F+1],zt[3*F+2]);xi.primitiveLength+=Ve.triangleCount,qe.x=Math.min(qe.x,pt.x),qe.y=Math.min(qe.y,pt.y),ri.x=Math.max(ri.x,vt.x),ri.y=Math.max(ri.y,vt.y)}xi.primitiveLength>0&&this.triangleSubSegments.push({segment:xi,min:qe,max:ri}),vt=zt;for(let Ae=vt;Ae<Ve&&F[Ae].subtile===F[vt].subtile;Ae++)zt++}Fe=Ve;for(let Ae=Fe;Ae<qe&&F[Ae].triangleSegmentIdx===F[Fe].triangleSegmentIdx;Ae++)Ve++}Ae._trim(),this.indexArray=Ae}getVisibleSegments(F,Ae,Oe){const Fe=new po;if(this.wallMode){for(const F of this.triangleSubSegments)Fe.segments.push(F.segment);return Fe}let Ve=0,qe=0;const pt=1<<F.canonical.z;if(Ae){const Oe=Ae.getMinMaxForTile(F);Oe&&(Ve=Oe.min,qe=Oe.max)}qe+=this.maxHeight;const vt=F.toUnwrapped();let zt;const ri=[vt.canonical.x/pt+vt.wrap,vt.canonical.y/pt],xi=[(vt.canonical.x+1)/pt+vt.wrap,(vt.canonical.y+1)/pt],h=(F,Ae,Oe)=>[F[0]*(1-Oe[0])+Ae[0]*Oe[0],F[1]*(1-Oe[1])+Ae[1]*Oe[1]],bi=[],wi=[];for(const F of this.triangleSubSegments){bi[0]=F.min.x/Vd,bi[1]=F.min.y/Vd,wi[0]=F.max.x/Vd,wi[1]=F.max.y/Vd;const Ae=h(ri,xi,bi),pt=h(ri,xi,wi);if(0===new xu([Ae[0],Ae[1],Ve],[pt[0],pt[1],qe]).intersectsPrecise(Oe)){zt&&(Fe.segments.push(zt),zt=void 0);continue}const vt=F.segment;zt&&zt.vertexOffset!==vt.vertexOffset&&(Fe.segments.push(zt),zt=void 0),zt?(zt.vertexLength+=vt.vertexLength,zt.primitiveLength+=vt.primitiveLength):zt={vertexOffset:vt.vertexOffset,primitiveLength:vt.primitiveLength,vertexLength:vt.vertexLength,primitiveOffset:vt.primitiveOffset,sortKey:void 0,vaos:{}}}return zt&&Fe.segments.push(zt),Fe}encodeCentroid(F,Ae){const Oe=F.centroid(),Fe=Ae.span(),Ve=Math.min(7,Math.round(Fe.x*this.tileToMeter/10)),qe=Math.min(7,Math.round(Fe.y*this.tileToMeter/10));return new Jl(Q(Oe.x,1,Vd-1)<<3|Ve,Q(Oe.y,1,Vd-1)<<3|qe)}encodeBorderCentroid(F){if(!F.borders)return new Jl(0,0);const Ae=F.borders,Oe=Number.MAX_VALUE;if(Ae[0][0]!==Oe||Ae[1][0]!==Oe){const F=Ae[0][0]!==Oe?0:1;return new Jl(6|(Ae[0][0]!==Oe?0:65528),(Ae[F][0]+Ae[F][1])/2<<3|6)}{const F=Ae[2][0]!==Oe?2:3;return new Jl((Ae[F][0]+Ae[F][1])/2<<3|6,6|(Ae[2][0]!==Oe?0:65528))}}showCentroid(F){const Ae=this.centroidData[F.centroidDataIndex];Ae.flags&=W_,Ae.centroidXY.x=0,Ae.centroidXY.y=0,this.writeCentroidToBuffer(Ae)}writeCentroidToBuffer(F){this.groundEffect.updateHiddenByLandmark(F);const Ae=F.vertexArrayOffset,Oe=F.vertexCount+F.vertexArrayOffset,Fe=F.flags&W_?H_:F.centroidXY,Ve=this.centroidVertexArray.geta_centroid_pos0(Ae);if(this.centroidVertexArray.geta_centroid_pos1(Ae)!==Fe.y||Ve!==Fe.x){for(let F=Ae;F<Oe;++F)this.centroidVertexArray.emplace(F,Fe.x,Fe.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const F of this.centroidData)this.writeCentroidToBuffer(F)}updateReplacement(F,Ae,Oe){if(Ae.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=Ae.updateTime;const Fe=Ae.getReplacementRegionsForTile(F.toUnwrapped());if(Ah(this.activeReplacements,Fe))return;if(this.activeReplacements=Fe,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const F of this.centroidData)F.flags&=2147483647;const Ve=[];for(const Ae of this.activeReplacements){if(Ae.order<Oe)continue;const Fe=Math.max(1,Math.pow(2,Ae.footprintTileId.canonical.z-F.canonical.z));for(const Oe of this.centroidData)if(!(Oe.flags&W_||Ae.min.x>Oe.max.x||Oe.min.x>Ae.max.x||Ae.min.y>Oe.max.y||Oe.min.y>Ae.max.y))for(let qe=0;qe<Oe.footprintSegLen;qe++){const pt=this.footprintSegments[Oe.footprintSegIdx+qe];if(Ve.length=0,op(this.footprintVertices,pt.vertexOffset,pt.vertexCount,Ae.footprintTileId.canonical,F.canonical,Ve),Ph(Ae.footprint,Ve,this.footprintIndices.uint16,pt.indexOffset,pt.indexCount,-pt.vertexOffset,-Fe)){Oe.flags|=W_;break}}}for(const F of this.centroidData)this.writeCentroidToBuffer(F);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(F,Ae,Oe){let Fe=!1;for(let Ve=0;Ve<Oe.footprintSegLen;Ve++){const qe=this.footprintSegments[Oe.footprintSegIdx+Ve];let pt=0;for(const Oe of qe.ringIndices){for(let Ve=pt,vt=Oe+pt-1;Ve<Oe+pt;vt=Ve++){const Oe=this.footprintVertices.int16[2*(Ve+qe.vertexOffset)+0],pt=this.footprintVertices.int16[2*(Ve+qe.vertexOffset)+1],zt=this.footprintVertices.int16[2*(vt+qe.vertexOffset)+1];pt>Ae!=zt>Ae&&F<(this.footprintVertices.int16[2*(vt+qe.vertexOffset)+0]-Oe)*(Ae-pt)/(zt-pt)+Oe&&(Fe=!Fe)}pt=Oe}}return Fe}getHeightAtTileCoord(F,Ae){let Oe=Number.NEGATIVE_INFINITY,Fe=!0;const Ve=4*(F+Vd)*Vd+(Ae+Vd);if(this.partLookup.hasOwnProperty(Ve)){const F=this.partLookup[Ve];return F?{height:F.height,hidden:!!(F.flags&W_)}:void 0}for(const qe of this.centroidData)F>qe.max.x||qe.min.x>F||Ae>qe.max.y||qe.min.y>Ae||this.footprintContainsPoint(F,Ae,qe)&&qe&&qe.height>Oe&&(Oe=qe.height,this.partLookup[Ve]=qe,Fe=!!(qe.flags&W_));if(Oe!==Number.NEGATIVE_INFINITY)return{height:Oe,hidden:Fe};this.partLookup[Ve]=void 0}}function Jh(F,Ae){const Oe=F.add(Ae)._unit();return F.x*Oe.x+F.y*Oe.y}function Qh(F,Ae,Oe,Fe){const Ve=Ae.sub(F)._perp()._unit(),qe=Oe.sub(Ae)._perp()._unit();return tp(F,Ae,Oe,Jh(Ve,qe),Fe)}function tp(F,Ae,Oe,Fe,Ve){const qe=Math.sqrt(1-Fe*Fe);return Math.min(F.dist(Ae)/3,Ae.dist(Oe)/3,Ve*qe/Fe)}function ep(F,Ae,Oe){return F.x<Oe[0].x&&Ae.x<Oe[0].x||F.x>Oe[1].x&&Ae.x>Oe[1].x||F.y<Oe[0].y&&Ae.y<Oe[0].y||F.y>Oe[1].y&&Ae.y>Oe[1].y}function rp(F,Ae){return F.x<Ae[0].x||F.x>Ae[1].x||F.y<Ae[0].y||F.y>Ae[1].y}function np(F,Ae,Oe){if(F.x<0||F.x>=Vd||Ae.x<0||Ae.x>=Vd||Oe.x<0||Oe.x>=Vd)return!1;const Fe=Oe.sub(Ae),Ve=Fe.perp(),qe=F.sub(Ae);return(Fe.x*qe.x+Fe.y*qe.y)/Math.sqrt((Fe.x*Fe.x+Fe.y*Fe.y)*(qe.x*qe.x+qe.y*qe.y))>-.866&&Ve.x*qe.x+Ve.y*qe.y<0}function ip(F,Ae,Oe){const Fe=Ae?2|F:-3&F;return Oe?1|Fe:-2&Fe}function ap(){const F=Math.PI/32,Ae=Math.tan(F),Oe=Am;return Oe*Math.sqrt(1+2*Ae*Ae)-Oe}function sp(F,Ae,Oe){const Fe=1<<Oe.z,Ve=pl(Oe.x/Fe),qe=pl((Oe.x+1)/Fe),pt=fl(Oe.y/Fe),vt=fl((Oe.y+1)/Fe);return function(F,Ae,Oe,Fe,Ve=0,qe){const pt=[];if(!F.length||!Oe||!Fe)return pt;const o=(F,Ae)=>{for(const Oe of F)pt.push({polygon:Oe,bounds:Ae})},vt=Math.ceil(Math.log2(Oe)),zt=Math.ceil(Math.log2(Fe)),ri=vt-zt,xi=[];for(let F=0;F<Math.abs(ri);F++)xi.push(ri>0?0:1);for(let F=0;F<Math.min(vt,zt);F++)xi.push(0),xi.push(1);let bi=F;if(bi=yh(bi,Ae[0].y-Ve,Ae[1].y+Ve,1),bi=yh(bi,Ae[0].x-Ve,Ae[1].x+Ve,0),!bi.length)return pt;const wi=[];for(xi.length?wi.push({polygons:bi,bounds:Ae,depth:0}):o(bi,Ae);wi.length;){const F=wi.pop(),Ae=F.depth,Oe=xi[Ae],Fe=F.bounds[0],pt=F.bounds[1],vt=0===Oe?Fe.x:Fe.y,zt=0===Oe?pt.x:pt.y,ri=qe?qe(Oe,vt,zt):.5*(vt+zt),bi=yh(F.polygons,vt-Ve,ri+Ve,Oe),dr=yh(F.polygons,ri-Ve,zt+Ve,Oe);if(bi.length){const F=[Fe,new Jl(0===Oe?ri:pt.x,1===Oe?ri:pt.y)];xi.length>Ae+1?wi.push({polygons:bi,bounds:F,depth:Ae+1}):o(bi,F)}if(dr.length){const F=[new Jl(0===Oe?ri:Fe.x,1===Oe?ri:Fe.y),pt];xi.length>Ae+1?wi.push({polygons:dr,bounds:F,depth:Ae+1}):o(dr,F)}}return pt}(F,Ae,Math.ceil((qe-Ve)/11.25),Math.ceil((pt-vt)/11.25),1,((F,Ae,Ve)=>{if(0===F)return.5*(Ae+Ve);{const F=fl((Oe.y+Ae/Vd)/Fe);return(cl(.5*(fl((Oe.y+Ve/Vd)/Fe)+F))*Fe-Oe.y)*Vd}}))}function op(F,Ae,Oe,Fe,Ve,qe){const pt=Math.pow(2,Fe.z-Ve.z);for(let vt=0;vt<Oe;vt++){let Oe=F.int16[2*(vt+Ae)+0],zt=F.int16[2*(vt+Ae)+1];Oe=(Oe+Ve.x*Vd)*pt-Fe.x*Vd,zt=(zt+Ve.y*Vd)*pt-Fe.y*Vd,qe.push(new Jl(Oe,zt))}}let Y_,K_;function cp(F,Ae){return F.x*Ae.x+F.y*Ae.y}function hp(F,Ae){if(1===F.length){let Oe=0;const Fe=Ae[Oe++];let Ve;for(;!Ve||Fe.equals(Ve);)if(Ve=Ae[Oe++],!Ve)return 1/0;for(;Oe<Ae.length;Oe++){const qe=Ae[Oe],pt=F[0],vt=Ve.sub(Fe),zt=qe.sub(Fe),ri=pt.sub(Fe),xi=cp(vt,vt),bi=cp(vt,zt),wi=cp(zt,zt),dr=cp(ri,vt),jr=cp(ri,zt),Qr=xi*wi-bi*bi,Xn=(wi*dr-bi*jr)/Qr,ho=(xi*jr-bi*dr)/Qr,yo=Fe.z*(1-Xn-ho)+Ve.z*Xn+qe.z*ho;if(isFinite(yo))return yo}return 1/0}{let F=1/0;for(const Oe of Ae)F=Math.min(F,Oe.z);return F}}function pp(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=pt*Ve.getElevationAt(F,Ae,!0,!0),ri=0!==qe[0],xi=ri?0===qe[1]?pt*(qe[0]/7-450):pt*function(F,Ae,Oe){const Fe=Math.floor(Ae[0]/8),Ve=Math.floor(Ae[1]/8),qe=10*(Ae[0]-8*Fe),pt=10*(Ae[1]-8*Ve),vt=F.getElevationAt(Fe,Ve,!0,!0),zt=F.getMeterToDEM(Oe),ri=Math.floor(.5*(qe*zt-1)),xi=Math.floor(.5*(pt*zt-1)),bi=F.tileCoordToPixel(Fe,Ve),wi=2*ri+1,dr=2*xi+1,jr=function(F,Ae,Oe,Fe,Ve){return[F.getElevationAtPixel(Ae,Oe,!0),F.getElevationAtPixel(Ae+Ve,Oe,!0),F.getElevationAtPixel(Ae,Oe+Ve,!0),F.getElevationAtPixel(Ae+Fe,Oe+Ve,!0)]}(F,bi.x-ri,bi.y-xi,wi,dr),Qr=Math.abs(jr[0]-jr[1]),Xn=Math.abs(jr[2]-jr[3]),ho=Math.abs(jr[0]-jr[2])+Math.abs(jr[1]-jr[3]),yo=Math.min(.25,.5*zt*(Qr+Xn)/wi),zo=Math.min(.25,.5*zt*ho/dr);return vt+Math.max(yo*qe,zo*pt)}(Ve,qe,vt):zt;return{base:zt+(0===Oe?-1:Oe),top:ri?Math.max(xi+Fe,zt+Oe+2):zt+Fe}}oa(Kh,"FillExtrusionBucket",{omit:["layers","features"]}),oa(Gh,"PartData"),oa($h,"FootprintSegment"),oa(Yh,"BorderCentroidData"),oa(Wh,"GroundEffect");const J_=ys([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),Q_=ys([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:Cg}=J_,Zg=ys([{name:"a_packed",components:3,type:"Float32"}]),{members:Hg}=Zg,Wg=ys([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:Kg}=Wg;class bp{constructor(F,Ae){this.width=F,this.height=Ae,this.nextRow=0,this.image=new ac({width:F,height:Ae}),this.positions={},this.uploaded=!1}getDash(F,Ae){const Oe=this.getKey(F,Ae);return this.positions[Oe]}trim(){const F=this.width,Ae=this.height=st(this.nextRow);this.image.resize({width:F,height:Ae})}getKey(F,Ae){return F.join(",")+Ae}getDashRanges(F,Ae,Oe){const Fe=[];let Ve=F.length%2==1?-F[F.length-1]*Oe:0,qe=F[0]*Oe,pt=!0;Fe.push({left:Ve,right:qe,isDash:pt,zeroLength:0===F[0]});let vt=F[0];for(let Ae=1;Ae<F.length;Ae++){pt=!pt;const zt=F[Ae];Ve=vt*Oe,vt+=zt,qe=vt*Oe,Fe.push({left:Ve,right:qe,isDash:pt,zeroLength:0===zt})}return Fe}addRoundDash(F,Ae,Oe){const Fe=Ae/2;for(let Ae=-Oe;Ae<=Oe;Ae++){const Ve=this.width*(this.nextRow+Oe+Ae);let qe=0,pt=F[qe];for(let vt=0;vt<this.width;vt++){vt/pt.right>1&&(pt=F[++qe]);const zt=Math.abs(vt-pt.left),ri=Math.abs(vt-pt.right),xi=Math.min(zt,ri);let bi;const wi=Ae/Oe*(Fe+1);if(pt.isDash){const F=Fe-Math.abs(wi);bi=Math.sqrt(xi*xi+F*F)}else bi=Fe-Math.sqrt(xi*xi+wi*wi);this.image.data[Ve+vt]=Math.max(0,Math.min(255,bi+128))}}}addRegularDash(F,Ae){for(let Ae=F.length-1;Ae>=0;--Ae){const Oe=F[Ae],Fe=F[Ae+1];Oe.zeroLength?F.splice(Ae,1):Fe&&Fe.isDash===Oe.isDash&&(Fe.left=Oe.left,F.splice(Ae,1))}const Oe=F[0],Fe=F[F.length-1];Oe.isDash===Fe.isDash&&(Oe.left=Fe.left-this.width,Fe.right=Oe.right+this.width);const Ve=this.width*this.nextRow;let qe=0,pt=F[qe];for(let Oe=0;Oe<this.width;Oe++){Oe/pt.right>1&&(pt=F[++qe]);const Fe=Math.abs(Oe-pt.left),vt=Math.abs(Oe-pt.right),zt=Math.min(Fe,vt);this.image.data[Ve+Oe]=Math.max(0,Math.min(255,(pt.isDash?zt:-zt)+Ae+128))}}addDash(F,Ae){const Oe=this.getKey(F,Ae);if(this.positions[Oe])return this.positions[Oe];const Fe="round"===Ae,Ve=Fe?7:0,qe=2*Ve+1;if(this.nextRow+qe>this.height)return ft("LineAtlas out of space"),null;0===F.length&&F.push(1);let pt=0;for(let Ae=0;Ae<F.length;Ae++)F[Ae]<0&&(ft("Negative value is found in line dasharray, replacing values with 0"),F[Ae]=0),pt+=F[Ae];if(0!==pt){const Oe=this.width/pt,qe=this.getDashRanges(F,this.width,Oe);Fe?this.addRoundDash(qe,Oe,Ve):this.addRegularDash(qe,"square"===Ae?.5*Oe:0)}const vt=this.nextRow+Ve;this.nextRow+=qe;const zt={tl:[vt,Ve],br:[pt,0]};return this.positions[Oe]=zt,zt}}oa(bp,"LineAtlas");const Jg=N_.VectorTileFeature.types,Qg=Math.cos(Math.PI/180*37.5),ey=Math.cos(Math.PI/180*5);class Ap{constructor(F){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.zoom=F.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=F.overscaling,this.pixelRatio=F.pixelRatio,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.projection=F.projection,this.hasPattern=!1,this.hasZOffset=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((F=>{this.gradients[F.id]={}})),this.layoutVertexArray=new ws,this.layoutVertexArray2=new Ms,this.patternVertexArray=new Ms,this.indexArray=new Ls,this.programConfigurations=new No(F.layers,{zoom:F.zoom,lut:F.lut}),this.segments=new po,this.maxLineLength=0,this.zOffsetVertexArray=new Ms,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.tessellationStep=F.tessellationStep?F.tessellationStep:Vd/64}updateFootprints(F,Ae){}populate(F,Ae,Oe,Fe){this.hasPattern=Oc("line",this.layers,this.pixelRatio,Ae);const Ve=this.layers[0].layout.get("line-sort-key");this.tileToMeter=vl(Oe);const qe=this.layers[0].layout.get("line-z-offset"),pt=qe.isConstant()&&!qe.constantOr(0),vt=this.layers[0].layout.get("line-elevation-reference");this.hasZOffset="sea"===vt||"ground"===vt||!pt&&"none"===vt,this.hasZOffset&&"none"===vt&&ft(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`);const zt=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.hasZOffset&&void 0!==zt;const ri=[];for(const{feature:Ae,id:qe,index:pt,sourceLayerIndex:vt}of F){const F=this.layers[0]._featureFilter.needGeometry,zt=El(Ae,F);if(!this.layers[0]._featureFilter.filter(new Ca(this.zoom),zt,Oe))continue;const xi=Ve?Ve.evaluate(zt,{},Oe):void 0,bi={id:qe,properties:Ae.properties,type:Ae.type,sourceLayerIndex:vt,index:pt,geometry:F?zt.geometry:zl(Ae,Oe,Fe),patterns:{},sortKey:xi};ri.push(bi)}Ve&&ri.sort(((F,Ae)=>F.sortKey-Ae.sortKey));const{lineAtlas:xi,featureIndex:bi}=Ae,wi=this.addConstantDashes(xi);for(const Fe of ri){const{geometry:Ve,index:qe,sourceLayerIndex:pt}=Fe;if(wi&&this.addFeatureDashes(Fe,xi),this.hasPattern){const F=Nc("line",this.layers,Fe,this.zoom,this.pixelRatio,Ae);this.patternFeatures.push(F)}else this.addFeature(Fe,Ve,qe,Oe,xi.positions,Ae.availableImages,Ae.brightness);bi.insert(F[qe].feature,Ve,qe,pt,this.index)}}addConstantDashes(F){let Ae=!1;for(const Oe of this.layers){const Fe=Oe.paint.get("line-dasharray").value,Ve=Oe.layout.get("line-cap").value;if("constant"!==Fe.kind||"constant"!==Ve.kind)Ae=!0;else{const Ae=Ve.value,Oe=Fe.value;if(!Oe)continue;F.addDash(Oe,Ae)}}return Ae}addFeatureDashes(F,Ae){const Oe=this.zoom;for(const Fe of this.layers){const Ve=Fe.paint.get("line-dasharray").value,qe=Fe.layout.get("line-cap").value;if("constant"===Ve.kind&&"constant"===qe.kind)continue;let pt,vt;if("constant"===Ve.kind){if(pt=Ve.value,!pt)continue}else pt=Ve.evaluate({zoom:Oe},F);vt="constant"===qe.kind?qe.value:qe.evaluate({zoom:Oe},F),Ae.addDash(pt,vt),F.patterns[Fe.id]=Ae.getKey(pt,vt)}}update(F,Ae,Oe,Fe,Ve,qe,pt){this.programConfigurations.updatePaintArrays(F,Ae,Ve,Oe,Fe,qe,pt)}addFeatures(F,Ae,Oe,Fe,Ve,qe){for(const F of this.patternFeatures)this.addFeature(F,F.geometry,F.index,Ae,Oe,Fe,qe)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(F){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=F.createVertexBuffer(this.layoutVertexArray2,Hg)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=F.createVertexBuffer(this.patternVertexArray,Kg)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=F.createVertexBuffer(this.zOffsetVertexArray,Q_.members,!0)),this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,Cg),this.indexBuffer=F.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(F){if(F.properties&&F.properties.hasOwnProperty("mapbox_clip_start")&&F.properties.hasOwnProperty("mapbox_clip_end"))return{start:+F.properties.mapbox_clip_start,end:+F.properties.mapbox_clip_end}}addFeature(F,Ae,Oe,Fe,Ve,qe,pt){const vt=this.layers[0].layout,zt=vt.get("line-join").evaluate(F,{}),ri=vt.get("line-cap").evaluate(F,{}),xi=vt.get("line-miter-limit"),bi=vt.get("line-round-limit");this.lineClips=this.lineFeatureClips(F),this.lineFeature=F,this.zOffsetValue=vt.get("line-z-offset").value;const wi=this.layers[0].paint.get("line-width").value;"constant"!==wi.kind&&!1===wi.isLineProgressConstant&&(this.variableWidthValue=wi);for(const Oe of Ae)this.addLine(Oe,F,Fe,zt,ri,xi,bi);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Oe,Ve,qe,Fe,pt)}addLine(F,Ae,Oe,Fe,Ve,qe,pt){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const vt="none"===Fe;if(this.patternJoinNone=this.hasPattern&&vt,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Ae=0;Ae<F.length-1;Ae++)this.totalDistance+=F[Ae].dist(F[Ae+1]);this.totalFeatureLength=this.totalDistance/(this.lineClips.end-this.lineClips.start),this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const zt="Polygon"===Jg[Ae.type];let ri=F.length;for(;ri>=2&&F[ri-1].equals(F[ri-2]);)ri--;let xi=0;for(;xi<ri-1&&F[xi].equals(F[xi+1]);)xi++;if(ri<(zt?3:2))return;"bevel"===Fe&&(qe=1.05);const bi=this.segments.prepareSegment(10*ri,this.layoutVertexArray,this.indexArray);let wi,dr,jr,Qr,Xn,ho;this.e1=this.e2=-1,zt&&(wi=F[ri-2],Xn=F[xi].sub(wi)._unit()._perp());for(let Ae=xi;Ae<ri;Ae++){if(jr=Ae===ri-1?zt?F[xi+1]:void 0:F[Ae+1],jr&&F[Ae].equals(jr))continue;Xn&&(Qr=Xn),wi&&(dr=wi),wi=F[Ae],ho=this.evaluateLineProgressFeatures(dr?dr.dist(wi):0),Xn=jr?jr.sub(wi)._unit()._perp():Qr,Qr=Qr||Xn;const Oe=dr&&jr;let yo=Oe?Fe:zt||vt?"butt":Ve;const zo=Qr.x*Xn.x+Qr.y*Xn.y;if(vt){const t=function(F){if(F.patternJoinNone){const Ae=F.segmentPoints.length/2,Oe=F.lineSoFar-F.segmentStart;for(let Fe=0;Fe<Ae;++Fe){const Ae=F.segmentPoints[2*Fe+1],Ve=Math.round(F.segmentPoints[2*Fe])+.5+.25*Ae;F.patternVertexArray.emplaceBack(Ve,Oe,F.segmentStart),F.patternVertexArray.emplaceBack(Ve,Oe,F.segmentStart)}F.segmentPoints.length=0}F.e1=F.e2=-1};if(Oe&&zo<ey){this.updateDistance(dr,wi),this.addCurrentVertex(wi,Qr,1,1,bi,ho),t(this),this.addCurrentVertex(wi,Xn,-1,-1,bi,ho);continue}if(dr){if(!jr){this.updateDistance(dr,wi),this.addCurrentVertex(wi,Qr,1,1,bi,ho),t(this);continue}yo="miter"}}let ko=Qr.add(Xn);0===ko.x&&0===ko.y||ko._unit();const Uo=ko.x*Xn.x+ko.y*Xn.y,ia=0!==Uo?1/Uo:1/0,_a=2*Math.sqrt(2-2*Uo),Ma=Uo<Qg&&dr&&jr,Ea=Qr.x*Xn.y-Qr.y*Xn.x>0,Ia=this.overscaling<=16?15*Vd/(512*this.overscaling):0;if(Oe&&"round"===yo)if(ia<pt)yo="miter";else if(ia<=2){const F=Sp(wi,-10,Vd+10);yo=this.hasZOffset&&(F||this.hasCrossSlope)?"miter":"fakeround"}if("miter"===yo&&ia>qe&&(yo="bevel"),"bevel"===yo&&(ia>2&&(yo="flipbevel"),ia<qe&&(yo="miter")),dr&&!("miter"===yo&&Ma)&&this.updateDistance(dr,wi),"miter"===yo)if(Ma){const F=wi.dist(dr);if(F>2*Ia){const Ae=wi.sub(wi.sub(dr)._mult(Ia/F)._round());this.updateDistance(dr,Ae),this.addCurrentVertex(Ae,Qr,0,0,bi,ho),dr=Ae}this.updateDistance(dr,wi),ko._mult(ia),this.addCurrentVertex(wi,ko,0,0,bi,ho);const Ae=wi.dist(jr);if(Ae>2*Ia){const F=wi.add(jr.sub(wi)._mult(Ia/Ae)._round());this.updateDistance(wi,F),this.addCurrentVertex(F,Xn,0,0,bi,ho),wi=F}}else ko._mult(ia),this.addCurrentVertex(wi,ko,0,0,bi,ho);else if("flipbevel"===yo){if(ia>100)ko=Xn.mult(-1);else{const F=ia*Qr.add(Xn).mag()/Qr.sub(Xn).mag();ko._perp()._mult(F*(Ea?-1:1))}this.addCurrentVertex(wi,ko,0,0,bi,ho),this.addCurrentVertex(wi,ko.mult(-1),0,0,bi,ho)}else if("bevel"===yo||"fakeround"===yo){null!=ho&&dr&&this.addCurrentVertex(wi,Qr,-1,-1,bi,ho);const F=wi.dist(dr)<=2*Ia&&"bevel"!==yo,Ae=ko.mult(Ea?1:-1);Ae._mult(ia);const Oe=Xn.mult(Ea?-1:1),Fe=Qr.mult(Ea?-1:1),Ve=this.evaluateLineProgressFeatures(this.distance);if(null==ho&&(this.addHalfVertex(wi,Ae.x,Ae.y,!1,!Ea,0,bi,Ve),F||this.addHalfVertex(wi,Ae.x+2*Fe.x,Ae.y+2*Fe.y,!1,Ea,0,bi,Ve)),"fakeround"===yo){const F=Math.round(180*_a/Math.PI/20);this.addHalfVertex(wi,Fe.x,Fe.y,!1,Ea,0,bi,Ve);for(let Ae=0;Ae<F;Ae++){let qe=Ae/F;if(.5!==qe){const F=qe-.5;qe+=qe*F*(qe-1)*((1.0904+zo*(zo*(3.55645-1.43519*zo)-3.2452))*F*F+(.848013+zo*(.215638*zo-1.06021)))}const pt=Oe.sub(Fe)._mult(qe)._add(Fe)._unit();this.addHalfVertex(wi,pt.x,pt.y,!1,Ea,0,bi,Ve)}this.addHalfVertex(wi,Oe.x,Oe.y,!1,Ea,0,bi,Ve)}F||null!=ho||this.addHalfVertex(wi,Ae.x+2*Oe.x,Ae.y+2*Oe.y,!1,Ea,0,bi,Ve),null!=ho&&jr&&this.addCurrentVertex(wi,Xn,1,1,bi,ho)}else"butt"===yo?this.addCurrentVertex(wi,ko,0,0,bi,ho):"square"===yo?(dr||this.addCurrentVertex(wi,ko,-1,-1,bi,ho),this.addCurrentVertex(wi,ko,0,0,bi,ho),dr&&this.addCurrentVertex(wi,ko,1,1,bi,ho)):"round"===yo&&(dr&&(this.addCurrentVertex(wi,Qr,0,0,bi,ho),this.addCurrentVertex(wi,Qr,1,1,bi,ho,!0)),jr&&(this.addCurrentVertex(wi,Xn,-1,-1,bi,ho,!0),this.addCurrentVertex(wi,Xn,0,0,bi,ho)))}}addVerticesTo(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri){const xi=(Ae.w-F.w)/this.tessellationStep|0;let bi=0;const wi=this.scaledDistance;if(xi>1){this.lineSoFar=F.w;const wi=(Ae.x-F.x)/xi,dr=(Ae.y-F.y)/xi,jr=(Ae.z-F.z)/xi,Qr=(Ae.w-F.w)/xi;for(let Ae=1;Ae<xi;++Ae){F.x+=wi,F.y+=dr,F.z+=jr,this.lineSoFar+=Qr,bi+=Qr;const Ae=this.evaluateLineProgressFeatures(this.prevDistance+bi);this.scaledDistance=(this.prevDistance+bi)/this.totalDistance,this.addHalfVertex(F,Oe,Fe,ri,!1,pt,zt,Ae),this.addHalfVertex(F,Ve,qe,ri,!0,-vt,zt,Ae)}}this.lineSoFar=Ae.w,this.scaledDistance=wi;const dr=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(Ae,Oe,Fe,ri,!1,pt,zt,dr),this.addHalfVertex(Ae,Ve,qe,ri,!0,-vt,zt,dr)}evaluateLineProgressFeatures(F){if(!this.variableWidthValue&&!this.hasZOffset)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+F)/this.totalFeatureLength):ft(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let Ae=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(Ae=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.hasZOffset?"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:Ae}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:Ae}:{zOffset:0,variableWidth:Ae}}addCurrentVertex(F,Ae,Oe,Fe,Ve,qe,pt=!1){const vt=Ae.x+Ae.y*Oe,zt=Ae.y-Ae.x*Oe,ri=Ae.y*Fe-Ae.x,xi=-Ae.y-Ae.x*Fe;if(null!=qe){const Ae=this.hasZOffset,bi=-10,wi=Vd+10,dr=qe.zOffset,jr=new mh(F.x,F.y,dr,this.lineSoFar),Qr=!!Ae&&Sp(F,bi,wi),Xn=this.lineSoFar,ho=this.distance;if(this.currentVertex)if(Qr){const Ae=this.currentVertexIsOutside,qe=this.currentVertex,Qr=new mh(F.x,F.y,dr,this.lineSoFar);if(xh(qe,Qr,bi,wi),!Sp(Qr,bi,wi)){if(Ae){this.e1=this.e2=-1,this.distance-=qe.dist(jr),this.lineSoFar=qe.w;const F=this.evaluateLineProgressFeatures(qe.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(qe,vt,zt,pt,!1,Oe,Ve,F),this.addHalfVertex(qe,ri,xi,pt,!0,-Fe,Ve,F),this.prevDistance=this.distance}this.distance=this.prevDistance+qe.dist(Qr),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(qe,Qr,vt,zt,ri,xi,Oe,Fe,Ve,pt),this.distance=ho,this.scaledDistance=this.distance/this.totalDistance}}else{const F=this.currentVertex;if(this.currentVertexIsOutside){xh(F,jr,bi,wi),this.e1=this.e2=-1,this.distance-=F.dist(jr),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=F.w;const Ae=this.evaluateLineProgressFeatures(F.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(F,vt,zt,pt,!1,Oe,Ve,Ae),this.addHalfVertex(F,ri,xi,pt,!0,-Fe,Ve,Ae),this.prevDistance=this.distance,this.distance=ho,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(F,jr,vt,zt,ri,xi,Oe,Fe,Ve,pt)}else Qr||(this.addHalfVertex(F,vt,zt,pt,!1,Oe,Ve,qe),this.addHalfVertex(F,ri,xi,pt,!0,-Fe,Ve,qe));this.currentVertex=jr,this.currentVertexIsOutside=Qr,this.lineSoFar=Xn}else this.addHalfVertex(F,vt,zt,pt,!1,Oe,Ve,qe),this.addHalfVertex(F,ri,xi,pt,!0,-Fe,Ve,qe)}addHalfVertex({x:F,y:Ae},Oe,Fe,Ve,qe,pt,vt,zt){if(this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),qe||this.segmentPoints.push(this.lineSoFar-this.segmentStart,pt)),this.layoutVertexArray.emplaceBack((F<<1)+(Ve?1:0),(Ae<<1)+(qe?1:0),Math.round(63*Oe)+128,Math.round(63*Fe)+128,1+(0===pt?0:pt<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const F=ze(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,F)}const ri=vt.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,ri),vt.primitiveLength++),qe?this.e2=ri:this.e1=ri,null!=zt&&this.zOffsetVertexArray.emplaceBack(zt.zOffset,zt.variableWidth,zt.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(F,Ae){this.prevDistance=this.distance,this.distance+=F.dist(Ae),this.updateScaledDistance()}}function Sp(F,Ae,Oe){return F.x<Ae||F.x>Oe||F.y<Ae||F.y>Oe}let ty,ry;function zp(F,Ae,Oe){return Ae*(Vd/(F.tileSize*Math.pow(2,Oe-F.tileID.overscaledZ)))}oa(Ap,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Ep=(F,Ae,Oe)=>(1-Oe)*F+Oe*Ae;function kp(F,Ae){return 1/zp(F,1,Ae.tileZoom)}function Tp(F,Ae,Oe,Fe){return F.translatePosMatrix(Fe||Ae.tileID.projMatrix,Ae,Oe.paint.get("line-translate"),Oe.paint.get("line-translate-anchor"))}const Bp=F=>{const Ae=[];Cp(F)&&Ae.push("RENDER_LINE_DASH"),F.paint.get("line-gradient")&&Ae.push("RENDER_LINE_GRADIENT");const Oe=F.paint.get("line-trim-offset");0===Oe[0]&&0===Oe[1]||Ae.push("RENDER_LINE_TRIM_OFFSET"),0!==F.paint.get("line-border-width").constantOr(1)&&Ae.push("RENDER_LINE_BORDER");const Fe="none"===F.layout.get("line-join").constantOr("miter"),Ve=!!F.paint.get("line-pattern").constantOr(1);return Fe&&Ve&&Ae.push("LINE_JOIN_NONE"),Ae};function Cp(F){const Ae=F.paint.get("line-dasharray").value;return Ae.value||"constant"!==Ae.kind}let cy;const Dp=()=>cy||(cy={layout:ty||(ty=new Ga({"line-cap":new qa(pf.layout_line["line-cap"]),"line-join":new qa(pf.layout_line["line-join"]),"line-miter-limit":new ja(pf.layout_line["line-miter-limit"]),"line-round-limit":new ja(pf.layout_line["line-round-limit"]),"line-sort-key":new qa(pf.layout_line["line-sort-key"]),"line-z-offset":new qa(pf.layout_line["line-z-offset"]),"line-elevation-reference":new ja(pf.layout_line["line-elevation-reference"]),"line-cross-slope":new ja(pf.layout_line["line-cross-slope"]),visibility:new ja(pf.layout_line.visibility),"line-width-unit":new ja(pf.layout_line["line-width-unit"])})),paint:ry||(ry=new Ga({"line-opacity":new qa(pf.paint_line["line-opacity"]),"line-color":new qa(pf.paint_line["line-color"]),"line-translate":new ja(pf.paint_line["line-translate"]),"line-translate-anchor":new ja(pf.paint_line["line-translate-anchor"]),"line-width":new qa(pf.paint_line["line-width"]),"line-gap-width":new qa(pf.paint_line["line-gap-width"]),"line-offset":new qa(pf.paint_line["line-offset"]),"line-blur":new qa(pf.paint_line["line-blur"]),"line-dasharray":new qa(pf.paint_line["line-dasharray"]),"line-pattern":new qa(pf.paint_line["line-pattern"]),"line-gradient":new $a(pf.paint_line["line-gradient"]),"line-trim-offset":new ja(pf.paint_line["line-trim-offset"]),"line-trim-fade-range":new ja(pf.paint_line["line-trim-fade-range"]),"line-trim-color":new ja(pf.paint_line["line-trim-color"]),"line-emissive-strength":new ja(pf.paint_line["line-emissive-strength"]),"line-border-width":new qa(pf.paint_line["line-border-width"]),"line-border-color":new qa(pf.paint_line["line-border-color"]),"line-occlusion-opacity":new ja(pf.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},cy);class Lp extends qa{possiblyEvaluate(F,Ae){return Ae=new Ca(Math.floor(Ae.zoom),{now:Ae.now,fadeDuration:Ae.fadeDuration,transition:Ae.transition}),super.possiblyEvaluate(F,Ae)}evaluate(F,Ae,Oe,Fe){return Ae=nt({},Ae,{zoom:Math.floor(Ae.zoom)}),super.evaluate(F,Ae,Oe,Fe)}}let hy;function Fp(F,Ae){return Ae>0?Ae+2*F:F}const dy=ys([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),_y=ys([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Sy=ys([{name:"a_projected_pos",components:4,type:"Float32"}],4);ys([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Ey=ys([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Iy=ys([{name:"a_texb",components:2,type:"Uint16"}]),Cy=ys([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),Dy=ys([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);ys([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Ry=ys([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Ly=ys([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ys([{name:"triangle",components:3,type:"Uint16"}]),ys([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ys([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),ys([{type:"Float32",name:"offsetX"}]),ys([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var ky=24;const Fy=128;function Wp(F,Ae,Oe,Fe,Ve){if("camera"===F.kind)return F.maxSize;if("composite"===F.kind){const Fe=Ae.possiblyEvaluate(new Ca(F.maxZoom),Oe).evaluate(Ve,{},Oe),qe=Ae.possiblyEvaluate(new Ca(F.minZoom),Oe).evaluate(Ve,{},Oe);return Math.max(Fe,qe)}return Ae.possiblyEvaluate(new Ca(Fe)).evaluate(Ve,{},Oe)}function Kp(F,Ae){const{expression:Oe}=Ae;if("constant"===Oe.kind)return{kind:"constant",layoutSize:Oe.evaluate(new Ca(F+1))};if("source"===Oe.kind)return{kind:"source"};{const{zoomStops:Ae,interpolationType:Fe}=Oe;let Ve=0;for(;Ve<Ae.length&&Ae[Ve]<=F;)Ve++;Ve=Math.max(0,Ve-1);let qe=Ve;for(;qe<Ae.length&&Ae[qe]<F+1;)qe++;qe=Math.min(Ae.length-1,qe);const pt=Ae[Ve],vt=Ae[qe];return"composite"===Oe.kind?{kind:"composite",minZoom:pt,maxZoom:vt,interpolationType:Fe}:{kind:"camera",minZoom:pt,maxZoom:vt,minSize:Oe.evaluate(new Ca(pt)),maxSize:Oe.evaluate(new Ca(vt)),interpolationType:Fe}}}function Jp(F,{uSize:Ae,uSizeT:Oe},{lowerSize:Fe,upperSize:Ve}){return"source"===F.kind?Fe/Fy:"composite"===F.kind?ze(Fe/Fy,Ve/Fy,Oe):Ae}function Qp(F,Ae,Oe=1){let Fe=0,Ve=0;if("constant"===F.kind)Ve=F.layoutSize*Oe;else if("source"!==F.kind){const{interpolationType:qe,minZoom:pt,maxZoom:vt}=F,zt=qe?Q(ai.interpolationFactor(qe,Ae,pt,vt),0,1):0;"camera"===F.kind?Ve=ze(F.minSize,F.maxSize,zt)*Oe:Fe=zt*Oe}return{uSizeT:Fe,uSize:Ve}}var By=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Fy,evaluateSizeForFeature:Jp,evaluateSizeForZoom:Qp,getRasterizedIconSize:Wp,getSizeData:Kp});function ef(F,Ae,Oe){return F.sections.forEach((F=>{F.text=function(F,Ae,Oe){const Fe=Ae.layout.get("text-transform").evaluate(Oe,{});return"uppercase"===Fe?F=F.toLocaleUpperCase():"lowercase"===Fe&&(F=F.toLocaleLowerCase()),uf.applyArabicShaping&&(F=uf.applyArabicShaping(F)),F}(F.text,Ae,Oe)})),F}const Vy={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function nf(F){return""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F}function af(F){return""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F}var ex,ix,rx,nx={};function cf(){return ex||(ex=1,nx.read=function(F,Ae,Oe,Fe,Ve){var qe,pt,vt=8*Ve-Fe-1,zt=(1<<vt)-1,ri=zt>>1,xi=-7,bi=Oe?Ve-1:0,wi=Oe?-1:1,dr=F[Ae+bi];for(bi+=wi,qe=dr&(1<<-xi)-1,dr>>=-xi,xi+=vt;xi>0;qe=256*qe+F[Ae+bi],bi+=wi,xi-=8);for(pt=qe&(1<<-xi)-1,qe>>=-xi,xi+=Fe;xi>0;pt=256*pt+F[Ae+bi],bi+=wi,xi-=8);if(0===qe)qe=1-ri;else{if(qe===zt)return pt?NaN:1/0*(dr?-1:1);pt+=Math.pow(2,Fe),qe-=ri}return(dr?-1:1)*pt*Math.pow(2,qe-Fe)},nx.write=function(F,Ae,Oe,Fe,Ve,qe){var pt,vt,zt,ri=8*qe-Ve-1,xi=(1<<ri)-1,bi=xi>>1,wi=23===Ve?Math.pow(2,-24)-Math.pow(2,-77):0,dr=Fe?0:qe-1,jr=Fe?1:-1,Qr=Ae<0||0===Ae&&1/Ae<0?1:0;for(Ae=Math.abs(Ae),isNaN(Ae)||Ae===1/0?(vt=isNaN(Ae)?1:0,pt=xi):(pt=Math.floor(Math.log(Ae)/Math.LN2),Ae*(zt=Math.pow(2,-pt))<1&&(pt--,zt*=2),(Ae+=pt+bi>=1?wi/zt:wi*Math.pow(2,1-bi))*zt>=2&&(pt++,zt/=2),pt+bi>=xi?(vt=0,pt=xi):pt+bi>=1?(vt=(Ae*zt-1)*Math.pow(2,Ve),pt+=bi):(vt=Ae*Math.pow(2,bi-1)*Math.pow(2,Ve),pt=0));Ve>=8;F[Oe+dr]=255&vt,dr+=jr,vt/=256,Ve-=8);for(pt=pt<<Ve|vt,ri+=Ve;ri>0;F[Oe+dr]=255&pt,dr+=jr,pt/=256,ri-=8);F[Oe+dr-jr]|=128*Qr}),nx}function hf(){if(rx)return ix;rx=1,ix=e;var Ae=cf();function e(Ae){(this||F).buf=ArrayBuffer.isView&&ArrayBuffer.isView(Ae)?Ae:new Uint8Array(Ae||0),(this||F).pos=0,(this||F).type=0,(this||F).length=(this||F).buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var Oe=4294967296,Fe=1/Oe,Ve="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function a(F){return F.type===e.Bytes?F.readVarint()+F.pos:F.pos+1}function s(F,Ae,Oe){return Oe?4294967296*Ae+(F>>>0):4294967296*(Ae>>>0)+(F>>>0)}function o(F,Ae,Oe){var Fe=Ae<=16383?1:Ae<=2097151?2:Ae<=268435455?3:Math.floor(Math.log(Ae)/(7*Math.LN2));Oe.realloc(Fe);for(var Ve=Oe.pos-1;Ve>=F;Ve--)Oe.buf[Ve+Fe]=Oe.buf[Ve]}function l(F,Ae){for(var Oe=0;Oe<F.length;Oe++)Ae.writeVarint(F[Oe])}function u(F,Ae){for(var Oe=0;Oe<F.length;Oe++)Ae.writeSVarint(F[Oe])}function c(F,Ae){for(var Oe=0;Oe<F.length;Oe++)Ae.writeFloat(F[Oe])}function h(F,Ae){for(var Oe=0;Oe<F.length;Oe++)Ae.writeDouble(F[Oe])}function p(F,Ae){for(var Oe=0;Oe<F.length;Oe++)Ae.writeBoolean(F[Oe])}function f(F,Ae){for(var Oe=0;Oe<F.length;Oe++)Ae.writeFixed32(F[Oe])}function d(F,Ae){for(var Oe=0;Oe<F.length;Oe++)Ae.writeSFixed32(F[Oe])}function m(F,Ae){for(var Oe=0;Oe<F.length;Oe++)Ae.writeFixed64(F[Oe])}function y(F,Ae){for(var Oe=0;Oe<F.length;Oe++)Ae.writeSFixed64(F[Oe])}function g(F,Ae){return(F[Ae]|F[Ae+1]<<8|F[Ae+2]<<16)+16777216*F[Ae+3]}function x(F,Ae,Oe){F[Oe]=Ae,F[Oe+1]=Ae>>>8,F[Oe+2]=Ae>>>16,F[Oe+3]=Ae>>>24}function v(F,Ae){return(F[Ae]|F[Ae+1]<<8|F[Ae+2]<<16)+(F[Ae+3]<<24)}return e.prototype={destroy:function(){(this||F).buf=null},readFields:function(Ae,Oe,Fe){for(Fe=Fe||(this||F).length;(this||F).pos<Fe;){var Ve=this.readVarint(),qe=Ve>>3,pt=(this||F).pos;(this||F).type=7&Ve,Ae(qe,Oe,this||F),(this||F).pos===pt&&this.skip(Ve)}return Oe},readMessage:function(Ae,Oe){return this.readFields(Ae,Oe,this.readVarint()+(this||F).pos)},readFixed32:function(){var Ae=g((this||F).buf,(this||F).pos);return(this||F).pos+=4,Ae},readSFixed32:function(){var Ae=v((this||F).buf,(this||F).pos);return(this||F).pos+=4,Ae},readFixed64:function(){var Ae=g((this||F).buf,(this||F).pos)+g((this||F).buf,(this||F).pos+4)*Oe;return(this||F).pos+=8,Ae},readSFixed64:function(){var Ae=g((this||F).buf,(this||F).pos)+v((this||F).buf,(this||F).pos+4)*Oe;return(this||F).pos+=8,Ae},readFloat:function(){var Oe=Ae.read((this||F).buf,(this||F).pos,!0,23,4);return(this||F).pos+=4,Oe},readDouble:function(){var Oe=Ae.read((this||F).buf,(this||F).pos,!0,52,8);return(this||F).pos+=8,Oe},readVarint:function(Ae){var Oe,Fe,Ve=(this||F).buf;return Oe=127&(Fe=Ve[(this||F).pos++]),Fe<128?Oe:(Oe|=(127&(Fe=Ve[(this||F).pos++]))<<7,Fe<128?Oe:(Oe|=(127&(Fe=Ve[(this||F).pos++]))<<14,Fe<128?Oe:(Oe|=(127&(Fe=Ve[(this||F).pos++]))<<21,Fe<128?Oe:function(F,Ae,Oe){var Fe,Ve,qe=Oe.buf;if(Fe=(112&(Ve=qe[Oe.pos++]))>>4,Ve<128)return s(F,Fe,Ae);if(Fe|=(127&(Ve=qe[Oe.pos++]))<<3,Ve<128)return s(F,Fe,Ae);if(Fe|=(127&(Ve=qe[Oe.pos++]))<<10,Ve<128)return s(F,Fe,Ae);if(Fe|=(127&(Ve=qe[Oe.pos++]))<<17,Ve<128)return s(F,Fe,Ae);if(Fe|=(127&(Ve=qe[Oe.pos++]))<<24,Ve<128)return s(F,Fe,Ae);if(Fe|=(1&(Ve=qe[Oe.pos++]))<<31,Ve<128)return s(F,Fe,Ae);throw new Error("Expected varint not more than 10 bytes")}(Oe|=(15&(Fe=Ve[(this||F).pos]))<<28,Ae,this||F))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var F=this.readVarint();return F%2==1?(F+1)/-2:F/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var Ae=this.readVarint()+(this||F).pos,Oe=(this||F).pos;return(this||F).pos=Ae,Ae-Oe>=12&&Ve?function(F,Ae,Oe){return Ve.decode(F.subarray(Ae,Oe))}((this||F).buf,Oe,Ae):function(F,Ae,Oe){for(var Fe="",Ve=Ae;Ve<Oe;){var qe,pt,vt,zt=F[Ve],ri=null,xi=zt>239?4:zt>223?3:zt>191?2:1;if(Ve+xi>Oe)break;1===xi?zt<128&&(ri=zt):2===xi?128==(192&(qe=F[Ve+1]))&&(ri=(31&zt)<<6|63&qe)<=127&&(ri=null):3===xi?(pt=F[Ve+2],128==(192&(qe=F[Ve+1]))&&128==(192&pt)&&((ri=(15&zt)<<12|(63&qe)<<6|63&pt)<=2047||ri>=55296&&ri<=57343)&&(ri=null)):4===xi&&(pt=F[Ve+2],vt=F[Ve+3],128==(192&(qe=F[Ve+1]))&&128==(192&pt)&&128==(192&vt)&&((ri=(15&zt)<<18|(63&qe)<<12|(63&pt)<<6|63&vt)<=65535||ri>=1114112)&&(ri=null)),null===ri?(ri=65533,xi=1):ri>65535&&(ri-=65536,Fe+=String.fromCharCode(ri>>>10&1023|55296),ri=56320|1023&ri),Fe+=String.fromCharCode(ri),Ve+=xi}return Fe}((this||F).buf,Oe,Ae)},readBytes:function(){var Ae=this.readVarint()+(this||F).pos,Oe=(this||F).buf.subarray((this||F).pos,Ae);return(this||F).pos=Ae,Oe},readPackedVarint:function(Ae,Oe){if((this||F).type!==e.Bytes)return Ae.push(this.readVarint(Oe));var Fe=a(this||F);for(Ae=Ae||[];(this||F).pos<Fe;)Ae.push(this.readVarint(Oe));return Ae},readPackedSVarint:function(Ae){if((this||F).type!==e.Bytes)return Ae.push(this.readSVarint());var Oe=a(this||F);for(Ae=Ae||[];(this||F).pos<Oe;)Ae.push(this.readSVarint());return Ae},readPackedBoolean:function(Ae){if((this||F).type!==e.Bytes)return Ae.push(this.readBoolean());var Oe=a(this||F);for(Ae=Ae||[];(this||F).pos<Oe;)Ae.push(this.readBoolean());return Ae},readPackedFloat:function(Ae){if((this||F).type!==e.Bytes)return Ae.push(this.readFloat());var Oe=a(this||F);for(Ae=Ae||[];(this||F).pos<Oe;)Ae.push(this.readFloat());return Ae},readPackedDouble:function(Ae){if((this||F).type!==e.Bytes)return Ae.push(this.readDouble());var Oe=a(this||F);for(Ae=Ae||[];(this||F).pos<Oe;)Ae.push(this.readDouble());return Ae},readPackedFixed32:function(Ae){if((this||F).type!==e.Bytes)return Ae.push(this.readFixed32());var Oe=a(this||F);for(Ae=Ae||[];(this||F).pos<Oe;)Ae.push(this.readFixed32());return Ae},readPackedSFixed32:function(Ae){if((this||F).type!==e.Bytes)return Ae.push(this.readSFixed32());var Oe=a(this||F);for(Ae=Ae||[];(this||F).pos<Oe;)Ae.push(this.readSFixed32());return Ae},readPackedFixed64:function(Ae){if((this||F).type!==e.Bytes)return Ae.push(this.readFixed64());var Oe=a(this||F);for(Ae=Ae||[];(this||F).pos<Oe;)Ae.push(this.readFixed64());return Ae},readPackedSFixed64:function(Ae){if((this||F).type!==e.Bytes)return Ae.push(this.readSFixed64());var Oe=a(this||F);for(Ae=Ae||[];(this||F).pos<Oe;)Ae.push(this.readSFixed64());return Ae},skip:function(Ae){var Oe=7&Ae;if(Oe===e.Varint)for(;(this||F).buf[(this||F).pos++]>127;);else if(Oe===e.Bytes)(this||F).pos=this.readVarint()+(this||F).pos;else if(Oe===e.Fixed32)(this||F).pos+=4;else{if(Oe!==e.Fixed64)throw new Error("Unimplemented type: "+Oe);(this||F).pos+=8}},writeTag:function(F,Ae){this.writeVarint(F<<3|Ae)},realloc:function(Ae){for(var Oe=(this||F).length||16;Oe<(this||F).pos+Ae;)Oe*=2;if(Oe!==(this||F).length){var Fe=new Uint8Array(Oe);Fe.set((this||F).buf),(this||F).buf=Fe,(this||F).length=Oe}},finish:function(){return(this||F).length=(this||F).pos,(this||F).pos=0,(this||F).buf.subarray(0,(this||F).length)},writeFixed32:function(Ae){this.realloc(4),x((this||F).buf,Ae,(this||F).pos),(this||F).pos+=4},writeSFixed32:function(Ae){this.realloc(4),x((this||F).buf,Ae,(this||F).pos),(this||F).pos+=4},writeFixed64:function(Ae){this.realloc(8),x((this||F).buf,-1&Ae,(this||F).pos),x((this||F).buf,Math.floor(Ae*Fe),(this||F).pos+4),(this||F).pos+=8},writeSFixed64:function(Ae){this.realloc(8),x((this||F).buf,-1&Ae,(this||F).pos),x((this||F).buf,Math.floor(Ae*Fe),(this||F).pos+4),(this||F).pos+=8},writeVarint:function(Ae){(Ae=+Ae||0)>268435455||Ae<0?function(F,Ae){var Oe,Fe;if(F>=0?(Oe=F%4294967296|0,Fe=F/4294967296|0):(Fe=~(-F/4294967296),4294967295^(Oe=~(-F%4294967296))?Oe=Oe+1|0:(Oe=0,Fe=Fe+1|0)),F>=0x10000000000000000||F<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");Ae.realloc(10),function(F,Ae,Oe){Oe.buf[Oe.pos++]=127&F|128,F>>>=7,Oe.buf[Oe.pos++]=127&F|128,F>>>=7,Oe.buf[Oe.pos++]=127&F|128,F>>>=7,Oe.buf[Oe.pos++]=127&F|128,Oe.buf[Oe.pos]=127&(F>>>=7)}(Oe,0,Ae),function(F,Ae){var Oe=(7&F)<<4;Ae.buf[Ae.pos++]|=Oe|((F>>>=3)?128:0),F&&(Ae.buf[Ae.pos++]=127&F|((F>>>=7)?128:0),F&&(Ae.buf[Ae.pos++]=127&F|((F>>>=7)?128:0),F&&(Ae.buf[Ae.pos++]=127&F|((F>>>=7)?128:0),F&&(Ae.buf[Ae.pos++]=127&F|((F>>>=7)?128:0),F&&(Ae.buf[Ae.pos++]=127&F)))))}(Fe,Ae)}(Ae,this||F):(this.realloc(4),(this||F).buf[(this||F).pos++]=127&Ae|(Ae>127?128:0),Ae<=127||((this||F).buf[(this||F).pos++]=127&(Ae>>>=7)|(Ae>127?128:0),Ae<=127||((this||F).buf[(this||F).pos++]=127&(Ae>>>=7)|(Ae>127?128:0),Ae<=127||((this||F).buf[(this||F).pos++]=Ae>>>7&127))))},writeSVarint:function(F){this.writeVarint(F<0?2*-F-1:2*F)},writeBoolean:function(F){this.writeVarint(Boolean(F))},writeString:function(Ae){Ae=String(Ae),this.realloc(4*Ae.length),(this||F).pos++;var Oe=(this||F).pos;(this||F).pos=function(F,Ae,Oe){for(var Fe,Ve,qe=0;qe<Ae.length;qe++){if((Fe=Ae.charCodeAt(qe))>55295&&Fe<57344){if(!Ve){Fe>56319||qe+1===Ae.length?(F[Oe++]=239,F[Oe++]=191,F[Oe++]=189):Ve=Fe;continue}if(Fe<56320){F[Oe++]=239,F[Oe++]=191,F[Oe++]=189,Ve=Fe;continue}Fe=Ve-55296<<10|Fe-56320|65536,Ve=null}else Ve&&(F[Oe++]=239,F[Oe++]=191,F[Oe++]=189,Ve=null);Fe<128?F[Oe++]=Fe:(Fe<2048?F[Oe++]=Fe>>6|192:(Fe<65536?F[Oe++]=Fe>>12|224:(F[Oe++]=Fe>>18|240,F[Oe++]=Fe>>12&63|128),F[Oe++]=Fe>>6&63|128),F[Oe++]=63&Fe|128)}return Oe}((this||F).buf,Ae,(this||F).pos);var Fe=(this||F).pos-Oe;Fe>=128&&o(Oe,Fe,this||F),(this||F).pos=Oe-1,this.writeVarint(Fe),(this||F).pos+=Fe},writeFloat:function(Oe){this.realloc(4),Ae.write((this||F).buf,Oe,(this||F).pos,!0,23,4),(this||F).pos+=4},writeDouble:function(Oe){this.realloc(8),Ae.write((this||F).buf,Oe,(this||F).pos,!0,52,8),(this||F).pos+=8},writeBytes:function(Ae){var Oe=Ae.length;this.writeVarint(Oe),this.realloc(Oe);for(var Fe=0;Fe<Oe;Fe++)(this||F).buf[(this||F).pos++]=Ae[Fe]},writeRawMessage:function(Ae,Oe){(this||F).pos++;var Fe=(this||F).pos;Ae(Oe,this||F);var Ve=(this||F).pos-Fe;Ve>=128&&o(Fe,Ve,this||F),(this||F).pos=Fe-1,this.writeVarint(Ve),(this||F).pos+=Ve},writeMessage:function(F,Ae,Oe){this.writeTag(F,e.Bytes),this.writeRawMessage(Ae,Oe)},writePackedVarint:function(F,Ae){Ae.length&&this.writeMessage(F,l,Ae)},writePackedSVarint:function(F,Ae){Ae.length&&this.writeMessage(F,u,Ae)},writePackedBoolean:function(F,Ae){Ae.length&&this.writeMessage(F,p,Ae)},writePackedFloat:function(F,Ae){Ae.length&&this.writeMessage(F,c,Ae)},writePackedDouble:function(F,Ae){Ae.length&&this.writeMessage(F,h,Ae)},writePackedFixed32:function(F,Ae){Ae.length&&this.writeMessage(F,f,Ae)},writePackedSFixed32:function(F,Ae){Ae.length&&this.writeMessage(F,d,Ae)},writePackedFixed64:function(F,Ae){Ae.length&&this.writeMessage(F,m,Ae)},writePackedSFixed64:function(F,Ae){Ae.length&&this.writeMessage(F,y,Ae)},writeBytesField:function(F,Ae){this.writeTag(F,e.Bytes),this.writeBytes(Ae)},writeFixed32Field:function(F,Ae){this.writeTag(F,e.Fixed32),this.writeFixed32(Ae)},writeSFixed32Field:function(F,Ae){this.writeTag(F,e.Fixed32),this.writeSFixed32(Ae)},writeFixed64Field:function(F,Ae){this.writeTag(F,e.Fixed64),this.writeFixed64(Ae)},writeSFixed64Field:function(F,Ae){this.writeTag(F,e.Fixed64),this.writeSFixed64(Ae)},writeVarintField:function(F,Ae){this.writeTag(F,e.Varint),this.writeVarint(Ae)},writeSVarintField:function(F,Ae){this.writeTag(F,e.Varint),this.writeSVarint(Ae)},writeStringField:function(F,Ae){this.writeTag(F,e.Bytes),this.writeString(Ae)},writeFloatField:function(F,Ae){this.writeTag(F,e.Fixed32),this.writeFloat(Ae)},writeDoubleField:function(F,Ae){this.writeTag(F,e.Fixed64),this.writeDouble(Ae)},writeBooleanField:function(F,Ae){this.writeVarintField(F,Boolean(Ae))}},ix}var ox=e(hf());const sx=3;function df(F,Ae,Oe){Ae.glyphs=[],1===F&&Oe.readMessage(mf,Ae)}function mf(F,Ae,Oe){if(3===F){const{id:F,bitmap:Fe,width:Ve,height:qe,left:pt,top:vt,advance:zt}=Oe.readMessage(yf,{});Ae.glyphs.push({id:F,bitmap:new ac({width:Ve+2*sx,height:qe+2*sx},Fe),metrics:{width:Ve,height:qe,left:pt,top:vt,advance:zt}})}else 4===F?Ae.ascender=Oe.readSVarint():5===F&&(Ae.descender=Oe.readSVarint())}function yf(F,Ae,Oe){1===F?Ae.id=Oe.readVarint():2===F?Ae.bitmap=Oe.readBytes():3===F?Ae.width=Oe.readVarint():4===F?Ae.height=Oe.readVarint():5===F?Ae.left=Oe.readSVarint():6===F?Ae.top=Oe.readSVarint():7===F&&(Ae.advance=Oe.readVarint())}const ax=sx,cx={horizontal:1,vertical:2,horizontalOnly:3};class vf{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(F,Ae){const Oe=new vf;return Oe.scale=F||1,Oe.fontStack=Ae,Oe}static forImage(F){const Ae=new vf;return Ae.image=F,Ae}}class bf{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(F,Ae){const Oe=new bf;for(let Fe=0;Fe<F.sections.length;Fe++){const Ve=F.sections[Fe];Ve.image?Oe.addImageSection(Ve):Oe.addTextSection(Ve,Ae)}return Oe}length(){return this.text.length}getSection(F){return this.sections[this.sectionIndex[F]]}getSections(){return this.sections}getSectionIndex(F){return this.sectionIndex[F]}getCodePoint(F){return this.text.codePointAt(F)}verticalizePunctuation(F){this.text=function(F,Ae){let Oe="";for(let Fe=0;Fe<F.length;Fe++){const Ve=F.charCodeAt(Fe+1)||null,qe=F.charCodeAt(Fe-1)||null;Oe+=!Ae&&(Ve&&ga(Ve)&&!Vy[F[Fe+1]]||qe&&ga(qe)&&!Vy[F[Fe-1]])||!Vy[F[Fe]]?F[Fe]:Vy[F[Fe]]}return Oe}(this.text,F)}trim(){let F=0;for(let Ae=0;Ae<this.text.length&&hx[this.text.charCodeAt(Ae)];Ae++)F++;let Ae=this.text.length;for(let Oe=this.text.length-1;Oe>=0&&Oe>=F&&hx[this.text.charCodeAt(Oe)];Oe--)Ae--;this.text=this.text.substring(F,Ae),this.sectionIndex=this.sectionIndex.slice(F,Ae)}substring(F,Ae){const Oe=new bf;return Oe.text=this.text.substring(F,Ae),Oe.sectionIndex=this.sectionIndex.slice(F,Ae),Oe.sections=this.sections,Oe}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((F,Ae)=>Math.max(F,this.sections[Ae].scale)),0)}addTextSection(F,Ae){this.text+=F.text,this.sections.push(vf.forText(F.scale,F.fontStack||Ae));const Oe=this.sections.length-1;for(let Ae=0;Ae<F.text.length;++Ae)this.sectionIndex.push(Oe)}addImageSection(F){const Ae=F.image&&F.image.namePrimary?F.image.getPrimary():null;if(!Ae)return void ft("Can't add FormattedSection with an empty image.");const Oe=this.getNextImageSectionCharCode();Oe?(this.text+=String.fromCodePoint(Oe),this.sections.push(vf.forImage(Ae)),this.sectionIndex.push(this.sections.length-1)):ft("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function _f(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr){const Qr=bf.fromFeature(F,Ve);bi===cx.vertical&&Qr.verticalizePunctuation(wi);let Xn=[];const ho=function(F,Ae,Oe,Fe,Ve,qe){if(!F)return[];const pt=[],vt=function(F,Ae,Oe,Fe,Ve,qe){let pt=0;for(let Oe=0;Oe<F.length();Oe++){const vt=F.getSection(Oe);pt+=Af(F.getCodePoint(Oe),vt,Fe,Ve,Ae,qe)}return pt/Math.max(1,Math.ceil(pt/Oe))}(F,Ae,Oe,Fe,Ve,qe),zt=F.text.indexOf("")>=0;let ri=0;for(let Oe=0;Oe<F.length();Oe++){const bi=F.getSection(Oe),wi=F.getCodePoint(Oe);if(hx[wi]||(ri+=Af(wi,bi,Fe,Ve,Ae,qe)),Oe<F.length()-1){const Ae=!((xi=wi)<11904||!(Hp["Bopomofo Extended"](xi)||Hp.Bopomofo(xi)||Hp["CJK Compatibility Forms"](xi)||Hp["CJK Compatibility Ideographs"](xi)||Hp["CJK Compatibility"](xi)||Hp["CJK Radicals Supplement"](xi)||Hp["CJK Strokes"](xi)||Hp["CJK Symbols and Punctuation"](xi)||Hp["CJK Unified Ideographs Extension A"](xi)||Hp["CJK Unified Ideographs"](xi)||Hp["Enclosed CJK Letters and Months"](xi)||Hp["Halfwidth and Fullwidth Forms"](xi)||Hp.Hiragana(xi)||Hp["Ideographic Description Characters"](xi)||Hp["Kangxi Radicals"](xi)||Hp["Katakana Phonetic Extensions"](xi)||Hp.Katakana(xi)||Hp["Vertical Forms"](xi)||Hp["Yi Radicals"](xi)||Hp["Yi Syllables"](xi)));(ux[wi]||Ae||bi.image)&&pt.push(Pf(Oe+1,ri,vt,pt,If(wi,F.getCodePoint(Oe+1),Ae&&zt),!1))}}var xi;return zf(Pf(F.length(),ri,vt,pt,0,!0))}(Qr,ri,qe,Ae,Fe,dr),{processBidirectionalText:yo,processStyledBidirectionalText:zo}=uf;if(yo&&1===Qr.sections.length){const F=yo(Qr.toString(),ho);for(const Ae of F){const F=new bf;F.text=Ae,F.sections=Qr.sections;for(let Oe=0;Oe<Ae.length;Oe++)F.sectionIndex.push(0);Xn.push(F)}}else if(zo){const F=zo(Qr.text,Qr.sectionIndex,ho);for(const Ae of F){const F=new bf;F.text=Ae[0],F.sectionIndex=Ae[1],F.sections=Qr.sections,Xn.push(F)}}else Xn=function(F,Ae){const Oe=[],Fe=F.text;let Ve=0;for(const Fe of Ae)Oe.push(F.substring(Ve,Fe)),Ve=Fe;return Ve<Fe.length&&Oe.push(F.substring(Ve,Fe.length)),Oe}(Qr,ho);const ko=[],Uo={positionedLines:ko,text:Qr.toString(),top:xi[1],bottom:xi[1],left:xi[0],right:xi[0],writingMode:bi,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi){let wi=0,dr=0,jr=0;const Qr="right"===vt?1:"left"===vt?0:.5;let Xn=!1;for(const F of Ve){const Oe=F.getSections();for(const F of Oe){if(F.image)continue;const Oe=Ae[F.fontStack];if(Oe&&(Xn=void 0!==Oe.ascender&&void 0!==Oe.descender,!Xn))break}if(!Xn)break}let ho=0;for(const pt of Ve){pt.trim();const Ve=pt.getMaxScale(),vt=(Ve-1)*ky,zo={positionedGlyphs:[],lineOffset:0};F.positionedLines[ho]=zo;const ko=zo.positionedGlyphs;let Uo=0;if(!pt.length()){dr+=qe,++ho;continue}let ia=0,_a=0;for(let qe=0;qe<pt.length();qe++){const vt=pt.getSection(qe),jr=pt.getSectionIndex(qe),Qr=pt.getCodePoint(qe);let ho=vt.scale,zo=null,Ma=null,Ea=null,Ia=ky,rl=0;const Sl=!(zt===cx.horizontal||!xi&&!ya(Qr)||xi&&(hx[Qr]||(yo=Qr,Hp.Arabic(yo)||Hp["Arabic Supplement"](yo)||Hp["Arabic Extended-A"](yo)||Hp["Arabic Presentation Forms-A"](yo)||Hp["Arabic Presentation Forms-B"](yo))));if(vt.image){const Ae=Fe[vt.image.serialize()];if(!Ae)continue;Ea=vt.image.id,F.iconsInText=F.iconsInText||!0,Ma=Ae.paddedRect;const Oe=Ae.displaySize;ho=ho*ky/bi,zo={width:Oe[0],height:Oe[1],left:0,top:-ax,advance:Sl?Oe[1]:Oe[0],localGlyph:!1},rl=Xn?-zo.height*ho:Ve*ky-17-Oe[1]*ho,Ia=zo.advance;const qe=(Sl?Oe[0]:Oe[1])*ho-ky*Ve;qe>0&&qe>Uo&&(Uo=qe)}else{const F=Oe[vt.fontStack];if(!F)continue;F[Qr]&&(Ma=F[Qr]);const Fe=Ae[vt.fontStack];if(!Fe)continue;const qe=Fe.glyphs[Qr];if(!qe)continue;if(zo=qe.metrics,Ia=8203!==Qr?ky:0,Xn){const F=void 0!==Fe.ascender?Math.abs(Fe.ascender):0,Ae=void 0!==Fe.descender?Math.abs(Fe.descender):0,Oe=(F+Ae)*ho;ia<Oe&&(ia=Oe,_a=(F-Ae)/2*ho),rl=-F*ho}else rl=(Ve-ho)*ky-17}Sl?(F.verticalizable=!0,ko.push({glyph:Qr,imageName:Ea,x:wi,y:dr+rl,vertical:Sl,scale:ho,localGlyph:zo.localGlyph,fontStack:vt.fontStack,sectionIndex:jr,metrics:zo,rect:Ma}),wi+=Ia*ho+ri):(ko.push({glyph:Qr,imageName:Ea,x:wi,y:dr+rl,vertical:Sl,scale:ho,localGlyph:zo.localGlyph,fontStack:vt.fontStack,sectionIndex:jr,metrics:zo,rect:Ma}),wi+=zo.advance*ho+ri)}0!==ko.length&&(jr=Math.max(wi-ri,jr),Xn?kf(ko,Qr,Uo,_a,qe*Ve/2):kf(ko,Qr,Uo,0,qe/2)),wi=0;const Ma=qe*Ve+Uo;zo.lineOffset=Math.max(Uo,vt),dr+=Ma,++ho}var yo;const zo=dr,{horizontalAlign:ko,verticalAlign:Uo}=Ef(pt);(function(F,Ae,Oe,Fe,Ve,qe){const pt=(Ae-Oe)*Ve,vt=-qe*Fe;for(const Ae of F)for(const F of Ae.positionedGlyphs)F.x+=pt,F.y+=vt})(F.positionedLines,Qr,ko,Uo,jr,zo),F.top+=-Uo*zo,F.bottom=F.top+zo,F.left+=-ko*jr,F.right=F.left+jr,F.hasBaseline=Xn}(Uo,Ae,Oe,Fe,Xn,pt,vt,zt,bi,ri,wi,jr),!function(F){for(const Ae of F)if(0!==Ae.positionedGlyphs.length)return!1;return!0}(ko)&&Uo}const hx={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},ux={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Af(F,Ae,Oe,Fe,Ve,qe){if(Ae.image){const F=Fe[Ae.image.serialize()];return F?F.displaySize[0]*Ae.scale*ky/qe+Ve:0}{const Fe=Oe[Ae.fontStack],qe=Fe&&Fe.glyphs[F];return qe?qe.metrics.advance*Ae.scale+Ve:0}}function Sf(F,Ae,Oe,Fe){const Ve=Math.pow(F-Ae,2);return Fe?F<Ae?Ve/2:2*Ve:Ve+Math.abs(Oe)*Oe}function If(F,Ae,Oe){let Fe=0;return 10===F&&(Fe-=1e4),Oe&&(Fe+=150),40!==F&&65288!==F||(Fe+=50),41!==Ae&&65289!==Ae||(Fe+=50),Fe}function Pf(F,Ae,Oe,Fe,Ve,qe){let pt=null,vt=Sf(Ae,Oe,Ve,qe);for(const F of Fe){const Fe=Sf(Ae-F.x,Oe,Ve,qe)+F.badness;Fe<=vt&&(pt=F,vt=Fe)}return{index:F,x:Ae,priorBreak:pt,badness:vt}}function zf(F){return F?zf(F.priorBreak).concat(F.index):[]}function Ef(F){let Ae=.5,Oe=.5;switch(F){case"right":case"top-right":case"bottom-right":Ae=1;break;case"left":case"top-left":case"bottom-left":Ae=0}switch(F){case"bottom":case"bottom-right":case"bottom-left":Oe=1;break;case"top":case"top-right":case"top-left":Oe=0}return{horizontalAlign:Ae,verticalAlign:Oe}}function kf(F,Ae,Oe,Fe,Ve){if(!(Ae||Oe||Fe||Ve))return;const qe=F.length-1,pt=F[qe],vt=(pt.x+pt.metrics.advance*pt.scale)*Ae;for(let Ae=0;Ae<=qe;Ae++)F[Ae].x-=vt,F[Ae].y+=Oe+Fe+Ve}function Tf(F,Ae,Oe,Fe){const{horizontalAlign:Ve,verticalAlign:qe}=Ef(Fe),pt=Oe[0]-F.displaySize[0]*Ve,vt=Oe[1]-F.displaySize[1]*qe;return{imagePrimary:F,imageSecondary:Ae,top:vt,bottom:vt+F.displaySize[1],left:pt,right:pt+F.displaySize[0]}}function Bf(F,Ae,Oe,Fe,Ve,qe){const pt=F.imagePrimary;let vt;if(pt.content){const F=pt.content,Ae=pt.pixelRatio||1;vt=[F[0]/Ae,F[1]/Ae,pt.displaySize[0]-F[2]/Ae,pt.displaySize[1]-F[3]/Ae]}const zt=Ae.left*qe,ri=Ae.right*qe;let xi,bi,wi,dr;"width"===Oe||"both"===Oe?(dr=Ve[0]+zt-Fe[3],bi=Ve[0]+ri+Fe[1]):(dr=Ve[0]+(zt+ri-pt.displaySize[0])/2,bi=dr+pt.displaySize[0]);const jr=Ae.top*qe,Qr=Ae.bottom*qe;return"height"===Oe||"both"===Oe?(xi=Ve[1]+jr-Fe[0],wi=Ve[1]+Qr+Fe[2]):(xi=Ve[1]+(jr+Qr-pt.displaySize[1])/2,wi=xi+pt.displaySize[1]),{imagePrimary:pt,imageSecondary:void 0,top:xi,right:bi,bottom:wi,left:dr,collisionPadding:vt}}class Cf extends Jl{constructor(F,Ae,Oe,Fe,Ve){super(F,Ae),this.angle=Fe,this.z=Oe,void 0!==Ve&&(this.segment=Ve)}clone(){return new Cf(this.x,this.y,this.z,this.angle,this.segment)}}function Vf(F,Ae,Oe,Fe,Ve){if(void 0===Ae.segment)return!0;let qe=Ae,pt=Ae.segment+1,vt=0;for(;vt>-Oe/2;){if(pt--,pt<0)return!1;vt-=F[pt].dist(qe),qe=F[pt]}vt+=F[pt].dist(F[pt+1]),pt++;const zt=[];let ri=0;for(;vt<Oe/2;){const Ae=F[pt],Oe=F[pt+1];if(!Oe)return!1;let qe=F[pt-1].angleTo(Ae)-Ae.angleTo(Oe);for(qe=Math.abs((qe+3*Math.PI)%(2*Math.PI)-Math.PI),zt.push({distance:vt,angleDelta:qe}),ri+=qe;vt-zt[0].distance>Fe;)ri-=zt.shift().angleDelta;if(ri>Ve)return!1;pt++,vt+=Ae.dist(Oe)}return!0}function Df(F){let Ae=0;for(let Oe=0;Oe<F.length-1;Oe++)Ae+=F[Oe].dist(F[Oe+1]);return Ae}function Lf(F,Ae,Oe){return F?.6*Ae*Oe:0}function Rf(F,Ae){return Math.max(F?F.right-F.left:0,Ae?Ae.right-Ae.left:0)}function Ff(F,Ae,Oe,Fe,Ve,qe){const pt=Lf(Oe,Ve,qe),vt=Rf(Oe,Fe)*qe;let zt=0;const ri=Df(F)/2;for(let Oe=0;Oe<F.length-1;Oe++){const Fe=F[Oe],Ve=F[Oe+1],qe=Fe.dist(Ve);if(zt+qe>ri){const xi=(ri-zt)/qe,bi=ze(Fe.x,Ve.x,xi),wi=ze(Fe.y,Ve.y,xi),dr=new Cf(bi,wi,0,Ve.angleTo(Fe),Oe);return!pt||Vf(F,dr,vt,pt,Ae)?dr:void 0}zt+=qe}}function Of(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri=Lf(Fe,qe,pt),xi=Rf(Fe,Ve),bi=xi*pt,wi=0===F[0].x||F[0].x===zt||0===F[0].y||F[0].y===zt;return Ae-bi<Ae/4&&(Ae=bi+Ae/4),Nf(F,wi?Ae/2*vt%Ae:(xi/2+2*qe)*pt*vt%Ae,Ae,ri,Oe,bi,wi,!1,zt)}function Nf(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri=qe/2,xi=Df(F);let bi=0,wi=Ae-Oe,dr=[];for(let Ae=0;Ae<F.length-1;Ae++){const pt=F[Ae],vt=F[Ae+1],jr=pt.dist(vt),Qr=vt.angleTo(pt);for(;wi+Oe<bi+jr;){wi+=Oe;const Xn=(wi-bi)/jr,ho=ze(pt.x,vt.x,Xn),yo=ze(pt.y,vt.y,Xn);if(ho>=0&&ho<zt&&yo>=0&&yo<zt&&wi-ri>=0&&wi+ri<=xi){const Oe=new Cf(ho,yo,0,Qr,Ae);Fe&&!Vf(F,Oe,qe,Fe,Ve)||dr.push(Oe)}}bi+=jr}return vt||dr.length||pt||(dr=Nf(F,bi/2,Oe,Fe,Ve,qe,pt,!0,zt)),dr}function Uf(F,Ae,Oe,Fe,Ve){const qe=[];for(let pt=0;pt<F.length;pt++){const vt=F[pt];let zt;for(let F=0;F<vt.length-1;F++){let pt=vt[F],ri=vt[F+1];pt.x<Ae&&ri.x<Ae||(pt.x<Ae?pt=new Jl(Ae,pt.y+(Ae-pt.x)/(ri.x-pt.x)*(ri.y-pt.y))._round():ri.x<Ae&&(ri=new Jl(Ae,pt.y+(Ae-pt.x)/(ri.x-pt.x)*(ri.y-pt.y))._round()),pt.y<Oe&&ri.y<Oe||(pt.y<Oe?pt=new Jl(pt.x+(Oe-pt.y)/(ri.y-pt.y)*(ri.x-pt.x),Oe)._round():ri.y<Oe&&(ri=new Jl(pt.x+(Oe-pt.y)/(ri.y-pt.y)*(ri.x-pt.x),Oe)._round()),pt.x>=Fe&&ri.x>=Fe||(pt.x>=Fe?pt=new Jl(Fe,pt.y+(Fe-pt.x)/(ri.x-pt.x)*(ri.y-pt.y))._round():ri.x>=Fe&&(ri=new Jl(Fe,pt.y+(Fe-pt.x)/(ri.x-pt.x)*(ri.y-pt.y))._round()),pt.y>=Ve&&ri.y>=Ve||(pt.y>=Ve?pt=new Jl(pt.x+(Ve-pt.y)/(ri.y-pt.y)*(ri.x-pt.x),Ve)._round():ri.y>=Ve&&(ri=new Jl(pt.x+(Ve-pt.y)/(ri.y-pt.y)*(ri.x-pt.x),Ve)._round()),zt&&pt.equals(zt[zt.length-1])||(zt=[pt],qe.push(zt)),zt.push(ri)))))}}return qe}function jf(F){let Ae=0,Oe=0;for(const Fe of F)Ae+=Fe.w*Fe.h,Oe=Math.max(Oe,Fe.w);F.sort(((F,Ae)=>Ae.h-F.h));const Fe=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(Ae/.95)),Oe),h:1/0}];let Ve=0,qe=0;for(const Ae of F)for(let F=Fe.length-1;F>=0;F--){const Oe=Fe[F];if(!(Ae.w>Oe.w||Ae.h>Oe.h)){if(Ae.x=Oe.x,Ae.y=Oe.y,qe=Math.max(qe,Ae.y+Ae.h),Ve=Math.max(Ve,Ae.x+Ae.w),Ae.w===Oe.w&&Ae.h===Oe.h){const Ae=Fe.pop();F<Fe.length&&(Fe[F]=Ae)}else Ae.h===Oe.h?(Oe.x+=Ae.w,Oe.w-=Ae.w):Ae.w===Oe.w?(Oe.y+=Ae.h,Oe.h-=Ae.h):(Fe.push({x:Oe.x+Ae.w,y:Oe.y,w:Oe.w-Ae.w,h:Ae.h}),Oe.y+=Ae.h,Oe.h-=Ae.h);break}}return{w:Ve,h:qe,fill:Ae/(Ve*qe)||0}}oa(Cf,"Anchor");const px=1;class $f{static getImagePositionScale(F,Ae,Oe){return Ae&&F&&F.options&&F.options.transform?{x:F.options.transform.a,y:F.options.transform.d}:{x:Oe,y:Oe}}constructor(F,{pixelRatio:Ae,version:Oe,stretchX:Fe,stretchY:Ve,content:qe,sdf:pt,usvg:vt},zt,ri){this.paddedRect=F,this.pixelRatio=Ae,this.stretchX=Fe,this.stretchY=Ve,this.content=qe,this.version=Oe,this.padding=zt,this.sdf=pt,this.scale=$f.getImagePositionScale(ri,vt,Ae)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}class Gf{constructor(F,Ae,Oe){const Fe={},Ve={};this.haveRenderCallbacks=[];const qe=[];this.addImages(F,Fe,px,qe),this.addImages(Ae,Ve,2,qe);const{w:pt,h:vt}=jf(qe),zt=new sc({width:pt||1,height:vt||1});for(const Ae in F){const Ve=F[Ae],qe=Fe[Ae].paddedRect;sc.copy(Ve.data,zt,{x:0,y:0},{x:qe.x+px,y:qe.y+px},Ve.data,Oe,Ve.sdf)}for(const F in Ae){const Fe=Ae[F],qe=Ve[F].paddedRect;let pt=Ve[F].padding;const vt=qe.x+pt,ri=qe.y+pt,xi=Fe.data.width,bi=Fe.data.height;pt=pt>1?pt-1:pt,sc.copy(Fe.data,zt,{x:0,y:0},{x:vt,y:ri},Fe.data,Oe),sc.copy(Fe.data,zt,{x:0,y:bi-pt},{x:vt,y:ri-pt},{width:xi,height:pt},Oe),sc.copy(Fe.data,zt,{x:0,y:0},{x:vt,y:ri+bi},{width:xi,height:pt},Oe),sc.copy(Fe.data,zt,{x:xi-pt,y:0},{x:vt-pt,y:ri},{width:pt,height:bi},Oe),sc.copy(Fe.data,zt,{x:0,y:0},{x:vt+xi,y:ri},{width:pt,height:bi},Oe),sc.copy(Fe.data,zt,{x:xi-pt,y:bi-pt},{x:vt-pt,y:ri-pt},{width:pt,height:pt},Oe),sc.copy(Fe.data,zt,{x:0,y:bi-pt},{x:vt+xi,y:ri-pt},{width:pt,height:pt},Oe),sc.copy(Fe.data,zt,{x:0,y:0},{x:vt+xi,y:ri+bi},{width:pt,height:pt},Oe),sc.copy(Fe.data,zt,{x:xi-pt,y:0},{x:vt-pt,y:ri+bi},{width:pt,height:pt},Oe)}this.lut=Oe,this.image=zt,this.iconPositions=Fe,this.patternPositions=Ve}addImages(F,Ae,Oe,Fe){for(const Ve in F){const qe=F[Ve],pt={x:0,y:0,w:qe.data.width+2*Oe,h:qe.data.height+2*Oe};Fe.push(pt);const vt=Qe.deserializeFromString(Ve);Ae[Ve]=new $f(pt,qe,Oe,vt),qe.hasRenderCallback&&this.haveRenderCallbacks.push(vt.id)}}patchUpdatedImages(F,Ae,Oe){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((Ae=>F.hasImage(Ae,Oe))),F.dispatchRenderCallbacks(this.haveRenderCallbacks,Oe);for(const Fe in F.getUpdatedImages(Oe)){for(const Ve of Object.keys(this.iconPositions))Qe.deserializeId(Ve)===Fe&&this.patchUpdatedImage(this.iconPositions[Ve],F.getImage(Fe,Oe),Ae);for(const Ve of Object.keys(this.patternPositions))Qe.deserializeId(Ve)===Fe&&this.patchUpdatedImage(this.patternPositions[Ve],F.getImage(Fe,Oe),Ae)}}patchUpdatedImage(F,Ae,Oe){if(!F||!Ae)return;if(F.version===Ae.version)return;F.version=Ae.version;const[Fe,Ve]=F.tl,qe=F.sdf;if(this.lut||qe){const F={width:Ae.data.width,height:Ae.data.height},pt=new sc(F);sc.copy(Ae.data,pt,{x:0,y:0},{x:0,y:0},F,this.lut,qe),Oe.update(pt,{position:{x:Fe,y:Ve}})}else Oe.update(Ae.data,{position:{x:Fe,y:Ve}})}}oa($f,"ImagePosition"),oa(Gf,"ImageAtlas");const yx=1e20;function Xf(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){for(let ri=Ae;ri<Ae+Fe;ri++)Zf(F,Oe*qe+ri,qe,Ve,pt,vt,zt);for(let ri=Oe;ri<Oe+Ve;ri++)Zf(F,ri*qe+Ae,1,Fe,pt,vt,zt)}function Zf(F,Ae,Oe,Fe,Ve,qe,pt){qe[0]=0,pt[0]=-yx,pt[1]=yx,Ve[0]=F[Ae];for(let vt=1,zt=0,ri=0;vt<Fe;vt++){Ve[vt]=F[Ae+vt*Oe];const Fe=vt*vt;do{const F=qe[zt];ri=(Ve[vt]-Ve[F]+Fe-F*F)/(vt-F)/2}while(ri<=pt[zt]&&--zt>-1);zt++,qe[zt]=vt,pt[zt]=ri,pt[zt+1]=yx}for(let vt=0,zt=0;vt<Fe;vt++){for(;pt[zt+1]<vt;)zt++;const Fe=qe[zt],ri=vt-Fe;F[Ae+vt*Oe]=Ve[Fe]+ri*ri}}const xx=2,vx={none:0,ideographs:1,all:2};class Kf{constructor(F,Ae,Oe){this.requestManager=F,this.localGlyphMode=Ae,this.localFontFamily=Oe,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(F,Ae){this.urls[Ae]=F}getGlyphs(F,Ae,Oe){const Fe=[],Ve=this.urls[Ae]||qc.GLYPHS_URL;for(const Ae in F)for(const Oe of F[Ae])Fe.push({stack:Ae,id:Oe});rt(Fe,(({stack:F,id:Ae},Oe)=>{let Fe=this.entries[F];Fe||(Fe=this.entries[F]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let qe=Fe.glyphs[Ae];if(void 0!==qe)return void Oe(null,{stack:F,id:Ae,glyph:qe});if(qe=this._tinySDF(Fe,F,Ae),qe)return Fe.glyphs[Ae]=qe,void Oe(null,{stack:F,id:Ae,glyph:qe});const pt=Math.floor(Ae/256);if(256*pt>65535)return ft("glyphs > 65535 not supported"),void Oe(null,{stack:F,id:Ae,glyph:qe});if(Fe.ranges[pt])return void Oe(null,{stack:F,id:Ae,glyph:qe});let vt=Fe.requests[pt];vt||(vt=Fe.requests[pt]=[],Kf.loadGlyphRange(F,pt,Ve,this.requestManager,((F,Ae)=>{if(Ae){Fe.ascender=Ae.ascender,Fe.descender=Ae.descender;for(const F in Ae.glyphs)this._doesCharSupportLocalGlyph(+F)||(Fe.glyphs[+F]=Ae.glyphs[+F]);Fe.ranges[pt]=!0}for(const Oe of vt)Oe(F,Ae);delete Fe.requests[pt]}))),vt.push(((Fe,Ve)=>{Fe?Oe(Fe):Ve&&Oe(null,{stack:F,id:Ae,glyph:Ve.glyphs[Ae]||null})}))}),((F,Ae)=>{if(F)Oe(F);else if(Ae){const F={};for(const{stack:Oe,id:Fe,glyph:Ve}of Ae)void 0===F[Oe]&&(F[Oe]={}),void 0===F[Oe].glyphs&&(F[Oe].glyphs={}),F[Oe].glyphs[Fe]=Ve&&{id:Ve.id,bitmap:Ve.bitmap.clone(),metrics:Ve.metrics},F[Oe].ascender=this.entries[Oe].ascender,F[Oe].descender=this.entries[Oe].descender;Oe(null,F)}}))}_doesCharSupportLocalGlyph(F){return this.localGlyphMode!==vx.none&&(this.localGlyphMode===vx.all?!!this.localFontFamily:!!this.localFontFamily&&(Hp["CJK Unified Ideographs"](F)||Hp["Hangul Syllables"](F)||Hp.Hiragana(F)||Hp.Katakana(F)||Hp["CJK Symbols and Punctuation"](F)||Hp["CJK Unified Ideographs Extension A"](F)||Hp["CJK Unified Ideographs Extension B"](F)||Hp.Osage(F)))}_tinySDF(F,Ae,Oe){const Fe=this.localFontFamily;if(!Fe||!this._doesCharSupportLocalGlyph(Oe))return;let Ve=F.tinySDF;if(!Ve){let Oe="400";/bold/i.test(Ae)?Oe="900":/medium/i.test(Ae)?Oe="500":/light/i.test(Ae)&&(Oe="200"),Ve=F.tinySDF=new Kf.TinySDF({fontFamily:Fe,fontWeight:Oe,fontSize:24*xx,buffer:3*xx,radius:8*xx}),Ve.fontWeight=Oe}if(this.localGlyphs[Ve.fontWeight][Oe])return this.localGlyphs[Ve.fontWeight][Oe];const qe=String.fromCodePoint(Oe),{data:pt,width:vt,height:zt,glyphWidth:ri,glyphHeight:xi,glyphLeft:bi,glyphTop:wi,glyphAdvance:dr}=Ve.draw(qe);return this.localGlyphs[Ve.fontWeight][Oe]={id:Oe,bitmap:new ac({width:vt,height:zt},pt),metrics:{width:ri/xx,height:xi/xx,left:bi/xx,top:wi/xx-27,advance:dr/xx,localGlyph:!0}}}}Kf.loadGlyphRange=function(F,Ae,Oe,Fe,Ve){const qe=256*Ae,pt=qe+255,vt=Fe.transformRequest(Fe.normalizeGlyphsURL(Oe).replace("{fontstack}",F).replace("{range}",`${qe}-${pt}`),Dh.Glyphs);ie(vt,((F,Ae)=>{if(F)Ve(F);else if(Ae){const F={},Oe=function(F){return new ox(F).readFields(df,{})}(Ae);for(const Ae of Oe.glyphs)F[Ae.id]=Ae;Ve(null,{glyphs:F,ascender:Oe.ascender,descender:Oe.descender})}}))},Kf.TinySDF=class{constructor({fontSize:F=24,buffer:Ae=3,radius:Oe=8,cutoff:Fe=.25,fontFamily:Ve="sans-serif",fontWeight:qe="normal",fontStyle:pt="normal"}={}){this.buffer=Ae,this.cutoff=Fe,this.radius=Oe;const vt=this.size=F+4*Ae,zt=this._createCanvas(vt),ri=this.ctx=zt.getContext("2d",{willReadFrequently:!0});ri.font=`${pt} ${qe} ${F}px ${Ve}`,ri.textBaseline="alphabetic",ri.textAlign="left",ri.fillStyle="black",this.gridOuter=new Float64Array(vt*vt),this.gridInner=new Float64Array(vt*vt),this.f=new Float64Array(vt),this.z=new Float64Array(vt+1),this.v=new Uint16Array(vt)}_createCanvas(F){const Ae=document.createElement("canvas");return Ae.width=Ae.height=F,Ae}draw(F){const{width:Ae,actualBoundingBoxAscent:Oe,actualBoundingBoxDescent:Fe,actualBoundingBoxLeft:Ve,actualBoundingBoxRight:qe}=this.ctx.measureText(F),pt=Math.ceil(Oe),vt=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(qe-Ve))),zt=Math.min(this.size-this.buffer,pt+Math.ceil(Fe)),ri=vt+2*this.buffer,xi=zt+2*this.buffer,bi=Math.max(ri*xi,0),wi=new Uint8ClampedArray(bi),dr={data:wi,width:ri,height:xi,glyphWidth:vt,glyphHeight:zt,glyphTop:pt,glyphLeft:0,glyphAdvance:Ae};if(0===vt||0===zt)return dr;const{ctx:jr,buffer:Qr,gridInner:Xn,gridOuter:ho}=this;jr.clearRect(Qr,Qr,vt,zt),jr.fillText(F,Qr,Qr+pt);const yo=jr.getImageData(Qr,Qr,vt,zt);ho.fill(yx,0,bi),Xn.fill(0,0,bi);for(let F=0;F<zt;F++)for(let Ae=0;Ae<vt;Ae++){const Oe=yo.data[4*(F*vt+Ae)+3]/255;if(0===Oe)continue;const Fe=(F+Qr)*ri+Ae+Qr;if(1===Oe)ho[Fe]=0,Xn[Fe]=yx;else{const F=.5-Oe;ho[Fe]=F>0?F*F:0,Xn[Fe]=F<0?F*F:0}}Xf(ho,0,0,ri,xi,ri,this.f,this.v,this.z),Xf(Xn,Qr,Qr,vt,zt,ri,this.f,this.v,this.z);for(let F=0;F<bi;F++){const Ae=Math.sqrt(ho[F])-Math.sqrt(Xn[F]);wi[F]=Math.round(255-255*(Ae/this.radius+this.cutoff))}return dr}};const bx=px;function Qf(F,Ae){return F+Ae[1]-Ae[0]}function td(F,Ae,Oe,Fe,Ve=1){const qe=[],pt=F.imagePrimary,vt=pt.pixelRatio,zt=pt.paddedRect.w-2*bx,ri=pt.paddedRect.h-2*bx,xi=(F.right-F.left)*Ve,bi=(F.bottom-F.top)*Ve,wi=pt.stretchX||[[0,zt]],dr=pt.stretchY||[[0,ri]],jr=wi.reduce(Qf,0),Qr=dr.reduce(Qf,0),Xn=zt-jr,ho=ri-Qr;let yo=0,zo=jr,ko=0,Uo=Qr,ia=0,_a=Xn,Ma=0,Ea=ho;if(pt.content&&Fe){const F=pt.content;yo=ed(wi,0,F[0]),ko=ed(dr,0,F[1]),zo=ed(wi,F[0],F[2]),Uo=ed(dr,F[1],F[3]),ia=F[0]-yo,Ma=F[1]-ko,_a=F[2]-F[0]-zo,Ea=F[3]-F[1]-Uo}const I=(Fe,qe,zt,ri)=>{const wi=nd(Fe.stretch-yo,zo,xi,F.left*Ve),dr=id(Fe.fixed-ia,_a,Fe.stretch,jr),Xn=nd(qe.stretch-ko,Uo,bi,F.top*Ve),ho=id(qe.fixed-Ma,Ea,qe.stretch,Qr),Ia=nd(zt.stretch-yo,zo,xi,F.left*Ve),rl=id(zt.fixed-ia,_a,zt.stretch,jr),Sl=nd(ri.stretch-ko,Uo,bi,F.top*Ve),Il=id(ri.fixed-Ma,Ea,ri.stretch,Qr),Kl=new Jl(wi,Xn),Ql=new Jl(Ia,Xn),ec=new Jl(Ia,Sl),tc=new Jl(wi,Sl),cc=new Jl(dr/vt,ho/vt),uc=new Jl(rl/vt,Il/vt),jc=Ae*Math.PI/180;if(jc){const F=Math.sin(jc),Ae=Math.cos(jc),Oe=[Ae,-F,F,Ae];Kl._matMult(Oe),Ql._matMult(Oe),tc._matMult(Oe),ec._matMult(Oe)}const Gc=Fe.stretch+Fe.fixed,qc=zt.stretch+zt.fixed,$c=qe.stretch+qe.fixed,Hc=ri.stretch+ri.fixed,Wc=F.imageSecondary;return{tl:Kl,tr:Ql,bl:tc,br:ec,texPrimary:{x:pt.paddedRect.x+bx+Gc,y:pt.paddedRect.y+bx+$c,w:qc-Gc,h:Hc-$c},texSecondary:Wc?{x:Wc.paddedRect.x+bx+Gc,y:Wc.paddedRect.y+bx+$c,w:qc-Gc,h:Hc-$c}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:cc,pixelOffsetBR:uc,minFontScaleX:_a/vt/xi,minFontScaleY:Ea/vt/bi,isSDF:Oe}};if(Fe&&(pt.stretchX||pt.stretchY)){const F=rd(wi,Xn,jr),Ae=rd(dr,ho,Qr);for(let Oe=0;Oe<F.length-1;Oe++){const Fe=F[Oe],Ve=F[Oe+1];for(let F=0;F<Ae.length-1;F++)qe.push(I(Fe,Ae[F],Ve,Ae[F+1]))}}else qe.push(I({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:zt+1},{fixed:0,stretch:ri+1}));return qe}function ed(F,Ae,Oe){let Fe=0;for(const Ve of F)Fe+=Math.max(Ae,Math.min(Oe,Ve[1]))-Math.max(Ae,Math.min(Oe,Ve[0]));return Fe}function rd(F,Ae,Oe){const Fe=[{fixed:-bx,stretch:0}];for(const[Ae,Oe]of F){const F=Fe[Fe.length-1];Fe.push({fixed:Ae-F.stretch,stretch:F.stretch}),Fe.push({fixed:Ae-F.stretch,stretch:F.stretch+(Oe-Ae)})}return Fe.push({fixed:Ae+bx,stretch:Oe}),Fe}function nd(F,Ae,Oe,Fe){return F/Ae*Oe+Fe}function id(F,Ae,Oe,Fe){return F-Ae*Oe/Fe}function ad(F,Ae,Oe,Fe){const Ve=Ae+F.positionedLines[Fe].lineOffset;return 0===Fe?Oe+Ve/2:Oe+(Ve+(Ae+F.positionedLines[Fe-1].lineOffset))/2}function sd(F,Ae=1,Oe=!1){let Fe=1/0,Ve=1/0,qe=-1/0,pt=-1/0;const vt=F[0];for(let F=0;F<vt.length;F++){const Ae=vt[F];(!F||Ae.x<Fe)&&(Fe=Ae.x),(!F||Ae.y<Ve)&&(Ve=Ae.y),(!F||Ae.x>qe)&&(qe=Ae.x),(!F||Ae.y>pt)&&(pt=Ae.y)}const zt=Math.min(qe-Fe,pt-Ve);let ri=zt/2;const xi=new Hr([],od);if(0===zt)return new Jl(Fe,Ve);for(let Ae=Fe;Ae<qe;Ae+=zt)for(let Oe=Ve;Oe<pt;Oe+=zt)xi.push(new ld(Ae+ri,Oe+ri,ri,F));let bi=function(F){let Ae=0,Oe=0,Fe=0;const Ve=F[0];for(let F=0,qe=Ve.length,pt=qe-1;F<qe;pt=F++){const qe=Ve[F],vt=Ve[pt],zt=qe.x*vt.y-vt.x*qe.y;Oe+=(qe.x+vt.x)*zt,Fe+=(qe.y+vt.y)*zt,Ae+=3*zt}return new ld(Oe/Ae,Fe/Ae,0,F)}(F),wi=xi.length;for(;xi.length;){const Fe=xi.pop();(Fe.d>bi.d||!bi.d)&&(bi=Fe,Oe&&console.log("found best %d after %d probes",Math.round(1e4*Fe.d)/1e4,wi)),Fe.max-bi.d<=Ae||(ri=Fe.h/2,xi.push(new ld(Fe.p.x-ri,Fe.p.y-ri,ri,F)),xi.push(new ld(Fe.p.x+ri,Fe.p.y-ri,ri,F)),xi.push(new ld(Fe.p.x-ri,Fe.p.y+ri,ri,F)),xi.push(new ld(Fe.p.x+ri,Fe.p.y+ri,ri,F)),wi+=4)}return Oe&&(console.log(`num probes: ${wi}`),console.log(`best distance: ${bi.d}`)),bi.p}function od(F,Ae){return Ae.max-F.max}class ld{constructor(F,Ae,Oe,Fe){this.p=new Jl(F,Ae),this.h=Oe,this.d=function(F,Ae){let Oe=!1,Fe=1/0;for(let Ve=0;Ve<Ae.length;Ve++){const qe=Ae[Ve];for(let Ae=0,Ve=qe.length,pt=Ve-1;Ae<Ve;pt=Ae++){const Ve=qe[Ae],vt=qe[pt];Ve.y>F.y!=vt.y>F.y&&F.x<(vt.x-Ve.x)*(F.y-Ve.y)/(vt.y-Ve.y)+Ve.x&&(Oe=!Oe),Fe=Math.min(Fe,Nl(F,Ve,vt))}}return(Oe?1:-1)*Math.sqrt(Fe)}(this.p,Fe),this.max=this.d+this.h*Math.SQRT2}}const wx=Number.POSITIVE_INFINITY,Tx=Math.sqrt(2);function hd(F,[Ae,Oe]){let Fe=0,Ve=0;if(Oe===wx){Ae<0&&(Ae=0);const Oe=Ae/Tx;switch(F){case"top-right":case"top-left":Ve=Oe-7;break;case"bottom-right":case"bottom-left":Ve=7-Oe;break;case"bottom":Ve=7-Ae;break;case"top":Ve=Ae-7}switch(F){case"top-right":case"bottom-right":Fe=-Oe;break;case"top-left":case"bottom-left":Fe=Oe;break;case"left":Fe=Ae;break;case"right":Fe=-Ae}}else{switch(Ae=Math.abs(Ae),Oe=Math.abs(Oe),F){case"top-right":case"top-left":case"top":Ve=Oe-7;break;case"bottom-right":case"bottom-left":case"bottom":Ve=7-Oe}switch(F){case"top-right":case"bottom-right":case"right":Fe=-Ae;break;case"top-left":case"bottom-left":case"left":Fe=Ae}}return[Fe,Ve]}function pd(F){switch(F){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function fd(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr){let Qr=qe.textMaxSize.evaluate(Ae,{},bi);void 0===Qr?Qr=pt*qe.textScaleFactor:Qr*=qe.textScaleFactor;const Xn=F.layers[0].layout,ho=Xn.get("icon-offset").evaluate(Ae,{},bi),yo=gd(Oe.horizontal)||Oe.vertical,zo="globe"===wi.name,ko=ky,Uo=pt*qe.textScaleFactor/ko,ia=F.tilePixelRatio*Qr/ko,_a=(Jl=F.overscaling,F.zoom>18&&Jl>2&&(Jl>>=1),Math.max(Vd/(512*Jl),1)*Xn.get("symbol-spacing")),Ma=Xn.get("text-padding")*F.tilePixelRatio,Ea=Xn.get("icon-padding")*F.tilePixelRatio,Ia=X(Xn.get("text-max-angle")),rl="map"===Xn.get("text-rotation-alignment")&&"point"!==Xn.get("symbol-placement"),Sl="map"===Xn.get("icon-rotation-alignment")&&"point"!==Xn.get("symbol-placement"),Il=Xn.get("symbol-placement"),Kl=_a/2;var Jl;const Ql=Xn.get("icon-text-fit").evaluate(Ae,{},bi),ec=Xn.get("icon-text-fit-padding").evaluate(Ae,{},bi),tc="none"!==Ql;let cc;!1===F.hasAnyIconTextFit&&tc&&(F.hasAnyIconTextFit=!0),Fe&&tc&&(F.allowVerticalPlacement&&Oe.vertical&&(cc=Bf(Fe,Oe.vertical,Ql,ec,ho,Uo)),yo&&(Fe=Bf(Fe,yo,Ql,ec,ho,Uo)));const L=(pt,vt,Qr)=>{if(vt.x<0||vt.x>=Vd||vt.y<0||vt.y>=Vd)return;let Xn=null;if(zo){const{x:F,y:Ae,z:Oe}=wi.projectTilePoint(vt.x,vt.y,Qr);Xn={anchor:new Cf(F,Ae,Oe,0,void 0),up:wi.upVector(Qr,vt.x,vt.y)}}!function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko,Uo,ia,_a,Ma,Ea,Ia){const rl=F.addToLineVertexArray(Ae,Fe);let Sl,Il,Kl,Jl,Ql,ec,tc,cc=0,uc=0,jc=0,Gc=0,qc=-1,$c=-1;const Hc={};let Wc=cu("");const Kc=Oe?Oe.anchor:Ae,Jc="none"!==zt.layout.get("icon-text-fit").evaluate(ko,{},Ma);let Qc=0,eh=0;if(void 0===zt._unevaluatedLayout.getValue("text-radial-offset")?[Qc,eh]=zt.layout.get("text-offset").evaluate(ko,{},Ma).map((F=>F*ky)):(Qc=zt.layout.get("text-radial-offset").evaluate(ko,{},Ma)*ky,eh=wx),F.allowVerticalPlacement&&Ve.vertical){const F=Ve.vertical;if(jr)ec=vd(F),vt&&(tc=vd(vt));else{const Oe=zt.layout.get("text-rotate").evaluate(ko,{},Ma)+90;Kl=xd(ri,Kc,Ae,xi,bi,wi,F,dr,Oe,Qr),vt&&(Jl=xd(ri,Kc,Ae,xi,bi,wi,vt,ho,Oe))}}if(qe){const Fe=F.iconSizeData,Ve=zt.layout.get("icon-rotate").evaluate(ko,{},Ma),pt=td(qe,Ve,ia,Jc,Uo.iconScaleFactor),dr=vt?td(vt,Ve,ia,Jc,Uo.iconScaleFactor):void 0;Il=xd(ri,Kc,Ae,xi,bi,wi,qe,ho,Ve,null),cc=4*pt.length;let jr=null;"source"===Fe.kind?(jr=[Fy*zt.layout.get("icon-size").evaluate(ko,{},Ma)*Uo.iconScaleFactor],jr[0]>Mx&&ft(`${F.layerIds[0]}: Value for "icon-size" is >= ${Sx}. Reduce your "icon-size".`)):"composite"===Fe.kind&&(jr=[Fy*Uo.compositeIconSizes[0].evaluate(ko,{},Ma)*Uo.iconScaleFactor,Fy*Uo.compositeIconSizes[1].evaluate(ko,{},Ma)*Uo.iconScaleFactor],(jr[0]>Mx||jr[1]>Mx)&&ft(`${F.layerIds[0]}: Value for "icon-size" is >= ${Sx}. Reduce your "icon-size".`)),F.addSymbols(F.icon,pt,jr,zo,yo,ko,!1,Oe,Ae,rl.lineStartIndex,rl.lineLength,-1,_a,Ma,Ea,Ia),qc=F.icon.placedSymbolArray.length-1,dr&&(uc=4*dr.length,F.addSymbols(F.icon,dr,jr,zo,yo,ko,cx.vertical,Oe,Ae,rl.lineStartIndex,rl.lineLength,-1,_a,Ma,Ea,Ia),$c=F.icon.placedSymbolArray.length-1)}for(const Fe in Ve.horizontal){const qe=Ve.horizontal[Fe];Sl||(Wc=cu(qe.text),jr?Ql=vd(qe):Sl=xd(ri,Kc,Ae,xi,bi,wi,qe,dr,zt.layout.get("text-rotate").evaluate(ko,{},Ma),Qr));const vt=1===qe.positionedLines.length;if(jc+=yd(F,Oe,Ae,qe,pt,zt,jr,ko,Qr,rl,Ve.vertical?cx.horizontal:cx.horizontalOnly,vt?Object.keys(Ve.horizontal):[Fe],Hc,qc,Uo,_a,Ma,Ea),vt)break}Ve.vertical&&(Gc+=yd(F,Oe,Ae,Ve.vertical,pt,zt,jr,ko,Qr,rl,cx.vertical,["vertical"],Hc,$c,Uo,_a,Ma,Ea));let th=-1;const Z=(F,Ae)=>F?Math.max(F,Ae):Ae;th=Z(Ql,th),th=Z(ec,th),th=Z(tc,th);const ih=th>-1?1:0;F.glyphOffsetArray.length>=65535&&ft("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==ko.sortKey&&F.addToSortKeyRanges(F.symbolInstances.length,ko.sortKey),F.symbolInstances.emplaceBack(Ae.x,Ae.y,Kc.x,Kc.y,Kc.z,Hc.right>=0?Hc.right:-1,Hc.center>=0?Hc.center:-1,Hc.left>=0?Hc.left:-1,Hc.vertical>=0?Hc.vertical:-1,qc,$c,Wc,void 0!==Sl?Sl:F.collisionBoxArray.length,void 0!==Sl?Sl+1:F.collisionBoxArray.length,void 0!==Kl?Kl:F.collisionBoxArray.length,void 0!==Kl?Kl+1:F.collisionBoxArray.length,void 0!==Il?Il:F.collisionBoxArray.length,void 0!==Il?Il+1:F.collisionBoxArray.length,Jl||F.collisionBoxArray.length,Jl?Jl+1:F.collisionBoxArray.length,xi,jc,Gc,cc,uc,ih,0,Qc,eh,th,0,Jc?1:0)}(F,vt,Xn,pt,Oe,Fe,Ve,cc,F.layers[0],F.collisionBoxArray,Ae.index,Ae.sourceLayerIndex,F.index,Ma,rl,zt,0,Ea,Sl,ho,Ae,qe,ri,xi,bi,dr,jr)};if("line"===Il)for(const Ve of Uf(Ae.geometry,0,0,Vd,Vd)){const Ae=Of(Ve,_a,Ia,Oe.vertical||yo,Fe,ko,ia,F.overscaling,Vd);for(const Oe of Ae)yo&&bd(F,yo.text,Kl,Oe)||L(Ve,Oe,bi)}else if("line-center"===Il){for(const F of Ae.geometry)if(F.length>1){const Ae=Ff(F,Ia,Oe.vertical||yo,Fe,ko,ia);Ae&&L(F,Ae,bi)}}else if("Polygon"===Ae.type)for(const F of Lc(Ae.geometry,0)){const Ae=sd(F,16);L(F[0],new Cf(Ae.x,Ae.y,0,0,void 0),bi)}else if("LineString"===Ae.type)for(const F of Ae.geometry)L(F,new Cf(F[0].x,F[0].y,0,0,void 0),bi);else if("Point"===Ae.type)for(const F of Ae.geometry)for(const Ae of F)L([Ae],new Cf(Ae.x,Ae.y,0,0,void 0),bi)}const Sx=255,Mx=Sx*Fy;function yd(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho){const yo=function(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=[];if(0===Ae.positionedLines.length)return zt;const ri=Fe.layout.get("text-rotate").evaluate(qe,{})*Math.PI/180,xi=function(F){const Ae=F[0],Oe=F[1],Fe=Ae*Oe;return Fe>0?[Ae,-Oe]:Fe<0?[-Ae,Oe]:0===Ae?[Oe,Ae]:[Oe,-Ae]}(Oe);let bi=Math.abs(Ae.top-Ae.bottom);for(const F of Ae.positionedLines)bi-=F.lineOffset;const wi=Ae.positionedLines.length,dr=bi/wi;let jr=Ae.top-Oe[1];for(let F=0;F<wi;++F){const Fe=Ae.positionedLines[F];jr=ad(Ae,dr,jr,F);for(const F of Fe.positionedGlyphs){if(!F.rect)continue;const Fe=F.rect||{};let qe=ax+1,bi=!0,wi=1,dr=0;if(F.imageName){const Ae=pt[tr.build(F.imageName).getSerializedPrimary()];if(!Ae)continue;if(Ae.sdf){ft("SDF images are not supported in formatted text and will be ignored.");continue}bi=!1,wi=Ae.pixelRatio,qe=px/wi}const Qr=(Ve||vt)&&F.vertical,Xn=F.metrics.advance*F.scale/2,ho=F.metrics,yo=F.rect;if(null===yo)continue;vt&&Ae.verticalizable&&(dr=F.imageName?Xn-F.metrics.width*F.scale/2:0);const zo=Ve?[F.x+Xn,F.y]:[0,0];let ko=[0,0],Uo=[0,0],ia=!1;Ve||(Qr?(Uo=[F.x+Xn+xi[0],F.y+xi[1]-dr],ia=!0):ko=[F.x+Xn+Oe[0],F.y+Oe[1]-dr]);const _a=yo.w*F.scale/(wi*(F.localGlyph?xx:1)),Ma=yo.h*F.scale/(wi*(F.localGlyph?xx:1));let Ea,Ia,rl,Sl;if(Qr){const Ae=F.y-jr,Oe=new Jl(-Xn,Xn-Ae),Fe=-Math.PI/2,Ve=new Jl(...Uo);Ea=new Jl(-Xn+ko[0],ko[1]),Ea._rotateAround(Fe,Oe)._add(Ve),Ea.x+=-Ae+Xn,Ea.y-=(ho.left-qe)*F.scale;const pt=F.imageName?ho.advance*F.scale:ky*F.scale,vt=String.fromCodePoint(F.glyph);nf(vt)?Ea.x+=(1-qe)*F.scale:af(vt)?Ea.x+=pt-ho.height*F.scale+(-qe-1)*F.scale:Ea.x+=F.imageName||ho.width+2*qe===yo.w&&ho.height+2*qe===yo.h?(pt-Ma)/2:(pt-(ho.height+2*qe)*F.scale)/2,Ia=new Jl(Ea.x,Ea.y-_a),rl=new Jl(Ea.x+Ma,Ea.y),Sl=new Jl(Ea.x+Ma,Ea.y-_a)}else{const Ae=(ho.left-qe)*F.scale-Xn+ko[0],Oe=(-ho.top-qe)*F.scale+ko[1],Fe=Ae+_a,Ve=Oe+Ma;Ea=new Jl(Ae,Oe),Ia=new Jl(Fe,Oe),rl=new Jl(Ae,Ve),Sl=new Jl(Fe,Ve)}if(ri){let F;F=Ve?new Jl(0,0):ia?new Jl(xi[0],xi[1]):new Jl(Oe[0],Oe[1]),Ea._rotateAround(ri,F),Ia._rotateAround(ri,F),rl._rotateAround(ri,F),Sl._rotateAround(ri,F)}const Il=new Jl(0,0),Kl=new Jl(0,0);zt.push({tl:Ea,tr:Ia,bl:rl,br:Sl,texPrimary:Fe,texSecondary:void 0,writingMode:Ae.writingMode,glyphOffset:zo,sectionIndex:F.sectionIndex,isSDF:bi,pixelOffsetTL:Il,pixelOffsetBR:Kl,minFontScaleX:0,minFontScaleY:0})}}return zt}(0,Fe,zt,qe,pt,vt,Ve,F.allowVerticalPlacement),zo=F.textSizeData;let ko=null;"source"===zo.kind?(ko=[Fy*qe.layout.get("text-size").evaluate(vt,{},Xn)*jr.textScaleFactor],ko[0]>Mx&&ft(`${F.layerIds[0]}: Value for "text-size" is >= ${Sx}. Reduce your "text-size".`)):"composite"===zo.kind&&(ko=[Fy*jr.compositeTextSizes[0].evaluate(vt,{},Xn)*jr.textScaleFactor,Fy*jr.compositeTextSizes[1].evaluate(vt,{},Xn)*jr.textScaleFactor],(ko[0]>Mx||ko[1]>Mx)&&ft(`${F.layerIds[0]}: Value for "text-size" is >= ${Sx}. Reduce your "text-size".`)),F.addSymbols(F.text,yo,ko,zt,pt,vt,xi,Ae,Oe,ri.lineStartIndex,ri.lineLength,dr,Qr,Xn,ho,!1);for(const Ae of bi)wi[Ae]=F.text.placedSymbolArray.length-1;return 4*yo.length}function gd(F){for(const Ae in F)return F[Ae];return null}function xd(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri){let xi=pt.top,bi=pt.bottom,wi=pt.left,dr=pt.right;const jr=pt.collisionPadding;if(jr&&(wi-=jr[0],xi-=jr[1],dr+=jr[2],bi+=jr[3]),zt){const F=new Jl(wi,xi),Ae=new Jl(dr,xi),Oe=new Jl(wi,bi),Fe=new Jl(dr,bi),Ve=X(zt);let qe=new Jl(0,0);ri&&(qe=new Jl(ri[0],ri[1])),F._rotateAround(Ve,qe),Ae._rotateAround(Ve,qe),Oe._rotateAround(Ve,qe),Fe._rotateAround(Ve,qe),wi=Math.min(F.x,Ae.x,Oe.x,Fe.x),dr=Math.max(F.x,Ae.x,Oe.x,Fe.x),xi=Math.min(F.y,Ae.y,Oe.y,Fe.y),bi=Math.max(F.y,Ae.y,Oe.y,Fe.y)}return F.emplaceBack(Ae.x,Ae.y,Ae.z,Oe.x,Oe.y,wi,xi,dr,bi,vt,Fe,Ve,qe),F.length-1}function vd(F){F.collisionPadding&&(F.top-=F.collisionPadding[1],F.bottom+=F.collisionPadding[3]);const Ae=F.bottom-F.top;return Ae>0?Math.max(10,Ae):null}function bd(F,Ae,Oe,Fe){const Ve=F.compareText;if(Ae in Ve){const F=Ve[Ae];for(let Ae=F.length-1;Ae>=0;Ae--)if(Fe.dist(F[Ae])<Oe)return!0}else Ve[Ae]=[];return Ve[Ae].push(Fe),!1}function _d(F,Ae){const Oe=F.fovAboveCenter,Fe=F.elevation?F.elevation.getMinElevationBelowMSL()*Ae:0,Ve=(F._camera.position[2]*F.worldSize-Fe)/Math.cos(F._pitch),qe=Math.sin(Oe)*Ve/Math.sin(Math.max(Math.PI/2-F._pitch-Oe,.01));let pt=Math.sin(F._pitch)*qe+Ve;const vt=Ve*(1/F._horizonShift);if(!F.elevation||0===F.elevation.exaggeration()){let Ae=Math.max(F.zoom-17,0);F.isOrthographic&&(Ae/=10),pt*=1+Ae}return Math.min(1.01*pt,vt)}function wd(F,Ae){if(!Ae.isReprojectedInTileSpace)return{scale:1<<F.z,x:F.x,y:F.y,x2:F.x+1,y2:F.y+1,projection:Ae};const Oe=Math.pow(2,-F.z),Fe=F.x*Oe,Ve=(F.x+1)*Oe,qe=F.y*Oe,pt=(F.y+1)*Oe,vt=pl(Fe),zt=pl(Ve),ri=fl(qe),xi=fl(pt),bi=Ae.project(vt,ri),wi=Ae.project(zt,ri),dr=Ae.project(zt,xi),jr=Ae.project(vt,xi);let Qr=Math.min(bi.x,wi.x,dr.x,jr.x),Xn=Math.min(bi.y,wi.y,dr.y,jr.y),ho=Math.max(bi.x,wi.x,dr.x,jr.x),yo=Math.max(bi.y,wi.y,dr.y,jr.y);const zo=Oe/16;function b(F,Oe,Fe,Ve,qe,pt){const vt=(Fe+qe)/2,zt=(Ve+pt)/2,ri=Ae.project(pl(vt),fl(zt)),xi=Math.max(0,Qr-ri.x,Xn-ri.y,ri.x-ho,ri.y-yo);Qr=Math.min(Qr,ri.x),ho=Math.max(ho,ri.x),Xn=Math.min(Xn,ri.y),yo=Math.max(yo,ri.y),xi>zo&&(b(F,ri,Fe,Ve,vt,zt),b(ri,Oe,vt,zt,qe,pt))}b(bi,wi,Fe,qe,Ve,qe),b(wi,dr,Ve,qe,Ve,pt),b(dr,jr,Ve,pt,Fe,pt),b(jr,bi,Fe,pt,Fe,qe),Qr-=zo,Xn-=zo,ho+=zo,yo+=zo;const ko=1/Math.max(ho-Qr,yo-Xn);return{scale:ko,x:Qr*ko,y:Xn*ko,x2:ho*ko,y2:yo*ko,projection:Ae}}function Md(F,{x:Ae,y:Oe},Fe=0){return new Jl(((Ae-Fe)*F.scale-F.x)*Vd,(Oe*F.scale-F.y)*Vd)}const Ex=Sl.mat4.identity(new Float32Array(16));class Sd{constructor(F){this.spec=F,this.name=F.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(F,Ae){return{x:0,y:0,z:0}}unproject(F,Ae){return new il(0,0)}projectTilePoint(F,Ae,Oe){return{x:F,y:Ae,z:0}}locationPoint(F,Ae,Oe=!0){return F._coordinatePoint(F.locationCoordinate(Ae),Oe)}pixelsPerMeter(F,Ae){return hl(1,F)*Ae}pixelSpaceConversion(F,Ae,Oe){return 1}farthestPixelDistance(F){return _d(F,F.pixelsPerMeter)}pointCoordinate(F,Ae,Oe,Fe){const Ve=F.horizonLineFromTop(!1),qe=new Jl(Ae,Math.max(Ve,Oe));return F.rayIntersectionCoordinate(F.pointRayIntersection(qe,Fe))}pointCoordinate3D(F,Ae,Oe){const Fe=new Jl(Ae,Oe);if(F.elevation)return F.elevation.pointCoordinate(Fe);{const Ae=this.pointCoordinate(F,Fe.x,Fe.y,0);return[Ae.x,Ae.y,Ae.z]}}isPointAboveHorizon(F,Ae){if(F.elevation&&F.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(F,Ae.x,Ae.y);const Oe=F.horizonLineFromTop();return Ae.y<Oe}createInversionMatrix(F,Ae){return Ex}createTileMatrix(F,Ae,Oe){let Fe,Ve,qe;const pt=Oe.canonical,vt=Sl.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const zt=wd(pt,this);Fe=1,Ve=zt.x+Oe.wrap*zt.scale,qe=zt.y,Sl.mat4.scale(vt,vt,[Fe/zt.scale,Fe/zt.scale,F.pixelsPerMeter/Ae])}else Fe=Ae/F.zoomScale(pt.z),Ve=(pt.x+Math.pow(2,pt.z)*Oe.wrap)*Fe,qe=pt.y*Fe;return Sl.mat4.translate(vt,vt,[Ve,qe,0]),Sl.mat4.scale(vt,vt,[Fe/Vd,Fe/Vd,1]),vt}upVector(F,Ae,Oe){return[0,0,1]}upVectorScale(F,Ae,Oe){return{metersToTile:1}}}class Id extends Sd{constructor(F){super(F),this.range=[4,7],this.center=F.center||[-96,37.5];const[Ae,Oe]=this.parallels=F.parallels||[29.5,45.5],Fe=Math.sin(X(Ae));this.n=(Fe+Math.sin(X(Oe)))/2,this.c=1+Fe*(2*this.n-Fe),this.r0=Math.sqrt(this.c)/this.n}project(F,Ae){const{n:Oe,c:Fe,r0:Ve}=this,qe=X(F-this.center[0]),pt=X(Ae),vt=Math.sqrt(Fe-2*Oe*Math.sin(pt))/Oe;return{x:vt*Math.sin(qe*Oe),y:vt*Math.cos(qe*Oe)-Ve,z:0}}unproject(F,Ae){const{n:Oe,c:Fe,r0:Ve}=this,qe=Ve+Ae;let pt=Math.atan2(F,Math.abs(qe))*Math.sign(qe);qe*Oe<0&&(pt-=Math.PI*Math.sign(F)*Math.sign(qe));const vt=X(this.center[0])*Oe;pt=et(pt,-Math.PI-vt,Math.PI-vt);const zt=Q(Z(pt/Oe)+this.center[0],-180,180),ri=Math.asin(Q((Fe-(F*F+qe*qe)*Oe*Oe)/(2*Oe),-1,1)),xi=Q(Z(ri),-jm,jm);return new il(zt,xi)}}const Ax=1.340264,Cx=-.081106,Rx=893e-6,kx=.003796,Ox=Math.sqrt(3)/2;class Bd extends Sd{project(F,Ae){Ae=Ae/180*Math.PI,F=F/180*Math.PI;const Oe=Math.asin(Ox*Math.sin(Ae)),Fe=Oe*Oe,Ve=Fe*Fe*Fe;return{x:.5*(F*Math.cos(Oe)/(Ox*(Ax+3*Cx*Fe+Ve*(7*Rx+9*kx*Fe)))/Math.PI+.5),y:1-.5*(Oe*(Ax+Cx*Fe+Ve*(Rx+kx*Fe))/Math.PI+1),z:0}}unproject(F,Ae){F=(2*F-.5)*Math.PI;let Oe=Ae=(2*(1-Ae)-1)*Math.PI,Fe=Oe*Oe,Ve=Fe*Fe*Fe;for(let F,qe,pt,vt=0;vt<12&&(qe=Oe*(Ax+Cx*Fe+Ve*(Rx+kx*Fe))-Ae,pt=Ax+3*Cx*Fe+Ve*(7*Rx+9*kx*Fe),F=qe/pt,Oe=Q(Oe-F,-Math.PI/3,Math.PI/3),Fe=Oe*Oe,Ve=Fe*Fe*Fe,!(Math.abs(F)<1e-12));++vt);const qe=Ox*F*(Ax+3*Cx*Fe+Ve*(7*Rx+9*kx*Fe))/Math.cos(Oe),pt=Math.asin(Math.sin(Oe)/Ox),vt=Q(180*qe/Math.PI,-180,180),zt=Q(180*pt/Math.PI,-jm,jm);return new il(vt,zt)}}class Cd extends Sd{constructor(F){super(F),this.wrap=!0,this.supportsWorldCopies=!0}project(F,Ae){return{x:.5+F/360,y:.5-Ae/360,z:0}}unproject(F,Ae){const Oe=360*(F-.5),Fe=Q(360*(.5-Ae),-jm,jm);return new il(Oe,Fe)}}const Fx=Math.PI/2;function Dd(F){return Math.tan((Fx+F)/2)}class Ld extends Sd{constructor(F){super(F),this.center=F.center||[0,30];const[Ae,Oe]=this.parallels=F.parallels||[30,30];let Fe=X(Ae),Ve=X(Oe);this.southernCenter=Fe+Ve<0,this.southernCenter&&(Fe=-Fe,Ve=-Ve);const qe=Math.cos(Fe),pt=Dd(Fe);this.n=Fe===Ve?Math.sin(Fe):Math.log(qe/Math.cos(Ve))/Math.log(Dd(Ve)/pt),this.f=qe*Math.pow(Dd(Fe),this.n)/this.n}project(F,Ae){Ae=X(Ae),this.southernCenter&&(Ae=-Ae),F=X(F-this.center[0]);const Oe=1e-6,{n:Fe,f:Ve}=this;Ve>0?Ae<-Fx+Oe&&(Ae=-Fx+Oe):Ae>Fx-Oe&&(Ae=Fx-Oe);const qe=Ve/Math.pow(Dd(Ae),Fe);let pt=qe*Math.sin(Fe*F),vt=Ve-qe*Math.cos(Fe*F);return pt=.5*(pt/Math.PI+.5),vt=.5*(vt/Math.PI+.5),{x:pt,y:this.southernCenter?vt:1-vt,z:0}}unproject(F,Ae){F=(2*F-.5)*Math.PI,this.southernCenter&&(Ae=1-Ae),Ae=(2*(1-Ae)-.5)*Math.PI;const{n:Oe,f:Fe}=this,Ve=Fe-Ae,qe=Math.sign(Ve),pt=Math.sign(Oe)*Math.sqrt(F*F+Ve*Ve);let vt=Math.atan2(F,Math.abs(Ve))*qe;Ve*Oe<0&&(vt-=Math.PI*Math.sign(F)*qe);const zt=Q(Z(vt/Oe)+this.center[0],-180,180),ri=Q(Z(2*Math.atan(Math.pow(Fe/pt,1/Oe))-Fx),-jm,jm);return new il(zt,this.southernCenter?-ri:ri)}}class Rd extends Sd{constructor(F){super(F),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(F,Ae){return{x:ul(F),y:cl(Ae),z:0}}unproject(F,Ae){const Oe=pl(F),Fe=fl(Ae);return new il(Oe,Fe)}}const Bx=X(jm);class Od extends Sd{project(F,Ae){const Oe=(Ae=X(Ae))*Ae,Fe=Oe*Oe;return{x:.5*((F=X(F))*(.8707-.131979*Oe+Fe*(Fe*(.003971*Oe-.001529*Fe)-.013791))/Math.PI+.5),y:1-.5*(Ae*(1.007226+Oe*(.015085+Fe*(.028874*Oe-.044475-.005916*Fe)))/Math.PI+1),z:0}}unproject(F,Ae){F=(2*F-.5)*Math.PI;let Oe=Ae=(2*(1-Ae)-1)*Math.PI,Fe=25,Ve=0,qe=Oe*Oe;do{qe=Oe*Oe;const F=qe*qe;Ve=(Oe*(1.007226+qe*(.015085+F*(.028874*qe-.044475-.005916*F)))-Ae)/(1.007226+qe*(.045255+F*(.259866*qe-.311325-.005916*11*F))),Oe=Q(Oe-Ve,-Bx,Bx)}while(Math.abs(Ve)>1e-6&&--Fe>0);qe=Oe*Oe;const pt=Q(Z(F/(.8707+qe*(qe*(qe*qe*qe*(.003971-.001529*qe)-.013791)-.131979))),-180,180),vt=Z(Oe);return new il(pt,vt)}}const Vx=X(jm);class Ud extends Sd{project(F,Ae){Ae=X(Ae),F=X(F);const Oe=Math.cos(Ae),Fe=2/Math.PI,Ve=Math.acos(Oe*Math.cos(F/2)),qe=Math.sin(Ve)/Ve,pt=.5*(F*Fe+2*Oe*Math.sin(F/2)/qe)||0,vt=.5*(Ae+Math.sin(Ae)/qe)||0;return{x:.5*(pt/Math.PI+.5),y:1-.5*(vt/Math.PI+1),z:0}}unproject(F,Ae){let Oe=F=(2*F-.5)*Math.PI,Fe=Ae=(2*(1-Ae)-1)*Math.PI,Ve=25;const qe=1e-6;let pt=0,vt=0;do{const Ve=Math.cos(Fe),qe=Math.sin(Fe),zt=2*qe*Ve,ri=qe*qe,xi=Ve*Ve,bi=Math.cos(Oe/2),wi=Math.sin(Oe/2),dr=2*bi*wi,jr=wi*wi,Qr=1-xi*bi*bi,Xn=Qr?1/Qr:0,ho=Qr?Math.acos(Ve*bi)*Math.sqrt(1/Qr):0,yo=.5*(2*ho*Ve*wi+2*Oe/Math.PI)-F,zo=.5*(ho*qe+Fe)-Ae,ko=.5*Xn*(xi*jr+ho*Ve*bi*ri)+1/Math.PI,Uo=Xn*(dr*zt/4-ho*qe*wi),ia=.125*Xn*(zt*wi-ho*qe*xi*dr),_a=.5*Xn*(ri*bi+ho*jr*Ve)+.5,Ma=Uo*ia-_a*ko;pt=(zo*Uo-yo*_a)/Ma,vt=(yo*ia-zo*ko)/Ma,Oe=Q(Oe-pt,-Math.PI,Math.PI),Fe=Q(Fe-vt,-Vx,Vx)}while((Math.abs(pt)>qe||Math.abs(vt)>qe)&&--Ve>0);return new il(Z(Oe),Z(Fe))}}class jd extends Sd{constructor(F){super(F),this.center=F.center||[0,0],this.parallels=F.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(X(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(F,Ae){const{scale:Oe,cosPhi:Fe}=this;return{x:X(F)*Fe*Oe+.5,y:-Math.sin(X(Ae))/Fe*Oe+.5,z:0}}unproject(F,Ae){const{scale:Oe,cosPhi:Fe}=this,Ve=-(Ae-.5)/Oe,qe=Q(Z((F-.5)/Oe)/Fe,-180,180),pt=Math.asin(Q(Ve*Fe,-1,1)),vt=Q(Z(pt),-jm,jm);return new il(qe,vt)}}class qd extends Rd{constructor(F){super(F),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(F,Ae,Oe){const Fe=ku(F,Ae,Oe),Ve=Cu(Au(Oe));return Sl.vec3.transformMat4(Fe,Fe,Ve),{x:Fe[0],y:Fe[1],z:Fe[2]}}locationPoint(F,Ae){const Oe=el(Ae.lat,Ae.lng),Fe=Sl.vec3.normalize([],Oe),Ve=F.elevation?F.elevation.getAtPointOrZero(F.locationCoordinate(Ae),F._centerAltitude):F._centerAltitude,qe=hl(1,0)*Vd*Ve;Sl.vec3.scaleAndAdd(Oe,Oe,Fe,qe);const pt=Sl.mat4.identity(new Float64Array(16));return Sl.mat4.multiply(pt,F.pixelMatrix,F.globeMatrix),Sl.vec3.transformMat4(Oe,Oe,pt),new Jl(Oe[0],Oe[1])}pixelsPerMeter(F,Ae){return hl(1,0)*Ae}pixelSpaceConversion(F,Ae,Oe){const Fe=hl(1,F)*Ae,Ve=ze(hl(1,45)*Ae,Fe,Oe);return this.pixelsPerMeter(F,Ae)/Ve}createTileMatrix(F,Ae,Oe){const Fe=Vu(Au(Oe.canonical));return Sl.mat4.multiply(new Float64Array(16),F.globeMatrix,Fe)}createInversionMatrix(F,Ae){const{center:Oe}=F,Fe=Cu(Au(Ae));return Sl.mat4.rotateY(Fe,Fe,X(Oe.lng)),Sl.mat4.rotateX(Fe,Fe,X(Oe.lat)),Sl.mat4.scale(Fe,Fe,[F._pixelsPerMercatorPixel,F._pixelsPerMercatorPixel,1]),Float32Array.from(Fe)}pointCoordinate(F,Ae,Oe,Fe){return _u(F,Ae,Oe,!0)||new bl(0,0)}pointCoordinate3D(F,Ae,Oe){const Fe=this.pointCoordinate(F,Ae,Oe,0);return[Fe.x,Fe.y,Fe.z]}isPointAboveHorizon(F,Ae){return!_u(F,Ae.x,Ae.y,!1)}farthestPixelDistance(F){const Ae=function(F,Ae){const Oe=F.cameraToCenterDistance,Fe=F._centerAltitude*Ae,Ve=F._camera,qe=F._camera.forward(),pt=Sl.vec3.add([],Sl.vec3.scale([],qe,-Oe),[0,0,Fe]),vt=F.worldSize/(2*Math.PI),zt=[0,0,-vt],ri=F.width/F.height,xi=Math.tan(F.fovAboveCenter),bi=Sl.vec3.scale([],Ve.up(),xi),wi=Sl.vec3.scale([],Ve.right(),xi*ri),dr=Sl.vec3.normalize([],Sl.vec3.add([],Sl.vec3.add([],qe,bi),wi)),jr=[];let Qr;if(new hu(pt,dr).closestPointOnSphere(zt,vt,jr)){const Ae=Sl.vec3.add([],jr,zt),Oe=Sl.vec3.sub([],Ae,pt);Qr=Math.cos(F.fovAboveCenter)*Sl.vec3.length(Oe)}else{const F=Sl.vec3.sub([],pt,zt),Ae=Sl.vec3.sub([],zt,pt);Sl.vec3.normalize(Ae,Ae);const Oe=Sl.vec3.length(F)-vt;Qr=Math.sqrt(Oe*(Oe+2*vt));const Fe=Math.acos(Qr/(vt+Oe))-Math.acos(Sl.vec3.dot(qe,Ae));Qr*=Math.cos(Fe)}return 1.01*Qr}(F,this.pixelsPerMeter(F.center.lat,F.worldSize)),Oe=Fu(F.zoom);if(Oe>0){const Fe=_d(F,hl(1,F.center.lat)*F.worldSize),Ve=F.worldSize/(2*Math.PI),qe=Math.max(F.width,F.height)/F.worldSize*Math.PI;return ze(Ae,Fe+Ve*(1-Math.cos(qe)),Math.pow(Oe,10))}return Ae}upVector(F,Ae,Oe){return ku(Ae,Oe,F,1)}upVectorScale(F){return{metersToTile:vu(Tu(Au(F)))}}}function $d(F){const Ae=F.parallels,Oe=!!Ae&&Math.abs(Ae[0]+Ae[1])<.01;switch(F.name){case"mercator":return new Rd(F);case"equirectangular":return new Cd(F);case"naturalEarth":return new Od(F);case"equalEarth":return new Bd(F);case"winkelTripel":return new Ud(F);case"albers":return Oe?new jd(F):new Id(F);case"lambertConformalConic":return Oe?new jd(F):new Ld(F);case"globe":return new qd(F)}throw new Error(`Invalid projection name: ${F.name}`)}const Ux=N_.VectorTileFeature.types,Gx=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Xd(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi){const dr=vt?Math.min(Mx,Math.round(vt[0])):0,jr=vt?Math.min(Mx,Math.round(vt[1])):0;F.emplaceBack(Ae,Oe,Math.round(32*Fe),Math.round(32*Ve),qe,pt,(dr<<1)+(zt?1:0),jr,16*ri,16*xi,256*bi,256*wi)}function Zd(F,Ae,Oe){F.emplaceBack(Ae,Oe)}function Hd(F,Ae,Oe,Fe,Ve,qe,pt){F.emplaceBack(Ae,Oe,Fe,Ve,qe,pt)}function Wd(F,Ae,Oe,Fe,Ve){F.emplaceBack(Ae,Oe,Fe,Ve),F.emplaceBack(Ae,Oe,Fe,Ve),F.emplaceBack(Ae,Oe,Fe,Ve),F.emplaceBack(Ae,Oe,Fe,Ve)}function Kd(F){for(const Ae of F.sections)if(ba(Ae.text))return!0;return!1}class Jd{constructor(F){this.layoutVertexArray=new Ps,this.indexArray=new Ls,this.programConfigurations=F,this.segments=new po,this.dynamicLayoutVertexArray=new Es,this.opacityVertexArray=new ks,this.placedSymbolArray=new to,this.iconTransitioningVertexArray=new Ts,this.globeExtVertexArray=new zs,this.zOffsetVertexArray=new Os}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(F,Ae,Oe,Fe,Ve){this.isEmpty()||(Oe&&(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,dy.members),this.indexBuffer=F.createIndexBuffer(this.indexArray,Ae),this.dynamicLayoutVertexBuffer=F.createVertexBuffer(this.dynamicLayoutVertexArray,Sy.members,!0),this.opacityVertexBuffer=F.createVertexBuffer(this.opacityVertexArray,Gx,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=F.createVertexBuffer(this.iconTransitioningVertexArray,Iy.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=F.createVertexBuffer(this.globeExtVertexArray,_y.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||Ve)&&(this.zOffsetVertexBuffer=F.createVertexBuffer(this.zOffsetVertexArray,Ey.members,!0)),this.opacityVertexBuffer.itemSize=1),(Oe||Fe)&&this.programConfigurations.upload(F))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}oa(Jd,"SymbolBuffers");class Qd{constructor(F,Ae,Oe){this.layoutVertexArray=new F,this.layoutAttributes=Ae,this.indexArray=new Oe,this.segments=new po,this.collisionVertexArray=new Ds,this.collisionVertexArrayExt=new Es}upload(F){this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=F.createVertexBuffer(this.collisionVertexArray,Cy.members,!0),this.collisionVertexBufferExt=F.createVertexBuffer(this.collisionVertexArrayExt,Dy.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}oa(Qd,"CollisionBuffers");class tm{constructor(F){this.collisionBoxArray=F.collisionBoxArray,this.zoom=F.zoom,this.lut=F.lut,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.pixelRatio=F.pixelRatio,this.sourceLayerIndex=F.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Sl.mat4.identity([]),this.placementViewportMatrix=Sl.mat4.identity([]);const Ae=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Kp(this.zoom,Ae["text-size"]),this.iconSizeData=Kp(this.zoom,Ae["icon-size"]);const Oe=this.layers[0].layout,Fe=Oe.get("symbol-sort-key"),Ve=Oe.get("symbol-z-order");this.canOverlap=Oe.get("text-allow-overlap")||Oe.get("icon-allow-overlap")||Oe.get("text-ignore-placement")||Oe.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==Ve&&void 0!==Fe.constantOr(1),this.sortFeaturesByY=("viewport-y"===Ve||"auto"===Ve&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=Oe.get("text-writing-mode").map((F=>cx[F])),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.sourceID=F.sourceID,this.projection=F.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=Oe.get("symbol-z-elevate"),this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new Jd(new No(this.layers,{zoom:this.zoom,lut:this.lut},(F=>F.startsWith("text")||F.startsWith("symbol")))),this.icon=new Jd(new No(this.layers,{zoom:this.zoom,lut:this.lut},(F=>F.startsWith("icon")||F.startsWith("symbol")))),this.glyphOffsetArray=new no,this.lineVertexArray=new io,this.symbolInstances=new ro}calculateGlyphDependencies(F,Ae,Oe,Fe,Ve){for(const Oe of F){const F=Oe.codePointAt(0);if(void 0===F)break;if(Ae[F]=!0,Fe&&Ve&&F<=65535){const F=Vy[Oe];F&&(Ae[F.charCodeAt(0)]=!0)}}}updateFootprints(F,Ae){}updateReplacement(F,Ae){if(Ae.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=Ae.updateTime;const Oe=Ae.getReplacementRegionsForTile(F.toUnwrapped(),!0);return!Ah(this.activeReplacements,Oe)&&(this.activeReplacements=Oe,!0)}populate(F,Ae,Oe,Fe){const Ve=this.layers[0],qe=Ve.layout,pt="globe"===this.projection.name,vt=qe.get("text-font"),zt=qe.get("text-field"),ri=qe.get("icon-image"),[xi,bi]=qe.get("icon-size-scale-range"),wi=Q(Ae.scaleFactor||1,xi,bi),dr=("constant"!==zt.value.kind||zt.value.value instanceof Je&&!zt.value.value.isEmpty()||zt.value.value.toString().length>0)&&("constant"!==vt.value.kind||vt.value.value.length>0),jr="constant"!==ri.value.kind||!!ri.value.value||Object.keys(ri.parameters).length>0,Qr=qe.get("symbol-sort-key");if(this.features=[],!dr&&!jr)return;const Xn=Ae.iconDependencies,ho=Ae.glyphDependencies,yo=Ae.availableImages,zo=new Ca(this.zoom);for(const{feature:Ae,id:zt,index:ri,sourceLayerIndex:xi}of F){const F=Ve._featureFilter.needGeometry,bi=El(Ae,F);if(!Ve._featureFilter.filter(zo,bi,Oe))continue;if(F||(bi.geometry=zl(Ae,Oe,Fe)),pt&&1!==Ae.type&&Oe.z<=5){const F=bi.geometry,Ae=.98078528056,n=(F,Fe)=>{const Ve=ku(F.x,F.y,Oe,1),qe=ku(Fe.x,Fe.y,Oe,1);return Sl.vec3.dot(Ve,qe)<Ae};for(let Ae=0;Ae<F.length;Ae++)F[Ae]=Al(F[Ae],n)}let ko,Uo;if(dr){const F=Ve.getValueAndResolveTokens("text-field",bi,Oe,yo),Ae=Je.factory(F);Kd(Ae)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===ka()||this.hasRTLText&&uf.isParsed())&&(ko=ef(Ae,Ve,bi))}if(jr){const F=Ve.getValueAndResolveTokens("icon-image",bi,Oe,yo);Uo=F instanceof tr?F:tr.build(F)}if(!ko&&!Uo)continue;const ia=this.sortFeaturesByKey?Qr.evaluate(bi,{},Oe):void 0,_a={id:zt,text:ko,icon:Uo,index:ri,sourceLayerIndex:xi,geometry:bi.geometry,properties:Ae.properties,type:Ux[Ae.type],sortKey:ia};if(this.features.push(_a),Uo){const F=Wp(this.iconSizeData,this.layers[0]._unevaluatedLayout._values["icon-size"],Oe,this.zoom,_a)*wi*this.pixelRatio,Ae=Uo.getPrimary().scaleSelf(F);if(Xn[Ae.id]=Xn[Ae.id]||[],Xn[Ae.id].push(Ae),Uo.nameSecondary){const Ae=Uo.getSecondary().scaleSelf(F);Xn[Ae.id]=Xn[Ae.id]||[],Xn[Ae.id].push(Ae)}}if(ko){const F=vt.evaluate(bi,{},Oe).join(","),Ae="map"===qe.get("text-rotation-alignment")&&"point"!==qe.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(cx.vertical)>=0;for(const Oe of ko.sections)if(Oe.image){const F=Oe.image.getPrimary().scaleSelf(this.pixelRatio);Xn[F.id]=Xn[F.id]||[],Xn[F.id].push(F)}else{const Fe=fa(ko.toString()),Ve=Oe.fontStack||F,qe=ho[Ve]=ho[Ve]||{};this.calculateGlyphDependencies(Oe.text,qe,Ae,this.allowVerticalPlacement,Fe)}}}"line"===qe.get("symbol-placement")&&(this.features=function(F){const Ae={},Oe={},Fe=[];let Ve=0;function a(Ae){Fe.push(F[Ae]),Ve++}function s(F,Ae,Ve){const qe=Oe[F];return delete Oe[F],Oe[Ae]=qe,Fe[qe].geometry[0].pop(),Fe[qe].geometry[0]=Fe[qe].geometry[0].concat(Ve[0]),qe}function o(F,Oe,Ve){const qe=Ae[Oe];return delete Ae[Oe],Ae[F]=qe,Fe[qe].geometry[0].shift(),Fe[qe].geometry[0]=Ve[0].concat(Fe[qe].geometry[0]),qe}function l(F,Ae,Oe){const Fe=Oe?Ae[0][Ae[0].length-1]:Ae[0][0];return`${F}:${Fe.x}:${Fe.y}`}for(let qe=0;qe<F.length;qe++){const pt=F[qe],vt=pt.geometry,zt=pt.text?pt.text.toString():null;if(!zt){a(qe);continue}const ri=l(zt,vt),xi=l(zt,vt,!0);if(ri in Oe&&xi in Ae&&Oe[ri]!==Ae[xi]){const F=o(ri,xi,vt),Ve=s(ri,xi,Fe[F].geometry);delete Ae[ri],delete Oe[xi],Oe[l(zt,Fe[Ve].geometry,!0)]=Ve,Fe[F].geometry=null}else ri in Oe?s(ri,xi,vt):xi in Ae?o(ri,xi,vt):(a(qe),Ae[ri]=Ve-1,Oe[xi]=Ve-1)}return Fe.filter((F=>F.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((F,Ae)=>F.sortKey-Ae.sortKey))}update(F,Ae,Oe,Fe,Ve,qe,pt){this.text.programConfigurations.updatePaintArrays(F,Ae,Ve,Oe,Fe,qe,pt),this.icon.programConfigurations.updatePaintArrays(F,Ae,Ve,Oe,Fe,qe,pt)}updateZOffset(){const t=(Ae,Oe,Fe)=>{F+=Oe,F>Ae.length&&Ae.resize(F);for(let Ve=-Oe;Ve<0;Ve++)Ae.emplace(Ve+F,Fe)},e=(F,Oe,Fe)=>{Ae+=Oe,Ae>F.length&&F.resize(Ae);for(let Ve=-Oe;Ve<0;Ve++)F.emplace(Ve+Ae,Fe)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let F=0,Ae=0;for(let F=0;F<this.symbolInstances.length;F++){const Ae=this.symbolInstances.get(F),{numHorizontalGlyphVertices:Oe,numVerticalGlyphVertices:Fe,numIconVertices:Ve}=Ae,qe=Ae.zOffset,pt=Ve>0;if((Oe>0||Fe>0)&&(t(this.text.zOffsetVertexArray,Oe,qe),t(this.text.zOffsetVertexArray,Fe,qe)),pt){const{placedIconSymbolIndex:F,verticalPlacedIconSymbolIndex:Oe}=Ae;F>=0&&e(this.icon.zOffsetVertexArray,Ve,qe),Oe>=0&&e(this.icon.zOffsetVertexArray,Ae.numVerticalIconVertices,qe)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(F){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(F),this.iconCollisionBox.upload(F)),this.text.upload(F,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(F,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=$d(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(F,Ae){const Oe=this.lineVertexArray.length;if(void 0!==F.segment)for(const{x:F,y:Oe}of Ae)this.lineVertexArray.emplaceBack(F,Oe);return{lineStartIndex:Oe,lineLength:this.lineVertexArray.length-Oe}}addSymbols(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr){const Xn=F.indexArray,ho=F.layoutVertexArray,yo=F.globeExtVertexArray,zo=F.segments.prepareSegment(4*Ae.length,ho,Xn,this.canOverlap?qe.sortKey:void 0),ko=this.glyphOffsetArray.length,Uo=zo.vertexLength,ia=this.allowVerticalPlacement&&pt===cx.vertical?Math.PI/2:0,_a=qe.text&&qe.text.sections;for(let Fe=0;Fe<Ae.length;Fe++){const{tl:Ve,tr:pt,bl:ri,br:xi,texPrimary:bi,texSecondary:ko,pixelOffsetTL:Uo,pixelOffsetBR:Ma,minFontScaleX:Ea,minFontScaleY:Ia,glyphOffset:rl,isSDF:Sl,sectionIndex:Il}=Ae[Fe],Kl=zo.vertexLength,Jl=rl[1];if(Xd(ho,zt.x,zt.y,Ve.x,Jl+Ve.y,bi.x,bi.y,Oe,Sl,Uo.x,Uo.y,Ea,Ia),Xd(ho,zt.x,zt.y,pt.x,Jl+pt.y,bi.x+bi.w,bi.y,Oe,Sl,Ma.x,Uo.y,Ea,Ia),Xd(ho,zt.x,zt.y,ri.x,Jl+ri.y,bi.x,bi.y+bi.h,Oe,Sl,Uo.x,Ma.y,Ea,Ia),Xd(ho,zt.x,zt.y,xi.x,Jl+xi.y,bi.x+bi.w,bi.y+bi.h,Oe,Sl,Ma.x,Ma.y,Ea,Ia),vt){const{x:Ae,y:Oe,z:Fe}=vt.anchor,[Ve,qe,pt]=vt.up;Hd(yo,Ae,Oe,Fe,Ve,qe,pt),Hd(yo,Ae,Oe,Fe,Ve,qe,pt),Hd(yo,Ae,Oe,Fe,Ve,qe,pt),Hd(yo,Ae,Oe,Fe,Ve,qe,pt),Wd(F.dynamicLayoutVertexArray,Ae,Oe,Fe,ia)}else Wd(F.dynamicLayoutVertexArray,zt.x,zt.y,zt.z,ia);if(Qr){const Ae=ko||bi;Zd(F.iconTransitioningVertexArray,Ae.x,Ae.y),Zd(F.iconTransitioningVertexArray,Ae.x+Ae.w,Ae.y),Zd(F.iconTransitioningVertexArray,Ae.x,Ae.y+Ae.h),Zd(F.iconTransitioningVertexArray,Ae.x+Ae.w,Ae.y+Ae.h)}Xn.emplaceBack(Kl,Kl+1,Kl+2),Xn.emplaceBack(Kl+1,Kl+2,Kl+3),zo.vertexLength+=4,zo.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(rl[0]),Fe!==Ae.length-1&&Il===Ae[Fe+1].sectionIndex||F.programConfigurations.populatePaintArrays(ho.length,qe,qe.index,{},wi,dr,jr,_a&&_a[Il])}const Ma=vt?vt.anchor:zt;F.placedSymbolArray.emplaceBack(Ma.x,Ma.y,Ma.z,zt.x,zt.y,ko,this.glyphOffsetArray.length-ko,Uo,ri,xi,zt.segment,Oe?Oe[0]:0,Oe?Oe[1]:0,Fe[0],Fe[1],pt,0,!1,0,bi,0)}_commitLayoutVertex(F,Ae,Oe,Fe,Ve,qe,pt){F.emplaceBack(Ae,Oe,Fe,Ve,qe,Math.round(pt.x),Math.round(pt.y))}_addCollisionDebugVertices(F,Ae,Oe,Fe,Ve,qe,pt){const vt=Oe.segments.prepareSegment(4,Oe.layoutVertexArray,Oe.indexArray),zt=vt.vertexLength,ri=pt.tileAnchorX,xi=pt.tileAnchorY;for(let F=0;F<4;F++)Oe.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(Oe.collisionVertexArrayExt,Ae,F.padding,pt.zOffset),this._commitLayoutVertex(Oe.layoutVertexArray,Fe,Ve,qe,ri,xi,new Jl(F.x1,F.y1)),this._commitLayoutVertex(Oe.layoutVertexArray,Fe,Ve,qe,ri,xi,new Jl(F.x2,F.y1)),this._commitLayoutVertex(Oe.layoutVertexArray,Fe,Ve,qe,ri,xi,new Jl(F.x2,F.y2)),this._commitLayoutVertex(Oe.layoutVertexArray,Fe,Ve,qe,ri,xi,new Jl(F.x1,F.y2)),vt.vertexLength+=4;const bi=Oe.indexArray;bi.emplaceBack(zt,zt+1),bi.emplaceBack(zt+1,zt+2),bi.emplaceBack(zt+2,zt+3),bi.emplaceBack(zt+3,zt),vt.primitiveLength+=4}_addTextDebugCollisionBoxes(F,Ae,Oe,Fe,Ve,qe){for(let pt=Fe;pt<Ve;pt++){const Fe=Oe.get(pt),Ve=this.getSymbolInstanceTextSize(F,qe,Ae,pt);this._addCollisionDebugVertices(Fe,Ve,this.textCollisionBox,Fe.projectedAnchorX,Fe.projectedAnchorY,Fe.projectedAnchorZ,qe)}}_addIconDebugCollisionBoxes(F,Ae,Oe,Fe,Ve,qe){for(let pt=Fe;pt<Ve;pt++){const Fe=Oe.get(pt),Ve=this.getSymbolInstanceIconSize(F,Ae,qe.placedIconSymbolIndex);this._addCollisionDebugVertices(Fe,Ve,this.iconCollisionBox,Fe.projectedAnchorX,Fe.projectedAnchorY,Fe.projectedAnchorZ,qe)}}generateCollisionDebugBuffers(F,Ae,Oe){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Qd(Cs,Ry.members,Ts),this.iconCollisionBox=new Qd(Cs,Ry.members,Ts);const Fe=Qp(this.iconSizeData,F),Ve=Qp(this.textSizeData,F,Oe);for(let Oe=0;Oe<this.symbolInstances.length;Oe++){const qe=this.symbolInstances.get(Oe);this._addTextDebugCollisionBoxes(Ve,F,Ae,qe.textBoxStartIndex,qe.textBoxEndIndex,qe),this._addTextDebugCollisionBoxes(Ve,F,Ae,qe.verticalTextBoxStartIndex,qe.verticalTextBoxEndIndex,qe),this._addIconDebugCollisionBoxes(Fe,F,Ae,qe.iconBoxStartIndex,qe.iconBoxEndIndex,qe),this._addIconDebugCollisionBoxes(Fe,F,Ae,qe.verticalIconBoxStartIndex,qe.verticalIconBoxEndIndex,qe)}}getSymbolInstanceTextSize(F,Ae,Oe,Fe){const Ve=this.text.placedSymbolArray.get(Ae.rightJustifiedTextSymbolIndex>=0?Ae.rightJustifiedTextSymbolIndex:Ae.centerJustifiedTextSymbolIndex>=0?Ae.centerJustifiedTextSymbolIndex:Ae.leftJustifiedTextSymbolIndex>=0?Ae.leftJustifiedTextSymbolIndex:Ae.verticalPlacedTextSymbolIndex>=0?Ae.verticalPlacedTextSymbolIndex:Fe),qe=Jp(this.textSizeData,F,Ve)/ky;return this.tilePixelRatio*qe}getSymbolInstanceIconSize(F,Ae,Oe){const Fe=this.icon.placedSymbolArray.get(Oe),Ve=Jp(this.iconSizeData,F,Fe);return this.tilePixelRatio*Ve}_commitDebugCollisionVertexUpdate(F,Ae,Oe,Fe){F.emplaceBack(Ae,-Oe,-Oe,Fe),F.emplaceBack(Ae,Oe,-Oe,Fe),F.emplaceBack(Ae,Oe,Oe,Fe),F.emplaceBack(Ae,-Oe,Oe,Fe)}_updateTextDebugCollisionBoxes(F,Ae,Oe,Fe,Ve,qe,pt){for(let pt=Fe;pt<Ve;pt++){const Fe=Oe.get(pt),Ve=this.getSymbolInstanceTextSize(F,qe,Ae,pt);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,Ve,Fe.padding,qe.zOffset)}}_updateIconDebugCollisionBoxes(F,Ae,Oe,Fe,Ve,qe,pt){for(let pt=Fe;pt<Ve;pt++){const Fe=Oe.get(pt),Ve=this.getSymbolInstanceIconSize(F,Ae,qe.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,Ve,Fe.padding,qe.zOffset)}}updateCollisionDebugBuffers(F,Ae,Oe,Fe){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const Ve=Qp(this.iconSizeData,F,Fe),qe=Qp(this.textSizeData,F,Oe);for(let pt=0;pt<this.symbolInstances.length;pt++){const vt=this.symbolInstances.get(pt);this._updateTextDebugCollisionBoxes(qe,F,Ae,vt.textBoxStartIndex,vt.textBoxEndIndex,vt,Oe),this._updateTextDebugCollisionBoxes(qe,F,Ae,vt.verticalTextBoxStartIndex,vt.verticalTextBoxEndIndex,vt,Oe),this._updateIconDebugCollisionBoxes(Ve,F,Ae,vt.iconBoxStartIndex,vt.iconBoxEndIndex,vt,Fe),this._updateIconDebugCollisionBoxes(Ve,F,Ae,vt.verticalIconBoxStartIndex,vt.verticalIconBoxEndIndex,vt,Fe)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri={};if(Ae<Oe){const{x1:Oe,y1:Fe,x2:Ve,y2:qe,padding:pt,projectedAnchorX:vt,projectedAnchorY:zt,projectedAnchorZ:xi,tileAnchorX:bi,tileAnchorY:wi,featureIndex:dr}=F.get(Ae);ri.textBox={x1:Oe,y1:Fe,x2:Ve,y2:qe,padding:pt,projectedAnchorX:vt,projectedAnchorY:zt,projectedAnchorZ:xi,tileAnchorX:bi,tileAnchorY:wi},ri.textFeatureIndex=dr}if(Fe<Ve){const{x1:Ae,y1:Oe,x2:Ve,y2:qe,padding:pt,projectedAnchorX:vt,projectedAnchorY:zt,projectedAnchorZ:xi,tileAnchorX:bi,tileAnchorY:wi,featureIndex:dr}=F.get(Fe);ri.verticalTextBox={x1:Ae,y1:Oe,x2:Ve,y2:qe,padding:pt,projectedAnchorX:vt,projectedAnchorY:zt,projectedAnchorZ:xi,tileAnchorX:bi,tileAnchorY:wi},ri.verticalTextFeatureIndex=dr}if(qe<pt){const{x1:Ae,y1:Oe,x2:Fe,y2:Ve,padding:pt,projectedAnchorX:vt,projectedAnchorY:zt,projectedAnchorZ:xi,tileAnchorX:bi,tileAnchorY:wi,featureIndex:dr}=F.get(qe);ri.iconBox={x1:Ae,y1:Oe,x2:Fe,y2:Ve,padding:pt,projectedAnchorX:vt,projectedAnchorY:zt,projectedAnchorZ:xi,tileAnchorX:bi,tileAnchorY:wi},ri.iconFeatureIndex=dr}if(vt<zt){const{x1:Ae,y1:Oe,x2:Fe,y2:Ve,padding:qe,projectedAnchorX:pt,projectedAnchorY:zt,projectedAnchorZ:xi,tileAnchorX:bi,tileAnchorY:wi,featureIndex:dr}=F.get(vt);ri.verticalIconBox={x1:Ae,y1:Oe,x2:Fe,y2:Ve,padding:qe,projectedAnchorX:pt,projectedAnchorY:zt,projectedAnchorZ:xi,tileAnchorX:bi,tileAnchorY:wi},ri.verticalIconFeatureIndex=dr}return ri}deserializeCollisionBoxes(F){this.collisionArrays=[];for(let Ae=0;Ae<this.symbolInstances.length;Ae++){const Oe=this.symbolInstances.get(Ae);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(F,Oe.textBoxStartIndex,Oe.textBoxEndIndex,Oe.verticalTextBoxStartIndex,Oe.verticalTextBoxEndIndex,Oe.iconBoxStartIndex,Oe.iconBoxEndIndex,Oe.verticalIconBoxStartIndex,Oe.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(F,Ae){const Oe=F.placedSymbolArray.get(Ae),Fe=Oe.vertexStartIndex+4*Oe.numGlyphs;for(let Ae=Oe.vertexStartIndex;Ae<Fe;Ae+=4)F.indexArray.emplaceBack(Ae,Ae+1,Ae+2),F.indexArray.emplaceBack(Ae+1,Ae+2,Ae+3)}getSortedSymbolIndexes(F){if(this.sortedAngle===F&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const Ae=Math.sin(F),Oe=Math.cos(F),Fe=[],Ve=[],qe=[];for(let F=0;F<this.symbolInstances.length;++F){qe.push(F);const pt=this.symbolInstances.get(F);Fe.push(0|Math.round(Ae*pt.tileAnchorX+Oe*pt.tileAnchorY)),Ve.push(pt.featureIndex)}return qe.sort(((F,Ae)=>Fe[F]-Fe[Ae]||Ve[Ae]-Ve[F])),qe}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let F=0;F<this.symbolInstances.length;++F)this.symbolInstanceIndexesSortedZOffset.push(F)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((F,Ae)=>this.symbolInstances.get(Ae).zOffset-this.symbolInstances.get(F).zOffset))}addToSortKeyRanges(F,Ae){const Oe=this.sortKeyRanges[this.sortKeyRanges.length-1];Oe&&Oe.sortKey===Ae?Oe.symbolInstanceEnd=F+1:this.sortKeyRanges.push({sortKey:Ae,symbolInstanceStart:F,symbolInstanceEnd:F+1})}sortFeatures(F){if(this.sortFeaturesByY&&this.sortedAngle!==F&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(F),this.sortedAngle=F,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const F of this.symbolInstanceIndexes){const Ae=this.symbolInstances.get(F);this.featureSortOrder.push(Ae.featureIndex);const{rightJustifiedTextSymbolIndex:Oe,centerJustifiedTextSymbolIndex:Fe,leftJustifiedTextSymbolIndex:Ve,verticalPlacedTextSymbolIndex:qe,placedIconSymbolIndex:pt,verticalPlacedIconSymbolIndex:vt}=Ae;Oe>=0&&this.addIndicesForPlacedSymbol(this.text,Oe),Fe>=0&&Fe!==Oe&&this.addIndicesForPlacedSymbol(this.text,Fe),Ve>=0&&Ve!==Fe&&Ve!==Oe&&this.addIndicesForPlacedSymbol(this.text,Ve),qe>=0&&this.addIndicesForPlacedSymbol(this.text,qe),pt>=0&&this.addIndicesForPlacedSymbol(this.icon,pt),vt>=0&&this.addIndicesForPlacedSymbol(this.icon,vt)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let qx,Yx,uv;oa(tm,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),tm.addDynamicAttributes=Wd;class im{constructor(F){this.type=F.property.overrides?F.property.overrides.runtimeType:ju,this.defaultValue=F}evaluate(F){if(F.formattedSection){const Ae=this.defaultValue.property.overrides;if(Ae&&Ae.hasOverride(F.formattedSection))return Ae.getOverride(F.formattedSection)}return F.feature&&F.featureState?this.defaultValue.evaluate(F.feature,F.featureState):this.defaultValue.property.specification.default}eachChild(F){this.defaultValue.isConstant()||F(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}oa(im,"FormatSectionOverride",{omit:["defaultValue"]});const am=()=>uv||(uv={layout:qx||(qx=new Ga({"symbol-placement":new ja(pf.layout_symbol["symbol-placement"]),"symbol-spacing":new ja(pf.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ja(pf.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new qa(pf.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ja(pf.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new ja(pf.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new ja(pf.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new ja(pf.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ja(pf.layout_symbol["icon-ignore-placement"]),"icon-optional":new ja(pf.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ja(pf.layout_symbol["icon-rotation-alignment"]),"icon-size":new qa(pf.layout_symbol["icon-size"]),"icon-size-scale-range":new ja(pf.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new qa(pf.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new qa(pf.layout_symbol["icon-text-fit-padding"]),"icon-image":new qa(pf.layout_symbol["icon-image"]),"icon-rotate":new qa(pf.layout_symbol["icon-rotate"]),"icon-padding":new ja(pf.layout_symbol["icon-padding"]),"icon-keep-upright":new ja(pf.layout_symbol["icon-keep-upright"]),"icon-offset":new qa(pf.layout_symbol["icon-offset"]),"icon-anchor":new qa(pf.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ja(pf.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ja(pf.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ja(pf.layout_symbol["text-rotation-alignment"]),"text-field":new qa(pf.layout_symbol["text-field"]),"text-font":new qa(pf.layout_symbol["text-font"]),"text-size":new qa(pf.layout_symbol["text-size"]),"text-size-scale-range":new ja(pf.layout_symbol["text-size-scale-range"]),"text-max-width":new qa(pf.layout_symbol["text-max-width"]),"text-line-height":new qa(pf.layout_symbol["text-line-height"]),"text-letter-spacing":new qa(pf.layout_symbol["text-letter-spacing"]),"text-justify":new qa(pf.layout_symbol["text-justify"]),"text-radial-offset":new qa(pf.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ja(pf.layout_symbol["text-variable-anchor"]),"text-anchor":new qa(pf.layout_symbol["text-anchor"]),"text-max-angle":new ja(pf.layout_symbol["text-max-angle"]),"text-writing-mode":new ja(pf.layout_symbol["text-writing-mode"]),"text-rotate":new qa(pf.layout_symbol["text-rotate"]),"text-padding":new ja(pf.layout_symbol["text-padding"]),"text-keep-upright":new ja(pf.layout_symbol["text-keep-upright"]),"text-transform":new qa(pf.layout_symbol["text-transform"]),"text-offset":new qa(pf.layout_symbol["text-offset"]),"text-allow-overlap":new ja(pf.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ja(pf.layout_symbol["text-ignore-placement"]),"text-optional":new ja(pf.layout_symbol["text-optional"]),visibility:new ja(pf.layout_symbol.visibility)})),paint:Yx||(Yx=new Ga({"icon-opacity":new qa(pf.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new qa(pf.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new qa(pf.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new qa(pf.paint_symbol["text-emissive-strength"]),"icon-color":new qa(pf.paint_symbol["icon-color"]),"icon-halo-color":new qa(pf.paint_symbol["icon-halo-color"]),"icon-halo-width":new qa(pf.paint_symbol["icon-halo-width"]),"icon-halo-blur":new qa(pf.paint_symbol["icon-halo-blur"]),"icon-translate":new ja(pf.paint_symbol["icon-translate"]),"icon-translate-anchor":new ja(pf.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new qa(pf.paint_symbol["icon-image-cross-fade"]),"text-opacity":new qa(pf.paint_symbol["text-opacity"]),"text-occlusion-opacity":new qa(pf.paint_symbol["text-occlusion-opacity"]),"text-color":new qa(pf.paint_symbol["text-color"],{runtimeType:Hu,getOverride:F=>F.textColor,hasOverride:F=>!!F.textColor}),"text-halo-color":new qa(pf.paint_symbol["text-halo-color"]),"text-halo-width":new qa(pf.paint_symbol["text-halo-width"]),"text-halo-blur":new qa(pf.paint_symbol["text-halo-blur"]),"text-translate":new ja(pf.paint_symbol["text-translate"]),"text-translate-anchor":new ja(pf.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new ja(pf.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new ja(pf.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new ja(pf.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new ja(pf.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new qa(pf.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},uv);class sm extends ps{constructor(F,Ae,Oe,Fe){super(F,am(),Ae,Oe,Fe),this._colorAdjustmentMatrix=Sl.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=void 0!==F.paint&&("icon-occlusion-opacity"in F.paint||"text-occlusion-opacity"in F.paint)}recalculate(F,Ae){super.recalculate(F,Ae),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const Oe=this.layout.get("text-writing-mode");if(Oe){const F=[];for(const Ae of Oe)F.indexOf(Ae)<0&&F.push(Ae);this.layout._values["text-writing-mode"]=F}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(F,Ae,Oe,Fe){return this._saturation===F&&this._contrast===Ae&&this._brightnessMin===Oe&&this._brightnessMax===Fe||(this._colorAdjustmentMatrix=function(F,Ae,Oe,Fe){F=At(F),Ae=Mt(Ae);const Ve=Sl.mat4.create(),qe=F/3,pt=1-2*qe,vt=[pt,qe,qe,0,qe,pt,qe,0,qe,qe,pt,0,0,0,0,1],zt=.5-.5*Ae,ri=Fe-Oe;return Sl.mat4.multiply(Ve,[ri,0,0,0,0,ri,0,0,0,0,ri,0,Oe,Oe,Oe,1],[Ae,0,0,0,0,Ae,0,0,0,0,Ae,0,zt,zt,zt,1]),Sl.mat4.multiply(Ve,Ve,vt),Ve}(F,Ae,Oe,Fe),this._saturation=F,this._contrast=Ae,this._brightnessMin=Oe,this._brightnessMax=Fe),this._colorAdjustmentMatrix}getValueAndResolveTokens(F,Ae,Oe,Fe){const Ve=this.layout.get(F).evaluate(Ae,{},Oe,Fe),qe=this._unevaluatedLayout._values[F];return qe.isDataDriven()||Hi(qe.value)||!Ve?Ve:function(F,Ae){return Ae.replace(/{([^{}]+)}/g,((Ae,Oe)=>Oe in F?String(F[Oe]):""))}(Ae.properties,Ve)}createBucket(F){return new tm(F)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const F of am().paint.overridableProperties){if(!sm.hasPaintOverride(this.layout,F))continue;const Ae=this.paint.get(F),Oe=new im(Ae),Fe=new Zi(Oe,Ae.property.specification,this.scope,this.options);let Ve=null;Ve="constant"===Ae.value.kind||"source"===Ae.value.kind?new Ki("source",Fe):new Ji("composite",Fe,Ae.value.zoomStops,Ae.value._interpolationType),this.paint._values[F]=new Na(Ae.property,Ve,Ae.parameters)}}_handleOverridablePaintPropertyUpdate(F,Ae,Oe){return!(!this.layout||Ae.isDataDriven()||Oe.isDataDriven())&&sm.hasPaintOverride(this.layout,F)}static hasPaintOverride(F,Ae){const Oe=F.get("text-field"),Fe=am().paint.properties[Ae];let Ve=!1;const a=F=>{for(const Ae of F)if(Fe.overrides&&Fe.overrides.hasOverride(Ae))return void(Ve=!0)};if("constant"===Oe.value.kind&&Oe.value.value instanceof Je)a(Oe.value.value.sections);else if("source"===Oe.value.kind){const t=F=>{Ve||(F instanceof ar&&nr(F.value)===ud?a(F.value.sections):F instanceof ur?a(F.sections):F.eachChild(t))},F=Oe.value;F._styleExpression&&t(F._styleExpression.expression)}return Ve}getProgramIds(){return["symbol"]}getDefaultProgramParams(F,Ae,Oe){return{config:new Oo(this,{zoom:Ae,lut:Oe}),overrideFog:!1}}}let dv,_v,wv,Tv;var Sv=ys([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function pm(F){switch(F){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function fm(F){switch(F){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class dm{constructor(F,Ae,Oe,Fe){this.context=F,this.format=Oe,this.useMipmap=Fe&&Fe.useMipmap,this.texture=F.gl.createTexture(),this.update(Ae,{premultiply:Fe&&Fe.premultiply})}update(F,Ae){const Oe=F&&F instanceof HTMLVideoElement&&0===F.width?F.videoWidth:F.width,Fe=F&&F instanceof HTMLVideoElement&&0===F.height?F.videoHeight:F.height,{context:Ve}=this,{gl:qe}=Ve,{x:pt,y:vt}=Ae&&Ae.position?Ae.position:{x:0,y:0},zt=pt+Oe,ri=vt+Fe;!this.size||this.size[0]===zt&&this.size[1]===ri||(qe.bindTexture(qe.TEXTURE_2D,null),qe.deleteTexture(this.texture),this.texture=qe.createTexture(),this.size=null),qe.bindTexture(qe.TEXTURE_2D,this.texture),Ve.pixelStoreUnpackFlipY.set(!1),Ve.pixelStoreUnpack.set(1),Ve.pixelStoreUnpackPremultiplyAlpha.set(this.format===qe.RGBA8&&(!Ae||!1!==Ae.premultiply));const xi=F instanceof HTMLImageElement||F instanceof HTMLCanvasElement||F instanceof HTMLVideoElement||F instanceof ImageData||ImageBitmap&&F instanceof ImageBitmap;if(!this.size&&zt>0&&ri>0){const F=this.useMipmap?Math.floor(Math.log2(Math.max(zt,ri)))+1:1;qe.texStorage2D(qe.TEXTURE_2D,F,this.format,zt,ri),this.size=[zt,ri]}if(this.size)if(xi)qe.texSubImage2D(qe.TEXTURE_2D,0,pt,vt,pm(this.format),fm(this.format),F);else{const Ae=F.data;Ae&&qe.texSubImage2D(qe.TEXTURE_2D,0,pt,vt,Oe,Fe,pm(this.format),fm(this.format),Ae)}this.useMipmap&&qe.generateMipmap(qe.TEXTURE_2D)}bind(F,Ae,Oe=!1){const{context:Fe}=this,{gl:Ve}=Fe;Ve.bindTexture(Ve.TEXTURE_2D,this.texture),F!==this.minFilter&&(Ve.texParameteri(Ve.TEXTURE_2D,Ve.TEXTURE_MAG_FILTER,F),Ve.texParameteri(Ve.TEXTURE_2D,Ve.TEXTURE_MIN_FILTER,this.useMipmap&&!Oe?F===Ve.NEAREST?Ve.NEAREST_MIPMAP_NEAREST:Ve.LINEAR_MIPMAP_LINEAR:F),this.minFilter=F),Ae!==this.wrapS&&(Ve.texParameteri(Ve.TEXTURE_2D,Ve.TEXTURE_WRAP_S,Ae),Ve.texParameteri(Ve.TEXTURE_2D,Ve.TEXTURE_WRAP_T,Ae),this.wrapS=Ae)}bindExtraParam(F,Ae,Oe,Fe){const{context:Ve}=this,{gl:qe}=Ve;qe.bindTexture(qe.TEXTURE_2D,this.texture),Ae!==this.magFilter&&(qe.texParameteri(qe.TEXTURE_2D,qe.TEXTURE_MAG_FILTER,Ae),this.magFilter=Ae),F!==this.minFilter&&(qe.texParameteri(qe.TEXTURE_2D,qe.TEXTURE_MIN_FILTER,this.useMipmap?F===qe.NEAREST?qe.NEAREST_MIPMAP_NEAREST:qe.LINEAR_MIPMAP_LINEAR:F),this.minFilter=F),Oe!==this.wrapS&&(qe.texParameteri(qe.TEXTURE_2D,qe.TEXTURE_WRAP_S,Oe),this.wrapS=Oe),Fe!==this.wrapT&&(qe.texParameteri(qe.TEXTURE_2D,qe.TEXTURE_WRAP_T,Fe),this.wrapT=Fe)}destroy(){const{gl:F}=this.context;F.deleteTexture(this.texture),this.texture=null}}class mm{constructor(F,Ae){this.context=F,this.texture=Ae}bind(F,Ae){const{context:Oe}=this,{gl:Fe}=Oe;Fe.bindTexture(Fe.TEXTURE_2D,this.texture),F!==this.minFilter&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MAG_FILTER,F),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MIN_FILTER,F),this.minFilter=F),Ae!==this.wrapS&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_S,Ae),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_T,Ae),this.wrapS=Ae)}}function ym(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=[F,Ae,1,Oe,Fe,1,Ve,qe,1],ri=[pt,vt,1],xi=Sl.mat3.adjoint([],zt),[bi,wi,dr]=Sl.vec3.transformMat3(ri,ri,xi);return Sl.mat3.multiply(zt,zt,[bi,0,0,0,wi,0,0,0,dr])}function gm(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=function(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=ym(0,0,1,0,1,1,0,1),ri=ym(F,Ae,Oe,Fe,Ve,qe,pt,vt),xi=Sl.mat3.adjoint([],zt);return Sl.mat3.multiply(ri,ri,xi)}(F,Ae,Oe,Fe,Ve,qe,pt,vt);return[zt[2]/zt[8]/Vd,zt[5]/zt[8]/Vd]}function xm(F){return[F[0],Math.min(Math.max(F[1],-jm),jm)]}class vm extends we{constructor(F,Ae,Oe,Fe){super(),this.id=F,this.dispatcher=Oe,this.coordinates=Ae.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(Fe),this.options=Ae,this._dirty=!1}load(F,Ae){if(this._loaded=Ae||!1,this.fire(new xe("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return F&&(this.coordinates=F),this._loaded=!0,void this._finishLoading();this._imageRequest=ue(this.map._requestManager.transformRequest(this.url,Dh.Image),((Ae,Oe)=>{this._imageRequest=null,this._loaded=!0,Ae?this.fire(new ve(Ae)):Oe&&(this.image=Oe instanceof HTMLImageElement?eh.getImageData(Oe):Oe,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,F&&(this.coordinates=F),this._finishLoading())}))}loaded(){return this._loaded}updateImage(F){return F.url?(this._imageRequest&&F.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=F.url,this.load(F.coordinates,this._loaded),this):this}setTexture(F){if(!(F.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new mm(this.map.painter.context,F.handle),this.width=F.dimensions[0],this.height=F.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new xe("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(F){this.map=F,this.load()}onRemove(F){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof mm||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(F){if(this.coordinates=F,this._boundsArray=void 0,this._unsupportedCoords=!1,!F.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let Ae=F[0][1],Oe=F[0][1];for(const Fe of F)Fe[1]>Oe&&(Oe=Fe[1]),Fe[1]<Ae&&(Ae=Fe[1]);const Fe=(Oe+Ae)/2;if(Fe>jm?this.onNorthPole=!0:Fe<-jm&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const Ae=F.map(bl.fromLngLat);this.tileID=function(F){let Ae=1/0,Oe=1/0,Fe=-1/0,Ve=-1/0;for(const qe of F)Ae=Math.min(Ae,qe.x),Oe=Math.min(Oe,qe.y),Fe=Math.max(Fe,qe.x),Ve=Math.max(Ve,qe.y);const qe=Math.max(Fe-Ae,Ve-Oe),pt=Math.max(0,Math.floor(-Math.log(qe)/Math.LN2)),vt=Math.pow(2,pt);let zt=Math.floor((Ae+Fe)/2*vt);return zt>1&&(zt-=1),new ru(pt,zt,Math.floor((Oe+Ve)/2*vt))}(Ae),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new xe("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(F){for(const F in this.tiles){const Ae=this.tiles[F];"loaded"!==Ae.state&&(Ae.state="loaded",Ae.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const Ae=wd(new ru(0,0,0),this.map.transform.projection),Oe=[Ae.projection.project(this.coordinates[0][0],this.coordinates[0][1]),Ae.projection.project(this.coordinates[1][0],this.coordinates[1][1]),Ae.projection.project(this.coordinates[2][0],this.coordinates[2][1]),Ae.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(F){const Ae=F[1].x-F[0].x,Oe=F[1].y-F[0].y,Fe=F[2].x-F[1].x,Ve=F[2].y-F[1].y,qe=F[3].x-F[2].x,pt=F[3].y-F[2].y,vt=F[0].x-F[3].x,zt=F[0].y-F[3].y,ri=Ae*Ve-Fe*Oe,xi=Fe*pt-qe*Ve,bi=qe*zt-vt*pt,wi=vt*Oe-Ae*zt;return ri>0&&xi>0&&bi>0&&wi>0||ri<0&&xi<0&&bi<0&&wi<0}(Oe))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const Fe=wd(this.tileID,this.map.transform.projection),[Ve,qe,pt,vt]=this.coordinates.map((F=>{const Ae=Fe.projection.project(F[0],F[1]);return Md(Fe,Ae)._round()}));this.perspectiveTransform=gm(Ve.x,Ve.y,qe.x,qe.y,pt.x,pt.y,vt.x,vt.y);const zt=this._boundsArray=new bs;zt.emplaceBack(Ve.x,Ve.y,0,0),zt.emplaceBack(qe.x,qe.y,Vd,0),zt.emplaceBack(vt.x,vt.y,0,Vd),zt.emplaceBack(pt.x,pt.y,Vd,Vd),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=F.createVertexBuffer(zt,Sv.members),this.boundsSegments=po.simpleSegment(0,0,4,2);const ri=[],xi=[xm((bi=this.coordinates)[0]),xm(bi[1]),xm(bi[2]),xm(bi[3])];var bi;const[wi,dr,jr,Qr]=function(F){let Ae=F[0][0],Oe=Ae,Fe=F[0][1],Ve=Fe;for(let qe=1;qe<F.length;qe++)F[qe][0]<Ae?Ae=F[qe][0]:F[qe][0]>Oe&&(Oe=F[qe][0]),F[qe][1]<Fe?Fe=F[qe][1]:F[qe][1]>Ve&&(Ve=F[qe][1]);return[Ae,Fe,Oe-Ae,Ve-Fe]}(xi);{const Fe=new bs,[Ve,qe,pt,vt]=function(F){let Ae=F[0].x,Oe=Ae,Fe=F[0].y,Ve=Fe;for(let qe=1;qe<F.length;qe++)F[qe].x<Ae?Ae=F[qe].x:F[qe].x>Oe&&(Oe=F[qe].x),F[qe].y<Fe?Fe=F[qe].y:F[qe].y>Ve&&(Ve=F[qe].y);return[Ae,Fe,Oe-Ae,Ve-Fe]}(Oe),l=F=>[(F.x-Ve)/pt,(F.y-qe)/vt],[zt,xi,bi,Xn]=Oe.map(l),ho=function(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=ym(0,0,1,0,1,1,0,1),ri=ym(F,Ae,Oe,Fe,Ve,qe,pt,vt),xi=Sl.mat3.adjoint([],ri);return Sl.mat3.multiply(zt,zt,xi)}(zt[0],zt[1],xi[0],xi[1],bi[0],bi[1],Xn[0],Xn[1]);this.elevatedGlobePerspectiveTransform=gm(zt[0],zt[1],xi[0],xi[1],bi[0],bi[1],Xn[0],Xn[1]);const v=(F,Ae)=>{ri.push(F.lng);const Oe=Math.round((F.lng-wi)/jr*Vd),Ve=Math.round((F.lat-dr)/Qr*Vd),qe=l(Ae),pt=Sl.vec3.transformMat3([],[qe[0],qe[1],1],ho),vt=Math.round(pt[0]/pt[2]*Vd),zt=Math.round(pt[1]/pt[2]*Vd);Fe.emplaceBack(Oe,Ve,vt,zt)},yo=Oe[3].x-Oe[0].x,zo=Oe[3].y-Oe[0].y,ko=Oe[2].x-Oe[1].x,Uo=Oe[2].y-Oe[1].y;for(let F=0;F<65;F++){const Fe=F/64,Ve=[Oe[0].x+Fe*yo,Oe[0].y+Fe*zo],qe=[Oe[1].x+Fe*ko,Oe[1].y+Fe*Uo],pt=qe[0]-Ve[0],vt=qe[1]-Ve[1];for(let F=0;F<65;F++){const Oe=F/64,Fe={x:Ve[0]+pt*Oe,y:Ve[1]+vt*Oe,z:0};v(Ae.projection.unproject(Fe.x,Fe.y),Fe)}}this.elevatedGlobeVertexBuffer=F.createVertexBuffer(Fe,Sv.members)}{this.maxLongitudeTriangleSize=0;let Ae=[],Oe=new Ls;const n=(F,Fe,Ve)=>{Oe.emplaceBack(F,Fe,Ve);const qe=ri[F],pt=ri[Fe],vt=ri[Ve],zt=Math.min(Math.min(qe,pt),vt),xi=Math.max(Math.max(qe,pt),vt)-zt;xi>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=xi),Ae.push(zt+xi/2)};for(let F=0;F<64;F++)for(let Ae=0;Ae<64;Ae++){const Oe=65*F+Ae,Fe=Oe+1,Ve=Oe+65,qe=Ve+1;n(Oe,Ve,Fe),n(Fe,Ve,qe)}[Ae,Oe]=function(F,Ae){const Oe=Array.from({length:F.length},((F,Ae)=>Ae));Oe.sort(((Ae,Oe)=>F[Ae]-F[Oe]));const Fe=[],Ve=new Ls;for(let qe=0;qe<Oe.length;qe++){const pt=Oe[qe];Fe.push(F[pt]);const vt=3*pt,zt=vt+1;Ve.emplaceBack(Ae.uint16[vt],Ae.uint16[zt],Ae.uint16[zt+1])}return[Fe,Ve]}(Ae,Oe),this.elevatedGlobeTrianglesCenterLongitudes=Ae,this.elevatedGlobeIndexBuffer=F.createIndexBuffer(Oe)}this.elevatedGlobeSegments=po.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,jr/Vd,0,Qr/Vd,0,0,dr,wi,0])}prepare(){const F=0!==Object.keys(this.tiles).length;if(this.tileID&&!F)return;const Ae=this.map.painter.context,Oe=Ae.gl;!this._dirty||this.texture instanceof mm||(this.texture?this.texture.update(this.image):(this.texture=new dm(Ae,this.image,Oe.RGBA8),this.texture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE)),this._dirty=!1),F&&this._prepareData(Ae)}loadTile(F,Ae){this.tileID&&this.tileID.equals(F.tileID.canonical)?(this.tiles[String(F.tileID.wrap)]=F,F.buckets={},Ae(null)):(F.state="errored",Ae(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(F){const Ae=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!Ae)return null;const Oe=this.elevatedGlobeTrianglesCenterLongitudes;let Fe=(Ve=F+180)+360*Math.round((Oe[0]-Ve)/360);var Ve;const qe=new po,s=(F,Oe)=>{qe.segments.push({vertexOffset:0,primitiveOffset:F,vertexLength:Ae.segments[0].vertexLength,primitiveLength:Oe,sortKey:void 0,vaos:{}})},pt=.51*this.maxLongitudeTriangleSize;if(Math.abs(Oe[0]-Fe)<=pt){const F=wt(Oe,0,Oe.length,Fe+pt);return F===Oe.length||s(F,_t(Oe,F+1,Oe.length,Fe+360-pt)-F),qe}Fe<Oe[0]&&(Fe+=360);const vt=_t(Oe,0,Oe.length,Fe-pt);if(vt===Oe.length)return s(0,Oe.length),qe;s(0,vt-0);const zt=wt(Oe,vt+1,Oe.length,Fe+pt);return zt!==Oe.length&&s(zt,Oe.length-zt),qe}}const Mv=(Math.pow(256,2)-1)/16907520;class _m extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:wv||(wv=new Ga({visibility:new ja(pf.layout_raster.visibility)})),paint:Tv||(Tv=new Ga({"raster-opacity":new ja(pf.paint_raster["raster-opacity"]),"raster-color":new $a(pf.paint_raster["raster-color"]),"raster-color-mix":new ja(pf.paint_raster["raster-color-mix"]),"raster-color-range":new ja(pf.paint_raster["raster-color-range"]),"raster-hue-rotate":new ja(pf.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ja(pf.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ja(pf.paint_raster["raster-brightness-max"]),"raster-saturation":new ja(pf.paint_raster["raster-saturation"]),"raster-contrast":new ja(pf.paint_raster["raster-contrast"]),"raster-resampling":new ja(pf.paint_raster["raster-resampling"]),"raster-fade-duration":new ja(pf.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new ja(pf.paint_raster["raster-emissive-strength"]),"raster-array-band":new ja(pf.paint_raster["raster-array-band"]),"raster-elevation":new ja(pf.paint_raster["raster-elevation"]),"raster-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(F){return!(F&&F._source instanceof vm&&(F._source.onNorthPole||F._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(F){"raster-color"!==F&&"raster-color-range"!==F||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(F){if(!this.hasColorMap())return;if(!this._curRampRange)return;const Ae=this._transitionablePaint._values["raster-color"].value.expression,[Oe,Fe]=F||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(Oe)&&isNaN(Fe)||Oe===this._curRampRange[0]&&Fe===this._curRampRange[1]||(this.colorRamp=lc({expression:Ae,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:Oe,end:Fe}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[Oe,Fe])}}let Ev,Iv,Av,Cv,Pv;class Pm extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:Ev||(Ev=new Ga({visibility:new ja(pf["layout_raster-particle"].visibility)})),paint:Iv||(Iv=new Ga({"raster-particle-array-band":new ja(pf["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new ja(pf["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new $a(pf["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new ja(pf["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new ja(pf["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new ja(pf["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new ja(pf["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new ja(pf["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe),this._updateColorRamp(),this.lastInvalidatedAt=eh.now()}onRemove(F){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(F){return!1}_handleSpecialPaintPropertyUpdate(F){"raster-particle-color"!==F&&"raster-particle-max-speed"!==F||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===F&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const F=this._transitionablePaint._values["raster-particle-color"].value.expression,Ae=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=lc({expression:F,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:Ae}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=eh.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class zm extends ps{constructor(F,Ae){super(F,{},Ae,null),this.implementation=F,F.slot&&(this.slot=F.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(F){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(F){this.implementation.onAdd&&this.implementation.onAdd(F,F.painter.context.gl)}onRemove(F){this.implementation.onRemove&&this.implementation.onRemove(F,F.painter.context.gl)}}function Em(F,Ae,Oe){const Fe=[0,0,1],Ve=Sl.quat.identity([]);return Sl.quat.rotateY(Ve,Ve,Oe?-X(F)+Math.PI:X(F)),Sl.quat.rotateX(Ve,Ve,-X(Ae)),Sl.vec3.transformQuat(Fe,Fe,Ve),Sl.vec3.normalize(Fe,Fe)}function km(F,Ae){const Oe=Bm(F.projection,F.zoom,F.width,F.height),Fe=function(F,Ae,Oe,Fe,Ve){const qe=new il(Oe.lng-180*zv,Oe.lat),pt=new il(Oe.lng+180*zv,Oe.lat),vt=F.project(qe.lng,qe.lat),zt=F.project(pt.lng,pt.lat),ri=-Math.atan2(zt.y-vt.y,zt.x-vt.x),xi=bl.fromLngLat(Oe);xi.y=Q(xi.y,-1+zv,1-zv);const bi=xi.toLngLat(),wi=F.project(bi.lng,bi.lat),dr=bl.fromLngLat(bi);dr.x+=zv;const jr=dr.toLngLat(),Qr=F.project(jr.lng,jr.lat),Xn=Dm(Qr.x-wi.x,Qr.y-wi.y,ri),ho=bl.fromLngLat(bi);ho.y+=zv;const yo=ho.toLngLat(),zo=F.project(yo.lng,yo.lat),ko=Dm(zo.x-wi.x,zo.y-wi.y,ri),Uo=Math.abs(Xn.x)/Math.abs(ko.y),ia=Sl.mat4.identity([]);Sl.mat4.rotateZ(ia,ia,-ri*(1-(Ve?0:Fe)));const _a=Sl.mat4.identity([]);return Sl.mat4.scale(_a,_a,[1,1-(1-Uo)*Fe,1]),_a[4]=-ko.x/ko.y*Fe,Sl.mat4.rotateZ(_a,_a,ri),Sl.mat4.multiply(_a,ia,_a),_a}(F.projection,0,F.center,Oe,Ae),Ve=Tm(F);return Sl.mat4.scale(Fe,Fe,[Ve,Ve,1]),Fe}function Tm(F){const Ae=F.projection,Oe=Bm(F.projection,F.zoom,F.width,F.height),Fe=Vm(Ae,F.center),Ve=Vm(Ae,il.convert(Ae.center));return Math.pow(2,Fe*Oe+(1-Oe)*Ve)}function Bm(F,Ae,Oe,Fe,Ve=1/0){const qe=F.range;if(!qe)return 0;const pt=Math.min(Ve,Math.max(Oe,Fe)),vt=Math.log(pt/1024)/Math.LN2;return tt(qe[0]+vt,qe[1]+vt,Ae)}const zv=1/4e4;function Vm(F,Ae){const Oe=Q(Ae.lat,-jm,jm),Fe=new il(Ae.lng-180*zv,Oe),Ve=new il(Ae.lng+180*zv,Oe),qe=F.project(Fe.lng,Oe),pt=F.project(Ve.lng,Oe),vt=bl.fromLngLat(Fe),zt=bl.fromLngLat(Ve),ri=pt.x-qe.x,xi=pt.y-qe.y,bi=zt.x-vt.x,wi=zt.y-vt.y,dr=Math.sqrt((bi*bi+wi*wi)/(ri*ri+xi*xi));return Math.log(dr)/Math.LN2}function Dm(F,Ae,Oe){const Fe=Math.cos(Oe),Ve=Math.sin(Oe);return{x:F*Fe-Ae*Ve,y:F*Ve+Ae*Fe}}function Lm(F,Ae,Oe){Sl.mat4.identity(F),Sl.mat4.rotateZ(F,F,X(Ae[2])),Sl.mat4.rotateX(F,F,X(Ae[0])),Sl.mat4.rotateY(F,F,X(Ae[1])),Sl.mat4.scale(F,F,Oe),Sl.mat4.multiply(F,F,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Rm(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=[Oe[0]-Ae[0],Oe[1]-Ae[1],0],ri=[Fe[0]-Ae[0],Fe[1]-Ae[1],0];if(Sl.vec3.length(zt)<1e-12||Sl.vec3.length(ri)<1e-12)return Sl.quat.identity(F);const xi=Sl.vec3.cross([],zt,ri);Sl.vec3.normalize(xi,xi),Sl.vec3.subtract(ri,Fe,Ae),zt[2]=(qe-Ve)*vt,ri[2]=(pt-Ve)*vt;const bi=zt;return Sl.vec3.cross(bi,zt,ri),Sl.vec3.normalize(bi,bi),Sl.quat.rotationTo(F,xi,bi)}function Fm(F,Ae,Oe=!1){const Fe=Fu(Ae.zoom),Ve=function(F,Ae,Oe){const Fe=Ae.worldSize,Ve=[F[12],F[13],F[14]],qe=fl(Ve[1]/Fe),pt=pl(Ve[0]/Fe),vt=Sl.mat4.identity([]),zt=hl(1,qe)*Fe,ri=hl(1,0)*Fe*gl(qe,Ae.zoom),xi=1/Du(Fe);let bi=ri*xi;if(Oe){const F=Bm(Ae.projection,Ae.zoom,Ae.width,Ae.height,1024);bi=xi*Ae.projection.pixelSpaceConversion(Ae.center.lat,Fe,F)}const wi=el(qe,pt);Sl.vec3.add(wi,wi,Sl.vec3.scale([],Sl.vec3.normalize([],wi),zt*bi*Ve[2]));const dr=function(F){const Ae=[F[0],F[1],F[2]];let Oe=[0,1,0];const Fe=Sl.vec3.cross([],Oe,Ae);return Sl.vec3.cross(Oe,Ae,Fe),0===Sl.vec3.squaredLength(Oe)&&(Oe=[0,1,0],Sl.vec3.cross(Fe,Ae,Oe)),Sl.vec3.normalize(Fe,Fe),Sl.vec3.normalize(Oe,Oe),Sl.vec3.normalize(Ae,Ae),[Fe[0],Fe[1],Fe[2],0,Oe[0],Oe[1],Oe[2],0,Ae[0],Ae[1],Ae[2],0,F[0],F[1],F[2],1]}(wi);Sl.mat4.scale(vt,vt,[bi,bi,bi*zt]),Sl.mat4.translate(vt,vt,[-Ve[0],-Ve[1],-Ve[2]]);const jr=Sl.mat4.multiply([],Ae.globeMatrix,dr);return Sl.mat4.multiply(jr,jr,vt),Sl.mat4.multiply(jr,jr,F),jr}(F,Ae,Oe);if(Fe>0){const Oe=function(F,Ae){const Oe=Ae.worldSize,Fe=hl(1,0)*Oe*gl(Ae.center.lat,Ae.zoom)/Du(Oe),Ve=hl(1,Ae.center.lat)*Oe,qe=Sl.mat4.identity([]);return Sl.mat4.rotateY(qe,qe,X(Ae.center.lng)),Sl.mat4.rotateX(qe,qe,X(Ae.center.lat)),Sl.mat4.translate(qe,qe,[0,0,cm]),Sl.mat4.scale(qe,qe,[Fe,Fe,Fe*Ve]),Sl.mat4.translate(qe,qe,[Ae.point.x-.5*Oe,Ae.point.y-.5*Oe,0]),Sl.mat4.multiply(qe,qe,F),Sl.mat4.multiply(qe,Ae.globeMatrix,qe)}(F,Ae);return function(F,Ae,Oe){const n=(F,Ae,Oe)=>{const Fe=Sl.vec3.length(F),Ve=Sl.vec3.length(Ae),qe=Su(F,Ae,Oe);return Sl.vec3.scale(qe,qe,1/Sl.vec3.length(qe)*ze(Fe,Ve,Oe))},Fe=n([F[0],F[1],F[2]],[Ae[0],Ae[1],Ae[2]],Oe),Ve=n([F[4],F[5],F[6]],[Ae[4],Ae[5],Ae[6]],Oe),qe=n([F[8],F[9],F[10]],[Ae[8],Ae[9],Ae[10]],Oe),pt=Su([F[12],F[13],F[14]],[Ae[12],Ae[13],Ae[14]],Oe);return[Fe[0],Fe[1],Fe[2],0,Ve[0],Ve[1],Ve[2],0,qe[0],qe[1],qe[2],0,pt[0],pt[1],pt[2],1]}(Ve,Oe,Fe)}return Ve}function Om(F,Ae,Oe,Fe){const Ve=xu.projectAabbCorners(Fe,Oe);let qe=Number.MAX_VALUE,pt=-1;for(let F=0;F<Ve.length;++F){const Oe=Ve[F];Oe[0]=(.5*Oe[0]+.5)*Ae.width,Oe[1]=(.5-.5*Oe[1])*Ae.height,Oe[2]<qe&&(pt=F,qe=Oe[2])}const o=F=>new Jl(Ve[F][0],Ve[F][1]);let vt;switch(pt){case 0:case 6:vt=[o(1),o(5),o(4),o(7),o(3),o(2),o(1)];break;case 1:case 7:vt=[o(0),o(4),o(5),o(6),o(2),o(3),o(0)];break;case 3:case 5:vt=[o(1),o(0),o(4),o(7),o(6),o(2),o(1)];break;default:vt=[o(1),o(5),o(6),o(7),o(3),o(0),o(1)]}if(Cl(F,vt))return qe}const Dv=ys([{name:"a_pos_3f",components:3,type:"Float32"}]),Rv=ys([{name:"a_color_3f",components:3,type:"Float32"}]),Lv=ys([{name:"a_color_4f",components:4,type:"Float32"}]),kv=ys([{name:"a_uv_2f",components:2,type:"Float32"}]),Ov=ys([{name:"a_normal_3f",components:3,type:"Float32"}]),Fv=ys([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),Bv=ys([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),Nv={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class Zm{constructor(F,Ae,Oe,Fe){this.message=(F?`${F}: `:"")+Oe,Fe&&(this.identifier=Fe),null!=Ae&&Ae.__line__&&(this.line=Ae.__line__)}}function Hm(F,Ae){const Oe=-1===F.indexOf("://");try{return new URL(F,Oe&&Ae?"http://example.com":void 0),!0}catch(F){return!1}}class Wm{constructor(F,Ae){this.feature=F,this.instancedDataOffset=Ae,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Km{constructor(){this.instancedDataArray=new Xs,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Jm{constructor(F){this.zoom=F.zoom,this.canonical=F.canonical,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.projection=F.projection,this.index=F.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(F,Ae){}populate(F,Ae,Oe,Fe){this.tileToMeter=vl(Oe);const Ve=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:qe,id:pt,index:vt,sourceLayerIndex:zt}of F){const F=null!=pt?pt:qe.properties&&qe.properties.hasOwnProperty("id")?qe.properties.id:void 0,ri=El(qe,Ve);if(!this.layers[0]._featureFilter.filter(new Ca(this.zoom),ri,Oe))continue;const xi={id:F,sourceLayerIndex:zt,index:vt,geometry:Ve?ri.geometry:zl(qe,Oe,Fe),properties:qe.properties,type:qe.type,patterns:{}},bi=this.addFeature(xi,xi.geometry,ri);bi&&Ae.featureIndex.insert(qe,xi.geometry,vt,zt,this.index,this.instancesPerModel[bi].instancedDataArray.length,Vd/32)}this.lookup=null}update(F,Ae,Oe,Fe){for(const Ae in this.instancesPerModel){const Oe=this.instancesPerModel[Ae];for(const Ae in F)Oe.idToFeaturesIndex.hasOwnProperty(Ae)&&(this.evaluate(Oe.features[Oe.idToFeaturesIndex[Ae]],F[Ae],Oe,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let F=!1;for(const Ae in this.instancesPerModel){const Oe=this.instancesPerModel[Ae];for(const Ae of Oe.features){const Fe=this.layers[0],Ve=Ae.feature,qe=this.canonical,pt=Fe.paint.get("model-rotation").evaluate(Ve,{},qe),vt=Fe.paint.get("model-scale").evaluate(Ve,{},qe),zt=Fe.paint.get("model-translation").evaluate(Ve,{},qe);Sl.vec3.exactEquals(Ae.rotation,pt)&&Sl.vec3.exactEquals(Ae.scale,vt)&&Sl.vec3.exactEquals(Ae.translation,zt)||(this.evaluate(Ae,Ae.featureStates,Oe,!0),F=!0)}}return F}updateReplacement(F,Ae,Oe,Fe){if(Ae.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=Ae.updateTime;const Ve=Ae.getReplacementRegionsForTile(F.toUnwrapped(),!0);if(Ah(this.activeReplacements,Ve))return!1;this.activeReplacements=Ve;let qe=!1;for(const Ae in this.instancesPerModel){const Ve=this.instancesPerModel[Ae],pt=Ve.instancedDataArray;for(const Ae of Ve.features){const Ve=Ae.instancedDataOffset,vt=Ae.instancedDataCount;for(let Ae=0;Ae<vt;Ae++){const vt=16*(Ae+Ve);let zt=pt.float32[vt+0];const ri=zt>Vd;zt=ri?zt-Vd:zt;const xi=Math.floor(zt),bi=pt.float32[vt+1];let wi=!1;for(const Ae of this.activeReplacements)if(!bh(Ae,Oe,Nv.Model,Fe)&&!(Ae.min.x>xi||xi>Ae.max.x||Ae.min.y>bi||bi>Ae.max.y)&&(wi=kh(Eh(xi,bi,F.canonical,Ae.footprintTileId.canonical),Ae.footprint),wi))break;pt.float32[vt]=wi?zt+Vd:zt,qe=qe||wi!==ri}}}return qe}isEmpty(){for(const F in this.instancesPerModel)if(0!==this.instancesPerModel[F].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(F){if(!this.uploaded)for(const Ae in this.instancesPerModel){const Oe=this.instancesPerModel[Ae];Oe.instancedDataArray.length<0||0===Oe.instancedDataArray.length||(Oe.instancedDataBuffer?Oe.instancedDataBuffer.updateData(Oe.instancedDataArray):Oe.instancedDataBuffer=F.createVertexBuffer(Oe.instancedDataArray,Fv.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const F in this.instancesPerModel){const Ae=this.instancesPerModel[F];0!==Ae.instancedDataArray.length&&Ae.instancedDataBuffer&&Ae.instancedDataBuffer.destroy()}const F=this.layers[0].modelManager;if(F&&this.modelUris)for(const Ae of this.modelUris)F.removeModel(Ae,"")}addFeature(F,Ae,Oe){const Fe=this.layers[0],Ve=Fe.layout.get("model-id").evaluate(Oe,{},this.canonical);if(!Ve)return ft(`modelId is not evaluated for layer ${Fe.id} and it is not going to get rendered.`),Ve;Hm(Ve,!1)&&(this.modelUris.includes(Ve)||this.modelUris.push(Ve)),this.instancesPerModel[Ve]||(this.instancesPerModel[Ve]=new Km);const qe=this.instancesPerModel[Ve],pt=qe.instancedDataArray,vt=new Wm(Oe,pt.length);for(const F of Ae)for(const Ae of F){if(Ae.x<0||Ae.x>=Vd||Ae.y<0||Ae.y>=Vd)continue;const F=(this.lookupDim-1)/Vd,Oe=this.lookupDim*(Ae.y*F|0)+Ae.x*F|0;if(this.lookup){if(0!==this.lookup[Oe])continue;this.lookup[Oe]=1}this.instanceCount++;const Fe=pt.length;pt.resize(Fe+1),qe.instancesEvaluatedElevation.push(0),pt.float32[16*Fe]=Ae.x,pt.float32[16*Fe+1]=Ae.y}return vt.instancedDataCount=qe.instancedDataArray.length-vt.instancedDataOffset,vt.instancedDataCount>0&&(F.id&&(qe.idToFeaturesIndex[F.id]=qe.features.length),qe.features.push(vt),this.evaluate(vt,{},qe,!1)),Ve}getModelUris(){return this.modelUris}evaluate(F,Ae,Oe,Fe){const Ve=this.layers[0],qe=F.feature,pt=this.canonical,vt=F.rotation=Ve.paint.get("model-rotation").evaluate(qe,Ae,pt),zt=F.scale=Ve.paint.get("model-scale").evaluate(qe,Ae,pt),ri=F.translation=Ve.paint.get("model-translation").evaluate(qe,Ae,pt),xi=Ve.paint.get("model-color").evaluate(qe,Ae,pt);xi.a=Ve.paint.get("model-color-mix-intensity").evaluate(qe,Ae,pt);const bi=[];this.maxVerticalOffset<ri[2]&&(this.maxVerticalOffset=ri[2]),this.maxScale=Math.max(Math.max(this.maxScale,zt[0]),Math.max(zt[1],zt[2])),Lm(bi,vt,zt);const wi=Math.round(100*xi.a)+xi.b/1.05;for(let Ae=0;Ae<F.instancedDataCount;++Ae){const Ve=F.instancedDataOffset+Ae,qe=16*Ve,vt=Oe.instancedDataArray.float32;let zt=0;Fe&&(zt=vt[qe+6]-Oe.instancesEvaluatedElevation[Ve]);const dr=0|vt[qe+1];vt[qe]=(0|vt[qe])+xi.r/1.05,vt[qe+1]=dr+xi.g/1.05,vt[qe+2]=wi,vt[qe+3]=1/(pt.z>10?this.tileToMeter:vl(pt,dr)),vt[qe+4]=ri[0],vt[qe+5]=ri[1],vt[qe+6]=ri[2]+zt,vt[qe+7]=bi[0],vt[qe+8]=bi[1],vt[qe+9]=bi[2],vt[qe+10]=bi[4],vt[qe+11]=bi[5],vt[qe+12]=bi[6],vt[qe+13]=bi[8],vt[qe+14]=bi[9],vt[qe+15]=bi[10],Oe.instancesEvaluatedElevation[Ve]=ri[2]}}}let Vv,Uv;oa(Jm,"ModelBucket",{omit:["layers"]}),oa(Km,"PerModelAttributes"),oa(Wm,"ModelFeature");const jv=64,Gv={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function ny(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri=!1){const xi=Oe.zoom,bi=Oe.project(Fe),wi=gl(Fe.lat,xi),dr=1/wi;Sl.mat4.identity(F),Sl.mat4.translate(F,F,[bi.x+pt[0]*dr,bi.y+pt[1]*dr,pt[2]]);let jr=1,Qr=1;const Xn=Oe.worldSize;if(ri){if("mercator"===Oe.projection.name){let F=0;Oe.elevation&&(F=Oe.elevation.getAtPointOrZero(new bl(bi.x/Xn,bi.y/Xn),0));const Ae=Sl.vec4.transformMat4([],[bi.x,bi.y,F,1],Oe.projMatrix)[3]/Oe.cameraToCenterDistance;jr=Ae,Qr=Ae*gl(Oe.center.lat,xi)}else if("globe"===Oe.projection.name){const Ae=Fm(F,Oe),Ve=Sl.mat4.multiply([],Oe.projMatrix,Ae),qe=[0,0,0,1];Sl.vec4.transformMat4(qe,qe,Ve);const pt=qe[3]/Oe.cameraToCenterDistance,vt=Fu(xi),zt=Oe.projection.pixelsPerMeter(Fe.lat,Xn)*gl(Fe.lat,xi),ri=Oe.projection.pixelsPerMeter(Oe.center.lat,Xn)*gl(Oe.center.lat,xi);jr=pt/ze(zt,yl(Oe.center.lat),vt),Qr=pt*wi/zt,jr*=ri,Qr*=ri}}else jr=dr;Sl.mat4.scale(F,F,[jr,jr,Qr]);const ho=[...F],yo=Ae.orientation,zo=[];if(Lm(zo,[yo[0]+Ve[0],yo[1]+Ve[1],yo[2]+Ve[2]],qe),Sl.mat4.multiply(F,ho,zo),vt&&Oe.elevation){let Ve=0;const qe=[];if(zt&&Oe.elevation){Ve=function(F,Ae,Oe,Fe,Ve){const qe=Ae.elevation;if(!qe)return 0;const pt=xu.projectAabbCorners(Oe,Fe),vt=hl(1,Ve.lat)*Ae.worldSize,zt=function(F,Ae){const Oe=[0,0,1],Fe=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Ve of Fe){const Fe=F[Ve.corners[0]],qe=F[Ve.corners[1]],pt=F[Ve.corners[2]],vt=[qe[0]-Fe[0],qe[1]-Fe[1],Ae*(qe[2]-Fe[2])],zt=Sl.vec3.cross(vt,vt,[pt[0]-Fe[0],pt[1]-Fe[1],Ae*(pt[2]-Fe[2])]);Sl.vec3.normalize(zt,zt),Ve.dotProductWithUp=Sl.vec3.dot(zt,Oe)}return Fe.sort(((F,Ae)=>F.dotProductWithUp-Ae.dotProductWithUp)),Fe[0].corners}(pt,vt),ri=pt[zt[0]],xi=pt[zt[1]],bi=pt[zt[2]],wi=pt[zt[3]],dr=qe.getAtPointOrZero(new bl(ri[0]/Ae.worldSize,ri[1]/Ae.worldSize),0),jr=qe.getAtPointOrZero(new bl(xi[0]/Ae.worldSize,xi[1]/Ae.worldSize),0),Qr=qe.getAtPointOrZero(new bl(bi[0]/Ae.worldSize,bi[1]/Ae.worldSize),0),Xn=qe.getAtPointOrZero(new bl(wi[0]/Ae.worldSize,wi[1]/Ae.worldSize),0),ho=(dr+Xn)/2,yo=(jr+Qr)/2;return ho>yo?jr<Qr?Rm(F,xi,wi,ri,jr,Xn,dr,vt):Rm(F,bi,ri,wi,Qr,dr,Xn,vt):dr<Xn?Rm(F,ri,xi,bi,dr,jr,Qr,vt):Rm(F,wi,bi,xi,Xn,Qr,jr,vt),Math.max(ho,yo)}(qe,Oe,Ae.aabb,F,Fe);const pt=Sl.mat4.fromQuat([],qe),vt=Sl.mat4.multiply([],pt,zo);Sl.mat4.multiply(F,ho,vt)}else Ve=Oe.elevation.getAtPointOrZero(new bl(bi.x/Xn,bi.y/Xn),0);0!==Ve&&(F[14]+=Ve)}}function iy(F,Ae,Oe=!1){F.uploaded||(F.gfxTexture=new dm(Ae,F.image,Oe?Ae.gl.R8:Ae.gl.RGBA8,{useMipmap:F.sampler.minFilter>=Ae.gl.NEAREST_MIPMAP_NEAREST}),F.uploaded=!0,F.image=null)}function ay(F,Ae,Oe){F.indexBuffer=Ae.createIndexBuffer(F.indexArray,!1,!0),F.vertexBuffer=Ae.createVertexBuffer(F.vertexArray,Dv.members,!1,!0),F.normalArray&&(F.normalBuffer=Ae.createVertexBuffer(F.normalArray,Ov.members,!1,!0)),F.texcoordArray&&(F.texcoordBuffer=Ae.createVertexBuffer(F.texcoordArray,kv.members,!1,!0)),F.colorArray&&(F.colorBuffer=Ae.createVertexBuffer(F.colorArray,(12===F.colorArray.bytesPerElement?Rv:Lv).members,!1,!0)),F.featureArray&&(F.pbrBuffer=Ae.createVertexBuffer(F.featureArray,Bv.members,!0)),F.segments=po.simpleSegment(0,0,F.vertexArray.length,F.indexArray.length);const Fe=F.material;Fe.pbrMetallicRoughness.baseColorTexture&&iy(Fe.pbrMetallicRoughness.baseColorTexture,Ae),Fe.pbrMetallicRoughness.metallicRoughnessTexture&&iy(Fe.pbrMetallicRoughness.metallicRoughnessTexture,Ae),Fe.normalTexture&&iy(Fe.normalTexture,Ae),Fe.occlusionTexture&&iy(Fe.occlusionTexture,Ae,Oe),Fe.emissionTexture&&iy(Fe.emissionTexture,Ae)}function sy(F,Ae,Oe){if(F.meshes)for(const Fe of F.meshes)ay(Fe,Ae,Oe);if(F.children)for(const Fe of F.children)sy(Fe,Ae,Oe)}function oy(F){if(F.meshes)for(const Ae of F.meshes)Ae.indexArray.destroy(),Ae.vertexArray.destroy(),Ae.colorArray&&Ae.colorArray.destroy(),Ae.normalArray&&Ae.normalArray.destroy(),Ae.texcoordArray&&Ae.texcoordArray.destroy(),Ae.featureArray&&Ae.featureArray.destroy();if(F.children)for(const Ae of F.children)oy(Ae)}function ly(F){if(F.meshes)for(const Oe of F.meshes)Oe.vertexBuffer&&(Oe.vertexBuffer.destroy(),Oe.indexBuffer.destroy(),Oe.normalBuffer&&Oe.normalBuffer.destroy(),Oe.texcoordBuffer&&Oe.texcoordBuffer.destroy(),Oe.colorBuffer&&Oe.colorBuffer.destroy(),Oe.pbrBuffer&&Oe.pbrBuffer.destroy(),Oe.segments.destroy(),Oe.material&&((Ae=Oe.material).pbrMetallicRoughness.baseColorTexture&&Ae.pbrMetallicRoughness.baseColorTexture.gfxTexture&&Ae.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),Ae.pbrMetallicRoughness.metallicRoughnessTexture&&Ae.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&Ae.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),Ae.normalTexture&&Ae.normalTexture.gfxTexture&&Ae.normalTexture.gfxTexture.destroy(),Ae.emissionTexture&&Ae.emissionTexture.gfxTexture&&Ae.emissionTexture.gfxTexture.destroy(),Ae.occlusionTexture&&Ae.occlusionTexture.gfxTexture&&Ae.occlusionTexture.gfxTexture.destroy()));var Ae;if(F.children)for(const Ae of F.children)ly(Ae)}class uy{constructor(F,Ae,Oe){this._demTile=F,this._dem=this._demTile.dem,this._scale=Ae,this._offset=Oe}static create(F,Ae,Oe){const Fe=Oe||F.findDEMTileFor(Ae);if(!Fe||!Fe.dem)return;const Ve=Fe.dem,qe=Fe.tileID,pt=1<<Ae.canonical.z-qe.canonical.z;return new uy(Fe,Ve.dim/Vd/pt,[(Ae.canonical.x/pt-qe.canonical.x)*Ve.dim,(Ae.canonical.y/pt-qe.canonical.y)*Ve.dim])}tileCoordToPixel(F,Ae){const Oe=Ae*this._scale+this._offset[1],Fe=Math.floor(F*this._scale+this._offset[0]),Ve=Math.floor(Oe);return new Jl(Fe,Ve)}getElevationAt(F,Ae,Oe,Fe){const Ve=F*this._scale+this._offset[0],qe=Ae*this._scale+this._offset[1],pt=Math.floor(Ve),vt=Math.floor(qe),zt=this._dem;return Fe=!!Fe,Oe?ze(ze(zt.get(pt,vt,Fe),zt.get(pt,vt+1,Fe),qe-vt),ze(zt.get(pt+1,vt,Fe),zt.get(pt+1,vt+1,Fe),qe-vt),Ve-pt):zt.get(pt,vt,Fe)}getElevationAtPixel(F,Ae,Oe){return this._dem.get(F,Ae,!!Oe)}getMeterToDEM(F){return(1<<this._demTile.tileID.canonical.z)*hl(1,F)*this._dem.stride}}const qv=new Float32Array(262144),Zv=new Uint8Array(262144);function py(F){let Ae=0;if(F.meshes)for(const Oe of F.meshes)Ae=Math.max(Ae,Oe.aabb.max[2]);if(F.children)for(const Oe of F.children)Ae=Math.max(Ae,py(Oe));return Ae}function fy(F,Ae,Oe){if(F.meshes)for(const Fe of F.meshes){if(Fe.aabb.min[0]===1/0)continue;const Ve=xu.applyTransform(Fe.aabb,F.matrix);Oe.insert(Ae,Ve.min[0],Ve.min[1],Ve.max[0],Ve.max[1])}if(F.children)for(const Fe of F.children)fy(Fe,Ae,Oe)}const $v=["","wall","door","roof","window","lamp","logo"];class my{constructor(F){this.node=F,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:F.id,geometry:[],properties:{height:py(F)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new xu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let F=0;const Ae=new xu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const Oe of this.node.meshes)this.node.lightMeshIndex!==F&&(Oe.transformedAabb=xu.applyTransformFast(Oe.aabb,this.node.matrix),Ae.encapsulate(Oe.transformedAabb)),F++;this.aabb=Ae}return this.aabb}}class yy{constructor(F,Ae,Oe,Fe,Ve,qe,pt){this.id=Oe,this.layers=F,this.layerIds=this.layers.map((F=>F.fqid)),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.modelTraits|=Gv.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,Fe&&(this.modelTraits|=Gv.HasMapboxMeshFeatures),Ve&&(this.modelTraits|=Gv.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=qe,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const F of Ae)this.nodesInfo.push(new my(F)),fy(F,pt.featureIndexArray.length,pt.grid),pt.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,pt.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(F,Ae){for(const Oe of this.getNodesInfo()){const Fe=Oe.node;Fe.footprint&&Ae.push({footprint:Fe.footprint,id:F})}}update(F){const Ae=0!==Object.keys(F).length;if(Ae&&!this.stateDependentLayers.length)return;const Oe=Ae?this.stateDependentLayers:this.layers;if(!$(F,this.states))for(const Ae of Oe)this.evaluate(Ae,F);this.states=structuredClone(F)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(F){if(!this.needsUpload)return;const Ae=this.getNodesInfo();for(const Oe of Ae){const Ae=Oe.node;this.uploaded?this.updatePbrBuffer(Ae):sy(Ae,F,!0)}for(const F of Ae)oy(F.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(F){let Ae=!1;if(!F.meshes)return Ae;for(const Oe of F.meshes)Oe.pbrBuffer&&(Oe.pbrBuffer.updateData(Oe.featureArray),Ae=!0);return Ae}needsReEvaluation(F,Ae,Oe){const Fe=F.transform.projectionOptions,Ve=F.style.getBrightness(),qe=this.brightness!==Ve;if(!this.uploaded||this.dirty||Fe.name!==this.projection.name||gy(Oe.paint.get("model-color").value,qe)||gy(Oe.paint.get("model-color-mix-intensity").value,qe)||gy(Oe.paint.get("model-roughness").value,qe)||gy(Oe.paint.get("model-emissive-strength").value,qe)||gy(Oe.paint.get("model-height-based-emissive-strength-multiplier").value,qe)){this.projection=Fe,this.brightness=Ve;const F=this.getNodesInfo();for(const Ae of F)Ae.state=null;return!0}return!1}evaluateScale(F,Ae){if(F.transform.zoom===this.zoom)return;this.zoom=F.transform.zoom;const Oe=this.getNodesInfo(),Fe=this.id.canonical;for(const F of Oe){const Oe=F.feature;F.evaluatedScale=Ae.paint.get("model-scale").evaluate(Oe,{},Fe)}}evaluate(F,Ae){const Oe=this.getNodesInfo();for(const Fe of Oe){if(!Fe.node.meshes)continue;const Oe=Fe.feature,Ve=Ae&&Ae[Oe.id];if($(Ve,Fe.state))continue;Fe.state=structuredClone(Ve);const qe=Fe.node.meshes&&Fe.node.meshes[0].featureData,pt=Fe.evaluatedColor[2],vt=Fe.evaluatedRMEA[2],zt=this.id.canonical;if(Fe.hasTranslucentParts=!1,qe){for(let Ae=0;Ae<$v.length;Ae++){const qe=$v[Ae];qe.length&&(Oe.properties.part=qe);const pt=F.paint.get("model-color").evaluate(Oe,Ve,zt).toRenderColor(null),vt=F.paint.get("model-color-mix-intensity").evaluate(Oe,Ve,zt);Fe.evaluatedColor[Ae]=[pt.r,pt.g,pt.b,vt],Fe.evaluatedRMEA[Ae][0]=F.paint.get("model-roughness").evaluate(Oe,Ve,zt),Fe.evaluatedRMEA[Ae][2]=F.paint.get("model-emissive-strength").evaluate(Oe,Ve,zt),Fe.evaluatedRMEA[Ae][3]=pt.a,Fe.emissionHeightBasedParams[Ae]=F.paint.get("model-height-based-emissive-strength-multiplier").evaluate(Oe,Ve,zt),!Fe.hasTranslucentParts&&pt.a<1&&(Fe.hasTranslucentParts=!0)}delete Oe.properties.part,vy(Fe,pt!==Fe.evaluatedColor[2]||vt!==Fe.evaluatedRMEA[2],this.modelTraits)}else Fe.evaluatedRMEA[0][2]=F.paint.get("model-emissive-strength").evaluate(Oe,Ve,zt);Fe.evaluatedScale=F.paint.get("model-scale").evaluate(Oe,Ve,zt),this.updatePbrBuffer(Fe.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(F,Ae,Oe,Fe){const Ve=F.findDEMTileFor(Oe);if(Ve&&(Ve.tileID.canonical!==this.terrainTile||Ae!==this.terrainExaggeration)){if(Ve.dem&&Ve.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=Ve.tileID.overscaledZ;const Ae=uy.create(F,Oe,Ve);if(!Ae)return;this.modelTraits&Gv.HasMapboxMeshFeatures&&this.updateDEM(F,Ae,Oe,Fe);for(const F of this.getNodesInfo()){const Oe=F.node;if(!Oe.footprint||!Oe.footprint.vertices||!Oe.footprint.vertices.length)continue;const Fe=Oe.footprint.vertices;let Ve=Ae.getElevationAt(Fe[0].x,Fe[0].y,!0,!0);for(let F=1;F<Fe.length;F++)Ve=Math.min(Ve,Ae.getElevationAt(Fe[F].x,Fe[F].y,!0,!0));Oe.elevation=Ve}}this.terrainTile=Ve.tileID.canonical,this.terrainExaggeration=Ae}}updateDEM(F,Ae,Oe,Fe){let Ve=Ae._dem._modifiedForSources[Fe];if(void 0===Ve&&(Ae._dem._modifiedForSources[Fe]=[],Ve=Ae._dem._modifiedForSources[Fe]),Ve.includes(Oe.canonical))return;const qe=Ae._dem.dim;Ve.push(Oe.canonical);let pt=!1;for(const F of this.getNodesInfo()){const Oe=F.node;if(!Oe.footprint||!Oe.footprint.grid)continue;const Fe=Oe.footprint.grid,Ve=Ae.tileCoordToPixel(Fe.min.x,Fe.min.y),vt=Ae.tileCoordToPixel(Fe.max.x,Fe.max.y),zt=Math.min(Math.min(qe-vt.y,Ve.x),Math.min(Ve.y,qe-vt.x));if(zt<0)continue;const ri=Q(zt,2,5);let xi=Math.max(0,Ve.x-ri),bi=Math.max(0,Ve.y-ri),wi=Math.min(vt.x+ri,qe-1),dr=Math.min(vt.y+ri,qe-1);for(let F=bi;F<=dr;++F)for(let Ae=xi;Ae<=wi;++Ae)Zv[F*qe+Ae]=255;let jr=0,Qr=0;for(let F=0;F<Fe.cellsY;++F)for(let Oe=0;Oe<Fe.cellsX;++Oe){if(!Fe.cells[F*Fe.cellsX+Oe])continue;const Ve=Ae.tileCoordToPixel(Fe.min.x+Oe/Fe.xScale,Fe.min.y+F/Fe.yScale),pt=Ae.tileCoordToPixel(Fe.min.x+(Oe+1)/Fe.xScale,Fe.min.y+(F+1)/Fe.yScale);for(let F=Ve.y;F<=Math.min(pt.y+1,qe-1);++F)for(let Oe=Ve.x;Oe<=Math.min(pt.x+1,qe-1);++Oe)255===Zv[F*qe+Oe]&&(Zv[F*qe+Oe]=0,jr+=Ae.getElevationAtPixel(Oe,F),Qr++)}const Xn=jr/Qr;xi=Math.max(1,Ve.x-ri),bi=Math.max(1,Ve.y-ri),wi=Math.min(vt.x+ri,qe-2),dr=Math.min(vt.y+ri,qe-2),pt=!0;for(let F=bi;F<=dr;++F)for(let Oe=xi;Oe<=wi;++Oe)0===Zv[F*qe+Oe]&&(qv[F*qe+Oe]=Ae._dem.set(Oe,F,Xn));for(let F=1;F<ri;++F){xi=Math.max(1,Ve.x-F),bi=Math.max(1,Ve.y-F),wi=Math.min(vt.x+F,qe-2),dr=Math.min(vt.y+F,qe-2);for(let Oe=bi;Oe<=dr;++Oe)for(let Fe=xi;Fe<=wi;++Fe){const Ve=Oe*qe+Fe;if(255===Zv[Ve]){let pt=0,vt=0,zt=-1,xi=-1;for(let Ae=-1;Ae<=1;++Ae)for(let Ve=-1;Ve<=1;++Ve){const ri=(Oe+Ae)*qe+Fe+Ve;if(Zv[ri]>=F)continue;const bi=qv[ri],wi=Math.abs(bi);wi>vt&&(pt=bi,vt=wi,zt=Ve,xi=Ae)}if(vt>.1){const qe=1-(F+.5*Math.abs(zt*xi))/ri;let vt=Ae._dem.get(Fe,Oe)+pt*qe;const bi=Ae._dem.get(Fe+zt,Oe+xi),wi=Ae._dem.get(Fe-zt,Oe-xi,!0);(vt-bi)*(vt-wi)>0&&(vt=(bi+wi)/2),qv[Ve]=Ae._dem.set(Fe,Oe,vt),Zv[Ve]=F}}}}}pt&&(Ae._demTile.needsDEMTextureUpload=!0,Ae._dem._timestamp=eh.now())}getNodesInfo(){return this.nodesInfo}destroy(){const F=this.getNodesInfo();for(const Ae of F)oy(Ae.node),ly(Ae.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(F,Ae){if(Ae.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=Ae.updateTime;const Oe=Ae.getReplacementRegionsForTile(F.toUnwrapped()),Fe=this.getNodesInfo();for(let F=0;F<this.nodesInfo.length;F++){const Ae=Fe[F].node;Fe[F].hiddenByReplacement=!!Ae.footprint&&!Oe.find((F=>F.footprint===Ae.footprint))}}getHeightAtTileCoord(F,Ae){const Oe=this.getNodesInfo(),Fe=[],Ve=[0,0,0],qe=Sl.mat4.identity([]);for(let pt=0;pt<this.nodesInfo.length;pt++){const vt=Oe[pt],zt=vt.node.meshes[0],ri=zt.transformedAabb;if(F<ri.min[0]||Ae<ri.min[1]||F>ri.max[0]||Ae>ri.max[1])continue;if(!0===vt.node.hidden)return{height:1/0,maxHeight:vt.feature.properties.height,hidden:!1,verticalScale:vt.evaluatedScale[2]};Sl.mat4.invert(qe,vt.node.matrix),Ve[0]=F,Ve[1]=Ae,Sl.vec3.transformMat4(Ve,Ve,qe);const xi=(Ve[0]-zt.aabb.min[0])/(zt.aabb.max[0]-zt.aabb.min[0])*jv|0,bi=Math.min(63,(Ve[1]-zt.aabb.min[1])/(zt.aabb.max[1]-zt.aabb.min[1])*jv|0)*jv+Math.min(63,xi),wi=zt.heightmap[bi];if(!(wi<0&&vt.node.footprint)){if(vt.hiddenByReplacement)return;return{height:wi,maxHeight:vt.feature.properties.height,hidden:!1,verticalScale:vt.evaluatedScale[2]}}if(vt.node.footprint.grid.query(new Jl(F,Ae),new Jl(F,Ae),Fe),Fe.length>0)return{height:void 0,maxHeight:vt.feature.properties.height,hidden:vt.hiddenByReplacement,verticalScale:vt.evaluatedScale[2]}}}}function gy(F,Ae){return!F.isLightConstant&&Ae}function xy(F,Ae,Oe,Fe,Ve,qe,pt,vt){let zt=(61440&Ae|(61440&Ae)>>4)>>8,ri=(3840&Ae|(3840&Ae)>>4)>>4,xi=240&Ae|(240&Ae)>>4;Oe[3]>0&&(zt=ze(zt,255*Oe[0],Oe[3]),ri=ze(ri,255*Oe[1],Oe[3]),xi=ze(xi,255*Oe[2],Oe[3]));const bi=zt<<8|ri,wi=xi<<8|Math.floor(255*Fe[3]),dr=function(F){const Ae=Q(F,0,2);return Math.min(Math.round(.5*Ae*255),255)}(Fe[2])<<8|15*Fe[0]<<4|15*Fe[1],jr=Q(Ve[0],0,1),Qr=Q(Ve[1],0,1),Xn=Q(Ve[2],0,1),ho=Q(Ve[3],0,1);let yo,zo,ko,Uo;if(jr!==Qr&&pt!==qe&&Qr!==jr){const F=pt-qe;zo=1/(F*(Qr-jr)),ko=-(qe+F*jr)/(F*(Qr-jr));const Ae=Q(Ve[4],-1,1);Uo=Math.pow(10,Ae),yo=255*Xn<<8|255*ho}else yo=65535,zo=0,ko=1,Uo=1;if(F.emplaceBack(bi,wi,dr,yo,zo,ko,Uo),vt){const F=vt.length;vt.clear();for(let Ae=0;Ae<F;Ae++)vt.emplaceBack(bi,wi,dr,yo,zo,ko,Uo)}}function vy(F,Ae,Oe){const Fe=F.node;let Ve=0;const qe=Oe&Gv.HasMeshoptCompression;for(const Oe of Fe.meshes){if(Fe.lights&&Fe.lightMeshIndex===Ve)continue;if(!Oe.featureData)continue;Oe.featureArray=new Zs,Oe.featureArray.reserve(Oe.featureData.length);let pt=Ae;for(const Ae of Oe.featureData){const Ve=qe?65535&Ae:Ae>>16&65535,vt=qe?Ae>>16&65535:65535&Ae,zt=(15&vt)<8?15&vt:0,ri=F.evaluatedRMEA[zt],xi=F.evaluatedColor[zt],bi=F.emissionHeightBasedParams[zt];let wi;if(pt&&2===zt&&Fe.lights&&(wi=new Zs,wi.resize(10*Fe.lights.length)),xy(Oe.featureArray,Ve,xi,ri,bi,Oe.aabb.min[2],Oe.aabb.max[2],wi),wi&&pt){pt=!1;const F=Fe.meshes[Fe.lightMeshIndex];F.featureArray=wi,F.featureArray._trim()}}Oe.featureArray._trim(),Ve++}}function by(F,Ae,Oe,Fe){const Ve=1<<F.z;Ae.lat=fl((Fe/Vd+F.y)/Ve),Ae.lng=pl((Oe/Vd+F.x)/Ve)}oa(yy,"Tiled3dModelBucket",{omit:["layers"]}),oa(my,"Tiled3dModelFeature");const Hv={circle:class extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:$m||($m=new Ga({"circle-sort-key":new qa(pf.layout_circle["circle-sort-key"]),"circle-elevation-reference":new ja(pf.layout_circle["circle-elevation-reference"]),visibility:new ja(pf.layout_circle.visibility)})),paint:Xm||(Xm=new Ga({"circle-radius":new qa(pf.paint_circle["circle-radius"]),"circle-color":new qa(pf.paint_circle["circle-color"]),"circle-blur":new qa(pf.paint_circle["circle-blur"]),"circle-opacity":new qa(pf.paint_circle["circle-opacity"]),"circle-translate":new ja(pf.paint_circle["circle-translate"]),"circle-translate-anchor":new ja(pf.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ja(pf.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ja(pf.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new qa(pf.paint_circle["circle-stroke-width"]),"circle-stroke-color":new qa(pf.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new qa(pf.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new ja(pf.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe)}createBucket(F){return new Bl(F)}queryRadius(F){const Ae=F;return Xl("circle-radius",this,Ae)+Xl("circle-stroke-width",this,Ae)+Zl(this.paint.get("circle-translate"))}queryIntersectsFeature(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=Wl(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),qe.angle,F.pixelToTileUnitsFactor),ri=this.paint.get("circle-radius").evaluate(Ae,Oe)+this.paint.get("circle-stroke-width").evaluate(Ae,Oe);return Yu(F,Fe,qe,pt,vt,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),zt,ri)}getProgramIds(){return["circle"]}getDefaultProgramParams(F,Ae,Oe){const Fe=Gu(this);return{config:new Oo(this,{zoom:Ae,lut:Oe}),defines:Fe,overrideFog:!1}}},heatmap:class extends ps{createBucket(F){return new Ku(F)}constructor(F,Ae,Oe,Fe){super(F,{layout:f_||(f_=new Ga({visibility:new ja(pf.layout_heatmap.visibility)})),paint:m_||(m_=new Ga({"heatmap-radius":new qa(pf.paint_heatmap["heatmap-radius"]),"heatmap-weight":new qa(pf.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ja(pf.paint_heatmap["heatmap-intensity"]),"heatmap-color":new $a(pf.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ja(pf.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(F){"heatmap-color"===F&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=lc({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(F){return Xl("heatmap-radius",this,F)}queryIntersectsFeature(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=this.paint.get("heatmap-radius").evaluate(Ae,Oe);return Yu(F,Fe,qe,pt,vt,!0,!0,new Jl(0,0),zt)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(F,Ae,Oe){return"heatmap"===F?{config:new Oo(this,{zoom:Ae,lut:Oe}),overrideFog:!1}:{}}},hillshade:class extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:__||(__=new Ga({visibility:new ja(pf.layout_hillshade.visibility)})),paint:g_||(g_=new Ga({"hillshade-illumination-direction":new ja(pf.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ja(pf.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ja(pf.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ja(pf.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ja(pf.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ja(pf.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new ja(pf.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(F,Ae,Oe){return{overrideFog:!1}}},fill:class extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:v_||(v_=new Ga({"fill-sort-key":new qa(pf.layout_fill["fill-sort-key"]),visibility:new ja(pf.layout_fill.visibility),"fill-elevation-reference":new ja(pf.layout_fill["fill-elevation-reference"])})),paint:b_||(b_=new Ga({"fill-antialias":new ja(pf.paint_fill["fill-antialias"]),"fill-opacity":new qa(pf.paint_fill["fill-opacity"]),"fill-color":new qa(pf.paint_fill["fill-color"]),"fill-outline-color":new qa(pf.paint_fill["fill-outline-color"]),"fill-translate":new ja(pf.paint_fill["fill-translate"]),"fill-translate-anchor":new ja(pf.paint_fill["fill-translate-anchor"]),"fill-pattern":new qa(pf.paint_fill["fill-pattern"]),"fill-emissive-strength":new ja(pf.paint_fill["fill-emissive-strength"]),"fill-z-offset":new qa(pf.paint_fill["fill-z-offset"]),"fill-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe)}getProgramIds(){const F=this.paint.get("fill-pattern"),Ae=F&&F.constantOr(1),Oe=[Ae?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&Oe.push(Ae&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),Oe}getDefaultProgramParams(F,Ae,Oe){return{config:new Oo(this,{zoom:Ae,lut:Oe}),overrideFog:!1}}recalculate(F,Ae){super.recalculate(F,Ae);const Oe=this.paint._values["fill-outline-color"];"constant"===Oe.value.kind&&void 0===Oe.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(F){return new Uc(F)}queryRadius(){return Zl(this.paint.get("fill-translate"))}queryIntersectsFeature(F,Ae,Oe,Fe,Ve,qe){return!F.queryGeometry.isAboveHorizon&&Dl(Hl(F.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),qe.angle,F.pixelToTileUnitsFactor),Fe)}isTileClipped(){return!0}is3D(){return 0!==this.paint.get("fill-z-offset").constantOr(1)}},"fill-extrusion":class extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:Y_||(Y_=new Ga({visibility:new ja(pf["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new ja(pf["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:K_||(K_=new Ga({"fill-extrusion-opacity":new ja(pf["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new qa(pf["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ja(pf["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ja(pf["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new qa(pf["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new qa(pf["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new qa(pf["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new ja(pf["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new ja(pf["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new ja(pf["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new ja(pf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new ja(pf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new ja(pf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new ja(pf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new ja(pf["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new ja(pf["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new ja(pf["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new qa(pf["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new qa(pf["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new ja(pf["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new ja(pf["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new ja(pf["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new ja(pf["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new qa(pf["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new qa(pf["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new ja(pf["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(F){return new Kh(F)}queryRadius(){return Zl(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri=Wl(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),qe.angle,F.pixelToTileUnitsFactor),xi=this.paint.get("fill-extrusion-height").evaluate(Ae,Oe),bi=this.paint.get("fill-extrusion-base").evaluate(Ae,Oe),wi=[0,0],dr=vt&&qe.elevation,jr=qe.elevation?qe.elevation.exaggeration():1,Qr=F.tile.getBucket(this);if(dr&&Qr instanceof Kh){const F=Qr.centroidVertexArray,Ae=zt+1;Ae<F.length&&(wi[0]=F.geta_centroid_pos0(Ae),wi[1]=F.geta_centroid_pos1(Ae))}if(0===wi[0]&&1===wi[1])return!1;"globe"===qe.projection.name&&(Fe=sp([Fe],[new Jl(0,0),new Jl(Vd,Vd)],F.tileID.canonical).map((F=>F.polygon)).flat());const Xn=dr?vt:null,[ho,yo]=function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi){return"globe"===F.projection.name?function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi){const bi=[],wi=[],dr=F.projection.upVectorScale(xi,F.center.lat,F.worldSize).metersToTile,jr=[0,0,0,1],Qr=[0,0,0,1],y=(F,Ae,Oe,Fe)=>{F[0]=Ae,F[1]=Oe,F[2]=Fe,F[3]=1},Xn=ap();Oe>0&&(Oe+=Xn),Fe+=Xn;for(const Xn of Ae){const Ae=[],ho=[];for(const bi of Xn){const wi=bi.x+Ve.x,Xn=bi.y+Ve.y,yo=F.projection.projectTilePoint(wi,Xn,xi),zo=F.projection.upVector(xi,bi.x,bi.y);let ko=Oe,Uo=Fe;if(pt){const F=pp(wi,Xn,Oe,Fe,pt,vt,zt,ri);ko+=F.base,Uo+=F.top}0!==Oe?y(jr,yo.x+zo[0]*dr*ko,yo.y+zo[1]*dr*ko,yo.z+zo[2]*dr*ko):y(jr,yo.x,yo.y,yo.z),y(Qr,yo.x+zo[0]*dr*Uo,yo.y+zo[1]*dr*Uo,yo.z+zo[2]*dr*Uo),Sl.vec3.transformMat4(jr,jr,qe),Sl.vec3.transformMat4(Qr,Qr,qe),Ae.push(new dh(jr[0],jr[1],jr[2])),ho.push(new dh(Qr[0],Qr[1],Qr[2]))}bi.push(Ae),wi.push(ho)}return[bi,wi]}(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi):pt?function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri=[],xi=[],bi=[0,0,0,1];for(const wi of F){const F=[],dr=[];for(const ri of wi){const xi=ri.x+Fe.x,wi=ri.y+Fe.y,jr=pp(xi,wi,Ae,Oe,qe,pt,vt,zt);bi[0]=xi,bi[1]=wi,bi[2]=jr.base,bi[3]=1,Sl.vec4.transformMat4(bi,bi,Ve),bi[3]=Math.max(bi[3],1e-5);const Qr=new dh(bi[0]/bi[3],bi[1]/bi[3],bi[2]/bi[3]);bi[0]=xi,bi[1]=wi,bi[2]=jr.top,bi[3]=1,Sl.vec4.transformMat4(bi,bi,Ve),bi[3]=Math.max(bi[3],1e-5);const Xn=new dh(bi[0]/bi[3],bi[1]/bi[3],bi[2]/bi[3]);F.push(Qr),dr.push(Xn)}ri.push(F),xi.push(dr)}return[ri,xi]}(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri):function(F,Ae,Oe,Fe,Ve){const qe=[],pt=[],vt=Ve[8]*Ae,zt=Ve[9]*Ae,ri=Ve[10]*Ae,xi=Ve[11]*Ae,bi=Ve[8]*Oe,wi=Ve[9]*Oe,dr=Ve[10]*Oe,jr=Ve[11]*Oe;for(const Ae of F){const F=[],Oe=[];for(const qe of Ae){const Ae=qe.x+Fe.x,pt=qe.y+Fe.y,Qr=Ve[0]*Ae+Ve[4]*pt+Ve[12],Xn=Ve[1]*Ae+Ve[5]*pt+Ve[13],ho=Ve[2]*Ae+Ve[6]*pt+Ve[14],yo=Ve[3]*Ae+Ve[7]*pt+Ve[15],zo=Qr+vt,ko=Xn+zt,Uo=ho+ri,ia=Math.max(yo+xi,1e-5),_a=Qr+bi,Ma=Xn+wi,Ea=ho+dr,Ia=Math.max(yo+jr,1e-5);F.push(new dh(zo/ia,ko/ia,Uo/ia)),Oe.push(new dh(_a/Ia,Ma/Ia,Ea/Ia))}qe.push(F),pt.push(Oe)}return[qe,pt]}(Ae,Oe,Fe,Ve,qe)}(qe,Fe,bi,xi,ri,pt,Xn,wi,jr,qe.center.lat,F.tileID.canonical),zo=F.queryGeometry;return function(F,Ae,Oe){let Fe=1/0;Dl(Oe,Ae)&&(Fe=hp(Oe,Ae[0]));for(let Ve=0;Ve<Ae.length;Ve++){const qe=Ae[Ve],pt=F[Ve];for(let F=0;F<qe.length-1;F++){const Ae=qe[F],Ve=[Ae,qe[F+1],pt[F+1],pt[F],Ae];Cl(Oe,Ve)&&(Fe=Math.min(Fe,hp(Oe,Ve)))}}return Fe!==1/0&&Fe}(ho,yo,zo.isPointQuery()?zo.screenBounds:zo.screenGeometry)}},line:class extends ps{constructor(F,Ae,Oe,Fe){const Ve=Dp();super(F,Ve,Ae,Oe,Fe),Ve.layout&&(this.layout=new Ua(Ve.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(F){if("line-gradient"===F){const F=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=F._styleExpression&&F._styleExpression.expression instanceof Nn,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(F,Ae){super.recalculate(F,Ae),this.paint._values["line-floorwidth"]=(()=>{if(hy)return hy;const F=Dp();return hy=new Lp(F.paint.properties["line-width"].specification),hy.useIntegerZoom=!0,hy})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,F)}createBucket(F){return new Ap(F)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(F,Ae,Oe){const Fe=Bp(this);return{config:new Oo(this,{zoom:Ae,lut:Oe}),defines:Fe,overrideFog:!1}}queryRadius(F){const Ae=F,Oe=Fp(Xl("line-width",this,Ae),Xl("line-gap-width",this,Ae)),Fe=Xl("line-offset",this,Ae);return Oe/2+Math.abs(Fe)+Zl(this.paint.get("line-translate"))}queryIntersectsFeature(F,Ae,Oe,Fe,Ve,qe){if(F.queryGeometry.isAboveHorizon)return!1;const pt=Hl(F.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),qe.angle,F.pixelToTileUnitsFactor),vt=F.pixelToTileUnitsFactor/2*Fp(this.paint.get("line-width").evaluate(Ae,Oe),this.paint.get("line-gap-width").evaluate(Ae,Oe)),zt=this.paint.get("line-offset").evaluate(Ae,Oe);return zt&&(Fe=function(F,Ae){const Oe=[],Fe=new Jl(0,0);for(let Ve=0;Ve<F.length;Ve++){const qe=F[Ve],pt=[];for(let F=0;F<qe.length;F++){const Oe=qe[F],Ve=qe[F+1],vt=0===F?Fe:Oe.sub(qe[F-1])._unit()._perp(),zt=F===qe.length-1?Fe:Ve.sub(Oe)._unit()._perp(),ri=vt._add(zt)._unit();ri._mult(1/(ri.x*zt.x+ri.y*zt.y)),pt.push(ri._mult(Ae)._add(Oe))}Oe.push(pt)}return Oe}(Fe,zt*F.pixelToTileUnitsFactor)),function(F,Ae,Oe){for(let Fe=0;Fe<Ae.length;Fe++){const Ve=Ae[Fe];if(F.length>=3)for(let Ae=0;Ae<Ve.length;Ae++)if(jl(F,Ve[Ae]))return!0;if(Ll(F,Ve,Oe))return!0}return!1}(pt,Fe,vt)}isTileClipped(){return!0}isDraped(F){return!this.hasElevatedBuckets}},symbol:sm,background:class extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:dv||(dv=new Ga({visibility:new ja(pf.layout_background.visibility)})),paint:_v||(_v=new Ga({"background-pitch-alignment":new ja(pf.paint_background["background-pitch-alignment"]),"background-color":new ja(pf.paint_background["background-color"]),"background-pattern":new ja(pf.paint_background["background-pattern"]),"background-opacity":new ja(pf.paint_background["background-opacity"]),"background-emissive-strength":new ja(pf.paint_background["background-emissive-strength"]),"background-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(F,Ae,Oe){return{overrideFog:!1}}is3D(){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:_m,"raster-particle":Pm,sky:class extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:Av||(Av=new Ga({visibility:new ja(pf.layout_sky.visibility)})),paint:Cv||(Cv=new Ga({"sky-type":new ja(pf.paint_sky["sky-type"]),"sky-atmosphere-sun":new ja(pf.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ja(pf.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ja(pf.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ja(pf.paint_sky["sky-gradient-radius"]),"sky-gradient":new $a(pf.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ja(pf.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ja(pf.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ja(pf.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(F){"sky-gradient"===F?this._updateColorRamp():"sky-atmosphere-sun"!==F&&"sky-atmosphere-halo-color"!==F&&"sky-atmosphere-color"!==F&&"sky-atmosphere-sun-intensity"!==F||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=lc({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(F){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const Ae=F.style.light.properties.get("position");return this._lightPosition.azimuthal!==Ae.azimuthal||this._lightPosition.polar!==Ae.polar}return!1}getCenter(F,Ae){if("atmosphere"===this.paint.get("sky-type")){const Oe=this.paint.get("sky-atmosphere-sun"),Fe=!Oe,Ve=F.style.light,qe=Ve.properties.get("position");return Fe&&"viewport"===Ve.properties.get("anchor")&&ft("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),Fe?Em(qe.azimuthal,90-qe.polar,Ae):Em(Oe[0],90-Oe[1],Ae)}const Oe=this.paint.get("sky-gradient-center");return Em(Oe[0],90-Oe[1],Ae)}isSky(){return!0}markSkyboxValid(F){this._skyboxInvalidated=!1,this._lightPosition=F.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const F=this.paint.get("sky-type");return"atmosphere"===F?["skyboxCapture","skybox"]:"gradient"===F?["skyboxGradient"]:null}},slot:class extends ps{constructor(F,Ae,Oe,Fe){super(F,{paint:Pv||(Pv=new Ga({}))},Ae,null)}},model:class extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:Vv||(Vv=new Ga({visibility:new ja(pf.layout_model.visibility),"model-id":new qa(pf.layout_model["model-id"])})),paint:Uv||(Uv=new Ga({"model-opacity":new qa(pf.paint_model["model-opacity"]),"model-rotation":new qa(pf.paint_model["model-rotation"]),"model-scale":new qa(pf.paint_model["model-scale"]),"model-translation":new qa(pf.paint_model["model-translation"]),"model-color":new qa(pf.paint_model["model-color"]),"model-color-mix-intensity":new qa(pf.paint_model["model-color-mix-intensity"]),"model-type":new ja(pf.paint_model["model-type"]),"model-cast-shadows":new ja(pf.paint_model["model-cast-shadows"]),"model-receive-shadows":new ja(pf.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new ja(pf.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new qa(pf.paint_model["model-emissive-strength"]),"model-roughness":new qa(pf.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new qa(pf.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new ja(pf.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new ja(pf.paint_model["model-front-cutoff"]),"model-color-use-theme":new qa({type:"string",default:"default","property-type":"data-driven"})}))},Ae,Oe,Fe),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(F){return new Jm(F)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(F){return F instanceof yy?Vd-1:0}queryIntersectsFeature(F,Ae,Oe,Fe,Ve,qe){if(!this.modelManager)return!1;const pt=this.modelManager,vt=F.tile.getBucket(this);if(!(vt&&vt instanceof Jm))return!1;for(const Oe in vt.instancesPerModel){const Fe=vt.instancesPerModel[Oe],Ve=void 0!==Ae.id?Ae.id:Ae.properties&&Ae.properties.hasOwnProperty("id")?Ae.properties.id:void 0;if(Fe.idToFeaturesIndex.hasOwnProperty(Ve)){const Ae=Fe.features[Fe.idToFeaturesIndex[Ve]],zt=pt.getModel(Oe,this.scope);if(!zt)return!1;let ri=Sl.mat4.create();const xi=new il(0,0),bi=vt.canonical;let wi=Number.MAX_VALUE;for(let Oe=0;Oe<Ae.instancedDataCount;++Oe){const Ve=16*(Ae.instancedDataOffset+Oe),pt=Fe.instancedDataArray.float32,vt=[pt[Ve+4],pt[Ve+5],pt[Ve+6]];by(bi,xi,pt[Ve],0|pt[Ve+1]),ny(ri,zt,qe,xi,Ae.rotation,Ae.scale,vt,!1,!1,!1),"globe"===qe.projection.name&&(ri=Fm(ri,qe));const dr=Sl.mat4.multiply([],qe.projMatrix,ri),jr=F.queryGeometry,Qr=Om(jr.isPointQuery()?jr.screenBounds:jr.screenGeometry,qe,dr,zt.aabb);null!=Qr&&(wi=Math.min(Qr,wi))}return wi!==Number.MAX_VALUE&&wi}}return!1}_handleOverridablePaintPropertyUpdate(F,Ae,Oe){return!(!this.layout||Ae.isDataDriven()||Oe.isDataDriven()||"model-color"!==F&&"model-color-mix-intensity"!==F&&"model-rotation"!==F&&"model-scale"!==F&&"model-translation"!==F&&"model-emissive-strength"!==F)}_isPropertyZoomDependent(F){const Ae=this._transitionablePaint._values[F];return null!=Ae&&null!=Ae.value&&null!=Ae.value.expression&&Ae.value.expression instanceof Ji}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends ps{constructor(F,Ae,Oe,Fe){super(F,{layout:w_||(w_=new Ga({"clip-layer-types":new ja(pf.layout_clip["clip-layer-types"]),"clip-layer-scope":new ja(pf.layout_clip["clip-layer-scope"])})),paint:T_||(T_=new Ga({}))},Ae,Oe,Fe)}recalculate(F,Ae){super.recalculate(F,Ae)}createBucket(F){return new Zc(F)}isTileClipped(){return!0}is3D(){return!0}}};class wy{constructor(F){this._callback=F,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class My{constructor(){this.tasks={},this.taskQueue=[],ot(["process"],this),this.invoker=new wy(this.process),this.nextId=0}add(F,Ae){const Oe=this.nextId++,Fe=function({type:F,isSymbolTile:Ae,zoom:Oe}){return Oe=Oe||0,"message"===F?0:"maybePrepare"!==F||Ae?"parseTile"!==F||Ae?"parseTile"===F&&Ae?300-Oe:"maybePrepare"===F&&Ae?400-Oe:500:200-Oe:100-Oe}(Ae);if(0===Fe){try{F()}finally{}return null}return this.tasks[Oe]={fn:F,metadata:Ae,priority:Fe,id:Oe},this.taskQueue.push(Oe),this.invoker.trigger(),{cancel:()=>{delete this.tasks[Oe]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((F=>!!this.tasks[F])),!this.taskQueue.length)return;const F=this.pick();if(null===F)return;const Ae=this.tasks[F];if(delete this.tasks[F],this.taskQueue.length&&this.invoker.trigger(),!Ae)return;Ae.fn()}finally{}}pick(){let F=null,Ae=1/0;for(let Oe=0;Oe<this.taskQueue.length;Oe++){const Fe=this.tasks[this.taskQueue[Oe]];Fe.priority<Ae&&(Ae=Fe.priority,F=Oe)}if(null===F)return null;const Oe=this.taskQueue[F];return this.taskQueue.splice(F,1),Oe}remove(){this.invoker.remove()}}class Ay{constructor(F,Ae,Oe){this.target=F,this.parent=Ae,this.mapId=Oe,this.callbacks={},this.cancelCallbacks={},ot(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new My}send(F,Ae,Oe,Fe,Ve=!1,qe){const pt=Math.round(1e18*Math.random()).toString(36).substring(0,10);Oe&&(Oe.metadata=qe,this.callbacks[pt]=Oe);const vt=new Set;return this.target.postMessage({id:pt,type:F,hasCallback:!!Oe,targetMapId:Fe,mustQueue:Ve,sourceMapId:this.mapId,data:ca(Ae,vt)},vt),{cancel:()=>{Oe&&delete this.callbacks[pt],this.target.postMessage({id:pt,type:"<cancel>",targetMapId:Fe,sourceMapId:this.mapId})}}}receive(F){const Ae=F.data,Oe=Ae.id;if(Oe&&(!Ae.targetMapId||this.mapId===Ae.targetMapId))if("<cancel>"===Ae.type){const F=this.cancelCallbacks[Oe];delete this.cancelCallbacks[Oe],F&&F.cancel()}else if(Ae.mustQueue||gt()){const F=this.callbacks[Oe],Fe=this.scheduler.add((()=>this.processTask(Oe,Ae)),F&&F.metadata||{type:"message"});Fe&&(this.cancelCallbacks[Oe]=Fe)}else this.processTask(Oe,Ae)}processTask(F,Ae){if(delete this.cancelCallbacks[F],"<response>"===Ae.type){const Oe=this.callbacks[F];delete this.callbacks[F],Oe&&(Ae.error?Oe(ha(Ae.error)):Oe(null,ha(Ae.data)))}else{const Oe=new Set,Fe=Ae.hasCallback?(Ae,Fe)=>{this.target.postMessage({id:F,type:"<response>",sourceMapId:this.mapId,error:Ae?ca(Ae):null,data:ca(Fe,Oe)},Oe)}:()=>{},Ve=ha(Ae.data);if(this.parent[Ae.type])this.parent[Ae.type](Ae.sourceMapId,Ve,Fe);else if(this.parent.getWorkerSource){const F=Ae.type.split(".");this.parent.getWorkerSource(Ae.sourceMapId,F[0],Ve.source,Ve.scope)[F[1]](Ve,Fe)}else Fe(new Error(`Could not find function ${Ae.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Wv={workerUrl:"",workerClass:null,workerParams:void 0};const Xv="mapboxgl_preloaded_worker_pool";class Py{constructor(){this.active={}}acquire(F,Ae=Py.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<Ae;)this.workers.push(null!=Wv.workerClass?new Wv.workerClass:new self.Worker(Wv.workerUrl,Wv.workerParams));return this.active[F]=!0,this.workers.slice()}release(F){delete this.active[F],this.workers&&0===this.numActive()&&(this.workers.forEach((F=>{F.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Xv]}numActive(){return Object.keys(this.active).length}}Py.workerCount=2;class zy{constructor(F,Ae,Oe="Worker",Fe=Py.workerCount){this.workerPool=F,this.actors=[],this.currentActor=0,this.id=at();const Ve=this.workerPool.acquire(this.id,Fe);for(let F=0;F<Ve.length;F++){const Fe=new zy.Actor(Ve[F],Ae,this.id);Fe.name=`${Oe} ${F}`,this.actors.push(Fe)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(F,Ae,Oe){rt(this.actors,((Oe,Fe)=>{Oe.send(F,Ae,Fe)}),Oe=Oe||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((F=>{F.remove()})),this.actors=[],this.workerPool.release(this.id)}}let Yv,Kv;function Ty(){return Yv||(Yv=new Py),Yv}zy.Actor=Ay;const Jv=new Ie(0,0,0);var Qv=(F=>(F[F.PATH_RULE_UNSPECIFIED=0]="PATH_RULE_UNSPECIFIED",F[F.PATH_RULE_NON_ZERO=1]="PATH_RULE_NON_ZERO",F[F.PATH_RULE_EVEN_ODD=2]="PATH_RULE_EVEN_ODD",F))(Qv||{}),eb=(F=>(F[F.LINE_CAP_UNSPECIFIED=0]="LINE_CAP_UNSPECIFIED",F[F.LINE_CAP_BUTT=1]="LINE_CAP_BUTT",F[F.LINE_CAP_ROUND=2]="LINE_CAP_ROUND",F[F.LINE_CAP_SQUARE=3]="LINE_CAP_SQUARE",F))(eb||{}),tb=(F=>(F[F.LINE_JOIN_UNSPECIFIED=0]="LINE_JOIN_UNSPECIFIED",F[F.LINE_JOIN_MITER=1]="LINE_JOIN_MITER",F[F.LINE_JOIN_MITER_CLIP=2]="LINE_JOIN_MITER_CLIP",F[F.LINE_JOIN_ROUND=3]="LINE_JOIN_ROUND",F[F.LINE_JOIN_BEVEL=4]="LINE_JOIN_BEVEL",F))(tb||{}),ib=(F=>(F[F.PAINT_ORDER_UNSPECIFIED=0]="PAINT_ORDER_UNSPECIFIED",F[F.PAINT_ORDER_FILL_AND_STROKE=1]="PAINT_ORDER_FILL_AND_STROKE",F[F.PAINT_ORDER_STROKE_AND_FILL=2]="PAINT_ORDER_STROKE_AND_FILL",F))(ib||{}),rb=(F=>(F[F.PATH_COMMAND_UNSPECIFIED=0]="PATH_COMMAND_UNSPECIFIED",F[F.PATH_COMMAND_MOVE=1]="PATH_COMMAND_MOVE",F[F.PATH_COMMAND_LINE=2]="PATH_COMMAND_LINE",F[F.PATH_COMMAND_QUAD=3]="PATH_COMMAND_QUAD",F[F.PATH_COMMAND_CUBIC=4]="PATH_COMMAND_CUBIC",F[F.PATH_COMMAND_CLOSE=5]="PATH_COMMAND_CLOSE",F))(rb||{}),nb=(F=>(F[F.MASK_TYPE_UNSPECIFIED=0]="MASK_TYPE_UNSPECIFIED",F[F.MASK_TYPE_LUMINANCE=1]="MASK_TYPE_LUMINANCE",F[F.MASK_TYPE_ALPHA=2]="MASK_TYPE_ALPHA",F))(nb||{});function Oy(F,Ae,Oe){1===F&&Ae.icons.push(function(F,Ae){return function(F){if(F.usvg_tree.height||(F.usvg_tree.height=F.usvg_tree.width),!F.metadata)return F;const{metadata:Ae}=F;if(Ae.content_area){const{content_area:Oe}=Ae;null==Oe.top&&(Oe.top=Oe.left),null==Oe.width&&(Oe.width=F.usvg_tree.width),null==Oe.height&&(Oe.height=Oe.width)}return Ae.stretch_x&&Ae.stretch_x.length&&Ny(Ae,"x"),Ae.stretch_y&&Ae.stretch_y.length&&Ny(Ae,"y"),F}(F.readFields(Uy,{name:void 0},Ae))}(Oe,Oe.readVarint()+Oe.pos))}function Ny(F,Ae){const Oe=[],Fe=F[`stretch_${Ae}`];let Ve=null;for(let F=0;F<Fe.length;F++)null===Ve?Ve=0===Oe.length?Fe[0]:Oe[Oe.length-1][1]+Fe[F]:(Oe.push([Ve,Ve+Fe[F]]),Ve=null);F[`stretch_${Ae}_areas`]=Oe}function Uy(F,Ae,Oe){1===F?Ae.name=Oe.readString():2===F?Ae.metadata=function(F,Ae){return F.readFields(jy,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},Ae)}(Oe,Oe.readVarint()+Oe.pos):3===F&&(Ae.usvg_tree=function(F,Ae){return F.readFields(Gy,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},Ae)}(Oe,Oe.readVarint()+Oe.pos),Ae.data="usvg_tree")}function jy(F,Ae,Oe){1===F?Ae.stretch_x=Oe.readPackedVarint():2===F?Ae.stretch_y=Oe.readPackedVarint():3===F?Ae.content_area=function(F,Ae){return F.readFields(qy,{left:0},Ae)}(Oe,Oe.readVarint()+Oe.pos):4===F&&Ae.variables.push(function(F,Ae){return F.readFields($y,{name:void 0},Ae)}(Oe,Oe.readVarint()+Oe.pos))}function qy(F,Ae,Oe){1===F?Ae.left=Oe.readVarint():2===F?Ae.width=Oe.readVarint():3===F?Ae.top=Oe.readVarint():4===F&&(Ae.height=Oe.readVarint())}function $y(F,Ae,Oe){1===F?Ae.name=Oe.readString():2===F&&(Ae.rgb_color=Qy(Oe.readVarint()),Ae.value="rgb_color")}function Gy(F,Ae,Oe){1===F?Ae.width=Ae.height=Oe.readVarint():2===F?Ae.height=Oe.readVarint():3===F?Ae.children.push(Yy(Oe,Oe.readVarint()+Oe.pos)):4===F?Ae.linear_gradients.push(function(F,Ae){return F.readFields(eg,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},Ae)}(Oe,Oe.readVarint()+Oe.pos)):5===F?Ae.radial_gradients.push(function(F,Ae){return F.readFields(ig,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},Ae)}(Oe,Oe.readVarint()+Oe.pos)):7===F?Ae.clip_paths.push(function(F,Ae){return F.readFields(ag,{children:[]},Ae)}(Oe,Oe.readVarint()+Oe.pos)):8===F&&Ae.masks.push(function(F,Ae){const Oe=F.readFields(sg,{left:0,width:20,mask_type:1,children:[]},Ae);return null==Oe.height&&(Oe.height=Oe.width),null==Oe.top&&(Oe.top=Oe.left),Oe}(Oe,Oe.readVarint()+Oe.pos))}function Yy(F,Ae){return F.readFields(Xy,{},Ae)}function Xy(F,Ae,Oe){1===F?(Ae.group=function(F,Ae){return F.readFields(Zy,{opacity:255,children:[]},Ae)}(Oe,Oe.readVarint()+Oe.pos),Ae.node="group"):2===F&&(Ae.path=function(F,Ae){return F.readFields(Ky,{paint_order:1,commands:[],step:1,diffs:[],rule:1},Ae)}(Oe,Oe.readVarint()+Oe.pos),Ae.node="path")}function Zy(F,Ae,Oe){1===F?Ae.transform=Hy(Oe,Oe.readVarint()+Oe.pos):2===F?Ae.opacity=Oe.readVarint():5===F?Ae.clip_path_idx=Oe.readVarint():6===F?Ae.mask_idx=Oe.readVarint():7===F&&Ae.children.push(Yy(Oe,Oe.readVarint()+Oe.pos))}function Hy(F,Ae){return F.readFields(Wy,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},Ae)}function Wy(F,Ae,Oe){1===F?Ae.sx=Oe.readFloat():2===F?Ae.ky=Oe.readFloat():3===F?Ae.kx=Oe.readFloat():4===F?Ae.sy=Oe.readFloat():5===F?Ae.tx=Oe.readFloat():6===F&&(Ae.ty=Oe.readFloat())}function Ky(F,Ae,Oe){1===F?Ae.fill=function(F,Ae){return F.readFields(Jy,{rgb_color:Jv,paint:"rgb_color",opacity:255},Ae)}(Oe,Oe.readVarint()+Oe.pos):2===F?Ae.stroke=function(F,Ae){return F.readFields(tg,{rgb_color:Jv,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},Ae)}(Oe,Oe.readVarint()+Oe.pos):3===F?Ae.paint_order=Oe.readVarint():5===F?Oe.readPackedVarint(Ae.commands):6===F?Ae.step=Oe.readFloat():7===F?Oe.readPackedSVarint(Ae.diffs):8===F&&(Ae.rule=Oe.readVarint())}function Jy(F,Ae,Oe){1===F?(Ae.rgb_color=Qy(Oe.readVarint()),Ae.paint="rgb_color"):2===F?(Ae.linear_gradient_idx=Oe.readVarint(),Ae.paint="linear_gradient_idx"):3===F?(Ae.radial_gradient_idx=Oe.readVarint(),Ae.paint="radial_gradient_idx"):5===F&&(Ae.opacity=Oe.readVarint())}function Qy(F){return new Ie((F>>16&255)/255,(F>>8&255)/255,(255&F)/255,1)}function tg(F,Ae,Oe){1===F?(Ae.rgb_color=Qy(Oe.readVarint()),Ae.paint="rgb_color"):2===F?(Ae.linear_gradient_idx=Oe.readVarint(),Ae.paint="linear_gradient_idx"):3===F?(Ae.radial_gradient_idx=Oe.readVarint(),Ae.paint="radial_gradient_idx"):5===F?Oe.readPackedFloat(Ae.dasharray):6===F?Ae.dashoffset=Oe.readFloat():7===F?Ae.miterlimit=Oe.readFloat():8===F?Ae.opacity=Oe.readVarint():9===F?Ae.width=Oe.readFloat():10===F?Ae.linecap=Oe.readVarint():11===F&&(Ae.linejoin=Oe.readVarint())}function eg(F,Ae,Oe){1===F?Ae.transform=Hy(Oe,Oe.readVarint()+Oe.pos):2===F?Ae.spread_method=Oe.readVarint():3===F?Ae.stops.push(rg(Oe,Oe.readVarint()+Oe.pos)):4===F?Ae.x1=Oe.readFloat():5===F?Ae.y1=Oe.readFloat():6===F?Ae.x2=Oe.readFloat():7===F&&(Ae.y2=Oe.readFloat())}function rg(F,Ae){return F.readFields(ng,{offset:0,opacity:255,rgb_color:Jv},Ae)}function ng(F,Ae,Oe){1===F?Ae.offset=Oe.readFloat():2===F?Ae.opacity=Oe.readVarint():3===F&&(Ae.rgb_color=Qy(Oe.readVarint()))}function ig(F,Ae,Oe){1===F?Ae.transform=Hy(Oe,Oe.readVarint()+Oe.pos):2===F?Ae.spread_method=Oe.readVarint():3===F?Ae.stops.push(rg(Oe,Oe.readVarint()+Oe.pos)):4===F?Ae.cx=Oe.readFloat():5===F?Ae.cy=Oe.readFloat():6===F?Ae.r=Oe.readFloat():7===F?Ae.fx=Oe.readFloat():8===F?Ae.fy=Oe.readFloat():9===F&&(Ae.fr=Oe.readFloat())}function ag(F,Ae,Oe){1===F?Ae.transform=Hy(Oe,Oe.readVarint()+Oe.pos):2===F?Ae.clip_path_idx=Oe.readVarint():3===F&&Ae.children.push(Yy(Oe,Oe.readVarint()+Oe.pos))}function sg(F,Ae,Oe){1===F?Ae.left=Ae.top=Oe.readFloat():2===F?Ae.width=Ae.height=Oe.readFloat():3===F?Ae.top=Oe.readFloat():4===F?Ae.height=Oe.readFloat():5===F?Ae.mask_type=Oe.readVarint():6===F?Ae.mask_idx=Oe.readVarint():7===F&&Ae.children.push(Yy(Oe,Oe.readVarint()+Oe.pos))}class og{static calculate(F,Ae){const Oe=new Map,Fe=new Map;if(0===Object.keys(F).length)return Oe;Ae.forEach((F=>{Fe.set(F.name,F.rgb_color||new Ie(0,0,0))}));for(const[Ae,Ve]of Object.entries(F))Fe.has(Ae)?Oe.set(Fe.get(Ae).toStringPremultipliedAlpha(),Ve):console.warn(`Ignoring unknown image variable "${Ae}"`);return Oe}}function lg(F,Ae=255,Oe){const Fe=Ae/255,Ve=F.toStringPremultipliedAlpha(),qe=Oe.has(Ve)?Oe.get(Ve).clone():F.clone();return qe.a=Fe,qe.toString()}function ug(F,Ae){if(!Vt()){const Oe=document.createElement("canvas");return Oe.width=F,Oe.height=Ae,Oe}return new OffscreenCanvas(F,Ae)}function cg(F,Ae){const Oe=og.calculate(Ae.params,F.metadata?F.metadata.variables:[]),Fe=F.usvg_tree,Ve=Fe.width,qe=Fe.height,pt=Ae.transform?Ae.transform:new DOMMatrix,vt=Math.max(1,Math.round(Ve*pt.a)),zt=Math.max(1,Math.round(qe*pt.d)),ri=new DOMMatrix([vt/Ve,0,0,zt/qe,0,0]),xi=ug(vt,zt).getContext("2d");return hg(xi,ri,Fe,Fe,Oe),xi.getImageData(0,0,vt,zt)}function hg(F,Ae,Oe,Fe,Ve){for(const qe of Fe.children)pg(F,Ae,Oe,qe,Ve)}function pg(F,Ae,Oe,Fe,Ve){Fe.group?(F.save(),function(F,Ae,Oe,Fe,Ve){const qe=null!=Fe.mask_idx?Oe.masks[Fe.mask_idx]:null,pt=null!=Fe.clip_path_idx?Oe.clip_paths[Fe.clip_path_idx]:null;if(Fe.transform&&(Ae=_g(Fe.transform).preMultiplySelf(Ae)),!function(F,Ae,Oe){return 255!==F.opacity||Ae||Oe}(Fe,null!=pt,null!=qe))return void hg(F,Ae,Oe,Fe,Ve);const vt=ug(F.canvas.width,F.canvas.height),zt=vt.getContext("2d");hg(zt,Ae,Oe,Fe,Ve),pt&&vg(zt,Ae,Oe,pt),qe&&bg(zt,Ae,Oe,qe,Ve),F.globalAlpha=Fe.opacity/255,F.drawImage(vt,0,0)}(F,Ae,Oe,Fe.group,Ve),F.restore()):Fe.path&&(F.save(),function(F,Ae,Oe,Fe,Ve){const qe=wg(Fe);F.setTransform(Ae),Fe.paint_order===ib.PAINT_ORDER_FILL_AND_STROKE?(fg(F,Oe,Fe,qe,Ve),mg(F,Oe,Fe,qe,Ve)):(mg(F,Oe,Fe,qe,Ve),fg(F,Oe,Fe,qe,Ve))}(F,Ae,Oe,Fe.path,Ve),F.restore())}function fg(F,Ae,Oe,Fe,Ve){const qe=Oe.fill;if(!qe)return;const pt=qe.opacity/255;switch(qe.paint){case"rgb_color":F.fillStyle=lg(qe.rgb_color,qe.opacity,Ve);break;case"linear_gradient_idx":F.fillStyle=yg(F,Ae.linear_gradients[qe.linear_gradient_idx],pt,Ve);break;case"radial_gradient_idx":F.fillStyle=gg(F,Ae.radial_gradients[qe.radial_gradient_idx],pt,Ve)}F.fill(Fe,dg(Oe))}function dg(F){return F.rule===Qv.PATH_RULE_NON_ZERO?"nonzero":F.rule===Qv.PATH_RULE_EVEN_ODD?"evenodd":void 0}function mg(F,Ae,Oe,Fe,Ve){const qe=Oe.stroke;if(!qe)return;F.lineWidth=qe.width,F.miterLimit=qe.miterlimit,F.setLineDash(qe.dasharray),F.lineDashOffset=qe.dashoffset;const pt=qe.opacity/255;switch(qe.paint){case"rgb_color":F.strokeStyle=lg(qe.rgb_color,qe.opacity,Ve);break;case"linear_gradient_idx":F.strokeStyle=yg(F,Ae.linear_gradients[qe.linear_gradient_idx],pt,Ve);break;case"radial_gradient_idx":F.strokeStyle=gg(F,Ae.radial_gradients[qe.radial_gradient_idx],pt,Ve)}switch(qe.linejoin){case tb.LINE_JOIN_MITER_CLIP:case tb.LINE_JOIN_MITER:F.lineJoin="miter";break;case tb.LINE_JOIN_ROUND:F.lineJoin="round";break;case tb.LINE_JOIN_BEVEL:F.lineJoin="bevel"}switch(qe.linecap){case eb.LINE_CAP_BUTT:F.lineCap="butt";break;case eb.LINE_CAP_ROUND:F.lineCap="round";break;case eb.LINE_CAP_SQUARE:F.lineCap="square"}F.stroke(Fe)}function yg(F,Ae,Oe,Fe){if(1===Ae.stops.length){const F=Ae.stops[0];return lg(F.rgb_color,F.opacity*Oe,Fe)}const Ve=_g(Ae.transform),{x1:qe,y1:pt,x2:vt,y2:zt}=Ae,ri=Ve.transformPoint(new DOMPoint(qe,pt)),xi=Ve.transformPoint(new DOMPoint(vt,zt)),bi=F.createLinearGradient(ri.x,ri.y,xi.x,xi.y);for(const F of Ae.stops)bi.addColorStop(F.offset,lg(F.rgb_color,F.opacity*Oe,Fe));return bi}function gg(F,Ae,Oe,Fe){if(1===Ae.stops.length){const F=Ae.stops[0];return lg(F.rgb_color,F.opacity*Oe,Fe)}const Ve=_g(Ae.transform),{fx:qe,fy:pt,cx:vt,cy:zt}=Ae,ri=Ve.transformPoint(new DOMPoint(qe,pt)),xi=Ve.transformPoint(new DOMPoint(vt,zt)),bi=F.createRadialGradient(ri.x,ri.y,0,xi.x,xi.y,Ae.r*((Ve.a+Ve.d)/2));for(const F of Ae.stops)bi.addColorStop(F.offset,lg(F.rgb_color,F.opacity*Oe,Fe));return bi}function xg(F,Ae,Oe,Fe){const Ve=Fe.transform?_g(Fe.transform).preMultiplySelf(Ae):Ae,qe=ug(F.canvas.width,F.canvas.height),pt=qe.getContext("2d");for(const F of Fe.children)if(F.group)xg(pt,Ve,Oe,F.group);else if(F.path){const Ae=F.path,Oe=new Path2D;Oe.addPath(wg(Ae),Ve),pt.fill(Oe,dg(Ae))}const vt=null!=Fe.clip_path_idx?Oe.clip_paths[Fe.clip_path_idx]:null;vt&&vg(pt,Ve,Oe,vt),F.globalCompositeOperation="source-over",F.drawImage(qe,0,0)}function vg(F,Ae,Oe,Fe){const Ve=ug(F.canvas.width,F.canvas.height);xg(Ve.getContext("2d"),Ae,Oe,Fe),F.globalCompositeOperation="destination-in",F.drawImage(Ve,0,0)}function bg(F,Ae,Oe,Fe,Ve){if(0===Fe.children.length)return;const qe=null!=Fe.mask_idx?Oe.masks[Fe.mask_idx]:null;qe&&bg(F,Ae,Oe,qe,Ve);const pt=F.canvas.width,vt=F.canvas.height,zt=ug(pt,vt),ri=zt.getContext("2d"),xi=Fe.width,bi=Fe.height,wi=Fe.left,dr=Fe.top,jr=new Path2D,Qr=new Path2D;Qr.rect(wi,dr,xi,bi),jr.addPath(Qr,Ae),ri.clip(jr);for(const F of Fe.children)pg(ri,Ae,Oe,F,Ve);const Xn=ri.getImageData(0,0,pt,vt),ho=Xn.data;if(Fe.mask_type===nb.MASK_TYPE_LUMINANCE)for(let F=0;F<ho.length;F+=4)ho[F+3]=ho[F+3]/255*(.2126*ho[F]+.7152*ho[F+1]+.0722*ho[F+2]);ri.putImageData(Xn,0,0),F.globalCompositeOperation="destination-in",F.drawImage(zt,0,0)}function _g(F){return F?new DOMMatrix([F.sx,F.ky,F.kx,F.sy,F.tx,F.ty]):new DOMMatrix}function wg(F){const Ae=new Path2D,Oe=F.step;let Fe=F.diffs[0]*Oe,Ve=F.diffs[1]*Oe;Ae.moveTo(Fe,Ve);for(let qe=0,pt=2;qe<F.commands.length;qe++)switch(F.commands[qe]){case rb.PATH_COMMAND_MOVE:Fe+=F.diffs[pt++]*Oe,Ve+=F.diffs[pt++]*Oe,Ae.moveTo(Fe,Ve);break;case rb.PATH_COMMAND_LINE:Fe+=F.diffs[pt++]*Oe,Ve+=F.diffs[pt++]*Oe,Ae.lineTo(Fe,Ve);break;case rb.PATH_COMMAND_QUAD:{const qe=Fe+F.diffs[pt++]*Oe,vt=Ve+F.diffs[pt++]*Oe;Fe=qe+F.diffs[pt++]*Oe,Ve=vt+F.diffs[pt++]*Oe,Ae.quadraticCurveTo(qe,vt,Fe,Ve);break}case rb.PATH_COMMAND_CUBIC:{const qe=Fe+F.diffs[pt++]*Oe,vt=Ve+F.diffs[pt++]*Oe,zt=qe+F.diffs[pt++]*Oe,ri=vt+F.diffs[pt++]*Oe;Fe=zt+F.diffs[pt++]*Oe,Ve=ri+F.diffs[pt++]*Oe,Ae.bezierCurveTo(qe,vt,zt,ri,Fe,Ve);break}case rb.PATH_COMMAND_CLOSE:Ae.closePath()}return Ae}class Mg{constructor(F){this.capacity=F,this.cache=new Map}get(F){if(!this.cache.has(F))return;const Ae=this.cache.get(F);return this.cache.delete(F),this.cache.set(F,Ae),Ae}put(F,Ae){this.cache.has(F)?this.cache.delete(F):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(F,Ae)}delete(F){this.cache.delete(F)}}class Ag{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(F){return new sc(F,F.data)}getFromCache(F,Ae,Oe){return this.cacheMap.has(Oe)||this.cacheMap.set(Oe,new Mg(150)),this.cacheMap.get(Oe).get(us(F.serialize(),Ae))}setInCache(F,Ae,Oe,Fe){this.cacheDependenciesMap.has(Fe)||this.cacheDependenciesMap.set(Fe,new Map),this.cacheMap.has(Fe)||this.cacheMap.set(Fe,new Mg(150));const Ve=this.cacheDependenciesMap.get(Fe);Ve.get(us(F.id,Oe))||Ve.set(us(F.id,Oe),new Set);const qe=this.cacheMap.get(Fe),pt=F.serialize();Ve.get(us(F.id,Oe)).add(pt),qe.put(us(F.serialize(),Oe),Ae)}removeImagesFromCacheByIds(F,Ae,Oe=""){if(!this.cacheMap.has(Oe)||!this.cacheDependenciesMap.has(Oe))return;const Fe=this.cacheMap.get(Oe),Ve=this.cacheDependenciesMap.get(Oe);for(const Oe of F)if(Ve.has(us(Oe,Ae))){for(const F of Ve.get(us(Oe,Ae)))Fe.delete(F);Ve.delete(us(Oe,Ae))}}rasterize(F,Ae,Oe,Fe,Ve=cg){const qe=this.getFromCache(F,Oe,Fe);if(qe)return qe.clone();const pt=Ve(Ae.icon,F.options),vt=Ag._getImage(pt);return this.setInCache(F,vt,Oe,Fe),vt.clone()}}class Sg{constructor(F){this.size=F,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(F,Ae){const Oe=this.toIdx(F,Ae);return{min:this.minimums[Oe],max:this.maximums[Oe]}}isLeaf(F,Ae){return this.leaves[this.toIdx(F,Ae)]}toIdx(F,Ae){return Ae*this.size+F}}function Ig(F,Ae,Oe,Fe){let Ve=0,qe=Number.MAX_VALUE;for(let pt=0;pt<3;pt++)if(Math.abs(Fe[pt])<1e-15){if(Oe[pt]<F[pt]||Oe[pt]>Ae[pt])return null}else{const vt=1/Fe[pt];let zt=(F[pt]-Oe[pt])*vt,ri=(Ae[pt]-Oe[pt])*vt;if(zt>ri){const F=zt;zt=ri,ri=F}if(zt>Ve&&(Ve=zt),ri<qe&&(qe=ri),Ve>qe)return null}return Ve}function Pg(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi){const bi=Fe-F,wi=Ve-Ae,dr=qe-Oe,jr=pt-F,Qr=vt-Ae,Xn=zt-Oe,ho=xi[1]*Xn-xi[2]*Qr,yo=xi[2]*jr-xi[0]*Xn,zo=xi[0]*Qr-xi[1]*jr,ko=bi*ho+wi*yo+dr*zo;if(Math.abs(ko)<1e-15)return null;const Uo=1/ko,ia=ri[0]-F,_a=ri[1]-Ae,Ma=ri[2]-Oe,Ea=(ia*ho+_a*yo+Ma*zo)*Uo;if(Ea<0||Ea>1)return null;const Ia=_a*dr-Ma*wi,rl=Ma*bi-ia*dr,Sl=ia*wi-_a*bi,Il=(xi[0]*Ia+xi[1]*rl+xi[2]*Sl)*Uo;return Il<0||Ea+Il>1?null:(jr*Ia+Qr*rl+Xn*Sl)*Uo}function zg(F,Ae,Oe){return(F-Ae)/(Oe-Ae)}function Eg(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri=1<<Oe,xi=qe-Fe,bi=pt-Ve,wi=(F+1)/ri*xi+Fe,dr=(Ae+0)/ri*bi+Ve,jr=(Ae+1)/ri*bi+Ve;vt[0]=(F+0)/ri*xi+Fe,vt[1]=dr,zt[0]=wi,zt[1]=jr}class kg{constructor(F){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=F,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const Ae=function(F){const Ae=Math.ceil(Math.log2(F.dim/8)),Oe=[];let Fe=Math.ceil(Math.pow(2,Ae));const Ve=1/Fe,a=(F,Ae,Oe,Fe,Ve)=>{const qe=Fe?1:0,pt=(F+1)*Oe-qe,vt=Ae*Oe,zt=(Ae+1)*Oe-qe;Ve[0]=F*Oe,Ve[1]=vt,Ve[2]=pt,Ve[3]=zt};let qe=new Sg(Fe);const pt=[];for(let Ae=0;Ae<Fe*Fe;Ae++){a(Ae%Fe,Math.floor(Ae/Fe),Ve,!1,pt);const Oe=Bg(pt[0],pt[1],F),vt=Bg(pt[2],pt[1],F),zt=Bg(pt[2],pt[3],F),ri=Bg(pt[0],pt[3],F);qe.minimums.push(Math.min(Oe,vt,zt,ri)),qe.maximums.push(Math.max(Oe,vt,zt,ri)),qe.leaves.push(1)}for(Oe.push(qe),Fe/=2;Fe>=1;Fe/=2){const F=Oe[Oe.length-1];qe=new Sg(Fe);for(let Ae=0;Ae<Fe*Fe;Ae++){a(Ae%Fe,Math.floor(Ae/Fe),2,!0,pt);const Oe=F.getElevation(pt[0],pt[1]),Ve=F.getElevation(pt[2],pt[1]),vt=F.getElevation(pt[2],pt[3]),zt=F.getElevation(pt[0],pt[3]),ri=F.isLeaf(pt[0],pt[1]),xi=F.isLeaf(pt[2],pt[1]),bi=F.isLeaf(pt[2],pt[3]),wi=F.isLeaf(pt[0],pt[3]),dr=Math.min(Oe.min,Ve.min,vt.min,zt.min),jr=Math.max(Oe.max,Ve.max,vt.max,zt.max),Qr=ri&&xi&&bi&&wi;qe.maximums.push(jr),qe.minimums.push(dr),qe.leaves.push(jr-dr<=5&&Qr?1:0)}Oe.push(qe)}return Oe}(this.dem),Oe=Ae.length-1,Fe=Ae[Oe];this._addNode(Fe.minimums[0],Fe.maximums[0],Fe.leaves[0]),this._construct(Ae,0,0,Oe,0)}raycastRoot(F,Ae,Oe,Fe,Ve,qe,pt=1){return Ig([F,Ae,-100],[Oe,Fe,this.maximums[0]*pt],Ve,qe)}raycast(F,Ae,Oe,Fe,Ve,qe,pt=1){if(!this.nodeCount)return null;const vt=this.raycastRoot(F,Ae,Oe,Fe,Ve,qe,pt);if(null==vt)return null;const zt=[],ri=[],xi=[],bi=[],wi=[{idx:0,t:vt,nodex:0,nodey:0,depth:0}];for(;wi.length>0;){const{idx:vt,t:dr,nodex:jr,nodey:Qr,depth:Xn}=wi.pop();if(this.leaves[vt]){Eg(jr,Qr,Xn,F,Ae,Oe,Fe,xi,bi);const vt=1<<Xn,zt=(jr+0)/vt,ri=(jr+1)/vt,wi=(Qr+0)/vt,ho=(Qr+1)/vt,yo=Bg(zt,wi,this.dem)*pt,zo=Bg(ri,wi,this.dem)*pt,ko=Bg(ri,ho,this.dem)*pt,Uo=Bg(zt,ho,this.dem)*pt,ia=Pg(xi[0],xi[1],yo,bi[0],xi[1],zo,bi[0],bi[1],ko,Ve,qe),_a=Pg(bi[0],bi[1],ko,xi[0],bi[1],Uo,xi[0],xi[1],yo,Ve,qe),Ma=Math.min(null!==ia?ia:Number.MAX_VALUE,null!==_a?_a:Number.MAX_VALUE);if(Ma!==Number.MAX_VALUE)return Ma;{const F=Sl.vec3.scaleAndAdd([],Ve,qe,dr);if(Tg(yo,zo,Uo,ko,zg(F[0],xi[0],bi[0]),zg(F[1],xi[1],bi[1]))>=F[2])return dr}continue}let ho=0;for(let wi=0;wi<this._siblingOffset.length;wi++){Eg((jr<<1)+this._siblingOffset[wi][0],(Qr<<1)+this._siblingOffset[wi][1],Xn+1,F,Ae,Oe,Fe,xi,bi),xi[2]=-100,bi[2]=this.maximums[this.childOffsets[vt]+wi]*pt;const dr=Ig(xi,bi,Ve,qe);if(null!=dr){const F=dr;zt[wi]=F;let Ae=!1;for(let Oe=0;Oe<ho&&!Ae;Oe++)F>=zt[ri[Oe]]&&(ri.splice(Oe,0,wi),Ae=!0);Ae||(ri[ho]=wi),ho++}}for(let F=0;F<ho;F++){const Ae=ri[F];wi.push({idx:this.childOffsets[vt]+Ae,t:zt[Ae],nodex:(jr<<1)+this._siblingOffset[Ae][0],nodey:(Qr<<1)+this._siblingOffset[Ae][1],depth:Xn+1})}}return null}_addNode(F,Ae,Oe){return this.minimums.push(F),this.maximums.push(Ae),this.leaves.push(Oe),this.childOffsets.push(0),this.nodeCount++}_construct(F,Ae,Oe,Fe,Ve){if(1===F[Fe].isLeaf(Ae,Oe))return;this.childOffsets[Ve]||(this.childOffsets[Ve]=this.nodeCount);const qe=Fe-1,pt=F[qe];let vt=0,zt=0;for(let F=0;F<this._siblingOffset.length;F++){const Fe=2*Ae+this._siblingOffset[F][0],Ve=2*Oe+this._siblingOffset[F][1],qe=pt.getElevation(Fe,Ve),ri=pt.isLeaf(Fe,Ve),xi=this._addNode(qe.min,qe.max,ri);ri&&(vt|=1<<F),zt||(zt=xi)}for(let Fe=0;Fe<this._siblingOffset.length;Fe++)vt&1<<Fe||this._construct(F,2*Ae+this._siblingOffset[Fe][0],2*Oe+this._siblingOffset[Fe][1],qe,zt+Fe)}}function Tg(F,Ae,Oe,Fe,Ve,qe){return ze(ze(F,Oe,qe),ze(Ae,Fe,qe),Ve)}function Bg(F,Ae,Oe){const Fe=Oe.dim,Ve=Q(F*Fe-.5,0,Fe-1),qe=Q(Ae*Fe-.5,0,Fe-1),pt=Math.floor(Ve),vt=Math.floor(qe),zt=Math.min(pt+1,Fe-1),ri=Math.min(vt+1,Fe-1);return Tg(Oe.get(pt,vt),Oe.get(zt,vt),Oe.get(pt,ri),Oe.get(zt,ri),Ve-pt,qe-vt)}const ob={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Vg(F,Ae,Oe){return(256*F*256+256*Ae+Oe)/10-1e4}function Dg(F,Ae,Oe){return 256*F+Ae+Oe/256-32768}class Lg{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(F,Ae,Oe,Fe=!1){if(this.uid=F,Ae.height!==Ae.width)throw new RangeError("DEM tiles must be square");if(Oe&&"mapbox"!==Oe&&"terrarium"!==Oe)return void ft(`"${Oe}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=Ae.height;const Ve=this.dim=Ae.height-2,qe=new Uint32Array(Ae.data.buffer);if(this.pixels=new Uint8Array(Ae.data.buffer),this.floatView=new Float32Array(Ae.data.buffer),this.borderReady=Fe,this._modifiedForSources={},!Fe){for(let F=0;F<Ve;F++)qe[this._idx(-1,F)]=qe[this._idx(0,F)],qe[this._idx(Ve,F)]=qe[this._idx(Ve-1,F)],qe[this._idx(F,-1)]=qe[this._idx(F,0)],qe[this._idx(F,Ve)]=qe[this._idx(F,Ve-1)];qe[this._idx(-1,-1)]=qe[this._idx(0,0)],qe[this._idx(Ve,-1)]=qe[this._idx(Ve-1,0)],qe[this._idx(-1,Ve)]=qe[this._idx(0,Ve-1)],qe[this._idx(Ve,Ve)]=qe[this._idx(Ve-1,Ve-1)]}const pt="terrarium"===Oe?Dg:Vg;for(let F=0;F<qe.length;++F){const Ae=4*F;this.floatView[F]=pt(this.pixels[Ae],this.pixels[Ae+1],this.pixels[Ae+2])}this._timestamp=eh.now()}_buildQuadTree(){this._tree=new kg(this)}get(F,Ae,Oe=!1){Oe&&(F=Q(F,-1,this.dim),Ae=Q(Ae,-1,this.dim));const Fe=this._idx(F,Ae);return this.floatView[Fe]}set(F,Ae,Oe){const Fe=this._idx(F,Ae),Ve=this.floatView[Fe];return this.floatView[Fe]=Oe,Oe-Ve}static getUnpackVector(F){return ob[F]}_idx(F,Ae){if(F<-1||F>=this.dim+1||Ae<-1||Ae>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(Ae+1)*this.stride+(F+1)}static pack(F,Ae){const Oe=[0,0,0,0],Fe=Lg.getUnpackVector(Ae);let Ve=Math.floor((F+Fe[3])/Fe[2]);return Oe[2]=Ve%256,Ve=Math.floor(Ve/256),Oe[1]=Ve%256,Ve=Math.floor(Ve/256),Oe[0]=Ve,Oe}getPixels(){return new oc({width:this.stride,height:this.stride},this.pixels)}backfillBorder(F,Ae,Oe){if(this.dim!==F.dim)throw new Error("dem dimension mismatch");let Fe=Ae*this.dim,Ve=Ae*this.dim+this.dim,qe=Oe*this.dim,pt=Oe*this.dim+this.dim;switch(Ae){case-1:Fe=Ve-1;break;case 1:Ve=Fe+1}switch(Oe){case-1:qe=pt-1;break;case 1:pt=qe+1}const vt=-Ae*this.dim,zt=-Oe*this.dim;for(let Ae=qe;Ae<pt;Ae++)for(let Oe=Fe;Oe<Ve;Oe++){const Fe=4*this._idx(Oe,Ae),Ve=4*this._idx(Oe+vt,Ae+zt);this.pixels[Fe+0]=F.pixels[Ve+0],this.pixels[Fe+1]=F.pixels[Ve+1],this.pixels[Fe+2]=F.pixels[Ve+2],this.pixels[Fe+3]=F.pixels[Ve+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function Rg(F,Ae,Oe){1===F?Ae.headerLength=Oe.readFixed32():2===F?Ae.x=Oe.readVarint():3===F?Ae.y=Oe.readVarint():4===F?Ae.z=Oe.readVarint():5===F&&Ae.layers.push(function(F,Ae){return F.readFields(jg,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},Ae)}(Oe,Oe.readVarint()+Oe.pos))}function Fg(F,Ae,Oe){1===F?(Ae.delta_filter=function(F,Ae){return F.readFields(Og,{blockSize:0},Ae)}(Oe,Oe.readVarint()+Oe.pos),Ae.filter="delta_filter"):2===F?(Oe.readVarint(),Ae.filter="zigzag_filter"):3===F?(Oe.readVarint(),Ae.filter="bitshuffle_filter"):4===F&&(Oe.readVarint(),Ae.filter="byteshuffle_filter")}function Og(F,Ae,Oe){1===F&&(Ae.blockSize=Oe.readVarint())}function Ng(F,Ae,Oe){1===F?(Oe.readVarint(),Ae.codec="gzip_data"):2===F?(Oe.readVarint(),Ae.codec="jpeg_image"):3===F?(Oe.readVarint(),Ae.codec="webp_image"):4===F&&(Oe.readVarint(),Ae.codec="png_image")}function Ug(F,Ae,Oe){let Fe=0,Ve=0;1===F?Ae.firstByte=Oe.readFixed64():2===F?Ae.lastByte=Oe.readFixed64():3===F?Ae.filters.push(function(F,Ae){return F.readFields(Fg,{},Ae)}(Oe,Oe.readVarint()+Oe.pos)):4===F?Ae.codec=function(F,Ae){return F.readFields(Ng,{},Ae)}(Oe,Oe.readVarint()+Oe.pos):5===F?Ve=Oe.readFloat():6===F?Fe=Oe.readFloat():7===F?Ae.bands.push(Oe.readString()):8===F?Ae.offset=Oe.readDouble():9===F&&(Ae.scale=Oe.readDouble()),0===Ae.offset&&(Ae.offset=Ve),0===Ae.scale&&(Ae.scale=Fe)}function jg(F,Ae,Oe){1===F?Ae.version=Oe.readVarint():2===F?Ae.name=Oe.readString():3===F?Ae.units=Oe.readString():4===F?Ae.tileSize=Oe.readVarint():5===F?Ae.buffer=Oe.readVarint():6===F?Ae.pixelFormat=Oe.readVarint():7===F&&Ae.dataIndex.push(function(F,Ae){return F.readFields(Ug,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},Ae)}(Oe,Oe.readVarint()+Oe.pos))}function qg(F,Ae,Oe){if(2===F)!function(F,Ae,Oe){F.readFields($g,Oe,Ae)}(Oe,Oe.readVarint()+Oe.pos,Ae);else if(3===F)throw new Error("Not implemented")}function $g(F,Ae,Oe){if(1===F){let F=0;const Fe=Oe.readVarint()+Oe.pos;for(;Oe.pos<Fe;)Ae[F++]=Oe.readVarint()}}function Gg(F,Ae){if(4!==Ae.length)throw new Error(`Expected data of dimension 4 but got ${Ae.length}.`);let Oe=Ae[3];for(let Fe=2;Fe>=1;Fe--){const Ve=1===Fe?1:0,qe=2===Fe?1:0;for(let Fe=0;Fe<Ae[0];Fe++){const pt=Ae[1]*Fe;for(let Fe=Ve;Fe<Ae[1];Fe++){const Ve=Ae[2]*(Fe+pt);for(let Fe=qe;Fe<Ae[2];Fe++){const qe=Ae[3]*(Fe+Ve);for(let Fe=0;Fe<Ae[3];Fe++){const Ae=qe+Fe;F[Ae]+=F[Ae-Oe]}}}}Oe*=Ae[Fe]}return F}function Yg(F){for(let Ae=0,Oe=F.length;Ae<Oe;Ae++)F[Ae]=F[Ae]>>>1^-(1&F[Ae]);return F}function Xg(F,Ae){switch(Ae){case"uint32":return F;case"uint16":for(let Ae=0;Ae<F.length;Ae+=2){const Oe=F[Ae],Fe=F[Ae+1];F[Ae]=(240&Oe)>>4|(61440&Oe)>>8|(240&Fe)<<4|61440&Fe,F[Ae+1]=15&Oe|(3840&Oe)>>4|(15&Fe)<<8|(3840&Fe)<<4}return F;case"uint8":for(let Ae=0;Ae<F.length;Ae+=4){const Oe=F[Ae],Fe=F[Ae+1],Ve=F[Ae+2],qe=F[Ae+3];F[Ae+0]=(192&Oe)>>6|(192&Fe)>>4|(192&Ve)>>2|192&qe,F[Ae+1]=(48&Oe)>>4|(48&Fe)>>2|48&Ve|(48&qe)<<2,F[Ae+2]=(12&Oe)>>2|12&Fe|(12&Ve)<<2|(12&qe)<<4,F[Ae+3]=3&Oe|(3&Fe)<<2|(3&Ve)<<4|(3&qe)<<6}return F;default:throw new Error(`Invalid pixel format, "${Ae}"`)}}oa(Lg,"DEMData"),oa(kg,"DemMinMaxQuadTree",{omit:["dem"]});var sb=Uint8Array,ab=Uint16Array,lb=Int32Array,cb=new sb([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),hb=new sb([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ub=new sb([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),tx=function(F,Ae){for(var Oe=new ab(31),Fe=0;Fe<31;++Fe)Oe[Fe]=Ae+=1<<F[Fe-1];var Ve=new lb(Oe[30]);for(Fe=1;Fe<30;++Fe)for(var qe=Oe[Fe];qe<Oe[Fe+1];++qe)Ve[qe]=qe-Oe[Fe]<<5|Fe;return{b:Oe,r:Ve}},db=tx(cb,2),pb=db.b,fb=db.r;pb[28]=258,fb[258]=28;for(var mb=tx(hb,0).b,_b=new ab(32768),gb=0;gb<32768;++gb){var yb=(43690&gb)>>1|(21845&gb)<<1;_b[gb]=((65280&(yb=(61680&(yb=(52428&yb)>>2|(13107&yb)<<2))>>4|(3855&yb)<<4))>>8|(255&yb)<<8)>>1}var lx=function(F,Ae,Oe){for(var Fe=F.length,Ve=0,qe=new ab(Ae);Ve<Fe;++Ve)F[Ve]&&++qe[F[Ve]-1];var pt,vt=new ab(Ae);for(Ve=1;Ve<Ae;++Ve)vt[Ve]=vt[Ve-1]+qe[Ve-1]<<1;pt=new ab(1<<Ae);var zt=15-Ae;for(Ve=0;Ve<Fe;++Ve)if(F[Ve])for(var ri=Ve<<4|F[Ve],xi=Ae-F[Ve],bi=vt[F[Ve]-1]++<<xi,wi=bi|(1<<xi)-1;bi<=wi;++bi)pt[_b[bi]>>zt]=ri;return pt},xb=new sb(288);for(gb=0;gb<144;++gb)xb[gb]=8;for(gb=144;gb<256;++gb)xb[gb]=9;for(gb=256;gb<280;++gb)xb[gb]=7;for(gb=280;gb<288;++gb)xb[gb]=8;var vb=new sb(32);for(gb=0;gb<32;++gb)vb[gb]=5;var bb=lx(xb,9),wb=lx(vb,5),fx=function(F){for(var Ae=F[0],Oe=1;Oe<F.length;++Oe)F[Oe]>Ae&&(Ae=F[Oe]);return Ae},dx=function(F,Ae,Oe){var Fe=Ae/8|0;return(F[Fe]|F[Fe+1]<<8)>>(7&Ae)&Oe},mx=function(F,Ae){var Oe=Ae/8|0;return(F[Oe]|F[Oe+1]<<8|F[Oe+2]<<16)>>(7&Ae)},Tb=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],gx=function(F,Ae,Oe){var Fe=new Error(Ae||Tb[F]);if(Fe.code=F,Error.captureStackTrace&&Error.captureStackTrace(Fe,gx),!Oe)throw Fe;return Fe},Sb=new sb(0),Mb="undefined"!=typeof TextDecoder&&new TextDecoder;try{Mb.decode(Sb,{stream:!0})}catch(Ae){}const Eb={gzip_data:"gzip"};class _x extends Error{constructor(F){super(F),this.name="MRTError"}}const Ib={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},Ab={uint32:1,uint16:2,uint8:4},Cb={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let Pb;class Ix{constructor(F=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=F}getLayer(F){const Ae=this.layers[F];if(!Ae)throw new _x(`Layer '${F}' not found`);return Ae}getHeaderLength(F){const Ae=new Uint8Array(F),Oe=new DataView(F);if(13!==Ae[0])throw new _x("File is not a valid MRT.");return Oe.getUint32(1,!0)}parseHeader(F){const Ae=new Uint8Array(F),Oe=this.getHeaderLength(F);if(Ae.length<Oe)throw new _x(`Expected header with length >= ${Oe} but got buffer of length ${Ae.length}`);const Fe=function(F){return F.readFields(Rg,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new Pb(Ae.subarray(0,Oe)));if(!isNaN(this.x)&&(this.x!==Fe.x||this.y!==Fe.y||this.z!==Fe.z))throw new _x(`Invalid attempt to parse header ${Fe.z}/${Fe.x}/${Fe.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=Fe.x,this.y=Fe.y,this.z=Fe.z;for(const F of Fe.layers)this.layers[F.name]=new Px(F,{cacheSize:this._cacheSize});return this}createDecodingTask(F){const Ae=[],Oe=this.getLayer(F.layerName);for(let Fe of F.blockIndices){const Ve=Oe.dataIndex[Fe],qe=Ve.firstByte-F.firstByte,pt=Ve.lastByte-F.firstByte;if(Oe._blocksInProgress.has(Fe))continue;const vt={layerName:Oe.name,firstByte:qe,lastByte:pt,pixelFormat:Oe.pixelFormat,blockIndex:Fe,blockShape:[Ve.bands.length].concat(Oe.bandShape),buffer:Oe.buffer,codec:Ve.codec.codec,filters:Ve.filters.map((F=>F.filter))};Oe._blocksInProgress.add(Fe),Ae.push(vt)}return new zx(Ae,(()=>{Ae.forEach((F=>Oe._blocksInProgress.delete(F.blockIndex)))}),((F,Fe)=>{if(Ae.forEach((F=>Oe._blocksInProgress.delete(F.blockIndex))),F)throw F;Fe.forEach((F=>{this.getLayer(F.layerName).processDecodedData(F)}))}))}}class Px{constructor({version:F,name:Ae,units:Oe,tileSize:Fe,pixelFormat:Ve,buffer:qe,dataIndex:pt},vt){if(this.version=F,1!==this.version)throw new _x(`Cannot parse raster layer encoded with MRT version ${F}`);this.name=Ae,this.units=Oe,this.tileSize=Fe,this.buffer=qe,this.pixelFormat=Ib[Ve],this.dataIndex=pt,this.bandShape=[Fe+2*qe,Fe+2*qe,Ab[this.pixelFormat]],this._decodedBlocks=new Mg(vt?vt.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return Ab[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:F})=>F)).flat()}processDecodedData(F){const Ae=F.blockIndex.toString();this._decodedBlocks.get(Ae)||this._decodedBlocks.put(Ae,F.data)}getBlockForBand(F){let Ae=0;switch(typeof F){case"string":for(const[Oe,Fe]of this.dataIndex.entries()){for(const[Ve,qe]of Fe.bands.entries())if(qe===F)return{bandIndex:Ae+Ve,blockIndex:Oe,blockBandIndex:Ve};Ae+=Fe.bands.length}break;case"number":for(const[Oe,Fe]of this.dataIndex.entries()){if(F>=Ae&&F<Ae+Fe.bands.length)return{bandIndex:F,blockIndex:Oe,blockBandIndex:F-Ae};Ae+=Fe.bands.length}break;default:throw new _x(`Invalid band \`${JSON.stringify(F)}\`. Expected string or integer.`)}throw new _x(`Band not found: ${JSON.stringify(F)}`)}getDataRange(F){let Ae=1/0,Oe=-1/0;const Fe=[],Ve=new Set;for(const qe of F){const{blockIndex:F}=this.getBlockForBand(qe);if(F<0)throw new _x(`Invalid band: ${JSON.stringify(qe)}`);const pt=this.dataIndex[F];Fe.includes(F)||Fe.push(F),Ve.add(F),Ae=Math.min(Ae,pt.firstByte),Oe=Math.max(Oe,pt.lastByte)}if(Ve.size>this.cacheSize)throw new _x(`Number of blocks to decode (${Ve.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:Ae,lastByte:Oe,blockIndices:Fe}}hasBand(F){const{blockIndex:Ae}=this.getBlockForBand(F);return Ae>=0}hasDataForBand(F){const{blockIndex:Ae}=this.getBlockForBand(F);return Ae>=0&&!!this._decodedBlocks.get(Ae.toString())}getBandView(F){const{blockIndex:Ae,blockBandIndex:Oe}=this.getBlockForBand(F),Fe=this._decodedBlocks.get(Ae.toString());if(!Fe)throw new _x(`Data for band ${JSON.stringify(F)} of layer "${this.name}" not decoded.`);const Ve=this.dataIndex[Ae],qe=this.bandShape.reduce(((F,Ae)=>F*Ae),1),pt=Oe*qe,vt=Fe.subarray(pt,pt+qe);return{data:vt,bytes:new Uint8Array(vt.buffer).subarray(vt.byteOffset,vt.byteOffset+vt.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:Ve.offset,scale:Ve.scale}}}Ix.setPbf=function(F){Pb=F};class zx{constructor(F,Ae,Oe){this.tasks=F,this._onCancel=Ae,this._onComplete=Oe,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(F,Ae){this._finalized||(this._onComplete(F,Ae),this._finalized=!0)}}Ix.performDecoding=function(F,Ae){const Oe=new Uint8Array(F);return Promise.all(Ae.tasks.map((F=>{const{layerName:Ae,firstByte:Fe,lastByte:Ve,pixelFormat:qe,blockShape:pt,blockIndex:vt,filters:zt,codec:ri}=F,xi=Oe.subarray(Fe,Ve+1),bi=new Uint32Array(pt[0]*pt[1]*pt[2]);let wi;if("gzip_data"!==ri)throw new _x(`Unhandled codec: ${ri}`);return wi=function(F,Ae){if(!globalThis.DecompressionStream&&"gzip_data"===Ae)return Promise.resolve(((qe=function(F){31==F[0]&&139==F[1]&&8==F[2]||gx(6,"invalid gzip data");var Ae=F[3],Oe=10;4&Ae&&(Oe+=2+(F[10]|F[11]<<8));for(var Fe=(Ae>>3&1)+(Ae>>4&1);Fe>0;Fe-=!F[Oe++]);return Oe+(2&Ae)}(Ve=F))+8>Ve.length&&gx(6,"invalid gzip data"),function(F,Ae,Oe){var Fe=F.length;if(!Fe||Ae.f&&!Ae.l)return Oe||new sb(0);var Ve=!Oe,qe=Ve||2!=Ae.i,pt=Ae.i;Ve&&(Oe=new sb(3*Fe));var vt,zt,c=function(F){var Ae=Oe.length;if(F>Ae){var Fe=new sb(Math.max(2*Ae,F));Fe.set(Oe),Oe=Fe}},ri=Ae.f||0,xi=Ae.p||0,bi=Ae.b||0,wi=Ae.l,dr=Ae.d,jr=Ae.m,Qr=Ae.n,Xn=8*Fe;do{if(!wi){ri=dx(F,xi,1);var ho=dx(F,xi+1,3);if(xi+=3,!ho){var yo=F[(Il=4+((xi+7)/8|0))-4]|F[Il-3]<<8,zo=Il+yo;if(zo>Fe){pt&&gx(0);break}qe&&c(bi+yo),Oe.set(F.subarray(Il,zo),bi),Ae.b=bi+=yo,Ae.p=xi=8*zo,Ae.f=ri;continue}if(1==ho)wi=bb,dr=wb,jr=9,Qr=5;else if(2==ho){var ko=dx(F,xi,31)+257,Uo=dx(F,xi+10,15)+4,ia=ko+dx(F,xi+5,31)+1;xi+=14;for(var _a=new sb(ia),Ma=new sb(19),Ea=0;Ea<Uo;++Ea)Ma[ub[Ea]]=dx(F,xi+3*Ea,7);xi+=3*Uo;var Ia=fx(Ma),rl=(1<<Ia)-1,Sl=lx(Ma,Ia);for(Ea=0;Ea<ia;){var Il,Kl=Sl[dx(F,xi,rl)];if(xi+=15&Kl,(Il=Kl>>4)<16)_a[Ea++]=Il;else{var Jl=0,Ql=0;for(16==Il?(Ql=3+dx(F,xi,3),xi+=2,Jl=_a[Ea-1]):17==Il?(Ql=3+dx(F,xi,7),xi+=3):18==Il&&(Ql=11+dx(F,xi,127),xi+=7);Ql--;)_a[Ea++]=Jl}}var ec=_a.subarray(0,ko),tc=_a.subarray(ko);jr=fx(ec),Qr=fx(tc),wi=lx(ec,jr),dr=lx(tc,Qr)}else gx(1);if(xi>Xn){pt&&gx(0);break}}qe&&c(bi+131072);for(var cc=(1<<jr)-1,uc=(1<<Qr)-1,jc=xi;;jc=xi){var Gc=(Jl=wi[mx(F,xi)&cc])>>4;if((xi+=15&Jl)>Xn){pt&&gx(0);break}if(Jl||gx(2),Gc<256)Oe[bi++]=Gc;else{if(256==Gc){jc=xi,wi=null;break}var qc=Gc-254;Gc>264&&(qc=dx(F,xi,(1<<(Wc=cb[Ea=Gc-257]))-1)+pb[Ea],xi+=Wc);var $c=dr[mx(F,xi)&uc],Hc=$c>>4;if($c||gx(3),xi+=15&$c,tc=mb[Hc],Hc>3){var Wc=hb[Hc];tc+=mx(F,xi)&(1<<Wc)-1,xi+=Wc}if(xi>Xn){pt&&gx(0);break}qe&&c(bi+131072);var Kc=bi+qc;if(bi<tc){var Jc=0-tc,Qc=Math.min(tc,Kc);for(Jc+bi<0&&gx(3);bi<Qc;++bi)Oe[bi]=(void 0)[Jc+bi]}for(;bi<Kc;++bi)Oe[bi]=Oe[bi-tc]}}Ae.l=wi,Ae.p=jc,Ae.b=bi,Ae.f=ri,wi&&(ri=1,Ae.m=jr,Ae.d=dr,Ae.n=Qr)}while(!ri);return bi!=Oe.length&&Ve?(vt=Oe,(null==(zt=bi)||zt>vt.length)&&(zt=vt.length),new sb(vt.subarray(0,zt))):Oe.subarray(0,bi)}(Ve.subarray(qe,-8),{i:2},new sb(((Oe=Ve)[(Fe=Oe.length)-4]|Oe[Fe-3]<<8|Oe[Fe-2]<<16|Oe[Fe-1]<<24)>>>0))));var Oe,Fe,Ve,qe;const pt=Eb[Ae];if(!pt)throw new Error(`Unhandled codec: ${Ae}`);const vt=new globalThis.DecompressionStream(pt);return new Response(new Blob([F]).stream().pipeThrough(vt)).arrayBuffer().then((F=>new Uint8Array(F)))}(xi,ri).then((F=>(function(F,Ae){F.readFields(qg,Ae)}(new Pb(F),bi),new(0,Cb[qe])(bi.buffer)))),wi.then((F=>{for(let Ae=zt.length-1;Ae>=0;Ae--)switch(zt[Ae]){case"delta_filter":Gg(F,pt);break;case"zigzag_filter":Yg(F);break;case"bitshuffle_filter":Xg(F,qe);break;default:throw new _x(`Unhandled filter "${zt[Ae]}"`)}return{layerName:Ae,blockIndex:vt,data:F}})).catch((F=>{throw F}))})))},oa(zx,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});let zb,Db,Rb,Lb,kb,Ob=null;function Dx(){return gt()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:Db||qc.DRACO_URL}function Lx(){if(gt()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Lb)return Lb;const F=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Lb=WebAssembly.validate(F)?qc.MESHOPT_SIMD_URL:qc.MESHOPT_URL,Lb}const Fb={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Bb={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Nb={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Nx(F,Ae,Oe){const Fe=Oe.json.bufferViews.length,Ve=Oe.buffers.length;Ae.bufferView=Fe,Oe.json.bufferViews[Fe]={buffer:Ve,byteLength:F.byteLength},Oe.buffers[Ve]=F}const Vb="KHR_draco_mesh_compression";function jx(F,Ae){const Oe=F.extensions&&F.extensions[Vb];if(!Oe)return;const Fe=new Rb.Decoder,Ve=Hx(Ae,Oe.bufferView),qe=new Rb.Mesh;if(!Fe.DecodeArrayToMesh(Ve,Ve.byteLength,qe))throw new Error("Failed to decode Draco mesh");const pt=Ae.json.accessors[F.indices],vt=Fb[pt.componentType],zt=pt.count*vt.BYTES_PER_ELEMENT,ri=Rb._malloc(zt);vt===Uint16Array?Fe.GetTrianglesUInt16Array(qe,zt,ri):Fe.GetTrianglesUInt32Array(qe,zt,ri),Nx(Rb.memory.buffer.slice(ri,ri+zt),pt,Ae),Rb._free(ri);for(const Ve of Object.keys(Oe.attributes)){const pt=Fe.GetAttributeByUniqueId(qe,Oe.attributes[Ve]),vt=Ae.json.accessors[F.attributes[Ve]],zt=Bb[vt.componentType],ri=vt.count*Nb[vt.type]*Fb[vt.componentType].BYTES_PER_ELEMENT,xi=Rb._malloc(ri);Fe.GetAttributeDataArrayForAllPoints(qe,pt,Rb[zt],ri,xi),Nx(Rb.memory.buffer.slice(xi,xi+ri),vt,Ae),Rb._free(xi)}Fe.destroy(),qe.destroy(),delete F.extensions[Vb]}const Ub="EXT_meshopt_compression";function $x(F,Ae){if(!F.extensions||!F.extensions[Ub])return;const Oe=F.extensions[Ub],Fe=new Uint8Array(Ae.buffers[Oe.buffer],Oe.byteOffset||0,Oe.byteLength||0),Ve=new Uint8Array(Oe.count*Oe.byteStride);kb.decodeGltfBuffer(Ve,Oe.count,Oe.byteStride,Fe,Oe.mode,Oe.filter),F.buffer=Ae.buffers.length,F.byteOffset=0,Ae.buffers[F.buffer]=Ve.buffer,delete F.extensions[Ub]}const jb=1179937895,Gb=new TextDecoder("utf8");function Xx(F,Ae){return new URL(F,Ae).href}function Zx(F,Ae,Oe,Fe){return fetch(Xx(F.uri,Fe)).then((F=>F.arrayBuffer())).then((F=>{Ae.buffers[Oe]=F}))}function Hx(F,Ae){const Oe=F.json.bufferViews[Ae];return new Uint8Array(F.buffers[Oe.buffer],Oe.byteOffset||0,Oe.byteLength)}function Wx(F,Ae,Oe,Fe){if(F.uri){const Ve=Xx(F.uri,Fe);return fetch(Ve).then((F=>F.blob())).then((F=>createImageBitmap(F))).then((F=>{Ae.images[Oe]=F}))}if(void 0!==F.bufferView){const Fe=Hx(Ae,F.bufferView),Ve=new Blob([Fe],{type:F.mimeType});return createImageBitmap(Ve).then((F=>{Ae.images[Oe]=F}))}}function Kx(F,Ae=0,Oe){const Fe={json:null,images:[],buffers:[]};if(new Uint32Array(F,Ae,1)[0]===jb){const Oe=new Uint32Array(F,Ae);let Ve=2;const qe=(Oe[Ve++]>>2)-3,pt=Oe[Ve++]>>2;if(Ve++,Fe.json=JSON.parse(Gb.decode(Oe.subarray(Ve,Ve+pt))),Ve+=pt,Ve<qe){const qe=Oe[Ve++];Ve++;const pt=Ae+(Ve<<2);Fe.buffers[0]=F.slice(pt,pt+qe)}}else Fe.json=JSON.parse(Gb.decode(new Uint8Array(F,Ae)));const{buffers:Ve,images:qe,meshes:pt,extensionsUsed:vt,bufferViews:zt}=Fe.json;let ri=Promise.resolve();if(Ve){const F=[];for(let Ae=0;Ae<Ve.length;Ae++){const qe=Ve[Ae];qe.uri?F.push(Zx(qe,Fe,Ae,Oe)):Fe.buffers[Ae]||(Fe.buffers[Ae]=null)}ri=Promise.all(F)}return ri.then((()=>{const F=[],Ae=vt&&vt.includes(Vb),Ve=vt&&vt.includes(Ub);if(Ae&&F.push(function(){if(!Rb)return null!=zb?zb:(zb=function(F){let Ae,Oe=null;function n(){Ae=new Uint8Array(Oe.buffer)}function i(){throw new Error("Unexpected Draco error.")}const Fe={a:{a:i,d:function(F,Oe,Fe){return Ae.copyWithin(F,Oe,Oe+Fe)},c:function(F){const Fe=Ae.length,Ve=Math.max(F>>>0,Math.ceil(1.2*Fe)),qe=Math.ceil((Ve-Fe)/65536);try{return Oe.grow(qe),n(),!0}catch(F){return!1}},b:i}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(F,Fe):F.then((F=>F.arrayBuffer())).then((F=>WebAssembly.instantiate(F,Fe)))).then((F=>{const{Rb:Fe,Qb:Ve,P:qe,T:pt,X:vt,Ja:zt,La:ri,Qa:xi,Va:bi,Wa:wi,eb:dr,jb:jr,f:Qr,e:Xn,yb:ho,zb:yo,Ab:zo,Bb:ko,Db:Uo,Gb:ia}=F.instance.exports;Oe=Xn;const _a=(()=>{let F=0,Oe=0,qe=0,pt=0;return vt=>{qe&&(Fe(pt),Fe(F),Oe+=qe,qe=F=0),F||(Oe+=128,F=Ve(Oe));const zt=vt.length+7&-8;let ri=F;zt>=Oe&&(qe=zt,ri=pt=Ve(zt));for(let F=0;F<vt.length;F++)Ae[ri+F]=vt[F];return ri}})();return n(),Qr(),{memory:Xn,_free:Fe,_malloc:Ve,Mesh:class{constructor(){this.ptr=qe()}destroy(){pt(this.ptr)}},Decoder:class{constructor(){this.ptr=zt()}destroy(){jr(this.ptr)}DecodeArrayToMesh(F,Ae,Oe){const Fe=_a(F),Ve=ri(this.ptr,Fe,Ae,Oe.ptr);return!!vt(Ve)}GetAttributeByUniqueId(F,Ae){return{ptr:xi(this.ptr,F.ptr,Ae)}}GetTrianglesUInt16Array(F,Ae,Oe){bi(this.ptr,F.ptr,Ae,Oe)}GetTrianglesUInt32Array(F,Ae,Oe){wi(this.ptr,F.ptr,Ae,Oe)}GetAttributeDataArrayForAllPoints(F,Ae,Oe,Fe,Ve){dr(this.ptr,F.ptr,Ae.ptr,Oe,Fe,Ve)}},DT_INT8:ho(),DT_UINT8:yo(),DT_INT16:zo(),DT_UINT16:ko(),DT_UINT32:Uo(),DT_FLOAT32:ia()}}))}(fetch(Dx())),zb.then((F=>{Rb=F,zb=void 0})))}()),Ve&&F.push(function(){if(kb)return;const F=function(F){let Ae;const Oe=WebAssembly.instantiateStreaming(F,{}).then((F=>{Ae=F.instance,Ae.exports.__wasm_call_ctors()})),Fe={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},Ve={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:Oe,supported:!0,decodeGltfBuffer(F,Oe,qe,pt,vt,zt){!function(F,Ae,Oe,Fe,Ve,qe,pt){const vt=F.exports.sbrk,zt=Fe+3&-4,ri=vt(zt*Ve),xi=vt(qe.length),bi=new Uint8Array(F.exports.memory.buffer);bi.set(qe,xi);const wi=Ae(ri,Fe,Ve,xi,qe.length);if(0===wi&&pt&&pt(ri,zt,Ve),Oe.set(bi.subarray(ri,ri+Fe*Ve)),vt(ri-vt(0)),0!==wi)throw new Error(`Malformed buffer data: ${wi}`)}(Ae,Ae.exports[Ve[vt]],F,Oe,qe,pt,Ae.exports[Fe[zt]])}}}(fetch(Lx()));return F.ready.then((()=>{kb=F}))}()),qe)for(let Ae=0;Ae<qe.length;Ae++)F.push(Wx(qe[Ae],Fe,Ae,Oe));return(F.length?Promise.all(F):Promise.resolve()).then((()=>{if(Ae&&pt)for(const{primitives:F}of pt)for(const Ae of F)jx(Ae,Fe);if(Ve&&pt&&zt)for(const F of zt)$x(F,Fe);return Fe}))}))}function Jx(F,Ae){const Oe=F.json.bufferViews[Ae.bufferView],Fe=Fb[Ae.componentType];return new Fe(F.buffers[Oe.buffer],(Ae.byteOffset||0)+(Oe.byteOffset||0),Ae.count*(Oe.byteStride&&Oe.byteStride!==Nb[Ae.type]*Fe.BYTES_PER_ELEMENT?Oe.byteStride/Fe.BYTES_PER_ELEMENT:Nb[Ae.type]))}function Qx(F,Ae,Oe,Fe){const Ve=Fb[Ae.componentType],qe=function(F){switch(F){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(Ve),pt=F.json.bufferViews[Ae.bufferView],vt=pt.byteStride?pt.byteStride/Ve.BYTES_PER_ELEMENT:Nb[Ae.type],zt=Oe.float32,ri=zt.length/Oe.capacity;for(let F=0,Oe=0;F<Ae.count*vt;F+=vt,Oe+=ri)for(let Ae=0;Ae<ri;Ae++)zt[Oe+Ae]=Fe[F+Ae]*qe;Oe._trim()}function tv(F,Ae,Oe){const Fe=F.indices,Ve=F.attributes,qe={};qe.indexArray=new Ls;const pt=Ae.json.accessors[Fe],vt=pt.count/3;qe.indexArray.reserve(vt);const zt=Jx(Ae,pt);for(let F=0;F<vt;F++)qe.indexArray.emplaceBack(zt[3*F],zt[3*F+1],zt[3*F+2]);qe.indexArray._trim(),qe.vertexArray=new Ms;const ri=Ae.json.accessors[Ve.POSITION];qe.vertexArray.reserve(ri.count);const xi=Jx(Ae,ri);for(let F=0;F<ri.count;F++)qe.vertexArray.emplaceBack(xi[3*F],xi[3*F+1],xi[3*F+2]);if(qe.vertexArray._trim(),qe.aabb=new xu(ri.min,ri.max),qe.centroid=function(F,Ae){const Oe=[0,0,0],Fe=F.length;if(Fe>0){for(let Ve=0;Ve<Fe;Ve++){const Fe=3*F[Ve];Oe[0]+=Ae[Fe],Oe[1]+=Ae[Fe+1],Oe[2]+=Ae[Fe+2]}Oe[0]/=Fe,Oe[1]/=Fe,Oe[2]/=Fe}return Oe}(zt,xi),void 0!==Ve.COLOR_0){const F=Ae.json.accessors[Ve.COLOR_0],Oe=Nb[F.type],Fe=Jx(Ae,F);qe.colorArray=3===Oe?new Ms:new Es,qe.colorArray.resize(F.count),Qx(Ae,F,qe.colorArray,Fe)}if(void 0!==Ve.NORMAL){qe.normalArray=new Ms;const F=Ae.json.accessors[Ve.NORMAL];qe.normalArray.resize(F.count);const Oe=Jx(Ae,F);Qx(Ae,F,qe.normalArray,Oe)}if(void 0!==Ve.TEXCOORD_0&&Oe.length>0){qe.texcoordArray=new $s;const F=Ae.json.accessors[Ve.TEXCOORD_0];qe.texcoordArray.resize(F.count);const Oe=Jx(Ae,F);Qx(Ae,F,qe.texcoordArray,Oe)}if(void 0!==Ve._FEATURE_ID_RGBA4444){const F=Ae.json.accessors[Ve._FEATURE_ID_RGBA4444];Ae.json.extensionsUsed&&Ae.json.extensionsUsed.includes("EXT_meshopt_compression")&&(qe.featureData=Jx(Ae,F))}void 0!==Ve._FEATURE_RGBA4444&&(qe.featureData=new Uint32Array(Jx(Ae,Ae.json.accessors[Ve._FEATURE_RGBA4444]).buffer));const bi=F.material;return qe.material=function(F,Ae){const{emissiveFactor:Oe=[0,0,0],alphaMode:Fe="OPAQUE",alphaCutoff:Ve=.5,normalTexture:qe,occlusionTexture:pt,emissiveTexture:vt,doubleSided:zt}=F,{baseColorFactor:ri=[1,1,1,1],metallicFactor:xi=1,roughnessFactor:bi=1,baseColorTexture:wi,metallicRoughnessTexture:dr}=F.pbrMetallicRoughness||{},jr=pt?Ae[pt.index]:void 0;if(pt&&pt.extensions&&pt.extensions.KHR_texture_transform&&jr){const F=pt.extensions.KHR_texture_transform;jr.offsetScale=[F.offset[0],F.offset[1],F.scale[0],F.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Ie(...ri),metallicFactor:xi,roughnessFactor:bi,baseColorTexture:wi?Ae[wi.index]:void 0,metallicRoughnessTexture:dr?Ae[dr.index]:void 0},doubleSided:zt,emissiveFactor:Oe,alphaMode:Fe,alphaCutoff:Ve,normalTexture:qe?Ae[qe.index]:void 0,occlusionTexture:jr,emissionTexture:vt?Ae[vt.index]:void 0,defined:void 0===F.defined}}(void 0!==bi?Ae.json.materials[bi]:{defined:!1},Oe),qe}function ev(F,Ae,Oe){const{matrix:Fe,rotation:Ve,translation:qe,scale:pt,mesh:vt,extras:zt,children:ri}=F,xi={};if(xi.matrix=Fe||Sl.mat4.fromRotationTranslationScale([],Ve||[0,0,0,1],qe||[0,0,0],pt||[1,1,1]),void 0!==vt){xi.meshes=Oe[vt];const F=xi.anchor=[0,0];for(const Ae of xi.meshes){const{min:Oe,max:Fe}=Ae.aabb;F[0]+=Oe[0]+Fe[0],F[1]+=Oe[1]+Fe[1]}F[0]=Math.floor(F[0]/xi.meshes.length/2),F[1]=Math.floor(F[1]/xi.meshes.length/2)}if(zt&&(zt.id&&(xi.id=zt.id),zt.lights&&(xi.lights=function(F){if(!F.length)return[];const Ae=function(F){const Ae=atob(F),Oe=new Uint8Array(Ae.length);for(let F=0;F<Ae.length;F++)Oe[F]=Ae.codePointAt(F);return Oe}(F),Oe=[],Fe=Ae.length/24,Ve=new Uint16Array(Ae.buffer),qe=new Float32Array(Ae.buffer);for(let F=0;F<Fe;F++){const Ae=Ve[2*F*6]/30,Fe=Ve[2*F*6+1]/30,pt=Ve[2*F*6+10]/100,vt=qe[6*F+1],zt=qe[6*F+2],ri=qe[6*F+3],xi=qe[6*F+4],bi=ri-vt,wi=xi-zt,dr=Math.hypot(bi,wi);Oe.push({pos:[vt+.5*bi,zt+.5*wi,Fe],normal:[wi/dr,-bi/dr,0],width:dr,height:Ae,depth:pt,points:[vt,zt,ri,xi]})}return Oe}(zt.lights))),ri){const F=[];for(const Fe of ri)F.push(ev(Ae.json.nodes[Fe],Ae,Oe));xi.children=F}return xi}function rv(F){if(0===F.vertices.length||0===F.indices.length)return null;const Ae=new Yc(F.vertices,F.indices,8,256),[Oe,Fe]=[Ae.min.clone(),Ae.max.clone()];return{vertices:F.vertices,indices:F.indices,grid:Ae,min:Oe,max:Fe}}function nv(F){if(!F.extras||!F.extras.ground)return null;const Ae=F.extras.ground;if(!Ae||!Array.isArray(Ae)||0===Ae.length)return null;const Oe=Ae[0];if(!Oe||!Array.isArray(Oe)||0===Oe.length)return null;const Fe=[];for(const F of Oe){if(!Array.isArray(F)||2!==F.length)continue;const Ae=F[0],Oe=F[1];"number"==typeof Ae&&"number"==typeof Oe&&Fe.push(new Jl(Ae,Oe))}if(Fe.length<3)return null;Fe.length>1&&Fe[Fe.length-1].equals(Fe[0])&&Fe.pop();let Ve=0;for(let F=0;F<Fe.length;F++){const Ae=Fe[F],Oe=Fe[(F+1)%Fe.length],qe=Fe[(F+2)%Fe.length];Ve+=(Ae.x-Oe.x)*(qe.y-Oe.y)-(qe.x-Oe.x)*(Ae.y-Oe.y)}Ve>0&&Fe.reverse();const qe=hc(Fe.flatMap((F=>[F.x,F.y])),[]);return 0===qe.length?null:{vertices:Fe,indices:qe}}function iv(F,Ae){const Oe=[],Fe=[];let Ve=0;const qe=[];for(const pt of F){Ve=Oe.length;const F=pt.vertexArray.float32,vt=pt.indexArray.uint16;for(let Fe=0;Fe<pt.vertexArray.length;Fe++)qe[0]=F[3*Fe+0],qe[1]=F[3*Fe+1],qe[2]=F[3*Fe+2],Sl.vec3.transformMat4(qe,qe,Ae),Oe.push(new Jl(qe[0],qe[1]));for(let F=0;F<3*pt.indexArray.length;F++)Fe.push(vt[F]+Ve)}if(Fe.length%3!=0)return null;for(let F=0;F<Fe.length;F+=3){const Ae=Oe[Fe[F+0]],Ve=Oe[Fe[F+1]],qe=Oe[Fe[F+2]];(Ae.x-Ve.x)*(qe.y-Ve.y)-(qe.x-Ve.x)*(Ae.y-Ve.y)>0&&([Fe[F+1],Fe[F+2]]=[Fe[F+2],Fe[F+1]])}return{vertices:Oe,indices:Fe}}function av(F){const Ae=function(F,Ae){const Oe=[],Fe=WebGL2RenderingContext;if(F.json.textures)for(const Ve of F.json.textures){const qe={magFilter:Fe.LINEAR,minFilter:Fe.NEAREST,wrapS:Fe.REPEAT,wrapT:Fe.REPEAT};void 0!==Ve.sampler&&Object.assign(qe,F.json.samplers[Ve.sampler]),Oe.push({image:Ae[Ve.source],sampler:qe,uploaded:!1})}return Oe}(F,F.images),Oe=function(F,Ae){const Oe=[];for(const Fe of F.json.meshes){const Ve=[];for(const Oe of Fe.primitives)Ve.push(tv(Oe,F,Ae));Oe.push(Ve)}return Oe}(F,Ae),{scenes:Fe,scene:Ve,nodes:qe}=F.json,pt=Fe?Fe[Ve||0].nodes:qe,vt=[];for(const Ae of pt)vt.push(ev(qe[Ae],F,Oe));return function(F,Ae,Oe){const Fe={},Ve=new Set;for(let qe=0;qe<F.length;qe++){const F=Oe[Ae[qe]];if(!F.extras)continue;const pt=F.extras["mapbox:footprint:version"],vt=F.extras["mapbox:footprint:id"];(pt||vt)&&Ve.add(qe),"1.0.0"===pt&&vt&&(Fe[vt]=qe)}for(let qe=0;qe<F.length;qe++){if(Ve.has(qe))continue;const pt=F[qe],vt=Oe[Ae[qe]];if(!vt.extras)continue;let zt=null;pt.id in Fe&&(zt=iv(F[Fe[pt.id]].meshes,pt.matrix)),zt||(zt=nv(vt)),zt&&(pt.footprint=rv(zt))}if(Ve.size>0){const Ae=Array.from(Ve.values()).sort(((F,Ae)=>F-Ae));for(let Oe=Ae.length-1;Oe>=0;Oe--)F.splice(Ae[Oe],1)}}(vt,pt,F.json.nodes),vt}function sv(F){F.heightmap=new Float32Array(4096),F.heightmap.fill(-1);const Ae=F.vertexArray.float32,Oe=F.aabb.min[0]-1,Fe=F.aabb.min[1]-1,Ve=jv/(F.aabb.max[0]-Oe+2),qe=jv/(F.aabb.max[1]-Fe+2);for(let pt=0;pt<Ae.length;pt+=3){const vt=Ae[pt+2],zt=(Ae[pt+0]-Oe)*Ve|0,ri=(Ae[pt+1]-Fe)*qe|0;vt>F.heightmap[ri*jv+zt]&&(F.heightmap[ri*jv+zt]=vt)}}function ov(F,Ae){const Oe={};Oe.indexArray=new Ls,Oe.indexArray.reserve(4*F.length),Oe.vertexArray=new Ms,Oe.vertexArray.reserve(10*F.length),Oe.colorArray=new Es,Oe.vertexArray.reserve(10*F.length);let Fe=0;for(const Ve of F){const F=Math.min(10,Math.max(4,1.3*Ve.height))*Ae,qe=[-Ve.normal[1],Ve.normal[0],0],pt=Math.min(.29,.1*Ve.width/Ve.depth),vt=Ve.width-2*Ve.depth*Ae*(pt+.01),zt=Sl.vec3.scaleAndAdd([],Ve.pos,qe,vt/2),ri=Sl.vec3.scaleAndAdd([],Ve.pos,qe,-vt/2),xi=[zt[0],zt[1],zt[2]+Ve.height],bi=[ri[0],ri[1],ri[2]+Ve.height],wi=Sl.vec3.scaleAndAdd([],Ve.normal,qe,pt);Sl.vec3.scale(wi,wi,F);const dr=Sl.vec3.scaleAndAdd([],Ve.normal,qe,-pt);Sl.vec3.scale(dr,dr,F),Sl.vec3.add(wi,zt,wi),Sl.vec3.add(dr,ri,dr),zt[2]+=.1,ri[2]+=.1,Oe.vertexArray.emplaceBack(wi[0],wi[1],wi[2]),Oe.vertexArray.emplaceBack(dr[0],dr[1],dr[2]),Oe.vertexArray.emplaceBack(zt[0],zt[1],zt[2]),Oe.vertexArray.emplaceBack(ri[0],ri[1],ri[2]),Oe.vertexArray.emplaceBack(xi[0],xi[1],xi[2]),Oe.vertexArray.emplaceBack(bi[0],bi[1],bi[2]),Oe.vertexArray.emplaceBack(zt[0],zt[1],zt[2]),Oe.vertexArray.emplaceBack(ri[0],ri[1],ri[2]),Oe.vertexArray.emplaceBack(wi[0],wi[1],wi[2]),Oe.vertexArray.emplaceBack(dr[0],dr[1],dr[2]);const jr=vt/F/2;Oe.colorArray.emplaceBack(-jr-pt,-1,jr,.8),Oe.colorArray.emplaceBack(jr+pt,-1,jr,.8),Oe.colorArray.emplaceBack(-jr,0,jr,1.3),Oe.colorArray.emplaceBack(jr,0,jr,1.3),Oe.colorArray.emplaceBack(jr+pt,-.8,jr,.7),Oe.colorArray.emplaceBack(jr+pt,-.8,jr,.7),Oe.colorArray.emplaceBack(0,0,jr,1.3),Oe.colorArray.emplaceBack(0,0,jr,1.3),Oe.colorArray.emplaceBack(jr+pt,-1.2,jr,.8),Oe.colorArray.emplaceBack(jr+pt,-1.2,jr,.8),Oe.indexArray.emplaceBack(6+Fe,4+Fe,8+Fe),Oe.indexArray.emplaceBack(7+Fe,9+Fe,5+Fe),Oe.indexArray.emplaceBack(0+Fe,1+Fe,2+Fe),Oe.indexArray.emplaceBack(1+Fe,3+Fe,2+Fe),Fe+=10}const Ve={defined:!0,emissiveFactor:[0,0,0]},qe={};return qe.baseColorFactor=Ie.white,Ve.pbrMetallicRoughness=qe,Oe.material=Ve,Oe.aabb=new xu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Oe}class lv{constructor(F){this._stringToNumber={},this._numberToString=[];for(let Ae=0;Ae<F.length;Ae++){const Oe=F[Ae];this._stringToNumber[Oe]=Ae,this._numberToString[Ae]=Oe}}encode(F){return this._stringToNumber[F]}decode(F){return this._numberToString[F]}}const qb=["id","tile","layer","source","sourceLayer","state"];class cv{constructor(F,Ae,Oe,Fe,Ve){this.type="Feature",this._vectorTileFeature=F,this._z=Ae,this._x=Oe,this._y=Fe,this.properties=F.properties,this.id=Ve}clone(){const F=new cv(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(F.state=Object.assign({},this.state)),this.layer&&(F.layer=Object.assign({},this.layer)),this.source&&(F.source=this.source),this.sourceLayer&&(F.sourceLayer=this.sourceLayer),F}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(F){this._geometry=F}toJSON(){const F={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const Ae of qb)void 0!==this[Ae]&&(F[Ae]=this[Ae]);return F}}class hv{constructor(F,Ae){this.tileID=F,this.x=F.canonical.x,this.y=F.canonical.y,this.z=F.canonical.z,this.grid=new Zp(Vd,16,0),this.featureIndexArray=new so,this.promoteId=Ae,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(F,Ae,Oe,Fe,Ve,qe=0,pt=0){const vt=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(Oe,Fe,Ve,qe);const zt=this.grid;for(let F=0;F<Ae.length;F++){const Oe=Ae[F],Fe=[1/0,1/0,-1/0,-1/0];for(let F=0;F<Oe.length;F++){const Ae=Oe[F];Fe[0]=Math.min(Fe[0],Ae.x),Fe[1]=Math.min(Fe[1],Ae.y),Fe[2]=Math.max(Fe[2],Ae.x),Fe[3]=Math.max(Fe[3],Ae.y)}0!==pt&&(Fe[0]-=pt,Fe[1]-=pt,Fe[2]+=pt,Fe[3]+=pt),Fe[0]<Vd&&Fe[1]<Vd&&Fe[2]>=0&&Fe[3]>=0&&zt.insert(vt,Fe[0],Fe[1],Fe[2],Fe[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new N_.VectorTile(new ox(this.rawTileData)).layers,this.sourceLayerCoder=new lv(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const F in this.vtLayers)this.vtFeatures[F]=[]}return this.vtLayers}query(F,Ae){const{tilespaceGeometry:Oe,transform:Fe,tileTransform:Ve,pixelPosMatrix:qe,availableImages:pt}=Ae;this.loadVTLayers(),this.serializedLayersCache.clear();const vt=Oe.bufferedTilespaceBounds,zt=this.grid.query(vt.min.x,vt.min.y,vt.max.x,vt.max.y,((F,Ae,Fe,Ve)=>ql(Oe.bufferedTilespaceGeometry,F,Ae,Fe,Ve)));zt.sort(fv);let ri=null;Fe.elevation&&zt.length>0&&(ri=uy.create(Fe.elevation,this.tileID));const xi={};let bi;for(let Ae=0;Ae<zt.length;Ae++){const vt=zt[Ae];if(vt===bi)continue;bi=vt;const wi=this.featureIndexArray.get(vt);let dr=null;this.is3DTile?this.loadMatchingModelFeature(xi,wi,F,Oe,Fe):this.loadMatchingFeature(xi,wi,F,pt,((F,Ae,pt,vt=0)=>(dr||(dr=zl(F,this.tileID.canonical,Ve)),Ae.queryIntersectsFeature(Oe,F,pt,dr,this.z,Fe,qe,ri,vt))))}return xi}loadMatchingFeature(F,Ae,Oe,Fe,Ve){const{featureIndex:qe,bucketIndex:pt,sourceLayerIndex:vt,layoutVertexArrayOffset:zt}=Ae,ri=this.bucketLayerIDs[pt],xi=Oe.layers,bi=Object.keys(xi);if(bi.length&&!function(F,Ae){for(let Oe=0;Oe<F.length;Oe++)if(Ae.indexOf(F[Oe])>=0)return!0;return!1}(bi,ri))return;const wi=Oe.sourceCache,dr=this.sourceLayerCoder.decode(vt),jr=this.vtLayers[dr].feature(qe),Qr=this.getId(jr,dr);for(let Ae=0;Ae<ri.length;Ae++){const Oe=ri[Ae];if(!xi[Oe])continue;const{styleLayer:pt,targets:vt}=xi[Oe];let bi={};void 0!==Qr&&(bi=wi.getFeatureState(pt.sourceLayer,Qr));const dr=!Ve||Ve(jr,pt,bi,zt);if(!dr)continue;const Xn=new cv(jr,this.z,this.x,this.y,Qr);Xn.tile=this.tileID.canonical,Xn.state=bi;let ho=this.serializedLayersCache.get(Oe);ho||(ho=pt.serialize(),ho.id=Oe,this.serializedLayersCache.set(Oe,ho)),Xn.source=ho.source,Xn.sourceLayer=ho["source-layer"],Xn.layer=nt({},ho),Xn.layer.paint=pv(ho.paint,pt.paint,jr,bi,Fe),Xn.layer.layout=pv(ho.layout,pt.layout,jr,bi,Fe);let yo=!1;for(const F of vt){this.updateFeatureProperties(Xn,F);const{filter:Ae}=F;if(Ae)if(jr.properties=Xn.properties,Ae.needGeometry){const F=El(jr,!0);if(!Ae.filter(new Ca(this.tileID.overscaledZ),F,this.tileID.canonical))continue}else if(!Ae.filter(new Ca(this.tileID.overscaledZ),jr))continue;yo=!0,F.targetId&&this.addFeatureVariant(Xn,F)}yo&&this.appendToResult(F,Oe,qe,Xn,dr)}}loadMatchingModelFeature(F,Ae,Oe,Fe,Ve){const qe=this.bucketLayerIDs[0][0],pt=Oe.layers;if(!pt[qe])return;const{styleLayer:vt,targets:zt}=pt[qe];if("model"!==vt.type)return;const ri=Fe.tile,xi=Ae.featureIndex,bi=ri.getBucket(vt);if(!(bi&&bi instanceof yy))return;const wi=function(F,Ae,Oe,Fe){const Ve=F.getNodesInfo()[Ae];if(Ve.hiddenByReplacement||!Ve.node.meshes)return;let qe=Number.MAX_VALUE;const pt=Ve.node,vt=Oe.tile,zt=Fe.calculatePosMatrix(vt.tileID.toUnwrapped(),Fe.worldSize),ri=Ve.evaluatedScale;let xi=0;Fe.elevation&&pt.elevation&&(xi=pt.elevation*Fe.elevation.exaggeration()),Sl.mat4.translate(zt,zt,[(pt.anchor?pt.anchor[0]:0)*(ri[0]-1),(pt.anchor?pt.anchor[1]:0)*(ri[1]-1),xi]),Sl.mat4.scale(zt,zt,ri);const bi=Oe.queryGeometry,wi=bi.isPointQuery()?bi.screenBounds:bi.screenGeometry,f=function(F){const Ae=Sl.mat4.multiply([],zt,F.matrix);Sl.mat4.multiply(Ae,Fe.expandedFarZProjMatrix,Ae);for(let Oe=0;Oe<F.meshes.length;++Oe){const Ve=F.meshes[Oe];if(Oe===F.lightMeshIndex)continue;const pt=Om(wi,Fe,Ae,Ve.aabb);null!=pt&&(qe=Math.min(pt,qe))}if(F.children)for(const Ae of F.children)f(Ae)};if(f(pt),qe===Number.MAX_VALUE)return;const dr=new il(0,0);return by(vt.tileID.canonical,dr,Ve.node.anchor[0],Ve.node.anchor[1]),{intersectionZ:qe,position:dr,feature:Ve.feature}}(bi,xi,Fe,Ve);if(!wi)return;const{z:dr,x:jr,y:Qr}=ri.tileID.canonical,{feature:Xn,intersectionZ:ho,position:yo}=wi;let zo={};void 0!==Xn.id&&(zo=Oe.sourceCache.getFeatureState(vt.sourceLayer,Xn.id));const ko=new cv({},dr,jr,Qr,Xn.id);ko.tile=this.tileID.canonical,ko.state=zo,ko.properties=Xn.properties,ko.geometry={type:"Point",coordinates:[yo.lng,yo.lat]};let Uo=this.serializedLayersCache.get(qe);Uo||(Uo=vt.serialize(),Uo.id=qe,this.serializedLayersCache.set(qe,Uo)),ko.source=Uo.source,ko.sourceLayer=Uo["source-layer"],ko.layer=nt({},Uo);let ia=!1;for(const F of zt){this.updateFeatureProperties(ko,F);const{filter:Ae}=F;if(Ae)if(Xn.properties=ko.properties,Ae.needGeometry){if(!Ae.filter(new Ca(this.tileID.overscaledZ),Xn,this.tileID.canonical))continue}else if(!Ae.filter(new Ca(this.tileID.overscaledZ),Xn))continue;ia=!0,F.targetId&&this.addFeatureVariant(ko,F)}ia&&this.appendToResult(F,qe,xi,ko,ho)}updateFeatureProperties(F,Ae,Oe){if(Ae.properties){const Fe={};for(const Ve in Ae.properties){const qe=Ae.properties[Ve].evaluate({zoom:this.z},F._vectorTileFeature,F.state,F.tile,Oe);null!=qe&&(Fe[Ve]=qe)}F.properties=Fe}}addFeatureVariant(F,Ae,Oe){const Fe={target:Ae.target,namespace:Ae.namespace,uniqueFeatureID:Ae.uniqueFeatureID};Ae.properties&&(Fe.properties=F.properties),F.variants=F.variants||{},F.variants[Ae.targetId]=F.variants[Ae.targetId]||[],F.variants[Ae.targetId].push(Fe)}appendToResult(F,Ae,Oe,Fe,Ve){let qe=F[Ae];void 0===qe&&(qe=F[Ae]=[]),qe.push({featureIndex:Oe,feature:Fe,intersectionZ:Ve})}lookupSymbolFeatures(F,Ae,Oe,Fe,Ve){const qe={};this.loadVTLayers();for(const pt of F)this.loadMatchingFeature(qe,{bucketIndex:Ae,sourceLayerIndex:Oe,featureIndex:pt,layoutVertexArrayOffset:0},Fe,Ve);return qe}loadFeature(F){const{featureIndex:Ae,sourceLayerIndex:Oe}=F;this.loadVTLayers();const Fe=this.sourceLayerCoder.decode(Oe),Ve=this.vtFeatures[Fe];if(Ve[Ae])return Ve[Ae];const qe=this.vtLayers[Fe].feature(Ae);return Ve[Ae]=qe,qe}hasLayer(F){for(const Ae of this.bucketLayerIDs)for(const Oe of Ae)if(F===Oe)return!0;return!1}getId(F,Ae){let Oe=F.id;if(this.promoteId){const Fe=Array.isArray(this.promoteId)||"object"!=typeof this.promoteId?this.promoteId:this.promoteId[Ae];if(null!=Fe)if(Array.isArray(Fe)){if(!this.promoteIdExpression){const F=Wi(Fe);if("success"!==F.result){const Ae=F.value.map((F=>`${F.key}: ${F.message}`)).join(", ");return void ft(`Failed to create expression for promoteId: ${Ae}`)}this.promoteIdExpression=F.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new mr),Oe=this.promoteIdExpression.evaluate({zoom:0},F)}else Oe=F.properties[Fe];"boolean"==typeof Oe&&(Oe=Number(Oe))}return Oe}}function pv(F,Ae,Oe,Fe,Ve){return ut(F,((F,qe)=>{const pt=Ae instanceof Ua?Ae.get(qe):null;return pt&&pt.evaluate?pt.evaluate(Oe,Fe,Ve):pt}))}function fv(F,Ae){return Ae-F}oa(hv,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const Zb=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class mv{static from(F){if(!(F instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[Ae,Oe]=new Uint8Array(F,0,2);if(219!==Ae)throw new Error("Data does not appear to be in a KDBush format.");const Fe=Oe>>4;if(1!==Fe)throw new Error(`Got v${Fe} data when expected v1.`);const Ve=Zb[15&Oe];if(!Ve)throw new Error("Unrecognized array type.");const[qe]=new Uint16Array(F,2,1),[pt]=new Uint32Array(F,4,1);return new mv(pt,qe,Ve,F)}constructor(F,Ae=64,Oe=Float64Array,Fe){if(isNaN(F)||F<0)throw new Error(`Unpexpected numItems value: ${F}.`);this.numItems=+F,this.nodeSize=Math.min(Math.max(+Ae,2),65535),this.ArrayType=Oe,this.IndexArrayType=F<65536?Uint16Array:Uint32Array;const Ve=Zb.indexOf(this.ArrayType),qe=2*F*this.ArrayType.BYTES_PER_ELEMENT,pt=F*this.IndexArrayType.BYTES_PER_ELEMENT,vt=(8-pt%8)%8;if(Ve<0)throw new Error(`Unexpected typed array class: ${Oe}.`);Fe&&Fe instanceof ArrayBuffer?(this.data=Fe,this.ids=new this.IndexArrayType(this.data,8,F),this.coords=new this.ArrayType(this.data,8+pt+vt,2*F),this._pos=2*F,this._finished=!0):(this.data=new ArrayBuffer(8+qe+pt+vt),this.ids=new this.IndexArrayType(this.data,8,F),this.coords=new this.ArrayType(this.data,8+pt+vt,2*F),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+Ve]),new Uint16Array(this.data,2,1)[0]=Ae,new Uint32Array(this.data,4,1)[0]=F)}add(F,Ae){const Oe=this._pos>>1;return this.ids[Oe]=Oe,this.coords[this._pos++]=F,this.coords[this._pos++]=Ae,Oe}finish(){const F=this._pos>>1;if(F!==this.numItems)throw new Error(`Added ${F} items when expected ${this.numItems}.`);return yv(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(F,Ae,Oe,Fe){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:Ve,coords:qe,nodeSize:pt}=this,vt=[0,Ve.length-1,0],zt=[];for(;vt.length;){const ri=vt.pop()||0,xi=vt.pop()||0,bi=vt.pop()||0;if(xi-bi<=pt){for(let pt=bi;pt<=xi;pt++){const vt=qe[2*pt],ri=qe[2*pt+1];vt>=F&&vt<=Oe&&ri>=Ae&&ri<=Fe&&zt.push(Ve[pt])}continue}const wi=bi+xi>>1,dr=qe[2*wi],jr=qe[2*wi+1];dr>=F&&dr<=Oe&&jr>=Ae&&jr<=Fe&&zt.push(Ve[wi]),(0===ri?F<=dr:Ae<=jr)&&(vt.push(bi),vt.push(wi-1),vt.push(1-ri)),(0===ri?Oe>=dr:Fe>=jr)&&(vt.push(wi+1),vt.push(xi),vt.push(1-ri))}return zt}within(F,Ae,Oe){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:Fe,coords:Ve,nodeSize:qe}=this,pt=[0,Fe.length-1,0],vt=[],zt=Oe*Oe;for(;pt.length;){const ri=pt.pop()||0,xi=pt.pop()||0,bi=pt.pop()||0;if(xi-bi<=qe){for(let Oe=bi;Oe<=xi;Oe++)bv(Ve[2*Oe],Ve[2*Oe+1],F,Ae)<=zt&&vt.push(Fe[Oe]);continue}const wi=bi+xi>>1,dr=Ve[2*wi],jr=Ve[2*wi+1];bv(dr,jr,F,Ae)<=zt&&vt.push(Fe[wi]),(0===ri?F-Oe<=dr:Ae-Oe<=jr)&&(pt.push(bi),pt.push(wi-1),pt.push(1-ri)),(0===ri?F+Oe>=dr:Ae+Oe>=jr)&&(pt.push(wi+1),pt.push(xi),pt.push(1-ri))}return vt}}function yv(F,Ae,Oe,Fe,Ve,qe){if(Ve-Fe<=Oe)return;const pt=Fe+Ve>>1;gv(F,Ae,pt,Fe,Ve,qe),yv(F,Ae,Oe,Fe,pt-1,1-qe),yv(F,Ae,Oe,pt+1,Ve,1-qe)}function gv(F,Ae,Oe,Fe,Ve,qe){for(;Ve>Fe;){if(Ve-Fe>600){const pt=Ve-Fe+1,vt=Oe-Fe+1,zt=Math.log(pt),ri=.5*Math.exp(2*zt/3),xi=.5*Math.sqrt(zt*ri*(pt-ri)/pt)*(vt-pt/2<0?-1:1);gv(F,Ae,Oe,Math.max(Fe,Math.floor(Oe-vt*ri/pt+xi)),Math.min(Ve,Math.floor(Oe+(pt-vt)*ri/pt+xi)),qe)}const pt=Ae[2*Oe+qe];let vt=Fe,zt=Ve;for(xv(F,Ae,Fe,Oe),Ae[2*Ve+qe]>pt&&xv(F,Ae,Fe,Ve);vt<zt;){for(xv(F,Ae,vt,zt),vt++,zt--;Ae[2*vt+qe]<pt;)vt++;for(;Ae[2*zt+qe]>pt;)zt--}Ae[2*Fe+qe]===pt?xv(F,Ae,Fe,zt):(zt++,xv(F,Ae,zt,Ve)),zt<=Oe&&(Fe=zt+1),Oe<=zt&&(Ve=zt-1)}}function xv(F,Ae,Oe,Fe){vv(F,Oe,Fe),vv(Ae,2*Oe,2*Fe),vv(Ae,2*Oe+1,2*Fe+1)}function vv(F,Ae,Oe){const Fe=F[Ae];F[Ae]=F[Oe],F[Oe]=Fe}function bv(F,Ae,Oe,Fe){const Ve=F-Oe,qe=Ae-Fe;return Ve*Ve+qe*qe}Ae.$=Ha,Ae.A=tr,Ae.B=2,Ae.C=$f,Ae.D=zy,Ae.E=we,Ae.F=jf,Ae.G=class extends Zm{},Ae.H=hr,Ae.I=Ag,Ae.J=Te,Ae.K=Xa,Ae.L=Oi,Ae.M=Li,Ae.N=Fi,Ae.O=Hi,Ae.P=Jl,Ae.Q=Za,Ae.R=Dh,Ae.S=Qi,Ae.T=dm,Ae.U=Wi,Ae.V=Zm,Ae.W=Bn,Ae.X=Vn,Ae.Y=Tn,Ae.Z=yr,Ae._=Bu,Ae.a=function(F){return qc.API_CDN_URL_REGEX.test(F)},Ae.a$=cv,Ae.a0=Ni,Ae.a1=Ri,Ae.a2=function(F){const Ae=F.value;let Oe=[];if(!Ae)return Oe;const Fe=hr(Ae);return"string"!==Fe?(Oe=Oe.concat([new Zm(F.key,Ae,`string expected, "${Fe}" found`)]),Oe):(Hm(Ae,!0)||(Oe=Oe.concat([new Zm(F.key,Ae,`invalid url "${Ae}"`)])),Oe)},Ae.a3=pf,Ae.a4=La,Ae.a5=Ga,Ae.a6=ja,Ae.a7=class{constructor(F){this.specification=F}possiblyEvaluate(F,Ae){return yt(F.expression.evaluate(Ae))}interpolate(F,Ae,Oe){return{x:ze(F.x,Ae.x,Oe),y:ze(F.y,Ae.y,Oe),z:ze(F.z,Ae.z,Oe),azimuthal:ze(F.azimuthal,Ae.azimuthal,Oe),polar:ze(F.polar,Ae.polar,Oe)}}},Ae.a8=Ca,Ae.a9=Ji,Ae.aA=cl,Ae.aB=class{constructor(F){this.entries={},this.scheduler=F}request(F,Ae,Oe,Fe){const Ve=this.entries[F]=this.entries[F]||{callbacks:[]};if(Ve.result){const[F,Oe]=Ve.result;return this.scheduler?this.scheduler.add((()=>{Fe(F,Oe)}),Ae):Fe(F,Oe),()=>{}}return Ve.callbacks.push(Fe),Ve.cancel||(Ve.cancel=Oe(((Oe,Fe)=>{Ve.result=[Oe,Fe];for(const F of Ve.callbacks)this.scheduler?this.scheduler.add((()=>{F(Oe,Fe)}),Ae):F(Oe,Fe);setTimeout((()=>delete this.entries[F]),3e3)}))),()=>{Ve.result||(Ve.callbacks=Ve.callbacks.filter((F=>F!==Fe)),Ve.callbacks.length||(Ve.cancel(),delete this.entries[F]))}}},Ae.aC=us,Ae.aD=function(Ae,Oe,Fe){const Ve=JSON.stringify(Ae.request);return Ae.data&&((this||F).deduped.entries[Ve]={result:[null,Ae.data]}),(this||F).deduped.request(Ve,{type:"parseTile",isSymbolTile:Ae.isSymbolTile,zoom:Ae.tileZoom},(F=>{const Oe=ie(Ae.request,((Ae,Oe,Ve,qe)=>{Ae?F(Ae):Oe&&F(null,{vectorTile:Fe?void 0:new N_.VectorTile(new ox(Oe)),rawData:Oe,cacheControl:Ve,expires:qe})}));return()=>{Oe.cancel(),F()}}),Oe)},Ae.aE=function(F){ah++,ah>rh&&(F.getActor().send("enforceCacheSizeLimit",ih),ah=0)},Ae.aF=function(F){return F<=1?1:Math.pow(2,Math.floor(Math.log(F)/Math.LN2))},Ae.aG=iu,Ae.aH=_m,Ae.aI=Pm,Ae.aJ=vm,Ae.aK=function(F,Ae){const Oe=document.createElement("video");Oe.muted=!0,Oe.onloadstart=function(){Ae(null,Oe)};for(let Ae=0;Ae<F.length;Ae++){const Fe=document.createElement("source");ae(F[Ae])||(Oe.crossOrigin="Anonymous"),Fe.src=F[Ae],Oe.appendChild(Fe)}return{cancel:()=>{}}},Ae.aL=mm,Ae.aM=function(F){return fetch(F).then((F=>F.arrayBuffer())).then((Ae=>Kx(Ae,0,F)))},Ae.aN=av,Ae.aO=class{constructor(F,Ae,Oe,Fe){this.id=F,this.position=null!=Ae?new il(Ae[0],Ae[1]):new il(0,0),this.orientation=null!=Oe?Oe:[0,0,0],this.nodes=Fe,this.uploaded=!1,this.aabb=new xu([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(F,Ae){if(Sl.mat4.multiply(F.matrix,Ae,F.matrix),F.meshes)for(const Ae of F.meshes){const Oe=xu.applyTransformFast(Ae.aabb,F.matrix);this.aabb.encapsulate(Oe)}if(F.children)for(const Ae of F.children)this._applyTransformations(Ae,F.matrix)}computeBoundsAndApplyParent(){const F=Sl.mat4.identity([]);for(const Ae of this.nodes)this._applyTransformations(Ae,F)}computeModelMatrix(F,Ae,Oe,Fe,Ve,qe,pt=!1){ny(this.matrix,this,F.transform,this.position,Ae,Oe,Fe,Ve,qe,pt)}upload(F){if(!this.uploaded){for(const Ae of this.nodes)sy(Ae,F);for(const F of this.nodes)oy(F);this.uploaded=!0}}destroy(){for(const F of this.nodes)ly(F)}},Ae.aP=ot,Ae.aQ=wd,Ae.aR=pl,Ae.aS=fl,Ae.aT=bs,Ae.aU=Ls,Ae.aV=at,Ae.aW=Js,Ae.aX=tm,Ae.aY=function(){uf.isLoading()||uf.isLoaded()||"deferred"!==ka()||Ta()},Ae.aZ=Wa,Ae.a_=El,Ae.aa=bl,Ae.ab=Sl,Ae.ac=tt,Ae.ad=Ua,Ae.ae=Fu,Ae.af=ze,Ae.ag=Vd,Ae.ah=Ee,Ae.ai=X,Ae.aj=Ie,Ae.ak=class{constructor(F){this.specification=F}possiblyEvaluate(F,Ae){return function([F,Ae]){const Oe=yt([1,F,Ae]);return{x:Oe.x,y:Oe.y,z:Oe.z}}(F.expression.evaluate(Ae))}interpolate(F,Ae,Oe){return{x:ze(F.x,Ae.x,Oe),y:ze(F.y,Ae.y,Oe),z:ze(F.z,Ae.z,Oe)}}},Ae.al=function(F,Ae,Oe=0,Fe=!0){const Ve=new Jl(Oe,Oe),qe=F.sub(Ve),pt=Ae.add(Ve),vt=[qe,new Jl(pt.x,qe.y),pt,new Jl(qe.x,pt.y)];return Fe&&vt.push(qe.clone()),vt},Ae.am=function(F,Ae){const Oe=[];for(let Fe=0;Fe<F.length;Fe++){const Ve=et(Fe-1,-1,F.length-1),qe=et(Fe+1,-1,F.length-1),pt=F[Fe],vt=F[qe],zt=F[Ve].sub(pt).unit(),ri=vt.sub(pt).unit(),xi=ri.angleWithSep(zt.x,zt.y),bi=zt.add(ri).unit().mult(-1*Ae/Math.sin(xi/2));Oe.push(pt.add(bi))}return Oe},Ae.an=Md,Ae.ao=ql,Ae.ap=function(F,Ae,Oe=0){return Sl.vec3.fromValues(((Ae.x-Oe)*F.scale-F.x)*Vd,(Ae.y*F.scale-F.y)*Vd,dl(Ae.z,Ae.y))},Ae.aq=hu,Ae.ar=zp,Ae.as=function(F){let Ae=1/0,Oe=1/0,Fe=-1/0,Ve=-1/0;for(const qe of F)Ae=Math.min(Ae,qe.x),Oe=Math.min(Oe,qe.y),Fe=Math.max(Fe,qe.x),Ve=Math.max(Ve,qe.y);return{min:new Jl(Ae,Oe),max:new Jl(Fe,Ve)}},Ae.at=ul,Ae.au=jl,Ae.av=wl,Ae.aw=Q,Ae.ax=cm,Ae.ay=function(F,Ae){const Oe={};for(let Fe=0;Fe<Ae.length;Fe++){const Ve=Ae[Fe];Ve in F&&(Oe[Ve]=F[Ve])}return Oe},Ae.az=al,Ae.b=function(F){return qc.API_FONTS_REGEX.test(F)},Ae.b$=Bm,Ae.b0=xt,Ae.b1=Ap,Ae.b2=Uc,Ae.b3=zl,Ae.b4=xs,Ae.b5=Ys,Ae.b6=o_,Ae.b7=po,Ae.b8=hc,Ae.b9=Sv,Ae.bA=kh,Ae.bB=pd,Ae.bC=hd,Ae.bD=Ef,Ae.bE=mv,Ae.bF=et,Ae.bG=bt,Ae.bH=hl,Ae.bI=function(F,Ae,Oe){F[4*Ae+0]=Oe[0],F[4*Ae+1]=Oe[1],F[4*Ae+2]=Oe[2],F[4*Ae+3]=Oe[3]},Ae.bJ=Eo,Ae.bK=Ao,Ae.bL=So,Ae.bM=Mo,Ae.bN=wo,Ae.bO=il,Ae.bP=$d,Ae.bQ=nu,Ae.bR=gu,Ae.bS=Tm,Ae.bT=ru,Ae.bU=Pu,Ae.bV=function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){if("globe"===zt.name)return Pu(F,Ae,new ru(Oe,Fe,Ve),!1);const ri=wd({z:Oe,x:Fe,y:Ve},zt);return new xu([(qe+ri.x/ri.scale)*Ae,Ae*(ri.y/ri.scale),pt],[(qe+ri.x2/ri.scale)*Ae,Ae*(ri.y2/ri.scale),vt])},Ae.bW=function(F,Ae,Oe){let Fe=0;for(let Oe=0;Oe<2;++Oe){const Ve=0;F[Oe]>Ve&&(Fe+=(F[Oe]-Ve)*(F[Oe]-Ve)),Ae[Oe]<Ve&&(Fe+=(Ve-Ae[Oe])*(Ve-Ae[Oe]))}return Fe},Ae.bX=jm,Ae.bY=um,Ae.bZ=function(F){const Ae=Sl.mat4.identity(new Float64Array(16));Sl.mat4.multiply(Ae,F.pixelMatrix,F.globeMatrix);const Oe=[0,Mm,0],Fe=[0,Im,0];return Sl.vec3.transformMat4(Oe,Oe,Ae),Sl.vec3.transformMat4(Fe,Fe,Ae),[Oe[0]>0&&Oe[0]<=F.width&&Oe[1]>0&&Oe[1]<=F.height&&!Nu(F,new il(F.center.lat,90)),Fe[0]>0&&Fe[0]<=F.width&&Fe[1]>0&&Fe[1]<=F.height&&!Nu(F,new il(F.center.lat,-90))]},Ae.b_=function(F,Ae){const{scale:Oe}=F.tileTransform,Fe=Oe*Vd/(F.tileSize*Math.pow(2,Ae.zoom-F.tileID.overscaledZ+F.tileID.canonical.z));return Sl.mat2.scale(new Float32Array(4),Ae.inverseAdjustmentMatrix,[Fe,Fe])},Ae.ba=function(F,Ae){const Oe=Fu(Ae.zoom);if(0===Oe)return Au(F);const Fe=zu(F),Ve=Eu(Fe),qe=ul(Fe.getWest())*Ae.worldSize,pt=ul(Fe.getEast())*Ae.worldSize,vt=cl(Fe.getNorth())*Ae.worldSize,zt=cl(Fe.getSouth())*Ae.worldSize,ri=[qe,vt,0],xi=[pt,vt,0],bi=[qe,zt,0],wi=[pt,zt,0],dr=Sl.mat4.invert([],Ae.globeMatrix);return Sl.vec3.transformMat4(ri,ri,dr),Sl.vec3.transformMat4(xi,xi,dr),Sl.vec3.transformMat4(bi,bi,dr),Sl.vec3.transformMat4(wi,wi,dr),Ve[0]=Su(Ve[0],bi,Oe),Ve[1]=Su(Ve[1],wi,Oe),Ve[2]=Su(Ve[2],xi,Oe),Ve[3]=Su(Ve[3],ri,Oe),xu.fromPoints(Ve)},Ae.bb=Cu,Ae.bc=ku,Ae.bd=Su,Ae.be=vs,Ae.bf=n_,Ae.bg=Ix,Ae.bh=ox,Ae.bi=ie,Ae.bj=function(F){const Ae=[];for(const Oe in F)Ae.push(F[Oe]);return Ae},Ae.bk=function(F,Ae){const Oe=[];for(const Fe in F)Fe in Ae||Oe.push(Fe);return Oe},Ae.bl=rt,Ae.bm=["type","source","source-layer","minzoom","maxzoom","filter","layout"],Ae.bn=$,Ae.bo=function(F,Ae){const{x:Oe,y:Fe}=F.point,Ve=Ru(Oe,Fe,F.worldSize/F._pixelsPerMercatorPixel,0,0);return Sl.mat4.multiply(Ve,Ve,Vu(Au(Ae)))},Ae.bp=Qp,Ae.bq=cx,Ae.br=Jp,Ae.bs=function(F,Ae,Oe,Fe,Ve){const qe=5*Ae+2;F.float32[qe+0]=Oe,F.float32[qe+1]=Fe,F.float32[qe+2]=Ve},Ae.bt=Wd,Ae.bu=Uf,Ae.bv=Cl,Ae.bw=ky,Ae.bx=bh,Ae.by=Nv,Ae.bz=Eh,Ae.c=Pt,Ae.c$=(F,Ae,Oe,Fe,Ve,qe,pt,vt)=>{const zt=F.transform,ri=zt.pitch<15?Ep(.07,.7,Q((14-zt.zoom)/5,0,1)):.07,xi="none"===Oe.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:Tp(F,Ae,Oe,Fe),u_texsize:Ae.imageAtlasTexture?Ae.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:zt.calculatePixelsToTileUnitsMatrix(Ae),u_device_pixel_ratio:Ve,u_width_scale:qe,u_floor_width_scale:pt,u_image:0,u_tile_units_to_pixels:kp(Ae,zt),u_units_to_pixels:[1/zt.pixelsToGLUnits[0],1/zt.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:vt,u_trim_fade_range:Oe.paint.get("line-trim-fade-range"),u_trim_color:Oe.paint.get("line-trim-color").toRenderColor(xi?null:Oe.lut).toArray01(),u_emissive_strength:Oe.paint.get("line-emissive-strength"),u_zbias_factor:ri,u_tile_to_meter:vl(Ae.tileID.canonical,0)}},Ae.c0=km,Ae.c1=function(F){const Ae=km(F,!0);return Sl.mat2.invert([],[Ae[0],Ae[1],Ae[4],Ae[5]])},Ae.c2=pu,Ae.c3=function(F){const{x:Ae,y:Oe}=F.point,{lng:Fe,lat:Ve}=F._center;return Ru(Ae,Oe,F.worldSize,Fe,Ve)},Ae.c4=Z,Ae.c5=au,Ae.c6=hm,Ae.c7=function(F){const Ae=Math.round((F+45+360)%360/90)%4;return tc[Ae]},Ae.c8=45,Ae.c9=ll,Ae.cA=class extends _o{constructor(F){super(F),this.current=em}set(F,Ae,Oe){if(this.fetchUniformLocation(F,Ae))for(let F=0;F<9;F++)if(Oe[F]!==this.current[F]){this.current=Oe,this.gl.uniformMatrix3fv(this.location,!1,Oe);break}}},Ae.cB=W,Ae.cC=function(F,Ae,Oe){const Fe=Fu(Oe.zoom),Ve=F.style.map._antialias,qe=F.terrain&&F.terrain.exaggeration()>0;return 0===Fe&&!Ve&&!qe},Ae.cD=function(F){const Ae=F.pixelsPerMeter,Oe=Ae/hl(1,F.center.lat),Fe=Sl.mat4.identity(new Float64Array(16));return Sl.mat4.translate(Fe,Fe,[F.point.x,F.point.y,0]),Sl.mat4.scale(Fe,Fe,[Oe,Oe,Ae]),Float32Array.from(Fe)},Ae.cE=zu,Ae.cF=function(F){const Ae=jm-5;F=Q(F,-Ae,Ae)/Ae*90;const Oe=Math.pow(Math.abs(Math.sin(X(F))),3);return Math.round(Oe*(Sm.length-1))},Ae.cG=function(F,Ae,Oe,Fe){const Ve=Ae.getNorth(),qe=Ae.getSouth(),pt=Ae.getWest(),vt=Ae.getEast(),zt=1<<F.z,ri=vt-pt,xi=Ve-qe,bi=ri/wm,wi=-xi/Sm[Oe],dr=[0,bi,0,wi,0,0,Ve,pt,0];if(F.z>0){const F=180/Fe;Sl.mat3.multiply(dr,dr,[F/ri+1,0,0,0,F/xi+1,0,-.5*F/bi,.5*F/wi,1])}return dr[2]=zt,dr[5]=F.x,dr[8]=F.y,dr},Ae.cH=Au,Ae.cI=function(F,Ae,Oe){const Fe=Sl.mat4.identity(new Float64Array(16)),Ve=(Ae/(1<<F)-.5)*Math.PI*2;return Sl.mat4.rotateY(Fe,Oe.globeMatrix,Ve),Float32Array.from(Fe)},Ae.cJ=class{isDataAvailableAtPoint(F){const Ae=this._source();if(this.isUsingMockSource()||!Ae||F.y<0||F.y>1)return!1;const Oe=Ae.getSource().maxzoom,Fe=1<<Oe,Ve=Math.floor(F.x),qe=Math.floor((F.x-Ve)*Fe),pt=Math.floor(F.y*Fe),vt=this.findDEMTileFor(new iu(Oe,Ve,Oe,qe,pt));return!(!vt||!vt.dem)}getAtPointOrZero(F,Ae=0){return this.getAtPoint(F,Ae)||0}getAtPoint(F,Ae,Oe=!0){if(this.isUsingMockSource())return null;null==Ae&&(Ae=null);const Fe=this._source();if(!Fe)return Ae;if(F.y<0||F.y>1)return Ae;const Ve=Fe.getSource().maxzoom,qe=1<<Ve,pt=Math.floor(F.x),vt=F.x-pt,zt=new iu(Ve,pt,Ve,Math.floor(vt*qe),Math.floor(F.y*qe)),ri=this.findDEMTileFor(zt);if(!ri||!ri.dem)return Ae;const xi=ri.dem,bi=1<<ri.tileID.canonical.z,wi=(vt*bi-ri.tileID.canonical.x)*xi.dim,dr=(F.y*bi-ri.tileID.canonical.y)*xi.dim,jr=Math.floor(wi),Qr=Math.floor(dr);return(Oe?this.exaggeration():1)*ze(ze(xi.get(jr,Qr),xi.get(jr,Qr+1),dr-Qr),ze(xi.get(jr+1,Qr),xi.get(jr+1,Qr+1),dr-Qr),wi-jr)}getAtTileOffset(F,Ae,Oe){const Fe=1<<F.canonical.z;return this.getAtPointOrZero(new bl(F.wrap+(F.canonical.x+Ae/Vd)/Fe,(F.canonical.y+Oe/Vd)/Fe))}getAtTileOffsetFunc(F,Ae,Oe,Fe){return Ve=>{const qe=this.getAtTileOffset(F,Ve.x,Ve.y),pt=Fe.upVector(F.canonical,Ve.x,Ve.y),vt=Fe.upVectorScale(F.canonical,Ae,Oe).metersToTile;return Sl.vec3.scale(pt,pt,qe*vt),pt}}getForTilePoints(F,Ae,Oe,Fe){if(this.isUsingMockSource())return!1;const Ve=uy.create(this,F,Fe);return!!Ve&&(Ae.forEach((F=>{F[2]=this.exaggeration()*Ve.getElevationAt(F[0],F[1],Oe)})),!0)}getMinMaxForTile(F){if(this.isUsingMockSource())return null;const Ae=this.findDEMTileFor(F);if(!Ae||!Ae.dem)return null;const Oe=Ae.dem.tree,Fe=Ae.tileID,Ve=1<<F.canonical.z-Fe.canonical.z;let qe=F.canonical.x/Ve-Fe.canonical.x,pt=F.canonical.y/Ve-Fe.canonical.y,vt=0;for(let Ae=0;Ae<F.canonical.z-Fe.canonical.z&&!Oe.leaves[vt];Ae++){qe*=2,pt*=2;const F=2*Math.floor(pt)+Math.floor(qe);vt=Oe.childOffsets[vt]+F,qe%=1,pt%=1}return{min:this.exaggeration()*Oe.minimums[vt],max:this.exaggeration()*Oe.maximums[vt]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(F,Ae,Oe){throw new Error("Pure virtual method called.")}pointCoordinate(F){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(F){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const F=this.visibleDemTiles;if(0===F.length)return null;let Ae=!1,Oe=Number.MAX_VALUE,Fe=Number.MIN_VALUE;for(const Ve of F){const F=this.getMinMaxForTile(Ve.tileID);F&&(Oe=Math.min(Oe,F.min),Fe=Math.max(Fe,F.max),Ae=!0)}return Ae?{min:Oe,max:Fe}:null}},Ae.cK=oc,Ae.cL=vu,Ae.cM=function(F,Ae){return[Math.pow(F[0],2.2)*Ae,Math.pow(F[1],2.2)*Ae,Math.pow(F[2],2.2)*Ae]},Ae.cN=Lu,Ae.cO=At,Ae.cP=Mt,Ae.cQ=256,Ae.cR=function(F,Ae){const Oe=[0,0,0],Fe=Cu(Au(Ae.canonical));return Sl.vec3.transformMat4(Oe,Oe,Fe),Sl.vec3.transformMat4(Oe,Oe,F),Oe},Ae.cS=F=>({u_camera_to_center_distance:new Mo(F),u_extrude_scale:new Bo(F),u_device_pixel_ratio:new Mo(F),u_matrix:new Eo(F),u_inv_rot_matrix:new Eo(F),u_merc_center:new Ao(F),u_tile_id:new So(F),u_zoom_transition:new Mo(F),u_up_dir:new So(F),u_emissive_strength:new Mo(F)}),Ae.cT=F=>({u_matrix:new Eo(F),u_pixels_to_tile_units:new Bo(F),u_device_pixel_ratio:new Mo(F),u_width_scale:new Mo(F),u_floor_width_scale:new Mo(F),u_units_to_pixels:new Ao(F),u_dash_image:new wo(F),u_gradient_image:new wo(F),u_image_height:new Mo(F),u_texsize:new Ao(F),u_tile_units_to_pixels:new Mo(F),u_alpha_discard_threshold:new Mo(F),u_trim_offset:new Ao(F),u_trim_fade_range:new Ao(F),u_trim_color:new Io(F),u_emissive_strength:new Mo(F),u_zbias_factor:new Mo(F),u_tile_to_meter:new Mo(F)}),Ae.cU=F=>({u_matrix:new Eo(F),u_texsize:new Ao(F),u_pixels_to_tile_units:new Bo(F),u_device_pixel_ratio:new Mo(F),u_width_scale:new Mo(F),u_floor_width_scale:new Mo(F),u_image:new wo(F),u_units_to_pixels:new Ao(F),u_tile_units_to_pixels:new Mo(F),u_alpha_discard_threshold:new Mo(F),u_trim_offset:new Ao(F),u_trim_fade_range:new Ao(F),u_trim_color:new Io(F),u_emissive_strength:new Mo(F),u_zbias_factor:new Mo(F),u_tile_to_meter:new Mo(F)}),Ae.cV=Vs,Ae.cW=Ly,Ae.cX=By,Ae.cY=Gu,Ae.cZ=(F,Ae,Oe,Fe,Ve,qe)=>{const pt=F.transform,vt="globe"===pt.projection.name;let zt;if("map"===qe.paint.get("circle-pitch-alignment"))if(vt){const F=Lu(pt.zoom,Ae.canonical)*pt._pixelsPerMercatorPixel;zt=Float32Array.from([F,0,0,F])}else zt=pt.calculatePixelsToTileUnitsMatrix(Oe);else zt=new Float32Array([pt.pixelsToGLUnits[0],0,0,pt.pixelsToGLUnits[1]]);const ri={u_camera_to_center_distance:F.transform.getCameraToCenterDistance(pt.projection),u_matrix:F.translatePosMatrix(Ae.projMatrix,Oe,qe.paint.get("circle-translate"),qe.paint.get("circle-translate-anchor")),u_device_pixel_ratio:eh.devicePixelRatio,u_extrude_scale:zt,u_inv_rot_matrix:u_,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:qe.paint.get("circle-emissive-strength")};if(vt){ri.u_inv_rot_matrix=Fe,ri.u_merc_center=Ve,ri.u_tile_id=[Ae.canonical.x,Ae.canonical.y,1<<Ae.canonical.z],ri.u_zoom_transition=Fu(pt.zoom);const F=Ve[0]*Vd,Oe=Ve[1]*Vd;ri.u_up_dir=pt.projection.upVector(new ru(0,0,0),F,Oe)}return ri},Ae.c_=Bp,Ae.ca=Io,Ae.cb=function(F,Ae,Oe){const Fe=Math.sqrt(F*F+Ae*Ae+Oe*Oe),Ve=Fe>0?Math.acos(Oe/Fe)*ec:0;let qe=0!==F||0!==Ae?Math.atan2(-Ae,-F)*ec+90:0;return qe<0&&(qe+=360),[Fe,qe,Ve]},Ae.cc=vl,Ae.cd=xu,Ae.ce=yt,Ae.cf=function(F){return[Math.pow(F[0],1/2.2),Math.pow(F[1],1/2.2),Math.pow(F[2],1/2.2)]},Ae.cg=function(F,Ae){return F.readFields(Oy,{icons:[]},Ae)},Ae.ch=function(F){return F({pluginStatus:of,pluginURL:sf}),lf.on("pluginStateChange",F),F},Ae.ci=Ty,Ae.cj=Kf,Ae.ck=vx,Ae.cl=Rh,Ae.cm=Pa,Ae.cn=Rt,Ae.co=cu,Ae.cp=ht,Ae.cq=function(F){const Ae=F.indexOf(gf);return Ae>=0?F.slice(0,Ae):F},Ae.cr=function(F){return F.indexOf(gf)>=0},Ae.cs=function(F){const Ae=F.indexOf(gf);return Ae>=0?F.slice(Ae+1):""},Ae.ct=function(F){const Ae=[],Oe=F.id;return void 0===Oe&&Ae.push({message:`layers.${Oe}: missing required property "id"`}),void 0===F.render&&Ae.push({message:`layers.${Oe}: missing required method "render"`}),F.renderingMode&&"2d"!==F.renderingMode&&"3d"!==F.renderingMode&&Ae.push({message:`layers.${Oe}: property "renderingMode" must be either "2d" or "3d"`}),Ae},Ae.cu=function(F,Ae,Oe,Fe){return"custom"===F.type?new zm(F,Ae):new Hv[F.type](F,Ae,Oe,Fe)},Ae.cv=ct,Ae.cw=class extends cv{constructor(F,Ae){super(F._vectorTileFeature,F._z,F._x,F._y,F.id),F.state&&(this.state=Object.assign({},F.state)),this.target=Ae.target,this.namespace=Ae.namespace,Ae.properties&&(this.properties=Ae.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=F.source,this.sourceLayer=F.sourceLayer,this.layer=F.layer)}toJSON(){const F=super.toJSON();return F.target=this.target,F.namespace=this.namespace,F}},Ae.cx=lf,Ae.cy=ne,Ae.cz=Po,Ae.d=function(F){return qc.API_TILEJSON_REGEX.test(F)},Ae.d$=hv,Ae.d0=(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt)=>{const ri=F.transform,xi=ri.calculatePixelsToTileUnitsMatrix(Ae),bi="none"===Oe.paint.get("line-trim-color-use-theme").constantOr("default"),wi=ri.pitch<15?Ep(.07,.7,Q((14-ri.zoom)/5,0,1)):.07;return{u_matrix:Tp(F,Ae,Oe,Fe),u_pixels_to_tile_units:xi,u_device_pixel_ratio:qe,u_width_scale:pt,u_floor_width_scale:vt,u_units_to_pixels:[1/ri.pixelsToGLUnits[0],1/ri.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:Ve,u_texsize:Cp(Oe)&&Ae.lineAtlasTexture?Ae.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:kp(Ae,F.transform),u_alpha_discard_threshold:0,u_trim_offset:zt,u_trim_fade_range:Oe.paint.get("line-trim-fade-range"),u_trim_color:Oe.paint.get("line-trim-color").toRenderColor(bi?null:Oe.lut).toArray01(),u_emissive_strength:Oe.paint.get("line-emissive-strength"),u_zbias_factor:wi,u_tile_to_meter:vl(Ae.tileID.canonical,0)}},Ae.d1=st,Ae.d2=lc,Ae.d3=ap,Ae.d4=t_,Ae.d5=Kh,Ae.d6=W_,Ae.d7=450,Ae.d8=7,Ae.d9=Mv,Ae.dA=cc,Ae.dB=xl,Ae.dC=el,Ae.dD=function([F,Ae,Oe]){const Fe=Math.hypot(F,Ae,Oe),Ve=Math.atan2(F,Oe),qe=.5*Math.PI-Math.acos(-Ae/Fe);return new il(Z(Ve),Z(qe))},Ae.dE=Vm,Ae.dF=function(F){const Ae=F.navigator?F.navigator.userAgent:null;return!!function(F){if(null==Gc){const Ae=F.navigator?F.navigator.userAgent:null;Gc=!!F.safari||!(!Ae||!(/\b(iPad|iPhone|iPod)\b/.test(Ae)||Ae.match("Safari")&&!Ae.match("Chrome")))}return Gc}(F)&&Ae&&(Ae.match("Version/15.4")||Ae.match("Version/15.5")||Ae.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},Ae.dG=function(F,Ae){ih=F,rh=Ae},Ae.dH=Nu,Ae.dI=Ou,Ae.dJ=function(F){const Ae=[0,0,0],Oe=Sl.mat4.identity(new Float64Array(16));return Sl.mat4.multiply(Oe,F.pixelMatrix,F.globeMatrix),Sl.vec3.transformMat4(Ae,Ae,Oe),new Jl(Ae[0],Ae[1])},Ae.dK=function(F,Ae,Oe=!1){if(of===Xp||of===Yp||of===tf)throw new Error("setRTLTextPlugin cannot be called multiple times.");sf=eh.resolveURL(F),of=Xp,rf=Ae,za(),Oe||Ta()},Ae.dL=ka,Ae.dM=function(){Ty().acquire(Xv)},Ae.dN=function(){const F=Yv;F&&(F.isPreloaded()&&1===F.numActive()?(F.release(Xv),Yv=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},Ae.dO=Py,Ae.dP=function(F){const Ae=$t();if(!Ae)return;const Oe=Ae.delete(th);F&&Oe.catch(F).then((()=>F()))},Ae.dQ=Wv,Ae.dR=Dx,Ae.dS=function(F){Db=eh.resolveURL(F),Ob||(Ob=new zy(Ty(),new we)),Ob.broadcast("setDracoUrl",Db)},Ae.dT=Lx,Ae.dU=function(F){Lb=eh.resolveURL(F),Ob||(Ob=new zy(Ty(),new we)),Ob.broadcast("setMeshoptUrl",Lb)},Ae.dV=oa,Ae.dW=ac,Ae.dX=xx,Ae.dY=N_,Ae.dZ=class{constructor(F,Ae){this.pos=F,this.dir=Ae}intersectsPlane(F,Ae,Oe){const Fe=Sl.vec2.dot(Ae,this.dir);if(Math.abs(Fe)<1e-6)return!1;const Ve=((F[0]-this.pos[0])*Ae[0]+(F[1]-this.pos[1])*Ae[1])/Fe;return Oe[0]=this.pos[0]+this.dir[0]*Ve,Oe[1]=this.pos[1]+this.dir[1]*Ve,!0}},Ae.d_=lv,Ae.da=ys,Ae.db=Hs,Ae.dc=256,Ae.dd=Vu,Ae.de=Ms,Ae.df=Ns,Ae.dg=Us,Ae.dh=function(F,Ae,Oe,Fe,Ve){return Q((F-Ae)/(Oe-Ae)*(Ve-Fe)+Fe,Fe,Ve)},Ae.di=Ii,Ae.dj=gl,Ae.dk=class{constructor(F,Ae,Oe,Fe){this.context=F,this.format=Fe,this.size=Oe,this.texture=F.gl.createTexture();const[Ve,qe,pt]=this.size,{gl:vt}=F;vt.bindTexture(vt.TEXTURE_3D,this.texture),F.pixelStoreUnpackFlipY.set(!1),F.pixelStoreUnpack.set(1),F.pixelStoreUnpackPremultiplyAlpha.set(!1),vt.texImage3D(vt.TEXTURE_3D,0,this.format,Ve,qe,pt,0,pm(this.format),fm(this.format),Ae.data)}bind(F,Ae){const{context:Oe}=this,{gl:Fe}=Oe;Fe.bindTexture(Fe.TEXTURE_3D,this.texture),F!==this.minFilter&&(Fe.texParameteri(Fe.TEXTURE_3D,Fe.TEXTURE_MAG_FILTER,F),Fe.texParameteri(Fe.TEXTURE_3D,Fe.TEXTURE_MIN_FILTER,F),this.minFilter=F),Ae!==this.wrapS&&(Fe.texParameteri(Fe.TEXTURE_3D,Fe.TEXTURE_WRAP_S,Ae),Fe.texParameteri(Fe.TEXTURE_3D,Fe.TEXTURE_WRAP_T,Ae),this.wrapS=Ae)}destroy(){const{gl:F}=this.context;F.deleteTexture(this.texture),this.texture=null}},Ae.dl=Fm,Ae.dm=[1,1,1],Ae.dn=uy,Ae.dp=Gv,Ae.dq=Ts,Ae.dr=$s,Ae.ds=Am,Ae.dt=qs,Ae.du=js,Ae.dv=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Jl(1/0,1/0),max:new Jl(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(F,Ae=!1){const Oe=Sh(new Jl(0,0),new Jl(Vd,Vd),F),Fe=[];if(Ae&&!Mh(Oe,this._globalClipBounds))return Fe;for(const Ae of this._activeRegions){if(Ae.hiddenByOverlap)continue;if(!Mh(Oe,Ae))continue;const Ve=Ih(Ae.min,Ae.max,F);Fe.push({min:Ve.min,max:Ve.max,sourceId:this._sourceIds[Ae.priority],footprint:Ae.footprint,footprintTileId:Ae.tileId,order:Ae.order,clipMask:Ae.clipMask,clipScope:Ae.clipScope})}return Fe}setSources(F){this._setSources(F.map((F=>({getSourceId:()=>F.cache.id,getFootprints:()=>{const Ae=[];for(const Oe of F.cache.getVisibleCoordinates()){const Fe=F.cache.getTile(Oe).buckets[F.layer];Fe&&Fe.updateFootprints(Oe.toUnwrapped(),Ae)}return Ae},getOrder:()=>F.order,getClipMask:()=>F.clipMask,getClipScope:()=>F.clipScope}))))}_addSource(F){const Ae=F.getFootprints();if(0===Ae.length)return;const Oe=F.getOrder(),Fe=F.getClipMask(),Ve=F.getClipScope();for(const F of Ae){if(!F.footprint)continue;const Ae=Sh(F.footprint.min,F.footprint.max,F.id);this._activeRegions.push({min:Ae.min,max:Ae.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:F.id,footprint:F.footprint,order:Oe,clipMask:Fe,clipScope:Ve})}this._sourceIds.push(F.getSourceId())}_computeReplacement(){this._activeRegions.sort(((F,Ae)=>F.priority-Ae.priority||_h(F.min,Ae.min)||_h(F.max,Ae.max)||F.order-Ae.order||F.clipMask-Ae.clipMask||function(F,Ae){const r=(F,Ae)=>F+Ae;return F.length-Ae.length||F.reduce(r,"").localeCompare(Ae.reduce(r,""))}(F.clipScope,Ae.clipScope)));let F=this._activeRegions.length!==this._prevRegions.length;if(!F){let Ae=0;for(;!F&&Ae!==this._activeRegions.length;){const Oe=this._activeRegions[Ae],Fe=this._prevRegions[Ae];F=Oe.priority!==Fe.priority||!wh(Oe,Fe)||Oe.order!==Fe.order||Oe.clipMask!==Fe.clipMask||!$(Oe.clipScope,Fe.clipScope),++Ae}}if(F){++this._updateTime;for(const F of this._activeRegions)F.order!==V_&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,F.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,F.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,F.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,F.max.y));const t=F=>{const Ae=this._activeRegions;if(F>=Ae.length)return F;const Oe=Ae[F].priority;for(;F<Ae.length&&Ae[F].priority===Oe;)++F;return F};if(this._sourceIds.length>1){let F=0,Ae=t(F);for(;F!==Ae;){let Oe=F;const Fe=F;for(;Oe!==Ae;){const F=this._activeRegions[Oe];F.hiddenByOverlap=!1;for(let Ae=0;Ae<Fe;Ae++){const Oe=this._activeRegions[Ae];if(!Oe.hiddenByOverlap&&F.order===V_&&Mh(F,Oe)&&(F.hiddenByOverlap=zh(F.footprint,F.tileId,Oe.footprint,Oe.tileId),F.hiddenByOverlap))break}++Oe}F=Ae,Ae=t(F)}}}}_setSources(F){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let Ae=F.length-1;Ae>=0;Ae--)this._addSource(F[Ae]);this._computeReplacement()}},Ae.dw=class{constructor(F){this._createGrid(F),this._createPoles(F)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const F of this._poleSegments)F.destroy();for(const F of this._gridSegments)F.withSkirts.destroy(),F.withoutSkirts.destroy()}_fillGridMeshWithLods(F,Ae){const Oe=new xs,Fe=new Ls,Ve=[],qe=F+1+2,pt=Ae[0]+1,vt=Ae[0]+1+(1+Ae.length),l=(F,Ae,Oe)=>{let Fe=F===qe-1?F-2:0===F?F:F-1;return Fe+=Oe?24575:0,[Fe,Ae]};for(let F=0;F<qe;++F)Oe.emplaceBack(...l(F,0,!0));for(let F=0;F<pt;++F)for(let Ae=0;Ae<qe;++Ae)Oe.emplaceBack(...l(Ae,F,(0===Ae||Ae===qe-1)&&!0));for(let F=0;F<Ae.length;++F){const Fe=Ae[F];for(let F=0;F<qe;++F)Oe.emplaceBack(...l(F,Fe,!0))}for(let F=0;F<Ae.length;++F){const pt=Fe.length,zt=Ae[F]+1+2,ri=new Ls;for(let Oe=0;Oe<zt-1;Oe++){const Ve=Oe===zt-2,pt=Ve?qe*(vt-Ae.length+F-Oe):qe;for(let F=0;F<qe-1;F++){const Ae=Oe*qe+F;0===Oe||Ve||0===F||F===qe-2?(ri.emplaceBack(Ae+1,Ae,Ae+pt),ri.emplaceBack(Ae+pt,Ae+pt+1,Ae+1)):(Fe.emplaceBack(Ae+1,Ae,Ae+pt),Fe.emplaceBack(Ae+pt,Ae+pt+1,Ae+1))}}const xi=po.simpleSegment(0,pt,Oe.length,Fe.length-pt);for(let F=0;F<ri.uint16.length;F+=3)Fe.emplaceBack(ri.uint16[F],ri.uint16[F+1],ri.uint16[F+2]);const bi=po.simpleSegment(0,pt,Oe.length,Fe.length-pt);Ve.push({withoutSkirts:xi,withSkirts:bi})}return{vertices:Oe,indices:Fe,segments:Ve}}_createGrid(F){const Ae=this._fillGridMeshWithLods(wm,Sm);this._gridSegments=Ae.segments,this._gridBuffer=F.createVertexBuffer(Ae.vertices,o_.members),this._gridIndexBuffer=F.createIndexBuffer(Ae.indices,!0)}_createPoles(F){const Ae=new Ls;for(let F=0;F<=wm;F++)Ae.emplaceBack(0,F+1,F+2);this._poleIndexBuffer=F.createIndexBuffer(Ae,!0);const Oe=new Ns,Fe=new Ns,Ve=new Ns,qe=new Ns;this._poleSegments=[];for(let F=0,Ae=0;F<hm;F++){const pt=360/(1<<F);Oe.emplaceBack(0,-cm,0,.5,0),Fe.emplaceBack(0,-cm,0,.5,1),Ve.emplaceBack(0,-cm,0,.5,.5),qe.emplaceBack(0,-cm,0,.5,.5);for(let F=0;F<=wm;F++){let Ae=F/wm,vt=0;const zt=ze(0,pt,Ae),[ri,xi,bi]=tl(c_,h_,zt,cm);Oe.emplaceBack(ri,xi,bi,Ae,vt),Fe.emplaceBack(ri,xi,bi,Ae,1-vt);const wi=X(zt);Ae=.5+.5*Math.sin(wi),vt=.5+.5*Math.cos(wi),Ve.emplaceBack(ri,xi,bi,Ae,vt),qe.emplaceBack(ri,xi,bi,Ae,1-vt)}this._poleSegments.push(po.simpleSegment(Ae,0,66,64)),Ae+=66}this._poleNorthVertexBuffer=F.createVertexBuffer(Oe,r_,!1),this._poleSouthVertexBuffer=F.createVertexBuffer(Fe,r_,!1),this._texturedPoleNorthVertexBuffer=F.createVertexBuffer(Ve,r_,!1),this._texturedPoleSouthVertexBuffer=F.createVertexBuffer(qe,r_,!1)}getGridBuffers(F,Ae){return[this._gridBuffer,this._gridIndexBuffer,Ae?this._gridSegments[F].withSkirts:this._gridSegments[F].withoutSkirts]}getPoleBuffers(F,Ae){return[Ae?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,Ae?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[F]]}},Ae.dx=V_,Ae.dy=K,Ae.dz=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},Ae.e=qc,Ae.e0=bp,Ae.e1=ut,Ae.e2=Qe,Ae.e3=Gf,Ae.e4=function(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi=1,bi,wi){F.createArrays(),F.tilePixelRatio=Vd/(512*F.overscaling),F.compareText={},F.iconsNeedLinear=!1;const dr=F.layers[0].layout,jr=F.layers[0]._unevaluatedLayout._values,Qr={};Qr.scaleFactor=xi,Qr.textSizeScaleRange=dr.get("text-size-scale-range"),Qr.iconSizeScaleRange=dr.get("icon-size-scale-range");const[Xn,ho]=Qr.textSizeScaleRange,[yo,zo]=Qr.iconSizeScaleRange;if(Qr.textScaleFactor=Q(Qr.scaleFactor,Xn,ho),Qr.iconScaleFactor=Q(Qr.scaleFactor,yo,zo),"composite"===F.textSizeData.kind){const{minZoom:Ae,maxZoom:Oe}=F.textSizeData;Qr.compositeTextSizes=[jr["text-size"].possiblyEvaluate(new Ca(Ae),vt),jr["text-size"].possiblyEvaluate(new Ca(Oe),vt)]}if("composite"===F.iconSizeData.kind){const{minZoom:Ae,maxZoom:Oe}=F.iconSizeData;Qr.compositeIconSizes=[jr["icon-size"].possiblyEvaluate(new Ca(Ae),vt),jr["icon-size"].possiblyEvaluate(new Ca(Oe),vt)]}Qr.layoutTextSize=jr["text-size"].possiblyEvaluate(new Ca(zt+1),vt),Qr.layoutIconSize=jr["icon-size"].possiblyEvaluate(new Ca(zt+1),vt),Qr.textMaxSize=jr["text-size"].possiblyEvaluate(new Ca(18),vt);const ko="map"===dr.get("text-rotation-alignment")&&"point"!==dr.get("symbol-placement"),Uo=dr.get("text-size");let ia=!1;for(const Ae of F.features)if(Ae.icon&&Ae.icon.nameSecondary){ia=!0;break}for(const qe of F.features){const zt=dr.get("text-font").evaluate(qe,{},vt).join(","),xi=Uo.evaluate(qe,{},vt)*Qr.textScaleFactor,Xn=Qr.layoutTextSize.evaluate(qe,{},vt)*Qr.textScaleFactor,ho=(Qr.layoutIconSize.evaluate(qe,{},vt),{horizontal:{},vertical:void 0}),yo=qe.text;let zo,_a=[0,0];if(yo){const Fe=yo.toString(),pt=dr.get("text-letter-spacing").evaluate(qe,{},vt)*ky,ri=dr.get("text-line-height").evaluate(qe,{},vt)*ky,bi=da(Fe)?pt:0,wi=dr.get("text-anchor").evaluate(qe,{},vt),jr=dr.get("text-variable-anchor");if(!jr){const F=dr.get("text-radial-offset").evaluate(qe,{},vt);_a=F?hd(wi,[F*ky,wx]):dr.get("text-offset").evaluate(qe,{},vt).map((F=>F*ky))}let Qr=ko?"center":dr.get("text-justify").evaluate(qe,{},vt);const zo="point"===dr.get("symbol-placement"),Uo=zo?dr.get("text-max-width").evaluate(qe,{},vt)*ky:1/0,w=qe=>{F.allowVerticalPlacement&&fa(Fe)&&(ho.vertical=_f(yo,Ae,Oe,Ve,zt,Uo,ri,wi,qe,bi,_a,cx.vertical,!0,Xn,xi))};if(!ko&&jr){const F="auto"===Qr?jr.map((F=>pd(F))):[Qr];let Fe=!1;for(let qe=0;qe<F.length;qe++){const pt=F[qe];if(!ho.horizontal[pt])if(Fe)ho.horizontal[pt]=ho.horizontal[0];else{const F=_f(yo,Ae,Oe,Ve,zt,Uo,ri,"center",pt,bi,_a,cx.horizontal,!1,Xn,xi);F&&(ho.horizontal[pt]=F,Fe=1===F.positionedLines.length)}}w("left")}else{if("auto"===Qr&&(Qr=pd(wi)),zo||dr.get("text-writing-mode").indexOf("horizontal")>=0||!fa(Fe)){const F=_f(yo,Ae,Oe,Ve,zt,Uo,ri,wi,Qr,bi,_a,cx.horizontal,!1,Xn,xi);F&&(ho.horizontal[Qr]=F)}w(zo?"left":Qr)}}let Ma=!1;if(qe.icon&&qe.icon.namePrimary){const Ae=Wp(F.iconSizeData,jr["icon-size"],vt,F.zoom,qe)*Qr.iconScaleFactor*bi,Oe=qe.icon.getPrimary().scaleSelf(Ae).serialize(),pt=Fe[Oe];pt&&(zo=Tf(Ve[Oe],qe.icon.nameSecondary?Ve[qe.icon.getSecondary().scaleSelf(Ae).serialize()]:void 0,dr.get("icon-offset").evaluate(qe,{},vt),dr.get("icon-anchor").evaluate(qe,{},vt)),Ma=pt.sdf,void 0===F.sdfIcons?F.sdfIcons=pt.sdf:F.sdfIcons!==pt.sdf&&ft("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(pt.pixelRatio!==F.pixelRatio||0!==dr.get("icon-rotate").constantOr(1))&&(F.iconsNeedLinear=!0))}const Ea=gd(ho.horizontal)||ho.vertical;F.iconsInText||(F.iconsInText=!!Ea&&Ea.iconsInText),(Ea||zo)&&fd(F,qe,ho,zo,Fe,Qr,Xn,0,_a,Ma,pt,vt,ri,wi,ia)}qe&&F.generateCollisionDebugBuffers(zt,F.collisionBoxArray,Qr.textScaleFactor)},Ae.e5=Lg,Ae.e6=j,Ae.e7=ph,Ae.e8=hf,Ae.e9=e,Ae.ea=function(F){let Ae=0;if(new Uint32Array(F,0,1)[0]!==jb){const Oe=new Uint32Array(F,0,7),[,,Fe,Ve,qe,pt]=Oe;Ae=Oe.byteLength+Ve+qe+pt+qe,(Fe!==F.byteLength||Ae>=F.byteLength)&&ft("Invalid b3dm header information.")}return Kx(F,Ae)},Ae.eb=function(F,Ae){const Oe=av(F);for(const F of Oe){for(const Ae of F.meshes)sv(Ae);F.lights&&(F.lightMeshIndex=F.meshes.length,F.meshes.push(ov(F.lights,Ae)))}return Oe},Ae.ec=yy,Ae.ed=Ay,Ae.ee=uf,Ae.ef=function(F){Gt(),null!=oh&&oh.then((Ae=>{Ae.keys().then((Oe=>{for(let Fe=0;Fe<Oe.length-F;Fe++)Ae.delete(Oe[Fe])}))}))},Ae.f=function(F){return 0===F.indexOf("mapbox:")},Ae.g=function(F,Ae){return ne(nt(F,{method:"GET"}),Ae)},Ae.h=It,Ae.i=function(F){return qc.API_STYLE_REGEX.test(F)&&!Pt(F)},Ae.j=function(F){return decodeURIComponent(atob(F).split("").map((F=>"%"+("00"+F.charCodeAt(0).toString(16)).slice(-2))).join(""))},Ae.k=function(F){return btoa(encodeURIComponent(F).replace(/%([0-9A-F]{2})/g,((F,Ae)=>String.fromCharCode(Number("0x"+Ae)))))},Ae.l=nt,Ae.m=lh,Ae.n=function(F,Ae){return ne(nt(F,{type:"json"}),Ae)},Ae.o=ue,Ae.p=function(F,Ae){return ne(nt(F,{method:"POST"}),Ae)},Ae.q=eh,Ae.r=sc,Ae.s=function(F){try{const Ae=self[F];return Ae.setItem("_mapbox_test_",1),Ae.removeItem("_mapbox_test_"),!0}catch(F){return!1}},Ae.t=Vt,Ae.u=function(){return function t(F){return F?(F^Math.random()*(16>>F/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()},Ae.v=function(F){return!!F&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(F)},Ae.w=ft,Ae.x=function(){return Kv||(Kv=new Py),Kv},Ae.y=ve,Ae.z=xe}));define(["./shared"],(function(Ae){function t(F){const Ae=F?F.url.toString():void 0;return Ae?performance.getEntriesByName(Ae):[]}function s(F){if("number"==typeof F||"boolean"==typeof F||"string"==typeof F||null==F)return JSON.stringify(F);if(Array.isArray(F)){let Ae="[";for(const Oe of F)Ae+=`${s(Oe)},`;return`${Ae}]`}let Ae="{";for(const Oe of Object.keys(F).sort())Ae+=`${Oe}:${s(F[Oe])},`;return`${Ae}}`}function i(F){let Oe="";for(const Fe of Ae.bm)("model"!==F.type||"minzoom"!==Fe&&"maxzoom"!==Fe)&&(Oe+=`/${s(F[Fe])}`);return Oe}class o{constructor(F){this.keyCache={},this._layers={},this._layerConfigs={},F&&this.replace(F)}replace(F,Ae){this._layerConfigs={},this._layers={},this.update(F,[],Ae)}update(F,Oe,Fe){this._options=Fe;for(const Oe of F)this._layerConfigs[Oe.id]=Oe,(this._layers[Oe.id]=Ae.cu(Oe,this.scope,null,this._options)).compileFilter(Fe),this.keyCache[Oe.id]&&delete this.keyCache[Oe.id];for(const F of Oe)delete this.keyCache[F],delete this._layerConfigs[F],delete this._layers[F];this.familiesBySource={};const Ve=function(F,Ae){const Oe={};for(let Fe=0;Fe<F.length;Fe++){const Ve=F[Fe];let qe=Ae&&Ae[Ve.id];!qe&&(qe=i(Ve),"line"===Ve.type&&Ve.paint)&&function e(F){return"string"==typeof F&&"line-progress"===F||(Array.isArray(F)?F.some(e):!(!F||"object"!=typeof F)&&Object.values(F).some(e))}(Ve.paint["line-width"])&&(qe+=`/${s(Ve.paint["line-width"])}`),Ae&&(Ae[Ve.id]=qe);let pt=Oe[qe];pt||(pt=Oe[qe]=[]),pt.push(Ve)}const Fe=[];for(const F in Oe)Fe.push(Oe[F]);return Fe}(Ae.bj(this._layerConfigs),this.keyCache);for(const F of Ve){const Ae=F.map((F=>this._layers[F.id])),Oe=Ae[0];if("none"===Oe.visibility)continue;const Fe=Oe.source||"";let Ve=this.familiesBySource[Fe];Ve||(Ve=this.familiesBySource[Fe]={});const qe=Oe.sourceLayer||"_geojsonTileLayer";let pt=Ve[qe];pt||(pt=Ve[qe]=[]),pt.push(Ae)}}}const Oe=1*Ae.dX;class n{constructor(F){const Fe={},Ve=[];for(const Ae in F){const qe=F[Ae],pt=Fe[Ae]={};for(const F in qe.glyphs){const Ae=qe.glyphs[+F];if(!Ae||0===Ae.bitmap.width||0===Ae.bitmap.height)continue;const Fe=Ae.metrics.localGlyph?Oe:1,vt={x:0,y:0,w:Ae.bitmap.width+2*Fe,h:Ae.bitmap.height+2*Fe};Ve.push(vt),pt[F]=vt}}const{w:qe,h:pt}=Ae.F(Ve),vt=new Ae.dW({width:qe||1,height:pt||1});for(const Ve in F){const qe=F[Ve];for(const F in qe.glyphs){const pt=qe.glyphs[+F];if(!pt||0===pt.bitmap.width||0===pt.bitmap.height)continue;const zt=Fe[Ve][F],ri=pt.metrics.localGlyph?Oe:1;Ae.dW.copy(pt.bitmap,vt,{x:0,y:0},{x:zt.x+ri,y:zt.y+ri},pt.bitmap)}}this.image=vt,this.positions=Fe}}Ae.dV(n,"GlyphAtlas");const Fe="3d_elevation_id",Ve="hd_road_elevation";class c{constructor(){this._valid=!1}reset(F){return this.feature=F,this._valid=!0,this._geometry=F.loadGeometry(),0!==this._geometry.length&&0!==this._geometry[0].length||(this._valid=!1),this}geometry(F,Ae){return this._valid&&F(Ae(this._geometry)),this}require(F,Ae,Oe){return this.get(F,!0,Ae,Oe)}optional(F,Ae,Oe){return this.get(F,!1,Ae,Oe)}success(){return this._valid}get(F,Ae,Oe,Fe){const Ve=this.feature.properties.hasOwnProperty(F)?+this.feature.properties[F]:void 0;return this._valid&&void 0!==Ve?Oe(Fe?Fe(Ve):Ve):Ae&&(this._valid=!1),this}}class h{constructor(F,Ae){this.featureFunc=F,this.vertexFunc=Ae}parseFeature(F,Ae,Oe){return this.featureFunc(F,Ae,Oe)}parseVertex(F,Ae,Oe){return this.vertexFunc(F,Ae,Oe)}}const qe=new h(((F,Ae,Oe)=>F.reset(Ae).require(Fe,(F=>{Oe.id=F})).optional("fixed_height_relative",(F=>{Oe.constantHeight=F}),p.decodeRelativeHeight).geometry((F=>{Oe.bounds=F}),p.computeBounds).success()),((F,Ae,Oe)=>F.reset(Ae).require(Fe,(F=>{Oe.id=F})).require("elevation_idx",(F=>{Oe.idx=F})).require("extent",(F=>{Oe.extent=F})).require("height_relative",(F=>{Oe.height=F}),p.decodeRelativeHeight).geometry((F=>{Oe.position=F}),p.getPoint).success())),pt=new h(((F,Ae,Oe)=>F.reset(Ae).require(Fe,(F=>{Oe.id=F})).optional("fixed_height",(F=>{Oe.constantHeight=F}),p.decodeMetricHeight).geometry((F=>{Oe.bounds=F}),p.computeBounds).success()),((F,Ae,Oe)=>F.reset(Ae).require(Fe,(F=>{Oe.id=F})).require("elevation_idx",(F=>{Oe.idx=F})).require("extent",(F=>{Oe.extent=F})).require("height",(F=>{Oe.height=F}),p.decodeMetricHeight).geometry((F=>{Oe.position=F}),p.getPoint).success()));class p{static computeBounds(F){const Oe=new Ae.P(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Fe=new Ae.P(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const Ae of F[0])Oe.x>Ae.x&&(Oe.x=Ae.x),Oe.y>Ae.y&&(Oe.y=Ae.y),Fe.x<Ae.x&&(Fe.x=Ae.x),Fe.y<Ae.y&&(Fe.y=Ae.y);return{min:Oe,max:Fe}}static getPoint(F){return Ae.ab.vec2.fromValues(F[0][0].x,F[0][0].y)}static decodeRelativeHeight(F){return 1e-4*F*5}static decodeMetricHeight(F){return 1e-4*F}static parse(F){const Oe=[],Fe=[],Ve=F.length,vt=new c;for(let ri=0;ri<Ve;ri++){const Ve=F.feature(ri),xi=Ve.properties.hasOwnProperty("version")?String(Ve.properties.version):void 0,bi=(zt=xi)?"1.0.1"===zt?pt:void 0:qe;if(void 0===bi){Ae.w(`Unknown elevation feature version number ${xi||"(unknown)"}`);continue}const wi=Ve.properties.hasOwnProperty("type")?Ve.properties.type:void 0;if(wi)if("Point"===Ae.dY.VectorTileFeature.types[Ve.type]&&"curve_point"===wi){const F={};bi.parseVertex(vt,Ve,F)&&Oe.push(F)}else if("Polygon"===Ae.dY.VectorTileFeature.types[Ve.type]&&"curve_meta"===wi){const F={};bi.parseFeature(vt,Ve,F)&&Fe.push(F)}}var zt;return{vertices:Oe,features:Fe}}}class f{constructor(F,Oe,Fe,Ve,qe,pt){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=F,this.heightRange={min:Fe,max:Fe},this.safeArea=Oe,this.constantHeight=Fe,null==this.constantHeight&&(null!=this.constantHeight||0!==Ve.length)){this.vertices=Ve,this.edges=qe,this.edges=this.edges.filter((F=>F.a<this.vertices.length&&F.b<this.vertices.length&&!Ae.ab.vec2.exactEquals(this.vertices[F.a].position,this.vertices[F.b].position))),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const F of this.vertices)this.vertexProps.push({dir:Ae.ab.vec2.fromValues(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,F.height),this.heightRange.max=Math.max(this.heightRange.max,F.height);for(const F of this.edges){const Oe=this.vertices[F.a].position,Fe=this.vertices[F.b].position,Ve=Ae.ab.vec2.subtract(Ae.ab.vec2.create(),Fe,Oe),qe=Ae.ab.vec2.length(Ve),pt=Ae.ab.vec2.scale(Ae.ab.vec2.create(),Ve,1/qe);this.edgeProps.push({vec:Ve,dir:pt,len:qe});const vt=this.vertexProps[F.a].dir,zt=this.vertexProps[F.b].dir;Ae.ab.vec2.add(vt,vt,pt),Ae.ab.vec2.add(zt,zt,pt)}for(const F of this.vertexProps)0===F.dir[0]&&0===F.dir[1]||Ae.ab.vec2.normalize(F.dir,F.dir);this.tessellate(pt)}}pointElevation(F){if(null!=this.constantHeight)return this.constantHeight;const Ae=this.getClosestEdge(F);if(null==Ae)return 0;const[Oe,Fe]=Ae;return(1-(Ve=Fe))*this.vertices[this.edges[Oe].a].height+Ve*this.vertices[this.edges[Oe].b].height;var Ve}getClosestEdge(F){if(0===this.edges.length)return;let Oe=0,Fe=Number.POSITIVE_INFINITY,Ve=0;const qe=Ae.ab.vec2.fromValues(F.x,F.y);for(let F=0;F<this.edges.length;F++){const pt=this.edges[F],vt=this.edgeProps[F].dir,zt=new Ae.dZ(qe,this.edgeProps[F].dir),ri=this.vertices[pt.a].position,xi=this.vertices[pt.b].position,bi=Ae.ab.vec2.create(),wi=Ae.ab.vec2.create(),dr=zt.intersectsPlane(ri,this.vertexProps[pt.a].dir,bi),jr=zt.intersectsPlane(xi,this.vertexProps[pt.b].dir,wi);if(!dr||!jr)continue;const Qr=Ae.ab.vec2.subtract(Ae.ab.vec2.create(),wi,bi),Xn=Ae.ab.vec2.subtract(Ae.ab.vec2.create(),qe,bi),ho=Ae.ab.vec2.dot(Qr,Qr),yo=ho>0?Ae.ab.vec2.dot(Xn,Qr)/ho:0,zo=Ae.aw(yo,0,1),ko=Math.abs((yo-zo)*this.edgeProps[F].len),Uo=Ae.ab.vec2.subtract(Ae.ab.vec2.create(),qe,ri),ia=ko+Math.abs(Ae.ab.vec2.dot(Uo,Ae.ab.vec2.fromValues(vt[1],-vt[0])));ia<Fe&&(Oe=F,Fe=ia,Ve=zo)}return[Oe,Ve]}tessellate(F){for(let Oe=this.edges.length-1;Oe>=0;--Oe){const Fe=this.edges[Oe].a,Ve=this.edges[Oe].b,{position:qe,height:pt,extent:vt}=this.vertices[Fe],{position:zt,height:ri,extent:xi}=this.vertices[Ve],bi=this.vertexProps[Fe].dir,wi=this.vertexProps[Ve].dir,dr=Ae.ab.vec3.fromValues(qe[0]/F,qe[1]/F,pt),jr=Ae.ab.vec3.fromValues(zt[0]/F,zt[1]/F,ri),Qr=Ae.ab.vec3.fromValues(bi[1],-bi[0],0);Ae.ab.vec3.scale(Qr,Qr,vt);const Xn=Ae.ab.vec3.fromValues(wi[1],-wi[0],0);if(Ae.ab.vec3.scale(Xn,Xn,xi),this.distSqLines(Ae.ab.vec3.fromValues(dr[0]+.5*Qr[0],dr[1]+.5*Qr[1],dr[2]+.5*Qr[2]),Ae.ab.vec3.fromValues(jr[0]-.5*Xn[0],jr[1]-.5*Xn[1],jr[2]-.5*Xn[2]),Ae.ab.vec3.fromValues(dr[0]-.5*Qr[0],dr[1]-.5*Qr[1],dr[2]-.5*Qr[2]),Ae.ab.vec3.fromValues(jr[0]+.5*Xn[0],jr[1]+.5*Xn[1],jr[2]+.5*Xn[2]))<=.05*.05)continue;const ho=this.vertices.length,yo=Ae.ab.vec2.add(Ae.ab.vec2.create(),qe,zt);this.vertices.push({position:Ae.ab.vec2.scale(yo,yo,.5),height:.5*(pt+ri),extent:.5*(vt+xi)});const zo=Ae.ab.vec2.add(Ae.ab.vec2.create(),bi,wi);this.vertexProps.push({dir:Ae.ab.vec2.normalize(zo,zo)}),this.edges.splice(Oe,1),this.edgeProps.splice(Oe,1),this.edges.push({a:Fe,b:ho}),this.edges.push({a:ho,b:Ve});const ko=Ae.ab.vec2.subtract(Ae.ab.vec2.create(),this.vertices[ho].position,qe),Uo=Ae.ab.vec2.length(ko),ia={vec:ko,dir:Ae.ab.vec2.scale(Ae.ab.vec2.create(),ko,1/Uo),len:Uo};this.edgeProps.push(ia),this.edgeProps.push(ia)}}distSqLines(F,Oe,Fe,Ve){const qe=Ae.ab.vec3.subtract(Ae.ab.vec3.create(),Oe,F),pt=Ae.ab.vec3.subtract(Ae.ab.vec3.create(),Ve,Fe),vt=Ae.ab.vec3.subtract(Ae.ab.vec3.create(),F,Fe),zt=Ae.ab.vec3.dot(qe,qe),ri=Ae.ab.vec3.dot(qe,pt),xi=Ae.ab.vec3.dot(qe,vt),bi=Ae.ab.vec3.dot(pt,pt),wi=Ae.ab.vec3.dot(pt,vt),dr=zt*bi-ri*ri;if(0===dr){const Oe=Ae.ab.vec3.dot(vt,pt)/Ae.ab.vec3.dot(pt,pt),qe=Ae.ab.vec3.lerp(Ae.ab.vec3.create(),Fe,Ve,Oe);return Ae.ab.vec3.squaredDistance(qe,F)}const jr=(ri*wi-xi*bi)/dr,Qr=(zt*wi-ri*xi)/dr,Xn=Ae.ab.vec3.lerp(Ae.ab.vec3.create(),F,Oe,jr),ho=Ae.ab.vec3.lerp(Ae.ab.vec3.create(),Fe,Ve,Qr);return Ae.ab.vec3.squaredDistance(Xn,ho)}}class g{static parseFrom(F,Oe){const Fe=p.parse(F);if(!Fe)return[];let{vertices:Ve,features:qe}=Fe;const pt=1/Ae.cc(Oe);qe.sort(((F,Ae)=>F.id-Ae.id)),Ve.sort(((F,Ae)=>F.id-Ae.id||F.idx-Ae.idx)),Ve=Ve.filter(((F,Ae,Oe)=>Ae===Oe.findIndex((Ae=>Ae.id===F.id&&Ae.idx===F.idx))));const vt=new Array;let zt=0;const ri=Ve.length;for(const F of qe){if(F.constantHeight){vt.push(new f(F.id,F.bounds,F.constantHeight));continue}for(;zt!==ri&&Ve[zt].id<F.id;)zt++;if(zt===ri||Ve[zt].id!==F.id)continue;const Ae=new Array,Oe=new Array,Fe=zt;for(;zt!==ri&&Ve[zt].id===F.id;){const F=Ve[zt];if(Ae.push({position:F.position,height:F.height,extent:F.extent}),zt!==Fe&&Ve[zt-1].idx===F.idx-1){const F=zt-Fe;Oe.push({a:F-1,b:F})}zt++}vt.push(new f(F.id,F.bounds,void 0,Ae,Oe,pt))}return vt}}Ae.dV(f,"ElevationFeature");class m{constructor(F){this.tileID=new Ae.aG(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.lut=F.lut,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.scope=F.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=F.showCollisionBoxes,this.collectResourceTiming=!!F.request&&F.request.collectResourceTiming,this.promoteId=F.promoteId,this.isSymbolTile=F.isSymbolTile,this.tileTransform=Ae.aQ(F.tileID.canonical,F.projection),this.projection=F.projection,this.worldview=F.worldview,this.localizableLayerIds=F.localizableLayerIds,this.brightness=F.brightness,this.extraShadowCaster=!!F.extraShadowCaster,this.tessellationStep=F.tessellationStep,this.scaleFactor=F.scaleFactor}parse(F,Oe,qe,pt,vt){this.status="parsing",this.data=F,this.collisionBoxArray=new Ae.aW;const zt=new Ae.d_(Object.keys(F.layers).sort()),ri=new Ae.d$(this.tileID,this.promoteId);ri.bucketLayerIDs=[];const xi={},bi=new Ae.e0(256,256),wi={featureIndex:ri,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:bi,availableImages:qe,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},dr=Oe.familiesBySource[this.source];for(const Oe in dr){const pt=F.layers[Oe];if(!pt)continue;let vt=!1,bi=!1,jr=!1;for(const F of dr[Oe])"symbol"===F[0].type?vt=!0:bi=!0,F[0].is3D()&&"model"!==F[0].type&&(jr=!0);if(this.extraShadowCaster&&!jr)continue;if(!0===this.isSymbolTile&&!vt)continue;if(!1===this.isSymbolTile&&!bi)continue;1===pt.version&&Ae.w(`Vector tile source "${this.source}" layer "${Oe}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Qr=zt.encode(Oe),Xn=[];let ho=!1;for(let F=0,Ae=0;F<pt.length;F++){const Ve=pt.feature(F),qe=ri.getId(Ve,Oe);if(this.localizableLayerIds&&this.localizableLayerIds.has(Oe)){const F=Ve.properties?Ve.properties.worldview:null;if(this.worldview&&"string"==typeof F)if("all"===F)Ve.properties.$localized=!0;else{if(!F.split(",").includes(this.worldview))continue;Ve.properties.$localized=!0,Ve.properties.worldview=this.worldview}}!ho&&Ve.properties&&Ve.properties.hasOwnProperty(Fe)&&(ho=!0),Xn.push({feature:Ve,id:qe,index:Ae,sourceLayerIndex:Qr}),Ae++}ho&&F.layers.hasOwnProperty(Ve)&&(wi.elevationFeatures=g.parseFrom(F.layers[Ve],this.canonical));for(const F of dr[Oe]){const Oe=F[0];(!this.extraShadowCaster||Oe.is3D()&&"model"!==Oe.type)&&(void 0!==this.isSymbolTile&&"symbol"===Oe.type!==this.isSymbolTile||Oe.minzoom&&this.zoom<Math.floor(Oe.minzoom)||Oe.maxzoom&&this.zoom>=Oe.maxzoom||"none"!==Oe.visibility&&(y(F,this.zoom,wi.brightness,qe),(xi[Oe.id]=Oe.createBucket({index:ri.bucketLayerIDs.length,layers:F,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Qr,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(Xn,wi,this.tileID.canonical,this.tileTransform),ri.bucketLayerIDs.push(F.map((F=>Ae.aC(F.id,F.scope))))))}}let jr,Qr,Xn,ho;bi.trim();const yo={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},I=()=>{if(jr)return this.status="done",vt(jr);if(this.extraShadowCaster)this.status="done",vt(null,{buckets:Ae.bj(xi).filter((F=>!F.isEmpty())),featureIndex:ri,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:wi.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Qr&&Xn&&ho){const F=new n(Qr),Oe=new Ae.e3(Xn,ho,this.lut);for(const Fe in xi){const Ve=xi[Fe];Ve instanceof Ae.aX?(y(Ve.layers,this.zoom,wi.brightness,qe),Ae.e4(Ve,Qr,F.positions,Xn,Oe.iconPositions,this.showCollisionBoxes,qe,this.tileID.canonical,this.tileZoom,this.projection,this.scaleFactor,this.pixelRatio,this.brightness)):Ve.hasPattern&&(Ve instanceof Ae.b1||Ve instanceof Ae.b2||Ve instanceof Ae.d5)&&(y(Ve.layers,this.zoom,wi.brightness,qe),Ve.addFeatures(wi,this.tileID.canonical,Oe.patternPositions,qe,this.tileTransform,this.brightness))}this.status="done",vt(null,{buckets:Ae.bj(xi).filter((F=>!F.isEmpty())),featureIndex:ri,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:F.image,lineAtlas:bi,imageAtlas:Oe,brightness:wi.brightness})}};if(!this.extraShadowCaster){const F=Ae.e1(wi.glyphDependencies,(F=>Object.keys(F).map(Number)));Object.keys(F).length?pt.send("getGlyphs",{uid:this.uid,stacks:F,scope:this.scope},((F,Ae)=>{jr||(jr=F,Qr=Ae,I())}),void 0,!1,yo):Qr={};const Oe=Object.keys(wi.iconDependencies);Oe.length?pt.send("getImages",{icons:Oe,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((F,Ae)=>{if(jr)return;jr=F;const Oe={};Object.values(Ae).some((F=>F.usvg))?this.rasterize(pt,Oe,Ae,wi.iconDependencies,(()=>{Xn=Oe,I()})):(this.fillImageMap(Oe,wi.iconDependencies,Ae),Xn=Oe,I())}),void 0,!1,yo):Xn={};const Fe=Object.keys(wi.patternDependencies);Fe.length?pt.send("getImages",{icons:Fe,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((F,Ae)=>{if(!jr){jr=F;const Oe={};Object.values(Ae).some((F=>F.usvg))?this.rasterize(pt,Oe,Ae,wi.patternDependencies,(()=>{ho=Oe,I()})):(this.fillImageMap(Oe,wi.patternDependencies,Ae),ho=Oe,I())}}),void 0,!1,yo):ho={}}I()}fillImageMap(F,Ae,Oe){for(const Fe in Oe){const Ve=Ae[Fe]||[];for(const Ae of Ve)Oe[Ae.id].usvg||(F[Ae.serialize()]=Oe[Ae.id])}}getImageTaskQueue(F,Ae,Oe){const Fe={};for(const Ve in Ae){const qe=Oe[Ve]||[];for(const Oe of qe){const Ve=Oe.serialize();Ae[Oe.id].usvg?Fe[Ve]||(Fe[Ve]=Oe):F[Ve]=Ae[Oe.id]}}return Fe}rasterize(F,Oe,Fe,Ve,qe){const pt=this.getImageTaskQueue(Oe,Fe,Ve);this.rasterizeTask=F.send("rasterizeImages",{scope:this.scope,imageTasks:pt},((F,Ve)=>{if(!F)for(const F in Ve){const{id:qe}=Ae.e2.deserializeFromString(F);Oe[F]=Object.assign({},Fe[qe],{data:Ve[F]})}qe()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function y(F,Oe,Fe,Ve){const qe=new Ae.a8(Oe,{brightness:Fe});for(const Ae of F)Ae.recalculate(qe,Ve)}class v extends Ae.E{constructor(F,Oe,Fe,Ve,qe,pt){super(),this.actor=F,this.layerIndex=Oe,this.availableImages=Fe,this.loadVectorData=qe||Ae.aD,this.loading={},this.loaded={},this.deduped=new Ae.aB(F.scheduler),this.isSpriteLoaded=Ve,this.scheduler=F.scheduler,this.brightness=pt}loadTile(F,Oe){const Fe=F.uid,Ve=F&&F.request,qe=Ve&&Ve.collectResourceTiming,pt=this.loading[Fe]=new m(F);pt.abort=this.loadVectorData(F,((vt,zt)=>{const ri=!this.loading[Fe];if(delete this.loading[Fe],pt.cancelRasterize(),ri||vt||!zt)return pt.status="done",ri||(this.loaded[Fe]=pt),Oe(vt);const xi=zt.rawData,bi={};zt.expires&&(bi.expires=zt.expires),zt.cacheControl&&(bi.cacheControl=zt.cacheControl),pt.vectorTile=zt.vectorTile||new Ae.dY.VectorTile(new Ae.bh(xi));const p=()=>{pt.parse(pt.vectorTile,this.layerIndex,this.availableImages,this.actor,((F,Fe)=>{if(F||!Fe)return Oe(F);const pt={};if(qe){const F=t(Ve);F.length>0&&(pt.resourceTiming=JSON.parse(JSON.stringify(F)))}Oe(null,Ae.l({rawTileData:xi.slice(0)},Fe,bi,pt))}))};this.isSpriteLoaded?p():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(p,{type:"parseTile",isSymbolTile:F.isSymbolTile,zoom:F.tileZoom}):p()})),this.loaded=this.loaded||{},this.loaded[Fe]=pt}))}reloadTile(F,Oe){const Fe=this.loaded,Ve=F.uid;if(Fe&&Fe[Ve]){const qe=Fe[Ve];qe.scaleFactor=F.scaleFactor,qe.showCollisionBoxes=F.showCollisionBoxes,qe.projection=F.projection,qe.brightness=F.brightness,qe.tileTransform=Ae.aQ(F.tileID.canonical,F.projection),qe.extraShadowCaster=F.extraShadowCaster,qe.lut=F.lut;const n=(F,Ae)=>{const Fe=qe.reloadCallback;Fe&&(delete qe.reloadCallback,qe.parse(qe.vectorTile,this.layerIndex,this.availableImages,this.actor,Fe)),Oe(F,Ae)};"parsing"===qe.status?qe.reloadCallback=n:"done"===qe.status&&(qe.vectorTile?qe.parse(qe.vectorTile,this.layerIndex,this.availableImages,this.actor,n):n())}else Oe(null,void 0)}abortTile(F,Ae){const Oe=F.uid,Fe=this.loading[Oe];Fe&&(Fe.abort&&Fe.abort(),delete this.loading[Oe]),Ae()}removeTile(F,Ae){const Oe=this.loaded,Fe=F.uid;Oe&&Oe[Fe]&&delete Oe[Fe],Ae()}}class b{loadTile(F,Oe){const{uid:Fe,encoding:Ve,rawImageData:qe,padding:pt}=F,vt=ImageBitmap&&qe instanceof ImageBitmap?this.getImageData(qe,pt):qe;Oe(null,new Ae.e5(Fe,vt,Ve,pt<1))}getImageData(F,Ae){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(F.width,F.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=F.width,this.offscreenCanvas.height=F.height,this.offscreenCanvasContext.drawImage(F,0,0,F.width,F.height);const Oe=this.offscreenCanvasContext.getImageData(-Ae,-Ae,F.width+2*Ae,F.height+2*Ae);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Oe}}Ae.bg.setPbf(Ae.bh);class x{decodeRasterArray({task:F,buffer:Oe},Fe){Ae.bg.performDecoding(Oe,F).then((F=>{Fe(null,F)}),(F=>{Fe(F)}))}}const vt=Ae.dY.VectorTileFeature.prototype.toGeoJSON;class I{constructor(F){this._feature=F,this.extent=Ae.ag,this.type=F.type,this.properties=F.tags,"id"in F&&!isNaN(F.id)&&(this.id=parseInt(F.id,10))}loadGeometry(){if(1===this._feature.type){const F=[];for(const Oe of this._feature.geometry)F.push([new Ae.P(Oe[0],Oe[1])]);return F}{const F=[];for(const Oe of this._feature.geometry){const Fe=[];for(const F of Oe)Fe.push(new Ae.P(F[0],F[1]));F.push(Fe)}return F}}toGeoJSON(F,Ae,Oe){return vt.call(this,F,Ae,Oe)}}class S{constructor(F){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=Ae.ag,this.length=F.length,this._features=F}feature(F){return new I(this._features[F])}}const zt=64/4096,ri=128;class T{constructor(){this.features=new Map}clear(){this.features.clear()}load(F=[],Ae){for(const Oe of F){const F=Oe.id;if(null==F)continue;let Fe=this.features.get(F);Fe&&this.updateCache(Fe,Ae),Oe.geometry?(Fe=_(Oe),this.updateCache(Fe,Ae),this.features.set(F,Fe)):this.features.delete(F),this.updateCache(Fe,Ae)}}updateCache(F,Ae){for(const{canonical:Oe,uid:Fe}of Object.values(Ae)){const{z:Ve,x:qe,y:pt}=Oe;k(F,Math.pow(2,Ve),qe,pt)&&delete Ae[Fe]}}getTile(F,Ae,Oe){const Fe=Math.pow(2,F),Ve=[];for(const F of this.features.values())k(F,Fe,Ae,Oe)&&Ve.push(D(F,Fe,Ae,Oe));return{features:Ve}}getFeatures(){return[...this.features.values()]}}function k({minX:F,minY:Ae,maxX:Oe,maxY:Fe},Ve,qe,pt){return F<(qe+1+zt)/Ve&&Ae<(pt+1+zt)/Ve&&Oe>(qe-zt)/Ve&&Fe>(pt-zt)/Ve}function _(F){const{id:Ae,geometry:Oe,properties:Fe}=F;if(!Oe)return;if("GeometryCollection"===Oe.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:Ve,coordinates:qe}=Oe,pt={id:Ae,type:1,geometry:[],tags:Fe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},vt=pt.geometry;if("Point"===Ve)C(qe,vt,pt);else if("MultiPoint"===Ve)for(const F of qe)C(F,vt,pt);else if("LineString"===Ve)pt.type=2,z(qe,vt,pt);else if("MultiLineString"===Ve)pt.type=2,L(qe,vt,pt);else if("Polygon"===Ve)pt.type=3,L(qe,vt,pt,!0);else{if("MultiPolygon"!==Ve)throw new Error("Input data is not a valid GeoJSON object.");pt.type=3;for(const F of qe)L(F,vt,pt,!0)}return pt}function C([F,Oe],Fe,Ve){const qe=Ae.at(F);let pt=Ae.aA(Oe);pt=pt<0?0:pt>1?1:pt,Fe.push(qe,pt),Ve.minX=Math.min(Ve.minX,qe),Ve.minY=Math.min(Ve.minY,pt),Ve.maxX=Math.max(Ve.maxX,qe),Ve.maxY=Math.max(Ve.maxY,pt)}function z(F,Ae,Oe,Fe=!1,Ve=!1){const qe=[];for(const Ae of F)C(Ae,qe,Oe);Ae.push(qe),Fe&&function(F,Ae){let Oe=0;for(let Ae=0,Fe=F.length,Ve=Fe-2;Ae<Fe;Ve=Ae,Ae+=2)Oe+=(F[Ae]-F[Ve])*(F[Ae+1]+F[Ve+1]);if(Oe>0===Ae)for(let Ae=0,Oe=F.length;Ae<Oe/2;Ae+=2){const Fe=F[Ae],Ve=F[Ae+1];F[Ae]=F[Oe-2-Ae],F[Ae+1]=F[Oe-1-Ae],F[Oe-2-Ae]=Fe,F[Oe-1-Ae]=Ve}}(qe,Ve)}function L(F,Ae,Oe,Fe=!1){for(let Ve=0;Ve<F.length;Ve++)z(F[Ve],Ae,Oe,Fe,0===Ve)}function D(F,Oe,Fe,Ve){const{id:qe,type:pt,geometry:vt,tags:zt}=F,ri=[];if(1===pt)!function(F,Oe,Fe,Ve,qe){for(let pt=0;pt<F.length;pt+=2){const vt=Math.round(Ae.ag*(F[pt+0]*Oe-Fe)),zt=Math.round(Ae.ag*(F[pt+1]*Oe-Ve));qe.push([vt,zt])}}(vt,Oe,Fe,Ve,ri);else for(const F of vt)O(F,Oe,Fe,Ve,ri);return{id:qe,type:pt,geometry:ri,tags:zt}}function O(F,Oe,Fe,Ve,qe){const pt=-ri,vt=Ae.ag+ri;let zt;for(let ri=0;ri<F.length-2;ri+=2){let xi=Math.round(Ae.ag*(F[ri+0]*Oe-Fe)),bi=Math.round(Ae.ag*(F[ri+1]*Oe-Ve)),wi=Math.round(Ae.ag*(F[ri+2]*Oe-Fe)),dr=Math.round(Ae.ag*(F[ri+3]*Oe-Ve));const jr=wi-xi,Qr=dr-bi;xi<pt&&wi<pt||(xi<pt?(bi+=Math.round(Qr*((pt-xi)/jr)),xi=pt):wi<pt&&(dr=bi+Math.round(Qr*((pt-xi)/jr)),wi=pt),bi<pt&&dr<pt||(bi<pt?(xi+=Math.round(jr*((pt-bi)/Qr)),bi=pt):dr<pt&&(wi=xi+Math.round(jr*((pt-bi)/Qr)),dr=pt),xi>=vt&&wi>=vt||(xi>=vt?(bi+=Math.round(Qr*((vt-xi)/jr)),xi=vt):wi>=vt&&(dr=bi+Math.round(Qr*((vt-xi)/jr)),wi=vt),bi>=vt&&dr>=vt||(bi>=vt?(xi+=Math.round(jr*((vt-bi)/Qr)),bi=vt):dr>=vt&&(wi=xi+Math.round(jr*((vt-bi)/Qr)),dr=vt),zt&&xi===zt[zt.length-1][0]&&bi===zt[zt.length-1][1]||(zt=[[xi,bi]],qe.push(zt)),zt.push([wi,dr])))))}}var xi,bi,wi,dr={exports:{}},jr=function(){if(wi)return dr.exports;wi=1;var Oe=Ae.e8(),Fe=function(){if(bi)return xi;bi=1;var Oe=Ae.e6(),Fe=Ae.e7().VectorTileFeature;function i(Ae,Oe){(this||F).options=Oe||{},(this||F).features=Ae,(this||F).length=Ae.length}function o(Ae,Oe){(this||F).id="number"==typeof Ae.id?Ae.id:void 0,(this||F).type=Ae.type,(this||F).rawGeometry=1===Ae.type?[Ae.geometry]:Ae.geometry,(this||F).properties=Ae.tags,(this||F).extent=Oe||4096}return xi=i,i.prototype.feature=function(Ae){return new o((this||F).features[Ae],(this||F).options.extent)},o.prototype.loadGeometry=function(){var Ae=(this||F).rawGeometry;(this||F).geometry=[];for(var Fe=0;Fe<Ae.length;Fe++){for(var Ve=Ae[Fe],qe=[],pt=0;pt<Ve.length;pt++)qe.push(new Oe(Ve[pt][0],Ve[pt][1]));(this||F).geometry.push(qe)}return(this||F).geometry},o.prototype.bbox=function(){(this||F).geometry||this.loadGeometry();for(var Ae=(this||F).geometry,Oe=1/0,Fe=-1/0,Ve=1/0,qe=-1/0,pt=0;pt<Ae.length;pt++)for(var vt=Ae[pt],zt=0;zt<vt.length;zt++){var ri=vt[zt];Oe=Math.min(Oe,ri.x),Fe=Math.max(Fe,ri.x),Ve=Math.min(Ve,ri.y),qe=Math.max(qe,ri.y)}return[Oe,Ve,Fe,qe]},o.prototype.toGeoJSON=Fe.prototype.toGeoJSON,xi}();function i(F){var Ae=new Oe;return function(F,Ae){for(var Oe in F.layers)Ae.writeMessage(3,o,F.layers[Oe])}(F,Ae),Ae.finish()}function o(F,Ae){var Oe;Ae.writeVarintField(15,F.version||1),Ae.writeStringField(1,F.name||""),Ae.writeVarintField(5,F.extent||4096);var Fe={keys:[],values:[],keycache:{},valuecache:{}};for(Oe=0;Oe<F.length;Oe++)Fe.feature=F.feature(Oe),Ae.writeMessage(2,r,Fe);var Ve=Fe.keys;for(Oe=0;Oe<Ve.length;Oe++)Ae.writeStringField(3,Ve[Oe]);var qe=Fe.values;for(Oe=0;Oe<qe.length;Oe++)Ae.writeMessage(4,h,qe[Oe])}function r(F,Ae){var Oe=F.feature;void 0!==Oe.id&&Ae.writeVarintField(1,Oe.id),Ae.writeMessage(2,n,F),Ae.writeVarintField(3,Oe.type),Ae.writeMessage(4,c,Oe)}function n(F,Ae){var Oe=F.feature,Fe=F.keys,Ve=F.values,qe=F.keycache,pt=F.valuecache;for(var vt in Oe.properties){var zt=Oe.properties[vt],ri=qe[vt];if(null!==zt){void 0===ri&&(Fe.push(vt),qe[vt]=ri=Fe.length-1),Ae.writeVarint(ri);var xi=typeof zt;"string"!==xi&&"boolean"!==xi&&"number"!==xi&&(zt=JSON.stringify(zt));var bi=xi+":"+zt,wi=pt[bi];void 0===wi&&(Ve.push(zt),pt[bi]=wi=Ve.length-1),Ae.writeVarint(wi)}}}function a(F,Ae){return(Ae<<3)+(7&F)}function l(F){return F<<1^F>>31}function c(F,Ae){for(var Oe=F.loadGeometry(),Fe=F.type,Ve=0,qe=0,pt=Oe.length,vt=0;vt<pt;vt++){var zt=Oe[vt],ri=1;1===Fe&&(ri=zt.length),Ae.writeVarint(a(1,ri));for(var xi=3===Fe?zt.length-1:zt.length,bi=0;bi<xi;bi++){1===bi&&1!==Fe&&Ae.writeVarint(a(2,xi-1));var wi=zt[bi].x-Ve,dr=zt[bi].y-qe;Ae.writeVarint(l(wi)),Ae.writeVarint(l(dr)),Ve+=wi,qe+=dr}3===Fe&&Ae.writeVarint(a(7,1))}}function h(F,Ae){var Oe=typeof F;"string"===Oe?Ae.writeStringField(1,F):"boolean"===Oe?Ae.writeBooleanField(7,F):"number"===Oe&&(F%1!=0?Ae.writeDoubleField(3,F):F<0?Ae.writeSVarintField(6,F):Ae.writeVarintField(5,F))}return dr.exports=i,dr.exports.fromVectorTileJs=i,dr.exports.fromGeojsonVt=function(F,Ae){Ae=Ae||{};var Oe={};for(var Ve in F)Oe[Ve]=new Fe(F[Ve].features,Ae),Oe[Ve].name=Ve,Oe[Ve].version=Ae.version,Oe[Ve].extent=Ae.extent;return i({layers:Oe})},dr.exports.GeoJSONWrapper=Fe,dr.exports}(),Qr=Ae.e9(jr);const Xn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:F=>F},ho=Math.fround||(yo=new Float32Array(1),F=>(yo[0]=+F,yo[0]));var yo;const zo=3,ko=5,Uo=6;class X{constructor(F){this.options=Object.assign(Object.create(Xn),F),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(F){const{log:Ae,minZoom:Oe,maxZoom:Fe}=this.options;Ae&&console.time("total time");const Ve=`prepare ${F.length} points`;Ae&&console.time(Ve),this.points=F;const qe=[];for(let Ae=0;Ae<F.length;Ae++){const Oe=F[Ae];if(!Oe.geometry)continue;const[Fe,Ve]=Oe.geometry.coordinates,pt=ho($(Fe)),vt=ho(H(Ve));qe.push(pt,vt,1/0,Ae,-1,1),this.options.reduce&&qe.push(0)}let pt=this.trees[Fe+1]=this._createTree(qe);Ae&&console.timeEnd(Ve);for(let F=Fe;F>=Oe;F--){const Oe=+Date.now();pt=this.trees[F]=this._createTree(this._cluster(pt,F)),Ae&&console.log("z%d: %d clusters in %dms",F,pt.numItems,+Date.now()-Oe)}return Ae&&console.timeEnd("total time"),this}getClusters(F,Ae){let Oe=((F[0]+180)%360+360)%360-180;const Fe=Math.max(-90,Math.min(90,F[1]));let Ve=180===F[2]?180:((F[2]+180)%360+360)%360-180;const qe=Math.max(-90,Math.min(90,F[3]));if(F[2]-F[0]>=360)Oe=-180,Ve=180;else if(Oe>Ve){const F=this.getClusters([Oe,Fe,180,qe],Ae),pt=this.getClusters([-180,Fe,Ve,qe],Ae);return F.concat(pt)}const pt=this.trees[this._limitZoom(Ae)],vt=pt.range($(Oe),H(qe),$(Ve),H(Fe)),zt=pt.data,ri=[];for(const F of vt){const Ae=this.stride*F;ri.push(zt[Ae+ko]>1?J(zt,Ae,this.clusterProps):this.points[zt[Ae+zo]])}return ri}getChildren(F){const Ae=this._getOriginId(F),Oe=this._getOriginZoom(F),Fe="No cluster with the specified id.",Ve=this.trees[Oe];if(!Ve)throw new Error(Fe);const qe=Ve.data;if(Ae*this.stride>=qe.length)throw new Error(Fe);const pt=this.options.radius/(this.options.extent*Math.pow(2,Oe-1)),vt=Ve.within(qe[Ae*this.stride],qe[Ae*this.stride+1],pt),zt=[];for(const Ae of vt){const Oe=Ae*this.stride;qe[Oe+4]===F&&zt.push(qe[Oe+ko]>1?J(qe,Oe,this.clusterProps):this.points[qe[Oe+zo]])}if(0===zt.length)throw new Error(Fe);return zt}getLeaves(F,Ae,Oe){const Fe=[];return this._appendLeaves(Fe,F,Ae=Ae||10,Oe=Oe||0,0),Fe}getTile(F,Ae,Oe){const Fe=this.trees[this._limitZoom(F)],Ve=Math.pow(2,F),{extent:qe,radius:pt}=this.options,vt=pt/qe,zt=(Oe-vt)/Ve,ri=(Oe+1+vt)/Ve,xi={features:[]};return this._addTileFeatures(Fe.range((Ae-vt)/Ve,zt,(Ae+1+vt)/Ve,ri),Fe.data,Ae,Oe,Ve,xi),0===Ae&&this._addTileFeatures(Fe.range(1-vt/Ve,zt,1,ri),Fe.data,Ve,Oe,Ve,xi),Ae===Ve-1&&this._addTileFeatures(Fe.range(0,zt,vt/Ve,ri),Fe.data,-1,Oe,Ve,xi),xi.features.length?xi:null}getClusterExpansionZoom(F){let Ae=this._getOriginZoom(F)-1;for(;Ae<=this.options.maxZoom;){const Oe=this.getChildren(F);if(Ae++,1!==Oe.length)break;F=Oe[0].properties.cluster_id}return Ae}_appendLeaves(F,Ae,Oe,Fe,Ve){const qe=this.getChildren(Ae);for(const Ae of qe){const qe=Ae.properties;if(qe&&qe.cluster?Ve+qe.point_count<=Fe?Ve+=qe.point_count:Ve=this._appendLeaves(F,qe.cluster_id,Oe,Fe,Ve):Ve<Fe?Ve++:F.push(Ae),F.length===Oe)break}return Ve}_createTree(F){const Oe=new Ae.bE(F.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Ae=0;Ae<F.length;Ae+=this.stride)Oe.add(F[Ae],F[Ae+1]);return Oe.finish(),Oe.data=F,Oe}_addTileFeatures(F,Ae,Oe,Fe,Ve,qe){for(const pt of F){const F=pt*this.stride,vt=Ae[F+ko]>1;let zt,ri,xi;if(vt)zt=q(Ae,F,this.clusterProps),ri=Ae[F],xi=Ae[F+1];else{const Oe=this.points[Ae[F+zo]];zt=Oe.properties;const[Fe,Ve]=Oe.geometry.coordinates;ri=$(Fe),xi=H(Ve)}const bi={type:1,geometry:[[Math.round(this.options.extent*(ri*Ve-Oe)),Math.round(this.options.extent*(xi*Ve-Fe))]],tags:zt};let wi;wi=vt||this.options.generateId?Ae[F+zo]:this.points[Ae[F+zo]].id,void 0!==wi&&(bi.id=wi),qe.features.push(bi)}}_limitZoom(F){return Math.max(this.options.minZoom,Math.min(Math.floor(+F),this.options.maxZoom+1))}_cluster(F,Ae){const{radius:Oe,extent:Fe,reduce:Ve,minPoints:qe}=this.options,pt=Oe/(Fe*Math.pow(2,Ae)),vt=F.data,zt=[],ri=this.stride;for(let Oe=0;Oe<vt.length;Oe+=ri){if(vt[Oe+2]<=Ae)continue;vt[Oe+2]=Ae;const Fe=vt[Oe],xi=vt[Oe+1],bi=F.within(vt[Oe],vt[Oe+1],pt),wi=vt[Oe+ko];let dr=wi;for(const F of bi){const Oe=F*ri;vt[Oe+2]>Ae&&(dr+=vt[Oe+ko])}if(dr>wi&&dr>=qe){let F,qe=Fe*wi,pt=xi*wi,jr=-1;const Qr=(Oe/ri<<5)+(Ae+1)+this.points.length;for(const Fe of bi){const zt=Fe*ri;if(vt[zt+2]<=Ae)continue;vt[zt+2]=Ae;const xi=vt[zt+ko];qe+=vt[zt]*xi,pt+=vt[zt+1]*xi,vt[zt+4]=Qr,Ve&&(F||(F=this._map(vt,Oe,!0),jr=this.clusterProps.length,this.clusterProps.push(F)),Ve(F,this._map(vt,zt)))}vt[Oe+4]=Qr,zt.push(qe/dr,pt/dr,1/0,Qr,-1,dr),Ve&&zt.push(jr)}else{for(let F=0;F<ri;F++)zt.push(vt[Oe+F]);if(dr>1)for(const F of bi){const Oe=F*ri;if(!(vt[Oe+2]<=Ae)){vt[Oe+2]=Ae;for(let F=0;F<ri;F++)zt.push(vt[Oe+F])}}}}return zt}_getOriginId(F){return F-this.points.length>>5}_getOriginZoom(F){return(F-this.points.length)%32}_map(F,Ae,Oe){if(F[Ae+ko]>1){const Fe=this.clusterProps[F[Ae+Uo]];return Oe?Object.assign({},Fe):Fe}const Fe=this.points[F[Ae+zo]].properties,Ve=this.options.map(Fe);return Oe&&Ve===Fe?Object.assign({},Ve):Ve}}function J(F,Ae,Oe){return{type:"Feature",id:F[Ae+zo],properties:q(F,Ae,Oe),geometry:{type:"Point",coordinates:[(Fe=F[Ae],360*(Fe-.5)),U(F[Ae+1])]}};var Fe}function q(F,Ae,Oe){const Fe=F[Ae+ko],Ve=Fe>=1e4?`${Math.round(Fe/1e3)}k`:Fe>=1e3?Math.round(Fe/100)/10+"k":Fe,qe=F[Ae+Uo],pt=-1===qe?{}:Object.assign({},Oe[qe]);return Object.assign(pt,{cluster:!0,cluster_id:F[Ae+zo],point_count:Fe,point_count_abbreviated:Ve})}function $(F){return F/360+.5}function H(F){const Ae=Math.sin(F*Math.PI/180),Oe=.5-.25*Math.log((1+Ae)/(1-Ae))/Math.PI;return Oe<0?0:Oe>1?1:Oe}function U(F){const Ae=(180-360*F)*Math.PI/180;return 360*Math.atan(Math.exp(Ae))/Math.PI-90}function Q(F,Ae,Oe,Fe){let Ve=Fe;const qe=Ae+(Oe-Ae>>1);let pt,vt=Oe-Ae;const zt=F[Ae],ri=F[Ae+1],xi=F[Oe],bi=F[Oe+1];for(let Fe=Ae+3;Fe<Oe;Fe+=3){const Ae=K(F[Fe],F[Fe+1],zt,ri,xi,bi);if(Ae>Ve)pt=Fe,Ve=Ae;else if(Ae===Ve){const F=Math.abs(Fe-qe);F<vt&&(pt=Fe,vt=F)}}Ve>Fe&&(pt-Ae>3&&Q(F,Ae,pt,Fe),F[pt+2]=Ve,Oe-pt>3&&Q(F,pt,Oe,Fe))}function K(F,Ae,Oe,Fe,Ve,qe){let pt=Ve-Oe,vt=qe-Fe;if(0!==pt||0!==vt){const zt=((F-Oe)*pt+(Ae-Fe)*vt)/(pt*pt+vt*vt);zt>1?(Oe=Ve,Fe=qe):zt>0&&(Oe+=pt*zt,Fe+=vt*zt)}return pt=F-Oe,vt=Ae-Fe,pt*pt+vt*vt}function ee(F,Ae,Oe,Fe){const Ve={id:F??null,type:Ae,geometry:Oe,tags:Fe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===Ae||"MultiPoint"===Ae||"LineString"===Ae)te(Ve,Oe);else if("Polygon"===Ae)te(Ve,Oe[0]);else if("MultiLineString"===Ae)for(const F of Oe)te(Ve,F);else if("MultiPolygon"===Ae)for(const F of Oe)te(Ve,F[0]);return Ve}function te(F,Ae){for(let Oe=0;Oe<Ae.length;Oe+=3)F.minX=Math.min(F.minX,Ae[Oe]),F.minY=Math.min(F.minY,Ae[Oe+1]),F.maxX=Math.max(F.maxX,Ae[Oe]),F.maxY=Math.max(F.maxY,Ae[Oe+1])}function se(F,Ae,Oe,Fe){if(!Ae.geometry)return;const Ve=Ae.geometry.coordinates;if(Ve&&0===Ve.length)return;const qe=Ae.geometry.type,pt=Math.pow(Oe.tolerance/((1<<Oe.maxZoom)*Oe.extent),2);let vt=[],zt=Ae.id;if(Oe.promoteId?zt=Ae.properties[Oe.promoteId]:Oe.generateId&&(zt=Fe||0),"Point"===qe)ie(Ve,vt);else if("MultiPoint"===qe)for(const F of Ve)ie(F,vt);else if("LineString"===qe)oe(Ve,vt,pt,!1);else if("MultiLineString"===qe){if(Oe.lineMetrics){for(const Oe of Ve)vt=[],oe(Oe,vt,pt,!1),F.push(ee(zt,"LineString",vt,Ae.properties));return}re(Ve,vt,pt,!1)}else if("Polygon"===qe)re(Ve,vt,pt,!0);else{if("MultiPolygon"!==qe){if("GeometryCollection"===qe){for(const Ve of Ae.geometry.geometries)se(F,{id:zt,geometry:Ve,properties:Ae.properties},Oe,Fe);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const F of Ve){const Ae=[];re(F,Ae,pt,!0),vt.push(Ae)}}F.push(ee(zt,qe,vt,Ae.properties))}function ie(F,Ae){Ae.push(ne(F[0]),ae(F[1]),0)}function oe(F,Ae,Oe,Fe){let Ve,qe,pt=0;for(let Oe=0;Oe<F.length;Oe++){const vt=ne(F[Oe][0]),zt=ae(F[Oe][1]);Ae.push(vt,zt,0),Oe>0&&(pt+=Fe?(Ve*zt-vt*qe)/2:Math.sqrt(Math.pow(vt-Ve,2)+Math.pow(zt-qe,2))),Ve=vt,qe=zt}const vt=Ae.length-3;Ae[2]=1,Q(Ae,0,vt,Oe),Ae[vt+2]=1,Ae.size=Math.abs(pt),Ae.start=0,Ae.end=Ae.size}function re(F,Ae,Oe,Fe){for(let Ve=0;Ve<F.length;Ve++){const qe=[];oe(F[Ve],qe,Oe,Fe),Ae.push(qe)}}function ne(F){return F/360+.5}function ae(F){const Ae=Math.sin(F*Math.PI/180),Oe=.5-.25*Math.log((1+Ae)/(1-Ae))/Math.PI;return Oe<0?0:Oe>1?1:Oe}function le(F,Ae,Oe,Fe,Ve,qe,pt,vt){if(Fe/=Ae,qe>=(Oe/=Ae)&&pt<Fe)return F;if(pt<Oe||qe>=Fe)return null;const zt=[];for(const Ae of F){const F=Ae.geometry;let qe=Ae.type;const pt=0===Ve?Ae.minX:Ae.minY,ri=0===Ve?Ae.maxX:Ae.maxY;if(pt>=Oe&&ri<Fe){zt.push(Ae);continue}if(ri<Oe||pt>=Fe)continue;let xi=[];if("Point"===qe||"MultiPoint"===qe)ce(F,xi,Oe,Fe,Ve);else if("LineString"===qe)he(F,xi,Oe,Fe,Ve,!1,vt.lineMetrics);else if("MultiLineString"===qe)de(F,xi,Oe,Fe,Ve,!1);else if("Polygon"===qe)de(F,xi,Oe,Fe,Ve,!0);else if("MultiPolygon"===qe)for(const Ae of F){const F=[];de(Ae,F,Oe,Fe,Ve,!0),F.length&&xi.push(F)}if(xi.length){if(vt.lineMetrics&&"LineString"===qe){for(const F of xi)zt.push(ee(Ae.id,qe,F,Ae.tags));continue}"LineString"!==qe&&"MultiLineString"!==qe||(1===xi.length?(qe="LineString",xi=xi[0]):qe="MultiLineString"),"Point"!==qe&&"MultiPoint"!==qe||(qe=3===xi.length?"Point":"MultiPoint"),zt.push(ee(Ae.id,qe,xi,Ae.tags))}}return zt.length?zt:null}function ce(F,Ae,Oe,Fe,Ve){for(let qe=0;qe<F.length;qe+=3){const pt=F[qe+Ve];pt>=Oe&&pt<=Fe&&pe(Ae,F[qe],F[qe+1],F[qe+2])}}function he(F,Ae,Oe,Fe,Ve,qe,pt){let vt=ue(F);const zt=0===Ve?fe:ge;let ri,xi,bi=F.start;for(let wi=0;wi<F.length-3;wi+=3){const dr=F[wi],jr=F[wi+1],Qr=F[wi+2],Xn=F[wi+3],ho=F[wi+4],yo=0===Ve?dr:jr,zo=0===Ve?Xn:ho;let ko=!1;pt&&(ri=Math.sqrt(Math.pow(dr-Xn,2)+Math.pow(jr-ho,2))),yo<Oe?zo>Oe&&(xi=zt(vt,dr,jr,Xn,ho,Oe),pt&&(vt.start=bi+ri*xi)):yo>Fe?zo<Fe&&(xi=zt(vt,dr,jr,Xn,ho,Fe),pt&&(vt.start=bi+ri*xi)):pe(vt,dr,jr,Qr),zo<Oe&&yo>=Oe&&(xi=zt(vt,dr,jr,Xn,ho,Oe),ko=!0),zo>Fe&&yo<=Fe&&(xi=zt(vt,dr,jr,Xn,ho,Fe),ko=!0),!qe&&ko&&(pt&&(vt.end=bi+ri*xi),Ae.push(vt),vt=ue(F)),pt&&(bi+=ri)}let wi=F.length-3;const dr=F[wi],jr=F[wi+1],Qr=0===Ve?dr:jr;Qr>=Oe&&Qr<=Fe&&pe(vt,dr,jr,F[wi+2]),wi=vt.length-3,qe&&wi>=3&&(vt[wi]!==vt[0]||vt[wi+1]!==vt[1])&&pe(vt,vt[0],vt[1],vt[2]),vt.length&&Ae.push(vt)}function ue(F){const Ae=[];return Ae.size=F.size,Ae.start=F.start,Ae.end=F.end,Ae}function de(F,Ae,Oe,Fe,Ve,qe){for(const pt of F)he(pt,Ae,Oe,Fe,Ve,qe,!1)}function pe(F,Ae,Oe,Fe){F.push(Ae,Oe,Fe)}function fe(F,Ae,Oe,Fe,Ve,qe){const pt=(qe-Ae)/(Fe-Ae);return pe(F,qe,Oe+(Ve-Oe)*pt,1),pt}function ge(F,Ae,Oe,Fe,Ve,qe){const pt=(qe-Oe)/(Ve-Oe);return pe(F,Ae+(Fe-Ae)*pt,qe,1),pt}function me(F,Ae){const Oe=[];for(let Fe=0;Fe<F.length;Fe++){const Ve=F[Fe],qe=Ve.type;let pt;if("Point"===qe||"MultiPoint"===qe||"LineString"===qe)pt=ye(Ve.geometry,Ae);else if("MultiLineString"===qe||"Polygon"===qe){pt=[];for(const F of Ve.geometry)pt.push(ye(F,Ae))}else if("MultiPolygon"===qe){pt=[];for(const F of Ve.geometry){const Oe=[];for(const Fe of F)Oe.push(ye(Fe,Ae));pt.push(Oe)}}Oe.push(ee(Ve.id,qe,pt,Ve.tags))}return Oe}function ye(F,Ae){const Oe=[];Oe.size=F.size,void 0!==F.start&&(Oe.start=F.start,Oe.end=F.end);for(let Fe=0;Fe<F.length;Fe+=3)Oe.push(F[Fe]+Ae,F[Fe+1],F[Fe+2]);return Oe}function ve(F,Ae){if(F.transformed)return F;const Oe=1<<F.z,Fe=F.x,Ve=F.y;for(const qe of F.features){const F=qe.geometry,pt=qe.type;if(qe.geometry=[],1===pt)for(let pt=0;pt<F.length;pt+=2)qe.geometry.push(be(F[pt],F[pt+1],Ae,Oe,Fe,Ve));else for(let pt=0;pt<F.length;pt++){const vt=[];for(let qe=0;qe<F[pt].length;qe+=2)vt.push(be(F[pt][qe],F[pt][qe+1],Ae,Oe,Fe,Ve));qe.geometry.push(vt)}}return F.transformed=!0,F}function be(F,Ae,Oe,Fe,Ve,qe){return[Math.round(Oe*(F*Fe-Ve)),Math.round(Oe*(Ae*Fe-qe))]}function xe(F,Ae,Oe,Fe,Ve){const qe=Ae===Ve.maxZoom?0:Ve.tolerance/((1<<Ae)*Ve.extent),pt={features:[],numPoints:0,numSimplified:0,numFeatures:F.length,source:null,x:Oe,y:Fe,z:Ae,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Ae of F)we(pt,Ae,qe,Ve);return pt}function we(F,Ae,Oe,Fe){const Ve=Ae.geometry,qe=Ae.type,pt=[];if(F.minX=Math.min(F.minX,Ae.minX),F.minY=Math.min(F.minY,Ae.minY),F.maxX=Math.max(F.maxX,Ae.maxX),F.maxY=Math.max(F.maxY,Ae.maxY),"Point"===qe||"MultiPoint"===qe)for(let Ae=0;Ae<Ve.length;Ae+=3)pt.push(Ve[Ae],Ve[Ae+1]),F.numPoints++,F.numSimplified++;else if("LineString"===qe)Ie(pt,Ve,F,Oe,!1,!1);else if("MultiLineString"===qe||"Polygon"===qe)for(let Ae=0;Ae<Ve.length;Ae++)Ie(pt,Ve[Ae],F,Oe,"Polygon"===qe,0===Ae);else if("MultiPolygon"===qe)for(let Ae=0;Ae<Ve.length;Ae++){const Fe=Ve[Ae];for(let Ae=0;Ae<Fe.length;Ae++)Ie(pt,Fe[Ae],F,Oe,!0,0===Ae)}if(pt.length){let Oe=Ae.tags||null;if("LineString"===qe&&Fe.lineMetrics){Oe={};for(const F in Ae.tags)Oe[F]=Ae.tags[F];Oe.mapbox_clip_start=Ve.start/Ve.size,Oe.mapbox_clip_end=Ve.end/Ve.size}const vt={geometry:pt,type:"Polygon"===qe||"MultiPolygon"===qe?3:"LineString"===qe||"MultiLineString"===qe?2:1,tags:Oe};null!==Ae.id&&(vt.id=Ae.id),F.features.push(vt)}}function Ie(F,Ae,Oe,Fe,Ve,qe){const pt=Fe*Fe;if(Fe>0&&Ae.size<(Ve?pt:Fe))return void(Oe.numPoints+=Ae.length/3);const vt=[];for(let F=0;F<Ae.length;F+=3)(0===Fe||Ae[F+2]>pt)&&(Oe.numSimplified++,vt.push(Ae[F],Ae[F+1])),Oe.numPoints++;Ve&&function(F,Ae){let Oe=0;for(let Ae=0,Fe=F.length,Ve=Fe-2;Ae<Fe;Ve=Ae,Ae+=2)Oe+=(F[Ae]-F[Ve])*(F[Ae+1]+F[Ve+1]);if(Oe>0===Ae)for(let Ae=0,Oe=F.length;Ae<Oe/2;Ae+=2){const Fe=F[Ae],Ve=F[Ae+1];F[Ae]=F[Oe-2-Ae],F[Ae+1]=F[Oe-1-Ae],F[Oe-2-Ae]=Fe,F[Oe-1-Ae]=Ve}}(vt,qe),F.push(vt)}const ia={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Me{constructor(F,Ae){const Oe=(Ae=this.options=function(F,Ae){for(const Oe in Ae)F[Oe]=Ae[Oe];return F}(Object.create(ia),Ae)).debug;if(Oe&&console.time("preprocess data"),Ae.maxZoom<0||Ae.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Ae.promoteId&&Ae.generateId)throw new Error("promoteId and generateId cannot be used together.");let Fe=function(F,Ae){const Oe=[];if("FeatureCollection"===F.type)for(let Fe=0;Fe<F.features.length;Fe++)se(Oe,F.features[Fe],Ae,Fe);else se(Oe,"Feature"===F.type?F:{geometry:F},Ae);return Oe}(F,Ae);this.tiles={},this.tileCoords=[],Oe&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Ae.indexMaxZoom,Ae.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Fe=function(F,Ae){const Oe=Ae.buffer/Ae.extent;let Fe=F;const Ve=le(F,1,-1-Oe,Oe,0,-1,2,Ae),qe=le(F,1,1-Oe,2+Oe,0,-1,2,Ae);return(Ve||qe)&&(Fe=le(F,1,-Oe,1+Oe,0,-1,2,Ae)||[],Ve&&(Fe=me(Ve,1).concat(Fe)),qe&&(Fe=Fe.concat(me(qe,-1)))),Fe}(Fe,Ae),Fe.length&&this.splitTile(Fe,0,0,0),Oe&&(Fe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(F,Ae,Oe,Fe,Ve,qe,pt){const vt=[F,Ae,Oe,Fe],zt=this.options,ri=zt.debug;for(;vt.length;){Fe=vt.pop(),Oe=vt.pop(),Ae=vt.pop(),F=vt.pop();const xi=1<<Ae,bi=Pe(Ae,Oe,Fe);let wi=this.tiles[bi];if(!wi&&(ri>1&&console.time("creation"),wi=this.tiles[bi]=xe(F,Ae,Oe,Fe,zt),this.tileCoords.push({z:Ae,x:Oe,y:Fe}),ri)){ri>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Ae,Oe,Fe,wi.numFeatures,wi.numPoints,wi.numSimplified),console.timeEnd("creation"));const F=`z${Ae}`;this.stats[F]=(this.stats[F]||0)+1,this.total++}if(wi.source=F,null==Ve){if(Ae===zt.indexMaxZoom||wi.numPoints<=zt.indexMaxPoints)continue}else{if(Ae===zt.maxZoom||Ae===Ve)continue;if(null!=Ve){const F=Ve-Ae;if(Oe!==qe>>F||Fe!==pt>>F)continue}}if(wi.source=null,0===F.length)continue;ri>1&&console.time("clipping");const dr=.5*zt.buffer/zt.extent,jr=.5-dr,Qr=.5+dr,Xn=1+dr;let ho=null,yo=null,zo=null,ko=null,Uo=le(F,xi,Oe-dr,Oe+Qr,0,wi.minX,wi.maxX,zt),ia=le(F,xi,Oe+jr,Oe+Xn,0,wi.minX,wi.maxX,zt);F=null,Uo&&(ho=le(Uo,xi,Fe-dr,Fe+Qr,1,wi.minY,wi.maxY,zt),yo=le(Uo,xi,Fe+jr,Fe+Xn,1,wi.minY,wi.maxY,zt),Uo=null),ia&&(zo=le(ia,xi,Fe-dr,Fe+Qr,1,wi.minY,wi.maxY,zt),ko=le(ia,xi,Fe+jr,Fe+Xn,1,wi.minY,wi.maxY,zt),ia=null),ri>1&&console.timeEnd("clipping"),vt.push(ho||[],Ae+1,2*Oe,2*Fe),vt.push(yo||[],Ae+1,2*Oe,2*Fe+1),vt.push(zo||[],Ae+1,2*Oe+1,2*Fe),vt.push(ko||[],Ae+1,2*Oe+1,2*Fe+1)}}getTile(F,Ae,Oe){F=+F,Ae=+Ae,Oe=+Oe;const Fe=this.options,{extent:Ve,debug:qe}=Fe;if(F<0||F>24)return null;const pt=1<<F,vt=Pe(F,Ae=Ae+pt&pt-1,Oe);if(this.tiles[vt])return ve(this.tiles[vt],Ve);qe>1&&console.log("drilling down to z%d-%d-%d",F,Ae,Oe);let zt,ri=F,xi=Ae,bi=Oe;for(;!zt&&ri>0;)ri--,xi>>=1,bi>>=1,zt=this.tiles[Pe(ri,xi,bi)];return zt&&zt.source?(qe>1&&(console.log("found parent tile z%d-%d-%d",ri,xi,bi),console.time("drilling down")),this.splitTile(zt.source,ri,xi,bi,F,Ae,Oe),qe>1&&console.timeEnd("drilling down"),this.tiles[vt]?ve(this.tiles[vt],Ve):null):null}}function Pe(F,Ae,Oe){return 32*((1<<F)*Oe+Ae)+F}function Te(Ae,Oe){const Fe=Ae.tileID.canonical;if(!(this||F)._geoJSONIndex)return void Oe(null,null);const Ve=(this||F)._geoJSONIndex.getTile(Fe.z,Fe.x,Fe.y);if(!Ve)return void Oe(null,null);const qe=new S(Ve.features);let pt=Qr(qe);0===pt.byteOffset&&pt.byteLength===pt.buffer.byteLength||(pt=new Uint8Array(pt)),Oe(null,{vectorTile:qe,rawData:pt.buffer})}class ke extends v{constructor(F,Ae,Oe,Fe,Ve,qe){super(F,Ae,Oe,Fe,Te,qe),Ve&&(this.loadGeoJSON=Ve),this._dynamicIndex=new T}loadData(F,Oe){const Fe=F&&F.request,Ve=Fe&&Fe.collectResourceTiming;this.loadGeoJSON(F,((qe,pt)=>{if(qe||!pt)return Oe(qe);if("object"!=typeof pt)return Oe(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));{try{if(F.filter){const Oe=Ae.U(F.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===Oe.result)throw new Error(Oe.value.map((F=>`${F.key}: ${F.message}`)).join(", "));pt.features=pt.features.filter((F=>Oe.value.evaluate({zoom:0},F)))}F.dynamic?("Feature"===pt.type&&(pt={type:"FeatureCollection",features:[pt]}),F.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(pt.features,this.loaded),F.cluster&&(pt.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=F.cluster?new X(function({superclusterOptions:F,clusterProperties:Oe}){if(!Oe||!F)return F;const Fe={},Ve={},qe={accumulated:null,zoom:0},pt={properties:null},vt=Object.keys(Oe);for(const F of vt){const[qe,pt]=Oe[F],vt=Ae.U(pt),zt=Ae.U("string"==typeof qe?[qe,["accumulated"],["get",F]]:qe);Fe[F]=vt.value,Ve[F]=zt.value}return F.map=F=>{pt.properties=F;const Ae={};for(const F of vt)Ae[F]=Fe[F].evaluate(qe,pt);return Ae},F.reduce=(F,Ae)=>{pt.properties=Ae;for(const Ae of vt)qe.accumulated=F[Ae],F[Ae]=Ve[Ae].evaluate(qe,pt)},F}(F)).load(pt.features):F.dynamic?this._dynamicIndex:function(F,Ae){return new Me(F,Ae)}(pt,F.geojsonVtOptions)}catch(F){return Oe(F)}const qe={};if(Ve){const Ae=t(Fe);Ae&&(qe.resourceTiming={},qe.resourceTiming[F.source]=JSON.parse(JSON.stringify(Ae)))}Oe(null,qe)}}))}reloadTile(F,Ae){const Oe=this.loaded;return Oe&&Oe[F.uid]?F.partial?Ae(null,void 0):super.reloadTile(F,Ae):this.loadTile(F,Ae)}loadGeoJSON(F,Oe){if(F.request)Ae.n(F.request,Oe);else{if("string"!=typeof F.data)return Oe(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));try{return Oe(null,JSON.parse(F.data))}catch(Ae){return Oe(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(F,Ae){try{Ae(null,this._geoJSONIndex.getClusterExpansionZoom(F.clusterId))}catch(F){Ae(F)}}getClusterChildren(F,Ae){try{Ae(null,this._geoJSONIndex.getChildren(F.clusterId))}catch(F){Ae(F)}}getClusterLeaves(F,Ae){try{Ae(null,this._geoJSONIndex.getLeaves(F.clusterId,F.limit,F.offset))}catch(F){Ae(F)}}}class _e{constructor(F,Oe){this.tileID=new Ae.aG(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=F.projection,this.brightness=Oe}parse(F,Oe,Fe,Ve){this.status="parsing";const qe=new Ae.aG(Fe.tileID.overscaledZ,Fe.tileID.wrap,Fe.tileID.canonical.z,Fe.tileID.canonical.x,Fe.tileID.canonical.y),pt=[],vt=Oe.familiesBySource[Fe.source],zt=new Ae.d$(qe,Fe.promoteId);return zt.bucketLayerIDs=[],zt.is3DTile=!0,Ae.ea(F).then((F=>{if(!F)return Ve(new Error("Could not parse tile"));const Oe=Ae.eb(F,1/Ae.cc(Fe.tileID.canonical)),ri=F.json.extensionsUsed&&F.json.extensionsUsed.includes("MAPBOX_mesh_features")||F.json.asset.extras&&F.json.asset.extras.MAPBOX_mesh_features,xi=F.json.extensionsUsed&&F.json.extensionsUsed.includes("EXT_meshopt_compression"),bi=new Ae.a8(this.zoom,{brightness:this.brightness});for(const F in vt)for(const Fe of vt[F]){const F=Fe[0];zt.bucketLayerIDs.push(Fe.map((F=>Ae.aC(F.id,F.scope)))),F.recalculate(bi,[]);const Ve=new Ae.ec(Fe,Oe,qe,ri,xi,this.brightness,zt);ri||(Ve.needsUpload=!0),pt.push(Ve),Ve.evaluate(F)}this.status="done",Ve(null,{buckets:pt,featureIndex:zt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((F=>Ve(new Error(F.message))))}}class Ce{constructor(F,Ae,Oe,Fe,Ve,qe){this.actor=F,this.layerIndex=Ae,this.availableImages=Oe,this.brightness=qe,this.loading={},this.loaded={}}loadTile(F,Oe){const Fe=F.uid,Ve=this.loading[Fe]=new _e(F,this.brightness);Ae.bi(F.request,((Ae,qe)=>{const pt=!this.loading[Fe];return delete this.loading[Fe],pt||Ae?(Ve.status="done",pt||(this.loaded[Fe]=Ve),Oe(Ae)):qe&&0!==qe.byteLength?void Ve.parse(qe,this.layerIndex,F,((F,Ae)=>{Ve.status="done",this.loaded=this.loaded||{},this.loaded[Fe]=Ve,F||!Ae?Oe(F):Oe(null,Ae)})):(Ve.status="done",this.loaded[Fe]=Ve,Oe())}))}reloadTile(F,Ae){const Oe=this.loaded,Fe=F.uid;if(Oe&&Oe[Fe]){const Ve=Oe[Fe];Ve.projection=F.projection,Ve.brightness=F.brightness;const r=(Oe,Fe)=>{Ve.reloadCallback&&(delete Ve.reloadCallback,this.loadTile(F,Ae)),Ae(Oe,Fe)};"parsing"===Ve.status?Ve.reloadCallback=r:"done"===Ve.status&&this.loadTile(F,Ae)}}abortTile(F,Ae){const Oe=F.uid;this.loading[Oe]&&delete this.loading[Oe],Ae()}removeTile(F,Ae){const Oe=this.loaded,Fe=F.uid;Oe&&Oe[Fe]&&delete Oe[Fe],Ae()}}class ze{constructor(F){this.self=F,this.actor=new Ae.ed(F,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.imageRasterizer=new Ae.I,this.projections={},this.defaultProjection=Ae.bP({name:"mercator"}),this.workerSourceTypes={vector:v,geojson:ke,"batched-model":Ce},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(F,Ae)=>{if(this.workerSourceTypes[F])throw new Error(`Worker source with name "${F}" already registered.`);this.workerSourceTypes[F]=Ae},this.self.registerRTLTextPlugin=F=>{if(Ae.ee.isParsed())throw new Error("RTL text plugin already registered.");Ae.ee.applyArabicShaping=F.applyArabicShaping,Ae.ee.processBidirectionalText=F.processBidirectionalText,Ae.ee.processStyledBidirectionalText=F.processStyledBidirectionalText}}clearCaches(F,Ae,Oe){delete this.layerIndexes[F],delete this.availableImages[F],delete this.workerSources[F],delete this.demWorkerSources[F],delete this.rasterArrayWorkerSource,Oe()}checkIfReady(F,Ae,Oe){Oe()}setReferrer(F,Ae){this.referrer=Ae}spriteLoaded(F,{scope:Oe,isLoaded:Fe}){if(this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),this.isSpriteLoaded[F][Oe]=Fe,this.workerSources[F]&&this.workerSources[F][Oe])for(const Ve in this.workerSources[F][Oe]){const qe=this.workerSources[F][Oe][Ve];for(const F in qe){const Oe=qe[F];Oe instanceof v&&(Oe.isSpriteLoaded=Fe,Oe.fire(new Ae.z("isSpriteLoaded")))}}}setImages(F,{scope:Ae,images:Oe},Fe){if(this.availableImages[F]||(this.availableImages[F]={}),this.availableImages[F][Ae]=Oe,this.workerSources[F]&&this.workerSources[F][Ae]){for(const Fe in this.workerSources[F][Ae]){const Ve=this.workerSources[F][Ae][Fe];for(const F in Ve)Ve[F].availableImages=Oe}Fe()}else Fe()}setProjection(F,Oe){this.projections[F]=Ae.bP(Oe)}setBrightness(F,Ae,Oe){this.brightness=Ae,Oe()}setLayers(F,Ae,Oe){this.getLayerIndex(F,Ae.scope).replace(Ae.layers,Ae.options),Oe()}updateLayers(F,Ae,Oe){this.getLayerIndex(F,Ae.scope).update(Ae.layers,Ae.removedIds,Ae.options),Oe()}loadTile(F,Ae,Oe){Ae.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,Ae.type,Ae.source,Ae.scope).loadTile(Ae,Oe)}loadDEMTile(F,Ae,Oe){this.getDEMWorkerSource(F,Ae.source,Ae.scope).loadTile(Ae,Oe)}decodeRasterArray(F,Ae,Oe){this.getRasterArrayWorkerSource().decodeRasterArray(Ae,Oe)}reloadTile(F,Ae,Oe){Ae.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,Ae.type,Ae.source,Ae.scope).reloadTile(Ae,Oe)}abortTile(F,Ae,Oe){this.getWorkerSource(F,Ae.type,Ae.source,Ae.scope).abortTile(Ae,Oe)}removeTile(F,Ae,Oe){this.getWorkerSource(F,Ae.type,Ae.source,Ae.scope).removeTile(Ae,Oe)}removeSource(F,Ae,Oe){if(!(this.workerSources[F]&&this.workerSources[F][Ae.scope]&&this.workerSources[F][Ae.scope][Ae.type]&&this.workerSources[F][Ae.scope][Ae.type][Ae.source]))return;const Fe=this.workerSources[F][Ae.scope][Ae.type][Ae.source];delete this.workerSources[F][Ae.scope][Ae.type][Ae.source],void 0!==Fe.removeSource?Fe.removeSource(Ae,Oe):Oe()}loadWorkerSource(F,Ae,Oe){try{this.self.importScripts(Ae.url),Oe()}catch(F){Oe(F.toString())}}syncRTLPluginState(F,Oe,Fe){try{Ae.ee.setState(Oe);const F=Ae.ee.getPluginURL();if(Ae.ee.isLoaded()&&!Ae.ee.isParsed()&&null!=F){this.self.importScripts(F);const Oe=Ae.ee.isParsed();Fe(Oe?void 0:new Error(`RTL Text Plugin failed to import scripts from ${F}`),Oe)}}catch(F){Fe(F.toString())}}setDracoUrl(F,Ae){this.dracoUrl=Ae}getAvailableImages(F,Ae){this.availableImages[F]||(this.availableImages[F]={});let Oe=this.availableImages[F][Ae];return Oe||(Oe=[]),Oe}getLayerIndex(F,Ae){this.layerIndexes[F]||(this.layerIndexes[F]={});let Oe=this.layerIndexes[F][Ae];return Oe||(Oe=this.layerIndexes[F][Ae]=new o,Oe.scope=Ae),Oe}getWorkerSource(F,Ae,Oe,Fe){return this.workerSources[F]||(this.workerSources[F]={}),this.workerSources[F][Fe]||(this.workerSources[F][Fe]={}),this.workerSources[F][Fe][Ae]||(this.workerSources[F][Fe][Ae]={}),this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),this.workerSources[F][Fe][Ae][Oe]||(this.workerSources[F][Fe][Ae][Oe]=new this.workerSourceTypes[Ae]({send:(Ae,Oe,Fe,Ve,qe,pt)=>{this.actor.send(Ae,Oe,Fe,F,qe,pt)},scheduler:this.actor.scheduler},this.getLayerIndex(F,Fe),this.getAvailableImages(F,Fe),this.isSpriteLoaded[F][Fe],void 0,this.brightness)),this.workerSources[F][Fe][Ae][Oe]}rasterizeImages(F,Ae,Oe){const{imageTasks:Fe,scope:Ve}=Ae,qe={};for(const Ae in Fe){const{image:Oe,imageIdWithOptions:pt}=Fe[Ae];qe[Ae]=this.imageRasterizer.rasterize(pt,Oe,Ve,F)}Oe(void 0,qe)}removeRasterizedImages(F,Ae,Oe){const{imageIds:Fe,scope:Ve}=Ae;this.imageRasterizer.removeImagesFromCacheByIds(Fe,Ve,F),Oe()}getDEMWorkerSource(F,Ae,Oe){return this.demWorkerSources[F]||(this.demWorkerSources[F]={}),this.demWorkerSources[F][Oe]||(this.demWorkerSources[F][Oe]={}),this.demWorkerSources[F][Oe][Ae]||(this.demWorkerSources[F][Oe][Ae]=new b),this.demWorkerSources[F][Oe][Ae]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new x),this.rasterArrayWorkerSource}enforceCacheSizeLimit(F,Oe){Ae.ef(Oe)}getWorkerPerformanceMetrics(F,Ae,Oe){Oe(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new ze(self)),ze}));define(["./shared"],(function(F){var Ae="3.10.0";const Oe={create:"create",load:"load",fullLoad:"fullLoad"},Fe={mark(F){performance.mark(F)},measure(F,Ae,Oe){performance.measure(F,Ae,Oe)}};function s(Ae){const Oe=Ae.name.split("?")[0];return F.a(Oe)&&Oe.includes("mapbox-gl.js")?"javascript":F.a(Oe)&&Oe.includes("mapbox-gl.css")?"css":F.b(Oe)?"fontRange":F.c(Oe)?"sprite":F.i(Oe)?"style":F.d(Oe)?"tilejson":"other"}var Ve,qe={},pt=function(){if(Ve)return qe;function e(F){return!t(F)}function t(Ae){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var F,Ae,Oe=new Blob([""],{type:"text/javascript"}),Fe=URL.createObjectURL(Oe);try{Ae=new Worker(Fe),F=!0}catch(Ae){F=!1}return Ae&&Ae.terminate(),URL.revokeObjectURL(Fe),F}()?function(){var F=document.createElement("canvas");F.width=F.height=1;var Ae=F.getContext("2d");if(!Ae)return!1;var Oe=Ae.getImageData(0,0,1,1);return Oe&&Oe.width===F.width}()?(void 0===F[Oe=Ae&&Ae.failIfMajorPerformanceCaveat]&&(F[Oe]=function(F){var Ae,Oe=function(F){var Ae=document.createElement("canvas"),Oe=Object.create(e.webGLContextAttributes);return Oe.failIfMajorPerformanceCaveat=F,Ae.getContext("webgl2",Oe)}(F);if(!Oe)return!1;try{Ae=Oe.createShader(Oe.VERTEX_SHADER)}catch(F){return!1}return!(!Ae||Oe.isContextLost())&&(Oe.shaderSource(Ae,"void main() {}"),Oe.compileShader(Ae),!0===Oe.getShaderParameter(Ae,Oe.COMPILE_STATUS))}(Oe)),F[Oe]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var Oe}Ve=1,qe.supported=e,qe.notSupportedReason=t;var F={};return e.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},qe}();function l(F,Ae,Oe){const Fe=document.createElement(F);return null!=Ae&&(Fe.className=Ae),Oe&&Oe.appendChild(Fe),Fe}function c(F,Ae,Oe){const Fe=document.createElementNS("http://www.w3.org/2000/svg",F);for(const F of Object.keys(Ae))Fe.setAttributeNS(null,F,String(Ae[F]));return Oe&&Oe.appendChild(Fe),Fe}const vt="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,zt=vt&&void 0!==vt.userSelect?"userSelect":"WebkitUserSelect";let ri;function _(){vt&&zt&&(ri=vt[zt],vt[zt]="none")}function p(){vt&&zt&&(vt[zt]=ri)}function f(F){F.preventDefault(),F.stopPropagation(),window.removeEventListener("click",f,!0)}function m(){window.addEventListener("click",f,!0),window.setTimeout((()=>{window.removeEventListener("click",f,!0)}),0)}function g(F,Ae){const Oe=F.getBoundingClientRect();return x(F,Oe,Ae)}function v(F,Ae){const Oe=F.getBoundingClientRect(),Fe=[];for(let Ve=0;Ve<Ae.length;Ve++)Fe.push(x(F,Oe,Ae[Ve]));return Fe}function y(F){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&2===F.button&&F.ctrlKey?0:F.button}function x(Ae,Oe,Fe){const Ve=Ae.offsetWidth===Oe.width?1:Ae.offsetWidth/Oe.width;return new F.P((Fe.clientX-Oe.left)*Ve,(Fe.clientY-Oe.top)*Ve)}const xi="01",bi="NO_ACCESS_TOKEN";class T{constructor(F,Ae,Oe){this._transformRequestFn=F,this._customAccessToken=Ae,this._silenceAuthErrors=!!Oe,this._createSkuToken()}_createSkuToken(){const F=function(){let F="";for(let Ae=0;Ae<10;Ae++)F+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",xi,F].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=F.token,this._skuTokenExpiresAt=F.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(F,Ae){return this._transformRequestFn&&this._transformRequestFn(F,Ae)||{url:F}}normalizeStyleURL(Oe,Fe){if(!F.f(Oe))return Oe;const Ve=S(Oe);return Ve.params.push(`sdk=js-${Ae}`),Ve.path=`/styles/v1${Ve.path}`,this._makeAPIURL(Ve,this._customAccessToken||Fe)}normalizeGlyphsURL(Ae,Oe){if(!F.f(Ae))return Ae;const Fe=S(Ae);return Fe.path=`/fonts/v1${Fe.path}`,this._makeAPIURL(Fe,this._customAccessToken||Oe)}normalizeModelURL(Ae,Oe){if(!F.f(Ae))return Ae;const Fe=S(Ae);return Fe.path=`/models/v1${Fe.path}`,this._makeAPIURL(Fe,this._customAccessToken||Oe)}normalizeSourceURL(Ae,Oe,Fe,Ve){if(!F.f(Ae))return Ae;const qe=S(Ae);return qe.path=`/v4/${qe.authority}.json`,qe.params.push("secure"),Fe&&qe.params.push(`language=${Fe}`),Ve&&qe.params.push(`worldview=${Ve}`),this._makeAPIURL(qe,this._customAccessToken||Oe)}normalizeIconsetURL(Ae,Oe){const Fe=S(Ae);return F.f(Ae)?(Fe.path=`/styles/v1${Fe.path}/iconset.pbf`,this._makeAPIURL(Fe,this._customAccessToken||Oe)):C(Fe)}normalizeSpriteURL(Ae,Oe,Fe,Ve){const qe=S(Ae);return F.f(Ae)?(qe.path=`/styles/v1${qe.path}/sprite${Oe}${Fe}`,this._makeAPIURL(qe,this._customAccessToken||Ve)):(qe.path+=`${Oe}${Fe}`,C(qe))}normalizeTileURL(Ae,Oe,Fe){if(this._isSkuTokenExpired()&&this._createSkuToken(),Ae&&!F.f(Ae))return Ae;const Ve=S(Ae);Ve.path=Ve.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${Oe||Fe&&"raster"!==Ve.authority&&512===Fe?"@2x":""}${F.m.supported?".webp":"$1"}`),"raster"===Ve.authority?Ve.path=`/${F.e.RASTER_URL_PREFIX}${Ve.path}`:"rasterarrays"===Ve.authority?Ve.path=`/${F.e.RASTERARRAYS_URL_PREFIX}${Ve.path}`:"3dtiles"===Ve.authority?Ve.path=`/${F.e.TILES3D_URL_PREFIX}${Ve.path}`:(Ve.path=Ve.path.replace(/^.+\/v4\//,"/"),Ve.path=`/${F.e.TILE_URL_VERSION}${Ve.path}`);const qe=this._customAccessToken||function(F){for(const Ae of F){const F=Ae.match(/^access_token=(.*)$/);if(F)return F[1]}return null}(Ve.params)||F.e.ACCESS_TOKEN;return F.e.REQUIRE_ACCESS_TOKEN&&qe&&this._skuToken&&Ve.params.push(`sku=${this._skuToken}`),this._makeAPIURL(Ve,qe)}canonicalizeTileURL(Ae,Oe){const Fe=S(Ae);if(!Fe.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!Fe.path.match(/\.[\w]+$/))return Ae;let Ve="mapbox://";Fe.path.match(/^\/raster\/v1\//)?Ve+=`raster/${Fe.path.replace(`/${F.e.RASTER_URL_PREFIX}/`,"")}`:Fe.path.match(/^\/rasterarrays\/v1\//)?Ve+=`rasterarrays/${Fe.path.replace(`/${F.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:Ve+=`tiles/${Fe.path.replace(`/${F.e.TILE_URL_VERSION}/`,"")}`;let qe=Fe.params;return Oe&&(qe=qe.filter((F=>!F.match(/^access_token=/)))),qe.length&&(Ve+=`?${qe.join("&")}`),Ve}canonicalizeTileset(Ae,Oe){const Fe=!!Oe&&F.f(Oe),Ve=[];for(const Oe of Ae.tiles||[])F.h(Oe)?Ve.push(this.canonicalizeTileURL(Oe,Fe)):Ve.push(Oe);return Ve}_makeAPIURL(Ae,Oe){const Fe="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",Ve=S(F.e.API_URL);if(Ae.protocol=Ve.protocol,Ae.authority=Ve.authority,"http"===Ae.protocol){const F=Ae.params.indexOf("secure");F>=0&&Ae.params.splice(F,1)}if("/"!==Ve.path&&(Ae.path=`${Ve.path}${Ae.path}`),!F.e.REQUIRE_ACCESS_TOKEN)return C(Ae);if(Oe=Oe||F.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!Oe)throw new Error(`An API access token is required to use Mapbox GL. ${Fe}`);if("s"===Oe[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${Fe}`)}return Ae.params=Ae.params.filter((F=>-1===F.indexOf("access_token"))),Ae.params.push(`access_token=${Oe||""}`),C(Ae)}}const wi=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function S(F){const Ae=F.match(wi);if(!Ae)throw new Error("Unable to parse URL object");return{protocol:Ae[1],authority:Ae[2],path:Ae[3]||"/",params:Ae[4]?Ae[4].split("&"):[]}}function C(F){const Ae=F.params.length?`?${F.params.join("&")}`:"";return`${F.protocol}://${F.authority}${F.path}${Ae}`}const dr="mapbox.eventData";function R(Ae){if(!Ae)return null;const Oe=Ae.split(".");if(!Oe||3!==Oe.length)return null;try{return JSON.parse(F.j(Oe[1]))}catch(F){return null}}class D{constructor(F){this.type=F,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(Ae){const Oe=R(F.e.ACCESS_TOKEN);let Fe="";return Fe=Oe&&Oe.u?F.k(Oe.u):F.e.ACCESS_TOKEN||"",Ae?`${dr}.${Ae}:${Fe}`:`${dr}:${Fe}`}fetchEventData(){const Ae=F.s("localStorage"),Oe=this.getStorageKey(),Fe=this.getStorageKey("uuid");if(Ae)try{const F=localStorage.getItem(Oe);F&&(this.eventData=JSON.parse(F));const Ae=localStorage.getItem(Fe);Ae&&(this.anonId=Ae)}catch(Ae){F.w("Unable to read from LocalStorage")}}saveEventData(){const Ae=F.s("localStorage"),Oe=this.getStorageKey(),Fe=this.getStorageKey("uuid"),Ve=this.anonId;if(Ae&&Ve)try{localStorage.setItem(Fe,Ve),Object.keys(this.eventData).length>=1&&localStorage.setItem(Oe,JSON.stringify(this.eventData))}catch(Ae){F.w("Unable to write to LocalStorage")}}processRequests(F){}postEvent(Ae,Oe,Fe,Ve){if(!F.e.EVENTS_URL)return;const qe=S(F.e.EVENTS_URL);qe.params.push(`access_token=${Ve||F.e.ACCESS_TOKEN||""}`);const pt={event:this.type,created:new Date(Ae).toISOString()},vt=Oe?F.l(pt,Oe):pt,zt={url:C(qe),headers:{"Content-Type":"text/plain"},body:JSON.stringify([vt])};this.pendingRequest=F.p(zt,(F=>{this.pendingRequest=null,Fe(F),this.saveEventData(),this.processRequests(Ve)}))}queueRequest(F,Ae){this.queue.push(F),this.processRequests(Ae)}}const jr=new class extends D{constructor(F){super("appUserTurnstile"),this._customAccessToken=F}postTurnstileEvent(Ae,Oe){F.e.EVENTS_URL&&F.e.ACCESS_TOKEN&&Array.isArray(Ae)&&Ae.some((Ae=>F.f(Ae)||F.h(Ae)))&&this.queueRequest(Date.now(),Oe)}processRequests(Oe){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const Fe=R(F.e.ACCESS_TOKEN),Ve=Fe?Fe.u:F.e.ACCESS_TOKEN;let qe=Ve!==this.eventData.tokenU;F.v(this.anonId)||(this.anonId=F.u(),qe=!0);const pt=this.queue.shift();if(this.eventData.lastSuccess){const F=new Date(this.eventData.lastSuccess),Ae=new Date(pt),Oe=(pt-this.eventData.lastSuccess)/864e5;qe=qe||Oe>=1||Oe<-1||F.getDate()!==Ae.getDate()}else qe=!0;qe?this.postEvent(pt,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Ae,skuId:xi,"enabled.telemetry":!1,userId:this.anonId},(F=>{F||(this.eventData.lastSuccess=pt,this.eventData.tokenU=Ve)}),Oe):this.processRequests()}},Qr=jr.postTurnstileEvent.bind(jr),Xn=new class extends D{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(Ae,Oe,Fe,Ve){this.skuToken=Oe,this.errorCb=Ve,F.e.EVENTS_URL&&(Fe||F.e.ACCESS_TOKEN?this.queueRequest({id:Ae,timestamp:Date.now()},Fe):this.errorCb(new Error(bi)))}processRequests(Oe){if(this.pendingRequest||0===this.queue.length)return;const{id:Fe,timestamp:Ve}=this.queue.shift();Fe&&this.success[Fe]||(this.anonId||this.fetchEventData(),F.v(this.anonId)||(this.anonId=F.u()),this.postEvent(Ve,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Ae,skuId:xi,skuToken:this.skuToken,userId:this.anonId},(F=>{F?this.errorCb(F):Fe&&(this.success[Fe]=!0)}),Oe))}remove(){this.errorCb=null}},ho=Xn.postMapLoadEvent.bind(Xn),yo=new class extends D{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(Ae){let Oe=this.mapInstanceIdMap.get(Ae);return Oe||(Oe=F.u(),this.mapInstanceIdMap.set(Ae,Oe)),Oe}getEventId(F){const Ae=this.eventIdPerMapInstanceMap.get(F)||0;return this.eventIdPerMapInstanceMap.set(F,Ae+1),Ae}postStyleLoadEvent(Ae,Oe){const{map:Fe,style:Ve,importedStyles:qe}=Oe;if(!F.e.EVENTS_URL||!Ae&&!F.e.ACCESS_TOKEN)return;const pt=this.getMapInstanceId(Fe),vt={mapInstanceId:pt,eventId:this.getEventId(pt),style:Ve};qe.length&&(vt.importedStyles=qe),this.queueRequest({timestamp:Date.now(),payload:vt},Ae)}processRequests(F){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:Ae,payload:Oe}=this.queue.shift();this.postEvent(Ae,Oe,(()=>{}),F)}},zo=yo.postStyleLoadEvent.bind(yo),ko=new class extends D{constructor(){super("gljs.performance")}postPerformanceEvent(Ae,Oe){F.e.EVENTS_URL&&(Ae||F.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:Oe},Ae)}processRequests(Fe){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:Ve,performanceData:qe}=this.queue.shift(),pt=function(Fe){const Ve=performance.getEntriesByType("resource"),qe=performance.getEntriesByType("mark"),pt=function(F){const Ae={};if(F)for(const Oe in F)if("other"!==Oe)for(const Fe of F[Oe]){const F=`${Oe}ResolveRangeMin`,Ve=`${Oe}ResolveRangeMax`,qe=`${Oe}RequestCount`,pt=`${Oe}RequestCachedCount`;Ae[F]=Math.min(Ae[F]||1/0,Fe.startTime),Ae[Ve]=Math.max(Ae[Ve]||-1/0,Fe.responseEnd);const n=F=>{void 0===Ae[F]&&(Ae[F]=0),++Ae[F]};void 0!==Fe.transferSize&&0===Fe.transferSize&&n(pt),n(qe)}return Ae}(function(F,Ae){const Oe={};if(F)for(const Fe of F){const F=Ae(Fe);void 0===Oe[F]&&(Oe[F]=[]),Oe[F].push(Fe)}return Oe}(Ve,s)),vt=window.devicePixelRatio,zt=navigator.connection||navigator.mozConnection||navigator.webkitConnection,ri=zt?zt.effectiveType:void 0,xi={counters:[],metadata:[],attributes:[]},d=(F,Ae,Oe)=>{null!=Oe&&F.push({name:Ae,value:Oe.toString()})};for(const F in pt)d(xi.counters,F,pt[F]);if(Fe.interactionRange[0]!==1/0&&Fe.interactionRange[1]!==-1/0&&(d(xi.counters,"interactionRangeMin",Fe.interactionRange[0]),d(xi.counters,"interactionRangeMax",Fe.interactionRange[1])),qe)for(const F of Object.keys(Oe)){const Ae=Oe[F],Fe=qe.find((F=>F.name===Ae));Fe&&d(xi.counters,Ae,Fe.startTime)}return d(xi.counters,"visibilityHidden",Fe.visibilityHidden),d(xi.attributes,"style",function(Ae){if(Ae)for(const Oe of Ae){const Ae=Oe.name.split("?")[0];if(F.i(Ae)){const F=Ae.split("/").slice(-2);if(2===F.length)return`mapbox://styles/${F[0]}/${F[1]}`}}}(Ve)),d(xi.attributes,"terrainEnabled",Fe.terrainEnabled?"true":"false"),d(xi.attributes,"fogEnabled",Fe.fogEnabled?"true":"false"),d(xi.attributes,"projection",Fe.projection),d(xi.attributes,"zoom",Fe.zoom),d(xi.metadata,"devicePixelRatio",vt),d(xi.metadata,"connectionEffectiveType",ri),d(xi.metadata,"navigatorUserAgent",navigator.userAgent),d(xi.metadata,"screenWidth",window.screen.width),d(xi.metadata,"screenHeight",window.screen.height),d(xi.metadata,"windowWidth",window.innerWidth),d(xi.metadata,"windowHeight",window.innerHeight),d(xi.metadata,"mapWidth",Fe.width/vt),d(xi.metadata,"mapHeight",Fe.height/vt),d(xi.metadata,"webglRenderer",Fe.renderer),d(xi.metadata,"webglVendor",Fe.vendor),d(xi.metadata,"sdkVersion",Ae),d(xi.metadata,"sdkIdentifier","mapbox-gl-js"),xi}(qe);for(const F of pt.metadata);for(const F of pt.counters);for(const F of pt.attributes);this.postEvent(Ve,pt,(()=>{}),Fe)}},Uo=ko.postPerformanceEvent.bind(ko),ia=new class extends D{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(Ae,Oe,Fe,Ve){if(!F.e.API_URL||!F.e.SESSION_PATH)return;const qe=S(F.e.API_URL+F.e.SESSION_PATH);qe.params.push(`sku=${Oe||""}`),qe.params.push(`access_token=${Ve||F.e.ACCESS_TOKEN||""}`);const pt={url:C(qe),headers:{"Content-Type":"text/plain"}};this.pendingRequest=F.g(pt,(F=>{this.pendingRequest=null,Fe(F),this.saveEventData(),this.processRequests(Ve)}))}getSessionAPI(Ae,Oe,Fe,Ve){this.skuToken=Oe,this.errorCb=Ve,F.e.SESSION_PATH&&F.e.API_URL&&(Fe||F.e.ACCESS_TOKEN?this.queueRequest({id:Ae,timestamp:Date.now()},Fe):this.errorCb(new Error(bi)))}processRequests(F){if(this.pendingRequest||0===this.queue.length)return;const{id:Ae,timestamp:Oe}=this.queue.shift();Ae&&this.success[Ae]||this.getSession(Oe,this.skuToken,(F=>{F?this.errorCb(F):Ae&&(this.success[Ae]=!0)}),F)}remove(){this.errorCb=null}},_a=ia.getSessionAPI.bind(ia),Ma=new Set;function j(F,Ae){Ae?Ma.add(F):Ma.delete(F)}class G{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(F,Ae){this._updatedSourceCaches[F]=Ae,this.setDirty()}discardSourceCacheUpdate(F){delete this._updatedSourceCaches[F]}updateLayer(F){const Ae=F.scope;this._updatedLayers[Ae]=this._updatedLayers[Ae]||new Set,this._updatedLayers[Ae].add(F.id),this.setDirty()}removeLayer(F){const Ae=F.scope;this._removedLayers[Ae]=this._removedLayers[Ae]||{},this._updatedLayers[Ae]=this._updatedLayers[Ae]||new Set,this._removedLayers[Ae][F.id]=F,this._updatedLayers[Ae].delete(F.id),this._updatedPaintProps.delete(F.fqid),this.setDirty()}getRemovedLayer(F){return this._removedLayers[F.scope]?this._removedLayers[F.scope][F.id]:null}discardLayerRemoval(F){this._removedLayers[F.scope]&&delete this._removedLayers[F.scope][F.id]}getLayerUpdatesByScope(){const F={};for(const Ae in this._updatedLayers)F[Ae]=F[Ae]||{},F[Ae].updatedIds=Array.from(this._updatedLayers[Ae].values());for(const Ae in this._removedLayers)F[Ae]=F[Ae]||{},F[Ae].removedIds=Object.keys(this._removedLayers[Ae]);return F}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(F){this._updatedPaintProps.add(F.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(F){this._updatedImages.add(F),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}function V(F){const{userImage:Ae}=F;return!!(Ae&&Ae.render&&Ae.render())&&(F.data.replace(new Uint8Array(Ae.data.buffer)),!0)}class q extends F.E{constructor(Ae){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0,this.spriteFormat=Ae,"raster"!==Ae&&F.t()&&(this.imageRasterizerDispatcher=new F.D(F.x(),this,"Image Rasterizer Worker",1))}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new F.I),this._imageRasterizer}createScope(Ae){this.images[Ae]={},this.loaded[Ae]=!1,this.updatedImages[Ae]={},this.patterns[Ae]={},this.callbackDispatchedThisFrame[Ae]={},this.atlasImage[Ae]=new F.r({width:1,height:1})}isLoaded(){for(const F in this.loaded)if(!this.loaded[F])return!1;return!0}setLoaded(F,Ae){if(this.loaded[Ae]!==F&&(this.loaded[Ae]=F,F)){for(const{ids:F,callback:Oe}of this.requestors)this._notify(F,Ae,Oe);this.requestors=[]}}hasImage(F,Ae){return!!this.getImage(F,Ae)}getImage(F,Ae){return this.images[Ae][F]}addImage(F,Ae,Oe){this._validate(F,Oe)&&(this.images[Ae][F]=Oe)}_validate(Ae,Oe){let Fe=!0;return this._validateStretch(Oe.stretchX,Oe.data&&Oe.data.width)||(this.fire(new F.y(new Error(`Image "${Ae}" has invalid "stretchX" value`))),Fe=!1),this._validateStretch(Oe.stretchY,Oe.data&&Oe.data.height)||(this.fire(new F.y(new Error(`Image "${Ae}" has invalid "stretchY" value`))),Fe=!1),this._validateContent(Oe.content,Oe)||(this.fire(new F.y(new Error(`Image "${Ae}" has invalid "content" value`))),Fe=!1),Fe}_validateStretch(F,Ae){if(!F)return!0;let Oe=0;for(const Fe of F){if(Fe[0]<Oe||Fe[1]<Fe[0]||Ae<Fe[1])return!1;Oe=Fe[1]}return!0}_validateContent(F,Ae){if(!F)return!0;if(4!==F.length)return!1;if(!Ae.usvg){if(F[0]<0||Ae.data.width<F[0])return!1;if(F[1]<0||Ae.data.height<F[1])return!1;if(F[2]<0||Ae.data.width<F[2])return!1;if(F[3]<0||Ae.data.height<F[3])return!1}return!(F[2]<F[0]||F[3]<F[1])}updateImage(F,Ae,Oe){Oe.version=this.images[Ae][F].version+1,this.images[Ae][F]=Oe,this.updatedImages[Ae][F]=!0,this.removeFromImageRasterizerCache(F,Ae)}removeFromImageRasterizerCache(Ae,Oe){"raster"!==this.spriteFormat&&(F.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[Ae],scope:Oe}):this.imageRasterizer.removeImagesFromCacheByIds([Ae],Oe))}removeImage(F,Ae){const Oe=this.images[Ae][F];delete this.images[Ae][F],delete this.patterns[Ae][F],this.removeFromImageRasterizerCache(F,Ae),Oe.userImage&&Oe.userImage.onRemove&&Oe.userImage.onRemove()}listImages(F){return Object.keys(this.images[F])}getImages(F,Ae,Oe){let Fe=!0;const Ve=!!this.loaded[Ae];if(!Ve)for(const Oe of F)this.images[Ae][Oe]||(Fe=!1);Ve||Fe?this._notify(F,Ae,Oe):this.requestors.push({ids:F,scope:Ae,callback:Oe})}rasterizeImages({scope:Ae,imageTasks:Oe},Fe){const Ve={};for(const F in Oe){const Fe=Oe[F],qe=this.getImage(Fe.id,Ae);qe&&(Ve[F]={image:qe,imageIdWithOptions:Fe})}F.t()?this.imageRasterizerDispatcher.getActor().send("rasterizeImages",{imageTasks:Ve,scope:Ae},Fe):this.rasterizeImagesInMainThread({imageTasks:Ve,scope:Ae},Fe)}rasterizeImagesInMainThread(F,Ae){const{imageTasks:Oe,scope:Fe}=F,Ve={};for(const F in Oe){const{image:Ae,imageIdWithOptions:qe}=Oe[F];Ve[F]=this.imageRasterizer.rasterize(qe,Ae,Fe,"")}Ae(void 0,Ve)}getUpdatedImages(F){return this.updatedImages[F]}_notify(Ae,Oe,Fe){const Ve={};for(const Fe of Ae){this.images[Oe][Fe]||this.fire(new F.z("styleimagemissing",{id:Fe}));const Ae=this.images[Oe][Fe];Ae?Ve[Fe]={data:Ae.usvg?null:Ae.data.clone(),pixelRatio:Ae.pixelRatio,sdf:Ae.sdf,usvg:Ae.usvg,version:Ae.version,stretchX:Ae.stretchX,stretchY:Ae.stretchY,content:Ae.content,hasRenderCallback:Boolean(Ae.userImage&&Ae.userImage.render)}:F.w(`Image "${Fe}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}Fe(null,Ve)}getPixelSize(F){const{width:Ae,height:Oe}=this.atlasImage[F];return{width:Ae,height:Oe}}getPattern(Ae,Oe,Fe){const Ve=this.patterns[Oe][Ae],qe=this.getImage(Ae,Oe);if(!qe)return null;if(Ve&&Ve.position.version===qe.version)return Ve.position;if(Ve)Ve.position.version=qe.version;else{qe.usvg&&!qe.data&&(qe.data=this.imageRasterizer.rasterize(F.A.from(Ae).getPrimary(),qe,Oe,""));const Fe={w:qe.data.width+2*F.B,h:qe.data.height+2*F.B,x:0,y:0},Ve=new F.C(Fe,qe,F.B);this.patterns[Oe][Ae]={bin:Fe,position:Ve}}return this._updatePatternAtlas(Oe,Fe),this.patterns[Oe][Ae].position}bind(Ae,Oe){const Fe=Ae.gl;let Ve=this.atlasTexture[Oe];Ve?this.dirty&&(Ve.update(this.atlasImage[Oe]),this.dirty=!1):(Ve=new F.T(Ae,this.atlasImage[Oe],Fe.RGBA8),this.atlasTexture[Oe]=Ve),Ve.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE)}_updatePatternAtlas(Ae,Oe){const Fe=[];for(const F in this.patterns[Ae])Fe.push(this.patterns[Ae][F].bin);const{w:Ve,h:qe}=F.F(Fe),pt=this.atlasImage[Ae];pt.resize({width:Ve||1,height:qe||1});for(const Fe in this.patterns[Ae]){const{bin:Ve,position:qe}=this.patterns[Ae][Fe];let vt=qe.padding;const zt=Ve.x+vt,ri=Ve.y+vt,xi=this.images[Ae][Fe].data,bi=xi.width,wi=xi.height;vt=vt>1?vt-1:vt,F.r.copy(xi,pt,{x:0,y:0},{x:zt,y:ri},{width:bi,height:wi},Oe),F.r.copy(xi,pt,{x:0,y:wi-vt},{x:zt,y:ri-vt},{width:bi,height:vt},Oe),F.r.copy(xi,pt,{x:0,y:0},{x:zt,y:ri+wi},{width:bi,height:vt},Oe),F.r.copy(xi,pt,{x:bi-vt,y:0},{x:zt-vt,y:ri},{width:vt,height:wi},Oe),F.r.copy(xi,pt,{x:0,y:0},{x:zt+bi,y:ri},{width:vt,height:wi},Oe),F.r.copy(xi,pt,{x:bi-vt,y:wi-vt},{x:zt-vt,y:ri-vt},{width:vt,height:vt},Oe),F.r.copy(xi,pt,{x:0,y:wi-vt},{x:zt+bi,y:ri-vt},{width:vt,height:vt},Oe),F.r.copy(xi,pt,{x:0,y:0},{x:zt+bi,y:ri+wi},{width:vt,height:vt},Oe),F.r.copy(xi,pt,{x:bi-vt,y:0},{x:zt-vt,y:ri+wi},{width:vt,height:vt},Oe)}this.dirty=!0}beginFrame(){for(const F in this.images)this.callbackDispatchedThisFrame[F]={}}dispatchRenderCallbacks(F,Ae){for(const Oe of F){if(this.callbackDispatchedThisFrame[Ae][Oe])continue;this.callbackDispatchedThisFrame[Ae][Oe]=!0;const F=this.images[Ae][Oe];V(F)&&this.updateImage(Oe,Ae,F)}}}function H(Ae){const Oe=Ae.key,Fe=Ae.value,Ve=Ae.valueSpec||{},qe=Ae.objectElementValidators||{},pt=Ae.style,vt=Ae.styleSpec;let zt=[];const ri=F.H(Fe);if("object"!==ri)return[new F.V(Oe,Fe,`object expected, ${ri} found`)];for(const Ae in Fe){const ri=Ae.split(".")[0];let xi;qe[ri]?xi=qe[ri]:Ve[ri]?xi=_e:qe["*"]?xi=qe["*"]:Ve["*"]&&(xi=_e),xi?zt=zt.concat(xi({key:(Oe?`${Oe}.`:Oe)+Ae,value:Fe[Ae],valueSpec:Ve[ri]||Ve["*"],style:pt,styleSpec:vt,object:Fe,objectKey:Ae},Fe)):zt.push(new F.G(Oe,Fe[Ae],`unknown property "${Ae}"`))}for(const Ae in Ve)qe[Ae]||Ve[Ae].required&&void 0===Ve[Ae].default&&void 0===Fe[Ae]&&zt.push(new F.V(Oe,Fe,`missing required property "${Ae}"`));return zt}function Z(Ae){const Oe=Ae.value,Fe=Ae.valueSpec,Ve=Ae.style,qe=Ae.styleSpec,pt=Ae.key,vt=Ae.arrayElementValidator||_e;if("array"!==F.H(Oe))return[new F.V(pt,Oe,`array expected, ${F.H(Oe)} found`)];if(Fe.length&&Oe.length!==Fe.length)return[new F.V(pt,Oe,`array length ${Fe.length} expected, length ${Oe.length} found`)];if(Fe["min-length"]&&Oe.length<Fe["min-length"])return[new F.V(pt,Oe,`array length at least ${Fe["min-length"]} expected, length ${Oe.length} found`)];let zt={type:Fe.value,values:Fe.values,minimum:Fe.minimum,maximum:Fe.maximum,function:void 0};qe.$version<7&&(zt.function=Fe.function),"object"===F.H(Fe.value)&&(zt=Fe.value);let ri=[];for(let F=0;F<Oe.length;F++)ri=ri.concat(vt({array:Oe,arrayIndex:F,value:Oe[F],valueSpec:zt,style:Ve,styleSpec:qe,key:`${pt}[${F}]`},!0));return ri}function W(Ae){const Oe=Ae.key,Fe=Ae.value,Ve=Ae.valueSpec;let qe=F.H(Fe);if("number"===qe&&Fe!=Fe&&(qe="NaN"),"number"!==qe)return[new F.V(Oe,Fe,`number expected, ${qe} found`)];if("minimum"in Ve){let qe=Ve.minimum;if("array"===F.H(Ve.minimum)&&(qe=Ve.minimum[Ae.arrayIndex]),Fe<qe)return[new F.V(Oe,Fe,`${Fe} is less than the minimum value ${qe}`)]}if("maximum"in Ve){let qe=Ve.maximum;if("array"===F.H(Ve.maximum)&&(qe=Ve.maximum[Ae.arrayIndex]),Fe>qe)return[new F.V(Oe,Fe,`${Fe} is greater than the maximum value ${qe}`)]}return[]}function $(Ae){const Oe=Ae.valueSpec,Fe=F.K(Ae.value.type);let Ve,qe,pt,vt={};const zt="categorical"!==Fe&&void 0===Ae.value.property,ri=!zt,xi="array"===F.H(Ae.value.stops)&&"array"===F.H(Ae.value.stops[0])&&"object"===F.H(Ae.value.stops[0][0]),bi=H({key:Ae.key,value:Ae.value,valueSpec:Ae.styleSpec.function,style:Ae.style,styleSpec:Ae.styleSpec,objectElementValidators:{stops:function(Ae){if("identity"===Fe)return[new F.V(Ae.key,Ae.value,'identity function may not have a "stops" property')];let Oe=[];const Ve=Ae.value;return Oe=Oe.concat(Z({key:Ae.key,value:Ve,valueSpec:Ae.valueSpec,style:Ae.style,styleSpec:Ae.styleSpec,arrayElementValidator:d})),"array"===F.H(Ve)&&0===Ve.length&&Oe.push(new F.V(Ae.key,Ve,"array must have at least one stop")),Oe},default:function(F){return _e({key:F.key,value:F.value,valueSpec:Oe,style:F.style,styleSpec:F.styleSpec})}}});return"identity"===Fe&&zt&&bi.push(new F.V(Ae.key,Ae.value,'missing required property "property"')),"identity"===Fe||Ae.value.stops||bi.push(new F.V(Ae.key,Ae.value,'missing required property "stops"')),"exponential"===Fe&&Ae.valueSpec.expression&&!F.L(Ae.valueSpec)&&bi.push(new F.V(Ae.key,Ae.value,"exponential functions not supported")),Ae.styleSpec.$version>=8&&(ri&&!F.M(Ae.valueSpec)?bi.push(new F.V(Ae.key,Ae.value,"property functions not supported")):zt&&!F.N(Ae.valueSpec)&&bi.push(new F.V(Ae.key,Ae.value,"zoom functions not supported"))),"categorical"!==Fe&&!xi||void 0!==Ae.value.property||bi.push(new F.V(Ae.key,Ae.value,'"property" property is required')),bi;function d(Ae){let Fe=[];const Ve=Ae.value,zt=Ae.key;if("array"!==F.H(Ve))return[new F.V(zt,Ve,`array expected, ${F.H(Ve)} found`)];if(2!==Ve.length)return[new F.V(zt,Ve,`array length 2 expected, length ${Ve.length} found`)];if(xi){if("object"!==F.H(Ve[0]))return[new F.V(zt,Ve,`object expected, ${F.H(Ve[0])} found`)];if(void 0===Ve[0].zoom)return[new F.V(zt,Ve,"object stop key must have zoom")];if(void 0===Ve[0].value)return[new F.V(zt,Ve,"object stop key must have value")];const Oe=F.K(Ve[0].zoom);if("number"!=typeof Oe)return[new F.V(zt,Ve[0].zoom,"stop zoom values must be numbers")];if(pt&&pt>Oe)return[new F.V(zt,Ve[0].zoom,"stop zoom values must appear in ascending order")];Oe!==pt&&(pt=Oe,qe=void 0,vt={}),Fe=Fe.concat(H({key:`${zt}[0]`,value:Ve[0],valueSpec:{zoom:{}},style:Ae.style,styleSpec:Ae.styleSpec,objectElementValidators:{zoom:W,value:_}}))}else Fe=Fe.concat(_({key:`${zt}[0]`,value:Ve[0],valueSpec:{},style:Ae.style,styleSpec:Ae.styleSpec},Ve));return F.O(F.Q(Ve[1]))?Fe.concat([new F.V(`${zt}[1]`,Ve[1],"expressions are not allowed in function stops.")]):Fe.concat(_e({key:`${zt}[1]`,value:Ve[1],valueSpec:Oe,style:Ae.style,styleSpec:Ae.styleSpec}))}function _(Ae,pt){const zt=F.H(Ae.value),ri=F.K(Ae.value),xi=null!==Ae.value?Ae.value:pt;if(Ve){if(zt!==Ve)return[new F.V(Ae.key,xi,`${zt} stop domain type must match previous stop domain type ${Ve}`)]}else Ve=zt;if("number"!==zt&&"string"!==zt&&"boolean"!==zt&&"number"!=typeof ri&&"string"!=typeof ri&&"boolean"!=typeof ri)return[new F.V(Ae.key,xi,"stop domain value must be a number, string, or boolean")];if("number"!==zt&&"categorical"!==Fe){let Ve=`number expected, ${zt} found`;return F.M(Oe)&&void 0===Fe&&(Ve+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new F.V(Ae.key,xi,Ve)]}return"categorical"!==Fe||"number"!==zt||"number"==typeof ri&&isFinite(ri)&&Math.floor(ri)===ri?"categorical"!==Fe&&"number"===zt&&"number"==typeof ri&&"number"==typeof qe&&void 0!==qe&&ri<qe?[new F.V(Ae.key,xi,"stop domain values must appear in ascending order")]:(qe=ri,"categorical"===Fe&&ri in vt?[new F.V(Ae.key,xi,"stop domain values must be unique")]:(vt[ri]=!0,[])):[new F.V(Ae.key,xi,`integer expected, found ${String(ri)}`)]}}function X(Ae){const Oe=("property"===Ae.expressionContext?F.S:F.U)(F.Q(Ae.value),Ae.valueSpec);if("error"===Oe.result)return Oe.value.map((Oe=>new F.V(`${Ae.key}${Oe.key}`,Ae.value,Oe.message)));const Fe=Oe.value.expression||Oe.value._styleExpression.expression;if("property"===Ae.expressionContext&&"text-font"===Ae.propertyKey&&!Fe.outputDefined())return[new F.V(Ae.key,Ae.value,`Invalid data expression for "${Ae.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===Ae.expressionContext&&"layout"===Ae.propertyType&&!F.W(Fe))return[new F.V(Ae.key,Ae.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===Ae.expressionContext)return K(Fe,Ae);if(Ae.expressionContext&&0===Ae.expressionContext.indexOf("cluster")){if(!F.X(Fe,["zoom","feature-state"]))return[new F.V(Ae.key,Ae.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===Ae.expressionContext&&!F.Y(Fe))return[new F.V(Ae.key,Ae.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function K(Ae,Oe){const Fe=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(Oe.valueSpec&&Oe.valueSpec.expression)for(const F of Oe.valueSpec.expression.parameters)Fe.delete(F);if(0===Fe.size)return[];const Ve=[];return Ae instanceof F.Z&&Fe.has(Ae.name)?[new F.V(Oe.key,Oe.value,`["${Ae.name}"] expression is not supported in a filter for a ${Oe.object.type} layer with id: ${Oe.object.id}`)]:(Ae.eachChild((F=>{Ve.push(...K(F,Oe))})),Ve)}function Y(Ae){const Oe=Ae.key,Fe=Ae.value,Ve=Ae.valueSpec,qe=[];return Array.isArray(Ve.values)?-1===Ve.values.indexOf(F.K(Fe))&&qe.push(new F.V(Oe,Fe,`expected one of [${Ve.values.join(", ")}], ${JSON.stringify(Fe)} found`)):-1===Object.keys(Ve.values).indexOf(F.K(Fe))&&qe.push(new F.V(Oe,Fe,`expected one of [${Object.keys(Ve.values).join(", ")}], ${JSON.stringify(Fe)} found`)),qe}function J(Ae){return F.$(F.Q(Ae.value))?X(F.J({},Ae,{expressionContext:"filter",valueSpec:Ae.styleSpec[`filter_${Ae.layerType||"fill"}`]})):Q(Ae)}function Q(Ae){const Oe=Ae.value,Fe=Ae.key;if("array"!==F.H(Oe))return[new F.V(Fe,Oe,`array expected, ${F.H(Oe)} found`)];const Ve=Ae.styleSpec;let qe,pt=[];if(Oe.length<1)return[new F.V(Fe,Oe,"filter array must have at least 1 element")];switch(pt=pt.concat(Y({key:`${Fe}[0]`,value:Oe[0],valueSpec:Ve.filter_operator,style:Ae.style,styleSpec:Ae.styleSpec})),F.K(Oe[0])){case"<":case"<=":case">":case">=":Oe.length>=2&&"$type"===F.K(Oe[1])&&pt.push(new F.V(Fe,Oe,`"$type" cannot be use with operator "${Oe[0]}"`));case"==":case"!=":3!==Oe.length&&pt.push(new F.V(Fe,Oe,`filter array for operator "${Oe[0]}" must have 3 elements`));case"in":case"!in":Oe.length>=2&&(qe=F.H(Oe[1]),"string"!==qe&&pt.push(new F.V(`${Fe}[1]`,Oe[1],`string expected, ${qe} found`)));for(let vt=2;vt<Oe.length;vt++)qe=F.H(Oe[vt]),"$type"===F.K(Oe[1])?pt=pt.concat(Y({key:`${Fe}[${vt}]`,value:Oe[vt],valueSpec:Ve.geometry_type,style:Ae.style,styleSpec:Ae.styleSpec})):"string"!==qe&&"number"!==qe&&"boolean"!==qe&&pt.push(new F.V(`${Fe}[${vt}]`,Oe[vt],`string, number, or boolean expected, ${qe} found`));break;case"any":case"all":case"none":for(let F=1;F<Oe.length;F++)pt=pt.concat(Q({key:`${Fe}[${F}]`,value:Oe[F],style:Ae.style,styleSpec:Ae.styleSpec}));break;case"has":case"!has":qe=F.H(Oe[1]),2!==Oe.length?pt.push(new F.V(Fe,Oe,`filter array for "${Oe[0]}" operator must have 2 elements`)):"string"!==qe&&pt.push(new F.V(`${Fe}[1]`,Oe[1],`string expected, ${qe} found`))}return pt}function ee(Ae,Oe){const Fe=Ae.key,Ve=Ae.style,qe=Ae.layer,pt=Ae.styleSpec,vt=Ae.value,zt=Ae.objectKey,ri=pt[`${Oe}_${Ae.layerType}`];if(!ri)return[];const xi=zt.match(/^(.*)-use-theme$/);if("paint"===Oe&&xi&&ri[xi[1]])return F.O(vt)?[].concat(_e({key:Ae.key,value:vt,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:Ve,styleSpec:pt,expressionContext:"property",propertyType:Oe,propertyKey:zt})):_e({key:Fe,value:vt,valueSpec:{type:"string"},style:Ve,styleSpec:pt});const bi=zt.match(/^(.*)-transition$/);if("paint"===Oe&&bi&&ri[bi[1]]&&ri[bi[1]].transition)return _e({key:Fe,value:vt,valueSpec:pt.transition,style:Ve,styleSpec:pt});const wi=Ae.valueSpec||ri[zt];if(!wi)return[new F.G(Fe,vt,`unknown property "${zt}"`)];let dr;if("string"===F.H(vt)&&F.M(wi)&&!wi.tokens&&(dr=/^{([^}]+)}$/.exec(vt))){const Ae=`\`{ "type": "identity", "property": ${dr?JSON.stringify(dr[1]):'"_"'} }\``;return[new F.V(Fe,vt,`"${zt}" does not support interpolation syntax\nUse an identity property function instead: ${Ae}.`)]}const jr=[];if("symbol"===Ae.layerType)"text-field"!==zt||!Ve||Ve.glyphs||Ve.imports||jr.push(new F.V(Fe,vt,'use of "text-field" requires a style "glyphs" property')),"text-font"===zt&&F.a0(F.Q(vt))&&"identity"===F.K(vt.type)&&jr.push(new F.V(Fe,vt,'"text-font" does not support identity functions'));else if("model"===Ae.layerType&&"paint"===Oe&&qe&&qe.layout&&qe.layout.hasOwnProperty("model-id")&&F.M(wi)&&(F.a1(wi)||F.N(wi))){const Ae=F.S(F.Q(vt),wi),Oe=Ae.value.expression||Ae.value._styleExpression.expression;Oe&&!F.X(Oe,["measure-light"])&&("model-emissive-strength"===zt&&F.Y(Oe)&&F.W(Oe)||jr.push(new F.V(Fe,vt,`${zt} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return jr.concat(_e({key:Ae.key,value:vt,valueSpec:wi,style:Ve,styleSpec:pt,expressionContext:"property",propertyType:Oe,propertyKey:zt}))}function te(F){return ee(F,"paint")}function ie(F){return ee(F,"layout")}function oe(Ae){let Oe=[];const Fe=Ae.value,Ve=Ae.key,qe=Ae.style,pt=Ae.styleSpec;Fe.type||Fe.ref||Oe.push(new F.V(Ve,Fe,'either "type" or "ref" is required'));let vt=F.K(Fe.type);const zt=F.K(Fe.ref);if(Fe.id){const pt=F.K(Fe.id);for(let vt=0;vt<Ae.arrayIndex;vt++){const Ae=qe.layers[vt];F.K(Ae.id)===pt&&Oe.push(new F.V(Ve,Fe.id,`duplicate layer id "${Fe.id}", previously used at line ${Ae.id.__line__}`))}}if("ref"in Fe){let Ae;["type","source","source-layer","filter","layout"].forEach((Ae=>{Ae in Fe&&Oe.push(new F.V(Ve,Fe[Ae],`"${Ae}" is prohibited for ref layers`))})),qe.layers.forEach((Oe=>{F.K(Oe.id)===zt&&(Ae=Oe)})),Ae?Ae.ref?Oe.push(new F.V(Ve,Fe.ref,"ref cannot reference another ref layer")):vt=F.K(Ae.type):"string"==typeof zt&&Oe.push(new F.V(Ve,Fe.ref,`ref layer "${zt}" not found`))}else if("background"!==vt&&"sky"!==vt&&"slot"!==vt)if(Fe.source){const Ae=qe.sources&&qe.sources[Fe.source],pt=Ae&&F.K(Ae.type);Ae?"vector"===pt&&"raster"===vt?Oe.push(new F.V(Ve,Fe.source,`layer "${Fe.id}" requires a raster source`)):"raster"===pt&&"raster"!==vt?Oe.push(new F.V(Ve,Fe.source,`layer "${Fe.id}" requires a vector source`)):"vector"!==pt||Fe["source-layer"]?"raster-dem"===pt&&"hillshade"!==vt?Oe.push(new F.V(Ve,Fe.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==pt||["raster","raster-particle"].includes(vt)?"line"!==vt||!Fe.paint||!Fe.paint["line-gradient"]&&!Fe.paint["line-trim-offset"]||"geojson"===pt&&Ae.lineMetrics?"raster-particle"===vt&&"raster-array"!==pt&&Oe.push(new F.V(Ve,Fe.source,`layer "${Fe.id}" requires a 'raster-array' source.`)):Oe.push(new F.V(Ve,Fe,`layer "${Fe.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):Oe.push(new F.V(Ve,Fe.source,"raster-array source can only be used with layer type 'raster'.")):Oe.push(new F.V(Ve,Fe,`layer "${Fe.id}" must specify a "source-layer"`)):Oe.push(new F.V(Ve,Fe.source,`source "${Fe.source}" not found`))}else Oe.push(new F.V(Ve,Fe,'missing required property "source"'));return Oe=Oe.concat(H({key:Ve,value:Fe,valueSpec:pt.layer,style:Ae.style,styleSpec:Ae.styleSpec,objectElementValidators:{"*":()=>[],type:()=>_e({key:`${Ve}.type`,value:Fe.type,valueSpec:pt.layer.type,style:Ae.style,styleSpec:Ae.styleSpec,object:Fe,objectKey:"type"}),filter:Ae=>J(F.J({layerType:vt},Ae)),layout:Ae=>H({layer:Fe,key:Ae.key,value:Ae.value,valueSpec:{},style:Ae.style,styleSpec:Ae.styleSpec,objectElementValidators:{"*":Ae=>ie(F.J({layerType:vt},Ae))}}),paint:Ae=>H({layer:Fe,key:Ae.key,value:Ae.value,valueSpec:{},style:Ae.style,styleSpec:Ae.styleSpec,objectElementValidators:{"*":Ae=>te(F.J({layerType:vt,layer:Fe},Ae))}})}})),Oe}function se(Ae){const Oe=Ae.value,Fe=Ae.key,Ve=F.H(Oe);return"string"!==Ve?[new F.V(Fe,Oe,`string expected, ${Ve} found`)]:[]}const Ea={promoteId:function t({key:Ae,value:Oe}){if("string"===F.H(Oe))return se({key:Ae,value:Oe});if(Array.isArray(Oe)){const Fe=[],Ve=F.Q(Oe),qe=F.U(Ve);return"error"===qe.result&&qe.value.forEach((Oe=>{Fe.push(new F.V(`${Ae}${Oe.key}`,null,`${Oe.message}`))})),F.X(qe.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||Fe.push(new F.V(`${Ae}`,null,"promoteId expression should be only feature dependent")),Fe}{const F=[];for(const Fe in Oe)F.push(...t({key:`${Ae}.${Fe}`,value:Oe[Fe]}));return F}}};function ae(Ae){const Oe=Ae.value,Fe=Ae.key,Ve=Ae.styleSpec,qe=Ae.style;if(!Oe.type)return[new F.V(Fe,Oe,'"type" is required')];const pt=F.K(Oe.type);let vt=[];switch(["vector","raster","raster-dem","raster-array"].includes(pt)&&(Oe.url||Oe.tiles||vt.push(new F.G(Fe,Oe,'Either "url" or "tiles" is required.'))),pt){case"vector":case"raster":case"raster-dem":case"raster-array":return vt=vt.concat(H({key:Fe,value:Oe,valueSpec:Ve[`source_${pt.replace("-","_")}`],style:Ae.style,styleSpec:Ve,objectElementValidators:Ea})),vt;case"geojson":if(vt=H({key:Fe,value:Oe,valueSpec:Ve.source_geojson,style:qe,styleSpec:Ve,objectElementValidators:Ea}),Oe.cluster)for(const F in Oe.clusterProperties){const[Ae,Ve]=Oe.clusterProperties[F],qe="string"==typeof Ae?[Ae,["accumulated"],["get",F]]:Ae;vt.push(...X({key:`${Fe}.${F}.map`,value:Ve,expressionContext:"cluster-map"})),vt.push(...X({key:`${Fe}.${F}.reduce`,value:qe,expressionContext:"cluster-reduce"}))}return vt;case"video":return H({key:Fe,value:Oe,valueSpec:Ve.source_video,style:qe,styleSpec:Ve});case"image":return H({key:Fe,value:Oe,valueSpec:Ve.source_image,style:qe,styleSpec:Ve});case"canvas":return[new F.V(Fe,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Y({key:`${Fe}.type`,value:Oe.type,valueSpec:{values:ne(Ve)},style:qe,styleSpec:Ve})}}function ne(F){return F.source.reduce(((Ae,Oe)=>{const Fe=F[Oe];return"enum"===Fe.type.type&&(Ae=Ae.concat(Object.keys(Fe.type.values))),Ae}),[])}function le(Ae){const Oe=Ae.value,Fe=Ae.styleSpec,Ve=Fe.light,qe=Ae.style;let pt=[];const vt=F.H(Oe);if(void 0===Oe)return pt;if("object"!==vt)return pt=pt.concat([new F.V("light",Oe,`object expected, ${vt} found`)]),pt;for(const Ae in Oe){const vt=Ae.match(/^(.*)-transition$/),zt=Ae.match(/^(.*)-use-theme$/);pt=pt.concat(zt&&Ve[zt[1]]?_e({key:Ae,value:Oe[Ae],valueSpec:{type:"string"},style:qe,styleSpec:Fe}):vt&&Ve[vt[1]]&&Ve[vt[1]].transition?_e({key:Ae,value:Oe[Ae],valueSpec:Fe.transition,style:qe,styleSpec:Fe}):Ve[Ae]?_e({key:Ae,value:Oe[Ae],valueSpec:Ve[Ae],style:qe,styleSpec:Fe}):[new F.V(Ae,Oe[Ae],`unknown property "${Ae}"`)])}return pt}function ce(Ae){const Oe=Ae.value;let Fe=[];if(!Oe)return Fe;const Ve=F.H(Oe);if("object"!==Ve)return Fe=Fe.concat([new F.V("light-3d",Oe,`object expected, ${Ve} found`)]),Fe;const qe=Ae.styleSpec,pt=qe["light-3d"],vt=Ae.key,zt=Ae.style,ri=Ae.style.lights;for(const Ae of["type","id"])if(!(Ae in Oe))return Fe=Fe.concat([new F.V("light-3d",Oe,`missing property ${Ae} on light`)]),Fe;if(Oe.type&&ri)for(let Ve=0;Ve<Ae.arrayIndex;Ve++){const Ae=F.K(Oe.type),qe=ri[Ve];F.K(qe.type)===Ae&&Fe.push(new F.V(vt,Oe.id,`duplicate light type "${Oe.type}", previously defined at line ${qe.id.__line__}`))}const xi=`properties_light_${Oe.type}`;if(!(xi in qe))return Fe=Fe.concat([new F.V("light-3d",Oe,`Invalid light type ${Oe.type}`)]),Fe;const bi=qe[xi];for(const Ve in Oe)if("properties"===Ve){const pt=Oe[Ve],vt=F.H(pt);if("object"!==vt)return Fe=Fe.concat([new F.V("properties",pt,`object expected, ${vt} found`)]),Fe;for(const Oe in pt)Fe=Fe.concat(bi[Oe]?_e({key:Oe,value:pt[Oe],valueSpec:bi[Oe],style:zt,styleSpec:qe}):[new F.G(Ae.key,pt[Oe],`unknown property "${Oe}"`)])}else{const Ae=Ve.match(/^(.*)-transition$/),vt=Ve.match(/^(.*)-use-theme$/);Fe=Fe.concat(vt&&pt[vt[1]]?_e({key:Ve,value:Oe[Ve],valueSpec:{type:"string"},style:zt,styleSpec:qe}):Ae&&pt[Ae[1]]&&pt[Ae[1]].transition?_e({key:Ve,value:Oe[Ve],valueSpec:qe.transition,style:zt,styleSpec:qe}):pt[Ve]?_e({key:Ve,value:Oe[Ve],valueSpec:pt[Ve],style:zt,styleSpec:qe}):[new F.G(Ve,Oe[Ve],`unknown property "${Ve}"`)])}return Fe}function he(Ae){const Oe=Ae.value,Fe=Ae.key,Ve=Ae.style,qe=Ae.styleSpec,pt=qe.terrain;let vt=[];const zt=F.H(Oe);if(void 0===Oe)return vt;if("null"===zt)return vt;if("object"!==zt)return vt=vt.concat([new F.V("terrain",Oe,`object expected, ${zt} found`)]),vt;for(const Ae in Oe){const Fe=Ae.match(/^(.*)-transition$/),zt=Ae.match(/^(.*)-use-theme$/);vt=vt.concat(zt&&pt[zt[1]]?_e({key:Ae,value:Oe[Ae],valueSpec:{type:"string"},style:Ve,styleSpec:qe}):Fe&&pt[Fe[1]]&&pt[Fe[1]].transition?_e({key:Ae,value:Oe[Ae],valueSpec:qe.transition,style:Ve,styleSpec:qe}):pt[Ae]?_e({key:Ae,value:Oe[Ae],valueSpec:pt[Ae],style:Ve,styleSpec:qe}):[new F.G(Ae,Oe[Ae],`unknown property "${Ae}"`)])}if(Oe.source){const Ae=Ve.sources&&Ve.sources[Oe.source],qe=Ae&&F.K(Ae.type);Ae?"raster-dem"!==qe&&vt.push(new F.V(Fe,Oe.source,`terrain cannot be used with a source of type ${String(qe)}, it only be used with a "raster-dem" source type`)):vt.push(new F.V(Fe,Oe.source,`source "${Oe.source}" not found`))}else vt.push(new F.V(Fe,Oe,'terrain is missing required property "source"'));return vt}function ue(Ae){const Oe=Ae.value,Fe=Ae.style,Ve=Ae.styleSpec,qe=Ve.fog;let pt=[];const vt=F.H(Oe);if(void 0===Oe)return pt;if("object"!==vt)return pt=pt.concat([new F.V("fog",Oe,`object expected, ${vt} found`)]),pt;for(const Ae in Oe){const vt=Ae.match(/^(.*)-transition$/),zt=Ae.match(/^(.*)-use-theme$/);pt=pt.concat(zt&&qe[zt[1]]?_e({key:Ae,value:Oe[Ae],valueSpec:{type:"string"},style:Fe,styleSpec:Ve}):vt&&qe[vt[1]]&&qe[vt[1]].transition?_e({key:Ae,value:Oe[Ae],valueSpec:Ve.transition,style:Fe,styleSpec:Ve}):qe[Ae]?_e({key:Ae,value:Oe[Ae],valueSpec:qe[Ae],style:Fe,styleSpec:Ve}):[new F.G(Ae,Oe[Ae],`unknown property "${Ae}"`)])}return pt}const Ia={"*":()=>[],array:Z,boolean:function(Ae){const Oe=Ae.value,Fe=Ae.key,Ve=F.H(Oe);return"boolean"!==Ve?[new F.V(Fe,Oe,`boolean expected, ${Ve} found`)]:[]},number:W,color:function(Ae){const Oe=Ae.key,Fe=Ae.value,Ve=F.H(Fe);return"string"!==Ve?[new F.V(Oe,Fe,`color expected, ${Ve} found`)]:null===F._.parseCSSColor(Fe)?[new F.V(Oe,Fe,`color expected, "${Fe}" found`)]:[]},enum:Y,filter:J,function:$,layer:oe,object:H,source:ae,model:F.a2,light:le,"light-3d":ce,terrain:he,fog:ue,string:se,formatted:function(F){return 0===se(F).length?[]:X(F)},resolvedImage:function(F){return 0===se(F).length?[]:X(F)},projection:function(Ae){const Oe=Ae.value,Fe=Ae.styleSpec,Ve=Fe.projection,qe=Ae.style;let pt=[];const vt=F.H(Oe);if("object"===vt)for(const F in Oe)pt=pt.concat(_e({key:F,value:Oe[F],valueSpec:Ve[F],style:qe,styleSpec:Fe}));else"string"!==vt&&(pt=pt.concat([new F.V("projection",Oe,`object or string expected, ${vt} found`)]));return pt},import:function(Ae){const{value:Oe,styleSpec:Fe}=Ae,{data:Ve,...qe}=Oe;Object.defineProperty(qe,"__line__",{value:Oe.__line__,enumerable:!1});let pt=H(F.J({},Ae,{value:qe,valueSpec:Fe.import}));return""===F.K(qe.id)&&pt.push(new F.V(`${Ae.key}.id`,qe,"import id can't be an empty string")),Ve&&(pt=pt.concat(fe(Ve,Fe,{key:`${Ae.key}.data`}))),pt}};function _e(Ae,Oe=!1){const Fe=Ae.value,Ve=Ae.valueSpec,qe=Ae.styleSpec;if(Ve.expression&&F.a0(F.K(Fe)))return $(Ae);if(Ve.expression&&F.O(F.Q(Fe)))return X(Ae);if(Ve.type&&Ia[Ve.type]){const Fe=Ia[Ve.type](Ae);return!0===Oe&&Fe.length>0&&"array"===F.H(Ae.value)?X(Ae):Fe}return H(F.J({},Ae,{valueSpec:Ve.type?qe[Ve.type]:Ve}))}function pe(Ae){const Oe=Ae.value,Fe=Ae.key,Ve=se(Ae);return Ve.length||(-1===Oe.indexOf("{fontstack}")&&Ve.push(new F.V(Fe,Oe,'"glyphs" url must include a "{fontstack}" token')),-1===Oe.indexOf("{range}")&&Ve.push(new F.V(Fe,Oe,'"glyphs" url must include a "{range}" token'))),Ve}function fe(Ae,Oe=F.a3,Fe={}){return _e({key:Fe.key||"",value:Ae,valueSpec:Oe.$root,styleSpec:Oe,style:Ae,objectElementValidators:{glyphs:pe,"*":()=>[]}})}function me(Ae,Oe=F.a3){return De(fe(Ae,Oe))}const ge=F=>De(ae(F)),ve=F=>De(le(F)),ye=F=>De(ce(F)),xe=F=>De(he(F)),be=F=>De(ue(F)),we=Ae=>De(function(Ae){const Oe=Ae.value,Fe=Ae.style,Ve=Ae.styleSpec,qe=Ve.snow;let pt=[];const vt=F.H(Oe);if(void 0===Oe)return pt;if("object"!==vt)return pt=pt.concat([new F.V("snow",Oe,`object expected, ${vt} found`)]),pt;for(const Ae in Oe){const vt=Ae.match(/^(.*)-transition$/);pt=pt.concat(vt&&qe[vt[1]]&&qe[vt[1]].transition?_e({key:Ae,value:Oe[Ae],valueSpec:Ve.transition,style:Fe,styleSpec:Ve}):qe[Ae]?_e({key:Ae,value:Oe[Ae],valueSpec:qe[Ae],style:Fe,styleSpec:Ve}):[new F.G(Ae,Oe[Ae],`unknown property "${Ae}"`)])}return pt}(Ae)),Te=Ae=>De(function(Ae){const Oe=Ae.value,Fe=Ae.style,Ve=Ae.styleSpec,qe=Ve.rain;let pt=[];const vt=F.H(Oe);if(void 0===Oe)return pt;if("object"!==vt)return pt=pt.concat([new F.V("rain",Oe,`object expected, ${vt} found`)]),pt;for(const Ae in Oe){const vt=Ae.match(/^(.*)-transition$/);pt=pt.concat(vt&&qe[vt[1]]&&qe[vt[1]].transition?_e({key:Ae,value:Oe[Ae],valueSpec:Ve.transition,style:Fe,styleSpec:Ve}):qe[Ae]?_e({key:Ae,value:Oe[Ae],valueSpec:qe[Ae],style:Fe,styleSpec:Ve}):[new F.G(Ae,Oe[Ae],`unknown property "${Ae}"`)])}return pt}(Ae)),Ee=F=>De(oe(F)),Se=F=>De(J(F)),Ce=F=>De(te(F)),Ie=F=>De(ie(F)),Re=Ae=>De(F.a2(Ae));function De(F){return F.slice().sort(((F,Ae)=>F.line&&Ae.line?F.line-Ae.line:0))}function Le(Ae,Oe){let Fe=!1;if(Oe&&Oe.length)for(const Ve of Oe)Ve instanceof F.G?F.w(Ve.message):(Ae.fire(new F.y(new Error(Ve.message))),Fe=!0);return Fe}let rl;class ze extends F.E{constructor(Ae,Oe="flat"){super(),this._transitionable=new F.a4(rl||(rl=new F.a5({anchor:new F.a6(F.a3.light.anchor),position:new F.a7(F.a3.light.position),color:new F.a6(F.a3.light.color),intensity:new F.a6(F.a3.light.intensity)}))),this.setLight(Ae,Oe),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(F,Ae,Oe={}){this._validate(ve,F,Oe)||(this._transitionable.setTransitionOrValue(F),this.id=Ae)}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Ae,Oe,Fe){return(!Fe||!1!==Fe.validate)&&Le(this,Ae.call(me,F.l({value:Oe,style:{glyphs:!0,sprite:!0},styleSpec:F.a3})))}}let Sl=class extends F.E{constructor(Ae,Oe,Fe,Ve){super(),this.scope=Fe,this._transitionable=new F.a4(new F.a5({source:new F.a6(F.a3.terrain.source),exaggeration:new F.a6(F.a3.terrain.exaggeration)}),Fe,Ve),this._transitionable.setTransitionOrValue(Ae,Ve),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=Oe}get(){return this._transitionable.serialize()}set(F,Ae){this._transitionable.setTransitionOrValue(F,Ae)}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}getExaggeration(Ae){return this._transitioning.possiblyEvaluate(new F.a8(Ae)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const Ae=this._transitionable._values.exaggeration;if(!Ae)return null;const Oe=Ae.value.expression;if(!Oe)return null;let Fe=-1,Ve=-1,qe=1;for(const Ae of Oe.zoomStops)qe=Oe.evaluate(new F.a8(Ae)),qe>.01?(Fe=Ae,Ve=-1):Ve=Ae;return qe<.01&&Fe>0&&Ve>Fe?[Fe,Ve]:null}isZoomDependent(){const Ae=this._transitionable._values.exaggeration;return null!=Ae&&null!=Ae.value&&null!=Ae.value.expression&&Ae.value.expression instanceof F.a9}};const Il=45,Kl=65,Jl=.05;function ke(Ae,Oe,Fe,Ve){const qe=F.ac(Il,Kl,Fe),[pt,vt]=Be(Ae,Ve);let zt=1-Math.min(1,Math.exp((Oe-pt)/(vt-pt)*-6));return zt*=zt*zt,zt=Math.min(1,1.00747*zt),zt*qe*Ae.alpha}function Be(F,Ae){const Oe=.5/Math.tan(.5*Ae);return[F.range[0]+Oe,F.range[1]+Oe]}function Ne(Ae,Oe,Fe,Ve,qe){const pt=F.ab.vec3.transformMat4([],[Oe,Fe,Ve],qe.mercatorFogMatrix);return ke(Ae,F.ab.vec3.length(pt),qe.pitch,qe._fov)}function Ue(Ae,Oe,Fe,Ve,qe,pt,vt){const zt=[[Fe,Ve,0],[qe,Ve,0],[qe,pt,0],[Fe,pt,0]];let ri=Number.MAX_VALUE,xi=-Number.MAX_VALUE;for(const Ae of zt){const Fe=F.ab.vec3.transformMat4([],Ae,Oe),Ve=F.ab.vec3.length(Fe);ri=Math.min(ri,Ve),xi=Math.max(xi,Ve)}return[ke(Ae,ri,vt.pitch,vt._fov),ke(Ae,xi,vt.pitch,vt._fov)]}class je extends F.E{constructor(Ae,Oe,Fe,Ve){super();const qe=new F.a5({range:new F.a6(F.a3.fog.range),color:new F.a6(F.a3.fog.color),"color-use-theme":new F.a6({type:"string","property-type":"data-constant",default:"default"}),"high-color":new F.a6(F.a3.fog["high-color"]),"high-color-use-theme":new F.a6({type:"string","property-type":"data-constant",default:"default"}),"space-color":new F.a6(F.a3.fog["space-color"]),"space-color-use-theme":new F.a6({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new F.a6(F.a3.fog["horizon-blend"]),"star-intensity":new F.a6(F.a3.fog["star-intensity"]),"vertical-range":new F.a6(F.a3.fog["vertical-range"])});this._transitionable=new F.a4(qe,Fe,new Map(Ve)),this.set(Ae,Ve),this._transitioning=this._transitionable.untransitioned(),this._transform=Oe,this.properties=new F.ad(qe),this.scope=Fe}get state(){const Ae=this._transform,Oe="globe"===Ae.projection.name,Fe=F.ae(Ae.zoom),Ve=this.properties.get("range"),qe=[.5,3];return{range:Oe?[F.af(qe[0],Ve[0],Fe),F.af(qe[1],Ve[1],Fe)]:Ve,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(Ae,Oe,Fe={}){if(this._validate(be,Ae,Fe))return;const Ve=F.l({},Ae);for(const Ae of Object.keys(F.a3.fog))void 0===Ve[Ae]&&(Ve[Ae]=F.a3.fog[Ae].default);this._options=Ve,this._transitionable.setTransitionOrValue(this._options,Oe)}getOpacity(Ae){if(!this._transform.projection.supportsFog)return 0;const Oe=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:F.ac(Il,Kl,Ae))*Oe.a}getOpacityAtLatLng(Ae,Oe){return this._transform.projection.supportsFog?function(Ae,Oe,Fe){const Ve=F.aa.fromLngLat(Oe),qe=Fe.elevation?Fe.elevation.getAtPointOrZero(Ve):0;return Ne(Ae,Ve.x,Ve.y,qe,Fe)}(this.state,Ae,Oe):0}getOpacityForTile(Ae){if(!this._transform.projection.supportsFog)return[1,1];const Oe=this._transform.calculateFogTileMatrix(Ae.toUnwrapped());return Ue(this.state,Oe,0,0,F.ag,F.ag,this._transform)}getOpacityForBounds(F,Ae,Oe,Fe,Ve){return this._transform.projection.supportsFog?Ue(this.state,F,Ae,Oe,Fe,Ve,this._transform):[1,1]}getFovAdjustedRange(F){return this._transform.projection.supportsFog?Be(this.state,F):[0,1]}isVisibleOnFrustum(Ae){if(!this._transform.projection.supportsFog)return!1;const Oe=[4,5,6,7];for(const Fe of Oe){const Oe=Ae.points[Fe];let Ve;if(Oe[2]>=0)Ve=Oe;else{const qe=Ae.points[Fe-4];Ve=F.ah(qe,Oe,qe[2]/(qe[2]-Oe[2]))}if(Ne(this.state,Ve[0],Ve[1],0,this._transform)>=Jl)return!0}return!1}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Ae,Oe,Fe){return(!Fe||!1!==Fe.validate)&&Le(this,Ae.call(me,F.l({value:Oe,style:{glyphs:!0,sprite:!0},styleSpec:F.a3})))}}let Ql,ec,tc,cc,uc=class extends F.E{constructor(Ae,Oe,Fe,Ve){super();const qe=Ql||(Ql=new F.a5({density:new F.a6(F.a3.snow.density),intensity:new F.a6(F.a3.snow.intensity),color:new F.a6(F.a3.snow.color),opacity:new F.a6(F.a3.snow.opacity),vignette:new F.a6(F.a3.snow.vignette),"vignette-color":new F.a6(F.a3.snow["vignette-color"]),"center-thinning":new F.a6(F.a3.snow["center-thinning"]),direction:new F.a6(F.a3.snow.direction),"flake-size":new F.a6(F.a3.snow["flake-size"])}));this._transitionable=new F.a4(qe,Fe,new Map(Ve)),this.set(Ae,Ve),this._transitioning=this._transitionable.untransitioned(),this.properties=new F.ad(qe),this.scope=Fe}get state(){const Ae=this.properties.get("opacity"),Oe=this.properties.get("color"),Fe=this.properties.get("direction"),Ve=F.ai(Fe[0]),qe=-Math.max(F.ai(Fe[1]),.01),pt=[Math.cos(Ve)*Math.cos(qe),Math.sin(Ve)*Math.cos(qe),Math.sin(qe)],vt=this.properties.get("vignette"),zt=this.properties.get("vignette-color");return zt.a=vt,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new F.aj(Oe.r,Oe.g,Oe.b,Oe.a*Ae),direction:pt,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:zt}}get(){return this._transitionable.serialize()}set(Ae,Oe,Fe={}){if(this._validate(we,Ae,Fe))return;const Ve=F.l({},Ae);for(const Ae of Object.keys(F.a3.snow))void 0===Ve[Ae]&&(Ve[Ae]=F.a3.snow[Ae].default);this._options=Ve,this._transitionable.setTransitionOrValue(this._options,Oe)}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Ae,Oe,Fe){return(!Fe||!1!==Fe.validate)&&Le(this,Ae.call(me,F.l({value:Oe,style:{glyphs:!0,sprite:!0},styleSpec:F.a3})))}},jc=class extends F.E{constructor(Ae,Oe,Fe,Ve){super();const qe=ec||(ec=new F.a5({density:new F.a6(F.a3.rain.density),intensity:new F.a6(F.a3.rain.intensity),color:new F.a6(F.a3.rain.color),opacity:new F.a6(F.a3.rain.opacity),vignette:new F.a6(F.a3.rain.vignette),"vignette-color":new F.a6(F.a3.rain["vignette-color"]),"center-thinning":new F.a6(F.a3.rain["center-thinning"]),direction:new F.a6(F.a3.rain.direction),"droplet-size":new F.a6(F.a3.rain["droplet-size"]),"distortion-strength":new F.a6(F.a3.rain["distortion-strength"])}));this._transitionable=new F.a4(qe,Fe,new Map(Ve)),this.set(Ae,Ve),this._transitioning=this._transitionable.untransitioned(),this.properties=new F.ad(qe),this.scope=Fe}get state(){const Ae=this.properties.get("opacity"),Oe=this.properties.get("color"),Fe=this.properties.get("direction"),Ve=F.ai(Fe[0]),qe=-Math.max(F.ai(Fe[1]),.01),pt=[Math.cos(Ve)*Math.cos(qe),Math.sin(Ve)*Math.cos(qe),Math.sin(qe)],vt=this.properties.get("vignette-color");return vt.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new F.aj(Oe.r,Oe.g,Oe.b,Oe.a*Ae),direction:pt,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:vt}}get(){return this._transitionable.serialize()}set(Ae,Oe,Fe={}){if(this._validate(Te,Ae,Fe))return;const Ve=F.l({},Ae);for(const Ae of Object.keys(F.a3.rain))void 0===Ve[Ae]&&(Ve[Ae]=F.a3.rain[Ae].default);this._options=Ve,this._transitionable.setTransitionOrValue(this._options,Oe)}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Ae,Oe,Fe){return(!Fe||!1!==Fe.validate)&&Le(this,Ae.call(me,F.l({value:Oe,style:{glyphs:!0,sprite:!0},styleSpec:F.a3})))}};class $e extends F.E{constructor(Ae,Oe,Fe,Ve){super(),this.scope=Fe,this._options=Ae,this.properties=new F.ad(Oe),this._transitionable=new F.a4(Oe,Fe,new Map(Ve)),this._transitionable.setTransitionOrValue(Ae.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(F){this._transitionable.setTransitionOrValue(this._options.properties,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(F,Ae){this._options=F,this._transitionable.setTransitionOrValue(F.properties,Ae)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}class Xe{constructor(F,Ae,Oe,Fe){this.screenBounds=F,this.cameraPoint=Ae,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=Oe,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,Fe)}static createFromScreenPoints(Ae,Oe){let Fe,Ve;if(Ae instanceof F.P||"number"==typeof Ae[0]){const qe=F.P.convert(Ae);Fe=[qe],Ve=Oe.isPointAboveHorizon(qe)}else{const qe=F.P.convert(Ae[0]),pt=F.P.convert(Ae[1]);Fe=[qe,pt],Ve=F.al(qe,pt).every((F=>Oe.isPointAboveHorizon(F)))}return new Xe(Fe,Oe.getCameraPoint(),Ve,Oe)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(Ae){return F.al(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],Ae)}bufferedCameraGeometry(Ae){const Oe=this.screenBounds[0],Fe=1===this.screenBounds.length?this.screenBounds[0].add(new F.P(1,1)):this.screenBounds[1],Ve=F.al(Oe,Fe,0,!1);return this.cameraPoint.y>Fe.y&&(this.cameraPoint.x>Oe.x&&this.cameraPoint.x<Fe.x?Ve.splice(3,0,this.cameraPoint):this.cameraPoint.x>=Fe.x?Ve[2]=this.cameraPoint:this.cameraPoint.x<=Oe.x&&(Ve[3]=this.cameraPoint)),F.am(Ve,Ae)}bufferedCameraGeometryGlobe(Ae){const Oe=this.screenBounds[0],Fe=1===this.screenBounds.length?this.screenBounds[0].add(new F.P(1,1)):this.screenBounds[1],Ve=F.al(Oe,Fe,Ae),qe=this.cameraPoint.clone();switch(3*((qe.y>Oe.y)+(qe.y>Fe.y))+((qe.x>Oe.x)+(qe.x>Fe.x))){case 0:Ve[0]=qe,Ve[4]=qe.clone();break;case 1:Ve.splice(1,0,qe);break;case 2:Ve[1]=qe;break;case 3:Ve.splice(4,0,qe);break;case 5:Ve.splice(2,0,qe);break;case 6:Ve[3]=qe;break;case 7:Ve.splice(3,0,qe);break;case 8:Ve[2]=qe}return Ve}containsTile(Ae,Oe,Fe,Ve=0){const qe=Ae.queryPadding/Oe._pixelsPerMercatorPixel+1,pt=Fe?this._bufferedCameraMercator(qe,Oe):this._bufferedScreenMercator(qe,Oe);let vt=Ae.tileID.wrap+(pt.unwrapped?Ve:0);const zt=pt.polygon.map((Oe=>F.an(Ae.tileTransform,Oe,vt)));if(!F.ao(zt,0,0,F.ag,F.ag))return;vt=Ae.tileID.wrap+(this.screenGeometryMercator.unwrapped?Ve:0);const ri=this.screenGeometryMercator.polygon.map((Oe=>F.ap(Ae.tileTransform,Oe,vt))),xi=ri.map((Ae=>new F.P(Ae[0],Ae[1]))),bi=Oe.getFreeCameraOptions().position||new F.aa(0,0,0),wi=F.ap(Ae.tileTransform,bi,vt),dr=ri.map((Ae=>{const Oe=F.ab.vec3.sub(Ae,Ae,wi);return F.ab.vec3.normalize(Oe,Oe),new F.aq(wi,Oe)})),jr=F.ar(Ae,1,Oe.zoom)*Oe._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:xi,tilespaceRays:dr,bufferedTilespaceGeometry:zt,bufferedTilespaceBounds:(Qr=F.as(zt),Qr.min.x=F.aw(Qr.min.x,0,F.ag),Qr.min.y=F.aw(Qr.min.y,0,F.ag),Qr.max.x=F.aw(Qr.max.x,0,F.ag),Qr.max.y=F.aw(Qr.max.y,0,F.ag),Qr),tile:Ae,tileID:Ae.tileID,pixelToTileUnitsFactor:jr};var Qr}_bufferedScreenMercator(F,Ae){const Oe=Je(F);if(this._screenRaycastCache[Oe])return this._screenRaycastCache[Oe];{let Fe;return Fe="globe"===Ae.projection.name?this._projectAndResample(this.bufferedScreenGeometry(F),Ae):{polygon:this.bufferedScreenGeometry(F).map((F=>Ae.pointCoordinate3D(F))),unwrapped:!0},this._screenRaycastCache[Oe]=Fe,Fe}}_bufferedCameraMercator(F,Ae){const Oe=Je(F);if(this._cameraRaycastCache[Oe])return this._cameraRaycastCache[Oe];{let Fe;return Fe="globe"===Ae.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(F),Ae):{polygon:this.bufferedCameraGeometry(F).map((F=>Ae.pointCoordinate3D(F))),unwrapped:!0},this._cameraRaycastCache[Oe]=Fe,Fe}}_projectAndResample(Ae,Oe){const Fe=function(Ae,Oe){const Fe=F.ab.mat4.multiply([],Oe.pixelMatrix,Oe.globeMatrix),Ve=[0,-F.ax,0,1],qe=[0,F.ax,0,1],pt=[0,0,0,1];F.ab.vec4.transformMat4(Ve,Ve,Fe),F.ab.vec4.transformMat4(qe,qe,Fe),F.ab.vec4.transformMat4(pt,pt,Fe);const vt=new F.P(Ve[0]/Ve[3],Ve[1]/Ve[3]),zt=new F.P(qe[0]/qe[3],qe[1]/qe[3]),ri=F.au(Ae,vt)&&Ve[3]<pt[3],xi=F.au(Ae,zt)&&qe[3]<pt[3];if(!ri&&!xi)return null;const bi=function(F,Ae,Oe){for(let Fe=1;Fe<F.length;Fe++){const Ve=Ye(Ae.pointCoordinate3D(F[Fe-1]).x),qe=Ye(Ae.pointCoordinate3D(F[Fe]).x);if(Oe<0){if(Ve<qe)return{idx:Fe,t:-Ve/(qe-1-Ve)}}else if(qe<Ve)return{idx:Fe,t:(1-Ve)/(qe+1-Ve)}}return null}(Ae,Oe,ri?-1:1);if(!bi)return null;const{idx:wi,t:dr}=bi;let jr=wi>1?Ke(Ae.slice(0,wi),Oe):[],Qr=wi<Ae.length?Ke(Ae.slice(wi),Oe):[];jr=jr.map((Ae=>new F.P(Ye(Ae.x),Ae.y))),Qr=Qr.map((Ae=>new F.P(Ye(Ae.x),Ae.y)));const Xn=[...jr];0===Xn.length&&Xn.push(Qr[Qr.length-1]);const ho=F.af(Xn[Xn.length-1].y,(0===Qr.length?jr[0]:Qr[0]).y,dr);let yo;return yo=ri?[new F.P(0,ho),new F.P(0,0),new F.P(1,0),new F.P(1,ho)]:[new F.P(1,ho),new F.P(1,1),new F.P(0,1),new F.P(0,ho)],Xn.push(...yo),0===Qr.length?Xn.push(jr[0]):Xn.push(...Qr),{polygon:Xn.map((Ae=>new F.aa(Ae.x,Ae.y))),unwrapped:!1}}(Ae,Oe);if(Fe)return Fe;const Ve=function(Ae,Oe){let Fe=!1,Ve=-1/0,qe=0;for(let F=0;F<Ae.length-1;F++)Ae[F].x>Ve&&(Ve=Ae[F].x,qe=F);for(let F=0;F<Ae.length-1;F++){const Oe=(qe+F)%(Ae.length-1),Ve=Ae[Oe],pt=Ae[Oe+1];Math.abs(Ve.x-pt.x)>.5&&(Ve.x<pt.x?(Ve.x+=1,0===Oe&&(Ae[Ae.length-1].x+=1)):(pt.x+=1,Oe+1===Ae.length-1&&(Ae[0].x+=1)),Fe=!0)}const pt=F.at(Oe.center.lng);return Fe&&pt<Math.abs(pt-1)&&Ae.forEach((F=>{F.x-=1})),{polygon:Ae,unwrapped:Fe}}(Ke(Ae,Oe).map((Ae=>new F.P(Ye(Ae.x),Ae.y))),Oe);return{polygon:Ve.polygon.map((Ae=>new F.aa(Ae.x,Ae.y))),unwrapped:Ve.unwrapped}}}function Ke(Ae,Oe){return F.av(Ae,(F=>{const Ae=Oe.pointCoordinate3D(F);F.x=Ae.x,F.y=Ae.y}),1/256)}function Ye(F){return F<0?1+F%1:F%1}function Je(F){return 100*F|0}function Qe(Ae,Oe,Fe,Ve,qe){const a=function(Fe,Ve){if(Fe)return qe(Fe);if(Ve){if(Ae.url&&Ve.tiles&&Ae.tiles&&delete Ae.tiles,Ve.variants){if(!Array.isArray(Ve.variants))return qe(new Error("variants must be an array"));for(const Ae of Ve.variants){if(null==Ae||"object"!=typeof Ae||Ae.constructor!==Object)return qe(new Error("variant must be an object"));if(!Array.isArray(Ae.capabilities))return qe(new Error("capabilities must be an array"));if(1===Ae.capabilities.length&&"meshopt"===Ae.capabilities[0]){Ve=F.l(Ve,Ae);break}}}const Fe=F.ay(F.l({},Ve,Ae),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);Fe.tiles=Oe.canonicalizeTileset(Fe,Ae.url),qe(null,Fe)}},pt=function(F,Ae,Oe){if(!F)return null;if(!Ae&&!Oe)return F;Oe=Oe||F.worldview_default;const Fe=Object.values(F.language||{});if(0===Fe.length)return null;const Ve=Object.values(F.worldview||{});if(0===Ve.length)return null;const qe=Fe.every((F=>F===Ae)),pt=Ve.every((F=>F===Oe));return qe&&pt?F:Ae in(F.language_options||{})||Oe in(F.worldview_options||{})?null:F.language_options&&F.worldview_options?F:null}(Ae.data,Fe,Ve);return pt?F.q.frame((()=>a(null,pt))):Ae.url?F.n(Oe.transformRequest(Oe.normalizeSourceURL(Ae.url,null,Fe,Ve),F.R.Source),a):F.q.frame((()=>{const{data:F,...Oe}=Ae;a(null,Oe)}))}class et{constructor(Ae,Oe,Fe){this.bounds=F.az.convert(this.validateBounds(Ae)),this.minzoom=Oe||0,this.maxzoom=Fe||24}validateBounds(F){return Array.isArray(F)&&4===F.length?[Math.max(-180,F[0]),Math.max(-90,F[1]),Math.min(180,F[2]),Math.min(90,F[3])]:[-180,-90,180,90]}contains(Ae){const Oe=Math.pow(2,Ae.z),Fe=Math.floor(F.at(this.bounds.getWest())*Oe),Ve=Math.floor(F.aA(this.bounds.getNorth())*Oe),qe=Math.ceil(F.at(this.bounds.getEast())*Oe),pt=Math.ceil(F.aA(this.bounds.getSouth())*Oe);return Ae.x>=Fe&&Ae.x<qe&&Ae.y>=Ve&&Ae.y<pt}}class tt extends F.E{constructor(Ae,Oe,Fe,Ve){if(super(),this.id=Ae,this.dispatcher=Fe,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,F.l(this,F.ay(Oe,["url","scheme","tileSize","promoteId"])),this._options=F.l({type:"vector"},Oe),this._collectResourceTiming=!!Oe.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(Ve),this._tileWorkers={},this._deduped=new F.aB}load(Ae){this._loaded=!1,this.fire(new F.z("dataloading",{dataType:"source"}));const Oe=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Fe=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,Oe,Fe,((Ve,qe)=>{if(this._tileJSONRequest=null,this._loaded=!0,Ve)Oe&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${Oe}`),Fe&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Fe}`),this.fire(new F.y(Ve));else if(qe){if(F.l(this,qe),this.hasWorldviews=!!qe.worldview_options,qe.worldview_default&&(this.worldviewDefault=qe.worldview_default),qe.vector_layers){this.vectorLayers=qe.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const F of qe.vector_layers)this.vectorLayerIds.push(F.id),qe.worldview&&qe.worldview[F.source]&&this.localizableLayerIds.add(F.id)}qe.bounds&&(this.tileBounds=new et(qe.bounds,this.minzoom,this.maxzoom)),Qr(qe.tiles,this.map._requestManager._customAccessToken),this.fire(new F.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.z("data",{dataType:"source",sourceDataType:"content"}))}Ae&&Ae(Ve)}))}loaded(){return this._loaded}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();const Ae=F.aC(this.id,this.scope);this.load((()=>this.map.style.clearSource(Ae)))}setTiles(F){return this._options.tiles=F,this.reload(),this}setUrl(F){return this.url=F,this._options.url=F,this.reload(),this}onRemove(F){this.cancelTileJSONRequest()}serialize(){return F.l({},this._options)}loadTile(Ae,Oe){const Fe=Ae.tileID.canonical.url(this.tiles,this.scheme),Ve=this.map._requestManager.normalizeTileURL(Fe),qe=this.map._requestManager.transformRequest(Ve,F.R.Tile),pt=this.map.style?this.map.style.getLut(this.scope):null,vt=pt?{image:pt.image.clone()}:null,zt={request:qe,data:void 0,uid:Ae.uid,tileID:Ae.tileID,tileZoom:Ae.tileZoom,zoom:Ae.tileID.overscaledZ,maxZoom:this.maxzoom,lut:vt,tileSize:this.tileSize*Ae.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:F.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:Ae.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:Ae.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&F.f(Fe)&&(zt.worldview=this.map.getWorldview()||this.worldviewDefault,zt.localizableLayerIds=this.localizableLayerIds),zt.request.collectResourceTiming=this._collectResourceTiming,Ae.actor&&"expired"!==Ae.state)"loading"===Ae.state?Ae.reloadCallback=Oe:Ae.request=Ae.actor.send("reloadTile",zt,c.bind(this));else if(Ae.actor=this._tileWorkers[Ve]=this._tileWorkers[Ve]||this.dispatcher.getActor(),this.dispatcher.ready)Ae.request=Ae.actor.send("loadTile",zt,c.bind(this),void 0,!0);else{const Oe=F.aD.call({deduped:this._deduped},zt,((F,Oe)=>{F||!Oe?c.call(this,F):(zt.data={cacheControl:Oe.cacheControl,expires:Oe.expires,rawData:Oe.rawData.slice(0)},Ae.actor&&Ae.actor.send("loadTile",zt,c.bind(this),void 0,!0))}),!0);Ae.request={cancel:Oe}}function c(Fe,Ve){return delete Ae.request,Ae.aborted?Oe(null):Fe&&404!==Fe.status?Oe(Fe):(Ve&&Ve.resourceTiming&&(Ae.resourceTiming=Ve.resourceTiming),this.map._refreshExpiredTiles&&Ve&&Ae.setExpiryData(Ve),Ae.loadVectorData(Ve,this.map.painter),F.aE(this.dispatcher),Oe(null),void(Ae.reloadCallback&&(this.loadTile(Ae,Ae.reloadCallback),Ae.reloadCallback=null)))}}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.actor&&F.actor.send("abortTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(F,Ae){F.actor&&F.actor.send("removeTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope}),F.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class it extends F.E{constructor(Ae,Oe,Fe,Ve){super(),this.id=Ae,this.dispatcher=Fe,this.setEventedParent(Ve),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=F.l({type:"raster"},Oe),F.l(this,F.ay(Oe,["url","scheme","tileSize"]))}load(Ae){this._loaded=!1,this.fire(new F.z("dataloading",{dataType:"source"})),this._tileJSONRequest=Qe(this._options,this.map._requestManager,null,null,((Oe,Fe)=>{this._tileJSONRequest=null,this._loaded=!0,Oe?this.fire(new F.y(Oe)):Fe&&(F.l(this,Fe),Fe.raster_layers&&(this.rasterLayers=Fe.raster_layers,this.rasterLayerIds=this.rasterLayers.map((F=>F.id))),Fe.bounds&&(this.tileBounds=new et(Fe.bounds,this.minzoom,this.maxzoom)),Qr(Fe.tiles),this.fire(new F.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.z("data",{dataType:"source",sourceDataType:"content"}))),Ae&&Ae(Oe)}))}loaded(){return this._loaded}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();const Ae=F.aC(this.id,this.scope);this.load((()=>this.map.style.clearSource(Ae)))}setTiles(F){return this._options.tiles=F,this.reload(),this}setUrl(F){return this.url=F,this._options.url=F,this.reload(),this}onRemove(F){this.cancelTileJSONRequest()}serialize(){return F.l({},this._options)}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}loadTile(Ae,Oe){const Fe=F.q.devicePixelRatio>=2,Ve=this.map._requestManager.normalizeTileURL(Ae.tileID.canonical.url(this.tiles,this.scheme),Fe,this.tileSize);Ae.request=F.o(this.map._requestManager.transformRequest(Ve,F.R.Tile),((Fe,Ve,qe,pt)=>(delete Ae.request,Ae.aborted?(Ae.state="unloaded",Oe(null)):Fe?(Ae.state="errored",Oe(Fe)):Ve?(this.map._refreshExpiredTiles&&Ae.setExpiryData({cacheControl:qe,expires:pt}),Ae.setTexture(Ve,this.map.painter),Ae.state="loaded",F.aE(this.dispatcher),void Oe(null)):Oe(null))))}abortTile(F,Ae){F.request&&(F.request.cancel(),delete F.request),Ae&&Ae()}unloadTile(Ae,Oe){Ae.texture&&Ae.texture instanceof F.T?(Ae.destroy(!0),Ae.texture&&Ae.texture instanceof F.T&&this.map.painter.saveTileTexture(Ae.texture)):Ae.destroy(),Oe&&Oe()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ot extends it{constructor(Ae,Oe,Fe,Ve){super(Ae,Oe,Fe,Ve),this.type="raster-array",this.maxzoom=22,this._options=F.l({type:"raster-array"},Oe)}triggerRepaint(F){const Ae=this.map.painter._terrain,Oe=this.map.style.getSourceCache(this.id);Ae&&Ae.enabled&&Oe&&Ae._clearRenderCacheForTile(Oe.id,F.tileID),this.map.triggerRepaint()}loadTile(Ae,Oe){const Fe=this.map._requestManager.normalizeTileURL(Ae.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),Ve=this.map._requestManager.transformRequest(Fe,F.R.Tile);Ae.requestParams=Ve,Ae.actor||(Ae.actor=this.dispatcher.getActor()),Ae.request=Ae.fetchHeader(void 0,((F,Fe,Ve,qe)=>{if(delete Ae.request,Ae.aborted)return Ae.state="unloaded",Oe(null);if(F){if(20===F.code)return;return Ae.state="errored",Oe(F)}this.map._refreshExpiredTiles&&Ae.setExpiryData({cacheControl:Ve,expires:qe}),Ae.state="empty",Oe(null)}))}unloadTile(Ae,Oe){const Fe=Ae.texture;Fe&&Fe instanceof F.T?(Ae.destroy(!0),this.map.painter.saveTileTexture(Fe)):(Ae.destroy(),Ae.flushQueues(),Ae._isHeaderLoaded=!1,delete Ae._mrt,delete Ae.textureDescriptor),Ae.fbo&&(Ae.fbo.destroy(),delete Ae.fbo),delete Ae.request,delete Ae.requestParams,delete Ae.neighboringTiles,Ae.state="unloaded"}prepareTile(Ae,Oe,Fe){Ae._isHeaderLoaded&&("empty"!==Ae.state&&(Ae.state="reloading"),Ae.fetchBand(Oe,Fe,((Oe,Fe)=>{if(Oe)return Ae.state="errored",this.fire(new F.y(Oe)),void this.triggerRepaint(Ae);Fe&&(Ae.setTexture(Fe,this.map.painter),Ae.state="loaded",this.triggerRepaint(Ae))})))}getInitialBand(F){if(!this.rasterLayers)return 0;const Ae=this.rasterLayers.find((({id:Ae})=>Ae===F)),Oe=Ae&&Ae.fields,Fe=Oe&&Oe.bands&&Oe.bands;return Fe?Fe[0]:0}getTextureDescriptor(Ae,Oe,Fe){if(!Ae)return;const Ve=Oe.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!Ve)return;let qe=null;Oe instanceof F.aH?qe=Oe.paint.get("raster-array-band"):Oe instanceof F.aI&&(qe=Oe.paint.get("raster-particle-array-band"));const pt=qe||this.getInitialBand(Ve);if(null!=pt)if(Ae.textureDescriptor){if(!Ae.updateNeeded(Ve,pt)||Fe)return Object.assign({},Ae.textureDescriptor,{texture:Ae.texture})}else this.prepareTile(Ae,Ve,pt)}}const Gc={vector:tt,raster:it,"raster-dem":class extends it{constructor(Ae,Oe,Fe,Ve){super(Ae,Oe,Fe,Ve),this.type="raster-dem",this.maxzoom=22,this._options=F.l({type:"raster-dem"},Oe),this.encoding=Oe.encoding||"mapbox"}loadTile(Ae,Oe){const Fe=this.map._requestManager.normalizeTileURL(Ae.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function s(F,Fe){F&&(Ae.state="errored",Oe(F)),Fe&&(Ae.dem=Fe,Ae.dem.onDeserialize(),Ae.needsHillshadePrepare=!0,Ae.needsDEMTextureUpload=!0,Ae.state="loaded",Oe(null))}Ae.request=F.o(this.map._requestManager.transformRequest(Fe,F.R.Tile),function(Fe,Ve,qe,pt){if(delete Ae.request,Ae.aborted)Ae.state="unloaded",Oe(null);else if(Fe)Ae.state="errored",Oe(Fe);else if(Ve){this.map._refreshExpiredTiles&&Ae.setExpiryData({cacheControl:qe,expires:pt});const Oe=ImageBitmap&&Ve instanceof ImageBitmap&&F.t(),Fe=1-(Ve.width-F.aF(Ve.width))/2;Fe<1||Ae.neighboringTiles||(Ae.neighboringTiles=this._getNeighboringTiles(Ae.tileID));const vt=Oe?Ve:F.q.getImageData(Ve,Fe),zt={uid:Ae.uid,coord:Ae.tileID,source:this.id,scope:this.scope,rawImageData:vt,encoding:this.encoding,padding:Fe};Ae.actor&&"expired"!==Ae.state||(Ae.actor=this.dispatcher.getActor(),Ae.actor.send("loadDEMTile",zt,s.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(Ae){const Oe=Ae.canonical,Fe=Math.pow(2,Oe.z),Ve=(Oe.x-1+Fe)%Fe,qe=0===Oe.x?Ae.wrap-1:Ae.wrap,pt=(Oe.x+1+Fe)%Fe,vt=Oe.x+1===Fe?Ae.wrap+1:Ae.wrap,zt={};return zt[new F.aG(Ae.overscaledZ,qe,Oe.z,Ve,Oe.y).key]={backfilled:!1},zt[new F.aG(Ae.overscaledZ,vt,Oe.z,pt,Oe.y).key]={backfilled:!1},Oe.y>0&&(zt[new F.aG(Ae.overscaledZ,qe,Oe.z,Ve,Oe.y-1).key]={backfilled:!1},zt[new F.aG(Ae.overscaledZ,Ae.wrap,Oe.z,Oe.x,Oe.y-1).key]={backfilled:!1},zt[new F.aG(Ae.overscaledZ,vt,Oe.z,pt,Oe.y-1).key]={backfilled:!1}),Oe.y+1<Fe&&(zt[new F.aG(Ae.overscaledZ,qe,Oe.z,Ve,Oe.y+1).key]={backfilled:!1},zt[new F.aG(Ae.overscaledZ,Ae.wrap,Oe.z,Oe.x,Oe.y+1).key]={backfilled:!1},zt[new F.aG(Ae.overscaledZ,vt,Oe.z,pt,Oe.y+1).key]={backfilled:!1}),zt}},"raster-array":ot,geojson:class extends F.E{constructor(Ae,Oe,Fe,Ve){super(),this.id=Ae,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=Fe.getActor(),this.setEventedParent(Ve),this._data=Oe.data,this._options=F.l({},Oe),this._collectResourceTiming=Oe.collectResourceTiming,void 0!==Oe.maxzoom&&(this.maxzoom=Oe.maxzoom),void 0!==Oe.minzoom&&(this.minzoom=Oe.minzoom),Oe.type&&(this.type=Oe.type),Oe.attribution&&(this.attribution=Oe.attribution),this.promoteId=Oe.promoteId;const qe=F.ag/this.tileSize;this.workerOptions=F.l({source:this.id,scope:this.scope,cluster:Oe.cluster||!1,geojsonVtOptions:{buffer:(void 0!==Oe.buffer?Oe.buffer:128)*qe,tolerance:(void 0!==Oe.tolerance?Oe.tolerance:.375)*qe,extent:F.ag,maxZoom:this.maxzoom,lineMetrics:Oe.lineMetrics||!1,generateId:Oe.generateId||!1},superclusterOptions:{maxZoom:void 0!==Oe.clusterMaxZoom?Oe.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,Oe.clusterMinPoints||2),extent:F.ag,radius:(void 0!==Oe.clusterRadius?Oe.clusterRadius:50)*qe,log:!1,generateId:Oe.generateId||!1},clusterProperties:Oe.clusterProperties,filter:Oe.filter,dynamic:Oe.dynamic},Oe.workerOptions)}onAdd(F){this.map=F,this.setData(this._data)}setData(F){return this._data=F,this._updateWorkerData(),this}updateData(Ae){if(!this._options.dynamic)return this.fire(new F.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof Ae&&("Feature"===Ae.type&&(Ae={type:"FeatureCollection",features:[Ae]}),"FeatureCollection"!==Ae.type))return this.fire(new F.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof Ae&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){const F=new Map;for(const Ae of this._data.features)F.set(Ae.id,Ae);for(const Oe of Ae.features)F.set(Oe.id,Oe);this._data.features=[...F.values()]}else this._data=Ae;return this._updateWorkerData(!0),this}getClusterExpansionZoom(F,Ae){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:F,source:this.id,scope:this.scope},Ae),this}getClusterChildren(F,Ae){return this.actor.send("geojson.getClusterChildren",{clusterId:F,source:this.id,scope:this.scope},Ae),this}getClusterLeaves(F,Ae,Oe,Fe){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:F,limit:Ae,offset:Oe},Fe),this}_updateWorkerData(Ae=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new F.z("dataloading",{dataType:"source"})),this._loaded=!1;const Oe=F.l({append:Ae},this.workerOptions);Oe.scope=this.scope;const Fe=this._data;"string"==typeof Fe?(Oe.request=this.map._requestManager.transformRequest(F.q.resolveURL(Fe),F.R.Source),Oe.request.collectResourceTiming=this._collectResourceTiming):Oe.data=JSON.stringify(Fe),this._pendingLoad=this.actor.send(`${this.type}.loadData`,Oe,((Oe,Fe)=>{if(this._loaded=!0,this._pendingLoad=null,Oe)this.fire(new F.y(Oe));else{const Oe={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&Fe&&Fe.resourceTiming&&Fe.resourceTiming[this.id]&&(Oe.resourceTiming=Fe.resourceTiming[this.id]),Ae&&(this._partialReload=!0),this.fire(new F.z("data",Oe)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(Ae),this._coalesce=!1)}))}loaded(){return this._loaded}reload(){const Ae=F.aC(this.id,this.scope);this.map.style.clearSource(Ae),this._updateWorkerData()}loadTile(Ae,Oe){const Fe=Ae.actor?"reloadTile":"loadTile";Ae.actor=this.actor;const Ve=this.map.style?this.map.style.getLut(this.scope):null,qe=Ve?{image:Ve.image.clone()}:null,pt=this._partialReload,vt={type:this.type,uid:Ae.uid,tileID:Ae.tileID,tileZoom:Ae.tileZoom,zoom:Ae.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:qe,scope:this.scope,pixelRatio:F.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,scaleFactor:this.map.getScaleFactor(),partial:pt};Ae.request=this.actor.send(Fe,vt,((F,Ve)=>pt&&!Ve?(Ae.state="loaded",Oe(null)):(delete Ae.request,Ae.destroy(),Ae.aborted?Oe(null):F?Oe(F):(Ae.loadVectorData(Ve,this.map.painter,"reloadTile"===Fe),Oe(null)))),void 0,"loadTile"===Fe)}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.aborted=!0}unloadTile(F,Ae){this.actor.send("removeTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope}),F.destroy()}onRemove(F){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return F.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends F.aJ{constructor(F,Ae,Oe,Fe){super(F,Ae,Oe,Fe),this.roundZoom=!0,this.type="video",this.options=Ae}load(){this._loaded=!1;const Ae=this.options;this.urls=[];for(const Oe of Ae.urls)this.urls.push(this.map._requestManager.transformRequest(Oe,F.R.Source).url);F.aK(this.urls,((Ae,Oe)=>{this._loaded=!0,Ae?this.fire(new F.y(Ae)):Oe&&(this.video=Oe,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(Ae){if(this.video){const Oe=this.video.seekable;Ae<Oe.start(0)||Ae>Oe.end(0)?this.fire(new F.y(new F.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${Oe.start(0)} and ${Oe.end(0)}-second mark.`))):this.video.currentTime=Ae}}getVideo(){return this.video}onAdd(F){this.map||(this.map=F,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const Ae=this.map.painter.context,Oe=Ae.gl;this.texture?this.video.paused||(this.texture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE),Oe.texSubImage2D(Oe.TEXTURE_2D,0,0,0,Oe.RGBA,Oe.UNSIGNED_BYTE,this.video)):(this.texture=new F.T(Ae,this.video,Oe.RGBA8),this.texture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(Ae)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:F.aJ,model:class extends F.E{constructor(F,Ae,Oe,Fe){super(),this.id=F,this.type="model",this.models=[],this._loaded=!1,this._options=Ae}load(){const Ae=[];for(const Oe in this._options.models){const Fe=this._options.models[Oe],Ve=F.aM(this.map._requestManager.transformRequest(Fe.uri,F.R.Model).url).then((Ae=>{if(!Ae)return;const Ve=F.aN(Ae),qe=new F.aO(Oe,Fe.position,Fe.orientation,Ve);qe.computeBoundsAndApplyParent(),this.models.push(qe)})).catch((Ae=>{this.fire(new F.y(new Error(`Could not load model ${Oe} from ${Fe.uri}: ${Ae.message}`)))}));Ae.push(Ve)}return Promise.allSettled(Ae).then((()=>{this._loaded=!0,this.fire(new F.z("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((Ae=>{this.fire(new F.y(new Error(`Could not load models: ${Ae.message}`)))}))}onAdd(F){this.map=F,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(F,Ae){}serialize(){return{type:"model"}}},"batched-model":class extends F.E{constructor(F,Ae,Oe,Fe){super(),this.type="batched-model",this.id=F,this.tileSize=512,this._options=Ae,this.tiles=this._options.tiles,this.maxzoom=Ae.maxzoom||19,this.minzoom=Ae.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=Oe,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(Fe)}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();const Ae=F.aC(this.id,this.scope);this.load((()=>this.map.style.clearSource(Ae)))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(Ae){this._loaded=!1,this.fire(new F.z("dataloading",{dataType:"source"}));const Oe=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Fe=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,Oe,Fe,((Ve,qe)=>{this._tileJSONRequest=null,this._loaded=!0,Ve?(Oe&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${Oe}`),Fe&&2!==Fe.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Fe}`),this.fire(new F.y(Ve))):qe&&(F.l(this,qe),qe.bounds&&(this.tileBounds=new et(qe.bounds,this.minzoom,this.maxzoom)),Qr(qe.tiles,this.map._requestManager._customAccessToken),this.fire(new F.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.z("data",{dataType:"source",sourceDataType:"content"}))),Ae&&Ae(Ve)}))}hasTransition(){return!1}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}loaded(){return this._loaded}loadTile(Ae,Oe){const Fe=this.map._requestManager.normalizeTileURL(Ae.tileID.canonical.url(this.tiles,this.scheme)),Ve={request:this.map._requestManager.transformRequest(Fe,F.R.Tile),data:void 0,uid:Ae.uid,tileID:Ae.tileID,tileZoom:Ae.tileZoom,zoom:Ae.tileID.overscaledZ,tileSize:this.tileSize*Ae.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:Ae.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,lut:null,maxZoom:null,promoteId:null,pixelRatio:null,scaleFactor:null};if(Ae.actor&&"expired"!==Ae.state)if("loading"===Ae.state)Ae.reloadCallback=Oe;else{if(Ae.buckets){const F=Object.values(Ae.buckets);for(const Ae of F)Ae.dirty=!0;return void(Ae.state="loaded")}Ae.request=Ae.actor.send("reloadTile",Ve,r.bind(this))}else Ae.actor=this.dispatcher.getActor(),Ae.request=Ae.actor.send("loadTile",Ve,r.bind(this),void 0,!0);function r(F,Fe){return Ae.aborted?Oe(null):F&&404!==F.status?Oe(F):(this.map._refreshExpiredTiles&&Fe&&Ae.setExpiryData(Fe),Ae.loadModelData(Fe,this.map.painter),Ae.state="loaded",void Oe(null))}}serialize(){return F.l({},this._options)}},canvas:class extends F.aJ{constructor(Ae,Oe,Fe,Ve){super(Ae,Oe,Fe,Ve),Oe.coordinates?Array.isArray(Oe.coordinates)&&4===Oe.coordinates.length&&!Oe.coordinates.some((F=>!Array.isArray(F)||2!==F.length||F.some((F=>"number"!=typeof F))))||this.fire(new F.y(new F.V(`sources.${Ae}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new F.y(new F.V(`sources.${Ae}`,null,'missing required property "coordinates"'))),Oe.animate&&"boolean"!=typeof Oe.animate&&this.fire(new F.y(new F.V(`sources.${Ae}`,null,'optional "animate" property must be a boolean value'))),Oe.canvas?"string"==typeof Oe.canvas||Oe.canvas instanceof HTMLCanvasElement||this.fire(new F.y(new F.V(`sources.${Ae}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new F.y(new F.V(`sources.${Ae}`,null,'missing required property "canvas"'))),this.options=Oe,this.animate=void 0===Oe.animate||Oe.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new F.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(F){this.map=F,this.load(),this.canvas&&this.animate&&this.play()}onRemove(F){this.pause()}prepare(){let Ae=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,Ae=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,Ae=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const Oe=this.map.painter.context;this.texture?!Ae&&!this._playing||this.texture instanceof F.aL||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new F.T(Oe,this.canvas,Oe.gl.RGBA8,{premultiply:!0}),this._prepareData(Oe)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const F of[this.canvas.width,this.canvas.height])if(isNaN(F)||F<=0)return!0;return!1}},custom:class extends F.E{constructor(Ae,Oe,Fe,Ve){super(),this.id=Ae,this.type="custom",this._dataType="raster",this._dispatcher=Fe,this._implementation=Oe,this.setEventedParent(Ve),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new F.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new F.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new et(this._implementation.bounds,this.minzoom,this.maxzoom)),Oe.update=this._update.bind(this),Oe.clearTiles=this._clearTiles.bind(this),Oe.coveringTiles=this._coveringTiles.bind(this),F.l(this,F.ay(Oe,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return F.ay(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new F.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(Ae){this.map=Ae,this._loaded=!1,this.fire(new F.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(Ae),this.load()}onRemove(F){this._implementation.onRemove&&this._implementation.onRemove(F)}hasTile(F){if(this._implementation.hasTile){const{x:Ae,y:Oe,z:Fe}=F.canonical;return this._implementation.hasTile({x:Ae,y:Oe,z:Fe})}return!this.tileBounds||this.tileBounds.contains(F.canonical)}loadTile(F,Ae){const{x:Oe,y:Fe,z:Ve}=F.tileID.canonical,qe=new AbortController;F.request=Promise.resolve(this._implementation.loadTile({x:Oe,y:Fe,z:Ve},{signal:qe.signal})).then(function(Oe){return delete F.request,F.aborted?(F.state="unloaded",Ae(null)):void 0===Oe?(F.state="errored",Ae(null)):null===Oe?(this.loadTileData(F,{width:this.tileSize,height:this.tileSize,data:null}),F.state="loaded",Ae(null)):function(F){return F instanceof ImageData||F instanceof HTMLCanvasElement||F instanceof ImageBitmap||F instanceof HTMLImageElement}(Oe)?(this.loadTileData(F,Oe),F.state="loaded",void Ae(null)):(F.state="errored",Ae(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((Oe=>{20!==Oe.code&&(F.state="errored",Ae(Oe))})),F.request.cancel=()=>qe.abort()}loadTileData(F,Ae){F.setTexture(Ae,this.map.painter)}unloadTile(Ae,Oe){if(Ae.texture&&Ae.texture instanceof F.T?(Ae.destroy(!0),Ae.texture&&Ae.texture instanceof F.T&&this.map.painter.saveTileTexture(Ae.texture)):Ae.destroy(),this._implementation.unloadTile){const{x:F,y:Oe,z:Fe}=Ae.tileID.canonical;this._implementation.unloadTile({x:F,y:Oe,z:Fe})}Oe&&Oe()}abortTile(F,Ae){F.request&&F.request.cancel&&(F.request.cancel(),delete F.request),Ae&&Ae()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((F=>({x:F.canonical.x,y:F.canonical.y,z:F.canonical.z})))}_clearTiles(){const Ae=F.aC(this.id,this.scope);this.map.style.clearSource(Ae)}_update(){this.fire(new F.z("data",{dataType:"source",sourceDataType:"content"}))}}},rt=function(Ae,Oe,Fe,Ve){const qe=new Gc[Oe.type](Ae,Oe,Fe,Ve);if(qe.id!==Ae)throw new Error(`Expected Source id to be ${Ae} instead of ${qe.id}`);return F.aP(["load","abort","unload","serialize","prepare"],qe),qe};function at(F,Ae,Oe=""){return`${Oe}:${Ae.id||""}:${Ae.layer.id}:${function(F){if("layerId"in F)return`layer:${F.layerId}`;{const{featuresetId:Ae,importId:Oe}=F;return`featureset:${Ae}${Oe?`:import:${Oe}`:""}`}}(F.target)}`}function nt(F,Ae,Oe,Fe=""){if(F.uniqueFeatureID){const Ve=at(F,Ae,Fe);if(Oe.has(Ve))return!0;Oe.add(Ve)}return!1}function lt(F,Ae,Oe,Fe,Ve=!1){const qe=Ae.sourceCache.transform,pt=Ae.sourceCache.tilesIn(F,Ae.has3DLayers,Ve);pt.sort(ut);const vt=[];for(const F of pt){const pt=F.tile.queryRenderedFeatures(Ae,F,Oe,Fe,qe,Ve);Object.keys(pt).length&&vt.push({wrappedTileID:F.tile.tileID.wrapped().key,queryResults:pt})}return 0===vt.length?{}:function(F){const Ae={},Oe={};for(const Fe of F){const F=Fe.queryResults,Ve=Fe.wrappedTileID,qe=Oe[Ve]=Oe[Ve]||{};for(const Oe in F){const Fe=F[Oe],Ve=qe[Oe]=qe[Oe]||{},pt=Ae[Oe]=Ae[Oe]||[];for(const F of Fe)Ve[F.featureIndex]||(Ve[F.featureIndex]=!0,pt.push(F))}}return Ae}(vt)}function ct(F,Ae,Oe,Fe,Ve){const qe={},pt=Fe.queryRenderedSymbols(F),vt=[];for(const F of Object.keys(pt).map(Number))vt.push(Ve[F]);vt.sort(ut);for(const F of vt){const Fe=F.featureIndex.lookupSymbolFeatures(pt[F.bucketInstanceId],F.bucketIndex,F.sourceLayerIndex,Ae,Oe);for(const Ae in Fe){const Oe=qe[Ae]=qe[Ae]||[],Ve=Fe[Ae];Ve.sort(((Ae,Oe)=>{const Fe=F.featureSortOrder;if(Fe){const F=Fe.indexOf(Ae.featureIndex);return Fe.indexOf(Oe.featureIndex)-F}return Oe.featureIndex-Ae.featureIndex}));for(const F of Ve)Oe.push(F)}}return qe}function ht(F,Ae){const Oe=F.getRenderableIds().map((Ae=>F.getTileByID(Ae))),Fe=[],Ve={};for(let F=0;F<Oe.length;F++){const qe=Oe[F],pt=qe.tileID.canonical.key;Ve[pt]||(Ve[pt]=!0,qe.querySourceFeatures(Fe,Ae))}return Fe}function ut(F,Ae){const Oe=F.tileID,Fe=Ae.tileID;return Oe.overscaledZ-Fe.overscaledZ||Oe.canonical.y-Fe.canonical.y||Oe.wrap-Fe.wrap||Oe.canonical.x-Fe.canonical.x}function dt(F,Ae){const Oe={};if(!Ae)return Oe;for(const Fe of F){const F=Fe.layerIds.map((F=>Ae.getLayer(F))).filter(Boolean);if(0!==F.length){Fe.layers=F,Fe.stateDependentLayerIds&&(Fe.stateDependentLayers=Fe.stateDependentLayerIds.map((Ae=>F.filter((F=>F.id===Ae))[0])));for(const Ae of F)Oe[Ae.fqid]=Fe}}return Oe}const qc=32,$c=33,Hc=new Uint16Array(8184);for(let F=0;F<2046;F++){let Ae=F+2,Oe=0,Fe=0,Ve=0,qe=0,pt=0,vt=0;for(1&Ae?Ve=qe=pt=qc:Oe=Fe=vt=qc;(Ae>>=1)>1;){const F=Oe+Ve>>1,zt=Fe+qe>>1;1&Ae?(Ve=Oe,qe=Fe,Oe=pt,Fe=vt):(Oe=Ve,Fe=qe,Ve=pt,qe=vt),pt=F,vt=zt}const zt=4*F;Hc[zt+0]=Oe,Hc[zt+1]=Fe,Hc[zt+2]=Ve,Hc[zt+3]=qe}const Wc=new Uint16Array(2178),Kc=new Uint8Array(1089),Jc=new Uint16Array(1089);function yt(F){return 0===F?-.03125:32===F?.03125:0}const Qc=(()=>({type:2,extent:F.ag,loadGeometry:()=>[[new F.P(0,0),new F.P(F.ag+1,0),new F.P(F.ag+1,F.ag+1),new F.P(0,F.ag+1),new F.P(0,0)]]}))();class bt{constructor(Ae,Oe,Fe,Ve,qe){this.tileID=Ae,this.uid=F.aV(),this.uses=0,this.tileSize=Oe,this.tileZoom=Fe,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=qe,Ve&&Ve.style&&(this._lastUpdatedBrightness=Ve.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",Ve&&Ve.transform&&(this.projection=Ve.transform.projection)}registerFadeDuration(Ae){const Oe=Ae+this.timeAdded;Oe<F.q.now()||this.fadeEndTime&&Oe<this.fadeEndTime||(this.fadeEndTime=Oe)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=F.aQ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(Ae,Oe,Fe){if(this.unloadVectorData(),this.state="loaded",Ae){Ae.featureIndex&&(this.latestFeatureIndex=Ae.featureIndex,Ae.rawTileData?(this.latestRawTileData=Ae.rawTileData,this.latestFeatureIndex.rawTileData=Ae.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=Ae.collisionBoxArray,this.buckets=dt(Ae.buckets,Oe.style),this.hasSymbolBuckets=!1;for(const Ae in this.buckets){const Oe=this.buckets[Ae];if(Oe instanceof F.aX){if(this.hasSymbolBuckets=!0,!Fe)break;Oe.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const Ae in this.buckets){const Oe=this.buckets[Ae];if(Oe instanceof F.aX&&Oe.hasRTLText){this.hasRTLText=!0,F.aY();break}}this.queryPadding=0;for(const F in this.buckets){const Ae=this.buckets[F],Fe=Oe.style.getOwnLayer(F);if(!Fe)continue;const Ve=Fe.queryRadius(Ae);this.queryPadding=Math.max(this.queryPadding,Ve)}Ae.imageAtlas&&(this.imageAtlas=Ae.imageAtlas),Ae.glyphAtlasImage&&(this.glyphAtlasImage=Ae.glyphAtlasImage),Ae.lineAtlas&&(this.lineAtlas=Ae.lineAtlas),this._lastUpdatedBrightness=Ae.brightness}else this.collisionBoxArray=new F.aW}unloadVectorData(){if(this.hasData()){for(const F in this.buckets)this.buckets[F].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(F,Ae,Oe){F&&(F.resourceTiming&&(this.resourceTiming=F.resourceTiming),this.buckets=Object.assign({},this.buckets,dt(F.buckets,Ae.style)),F.featureIndex&&(this.latestFeatureIndex=F.featureIndex))}getBucket(F){return this.buckets[F.fqid]}upload(Ae){for(const F in this.buckets){const Oe=this.buckets[F];Oe.uploadPending()&&Oe.upload(Ae)}const Oe=Ae.gl,Fe=this.imageAtlas;if(Fe&&!Fe.uploaded){const Ve=!!Object.keys(Fe.patternPositions).length;this.imageAtlasTexture=new F.T(Ae,Fe.image,Oe.RGBA8,{useMipmap:Ve}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new F.T(Ae,this.glyphAtlasImage,Oe.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new F.T(Ae,this.lineAtlas.image,Oe.R8),this.lineAtlas.uploaded=!0)}prepare(F,Ae,Oe){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(F,this.imageAtlasTexture,Oe),!Ae||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const Fe=Ae.style.getBrightness();(this._lastUpdatedBrightness||Fe)&&(this._lastUpdatedBrightness&&Fe&&Math.abs(this._lastUpdatedBrightness-Fe)<.001||(this.updateBuckets(Ae,this._lastUpdatedBrightness!==Fe),this._lastUpdatedBrightness=Fe))}queryRenderedFeatures(Ae,Oe,Fe,Ve,qe,pt){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const vt=function(Ae,Oe){const Fe=F.ab.mat4.fromScaling([],[.5*Ae.width,.5*-Ae.height,1]);return F.ab.mat4.translate(Fe,Fe,[1,-1,0]),F.ab.mat4.multiply(Fe,Fe,Ae.calculateProjMatrix(Oe.toUnwrapped())),Float32Array.from(Fe)}(qe,this.tileID);return this.latestFeatureIndex.query(Ae,{tilespaceGeometry:Oe,pixelPosMatrix:vt,transform:Ve,availableImages:Fe,tileTransform:this.tileTransform})}querySourceFeatures(Ae,Oe){const Fe=this.latestFeatureIndex;if(!Fe||!Fe.rawTileData)return;const Ve=Fe.loadVTLayers(),qe=Oe?Oe.sourceLayer:"",pt=Ve._geojsonTileLayer||Ve[qe];if(!pt)return;const vt=F.aZ(Oe&&Oe.filter),{z:zt,x:ri,y:xi}=this.tileID.canonical,bi={z:zt,x:ri,y:xi};for(let Oe=0;Oe<pt.length;Oe++){const Ve=pt.feature(Oe);if(vt.needGeometry){const Ae=F.a_(Ve,!0);if(!vt.filter(new F.a8(this.tileID.overscaledZ),Ae,this.tileID.canonical))continue}else if(!vt.filter(new F.a8(this.tileID.overscaledZ),Ve))continue;const wi=Fe.getId(Ve,qe),dr=new F.a$(Ve,zt,ri,xi,wi);dr.tile=bi,Ae.push(dr)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(Ae){const Oe=this.expirationTime;if(Ae.cacheControl){const Oe=F.b0(Ae.cacheControl);Oe["max-age"]&&(this.expirationTime=Date.now()+1e3*Oe["max-age"])}else Ae.expires&&(this.expirationTime=new Date(Ae.expires).getTime());if(this.expirationTime){const F=Date.now();let Ae=!1;if(this.expirationTime>F)Ae=!1;else if(Oe)if(this.expirationTime<Oe)Ae=!0;else{const Fe=this.expirationTime-Oe;Fe?this.expirationTime=F+Math.max(Fe,3e4):Ae=!0}else Ae=!0;Ae?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}refreshFeatureState(F){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&F&&this.updateBuckets(F)}updateBuckets(Ae,Oe){if(!this.latestFeatureIndex)return;if(!Ae.style)return;const Fe=this.latestFeatureIndex.loadVTLayers(),Ve=Ae.style.listImages(),qe=Ae.style.getBrightness();for(const pt in this.buckets){if(!Ae.style.hasLayer(pt))continue;const vt=this.buckets[pt],zt=vt.layers[0],ri=zt.sourceLayer||"_geojsonTileLayer",xi=Fe[ri],bi=Ae.style.getLayerSourceCache(zt);let wi={};bi&&(wi=bi._state.getState(ri,void 0));const dr=this.imageAtlas&&this.imageAtlas.patternPositions||{},jr=Object.keys(wi).length>0&&!Oe;jr&&!vt.stateDependentLayers.length&&!Oe||vt.update(wi,xi,Ve,dr,jr?vt.stateDependentLayers:vt.layers,Oe,qe),(vt instanceof F.b1||vt instanceof F.b2)&&Ae._terrain&&Ae._terrain.enabled&&bi&&vt.programConfigurations.needsUpload&&Ae._terrain._clearRenderCacheForTile(bi.id,this.tileID);const Qr=Ae&&Ae.style&&Ae.style.getOwnLayer(pt);Qr&&(this.queryPadding=Math.max(this.queryPadding,Qr.queryRadius(vt)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<F.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(Ae){this.symbolFadeHoldUntil=F.q.now()+Ae}setTexture(Ae,Oe){const Fe=Oe.context,Ve=Fe.gl;this.texture=this.texture||Oe.getTileTexture(Ae.width),this.texture&&this.texture instanceof F.T?this.texture.update(Ae):(this.texture=new F.T(Fe,Ae,Ve.RGBA8,{useMipmap:!0}),this.texture.bind(Ve.LINEAR,Ve.CLAMP_TO_EDGE))}setDependencies(F,Ae){const Oe={};for(const F of Ae)Oe[F]=!0;this.dependencies[F]=Oe}hasDependency(F,Ae){for(const Oe of F){const F=this.dependencies[Oe];if(F)for(const Oe of Ae)if(F[Oe])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(Ae,Oe){if(!Oe||"mercator"===Oe.name||this._tileDebugBuffer)return;const Fe=F.b3(Qc,this.tileID.canonical,this.tileTransform)[0],Ve=new F.b4,qe=new F.b5;for(let F=0;F<Fe.length;F++){const{x:Ae,y:Oe}=Fe[F];Ve.emplaceBack(Ae,Oe),qe.emplaceBack(F)}qe.emplaceBack(0),this._tileDebugIndexBuffer=Ae.createIndexBuffer(qe),this._tileDebugBuffer=Ae.createVertexBuffer(Ve,F.b6.members),this._tileDebugSegments=F.b7.simpleSegment(0,0,Ve.length,qe.length)}_makeTileBoundsBuffers(Ae,Oe){if(this._tileBoundsBuffer||!Oe||"mercator"===Oe.name)return;const Fe=F.b3(Qc,this.tileID.canonical,this.tileTransform)[0];let Ve,qe;if(this.isRaster){const Ae=function(Ae,Oe){const Fe=F.aQ(Ae,Oe),Ve=Math.pow(2,Ae.z);for(let qe=0;qe<$c;qe++)for(let pt=0;pt<$c;pt++){const vt=F.aR((Ae.x+(pt+yt(pt))/qc)/Ve),zt=F.aS((Ae.y+(qe+yt(qe))/qc)/Ve),ri=Oe.project(vt,zt),xi=qe*$c+pt;Wc[2*xi+0]=Math.round((ri.x*Fe.scale-Fe.x)*F.ag),Wc[2*xi+1]=Math.round((ri.y*Fe.scale-Fe.y)*F.ag)}Kc.fill(0),Jc.fill(0);for(let F=2045;F>=0;F--){const Ae=4*F,Oe=Hc[Ae+0],Fe=Hc[Ae+1],Ve=Hc[Ae+2],qe=Hc[Ae+3],pt=Oe+Ve>>1,vt=Fe+qe>>1,zt=pt+vt-Fe,ri=vt+Oe-pt,xi=Fe*$c+Oe,bi=qe*$c+Ve,wi=vt*$c+pt,dr=Math.hypot((Wc[2*xi+0]+Wc[2*bi+0])/2-Wc[2*wi+0],(Wc[2*xi+1]+Wc[2*bi+1])/2-Wc[2*wi+1])>=16;Kc[wi]=Kc[wi]||(dr?1:0),F<1022&&(Kc[wi]=Kc[wi]||Kc[(Fe+ri>>1)*$c+(Oe+zt>>1)]||Kc[(qe+ri>>1)*$c+(Ve+zt>>1)])}const qe=new F.aT,pt=new F.aU;let vt=0;function l(Ae,Oe){const Fe=Oe*$c+Ae;return 0===Jc[Fe]&&(qe.emplaceBack(Wc[2*Fe+0],Wc[2*Fe+1],Ae*F.ag/qc,Oe*F.ag/qc),Jc[Fe]=++vt),Jc[Fe]-1}function c(F,Ae,Oe,Fe,Ve,qe){const vt=F+Oe>>1,zt=Ae+Fe>>1;if(Math.abs(F-Ve)+Math.abs(Ae-qe)>1&&Kc[zt*$c+vt])c(Ve,qe,F,Ae,vt,zt),c(Oe,Fe,Ve,qe,vt,zt);else{const vt=l(F,Ae),zt=l(Oe,Fe),ri=l(Ve,qe);pt.emplaceBack(vt,zt,ri)}}return c(0,0,qc,qc,qc,0),c(qc,qc,0,0,0,qc),{vertices:qe,indices:pt}}(this.tileID.canonical,Oe);Ve=Ae.vertices,qe=Ae.indices}else{Ve=new F.aT,qe=new F.aU;for(const{x:F,y:Ae}of Fe)Ve.emplaceBack(F,Ae,0,0);const Ae=F.b8(Ve.int16,void 0,4);for(let F=0;F<Ae.length;F+=3)qe.emplaceBack(Ae[F],Ae[F+1],Ae[F+2])}this._tileBoundsBuffer=Ae.createVertexBuffer(Ve,F.b9.members),this._tileBoundsIndexBuffer=Ae.createIndexBuffer(qe),this._tileBoundsSegments=F.b7.simpleSegment(0,0,Ve.length,qe.length)}_makeGlobeTileDebugBuffers(Ae,Oe){const Fe=Oe.projection;if(!Fe||"globe"!==Fe.name||Oe.freezeTileCoverage)return;const Ve=this.tileID.canonical,qe=F.ba(Ve,Oe),pt=F.bb(qe),vt=F.ae(Oe.zoom);let zt;vt>0&&(zt=F.ab.mat4.invert(new Float64Array(16),Oe.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(Ae,Ve,Oe,pt,zt,vt),this._makeGlobeTileDebugTextBuffer(Ae,Ve,Oe,pt,zt,vt)}_globePoint(Ae,Oe,Fe,Ve,qe,pt,vt){let zt=F.bc(Ae,Oe,Fe);if(pt){const qe=1<<Fe.z,ri=F.at(Ve.center.lng),xi=F.aA(Ve.center.lat),bi=(Fe.x+.5)/qe-ri;let wi=0;bi>.5?wi=-1:bi<-.5&&(wi=1);let dr=(Ae/F.ag+Fe.x)/qe+wi,jr=(Oe/F.ag+Fe.y)/qe;dr=(dr-ri)*Ve._pixelsPerMercatorPixel+ri,jr=(jr-xi)*Ve._pixelsPerMercatorPixel+xi;const Qr=[dr*Ve.worldSize,jr*Ve.worldSize,0];F.ab.vec3.transformMat4(Qr,Qr,pt),zt=F.bd(zt,Qr,vt)}return F.ab.vec3.transformMat4(zt,zt,qe)}_makeGlobeTileDebugBorderBuffer(Ae,Oe,Fe,Ve,qe,pt){const vt=new F.b4,zt=new F.b5,ri=new F.be,h=(F,Ae,xi,bi,wi)=>{const dr=(xi-F)/(wi-1),jr=(bi-Ae)/(wi-1),Qr=vt.length;for(let xi=0;xi<wi;xi++){const bi=F+xi*dr,wi=Ae+xi*jr;vt.emplaceBack(bi,wi);const Xn=this._globePoint(bi,wi,Oe,Fe,Ve,qe,pt);ri.emplaceBack(Xn[0],Xn[1],Xn[2]),zt.emplaceBack(Qr+xi)}},xi=F.ag;h(0,0,xi,0,16),h(xi,0,xi,xi,16),h(xi,xi,0,xi,16),h(0,xi,0,0,16),this._tileDebugIndexBuffer=Ae.createIndexBuffer(zt),this._tileDebugBuffer=Ae.createVertexBuffer(vt,F.b6.members),this._globeTileDebugBorderBuffer=Ae.createVertexBuffer(ri,F.bf.members),this._tileDebugSegments=F.b7.simpleSegment(0,0,vt.length,zt.length)}_makeGlobeTileDebugTextBuffer(Ae,Oe,Fe,Ve,qe,pt){const vt=F.ag/4,zt=new F.b4,ri=new F.aU,xi=new F.be,bi=25;ri.reserve(32),zt.reserve(bi),xi.reserve(bi);const d=(F,Ae)=>bi*F+Ae;for(let F=0;F<bi;F++){const Ae=F*vt;for(let F=0;F<bi;F++){const ri=F*vt;zt.emplaceBack(ri,Ae);const bi=this._globePoint(ri,Ae,Oe,Fe,Ve,qe,pt);xi.emplaceBack(bi[0],bi[1],bi[2])}}for(let F=0;F<4;F++)for(let Ae=0;Ae<4;Ae++){const Oe=d(F,Ae),Fe=d(F,Ae+1),Ve=d(F+1,Ae),qe=d(F+1,Ae+1);ri.emplaceBack(Oe,Fe,Ve),ri.emplaceBack(Ve,Fe,qe)}this._tileDebugTextIndexBuffer=Ae.createIndexBuffer(ri),this._tileDebugTextBuffer=Ae.createVertexBuffer(zt,F.b6.members),this._globeTileDebugTextBuffer=Ae.createVertexBuffer(xi,F.bf.members),this._tileDebugTextSegments=F.b7.simpleSegment(0,0,bi,32)}destroy(Ae=!1){for(const F in this.buckets)this.buckets[F].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!Ae&&this.texture&&this.texture instanceof F.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}F.bg.setPbf(F.bh);class wt extends bt{constructor(F,Ae,Oe,Fe,Ve){super(F,Ae,Oe,Fe,Ve),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(Ae,Oe){const Fe=Oe.context,Ve=Fe.gl;this.texture=this.texture||Oe.getTileTexture(Ae.width),this.texture&&this.texture instanceof F.T?this.texture.update(Ae,{premultiply:!1}):this.texture=new F.T(Fe,Ae,Ve.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(Ae=16384,Oe){const Fe=this._mrt=new F.bg(30),Ve=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(Ae-1)}});return this.entireBuffer=null,this.request=F.bi(Ve,((F,Ve,qe,pt)=>{if(F)Oe(F);else try{const F=Fe.getHeaderLength(Ve);if(F>Ae)return void(this.request=this.fetchHeader(F,Oe));Fe.parseHeader(Ve),this._isHeaderLoaded=!0;let vt=0;for(const F of Object.values(Fe.layers))vt=Math.max(vt,F.dataIndex[F.dataIndex.length-1].last_byte);Ve.byteLength>=vt&&(this.entireBuffer=Ve),Oe(null,this.entireBuffer||Ve,qe,pt)}catch(F){Oe(F)}})),this.request}fetchBand(Ae,Oe,Fe){const Ve=this._mrt;if(!this._isHeaderLoaded||!Ve)return void Fe(new Error("Tile header is not ready"));const qe=this.actor;if(!qe)return void Fe(new Error("Can't fetch tile band without an actor"));let pt;const n=(F,Ve)=>{pt.complete(F,Ve),F?Fe(F):(this.updateTextureDescriptor(Ae,Oe),Fe(null,this.textureDescriptor&&this.textureDescriptor.img))},l=(F,Ae)=>{if(F)return Fe(F);const Oe=qe.send("decodeRasterArray",{buffer:Ae,task:pt},n,void 0,!0);this._workQueue.push((()=>{Oe&&Oe.cancel(),pt.cancel()}))},vt=Ve.getLayer(Ae);if(!vt)return void Fe(new Error(`Unknown sourceLayer "${Ae}"`));if(vt.hasDataForBand(Oe))return this.updateTextureDescriptor(Ae,Oe),void Fe(null,this.textureDescriptor?this.textureDescriptor.img:null);const zt=vt.getDataRange([Oe]);if(pt=Ve.createDecodingTask(zt),!pt||pt.tasks.length)if(this.flushQueues(),this.entireBuffer)l(null,this.entireBuffer.slice(zt.firstByte,zt.lastByte+1));else{const Ae=Object.assign({},this.requestParams,{headers:{Range:`bytes=${zt.firstByte}-${zt.lastByte}`}}),Oe=F.bi(Ae,l);this._fetchQueue.push((()=>{Oe.cancel(),pt.cancel()}))}else Fe(null)}updateNeeded(F,Ae){return(!this.textureDescriptor||this.textureDescriptor.band!==Ae||this.textureDescriptor.layer!==F)&&"errored"!==this.state}updateTextureDescriptor(Ae,Oe){if(!this._mrt)return;const Fe=this._mrt.getLayer(Ae);if(!Fe||!Fe.hasBand(Oe)||!Fe.hasDataForBand(Oe))return;const{bytes:Ve,tileSize:qe,buffer:pt,offset:vt,scale:zt}=Fe.getBandView(Oe),ri=qe+2*pt,xi={data:Ve,width:ri,height:ri},bi=this.texture;bi&&bi instanceof F.T&&bi.update(xi,{premultiply:!1}),this.textureDescriptor={layer:Ae,band:Oe,img:xi,buffer:pt,offset:vt,tileSize:qe,format:Fe.pixelFormat,mix:[zt,256*zt,65536*zt,16777216*zt]}}}class Tt{constructor(F,Ae){this.max=F,this.onRemove=Ae,this.reset()}reset(){for(const F in this.data)for(const Ae of this.data[F])Ae.timeout&&clearTimeout(Ae.timeout),this.onRemove(Ae.value);return this.data={},this.order=[],this}add(F,Ae,Oe){const Fe=F.wrapped().key;void 0===this.data[Fe]&&(this.data[Fe]=[]);const Ve={value:Ae,timeout:void 0};if(void 0!==Oe&&(Ve.timeout=setTimeout((()=>{this.remove(F,Ve)}),Oe)),this.data[Fe].push(Ve),this.order.push(Fe),this.order.length>this.max){const F=this._getAndRemoveByKey(this.order[0]);F&&this.onRemove(F)}return this}has(F){return F.wrapped().key in this.data}getAndRemove(F){return this.has(F)?this._getAndRemoveByKey(F.wrapped().key):null}_getAndRemoveByKey(F){const Ae=this.data[F].shift();return Ae.timeout&&clearTimeout(Ae.timeout),0===this.data[F].length&&delete this.data[F],this.order.splice(this.order.indexOf(F),1),Ae.value}getByKey(F){const Ae=this.data[F];return Ae?Ae[0].value:null}get(F){return this.has(F)?this.data[F.wrapped().key][0].value:null}remove(F,Ae){if(!this.has(F))return this;const Oe=F.wrapped().key,Fe=void 0===Ae?0:this.data[Oe].indexOf(Ae),Ve=this.data[Oe][Fe];return this.data[Oe].splice(Fe,1),Ve.timeout&&clearTimeout(Ve.timeout),0===this.data[Oe].length&&delete this.data[Oe],this.onRemove(Ve.value),this.order.splice(this.order.indexOf(Oe),1),this}setMaxSize(F){for(this.max=F;this.order.length>this.max;){const F=this._getAndRemoveByKey(this.order[0]);F&&this.onRemove(F)}return this}filter(F){const Ae=[];for(const Oe in this.data)for(const Fe of this.data[Oe])F(Fe.value)||Ae.push(Fe);for(const F of Ae)this.remove(F.value.tileID,F)}}class Et{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(Ae,Oe,Fe){const Ve=String(Oe);if(this.stateChanges[Ae]=this.stateChanges[Ae]||{},this.stateChanges[Ae][Ve]=this.stateChanges[Ae][Ve]||{},F.l(this.stateChanges[Ae][Ve],Fe),null===this.deletedStates[Ae]){this.deletedStates[Ae]={};for(const F in this.state[Ae])F!==Ve&&(this.deletedStates[Ae][F]=null)}else if(this.deletedStates[Ae]&&null===this.deletedStates[Ae][Ve]){this.deletedStates[Ae][Ve]={};for(const F in this.state[Ae][Ve])Fe[F]||(this.deletedStates[Ae][Ve][F]=null)}else for(const F in Fe)this.deletedStates[Ae]&&this.deletedStates[Ae][Ve]&&null===this.deletedStates[Ae][Ve][F]&&delete this.deletedStates[Ae][Ve][F]}removeFeatureState(F,Ae,Oe){if(null===this.deletedStates[F])return;const Fe=String(Ae);if(this.deletedStates[F]=this.deletedStates[F]||{},Oe&&void 0!==Ae)null!==this.deletedStates[F][Fe]&&(this.deletedStates[F][Fe]=this.deletedStates[F][Fe]||{},this.deletedStates[F][Fe][Oe]=null);else if(void 0!==Ae)if(this.stateChanges[F]&&this.stateChanges[F][Fe])for(Oe in this.deletedStates[F][Fe]={},this.stateChanges[F][Fe])this.deletedStates[F][Fe][Oe]=null;else this.deletedStates[F][Fe]=null;else this.deletedStates[F]=null}getState(Ae,Oe){const Fe=this.state[Ae]||{},Ve=this.stateChanges[Ae]||{},qe=this.deletedStates[Ae];if(null===qe)return{};if(void 0!==Oe){const Ae=String(Oe),pt=F.l({},Fe[Ae],Ve[Ae]);if(qe){const F=qe[Oe];if(null===F)return{};for(const Ae in F)delete pt[Ae]}return pt}const pt=F.l({},Fe,Ve);if(qe)for(const F in qe)delete pt[F];return pt}initializeTileState(F,Ae){F.refreshFeatureState(Ae)}coalesceChanges(Ae,Oe){const Fe={};for(const Ae in this.stateChanges){this.state[Ae]=this.state[Ae]||{};const Oe={};for(const Fe in this.stateChanges[Ae])this.state[Ae][Fe]||(this.state[Ae][Fe]={}),F.l(this.state[Ae][Fe],this.stateChanges[Ae][Fe]),Oe[Fe]=this.state[Ae][Fe];Fe[Ae]=Oe}for(const Ae in this.deletedStates){this.state[Ae]=this.state[Ae]||{};const Oe={};if(null===this.deletedStates[Ae])for(const F in this.state[Ae])Oe[F]={},this.state[Ae][F]={};else for(const F in this.deletedStates[Ae]){if(null===this.deletedStates[Ae][F])this.state[Ae][F]={};else if(this.state[Ae][F])for(const Oe of Object.keys(this.deletedStates[Ae][F]))delete this.state[Ae][F][Oe];Oe[F]=this.state[Ae][F]}Fe[Ae]=Fe[Ae]||{},F.l(Fe[Ae],Oe)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(Fe).length)for(const F in Ae)Ae[F].refreshFeatureState(Oe)}}class St extends F.E{constructor(F,Ae,Oe){super(),this.id=F,this._onlySymbols=Oe,Ae.on("data",(F=>{"source"===F.dataType&&"metadata"===F.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===F.dataType&&"content"===F.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),Ae.on("error",(()=>{this._sourceErrored=!0})),this._source=Ae,this._tiles={},this._cache=new Tt(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=Ae.minTileCacheSize,this._maxTileCacheSize=Ae.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Et,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(F){this.map=F,this._minTileCacheSize=void 0===this._minTileCacheSize&&F?F._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&F?F._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const F in this._tiles){const Ae=this._tiles[F];if("loaded"!==Ae.state&&"errored"!==Ae.state)return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const F=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,F&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(F,Ae){return F.isSymbolTile=this._onlySymbols,F.isExtraShadowCaster=this._shadowCasterTiles[F.tileID.key],this._source.loadTile(F,Ae)}_unloadTile(F){if(this._source.unloadTile)return this._source.unloadTile(F)}_abortTile(F){if(this._source.abortTile)return this._source.abortTile(F)}serialize(){return this._source.serialize()}prepare(F){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const Ae in this._tiles){const Oe=this._tiles[Ae];Oe.upload(F),Oe.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return F.bj(this._tiles).map((F=>F.tileID)).sort(Ct).map((F=>F.key))}getRenderableIds(Ae,Oe){const Fe=[];for(const F in this._tiles)this._isIdRenderable(+F,Ae,Oe)&&Fe.push(this._tiles[F]);return Ae?Fe.sort(((Ae,Oe)=>{const Fe=Ae.tileID,Ve=Oe.tileID,qe=new F.P(Fe.canonical.x,Fe.canonical.y)._rotate(this.transform.angle),pt=new F.P(Ve.canonical.x,Ve.canonical.y)._rotate(this.transform.angle);return Fe.overscaledZ-Ve.overscaledZ||pt.y-qe.y||pt.x-qe.x})).map((F=>F.tileID.key)):Fe.map((F=>F.tileID)).sort(Ct).map((F=>F.key))}hasRenderableParent(F){const Ae=this.findLoadedParent(F,0);return!!Ae&&this._isIdRenderable(Ae.tileID.key)}_isIdRenderable(F,Ae,Oe){return this._tiles[F]&&this._tiles[F].hasData()&&!this._coveredTiles[F]&&(Ae||!this._tiles[F].holdingForFade())&&(Oe||!this._shadowCasterTiles[F])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const F in this._tiles)"errored"!==this._tiles[F].state&&this._reloadTile(+F,"reloading")}}_reloadTile(F,Ae){const Oe=this._tiles[F];Oe&&("loading"!==Oe.state&&(Oe.state=Ae),this._loadTile(Oe,this._tileLoaded.bind(this,Oe,F,Ae)))}_tileLoaded(Ae,Oe,Fe,Ve){if(Ve)if(Ae.state="errored",404!==Ve.status)this._source.fire(new F.y(Ve,{tile:Ae}));else{if(this._source.fire(new F.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:Ae})),!(Ae.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const F=this.map.painter.terrain;this.update(this.transform,F.getScaledDemTileSize(),!0),F.resetTileLookupCache(this.id)}else this.update(this.transform)}else Ae.timeAdded=F.q.now(),"expired"===Fe&&(Ae.refreshedUponExpiration=!0),this._setTileReloadTimer(Oe,Ae),"raster-dem"===this._source.type&&Ae.dem&&this._backfillDEM(Ae),this._state.initializeTileState(Ae,this.map?this.map.painter:null),this._source.fire(new F.z("data",{dataType:"source",tile:Ae,coord:Ae.tileID,sourceCacheId:this.id}))}_backfillDEM(F){const Ae=this.getRenderableIds();for(let Oe=0;Oe<Ae.length;Oe++){const Fe=Ae[Oe];if(F.neighboringTiles&&F.neighboringTiles[Fe]){const Ae=this.getTileByID(Fe);i(F,Ae),i(Ae,F)}}function i(F,Ae){if(!F.dem||F.dem.borderReady)return;F.needsHillshadePrepare=!0,F.needsDEMTextureUpload=!0;let Oe=Ae.tileID.canonical.x-F.tileID.canonical.x;const Fe=Ae.tileID.canonical.y-F.tileID.canonical.y,Ve=Math.pow(2,F.tileID.canonical.z),qe=Ae.tileID.key;0===Oe&&0===Fe||Math.abs(Fe)>1||(Math.abs(Oe)>1&&(1===Math.abs(Oe+Ve)?Oe+=Ve:1===Math.abs(Oe-Ve)&&(Oe-=Ve)),Ae.dem&&F.dem&&(F.dem.backfillBorder(Ae.dem,Oe,Fe),F.neighboringTiles&&F.neighboringTiles[qe]&&(F.neighboringTiles[qe].backfilled=!0)))}}getTile(F){return this.getTileByID(F.key)}getTileByID(F){return this._tiles[F]}_retainLoadedChildren(F,Ae,Oe,Fe){for(const Ve in this._tiles){let qe=this._tiles[Ve];if(Fe[Ve]||!qe.hasData()||qe.tileID.overscaledZ<=Ae||qe.tileID.overscaledZ>Oe)continue;let pt=qe.tileID;for(;qe&&qe.tileID.overscaledZ>Ae+1;){const F=qe.tileID.scaledTo(qe.tileID.overscaledZ-1);qe=this._tiles[F.key],qe&&qe.hasData()&&(pt=F)}let vt=pt;for(;vt.overscaledZ>Ae;)if(vt=vt.scaledTo(vt.overscaledZ-1),F[vt.key]){Fe[pt.key]=pt;break}}}findLoadedParent(F,Ae){if(F.key in this._loadedParentTiles){const Oe=this._loadedParentTiles[F.key];return Oe&&Oe.tileID.overscaledZ>=Ae?Oe:null}for(let Oe=F.overscaledZ-1;Oe>=Ae;Oe--){const Ae=F.scaledTo(Oe),Fe=this._getLoadedTile(Ae);if(Fe)return Fe}}_getLoadedTile(F){const Ae=this._tiles[F.key];return Ae&&Ae.hasData()?Ae:this._cache.getByKey(this._source.reparseOverscaled?F.wrapped().key:F.canonical.key)}updateCacheSize(F,Ae){Ae=Ae||this._source.tileSize;const Oe=Math.ceil(F.width/Ae)+1,Fe=Math.ceil(F.height/Ae)+1,Ve=Math.floor(Oe*Fe*5),qe="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,Ve):Ve,pt="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,qe):qe;this._cache.setMaxSize(pt)}handleWrapJump(F){const Ae=Math.round((F-(void 0===this._prevLng?F:this._prevLng))/360);if(this._prevLng=F,Ae){const F={};for(const Oe in this._tiles){const Fe=this._tiles[Oe];Fe.tileID=Fe.tileID.unwrapTo(Fe.tileID.wrap+Ae),F[Fe.tileID.key]=Fe}this._tiles=F;for(const F in this._timers)clearTimeout(this._timers[F]),delete this._timers[F];for(const F in this._tiles)this._setTileReloadTimer(+F,this._tiles[F])}}update(Ae,Oe,Fe,Ve){if(this.transform=Ae,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!Fe)return;this.updateCacheSize(Ae,Oe),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const qe="batched-model"===this._source.type;let pt,vt=this._source.maxzoom;const zt=this.map&&this.map.painter?this.map.painter._terrain:null;if(zt&&zt.sourceCache===this&&zt.attenuationRange()){const F=zt.attenuationRange()[0],Ae=Math.floor(F)-Math.log2(zt.getDemUpscale());vt>Ae&&(vt=Ae)}if(this.used||this.usedForTerrain){if(this._source.tileID)pt=Ae.getVisibleUnwrappedCoordinates(this._source.tileID).map((Ae=>new F.aG(Ae.canonical.z,Ae.wrap,Ae.canonical.z,Ae.canonical.x,Ae.canonical.y)));else if(0!==this.tileCoverLift){const Ve=Ae.clone();Ve.tileCoverLift=this.tileCoverLift,pt=Ve.coveringTiles({tileSize:Oe||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:vt,roundZoom:this._source.roundZoom&&!Fe,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:qe}),this._source.minzoom<=1&&"globe"===Ae.projection.name&&(pt.push(new F.aG(1,0,1,0,0)),pt.push(new F.aG(1,0,1,1,0)),pt.push(new F.aG(1,0,1,0,1)),pt.push(new F.aG(1,0,1,1,1)))}else if(pt=Ae.coveringTiles({tileSize:Oe||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:vt,roundZoom:this._source.roundZoom&&!Fe,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:qe}),this._source.hasTile){const F=this._source.hasTile.bind(this._source);pt=pt.filter((Ae=>F(Ae)))}}else pt=[];if(pt.length>0&&this.castsShadows&&Ve&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!It(this._source.type)){const F=Ae.coveringZoomLevel({tileSize:Oe||this._source.tileSize,roundZoom:this._source.roundZoom&&!Fe}),vt=Math.min(F,this._source.maxzoom);if(qe){const F=Ae.extendTileCover(pt,vt);for(const Ae of F)pt.push(Ae)}else{const F=Ae.extendTileCover(pt,vt,Ve);for(const Ae of F)this._shadowCasterTiles[Ae.key]=!0,pt.push(Ae)}}const ri=this._updateRetainedTiles(pt);if(It(this._source.type)&&0!==pt.length){const Ae={},Oe={},Fe=Object.keys(ri);for(const Ve of Fe){const Fe=ri[Ve],qe=this._tiles[Ve];if(!qe||qe.fadeEndTime&&qe.fadeEndTime<=F.q.now())continue;const pt=this.findLoadedParent(Fe,Math.max(Fe.overscaledZ-St.maxOverzooming,this._source.minzoom));pt&&(this._addTile(pt.tileID),Ae[pt.tileID.key]=pt.tileID),Oe[Ve]=Fe}const Ve=pt[pt.length-1].overscaledZ;for(const F in this._tiles){const Ae=this._tiles[F];if(ri[F]||!Ae.hasData())continue;let Fe=Ae.tileID;for(;Fe.overscaledZ>Ve;){Fe=Fe.scaledTo(Fe.overscaledZ-1);const Ve=this._tiles[Fe.key];if(Ve&&Ve.hasData()&&Oe[Fe.key]){ri[F]=Ae.tileID;break}}}for(const F in Ae)ri[F]||(this._coveredTiles[F]=!0,ri[F]=Ae[F])}for(const F in ri)this._tiles[F].clearFadeHold();const xi=F.bk(this._tiles,ri);for(const F of xi){const Ae=this._tiles[F];Ae.hasSymbolBuckets&&!Ae.holdingForFade()?Ae.setHoldDuration(this.map._fadeDuration):Ae.hasSymbolBuckets&&!Ae.symbolFadeFinished()||this._removeTile(+F)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const F in this._tiles)this._tiles[F].holdingForFade()&&this._removeTile(+F)}_updateRetainedTiles(F){const Ae={};if(0===F.length)return Ae;const Oe={},Fe=F.reduce(((F,Ae)=>Math.min(F,Ae.overscaledZ)),1/0),Ve=F[0].overscaledZ,qe=Math.max(Ve-St.maxOverzooming,this._source.minzoom),pt=Math.max(Ve+St.maxUnderzooming,this._source.minzoom),vt={};for(const Oe of F){const F=this._addTile(Oe);Ae[Oe.key]=Oe,F.hasData()||Fe<this._source.maxzoom&&(vt[Oe.key]=Oe)}this._retainLoadedChildren(vt,Fe,pt,Ae);for(const Fe of F){let F=this._tiles[Fe.key];if(F.hasData())continue;if(Fe.canonical.z>=this._source.maxzoom){const F=Fe.children(this._source.maxzoom)[0],Oe=this.getTile(F);if(Oe&&Oe.hasData()){Ae[F.key]=F;continue}}else{const F=Fe.children(this._source.maxzoom);if(Ae[F[0].key]&&Ae[F[1].key]&&Ae[F[2].key]&&Ae[F[3].key])continue}let Ve=F.wasRequested();for(let pt=Fe.overscaledZ-1;pt>=qe;--pt){const qe=Fe.scaledTo(pt);if(Oe[qe.key])break;if(Oe[qe.key]=!0,F=this.getTile(qe),!F&&Ve&&(F=this._addTile(qe)),F&&(Ae[qe.key]=qe,Ve=F.wasRequested(),F.hasData()))break}}return Ae}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const F in this._tiles){const Ae=[];let Oe,Fe=this._tiles[F].tileID;for(;Fe.overscaledZ>0;){if(Fe.key in this._loadedParentTiles){Oe=this._loadedParentTiles[Fe.key];break}Ae.push(Fe.key);const F=Fe.scaledTo(Fe.overscaledZ-1);if(Oe=this._getLoadedTile(F),Oe)break;Fe=F}for(const F of Ae)this._loadedParentTiles[F]=Oe}}_addTile(Ae){let Oe=this._tiles[Ae.key];if(Oe)return!0!==Oe.isExtraShadowCaster||!!this._shadowCasterTiles[Ae.key]||this._reloadTile(Ae.key,"reloading"),Oe;Oe=this._cache.getAndRemove(Ae),Oe&&(this._setTileReloadTimer(Ae.key,Oe),Oe.tileID=Ae,this._state.initializeTileState(Oe,this.map?this.map.painter:null),this._cacheTimers[Ae.key]&&(clearTimeout(this._cacheTimers[Ae.key]),delete this._cacheTimers[Ae.key],this._setTileReloadTimer(Ae.key,Oe)));const Fe=Boolean(Oe);if(!Fe){const F=this.map?this.map.painter:null,Fe=this._source.tileSize*Ae.overscaleFactor();Oe="raster-array"===this._source.type?new wt(Ae,Fe,this.transform.tileZoom,F,this._isRaster):new bt(Ae,Fe,this.transform.tileZoom,F,this._isRaster),this._loadTile(Oe,this._tileLoaded.bind(this,Oe,Ae.key,Oe.state))}return Oe?(Oe.uses++,this._tiles[Ae.key]=Oe,Fe||this._source.fire(new F.z("dataloading",{tile:Oe,coord:Oe.tileID,dataType:"source"})),Oe):null}_setTileReloadTimer(F,Ae){F in this._timers&&(clearTimeout(this._timers[F]),delete this._timers[F]);const Oe=Ae.getExpiryTimeout();Oe&&(this._timers[F]=setTimeout((()=>{this._reloadTile(F,"expired"),delete this._timers[F]}),Oe))}_removeTile(F){const Ae=this._tiles[F];Ae&&(Ae.uses--,delete this._tiles[F],this._timers[F]&&(clearTimeout(this._timers[F]),delete this._timers[F]),Ae.uses>0||(Ae.hasData()&&"reloading"!==Ae.state||"empty"===Ae.state?this._cache.add(Ae.tileID,Ae,Ae.getExpiryTimeout()):(Ae.aborted=!0,this._abortTile(Ae),this._unloadTile(Ae))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const F in this._tiles)this._removeTile(+F);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(Ae,Oe,Fe){const Ve=[],qe=this.transform;if(!qe)return Ve;const pt="globe"===qe.projection.name,vt=F.at(qe.center.lng);for(const zt in this._tiles){const ri=this._tiles[zt];if(Fe&&ri.clearQueryDebugViz(),ri.holdingForFade())continue;let xi;if(pt){const Ae=ri.tileID.canonical;if(0===Ae.z){const Oe=[Math.abs(F.aw(vt,...Rt(Ae,-1))-vt),Math.abs(F.aw(vt,...Rt(Ae,1))-vt)];xi=[0,2*Oe.indexOf(Math.min(...Oe))-1]}else{const Oe=[Math.abs(F.aw(vt,...Rt(Ae,-1))-vt),Math.abs(F.aw(vt,...Rt(Ae,0))-vt),Math.abs(F.aw(vt,...Rt(Ae,1))-vt)];xi=[Oe.indexOf(Math.min(...Oe))-1]}}else xi=[0];for(const F of xi){const Fe=Ae.containsTile(ri,qe,Oe,F);Fe&&Ve.push(Fe)}}return Ve}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(F){return this._getRenderableCoordinates(F)}_getRenderableCoordinates(F,Ae){const Oe=this.getRenderableIds(F,Ae).map((F=>this._tiles[F].tileID)),Fe="globe"===this.transform.projection.name;for(const F of Oe)F.projMatrix=this.transform.calculateProjMatrix(F.toUnwrapped()),F.expandedProjMatrix=Fe?this.transform.calculateProjMatrix(F.toUnwrapped(),!1,!0):F.projMatrix;return Oe}sortCoordinatesByDistance(F){const Ae=F.slice(),Oe=this.transform._camera.position,Fe=this.transform._camera.forward(),Ve={};for(const F of Ae){const Ae=1/(1<<F.canonical.z);Ve[F.key]=((F.canonical.x+.5)*Ae+F.wrap-Oe[0])*Fe[0]+((F.canonical.y+.5)*Ae-Oe[1])*Fe[1]-Oe[2]*Fe[2]}return Ae.sort(((F,Ae)=>Ve[F.key]-Ve[Ae.key])),Ae}hasTransition(){if(this._source.hasTransition())return!0;if(It(this._source.type))for(const Ae in this._tiles){const Oe=this._tiles[Ae];if(void 0!==Oe.fadeEndTime&&Oe.fadeEndTime>=F.q.now())return!0}return!1}setFeatureState(F,Ae,Oe){this._state.updateState(F=F||"_geojsonTileLayer",Ae,Oe)}removeFeatureState(F,Ae,Oe){this._state.removeFeatureState(F=F||"_geojsonTileLayer",Ae,Oe)}getFeatureState(F,Ae){return this._state.getState(F=F||"_geojsonTileLayer",Ae)}setDependencies(F,Ae,Oe){const Fe=this._tiles[F];Fe&&Fe.setDependencies(Ae,Oe)}reloadTilesForDependencies(F,Ae){for(const Oe in this._tiles)this._tiles[Oe].hasDependency(F,Ae)&&this._reloadTile(+Oe,"reloading");this._cache.filter((Oe=>!Oe.hasDependency(F,Ae)))}_preloadTiles(Ae,Oe){if(!this._sourceLoaded){const e=()=>{this._sourceLoaded&&(this._source.off("data",e),this._preloadTiles(Ae,Oe))};return void this._source.on("data",e)}const Fe=new Map,Ve=Array.isArray(Ae)?Ae:[Ae],qe=this.map.painter.terrain,pt=this.usedForTerrain&&qe?qe.getScaledDemTileSize():this._source.tileSize;for(const F of Ve){const Ae=F.coveringTiles({tileSize:pt,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const F of Ae)Fe.set(F.key,F);this.usedForTerrain&&F.updateElevation(!1)}const vt=Array.from(Fe.values());F.bl(vt,((F,Ae)=>{const Oe=new bt(F,this._source.tileSize*F.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(Oe,(F=>{"raster-dem"===this._source.type&&Oe.dem&&this._backfillDEM(Oe),Ae(F,Oe)}))}),Oe)}}function Ct(F,Ae){const Oe=Math.abs(2*F.wrap)-+(F.wrap<0),Fe=Math.abs(2*Ae.wrap)-+(Ae.wrap<0);return F.overscaledZ-Ae.overscaledZ||Fe-Oe||Ae.canonical.y-F.canonical.y||Ae.canonical.x-F.canonical.x}function It(F){return"raster"===F||"image"===F||"video"===F||"custom"===F}function Rt(F,Ae){const Oe=1<<F.z;return[F.x/Oe+Ae,(F.x+1)/Oe+Ae]}St.maxOverzooming=10,St.maxUnderzooming=3;class Dt{constructor(F){this.style=F,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const F=!1,Ae=!1;for(const Oe in this.style._mergedLayers){const Fe=this.style._mergedLayers[Oe];if("fill-extrusion"===Fe.type)this.layers.push({layer:Fe,visible:F,visibilityChanged:Ae});else if("model"===Fe.type){const Oe=this.style.getLayerSource(Fe);Oe&&"batched-model"===Oe.type&&this.layers.push({layer:Fe,visible:F,visibilityChanged:Ae})}}}onNewFrame(F){this.layersGotHidden=!1;for(const Ae of this.layers){const Oe=Ae.layer;let Fe=!1;"fill-extrusion"===Oe.type?Fe=!Oe.isHidden(F)&&Oe.paint.get("fill-extrusion-opacity")>0:"model"===Oe.type&&(Fe=!Oe.isHidden(F)&&Oe.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!Fe&&Ae.visible,Ae.visible=Fe}}updateZOffset(F,Ae){this.currentBuildingBuckets=[];for(const F of this.layers){const Oe=F.layer,Fe=this.style.getLayerSourceCache(Oe);let Ve=1;"fill-extrusion"===Oe.type&&(Ve=F.visible?Oe.paint.get("fill-extrusion-vertical-scale"):0);let qe=Fe?Fe.getTile(Ae):null;if(!qe&&Fe&&Ae.canonical.z>Fe.getSource().minzoom){let F=Ae.scaledTo(Math.min(Fe.getSource().maxzoom,Ae.overscaledZ-1));for(;F.overscaledZ>=Fe.getSource().minzoom&&(qe=Fe.getTile(F),!qe&&0!==F.overscaledZ);)F=F.scaledTo(F.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:qe?qe.getBucket(Oe):null,tileID:qe?qe.tileID:Ae,verticalScale:Ve})}F.hasAnyZOffset=!1;let Oe=!1;for(let Fe=0;Fe<F.symbolInstances.length;Fe++){const Ve=F.symbolInstances.get(Fe),qe=Ve.zOffset,pt=this._getHeightAtTileOffset(Ae,Ve.tileAnchorX,Ve.tileAnchorY);Ve.zOffset=pt!==Number.NEGATIVE_INFINITY?pt:qe,Oe||qe===Ve.zOffset||(Oe=!0),F.hasAnyZOffset||0===Ve.zOffset||(F.hasAnyZOffset=!0)}Oe&&(F.zOffsetBuffersNeedUpload=!0,F.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(Ae,Oe,Fe,Ve){let qe=Oe,pt=Fe;if(Ae.canonical.z!==Ve.canonical.z){const vt=Ve.canonical,zt=1/(1<<Ae.canonical.z-vt.z);qe=(Oe+Ae.canonical.x*F.ag)*zt-vt.x*F.ag|0,pt=(Fe+Ae.canonical.y*F.ag)*zt-vt.y*F.ag|0}return{tileX:qe,tileY:pt}}_getHeightAtTileOffset(F,Ae,Oe){let Fe,Ve;for(let qe=0;qe<this.layers.length;++qe){if("fill-extrusion"!==this.layers[qe].layer.type)continue;const{bucket:pt,tileID:vt,verticalScale:zt}=this.currentBuildingBuckets[qe];if(!pt)continue;const{tileX:ri,tileY:xi}=this._mapCoordToOverlappingTile(F,Ae,Oe,vt),bi=pt.getHeightAtTileCoord(ri,xi);bi&&void 0!==bi.height&&(bi.hidden?Fe=bi.height:Ve=Math.max(bi.height*zt,Ve||0))}if(void 0!==Ve)return Ve;for(let Ve=0;Ve<this.layers.length;++Ve){const qe=this.layers[Ve];if("model"!==qe.layer.type||!qe.visible)continue;const{bucket:pt,tileID:vt}=this.currentBuildingBuckets[Ve];if(!pt)continue;const{tileX:zt,tileY:ri}=this._mapCoordToOverlappingTile(F,Ae,Oe,vt),xi=pt.getHeightAtTileCoord(zt,ri);if(xi&&!xi.hidden)return void 0===xi.height&&void 0!==Fe?Math.min(xi.maxHeight,Fe)*xi.verticalScale:xi.height?xi.height*xi.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Lt(Ae,Oe){const Fe={};for(const F in Ae)"ref"!==F&&(Fe[F]=Ae[F]);return F.bm.forEach((F=>{F in Oe&&(Fe[F]=Oe[F])})),Fe}function At(F){F=F.slice();const Ae=Object.create(null);for(let Oe=0;Oe<F.length;Oe++)Ae[F[Oe].id]=F[Oe];for(let Oe=0;Oe<F.length;Oe++)"ref"in F[Oe]&&(F[Oe]=Lt(F[Oe],Ae[F[Oe].ref]));return F}const eh={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Pt(F,Ae,Oe){Oe.push({command:eh.addSource,args:[F,Ae[F]]})}function Mt(F,Ae,Oe){Ae.push({command:eh.removeSource,args:[F]}),Oe[F]=!0}function Ot(F,Ae,Oe,Fe){Mt(F,Oe,Fe),Pt(F,Ae,Oe)}function Ft(Ae,Oe,Fe){let Ve;for(Ve in Ae[Fe])if(Ae[Fe].hasOwnProperty(Ve)&&"data"!==Ve&&!F.bn(Ae[Fe][Ve],Oe[Fe][Ve]))return!1;for(Ve in Oe[Fe])if(Oe[Fe].hasOwnProperty(Ve)&&"data"!==Ve&&!F.bn(Ae[Fe][Ve],Oe[Fe][Ve]))return!1;return!0}function kt(Ae,Oe,Fe,Ve,qe,pt){let vt;for(vt in Oe=Oe||{},Ae=Ae||{})Ae.hasOwnProperty(vt)&&(F.bn(Ae[vt],Oe[vt])||Fe.push({command:pt,args:[Ve,vt,Oe[vt],qe]}));for(vt in Oe)Oe.hasOwnProperty(vt)&&!Ae.hasOwnProperty(vt)&&(F.bn(Ae[vt],Oe[vt])||Fe.push({command:pt,args:[Ve,vt,Oe[vt],qe]}))}function Bt(F){return F.id}function Nt(F,Ae){return F[Ae.id]=Ae,F}class Ut{constructor(F,Ae){this.reset(F,Ae)}reset(F,Ae){this.points=F||[],this._distances=[0];for(let F=1;F<this.points.length;F++)this._distances[F]=this._distances[F-1]+this.points[F].dist(this.points[F-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(Ae||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(Ae){if(1===this.points.length)return this.points[0];Ae=F.aw(Ae,0,1);let Oe=1,Fe=this._distances[Oe];const Ve=Ae*this.paddedLength+this.padding;for(;Fe<Ve&&Oe<this._distances.length;)Fe=this._distances[++Oe];const qe=Oe-1,pt=this._distances[qe],vt=Fe-pt,zt=vt>0?(Ve-pt)/vt:0;return this.points[qe].mult(1-zt).add(this.points[Oe].mult(zt))}}class jt{constructor(F,Ae,Oe){const Fe=this.boxCells=[],Ve=this.circleCells=[];this.xCellCount=Math.ceil(F/Oe),this.yCellCount=Math.ceil(Ae/Oe);for(let F=0;F<this.xCellCount*this.yCellCount;F++)Fe.push([]),Ve.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=F,this.height=Ae,this.xScale=this.xCellCount/F,this.yScale=this.yCellCount/Ae,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(F,Ae,Oe,Fe,Ve){this._forEachCell(Ae,Oe,Fe,Ve,this._insertBoxCell,this.boxUid++),this.boxKeys.push(F),this.bboxes.push(Ae),this.bboxes.push(Oe),this.bboxes.push(Fe),this.bboxes.push(Ve)}insertCircle(F,Ae,Oe,Fe){this._forEachCell(Ae-Fe,Oe-Fe,Ae+Fe,Oe+Fe,this._insertCircleCell,this.circleUid++),this.circleKeys.push(F),this.circles.push(Ae),this.circles.push(Oe),this.circles.push(Fe)}_insertBoxCell(F,Ae,Oe,Fe,Ve,qe){this.boxCells[Ve].push(qe)}_insertCircleCell(F,Ae,Oe,Fe,Ve,qe){this.circleCells[Ve].push(qe)}_query(F,Ae,Oe,Fe,Ve,qe){if(Oe<0||F>this.width||Fe<0||Ae>this.height)return!Ve&&[];const pt=[];if(F<=0&&Ae<=0&&this.width<=Oe&&this.height<=Fe){if(Ve)return!0;for(let F=0;F<this.boxKeys.length;F++)pt.push({key:this.boxKeys[F],x1:this.bboxes[4*F],y1:this.bboxes[4*F+1],x2:this.bboxes[4*F+2],y2:this.bboxes[4*F+3]});for(let F=0;F<this.circleKeys.length;F++){const Ae=this.circles[3*F],Oe=this.circles[3*F+1],Fe=this.circles[3*F+2];pt.push({key:this.circleKeys[F],x1:Ae-Fe,y1:Oe-Fe,x2:Ae+Fe,y2:Oe+Fe})}return qe?pt.filter(qe):pt}return this._forEachCell(F,Ae,Oe,Fe,this._queryCell,pt,{hitTest:Ve,seenUids:{box:{},circle:{}}},qe),Ve?pt.length>0:pt}_queryCircle(F,Ae,Oe,Fe,Ve){const qe=F-Oe,pt=F+Oe,vt=Ae-Oe,zt=Ae+Oe;if(pt<0||qe>this.width||zt<0||vt>this.height)return!Fe&&[];const ri=[];return this._forEachCell(qe,vt,pt,zt,this._queryCellCircle,ri,{hitTest:Fe,circle:{x:F,y:Ae,radius:Oe},seenUids:{box:{},circle:{}}},Ve),Fe?ri.length>0:ri}query(F,Ae,Oe,Fe,Ve){return this._query(F,Ae,Oe,Fe,!1,Ve)}hitTest(F,Ae,Oe,Fe,Ve){return this._query(F,Ae,Oe,Fe,!0,Ve)}hitTestCircle(F,Ae,Oe,Fe){return this._queryCircle(F,Ae,Oe,!0,Fe)}_queryCell(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=pt.seenUids,ri=this.boxCells[Ve];if(null!==ri){const Ve=this.bboxes;for(const xi of ri)if(!zt.box[xi]){zt.box[xi]=!0;const ri=4*xi;if(F<=Ve[ri+2]&&Ae<=Ve[ri+3]&&Oe>=Ve[ri+0]&&Fe>=Ve[ri+1]&&(!vt||vt(this.boxKeys[xi]))){if(pt.hitTest)return qe.push(!0),!0;qe.push({key:this.boxKeys[xi],x1:Ve[ri],y1:Ve[ri+1],x2:Ve[ri+2],y2:Ve[ri+3]})}}}const xi=this.circleCells[Ve];if(null!==xi){const Ve=this.circles;for(const ri of xi)if(!zt.circle[ri]){zt.circle[ri]=!0;const xi=3*ri;if(this._circleAndRectCollide(Ve[xi],Ve[xi+1],Ve[xi+2],F,Ae,Oe,Fe)&&(!vt||vt(this.circleKeys[ri]))){if(pt.hitTest)return qe.push(!0),!0;{const F=Ve[xi],Ae=Ve[xi+1],Oe=Ve[xi+2];qe.push({key:this.circleKeys[ri],x1:F-Oe,y1:Ae-Oe,x2:F+Oe,y2:Ae+Oe})}}}}}_queryCellCircle(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=pt.circle,ri=pt.seenUids,xi=this.boxCells[Ve];if(null!==xi){const F=this.bboxes;for(const Ae of xi)if(!ri.box[Ae]){ri.box[Ae]=!0;const Oe=4*Ae;if(this._circleAndRectCollide(zt.x,zt.y,zt.radius,F[Oe+0],F[Oe+1],F[Oe+2],F[Oe+3])&&(!vt||vt(this.boxKeys[Ae])))return qe.push(!0),!0}}const bi=this.circleCells[Ve];if(null!==bi){const F=this.circles;for(const Ae of bi)if(!ri.circle[Ae]){ri.circle[Ae]=!0;const Oe=3*Ae;if(this._circlesCollide(F[Oe],F[Oe+1],F[Oe+2],zt.x,zt.y,zt.radius)&&(!vt||vt(this.circleKeys[Ae])))return qe.push(!0),!0}}}_forEachCell(F,Ae,Oe,Fe,Ve,qe,pt,vt){const zt=this._convertToXCellCoord(F),ri=this._convertToYCellCoord(Ae),xi=this._convertToXCellCoord(Oe),bi=this._convertToYCellCoord(Fe);for(let wi=zt;wi<=xi;wi++)for(let zt=ri;zt<=bi;zt++)if(Ve.call(this,F,Ae,Oe,Fe,this.xCellCount*zt+wi,qe,pt,vt))return}_convertToXCellCoord(F){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(F*this.xScale)))}_convertToYCellCoord(F){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(F*this.yScale)))}_circlesCollide(F,Ae,Oe,Fe,Ve,qe){const pt=Fe-F,vt=Ve-Ae,zt=Oe+qe;return zt*zt>pt*pt+vt*vt}_circleAndRectCollide(F,Ae,Oe,Fe,Ve,qe,pt){const vt=(qe-Fe)/2,zt=Math.abs(F-(Fe+vt));if(zt>vt+Oe)return!1;const ri=(pt-Ve)/2,xi=Math.abs(Ae-(Ve+ri));if(xi>ri+Oe)return!1;if(zt<=vt||xi<=ri)return!0;const bi=zt-vt,wi=xi-ri;return bi*bi+wi*wi<=Oe*Oe}}const th={unknown:0,flipRequired:1,flipNotRequired:2},ih=Math.tan(85*Math.PI/180);function qt(Ae,Oe,Fe,Ve,qe,pt,vt){const zt=F.ab.mat4.create();if(Fe)if("globe"===pt.name){const Ae=F.bo(qe,Oe);F.ab.mat4.multiply(zt,zt,Ae)}else{const Ae=F.ab.mat2.invert([],vt);zt[0]=Ae[0],zt[1]=Ae[1],zt[4]=Ae[2],zt[5]=Ae[3],Ve||F.ab.mat4.rotateZ(zt,zt,qe.angle)}else F.ab.mat4.multiply(zt,qe.labelPlaneMatrix,Ae);return zt}function Ht(F,Ae,Oe,Fe,Ve,qe,pt){const vt=qt(F,Ae,Oe,Fe,Ve,qe,pt);return"globe"===qe.name&&Oe||(vt[2]=vt[6]=vt[10]=vt[14]=0),vt}function Zt(Ae,Oe,Fe,Ve,qe,pt,vt){if(Fe){if("globe"===pt.name){const zt=qt(Ae,Oe,Fe,Ve,qe,pt,vt);return F.ab.mat4.invert(zt,zt),F.ab.mat4.multiply(zt,Ae,zt),zt}{const Oe=F.ab.mat4.clone(Ae),Fe=F.ab.mat4.identity([]);return Fe[0]=vt[0],Fe[1]=vt[1],Fe[4]=vt[2],Fe[5]=vt[3],F.ab.mat4.multiply(Oe,Oe,Fe),Ve||F.ab.mat4.rotateZ(Oe,Oe,-qe.angle),Oe}}return qe.glCoordMatrix}function Wt(Ae,Oe,Fe,Ve){const qe=[Ae,Oe,Fe,1];Fe?F.ab.vec4.transformMat4(qe,qe,Ve):si(qe,qe,Ve);const pt=qe[3];return qe[0]/=pt,qe[1]/=pt,qe[2]/=pt,qe}function $t(F,Ae){return Math.min(.5+F/Ae*.5,1.5)}function Xt(F,Ae){const Oe=F[0]/F[3],Fe=F[1]/F[3];return Oe>=-Ae[0]&&Oe<=Ae[0]&&Fe>=-Ae[1]&&Fe<=Ae[1]}function Kt(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi){const bi=Fe.transform,wi=Ve?Ae.textSizeData:Ae.iconSizeData,dr=F.bp(wi,Fe.transform.zoom),jr="globe"===bi.projection.name,Qr=[256/Fe.width*2+1,256/Fe.height*2+1],Xn=Ve?Ae.text.dynamicLayoutVertexArray:Ae.icon.dynamicLayoutVertexArray;Xn.clear();let ho=null;jr&&(ho=Ve?Ae.text.globeExtVertexArray:Ae.icon.globeExtVertexArray);const yo=Ae.lineVertexArray,zo=Ve?Ae.text.placedSymbolArray:Ae.icon.placedSymbolArray,ko=Fe.transform.width/Fe.transform.height;let Uo,ia=!1;for(let Ve=0;Ve<zo.length;Ve++){const jr=zo.get(Ve),{numGlyphs:_a,writingMode:Ma}=jr;if(Ma!==F.bq.vertical||ia||Uo===F.bq.horizontal||(ia=!0),Uo=Ma,(jr.hidden||Ma===F.bq.vertical)&&!ia){oi(_a,Xn);continue}ia=!1;const Ea=new F.P(jr.tileAnchorX,jr.tileAnchorY);let{x:Ia,y:rl,z:Sl}=bi.projection.projectTilePoint(Ea.x,Ea.y,xi.canonical);if(ri){const[F,Ae,Oe]=ri(Ea);Ia+=F,rl+=Ae,Sl+=Oe}const Il=[Ia,rl,Sl,1];if(F.ab.vec4.transformMat4(Il,Il,Oe),!Xt(Il,Qr)){oi(_a,Xn);continue}const Kl=Il[3],Jl=$t(Fe.transform.getCameraToCenterDistance(bi.projection),Kl),Ql=F.br(wi,dr,jr),ec=vt?Ql/Jl:Ql*Jl,tc=Wt(Ia,rl,Sl,qe);if(tc[3]<=0){oi(_a,Xn);continue}let cc={};const uc=vt?null:ri,jc=Qt(jr,ec,!1,zt,Oe,qe,pt,Ae.glyphOffsetArray,yo,Xn,ho,tc,Ea,cc,ko,uc,bi.projection,xi,vt);ia=jc.useVertical,uc&&jc.needsFlipping&&(cc={}),(jc.notEnoughRoom||ia||jc.needsFlipping&&Qt(jr,ec,!0,zt,Oe,qe,pt,Ae.glyphOffsetArray,yo,Xn,ho,tc,Ea,cc,ko,uc,bi.projection,xi,vt).notEnoughRoom)&&oi(_a,Xn)}Ve?(Ae.text.dynamicLayoutVertexBuffer.updateData(Xn),ho&&Ae.text.globeExtVertexBuffer&&Ae.text.globeExtVertexBuffer.updateData(ho)):(Ae.icon.dynamicLayoutVertexBuffer.updateData(Xn),ho&&Ae.icon.globeExtVertexBuffer&&Ae.icon.globeExtVertexBuffer.updateData(ho))}function Yt(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr){const{lineStartIndex:Xn,glyphStartIndex:ho,segment:yo}=vt,zo=ho+vt.numGlyphs,ko=Xn+vt.lineLength,Uo=Ae.getoffsetX(ho),ia=Ae.getoffsetX(zo-1),_a=ii(F*Uo,Oe,Fe,Ve,qe,pt,yo,Xn,ko,zt,ri,xi,bi,wi,!0,dr,jr,Qr);if(!_a)return null;const Ma=ii(F*ia,Oe,Fe,Ve,qe,pt,yo,Xn,ko,zt,ri,xi,bi,wi,!0,dr,jr,Qr);return Ma?{first:_a,last:Ma}:null}function Jt(Ae,Oe,Fe,Ve){return Ae===F.bq.horizontal&&Math.abs(Ve)>Math.abs(Fe)?{useVertical:!0}:Ae===F.bq.vertical?Ve>0?{needsFlipping:!0}:null:Oe!==th.unknown&&function(F,Ae){return 0===F||Math.abs(Ae/F)>ih}(Fe,Ve)?Oe===th.flipRequired?{needsFlipping:!0}:null:Fe<0?{needsFlipping:!0}:null}function Qt(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo){const ko=Oe/24,Uo=Ae.lineOffsetX*ko,ia=Ae.lineOffsetY*ko,{lineStartIndex:_a,glyphStartIndex:Ma,numGlyphs:Ea,segment:Ia,writingMode:rl,flipState:Sl}=Ae,Il=_a+Ae.lineLength,L=Ae=>{if(bi){const[Oe,Fe,Ve]=Ae.up,qe=xi.length;F.bs(bi,qe+0,Oe,Fe,Ve),F.bs(bi,qe+1,Oe,Fe,Ve),F.bs(bi,qe+2,Oe,Fe,Ve),F.bs(bi,qe+3,Oe,Fe,Ve)}const[Oe,Fe,Ve]=Ae.point;F.bt(xi,Oe,Fe,Ve,Ae.angle)};if(Ea>1){const F=Yt(ko,zt,Uo,ia,Fe,wi,dr,Ae,ri,pt,jr,Xn,!1,ho,yo,zo);if(!F)return{notEnoughRoom:!0};if(Ve&&!Fe){let[Oe,Fe,Ve]=F.first.point,[qe,pt,zt]=F.last.point;[Oe,Fe]=Wt(Oe,Fe,Ve,vt),[qe,pt]=Wt(qe,pt,zt,vt);const ri=Jt(rl,Sl,(qe-Oe)*Qr,pt-Fe);if(Ae.flipState=ri&&ri.needsFlipping?th.flipRequired:th.flipNotRequired,ri)return ri}L(F.first);for(let F=Ma+1;F<Ma+Ea-1;F++){const Ae=ii(ko*zt.getoffsetX(F),Uo,ia,Fe,wi,dr,Ia,_a,Il,ri,pt,jr,Xn,!1,!1,ho,yo,zo);if(!Ae)return xi.length-=4*(F-Ma),{notEnoughRoom:!0};L(Ae)}L(F.last)}else{if(Ve&&!Fe){const Oe=Wt(dr.x,dr.y,0,qe),Fe=_a+Ia+1,Ve=new F.P(ri.getx(Fe),ri.gety(Fe)),pt=Wt(Ve.x,Ve.y,0,qe),vt=pt[3]>0?pt:ti(dr,Ve,Oe,1,qe,void 0,ho,yo.canonical),zt=Jt(rl,Sl,(vt[0]-Oe[0])*Qr,vt[1]-Oe[1]);if(Ae.flipState=zt&&zt.needsFlipping?th.flipRequired:th.flipNotRequired,zt)return zt}const Oe=ii(ko*zt.getoffsetX(Ma),Uo,ia,Fe,wi,dr,Ia,_a,Il,ri,pt,jr,Xn,!1,!1,ho,yo,zo);if(!Oe)return{notEnoughRoom:!0};L(Oe)}return{}}function ei(F,Ae,Oe,Fe,Ve){const{x:qe,y:pt,z:vt}=Fe.projectTilePoint(F.x,F.y,Ae);if(!Ve)return Wt(qe,pt,vt,Oe);const[zt,ri,xi]=Ve(F);return Wt(qe+zt,pt+ri,vt+xi,Oe)}function ti(Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri=ei(Ae.sub(Oe)._unit()._add(Ae),zt,qe,vt,pt);return F.ab.vec3.sub(ri,Fe,ri),F.ab.vec3.normalize(ri,ri),F.ab.vec3.scaleAndAdd(ri,Fe,ri,Ve)}function ii(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo){const zo=Ve?Ae-Oe:Ae+Oe;let ko=zo>0?1:-1,Uo=0;Ve&&(ko*=-1,Uo=Math.PI),ko<0&&(Uo+=Math.PI);let ia=zt+vt+(ko>0?0:1)|0,_a=qe,Ma=qe,Ea=0,Ia=0;const rl=Math.abs(zo),Sl=[],Il=[];let Kl=pt,Jl=Kl;const z=()=>ti(Jl,Kl,Ma,rl-Ea+1,bi,dr,Xn,ho.canonical);for(;Ea+Ia<=rl;){if(ia+=ko,ia<zt||ia>=ri)return null;if(Ma=_a,Jl=Kl,Sl.push(Ma),jr&&Il.push(Jl),Kl=new F.P(xi.getx(ia),xi.gety(ia)),_a=wi[ia],!_a){const F=ei(Kl,ho.canonical,bi,Xn,dr);_a=F[3]>0?wi[ia]=F:z()}Ea+=Ia,Ia=F.ab.vec3.distance(Ma,_a)}Qr&&dr&&(wi[ia]&&(_a=z(),Ia=F.ab.vec3.distance(Ma,_a)),wi[ia]=_a);const Ql=(rl-Ea)/Ia,ec=Kl.sub(Jl)._mult(Ql)._add(Jl),tc=F.ab.vec3.sub([],_a,Ma),cc=F.ab.vec3.scaleAndAdd([],Ma,tc,Ql);let uc=[0,0,1],jc=tc[0],Gc=tc[1];if(yo&&(uc=Xn.upVector(ho.canonical,ec.x,ec.y),0!==uc[0]||0!==uc[1]||1!==uc[2])){const Ae=[uc[2],0,-uc[0]],Oe=F.ab.vec3.cross([],uc,Ae);F.ab.vec3.normalize(Ae,Ae),F.ab.vec3.normalize(Oe,Oe),jc=F.ab.vec3.dot(tc,Ae),Gc=F.ab.vec3.dot(tc,Oe)}if(Fe){const Ae=F.ab.vec3.cross([],uc,tc);F.ab.vec3.normalize(Ae,Ae),F.ab.vec3.scaleAndAdd(cc,cc,Ae,Fe*ko)}const qc=Uo+Math.atan2(Gc,jc);return Sl.push(cc),jr&&Il.push(ec),{point:cc,angle:qc,path:Sl,tilePath:Il,up:uc}}function oi(F,Ae){const Oe=Ae.length,Fe=Oe+4*F;Ae.resize(Fe),Ae.float32.fill(-1/0,4*Oe,4*Fe)}function si(F,Ae,Oe){const Fe=Ae[0],Ve=Ae[1];return F[0]=Oe[0]*Fe+Oe[4]*Ve+Oe[12],F[1]=Oe[1]*Fe+Oe[5]*Ve+Oe[13],F[3]=Oe[3]*Fe+Oe[7]*Ve+Oe[15],F}const rh=100;class ai{constructor(F,Ae,Oe=new jt(F.width+200,F.height+200,25),Fe=new jt(F.width+200,F.height+200,25)){this.transform=F,this.grid=Oe,this.ignoredGrid=Fe,this.pitchfactor=Math.cos(F._pitch)*F.cameraToCenterDistance,this.screenRightBoundary=F.width+rh,this.screenBottomBoundary=F.height+rh,this.gridRightBoundary=F.width+200,this.gridBottomBoundary=F.height+200,this.fogState=Ae}placeCollisionBox(F,Ae,Oe,Fe,Ve,qe,pt,vt){let zt=Oe.projectedAnchorX,ri=Oe.projectedAnchorY,xi=Oe.projectedAnchorZ;const bi=Oe.elevation,wi=Oe.tileID,dr=F.getProjection();if(bi&&wi){const[F,Ae,Fe]=dr.upVector(wi.canonical,Oe.tileAnchorX,Oe.tileAnchorY),Ve=dr.upVectorScale(wi.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;zt+=F*bi*Ve,ri+=Ae*bi*Ve,xi+=Fe*bi*Ve}const jr=this.projectAndGetPerspectiveRatio(pt,zt,ri,xi,Oe.tileID,"globe"===dr.name||!!bi||this.transform.pitch>0,dr),Qr=qe*jr.perspectiveRatio,Xn=(Oe.x1*Ae+Fe.x-Oe.padding)*Qr+jr.point.x,ho=(Oe.y1*Ae+Fe.y-Oe.padding)*Qr+jr.point.y,yo=(Oe.x2*Ae+Fe.x+Oe.padding)*Qr+jr.point.x,zo=(Oe.y2*Ae+Fe.y+Oe.padding)*Qr+jr.point.y,ko=jr.perspectiveRatio<=.55||jr.occluded;return!this.isInsideGrid(Xn,ho,yo,zo)||!Ve&&this.grid.hitTest(Xn,ho,yo,zo,vt)||ko?{box:[],offscreen:!1,occluded:jr.occluded}:{box:[Xn,ho,yo,zo],offscreen:this.isOffscreen(Xn,ho,yo,zo),occluded:!1}}placeCollisionCircles(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr){const Xn=[],ho=this.transform.elevation,yo=Ae.getProjection(),zo=ho?ho.getAtTileOffsetFunc(Qr,this.transform.center.lat,this.transform.worldSize,yo):null,ko=new F.P(Fe.tileAnchorX,Fe.tileAnchorY);let{x:Uo,y:ia,z:_a}=yo.projectTilePoint(ko.x,ko.y,Qr.canonical);if(zo){const[F,Ae,Oe]=zo(ko);Uo+=F,ia+=Ae,_a+=Oe}const Ma="globe"===yo.name,Ea=this.projectAndGetPerspectiveRatio(vt,Uo,ia,_a,Qr,Ma||!!ho||this.transform.pitch>0,yo),{perspectiveRatio:Ia}=Ea,rl=(bi?pt/Ia:pt*Ia)/F.bw,Sl=Wt(Uo,ia,_a,zt),Il=Ea.signedDistanceFromCamera>0?Yt(rl,qe,Fe.lineOffsetX*rl,Fe.lineOffsetY*rl,!1,Sl,ko,Fe,Ve,zt,{},ho&&!bi?zo:null,bi&&!!ho,yo,Qr,bi):null;let Kl=!1,Jl=!1,Ql=!0;if(Il&&!Ea.occluded){const Ae=.5*dr*Ia+jr,Fe=new F.P(-100,-100),Ve=new F.P(this.screenRightBoundary,this.screenBottomBoundary),qe=new Ut,{first:pt,last:vt}=Il,zt=pt.path.length;let bi=[];for(let F=zt-1;F>=1;F--)bi.push(pt.path[F]);for(let F=1;F<vt.path.length;F++)bi.push(vt.path[F]);const Qr=2.5*Ae;ri&&(bi=bi.map((([F,Ae,Oe],Fe)=>(zo&&!Ma&&(Oe=zo(Fe<zt-1?pt.tilePath[zt-1-Fe]:vt.tilePath[Fe-zt+2])[2]),Wt(F,Ae,Oe,ri)))),bi.some((F=>F[3]<=0))&&(bi=[]));let ho=[];if(bi.length>0){let Ae=1/0,Oe=-1/0,qe=1/0,pt=-1/0;for(const F of bi)Ae=Math.min(Ae,F[0]),qe=Math.min(qe,F[1]),Oe=Math.max(Oe,F[0]),pt=Math.max(pt,F[1]);Oe>=Fe.x&&Ae<=Ve.x&&pt>=Fe.y&&qe<=Ve.y&&(ho=[bi.map((Ae=>new F.P(Ae[0],Ae[1])))],(Ae<Fe.x||Oe>Ve.x||qe<Fe.y||pt>Ve.y)&&(ho=F.bu(ho,Fe.x,Fe.y,Ve.x,Ve.y)))}for(const F of ho){qe.reset(F,.25*Ae);let Fe=0;Fe=qe.length<=.5*Ae?1:Math.ceil(qe.paddedLength/Qr)+1;for(let F=0;F<Fe;F++){const Ve=F/Math.max(Fe-1,1),pt=qe.lerp(Ve),vt=pt.x+rh,zt=pt.y+rh;Xn.push(vt,zt,Ae,0);const ri=vt-Ae,bi=zt-Ae,dr=vt+Ae,jr=zt+Ae;if(Ql=Ql&&this.isOffscreen(ri,bi,dr,jr),Jl=Jl||this.isInsideGrid(ri,bi,dr,jr),!Oe&&this.grid.hitTestCircle(vt,zt,Ae,wi)&&(Kl=!0,!xi))return{circles:[],offscreen:!1,collisionDetected:Kl,occluded:!1}}}}return{circles:!xi&&Kl||!Jl?[]:Xn,offscreen:Ql,collisionDetected:Kl,occluded:Ea.occluded}}queryRenderedSymbols(Ae){if(0===Ae.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const Oe=[];let Fe=1/0,Ve=1/0,qe=-1/0,pt=-1/0;for(const vt of Ae){const Ae=new F.P(vt.x+rh,vt.y+rh);Fe=Math.min(Fe,Ae.x),Ve=Math.min(Ve,Ae.y),qe=Math.max(qe,Ae.x),pt=Math.max(pt,Ae.y),Oe.push(Ae)}const vt=this.grid.query(Fe,Ve,qe,pt).concat(this.ignoredGrid.query(Fe,Ve,qe,pt)),zt={},ri={};for(const Ae of vt){const Fe=Ae.key;if(void 0===zt[Fe.bucketInstanceId]&&(zt[Fe.bucketInstanceId]={}),zt[Fe.bucketInstanceId][Fe.featureIndex])continue;const Ve=[new F.P(Ae.x1,Ae.y1),new F.P(Ae.x2,Ae.y1),new F.P(Ae.x2,Ae.y2),new F.P(Ae.x1,Ae.y2)];F.bv(Oe,Ve)&&(zt[Fe.bucketInstanceId][Fe.featureIndex]=!0,void 0===ri[Fe.bucketInstanceId]&&(ri[Fe.bucketInstanceId]=[]),ri[Fe.bucketInstanceId].push(Fe.featureIndex))}return ri}insertCollisionBox(F,Ae,Oe,Fe,Ve){(Ae?this.ignoredGrid:this.grid).insert({bucketInstanceId:Oe,featureIndex:Fe,collisionGroupID:Ve},F[0],F[1],F[2],F[3])}insertCollisionCircles(F,Ae,Oe,Fe,Ve){const qe=Ae?this.ignoredGrid:this.grid,pt={bucketInstanceId:Oe,featureIndex:Fe,collisionGroupID:Ve};for(let Ae=0;Ae<F.length;Ae+=4)qe.insertCircle(pt,F[Ae],F[Ae+1],F[Ae+2])}projectAndGetPerspectiveRatio(Ae,Oe,Fe,Ve,qe,pt,vt){const zt=[Oe,Fe,Ve,1];let ri=!1;if(Ve||this.transform.pitch>0){if(F.ab.vec4.transformMat4(zt,zt,Ae),this.fogState&&qe&&"globe"!==vt.name){const Ae=function(Ae,Oe,Fe,Ve,qe,pt){const vt=pt.calculateFogTileMatrix(qe),zt=[Oe,Fe,Ve];return F.ab.vec3.transformMat4(zt,zt,vt),ke(Ae,F.ab.vec3.length(zt),pt.pitch,pt._fov)}(this.fogState,Oe,Fe,Ve,qe.toUnwrapped(),this.transform);ri=Ae>.9}}else si(zt,zt,Ae);const xi=zt[3];return{point:new F.P((zt[0]/xi+1)/2*this.transform.width+rh,(-zt[1]/xi+1)/2*this.transform.height+rh),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(vt)/xi*.5,1.5),signedDistanceFromCamera:xi,occluded:pt&&zt[2]>xi||ri}}isOffscreen(F,Ae,Oe,Fe){return Oe<rh||F>=this.screenRightBoundary||Fe<rh||Ae>this.screenBottomBoundary}isInsideGrid(F,Ae,Oe,Fe){return Oe>=0&&F<this.gridRightBoundary&&Fe>=0&&Ae<this.gridBottomBoundary}getViewportMatrix(){const Ae=F.ab.mat4.identity([]);return F.ab.mat4.translate(Ae,Ae,[-100,-100,0]),Ae}}function ni(Ae,Oe,Fe){const Ve=Oe.createTileMatrix(Ae,Ae.worldSize,Fe.toUnwrapped());return F.ab.mat4.multiply(new Float32Array(16),Ae.projMatrix,Ve)}function li(F,Ae,Oe){if(Ae.projection.name===Oe.projection.name)return F.projMatrix;const Fe=Oe.clone();return Fe.setProjection(Ae.projection),ni(Fe,Ae.getProjection(),F)}function ci(F,Ae,Oe){return Ae.name===Oe.projection.name?F.projMatrix:ni(Oe,Ae,F)}class hi{constructor(F,Ae,Oe,Fe){this.opacity=F?Math.max(0,Math.min(1,F.opacity+(F.placed?Ae:-Ae))):Fe&&Oe?1:0,this.placed=Oe}isHidden(){return 0===this.opacity&&!this.placed}}class ui{constructor(F,Ae,Oe,Fe,Ve,qe=!1){this.text=new hi(F?F.text:null,Ae,Oe,Ve),this.icon=new hi(F?F.icon:null,Ae,Fe,Ve),this.clipped=qe}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class di{constructor(F,Ae,Oe,Fe=!1){this.text=F,this.icon=Ae,this.skipFade=Oe,this.clipped=Fe}}class _i{constructor(){this.invProjMatrix=F.ab.mat4.create(),this.viewportMatrix=F.ab.mat4.create(),this.circles=[]}}class pi{constructor(F,Ae,Oe,Fe,Ve){this.bucketInstanceId=F,this.featureIndex=Ae,this.sourceLayerIndex=Oe,this.bucketIndex=Fe,this.tileID=Ve}}class fi{constructor(F){this.crossSourceCollisions=F,this.maxGroupID=0,this.collisionGroups={}}get(F){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[F]){const Ae=++this.maxGroupID;this.collisionGroups[F]={ID:Ae,predicate:F=>F.collisionGroupID===Ae}}return this.collisionGroups[F]}}function mi(Ae,Oe,Fe,Ve,qe){const{horizontalAlign:pt,verticalAlign:vt}=F.bD(Ae),zt=-(pt-.5)*Oe,ri=-(vt-.5)*Fe,xi=F.bC(Ae,Ve);return new F.P(zt+xi[0]*qe,ri+xi[1]*qe)}function gi(Ae,Oe,Fe,Ve,qe){const pt=new F.P(Ae,Oe);return Fe&&pt._rotate(Ve?qe:-qe),pt}class vi{constructor(F,Ae,Oe,Fe,Ve,qe){this.transform=F.clone(),this.projection=F.projection.name,this.collisionIndex=new ai(this.transform,Ve),this.buildingIndex=qe,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=Ae,this.retainedQueryData={},this.collisionGroups=new fi(Oe),this.collisionCircleArrays={},this.prevPlacement=Fe,Fe&&(Fe.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(Ae,Oe,Fe,Ve,qe=1){const pt=Fe.getBucket(Oe),vt=Fe.latestFeatureIndex;if(!pt||!vt||Oe.fqid!==pt.layerIds[0])return;const zt=pt.layers[0].layout,ri=pt.layers[0].paint,xi=Fe.collisionBoxArray,bi=Math.pow(2,this.transform.zoom-Fe.tileID.overscaledZ),wi=Fe.tileSize/F.ag,dr=Fe.tileID.toUnwrapped();this.transform.setProjection(pt.projection);const jr=(Qr=Fe.tileID,Xn=pt.getProjection(),ho=this.transform,Xn.name===this.projection?ho.calculateProjMatrix(Qr.toUnwrapped()):ni(ho,Xn,Qr));var Qr,Xn,ho;const yo="map"===zt.get("text-pitch-alignment"),zo="map"===zt.get("text-rotation-alignment");Oe.compileFilter(Oe.options);const ko=Oe.dynamicFilter(),Uo=Oe.dynamicFilterNeedsFeature(),ia=this.transform.calculatePixelsToTileUnitsMatrix(Fe),_a=Ht(jr,Fe.tileID.canonical,yo,zo,this.transform,pt.getProjection(),ia);let Ma=null;if(yo){const Ae=Zt(jr,Fe.tileID.canonical,yo,zo,this.transform,pt.getProjection(),ia);Ma=F.ab.mat4.multiply([],this.transform.labelPlaneMatrix,Ae)}let Ea=null;ko&&Fe.latestFeatureIndex&&(Ea={unwrappedTileID:dr,dynamicFilter:ko,dynamicFilterNeedsFeature:Uo}),this.retainedQueryData[pt.bucketInstanceId]=new pi(pt.bucketInstanceId,vt,pt.sourceLayerIndex,pt.index,Fe.tileID);const[Ia,rl]=pt.layers[0].layout.get("text-size-scale-range"),Sl=F.aw(qe,Ia,rl),[Il,Kl]=zt.get("icon-size-scale-range"),Jl=F.aw(qe,Il,Kl),Ql={bucket:pt,layout:zt,paint:ri,posMatrix:jr,textLabelPlaneMatrix:_a,labelToScreenMatrix:Ma,clippingData:Ea,scale:bi,textPixelRatio:wi,holdingForFade:Fe.holdingForFade(),collisionBoxArray:xi,partiallyEvaluatedTextSize:F.bp(pt.textSizeData,this.transform.zoom,Sl),partiallyEvaluatedIconSize:F.bp(pt.iconSizeData,this.transform.zoom,Jl),collisionGroup:this.collisionGroups.get(pt.sourceID),latestFeatureIndex:Fe.latestFeatureIndex};if(Ve)for(const F of pt.sortKeyRanges){const{sortKey:Oe,symbolInstanceStart:Fe,symbolInstanceEnd:Ve}=F;Ae.push({sortKey:Oe,symbolInstanceStart:Fe,symbolInstanceEnd:Ve,parameters:Ql})}else Ae.push({symbolInstanceStart:0,symbolInstanceEnd:pt.symbolInstances.length,parameters:Ql})}attemptAnchorPlacement(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho){const{textOffset0:yo,textOffset1:zo,crossTileID:ko}=bi,Uo=[yo,zo],ia=mi(F,Oe,Fe,Uo,Ve),_a=this.collisionIndex.placeCollisionBox(dr,Ve,Ae,gi(ia.x,ia.y,qe,pt,this.transform.angle),xi,vt,zt,ri.predicate);if(Qr){const F=dr.getSymbolInstanceIconSize(ho,this.transform.zoom,bi.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(dr,F,Qr,gi(ia.x,ia.y,qe,pt,this.transform.angle),xi,vt,zt,ri.predicate).box.length)return}if(_a.box.length>0){let Ae;return this.prevPlacement&&this.prevPlacement.variableOffsets[ko]&&this.prevPlacement.placements[ko]&&this.prevPlacement.placements[ko].text&&(Ae=this.prevPlacement.variableOffsets[ko].anchor),this.variableOffsets[ko]={textOffset:Uo,width:Oe,height:Fe,anchor:F,textScale:Ve,prevAnchor:Ae},this.markUsedJustification(dr,F,bi,jr),dr.allowVerticalPlacement&&(this.markUsedOrientation(dr,jr,bi),this.placedOrientations[ko]=jr),{shift:ia,placedGlyphBoxes:_a}}}placeLayerBucketPart(Ae,Oe,Fe,Ve,qe=1){const{bucket:pt,layout:vt,paint:zt,posMatrix:ri,textLabelPlaneMatrix:xi,labelToScreenMatrix:bi,clippingData:wi,textPixelRatio:dr,holdingForFade:jr,collisionBoxArray:Qr,partiallyEvaluatedTextSize:Xn,partiallyEvaluatedIconSize:ho,collisionGroup:yo,latestFeatureIndex:zo}=Ae.parameters,ko=vt.get("text-optional"),Uo=vt.get("icon-optional"),ia=vt.get("text-allow-overlap"),_a=vt.get("icon-allow-overlap"),Ma="map"===vt.get("text-rotation-alignment"),Ea="map"===vt.get("text-pitch-alignment"),Ia=vt.get("symbol-z-elevate"),rl=zt.get("symbol-z-offset"),Sl="sea"===vt.get("symbol-elevation-reference"),[Il,Kl]=vt.get("text-size-scale-range"),[Jl,Ql]=vt.get("icon-size-scale-range"),ec=F.aw(qe,Il,Kl),tc=F.aw(qe,Jl,Ql);this.transform.setProjection(pt.projection);let cc=ia&&(_a||!pt.hasIconData()||Uo),uc=_a&&(ia||!pt.hasTextData()||ko);const jc=!rl.isConstant();!pt.collisionArrays&&Qr&&pt.deserializeCollisionBoxes(Qr),Fe&&Ve&&pt.updateCollisionDebugBuffers(this.transform.zoom,Qr,ec,tc);const B=(Ae,Ve,zt)=>{const{crossTileID:Qr,numVerticalGlyphVertices:Ia}=Ae;let Il=null;if(wi&&wi.dynamicFilterNeedsFeature||jc){const F=this.retainedQueryData[pt.bucketInstanceId];Il=zo.loadFeature({featureIndex:Ae.featureIndex,bucketIndex:F.bucketIndex,sourceLayerIndex:F.sourceLayerIndex,layoutVertexArrayOffset:0})}if(wi&&!(0,wi.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Il,this.retainedQueryData[pt.bucketInstanceId].tileID.canonical,new F.P(Ae.tileAnchorX,Ae.tileAnchorY),this.transform.calculateDistanceTileData(wi.unwrappedTileID)))return this.placements[Qr]=new di(!1,!1,!1,!0),void Oe.add(Qr);const Kl=rl.evaluate(Il,{});if(Oe.has(Qr))return;if(jr)return void(this.placements[Qr]=new di(!1,!1,!1));let Jl=!1,Ql=!1,ec=!0,tc=!1,Gc=!1,qc=null,$c={box:null,offscreen:null,occluded:null},Hc={box:null,offscreen:null,occluded:null},Wc=null,Kc=null,Jc=null,Qc=0,eh=0,th=0;zt.textFeatureIndex?Qc=zt.textFeatureIndex:Ae.useRuntimeCollisionCircles&&(Qc=Ae.featureIndex),zt.verticalTextFeatureIndex&&(eh=zt.verticalTextFeatureIndex);const $=F=>{F.tileID=this.retainedQueryData[pt.bucketInstanceId].tileID;const Oe=this.transform.elevation;F.elevation=Sl?Kl:Kl+(Oe?Oe.getAtTileOffset(F.tileID,F.tileAnchorX,F.tileAnchorY):0),F.elevation+=Ae.zOffset},ih=zt.textBox;if(ih){$(ih);const i=Oe=>{let Fe=F.bq.horizontal;if(pt.allowVerticalPlacement&&!Oe&&this.prevPlacement){const F=this.prevPlacement.placedOrientations[Qr];F&&(this.placedOrientations[Qr]=F,Fe=F,this.markUsedOrientation(pt,Fe,Ae))}return Fe},o=(Ae,Oe)=>{if(pt.allowVerticalPlacement&&Ia>0&&zt.verticalTextBox){for(const Fe of pt.writingModes)if(Fe===F.bq.vertical?($c=Oe(),Hc=$c):$c=Ae(),$c&&$c.box&&$c.box.length)break}else $c=Ae()};if(vt.get("text-variable-anchor")){let Oe=vt.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[Qr]){const F=this.prevPlacement.variableOffsets[Qr];Oe.indexOf(F.anchor)>0&&(Oe=Oe.filter((Ae=>Ae!==F.anchor)),Oe.unshift(F.anchor))}const h=(F,Fe,qe)=>{const vt=pt.getSymbolInstanceTextSize(Xn,Ae,this.transform.zoom,Ve),zt=(F.x2-F.x1)*vt+2*F.padding,xi=(F.y2-F.y1)*vt+2*F.padding,bi=Ae.hasIconTextFit&&!_a?Fe:null;bi&&$(bi);let wi={box:[],offscreen:!1,occluded:!1};const jr=ia?2*Oe.length:Oe.length;for(let Fe=0;Fe<jr;++Fe){const jr=this.attemptAnchorPlacement(Oe[Fe%Oe.length],F,zt,xi,vt,Ma,Ea,dr,ri,yo,Fe>=Oe.length,Ae,Ve,pt,qe,bi,Xn,ho);if(jr&&(wi=jr.placedGlyphBoxes,wi&&wi.box&&wi.box.length)){Jl=!0,qc=jr.shift;break}}return wi};o((()=>h(ih,zt.iconBox,F.bq.horizontal)),(()=>{const Ae=zt.verticalTextBox;return Ae&&$(Ae),pt.allowVerticalPlacement&&!($c&&$c.box&&$c.box.length)&&Ia>0&&Ae?h(Ae,zt.verticalIconBox,F.bq.vertical):{box:null,offscreen:null,occluded:null}})),$c&&(Jl=$c.box,ec=$c.offscreen,tc=$c.occluded);const Fe=i(!(!$c||!$c.box));if(!Jl&&this.prevPlacement){const F=this.prevPlacement.variableOffsets[Qr];F&&(this.variableOffsets[Qr]=F,this.markUsedJustification(pt,F.anchor,Ae,Fe))}}else{const n=(Oe,Fe)=>{const vt=pt.getSymbolInstanceTextSize(Xn,Ae,this.transform.zoom,Ve,qe),zt=this.collisionIndex.placeCollisionBox(pt,vt,Oe,new F.P(0,0),ia,dr,ri,yo.predicate);return zt&&zt.box&&zt.box.length&&(this.markUsedOrientation(pt,Fe,Ae),this.placedOrientations[Qr]=Fe),zt};o((()=>n(ih,F.bq.horizontal)),(()=>{const Ae=zt.verticalTextBox;return pt.allowVerticalPlacement&&Ia>0&&Ae?($(Ae),n(Ae,F.bq.vertical)):{box:null,offscreen:null,occluded:null}})),i(!!($c&&$c.box&&$c.box.length))}}if(Wc=$c,Jl=Wc&&Wc.box&&Wc.box.length>0,ec=Wc&&Wc.offscreen,tc=Wc&&Wc.occluded,Ae.useRuntimeCollisionCircles){const Oe=pt.text.placedSymbolArray.get(Ae.centerJustifiedTextSymbolIndex>=0?Ae.centerJustifiedTextSymbolIndex:Ae.verticalPlacedTextSymbolIndex),Ve=F.br(pt.textSizeData,Xn,Oe),qe=vt.get("text-padding");Kc=this.collisionIndex.placeCollisionCircles(pt,ia,Oe,pt.lineVertexArray,pt.glyphOffsetArray,Ve,ri,xi,bi,Fe,Ea,yo.predicate,Ae.collisionCircleDiameter*Ve/F.bw,qe,this.retainedQueryData[pt.bucketInstanceId].tileID),Jl=ia||Kc.circles.length>0&&!Kc.collisionDetected,ec=ec&&Kc.offscreen,tc=Kc.occluded}if(zt.iconFeatureIndex&&(th=zt.iconFeatureIndex),zt.iconBox){const i=Oe=>{$(Oe);const Fe=Ae.hasIconTextFit&&qc?gi(qc.x,qc.y,Ma,Ea,this.transform.angle):new F.P(0,0),Ve=pt.getSymbolInstanceIconSize(ho,this.transform.zoom,Ae.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(pt,Ve,Oe,Fe,_a,dr,ri,yo.predicate)};Hc&&Hc.box&&Hc.box.length&&zt.verticalIconBox?(Jc=i(zt.verticalIconBox),Ql=Jc.box.length>0):(Jc=i(zt.iconBox),Ql=Jc.box.length>0),ec=ec&&Jc.offscreen,Gc=Jc.occluded}const rh=ko||0===Ae.numHorizontalGlyphVertices&&0===Ia,nh=Uo||0===Ae.numIconVertices;if(rh||nh?nh?rh||(Ql=Ql&&Jl):Jl=Ql&&Jl:Ql=Jl=Ql&&Jl,Jl&&Wc&&Wc.box&&this.collisionIndex.insertCollisionBox(Wc.box,vt.get("text-ignore-placement"),pt.bucketInstanceId,Hc&&Hc.box&&eh?eh:Qc,yo.ID),Ql&&Jc&&this.collisionIndex.insertCollisionBox(Jc.box,vt.get("icon-ignore-placement"),pt.bucketInstanceId,th,yo.ID),Kc&&(Jl&&this.collisionIndex.insertCollisionCircles(Kc.circles,vt.get("text-ignore-placement"),pt.bucketInstanceId,Qc,yo.ID),Fe)){const F=pt.bucketInstanceId;let Ae=this.collisionCircleArrays[F];void 0===Ae&&(Ae=this.collisionCircleArrays[F]=new _i);for(let F=0;F<Kc.circles.length;F+=4)Ae.circles.push(Kc.circles[F+0]),Ae.circles.push(Kc.circles[F+1]),Ae.circles.push(Kc.circles[F+2]),Ae.circles.push(Kc.collisionDetected?1:0)}const oh="globe"!==pt.projection.name;cc=cc&&(oh||!tc),uc=uc&&(oh||!Gc),this.placements[Qr]=new di(Jl||cc,Ql||uc,ec||pt.justReloaded),Oe.add(Qr)};if(Ia&&this.buildingIndex&&(this.buildingIndex.updateZOffset(pt,this.retainedQueryData[pt.bucketInstanceId].tileID),pt.updateZOffset()),pt.sortFeaturesByY){const Ae=pt.getSortedSymbolIndexes(this.transform.angle);for(let F=Ae.length-1;F>=0;--F){const Oe=Ae[F];B(pt.symbolInstances.get(Oe),Oe,pt.collisionArrays[Oe])}pt.hasAnyZOffset&&F.w(`${pt.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(pt.hasAnyZOffset){const F=pt.getSortedIndexesByZOffset();for(let Ae=0;Ae<F.length;++Ae){const Oe=F[Ae];B(pt.symbolInstances.get(Oe),Oe,pt.collisionArrays[Oe])}}else for(let F=Ae.symbolInstanceStart;F<Ae.symbolInstanceEnd;F++)B(pt.symbolInstances.get(F),F,pt.collisionArrays[F]);if(Fe&&pt.bucketInstanceId in this.collisionCircleArrays){const Ae=this.collisionCircleArrays[pt.bucketInstanceId];F.ab.mat4.invert(Ae.invProjMatrix,ri),Ae.viewportMatrix=this.collisionIndex.getViewportMatrix()}pt.justReloaded=!1}markUsedJustification(Ae,Oe,Fe,Ve){const{leftJustifiedTextSymbolIndex:qe,centerJustifiedTextSymbolIndex:pt,rightJustifiedTextSymbolIndex:vt,verticalPlacedTextSymbolIndex:zt,crossTileID:ri}=Fe,xi=F.bB(Oe),bi=Ve===F.bq.vertical?zt:"left"===xi?qe:"center"===xi?pt:"right"===xi?vt:-1;qe>=0&&(Ae.text.placedSymbolArray.get(qe).crossTileID=bi>=0&&qe!==bi?0:ri),pt>=0&&(Ae.text.placedSymbolArray.get(pt).crossTileID=bi>=0&&pt!==bi?0:ri),vt>=0&&(Ae.text.placedSymbolArray.get(vt).crossTileID=bi>=0&&vt!==bi?0:ri),zt>=0&&(Ae.text.placedSymbolArray.get(zt).crossTileID=bi>=0&&zt!==bi?0:ri)}markUsedOrientation(Ae,Oe,Fe){const Ve=Oe===F.bq.horizontal||Oe===F.bq.horizontalOnly?Oe:0,qe=Oe===F.bq.vertical?Oe:0,{leftJustifiedTextSymbolIndex:pt,centerJustifiedTextSymbolIndex:vt,rightJustifiedTextSymbolIndex:zt,verticalPlacedTextSymbolIndex:ri}=Fe,xi=Ae.text.placedSymbolArray;pt>=0&&(xi.get(pt).placedOrientation=Ve),vt>=0&&(xi.get(vt).placedOrientation=Ve),zt>=0&&(xi.get(zt).placedOrientation=Ve),ri>=0&&(xi.get(ri).placedOrientation=qe)}commit(F){this.commitTime=F,this.zoomAtLastRecencyCheck=this.transform.zoom;const Ae=this.prevPlacement;let Oe=!1;this.prevZoomAdjustment=Ae?Ae.zoomAdjustment(this.transform.zoom):0;const Fe=Ae?Ae.symbolFadeChange(F):1,Ve=Ae?Ae.opacities:{},qe=Ae?Ae.variableOffsets:{},pt=Ae?Ae.placedOrientations:{};for(const F in this.placements){const Ae=this.placements[F],qe=Ve[F];qe?(this.opacities[F]=new ui(qe,Fe,Ae.text,Ae.icon,null,Ae.clipped),Oe=Oe||Ae.text!==qe.text.placed||Ae.icon!==qe.icon.placed):(this.opacities[F]=new ui(null,Fe,Ae.text,Ae.icon,Ae.skipFade,Ae.clipped),Oe=Oe||Ae.text||Ae.icon)}for(const F in Ve){const Ae=Ve[F];if(!this.opacities[F]){const Ve=new ui(Ae,Fe,!1,!1);Ve.isHidden()||(this.opacities[F]=Ve,Oe=Oe||Ae.text.placed||Ae.icon.placed)}}for(const F in qe)this.variableOffsets[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.variableOffsets[F]=qe[F]);for(const F in pt)this.placedOrientations[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.placedOrientations[F]=pt[F]);Oe?this.lastPlacementChangeTime=F:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=Ae?Ae.lastPlacementChangeTime:F)}updateLayerOpacities(F,Ae,Oe,Fe){const Ve=new Set;for(const qe of Ae){const Ae=qe.getBucket(F);Ae&&qe.latestFeatureIndex&&F.fqid===Ae.layerIds[0]&&(this.updateBucketOpacities(Ae,Ve,qe,qe.collisionBoxArray,Oe,Fe,qe.tileID,F.scope),Ae.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(Ae,qe.tileID),Ae.updateZOffset()))}}updateBucketOpacities(Ae,Oe,Fe,Ve,qe,pt,vt,zt){Ae.hasTextData()&&Ae.text.opacityVertexArray.clear(),Ae.hasIconData()&&Ae.icon.opacityVertexArray.clear(),Ae.hasIconCollisionBoxData()&&Ae.iconCollisionBox.collisionVertexArray.clear(),Ae.hasTextCollisionBoxData()&&Ae.textCollisionBox.collisionVertexArray.clear();const ri=Ae.layers[0].layout,xi=Ae.layers[0].paint,bi=!!Ae.layers[0].dynamicFilter(),wi=new ui(null,0,!1,!1,!0),dr=ri.get("text-allow-overlap"),jr=ri.get("icon-allow-overlap"),Qr=ri.get("text-variable-anchor"),Xn="map"===ri.get("text-rotation-alignment"),ho="map"===ri.get("text-pitch-alignment"),yo=xi.get("symbol-z-offset"),zo="sea"===ri.get("symbol-elevation-reference"),ko=!yo.isConstant(),Uo=new ui(null,0,dr&&(jr||!Ae.hasIconData()||ri.get("icon-optional")),jr&&(dr||!Ae.hasTextData()||ri.get("text-optional")),!0);!Ae.collisionArrays&&Ve&&(Ae.hasIconCollisionBoxData()||Ae.hasTextCollisionBoxData())&&Ae.deserializeCollisionBoxes(Ve);const w=(F,Ae,Oe)=>{for(let Fe=0;Fe<Ae/4;Fe++)F.opacityVertexArray.emplaceBack(Oe)};let ia=0;pt&&Ae.updateReplacement(vt,pt);for(let Ve=0;Ve<Ae.symbolInstances.length;Ve++){const ri=Ae.symbolInstances.get(Ve),{numHorizontalGlyphVertices:xi,numVerticalGlyphVertices:dr,crossTileID:jr,numIconVertices:_a,tileAnchorX:Ma,tileAnchorY:Ea}=ri;let Ia=null;const rl=this.retainedQueryData[Ae.bucketInstanceId];ko&&ri&&rl&&(Ia=Fe.latestFeatureIndex.loadFeature({featureIndex:ri.featureIndex,bucketIndex:rl.bucketIndex,sourceLayerIndex:rl.sourceLayerIndex,layoutVertexArrayOffset:0}));const Sl=yo.evaluate(Ia,{}),Il=Oe.has(jr);let Kl=this.opacities[jr];Il?Kl=wi:Kl||(Kl=Uo,this.opacities[jr]=Kl),Oe.add(jr);const Jl=xi>0||dr>0,Ql=_a>0,ec=this.placedOrientations[jr],tc=ec===F.bq.vertical,cc=ec===F.bq.horizontal||ec===F.bq.horizontalOnly;!Jl&&!Ql||Kl.isHidden()||ia++;let uc=!1;if((Jl||Ql)&&pt)for(const Oe of Ae.activeReplacements){if(F.bx(Oe,qe,F.by.Symbol,zt))continue;if(Oe.min.x>Ma||Ma>Oe.max.x||Oe.min.y>Ea||Ea>Oe.max.y)continue;const Ae=F.bz(Ma,Ea,vt.canonical,Oe.footprintTileId.canonical);if(uc=F.bA(Ae,Oe.footprint),uc)break}if(Jl){const F=uc?vh:Ii(Kl.text);w(Ae.text,xi,tc?vh:F),w(Ae.text,dr,cc?vh:F);const Oe=Kl.text.isHidden(),{leftJustifiedTextSymbolIndex:Fe,centerJustifiedTextSymbolIndex:Ve,rightJustifiedTextSymbolIndex:qe,verticalPlacedTextSymbolIndex:pt}=ri,vt=Ae.text.placedSymbolArray,zt=Oe||tc?1:0;Fe>=0&&(vt.get(Fe).hidden=zt),Ve>=0&&(vt.get(Ve).hidden=zt),qe>=0&&(vt.get(qe).hidden=zt),pt>=0&&(vt.get(pt).hidden=Oe||cc?1:0);const bi=this.variableOffsets[jr];bi&&this.markUsedJustification(Ae,bi.anchor,ri,ec);const wi=this.placedOrientations[jr];wi&&(this.markUsedJustification(Ae,"left",ri,wi),this.markUsedOrientation(Ae,wi,ri))}if(Ql){const F=uc?vh:Ii(Kl.icon),{placedIconSymbolIndex:Oe,verticalPlacedIconSymbolIndex:Fe}=ri,Ve=Ae.icon.placedSymbolArray,qe=Kl.icon.isHidden()?1:0;Oe>=0&&(w(Ae.icon,_a,tc?vh:F),Ve.get(Oe).hidden=qe),Fe>=0&&(w(Ae.icon,ri.numVerticalIconVertices,cc?vh:F),Ve.get(Fe).hidden=qe)}if(Ae.hasIconCollisionBoxData()||Ae.hasTextCollisionBoxData()){const Oe=Ae.collisionArrays[Ve];if(Oe){let Fe=new F.P(0,0),Ve=!0;if(Oe.textBox||Oe.verticalTextBox){if(Qr){const F=this.variableOffsets[jr];F?(Fe=mi(F.anchor,F.width,F.height,F.textOffset,F.textScale),Xn&&Fe._rotate(ho?this.transform.angle:-this.transform.angle)):Ve=!1}bi&&(Ve=!Kl.clipped),Oe.textBox&&yi(Ae.textCollisionBox.collisionVertexArray,Kl.text.placed,!Ve||tc,Sl,zo,Fe.x,Fe.y),Oe.verticalTextBox&&yi(Ae.textCollisionBox.collisionVertexArray,Kl.text.placed,!Ve||cc,Sl,zo,Fe.x,Fe.y)}const qe=Ve&&Boolean(!cc&&Oe.verticalIconBox);Oe.iconBox&&yi(Ae.iconCollisionBox.collisionVertexArray,Kl.icon.placed,qe,Sl,zo,ri.hasIconTextFit?Fe.x:0,ri.hasIconTextFit?Fe.y:0),Oe.verticalIconBox&&yi(Ae.iconCollisionBox.collisionVertexArray,Kl.icon.placed,!qe,Sl,zo,ri.hasIconTextFit?Fe.x:0,ri.hasIconTextFit?Fe.y:0)}}}if(Ae.fullyClipped=0===ia,Ae.sortFeatures(this.transform.angle),this.retainedQueryData[Ae.bucketInstanceId]&&(this.retainedQueryData[Ae.bucketInstanceId].featureSortOrder=Ae.featureSortOrder),Ae.hasTextData()&&Ae.text.opacityVertexBuffer&&Ae.text.opacityVertexBuffer.updateData(Ae.text.opacityVertexArray),Ae.hasIconData()&&Ae.icon.opacityVertexBuffer&&Ae.icon.opacityVertexBuffer.updateData(Ae.icon.opacityVertexArray),Ae.hasIconCollisionBoxData()&&Ae.iconCollisionBox.collisionVertexBuffer&&Ae.iconCollisionBox.collisionVertexBuffer.updateData(Ae.iconCollisionBox.collisionVertexArray),Ae.hasTextCollisionBoxData()&&Ae.textCollisionBox.collisionVertexBuffer&&Ae.textCollisionBox.collisionVertexBuffer.updateData(Ae.textCollisionBox.collisionVertexArray),Ae.bucketInstanceId in this.collisionCircleArrays){const F=this.collisionCircleArrays[Ae.bucketInstanceId];Ae.placementInvProjMatrix=F.invProjMatrix,Ae.placementViewportMatrix=F.viewportMatrix,Ae.collisionCircleArray=F.circles,delete this.collisionCircleArrays[Ae.bucketInstanceId]}}symbolFadeChange(F){return 0===this.fadeDuration?1:(F-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(F){return Math.max(0,(this.transform.zoom-F)/1.5)}hasTransitions(F){return this.stale||F-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(F,Ae){const Oe=this.zoomAtLastRecencyCheck===Ae?1-this.zoomAdjustment(Ae):1;return this.zoomAtLastRecencyCheck=Ae,this.commitTime+this.fadeDuration*Oe>F}setStale(){this.stale=!0}}function yi(F,Ae,Oe,Fe,Ve,qe,pt){F.emplaceBack(Ae?1:0,Oe?1:0,qe||0,pt||0,Fe,Ve?1:0),F.emplaceBack(Ae?1:0,Oe?1:0,qe||0,pt||0,Fe,Ve?1:0),F.emplaceBack(Ae?1:0,Oe?1:0,qe||0,pt||0,Fe,Ve?1:0),F.emplaceBack(Ae?1:0,Oe?1:0,qe||0,pt||0,Fe,Ve?1:0)}const nh=Math.pow(2,25),oh=Math.pow(2,24),sh=Math.pow(2,17),ah=Math.pow(2,16),lh=Math.pow(2,9),uh=Math.pow(2,8),fh=Math.pow(2,1);function Ii(F){if(0===F.opacity&&!F.placed)return 0;if(1===F.opacity&&F.placed)return 4294967295;const Ae=F.placed?1:0,Oe=Math.floor(127*F.opacity);return Oe*nh+Ae*oh+Oe*sh+Ae*ah+Oe*lh+Ae*uh+Oe*fh+Ae}const vh=0;class Di{constructor(F){this._sortAcrossTiles="viewport-y"!==F.layout.get("symbol-z-order")&&void 0!==F.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(F,Ae,Oe,Fe,Ve,qe){const pt=this._bucketParts;for(;this._currentTileIndex<F.length;)if(Ae.getBucketParts(pt,Fe,F[this._currentTileIndex],this._sortAcrossTiles,qe),this._currentTileIndex++,Ve())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,pt.sort(((F,Ae)=>F.sortKey-Ae.sortKey)));this._currentPartIndex<pt.length;){const F=pt[this._currentPartIndex];if(Ae.placeLayerBucketPart(F,this._seenCrossTileIDs,Oe,0===F.symbolInstanceStart,qe),this._currentPartIndex++,Ve())return!0}return!1}}class Li{constructor(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt){this.placement=new vi(F,Ve,qe,pt,vt,zt),this._currentPlacementIndex=Ae.length-1,this._forceFullPlacement=Oe,this._showCollisionBoxes=Fe,this._done=!1}isDone(){return this._done}continuePlacement(Ae,Oe,Fe,Ve,qe){const pt=F.q.now(),n=()=>{const Ae=F.q.now()-pt;return!this._forceFullPlacement&&Ae>2};for(;this._currentPlacementIndex>=0;){const pt=Oe[Ae[this._currentPlacementIndex]],vt=this.placement.collisionIndex.transform.zoom;if("symbol"===pt.type&&(!pt.minzoom||pt.minzoom<=vt)&&(!pt.maxzoom||pt.maxzoom>vt)){const Ae=pt,Oe=Ae.layout.get("symbol-z-elevate"),vt=void 0!==Ae.layout.get("symbol-sort-key").constantOr(1),zt=Ae.layout.get("symbol-z-order"),ri="viewport-y"===zt||"auto"===zt&&!("viewport-y"!==zt&&vt),xi=Ae.layout.get("text-allow-overlap")||Ae.layout.get("icon-allow-overlap")||Ae.layout.get("text-ignore-placement")||Ae.layout.get("icon-ignore-placement"),bi=ri&&xi,wi=this._inProgressLayer=this._inProgressLayer||new Di(Ae),dr=F.aC(pt.source,pt.scope);if(wi.continuePlacement(Oe||bi?Ve[dr]:Fe[dr],this.placement,this._showCollisionBoxes,pt,n,qe))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(F){return this.placement.commit(F),this.placement}}const Th=512/F.ag/2;class zi{constructor(Ae,Oe,Fe){this.tileID=Ae,this.bucketInstanceId=Fe,this.index=new F.bE(Oe.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const Ve=Ae.canonical.x*F.ag,qe=Ae.canonical.y*F.ag;for(let F=0;F<Oe.length;F++){const{key:Ae,crossTileID:Fe,tileAnchorX:pt,tileAnchorY:vt}=Oe.get(F),zt=Math.floor((Ve+pt)*Th),ri=Math.floor((qe+vt)*Th);this.index.add(zt,ri),this.keys.push(Ae),this.crossTileIDs.push(Fe)}this.index.finish()}findMatches(Ae,Oe,Fe){const Ve=this.tileID.canonical.z<Oe.canonical.z?1:Math.pow(2,this.tileID.canonical.z-Oe.canonical.z),qe=Th/Math.pow(2,Oe.canonical.z-this.tileID.canonical.z),pt=Oe.canonical.x*F.ag,vt=Oe.canonical.y*F.ag;for(let F=0;F<Ae.length;F++){const Oe=Ae.get(F);if(Oe.crossTileID)continue;const{key:zt,tileAnchorX:ri,tileAnchorY:xi}=Oe,bi=Math.floor((pt+ri)*qe),wi=Math.floor((vt+xi)*qe),dr=this.index.range(bi-Ve,wi-Ve,bi+Ve,wi+Ve);for(const F of dr){const Ae=this.crossTileIDs[F];if(this.keys[F]===zt&&!Fe.has(Ae)){Fe.add(Ae),Oe.crossTileID=Ae;break}}}}}class Pi{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Mi{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(F){const Ae=Math.round((F-this.lng)/360);if(0!==Ae)for(const F in this.indexes){const Oe=this.indexes[F],Fe={};for(const F in Oe){const Ve=Oe[F];Ve.tileID=Ve.tileID.unwrapTo(Ve.tileID.wrap+Ae),Fe[Ve.tileID.key]=Ve}this.indexes[F]=Fe}this.lng=F}addBucket(F,Ae,Oe){if(this.indexes[F.overscaledZ]&&this.indexes[F.overscaledZ][F.key]){if(this.indexes[F.overscaledZ][F.key].bucketInstanceId===Ae.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(F.overscaledZ,this.indexes[F.overscaledZ][F.key])}for(let F=0;F<Ae.symbolInstances.length;F++)Ae.symbolInstances.get(F).crossTileID=0;this.usedCrossTileIDs[F.overscaledZ]||(this.usedCrossTileIDs[F.overscaledZ]=new Set);const Fe=this.usedCrossTileIDs[F.overscaledZ];for(const Oe in this.indexes){const Ve=this.indexes[Oe];if(Number(Oe)>F.overscaledZ)for(const Oe in Ve){const qe=Ve[Oe];qe.tileID.isChildOf(F)&&qe.findMatches(Ae.symbolInstances,F,Fe)}else{const qe=Ve[F.scaledTo(Number(Oe)).key];qe&&qe.findMatches(Ae.symbolInstances,F,Fe)}}for(let F=0;F<Ae.symbolInstances.length;F++){const Ve=Ae.symbolInstances.get(F);Ve.crossTileID||(Ve.crossTileID=Oe.generate(),Fe.add(Ve.crossTileID))}return void 0===this.indexes[F.overscaledZ]&&(this.indexes[F.overscaledZ]={}),this.indexes[F.overscaledZ][F.key]=new zi(F,Ae.symbolInstances,Ae.bucketInstanceId),!0}removeBucketCrossTileIDs(F,Ae){for(const Oe of Ae.crossTileIDs)this.usedCrossTileIDs[F].delete(Oe)}removeStaleBuckets(F){let Ae=!1;for(const Oe in this.indexes){const Fe=this.indexes[Oe];for(const Ve in Fe)F[Fe[Ve].bucketInstanceId]||(this.removeBucketCrossTileIDs(Oe,Fe[Ve]),delete Fe[Ve],Ae=!0)}return Ae}}class Oi{constructor(){this.layerIndexes={},this.crossTileIDs=new Pi,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(F,Ae,Oe,Fe){let Ve=this.layerIndexes[F.fqid];void 0===Ve&&(Ve=this.layerIndexes[F.fqid]=new Mi);let qe=!1;const pt={};"globe"!==Fe.name&&Ve.handleWrapJump(Oe);for(const Oe of Ae){const Ae=Oe.getBucket(F);Ae&&F.fqid===Ae.layerIds[0]&&(Ae.bucketInstanceId||(Ae.bucketInstanceId=++this.maxBucketInstanceId),Ve.addBucket(Oe.tileID,Ae,this.crossTileIDs)&&(qe=!0),pt[Ae.bucketInstanceId]=!0)}return Ve.removeStaleBuckets(pt)&&(qe=!0),qe}pruneUnusedLayers(F){const Ae={};F.forEach((F=>{Ae[F]=!0}));for(const F in this.layerIndexes)Ae[F]||delete this.layerIndexes[F]}}const Ch=771;class ki{constructor(F,Ae,Oe,Fe){this.blendFunction=F,this.blendColor=Ae,this.mask=Oe,this.blendEquation=Fe}}ki.Replace=[1,0,1,0],ki.disabled=new ki(ki.Replace,F.aj.transparent,[!1,!1,!1,!1]),ki.unblended=new ki(ki.Replace,F.aj.transparent,[!0,!0,!0,!0]),ki.alphaBlended=new ki([1,Ch,1,Ch],F.aj.transparent,[!0,!0,!0,!0]),ki.alphaBlendedNonPremultiplied=new ki([770,Ch,770,Ch],F.aj.transparent,[!0,!0,!0,!0]),ki.multiply=new ki([774,0,774,0],F.aj.transparent,[!0,!0,!0,!0]);class Bi{constructor(F,Ae,Oe){this.func=F,this.mask=Ae,this.range=Oe}}Bi.ReadOnly=!1,Bi.ReadWrite=!0,Bi.disabled=new Bi(519,Bi.ReadOnly,[0,1]);const Dh=7680;class Ui{constructor(F,Ae,Oe,Fe,Ve,qe){this.test=F,this.ref=Ae,this.mask=Oe,this.fail=Fe,this.depthFail=Ve,this.pass=qe}}Ui.disabled=new Ui({func:519,mask:0},0,0,Dh,Dh,Dh);const Rh=1029,Lh=2305;class Vi{constructor(F,Ae,Oe){this.enable=F,this.mode=Ae,this.frontFace=Oe}}function qi(Ae,Oe){const Fe=F.bG(Ae,3);F.ab.mat4.fromQuat(Ae,Oe),F.bI(Ae,3,Fe)}function Hi(Ae,Oe){const Fe=F.ab.quat.identity([]);return F.ab.quat.rotateZ(Fe,Fe,-Oe),F.ab.quat.rotateX(Fe,Fe,-Ae),Fe}function Zi(Ae,Oe){const Fe=[Ae[0],Ae[1],0],Ve=[Oe[0],Oe[1],0];if(F.ab.vec3.length(Fe)>=1e-15){const Ae=F.ab.vec3.normalize([],Fe);F.ab.vec3.scale(Ve,Ae,F.ab.vec3.dot(Ve,Ae)),Oe[0]=Ve[0],Oe[1]=Ve[1]}const qe=F.ab.vec3.cross([],Oe,Ae);if(F.ab.vec3.len(qe)<1e-15)return null;const pt=Math.atan2(-qe[1],qe[0]);return Hi(Math.atan2(Math.sqrt(Ae[0]*Ae[0]+Ae[1]*Ae[1]),-Ae[2]),pt)}Vi.disabled=new Vi(!1,Rh,Lh),Vi.backCCW=new Vi(!0,Rh,Lh),Vi.backCW=new Vi(!0,Rh,2304),Vi.frontCW=new Vi(!0,1028,2304),Vi.frontCCW=new Vi(!0,1028,Lh);class Wi{constructor(F,Ae){this.position=F,this.orientation=Ae}get position(){return this._position}set position(Ae){if(Ae){const Oe=Ae instanceof F.aa?Ae:new F.aa(Ae[0],Ae[1],Ae[2]);this._renderWorldCopies&&(Oe.x=F.bF(Oe.x,0,1)),this._position=Oe}else this._position=null}lookAtPoint(Ae,Oe){if(this.orientation=null,!this.position)return;const Fe=this.position,Ve=this._elevation?this._elevation.getAtPointOrZero(F.aa.fromLngLat(Ae)):0,qe=F.aa.fromLngLat(Ae,Ve),pt=[qe.x-Fe.x,qe.y-Fe.y,qe.z-Fe.z];Oe||(Oe=[0,0,1]),Oe[2]=Math.abs(Oe[2]),this.orientation=Zi(pt,Oe)}setPitchBearing(Ae,Oe){this.orientation=Hi(F.ai(Ae),F.ai(-Oe))}}class $i{constructor(Ae,Oe){this._transform=F.ab.mat4.identity([]),this.orientation=Oe,this.position=Ae}get mercatorPosition(){const Ae=this.position;return new F.aa(Ae[0],Ae[1],Ae[2])}get position(){const Ae=F.bG(this._transform,3);return[Ae[0],Ae[1],Ae[2]]}set position(Ae){var Oe;Ae&&F.bI(this._transform,3,[(Oe=Ae)[0],Oe[1],Oe[2],1])}get orientation(){return this._orientation}set orientation(Ae){this._orientation=Ae||F.ab.quat.identity([]),Ae&&qi(this._transform,this._orientation)}getPitchBearing(){const F=this.forward(),Ae=this.right();return{bearing:Math.atan2(-Ae[1],Ae[0]),pitch:Math.atan2(Math.sqrt(F[0]*F[0]+F[1]*F[1]),-F[2])}}setPitchBearing(F,Ae){this._orientation=Hi(F,Ae),qi(this._transform,this._orientation)}forward(){const Ae=F.bG(this._transform,2);return[-Ae[0],-Ae[1],-Ae[2]]}up(){const Ae=F.bG(this._transform,1);return[-Ae[0],-Ae[1],-Ae[2]]}right(){const Ae=F.bG(this._transform,0);return[Ae[0],Ae[1],Ae[2]]}getCameraToWorld(Ae,Oe){const Fe=new Float64Array(16);return F.ab.mat4.invert(Fe,this.getWorldToCamera(Ae,Oe)),Fe}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(Ae,Oe,Fe){const Ve=this.position;F.ab.vec3.scale(Ve,Ve,-Ae);const qe=new Float64Array(16);return F.ab.mat4.fromScaling(qe,[Fe,Fe,Fe]),F.ab.mat4.translate(qe,qe,Ve),qe[10]*=Oe,qe}getWorldToCamera(Ae,Oe){const Fe=new Float64Array(16),Ve=new Float64Array(4),qe=this.position;return F.ab.quat.conjugate(Ve,this._orientation),F.ab.vec3.scale(qe,qe,-Ae),F.ab.mat4.fromQuat(Fe,Ve),F.ab.mat4.translate(Fe,Fe,qe),Fe[1]*=-1,Fe[5]*=-1,Fe[9]*=-1,Fe[13]*=-1,Fe[8]*=Oe,Fe[9]*=Oe,Fe[10]*=Oe,Fe[11]*=Oe,Fe}getCameraToClipPerspective(Ae,Oe,Fe,Ve){const qe=new Float64Array(16);return F.ab.mat4.perspective(qe,Ae,Oe,Fe,Ve),qe}getCameraToClipOrthographic(Ae,Oe,Fe,Ve,qe,pt){const vt=new Float64Array(16);return F.ab.mat4.ortho(vt,Ae,Oe,Fe,Ve,qe,pt),vt}getDistanceToElevation(Ae,Oe=!1){const Fe=0===Ae?0:F.bH(Ae,Oe?F.aS(this.position[1]):this.position[1]),Ve=this.forward();return(Fe-this.position[2])/Ve[2]}clone(){return new $i([...this.position],[...this.orientation])}}const Oh={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Ki{constructor(F=0,Ae=0,Oe=0,Fe=0){if(isNaN(F)||F<0||isNaN(Ae)||Ae<0||isNaN(Oe)||Oe<0||isNaN(Fe)||Fe<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=F,this.bottom=Ae,this.left=Oe,this.right=Fe}interpolate(Ae,Oe,Fe){return null!=Oe.top&&null!=Ae.top&&(this.top=F.af(Ae.top,Oe.top,Fe)),null!=Oe.bottom&&null!=Ae.bottom&&(this.bottom=F.af(Ae.bottom,Oe.bottom,Fe)),null!=Oe.left&&null!=Ae.left&&(this.left=F.af(Ae.left,Oe.left,Fe)),null!=Oe.right&&null!=Ae.right&&(this.right=F.af(Ae.right,Oe.right,Fe)),this}getCenter(Ae,Oe){const Fe=F.aw((this.left+Ae-this.right)/2,0,Ae),Ve=F.aw((this.top+Oe-this.bottom)/2,0,Oe);return new F.P(Fe,Ve)}equals(F){return this.top===F.top&&this.bottom===F.bottom&&this.left===F.left&&this.right===F.right}clone(){return new Ki(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Yi=(F,Ae,Oe)=>(1-Oe)*F+Oe*Ae,Ji=F=>F*F*F*F*F;class Qi{constructor(Ae,Oe,Fe,Ve,qe,pt,vt){this.tileSize=512,this._renderWorldCopies=void 0===qe||qe,this._minZoom=Ae||0,this._maxZoom=Oe||22,this._minPitch=Fe??0,this._maxPitch=Ve??60,this.setProjection(pt),this.setMaxBounds(vt),this.width=0,this.height=0,this._center=new F.bO(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Ki,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new $i,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const F=new Qi(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return F._elevation=this._elevation,F._centerAltitude=this._centerAltitude,F._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,F.tileSize=this.tileSize,F.mercatorFromTransition=this.mercatorFromTransition,F.width=this.width,F.height=this.height,F.cameraElevationReference=this.cameraElevationReference,F._center=this._center,F._setZoom(this.zoom),F._seaLevelZoom=this._seaLevelZoom,F.angle=this.angle,F._fov=this._fov,F._pitch=this._pitch,F._nearZ=this._nearZ,F._farZ=this._farZ,F._averageElevation=this._averageElevation,F._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,F._unmodified=this._unmodified,F._edgeInsets=this._edgeInsets.clone(),F._camera=this._camera.clone(),F._calcMatrices(),F.freezeTileCoverage=this.freezeTileCoverage,F.frustumCorners=this.frustumCorners,F}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(F){this._elevation!==F&&(this._elevation=F,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(F,Ae=!1){const Oe=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||Oe)&&this._updateCameraOnTerrain(),(F||Oe)&&this._constrainCamera(Ae),this._calcMatrices()}getProjection(){return F.ay(this.projection,["name","center","parallels"])}setProjection(Ae){this.projectionOptions=Ae||{name:"mercator"};const Oe=this.projection?this.getProjection():void 0;this.projection=F.bP(this.projectionOptions);const Fe=this.getProjection(),Ve=!F.bn(Oe,Fe);return Ve&&this._calcMatrices(),this.mercatorFromTransition=!1,Ve}setOrthographicProjectionAtLowPitch(F){return this._orthographicProjectionAtLowPitch!==F&&(this._orthographicProjectionAtLowPitch=F,this._calcMatrices(),!0)}setMercatorFromTransition(){const Ae=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=F.bP({name:"mercator"});const Oe=Ae!==this.projection.name;return Oe&&this._calcMatrices(),Oe}get minZoom(){return this._minZoom}set minZoom(F){this._minZoom!==F&&(this._minZoom=F,this.zoom=Math.max(this.zoom,F))}get maxZoom(){return this._maxZoom}set maxZoom(F){this._maxZoom!==F&&(this._maxZoom=F,this.zoom=Math.min(this.zoom,F))}get minPitch(){return this._minPitch}set minPitch(F){this._minPitch!==F&&(this._minPitch=F,this.pitch=Math.max(this.pitch,F))}get maxPitch(){return this._maxPitch}set maxPitch(F){this._maxPitch!==F&&(this._maxPitch=F,this.pitch=Math.min(this.pitch,F))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(F){void 0===F?F=!0:null===F&&(F=!1),this._renderWorldCopies=F}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const F=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(F))}get cameraWorldSize(){const F=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(F))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return F.bH(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new F.P(this.width,this.height)}get bearing(){return F.bF(this.rotation,-180,180)}set bearing(F){this.rotation=F}get rotation(){return-this.angle/Math.PI*180}set rotation(Ae){const Oe=-Ae*Math.PI/180;this.angle!==Oe&&(this._unmodified=!1,this.angle=Oe,this._calcMatrices(),this.rotationMatrix=F.ab.mat2.create(),F.ab.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(Ae){const Oe=F.aw(Ae,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==Oe&&(this._unmodified=!1,this._pitch=Oe,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const F=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/F)}set fov(Ae){Ae=Math.max(.01,Math.min(60,Ae)),this._fov!==Ae&&(this._unmodified=!1,this._fov=F.ai(Ae),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(F){this._averageElevation=F,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(F){const Ae=Math.min(Math.max(F,this.minZoom),this.maxZoom);this._zoom!==Ae&&(this._unmodified=!1,this._setZoom(Ae),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(F){this._zoom=F,this.scale=this.zoomScale(F),this.tileZoom=Math.floor(F),this.zoomFraction=F-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(F){this._tileCoverLift!==F&&(this._tileCoverLift=F)}_updateCameraOnTerrain(){const F=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,Ae=this.elevation&&F===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||F===Number.NEGATIVE_INFINITY&&(!Ae||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const Oe=this._elevation;Ae||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&Oe.exaggeration()&&this._centerAltitudeValidForExaggeration!==Oe.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*Oe.exaggeration(),this._centerAltitudeValidForExaggeration=Oe.exaggeration()):(this._centerAltitude=F||0,this._centerAltitudeValidForExaggeration=Oe.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const Ae=this._elevation,Oe=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],Fe=this.horizonLineFromTop();let Ve=0,qe=0;for(let pt=0;pt<Oe.length;pt++){const vt=new F.P(Oe[pt][0]*this.width,Fe+Oe[pt][1]*(this.height-Fe)),zt=Ae.pointCoordinate(vt);if(!zt)continue;const ri=1/Math.hypot(zt[0]-this._camera.position[0],zt[1]-this._camera.position[1]);Ve+=zt[3]*ri,qe+=ri}return 0===qe?NaN:Ve/qe}get center(){return this._center}set center(F){F.lat===this._center.lat&&F.lng===this._center.lng||(this._unmodified=!1,this._center=F,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const F=this._seaLevelZoom,Ae=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),Oe=this.pixelsPerMeter/this.worldSize*Ae,Fe=this._mercatorZfromZoom(F),Ve=this._mercatorZfromZoom(this._maxZoom),qe=Math.max(Fe-Oe,Ve);this._setZoom(this._zoomFromMercatorZ(qe))}get padding(){return this._edgeInsets.toJSON()}set padding(F){this._edgeInsets.equals(F)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,F,1),this._calcMatrices())}computeZoomRelativeTo(Ae){const Oe=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,Ae.toAltitude()));let Fe;Fe=Ae.z<this._camera.position[2]?[Oe.x,Oe.y,Oe.z]:[Ae.x,Ae.y,Ae.z];const Ve=F.ab.vec3.length(F.ab.vec3.sub([],this._camera.position,Fe));return F.aw(this._zoomFromMercatorZ(Ve),this._minZoom,this._maxZoom)}setFreeCameraOptions(Ae){if(!this.height)return;if(!Ae.position&&!Ae.orientation)return;this._updateCameraState();let Oe=!1;if(Ae.orientation&&!F.ab.quat.exactEquals(Ae.orientation,this._camera.orientation)&&(Oe=this._setCameraOrientation(Ae.orientation)),Ae.position){const Fe=[Ae.position.x,Ae.position.y,Ae.position.z];F.ab.vec3.exactEquals(Fe,this._camera.position)||(this._setCameraPosition(Fe),Oe=!0)}Oe&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const Ae=this._camera.position,Oe=new Wi;return Oe.position=new F.aa(Ae[0],Ae[1],Ae[2]),Oe.orientation=this._camera.orientation,Oe._elevation=this.elevation,Oe._renderWorldCopies=this.renderWorldCopies,Oe}_setCameraOrientation(Ae){if(!F.ab.quat.length(Ae))return!1;F.ab.quat.normalize(Ae,Ae);const Oe=F.ab.vec3.transformQuat([],[0,0,-1],Ae),Fe=F.ab.vec3.transformQuat([],[0,-1,0],Ae);if(Fe[2]<0)return!1;const Ve=Zi(Oe,Fe);return!!Ve&&(this._camera.orientation=Ve,!0)}_setCameraPosition(Ae){const Oe=this.zoomScale(this.minZoom)*this.tileSize,Fe=this.zoomScale(this.maxZoom)*this.tileSize,Ve=this.cameraToCenterDistance;Ae[2]=F.aw(Ae[2],Ve/Fe,Ve/Oe),this._camera.position=Ae}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(F){return this._edgeInsets.equals(F)}interpolatePadding(F,Ae,Oe){this._unmodified=!1,this._edgeInsets.interpolate(F,Ae,Oe),this._constrain(),this._calcMatrices()}coveringZoomLevel(F){const Ae=(F.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/F.tileSize));return Math.max(0,Ae)}getVisibleUnwrappedCoordinates(Ae){const Oe=[new F.bQ(0,Ae)];if(this.renderWorldCopies){const Fe=this.pointCoordinate(new F.P(0,0)),Ve=this.pointCoordinate(new F.P(this.width,0)),qe=this.pointCoordinate(new F.P(this.width,this.height)),pt=this.pointCoordinate(new F.P(0,this.height)),vt=Math.floor(Math.min(Fe.x,Ve.x,qe.x,pt.x)),zt=Math.floor(Math.max(Fe.x,Ve.x,qe.x,pt.x)),ri=1;for(let Fe=vt-ri;Fe<=zt+ri;Fe++)0!==Fe&&Oe.push(new F.bQ(Fe,Ae))}return Oe}isLODDisabled(F){return(!F||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(Ae,Oe,Fe){let Ve=[];const qe=void 0!==Fe,pt=!qe;if(pt&&this.zoom<Oe)return Ve;if(qe&&0===Fe[0]&&0===Fe[1])return Ve;const vt=new Set,l=(Ae,Oe,Fe,qe,pt)=>{const zt=F.c5(Oe,Ae,Fe,qe,pt);vt.has(zt)||(Ve.push(new F.aG(Ae,Oe,Fe,qe,pt)),vt.add(zt))};for(let F=0;F<Ae.length;F++){const Ve=Ae[F];if(pt&&Ve.canonical.z!==Oe)continue;const vt=Ve.canonical,zt=Ve.overscaledZ,ri=Ve.wrap,xi=1<<vt.z,bi=vt.x+1<xi,wi=vt.x>0,dr=vt.y+1<xi,jr=vt.y>0,Qr=Ve.wrap-(wi?0:1),Xn=Ve.wrap+(bi?0:1),ho=wi?vt.x-1:xi-1,yo=bi?vt.x+1:0;if(qe)Fe[0]<0?(l(zt,Xn,vt.z,yo,vt.y),Fe[1]<0&&dr&&(l(zt,ri,vt.z,vt.x,vt.y+1),l(zt,Xn,vt.z,yo,vt.y+1)),Fe[1]>0&&jr&&(l(zt,ri,vt.z,vt.x,vt.y-1),l(zt,Xn,vt.z,yo,vt.y-1))):Fe[0]>0?(l(zt,Qr,vt.z,ho,vt.y),Fe[1]<0&&dr&&(l(zt,ri,vt.z,vt.x,vt.y+1),l(zt,Qr,vt.z,ho,vt.y+1)),Fe[1]>0&&jr&&(l(zt,ri,vt.z,vt.x,vt.y-1),l(zt,Qr,vt.z,ho,vt.y-1))):Fe[1]<0&&dr?l(zt,ri,vt.z,vt.x,vt.y+1):jr&&l(zt,ri,vt.z,vt.x,vt.y-1);else{const F=Ve.visibleQuadrants;1&F&&(l(zt,Qr,vt.z,ho,vt.y),jr&&(l(zt,ri,vt.z,vt.x,vt.y-1),l(zt,Qr,vt.z,ho,vt.y-1))),2&F&&(l(zt,Xn,vt.z,yo,vt.y),jr&&(l(zt,ri,vt.z,vt.x,vt.y-1),l(zt,Xn,vt.z,yo,vt.y-1))),4&F&&(l(zt,Qr,vt.z,ho,vt.y),dr&&(l(zt,ri,vt.z,vt.x,vt.y+1),l(zt,Qr,vt.z,ho,vt.y+1))),8&F&&(l(zt,Xn,vt.z,yo,vt.y),dr&&(l(zt,ri,vt.z,vt.x,vt.y+1),l(zt,Xn,vt.z,yo,vt.y+1)))}}const zt=[];for(const F of Ve)Ve.some((Ae=>F.isChildOf(Ae)))||zt.push(F);if(Ve=zt.filter((F=>!Ae.some((Ae=>!!(F.overscaledZ<Oe&&Ae.isChildOf(F))||F.equals(Ae)||F.isChildOf(Ae))))),pt){const F=1<<Oe,Ae="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Fe=[F*Ae.x,F*Ae.y],qe=4,pt=qe*qe;Ve=Ve.filter((F=>{const Ae=F.canonical.x+.5-Fe[0],Oe=F.canonical.y+.5-Fe[1];return Ae*Ae+Oe*Oe<pt}))}return Ve}coveringTiles(Ae){let Oe=this.coveringZoomLevel(Ae);const Fe=Oe,Ve=this.elevation&&this.elevation.exaggeration(),qe=Ve&&!Ae.isTerrainDEM,pt="mercator"===this.projection.name;if(void 0!==Ae.minzoom&&Oe<Ae.minzoom)return[];void 0!==Ae.maxzoom&&Oe>Ae.maxzoom&&(Oe=Ae.maxzoom);const vt=this.locationCoordinate(this.center),zt=this.center.lat,ri=1<<Oe,xi=[ri*vt.x,ri*vt.y,0],bi="globe"===this.projection.name,wi=!bi,dr=F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,Oe,wi),jr=bi?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Qr=ri*F.bH(1,this.center.lat),Xn=this._camera.position[2]/F.bH(1,this.center.lat),ho=[ri*jr.x,ri*jr.y,Xn*(wi?1:Qr)],yo=bi||Ve,zo=this.cameraToCenterDistance/Ae.tileSize*(Ae.roundZoom?1:.502),ko=this.isLODDisabled(!0)?Oe:0;let Uo;if(this._elevation&&Ae.isTerrainDEM)Uo=1e4*this._elevation.exaggeration();else if(this._elevation){const F=this._elevation.getMinMaxForVisibleTiles();Uo=F?F.max:this._centerAltitude}else Uo=this._centerAltitude;const ia=Ae.isTerrainDEM?-Uo:this._elevation?this._elevation.getMinElevationBelowMSL():0,_a=this.projection.isReprojectedInTileSpace?F.bS(this):1,E=Ae=>{const Oe=1/4e4,Fe=new F.aa(Ae.x+Oe,Ae.y,Ae.z),Ve=new F.aa(Ae.x,Ae.y+Oe,Ae.z),qe=Ae.toLngLat(),pt=Fe.toLngLat(),vt=Ve.toLngLat(),zt=this.locationCoordinate(qe),ri=this.locationCoordinate(pt),xi=this.locationCoordinate(vt),bi=Math.hypot(ri.x-zt.x,ri.y-zt.y),wi=Math.hypot(xi.x-zt.x,xi.y-zt.y);return Math.sqrt(bi*wi)*_a/Oe},S=Ae=>{const Oe=Uo,Fe=ia;return{aabb:F.bV(this,ri,0,0,0,Ae,Fe,Oe,this.projection),zoom:0,x:0,y:0,minZ:Fe,maxZ:Oe,wrap:Ae,fullyVisible:!1}},Ma=[];let Ea=[];const Ia=Oe,rl=Ae.reparseOverscaled?Fe:Oe,Sl=(Xn-this._centerAltitude)*Qr,A=F=>{if(!this._elevation||!F.tileID||!pt)return;const Ae=this._elevation.getMinMaxForTile(F.tileID),Oe=F.aabb;Ae?(Oe.min[2]=Ae.min,Oe.max[2]=Ae.max,Oe.center[2]=(Oe.min[2]+Oe.max[2])/2):(F.shouldSplit=P(F),F.shouldSplit||(Oe.min[2]=Oe.max[2]=Oe.center[2]=this._centerAltitude))},z=(F,Ae)=>{if(.707*Ae<F)return 1;const Oe=Ae/F;return Oe/(1.4144271570014144+(Math.pow(1.1,Oe-1.4144271570014144+1)-1)/(1.1-1)-1)},P=Ae=>{if(Ae.zoom<ko)return!0;if(Ae.zoom===Ia)return!1;if(null!=Ae.shouldSplit)return Ae.shouldSplit;const Oe=Ae.aabb.distanceX(ho),Ve=Ae.aabb.distanceY(ho);let vt=Sl,ri=1;if(bi){vt=Ae.aabb.distanceZ(ho);const Oe=Math.pow(2,Ae.zoom),Fe=F.aS((Ae.y+1)/Oe),Ve=F.aS(Ae.y/Oe),qe=Math.min(Math.max(zt,Fe),Ve),pt=F.c9(qe)/F.c9(zt);if(ri=qe===zt?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,pt/this._mercatorScaleRatio),this.zoom<=F.c6&&Ae.zoom===Ia-1&&pt>=.9)return!0}else if(qe&&(vt=Ae.aabb.distanceZ(ho)*Qr),this.projection.isReprojectedInTileSpace&&Fe<=5){const Oe=Math.pow(2,Ae.zoom),Fe=E(new F.aa((Ae.x+.5)/Oe,(Ae.y+.5)/Oe));ri=Fe>.85?1:Fe}if(!pt){const F=Math.sqrt(Oe*Oe+Ve*Ve+vt*vt);let Fe=(1<<Ia-Ae.zoom)*zo*ri;return Fe*=z(Math.max(vt,Sl),F),F<Fe}let wi=Number.MAX_VALUE,dr=0;const jr=Ae.aabb.getCorners(),Xn=[];for(const Ae of jr){F.ab.vec3.sub(Xn,Ae,ho),bi||(qe?Xn[2]*=Qr:Xn[2]=Sl);const Oe=F.ab.vec3.dot(Xn,this._camera.forward());Oe<wi&&(wi=Oe,dr=Math.abs(Xn[2]))}let yo=(1<<Ia-Ae.zoom)*zo*ri;if(yo*=z(Math.max(dr,Sl),wi),wi<yo)return!0;const Uo=Ae.aabb.closestPoint(xi);return Uo[0]===xi[0]&&Uo[1]===xi[1]};if(this.renderWorldCopies)for(let F=1;F<=3;F++)Ma.push(S(-F)),Ma.push(S(F));for(Ma.push(S(0));Ma.length>0;){const Fe=Ma.pop(),Ve=Fe.x,vt=Fe.y;let zt=Fe.fullyVisible;const d=()=>"globe"===this.projection.name&&(0===Fe.y||Fe.y===(1<<Fe.zoom)-1);if(!zt){let Ae=yo?Fe.aabb.intersects(dr):Fe.aabb.intersectsFlat(dr);if(0===Ae&&d()){const Oe=new F.bT(Fe.zoom,Ve,vt);Ae=F.bU(this,ri,Oe,!0).intersects(dr)}if(0===Ae)continue;zt=2===Ae}if(Fe.zoom!==Ia&&P(Fe))for(let Ae=0;Ae<4;Ae++){const Oe=(Ve<<1)+Ae%2,xi=(vt<<1)+(Ae>>1),wi={aabb:pt?Fe.aabb.quadrant(Ae):F.bV(this,ri,Fe.zoom+1,Oe,xi,Fe.wrap,Fe.minZ,Fe.maxZ,this.projection),zoom:Fe.zoom+1,x:Oe,y:xi,wrap:Fe.wrap,fullyVisible:zt,tileID:void 0,shouldSplit:void 0,minZ:Fe.minZ,maxZ:Fe.maxZ};qe&&!bi&&(wi.tileID=new F.aG(Fe.zoom+1===Ia?rl:Fe.zoom+1,Fe.wrap,Fe.zoom+1,Oe,xi),A(wi)),Ma.push(wi)}else{const qe=Fe.zoom===Ia?rl:Fe.zoom;if(Ae.minzoom&&Ae.minzoom>qe)continue;let pt=0;if(!zt){let Oe=yo?Fe.aabb.intersectsPrecise(dr):Fe.aabb.intersectsPreciseFlat(dr);if(0===Oe&&d()){const Ae=new F.bT(Fe.zoom,Ve,vt);Oe=F.bU(this,ri,Ae,!0).intersectsPrecise(dr)}if(0===Oe)continue;if(Ae.calculateQuadrantVisibility)if(dr.containsPoint(Fe.aabb.center))pt=15;else for(let F=0;F<4;F++)0!==Fe.aabb.quadrant(F).intersects(dr)&&(pt|=1<<F)}const bi=xi[0]-(.5+Ve+(Fe.wrap<<Fe.zoom))*(1<<Oe-Fe.zoom),wi=xi[1]-.5-vt,jr=Fe.tileID?Fe.tileID:new F.aG(qe,Fe.wrap,Fe.zoom,Ve,vt);Ae.calculateQuadrantVisibility&&(jr.visibleQuadrants=pt),Ea.push({tileID:jr,distanceSq:bi*bi+wi*wi})}}if(this.fogCullDistSq){const Oe=this.fogCullDistSq,Fe=this.horizonLineFromTop();Ea=Ea.filter((Ve=>{const qe=[0,0,0,1],pt=[F.ag,F.ag,0,1],vt=this.calculateFogTileMatrix(Ve.tileID.toUnwrapped());F.ab.vec4.transformMat4(qe,qe,vt),F.ab.vec4.transformMat4(pt,pt,vt);const zt=F.ab.vec4.min([],qe,pt),ri=F.ab.vec4.max([],qe,pt),xi=F.bW(zt,ri);if(0===xi)return!0;let bi=!1;const wi=this._elevation;if(wi&&xi>Oe&&0!==Fe){const Oe=this.calculateProjMatrix(Ve.tileID.toUnwrapped());let qe;Ae.isTerrainDEM||(qe=wi.getMinMaxForTile(Ve.tileID)),qe||(qe={min:ia,max:Uo});const pt=F.c7(this.rotation),vt=[pt[0]*F.ag,pt[1]*F.ag,qe.max];F.ab.vec3.transformMat4(vt,vt,Oe),bi=(1-vt[1])*this.height*.5<Fe}return xi<Oe||bi}))}return Ea.sort(((F,Ae)=>F.distanceSq-Ae.distanceSq)).map((F=>F.tileID))}resize(F,Ae){this.width=F,this.height=Ae,this.pixelsToGLUnits=[2/F,-2/Ae],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(F){return Math.pow(2,F)}scaleZoom(F){return Math.log(F)/Math.LN2}project(Ae){const Oe=F.aw(Ae.lat,-F.bX,F.bX),Fe=this.projection.project(Ae.lng,Oe);return new F.P(Fe.x*this.worldSize,Fe.y*this.worldSize)}unproject(F){return this.projection.unproject(F.x/this.worldSize,F.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/F.bH(1,this.center.lat)/this.worldSize}setLocationAtPoint(Ae,Oe){let Fe,Ve;const qe=this.centerPoint;if("globe"===this.projection.name){const F=this.worldSize;Fe=(Oe.x-qe.x)/F,Ve=(Oe.y-qe.y)/F}else{const F=this.pointCoordinate(Oe),Ae=this.pointCoordinate(qe);Fe=F.x-Ae.x,Ve=F.y-Ae.y}const pt=this.locationCoordinate(Ae);this.setLocation(new F.aa(pt.x-Fe,pt.y-Ve))}setLocation(F){this.center=this.coordinateLocation(F),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(F){return this.projection.locationPoint(this,F)}locationPoint3D(F){return this.projection.locationPoint(this,F,!0)}pointLocation(F){return this.coordinateLocation(this.pointCoordinate(F))}pointLocation3D(F){return this.coordinateLocation(this.pointCoordinate3D(F))}locationCoordinate(Ae,Oe){const Fe=Oe?F.bH(Oe,Ae.lat):void 0,Ve=this.projection.project(Ae.lng,Ae.lat);return new F.aa(Ve.x,Ve.y,Fe)}coordinateLocation(F){return this.projection.unproject(F.x,F.y)}pointRayIntersection(Ae,Oe){const Fe=null!=Oe?Oe:this._centerAltitude,Ve=[Ae.x,Ae.y,0,1],qe=[Ae.x,Ae.y,1,1];F.ab.vec4.transformMat4(Ve,Ve,this.pixelMatrixInverse),F.ab.vec4.transformMat4(qe,qe,this.pixelMatrixInverse);const pt=qe[3];F.ab.vec4.scale(Ve,Ve,1/Ve[3]),F.ab.vec4.scale(qe,qe,1/pt);const vt=Ve[2],zt=qe[2];return{p0:Ve,p1:qe,t:vt===zt?0:(Fe-vt)/(zt-vt)}}screenPointToMercatorRay(Ae){const Oe=[Ae.x,Ae.y,0,1],Fe=[Ae.x,Ae.y,1,1];return F.ab.vec4.transformMat4(Oe,Oe,this.pixelMatrixInverse),F.ab.vec4.transformMat4(Fe,Fe,this.pixelMatrixInverse),F.ab.vec4.scale(Oe,Oe,1/Oe[3]),F.ab.vec4.scale(Fe,Fe,1/Fe[3]),Oe[2]=F.bH(Oe[2],this._center.lat)*this.worldSize,Fe[2]=F.bH(Fe[2],this._center.lat)*this.worldSize,F.ab.vec4.scale(Oe,Oe,1/this.worldSize),F.ab.vec4.scale(Fe,Fe,1/this.worldSize),new F.aq([Oe[0],Oe[1],Oe[2]],F.ab.vec3.normalize([],F.ab.vec3.sub([],Fe,Oe)))}rayIntersectionCoordinate(Ae){const{p0:Oe,p1:Fe,t:Ve}=Ae,qe=F.bH(Oe[2],this._center.lat),pt=F.bH(Fe[2],this._center.lat);return new F.aa(F.af(Oe[0],Fe[0],Ve)/this.worldSize,F.af(Oe[1],Fe[1],Ve)/this.worldSize,F.af(qe,pt,Ve))}pointCoordinate(F,Ae=this._centerAltitude){return this.projection.pointCoordinate(this,F.x,F.y,Ae)}pointCoordinate3D(Ae){if(!this.elevation)return this.pointCoordinate(Ae);let Oe=this.projection.pointCoordinate3D(this,Ae.x,Ae.y);if(Oe)return new F.aa(Oe[0],Oe[1],Oe[2]);let Fe=0,Ve=this.horizonLineFromTop();if(Ae.y>Ve)return this.pointCoordinate(Ae);const qe=.02*Ve,pt=Ae.clone();for(let Ae=0;Ae<10&&Ve-Fe>qe;Ae++){pt.y=F.af(Fe,Ve,.66);const Ae=this.projection.pointCoordinate3D(this,pt.x,pt.y);Ae?(Ve=pt.y,Oe=Ae):Fe=pt.y}return Oe?new F.aa(Oe[0],Oe[1],Oe[2]):this.pointCoordinate(Ae)}isPointAboveHorizon(F){return this.projection.isPointAboveHorizon(this,F)}isPointOnSurface(Ae){if(Ae.y<0||Ae.y>this.height||Ae.x<0||Ae.x>this.width)return!1;if(this.elevation||this.zoom>=F.bY)return!this.isPointAboveHorizon(Ae);const Oe=this.pointCoordinate(Ae);return Oe.y>=0&&Oe.y<=1}_coordinatePoint(Ae,Oe){const Fe=Oe&&this.elevation?this.elevation.getAtPointOrZero(Ae,this._centerAltitude):this._centerAltitude,Ve=[Ae.x*this.worldSize,Ae.y*this.worldSize,Fe+Ae.toAltitude(),1];return F.ab.vec4.transformMat4(Ve,Ve,this.pixelMatrix),Ve[3]>0?new F.P(Ve[0]/Ve[3],Ve[1]/Ve[3]):new F.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:Ae,left:Oe}=this._edgeInsets,Fe=this.height-this._edgeInsets.bottom,Ve=this.width-this._edgeInsets.right,qe=this.pointLocation3D(new F.P(Oe,Ae)),pt=this.pointLocation3D(new F.P(Ve,Ae)),vt=this.pointLocation3D(new F.P(Ve,Fe)),zt=this.pointLocation3D(new F.P(Oe,Fe));let ri=Math.min(qe.lng,pt.lng,vt.lng,zt.lng),xi=Math.max(qe.lng,pt.lng,vt.lng,zt.lng),bi=Math.min(qe.lat,pt.lat,vt.lat,zt.lat),wi=Math.max(qe.lat,pt.lat,vt.lat,zt.lat);const dr=Math.pow(2,-this.zoom)/16*270,jr="globe"===this.projection.name?1:4,f=(Ae,Oe,Fe,Ve,qe)=>{const pt=(Ae+Fe)/2,vt=(Oe+Ve)/2,zt=new F.P(pt,vt),{lng:Qr,lat:Xn}=this.pointLocation3D(zt),ho=Math.max(0,ri-Qr,bi-Xn,Qr-xi,Xn-wi);ri=Math.min(ri,Qr),xi=Math.max(xi,Qr),bi=Math.min(bi,Xn),wi=Math.max(wi,Xn),(qe<jr||ho>dr)&&(f(Ae,Oe,pt,vt,qe+1),f(pt,vt,Fe,Ve,qe+1))};if(f(Oe,Ae,Ve,Ae,1),f(Ve,Ae,Ve,Fe,1),f(Ve,Fe,Oe,Fe,1),f(Oe,Fe,Oe,Ae,1),"globe"===this.projection.name){const[Ae,Oe]=F.bZ(this);Ae?(wi=90,xi=180,ri=-180):Oe&&(bi=-90,xi=180,ri=-180)}return new F.az(new F.bO(ri,bi),new F.bO(xi,wi))}_getBoundsRectangular(Ae,Oe){const{top:Fe,left:Ve}=this._edgeInsets,qe=this.height-this._edgeInsets.bottom,pt=this.width-this._edgeInsets.right,vt=new F.P(Ve,Fe),zt=new F.P(pt,Fe),ri=new F.P(pt,qe),xi=new F.P(Ve,qe);let bi=this.pointCoordinate(vt,Ae),wi=this.pointCoordinate(zt,Ae);const dr=this.pointCoordinate(ri,Oe),jr=this.pointCoordinate(xi,Oe),f=(F,Ae)=>(Ae.y-F.y)/(Ae.x-F.x);return bi.y>1&&wi.y>=0?bi=new F.aa((1-jr.y)/f(jr,bi)+jr.x,1):bi.y<0&&wi.y<=1&&(bi=new F.aa(-jr.y/f(jr,bi)+jr.x,0)),wi.y>1&&bi.y>=0?wi=new F.aa((1-dr.y)/f(dr,wi)+dr.x,1):wi.y<0&&bi.y<=1&&(wi=new F.aa(-dr.y/f(dr,wi)+dr.x,0)),(new F.az).extend(this.coordinateLocation(bi)).extend(this.coordinateLocation(wi)).extend(this.coordinateLocation(jr)).extend(this.coordinateLocation(dr))}_getBoundsRectangularTerrain(){const F=this.elevation;if(!F.visibleDemTiles.length||F.isUsingMockSource())return this._getBoundsRectangular(0,0);const Ae=F.visibleDemTiles.reduce(((F,Ae)=>{if(Ae.dem){const Oe=Ae.dem.tree;F.min=Math.min(F.min,Oe.minimums[0]),F.max=Math.max(F.max,Oe.maximums[0])}return F}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(Ae.min*F.exaggeration(),Ae.max*F.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(F=!0){const Ae=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,Oe=this.height/2-Ae*(1-this._horizonShift);return F?Math.max(0,Oe):Oe}getMaxBounds(){return this.maxBounds}setMaxBounds(Ae){this.maxBounds=Ae,this.minLat=-F.bX,this.maxLat=F.bX,this.minLng=-180,this.maxLng=180,Ae&&(this.minLat=Ae.getSouth(),this.maxLat=Ae.getNorth(),this.minLng=Ae.getWest(),this.maxLng=Ae.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=F.at(this.minLng)*this.tileSize,this.worldMaxX=F.at(this.maxLng)*this.tileSize,this.worldMinY=F.aA(this.maxLat)*this.tileSize,this.worldMaxY=F.aA(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(F,Ae){return this.projection.createTileMatrix(this,Ae,F)}calculateDistanceTileData(Ae){const Oe=Ae.key,Fe=this._distanceTileDataCache;if(Fe[Oe])return Fe[Oe];const Ve=Ae.canonical,qe=1/this.height,pt=this.cameraWorldSize,vt=pt/this.zoomScale(Ve.z),zt=(Ve.x+Math.pow(2,Ve.z)*Ae.wrap)*vt,ri=Ve.y*vt,xi=this.point;xi.x*=pt/this.worldSize,xi.y*=pt/this.worldSize;const bi=this.angle,wi=Math.sin(-bi),dr=-Math.cos(-bi);return Fe[Oe]={bearing:[wi,dr],center:[(xi.x-zt)*qe,(xi.y-ri)*qe],scale:vt/F.ag*qe},Fe[Oe]}calculateFogTileMatrix(Ae){const Oe=Ae.key,Fe=this._fogTileMatrixCache;if(Fe[Oe])return Fe[Oe];const Ve=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,Ae);return F.ab.mat4.multiply(Ve,this.worldToFogMatrix,Ve),Fe[Oe]=new Float32Array(Ve),Fe[Oe]}calculateProjMatrix(Ae,Oe=!1,Fe=!1){const Ve=Ae.key;let qe;if(qe=Fe?this._expandedProjMatrixCache:Oe?this._alignedProjMatrixCache:this._projMatrixCache,qe[Ve])return qe[Ve];const pt=this.calculatePosMatrix(Ae,this.worldSize);let vt;return vt=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:Fe?this.expandedFarZProjMatrix:Oe?this.alignedProjMatrix:this.projMatrix,F.ab.mat4.multiply(pt,vt,pt),qe[Ve]=new Float32Array(pt),qe[Ve]}calculatePixelsToTileUnitsMatrix(Ae){const Oe=Ae.tileID.key,Fe=this._pixelsToTileUnitsCache;if(Fe[Oe])return Fe[Oe];const Ve=F.b_(Ae,this);return Fe[Oe]=Ve,Fe[Oe]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const Ae=1/this.worldSize,Oe=F.ab.mat4.fromScaling([],[Ae,Ae,Ae]);return F.ab.mat4.multiply(Oe,Oe,this.globeMatrix),Oe}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const Ae=this._elevation;this._updateCameraState();const Oe=F.bH(1,this._center.lat)*this.worldSize,Fe=this._computeCameraPosition(Oe),Ve=this._camera.forward(),qe=F.bH(1,this._center.lat);Fe[2]/=qe,Ve[2]/=qe,F.ab.vec3.normalize(Ve,Ve);const pt=Ae.raycast(Fe,Ve,Ae.exaggeration());if(pt){const Ae=F.ab.vec3.scaleAndAdd([],Fe,Ve,pt),Oe=new F.aa(Ae[0],Ae[1],F.bH(Ae[2],F.aS(Ae[1]))),vt=(Oe.z+F.ab.vec3.length([Oe.x-Fe[0],Oe.y-Fe[1],Oe.z-Fe[2]*qe]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(vt),this._centerAltitude=Oe.toAltitude(),this._center=this.coordinateLocation(Oe),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(Ae=!1){if(!this._elevation)return;const Oe=this._elevation,Fe=F.bH(1,this._center.lat)*this.worldSize,Ve=this._computeCameraPosition(Fe),qe=Oe.getAtPointOrZero(new F.aa(...Ve)),pt=this.pixelsPerMeter/this.worldSize*qe,vt=this._minimumHeightOverTerrain(),zt=Ve[2]-pt;if(zt<=vt)if(zt<0||Ae){const Ae=this.locationCoordinate(this._center,this._centerAltitude),Oe=[Ve[0],Ve[1],Ae.z-Ve[2]],Fe=F.ab.vec3.length(Oe);Oe[2]-=(vt-zt)/this._pixelsPerMercatorPixel;const qe=F.ab.vec3.length(Oe);if(0===qe)return;F.ab.vec3.scale(Oe,Oe,Fe/qe*this._pixelsPerMercatorPixel),this._camera.position=[Ve[0],Ve[1],Ae.z*this._pixelsPerMercatorPixel-Oe[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const Ae="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||Ae){const Oe=this.center;return Oe.lat=F.aw(Oe.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!Ae)&&(Oe.lng=F.aw(Oe.lng,this.minLng,this.maxLng)),this.center=Oe,void(this._constraining=!1)}const Oe=this._unmodified,{x:Fe,y:Ve}=this.point;let qe=0,pt=Fe,vt=Ve;const zt=this.width/2,ri=this.height/2,xi=this.worldMinY*this.scale,bi=this.worldMaxY*this.scale;if(Ve-ri<xi&&(vt=xi+ri),Ve+ri>bi&&(vt=bi-ri),bi-xi<this.height&&(qe=Math.max(qe,this.height/(bi-xi)),vt=(bi+xi)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const F=this.worldMinX*this.scale,Ae=this.worldMaxX*this.scale,Oe=this.worldSize/2-(F+Ae)/2;pt=(Fe+Oe+this.worldSize)%this.worldSize-Oe,pt-zt<F&&(pt=F+zt),pt+zt>Ae&&(pt=Ae-zt),Ae-F<this.width&&(qe=Math.max(qe,this.width/(Ae-F)),pt=(Ae+F)/2)}pt===Fe&&vt===Ve||(this.center=this.unproject(new F.P(pt,vt))),qe&&(this.zoom+=this.scaleZoom(qe)),this._constrainCamera(),this._unmodified=Oe,this._constraining=!1}_minZoomForBounds(){let F=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(F=Math.max(F,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),F}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const Ae=this.centerOffset,Oe="globe"===this.projection.name,Fe=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=F.bH(1,this.center.lat)/F.bH(1,F.c8));const Ve=F.b$(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,Ve),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const qe="meters"===this.projection.zAxisUnit?Fe:1,pt=this._camera.getWorldToCamera(this.worldSize,qe);let vt;const zt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(zt[8]=2*-Ae.x/this.width,zt[9]=2*Ae.y/this.height,this.isOrthographic){let F=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Oe=F*this.aspect,Fe=-Oe,Ve=-F;Oe-=Ae.x,Fe-=Ae.x,F+=Ae.y,Ve+=Ae.y,vt=this._camera.getCameraToClipOrthographic(Fe,Oe,Ve,F,this._nearZ,this._farZ),((F,Ae,Oe,Fe)=>{for(let Ve=0;Ve<16;Ve++)F[Ve]=Yi(Ae[Ve],Oe[Ve],Fe)})(vt,vt,zt,Ji(this.pitch>=15?1:this.pitch/15))}else vt=zt;const ri=F.ab.mat4.mul([],zt,pt);let xi=F.ab.mat4.mul([],vt,pt);if(this.projection.isReprojectedInTileSpace){const Ae=this.locationCoordinate(this.center),Oe=F.ab.mat4.identity([]);F.ab.mat4.translate(Oe,Oe,[Ae.x*this.worldSize,Ae.y*this.worldSize,0]),F.ab.mat4.multiply(Oe,Oe,F.c0(this)),F.ab.mat4.translate(Oe,Oe,[-Ae.x*this.worldSize,-Ae.y*this.worldSize,0]),F.ab.mat4.multiply(xi,xi,Oe),F.ab.mat4.multiply(ri,ri,Oe),this.inverseAdjustmentMatrix=F.c1(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=F.ab.mat4.scale([],xi,[this.worldSize,this.worldSize,this.worldSize/qe,1]),this.projMatrix=xi,this.invProjMatrix=F.ab.mat4.invert(new Float64Array(16),this.projMatrix),Oe){const Oe=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Oe[8]=2*-Ae.x/this.width,Oe[9]=2*Ae.y/this.height,this.expandedFarZProjMatrix=F.ab.mat4.mul([],Oe,pt)}else this.expandedFarZProjMatrix=this.projMatrix;const bi=F.ab.mat4.invert([],vt);this.frustumCorners=F.c2.fromInvProjectionMatrix(bi,this.horizonLineFromTop(),this.height),this.cameraFrustum=F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!Oe);const wi=new Float32Array(16);F.ab.mat4.identity(wi),F.ab.mat4.scale(wi,wi,[1,-1,1]),F.ab.mat4.rotateX(wi,wi,this._pitch),F.ab.mat4.rotateZ(wi,wi,this.angle);const dr=F.ab.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=F.ab.mat4.clone(dr);const jr=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;dr[8]=2*-Ae.x/this.width,dr[9]=2*(Ae.y+jr)/this.height,this.skyboxMatrix=F.ab.mat4.multiply(wi,dr,wi);const Qr=this.point,Xn=Qr.x,ho=Qr.y,yo=this.width%2/2,zo=this.height%2/2,ko=Math.cos(this.angle),Uo=Math.sin(this.angle),ia=Xn-Math.round(Xn)+ko*yo+Uo*zo,_a=ho-Math.round(ho)+ko*zo+Uo*yo,Ma=new Float64Array(xi);if(F.ab.mat4.translate(Ma,Ma,[ia>.5?ia-1:ia,_a>.5?_a-1:_a,0]),this.alignedProjMatrix=Ma,xi=F.ab.mat4.create(),F.ab.mat4.scale(xi,xi,[this.width/2,-this.height/2,1]),F.ab.mat4.translate(xi,xi,[1,-1,0]),this.labelPlaneMatrix=xi,xi=F.ab.mat4.create(),F.ab.mat4.scale(xi,xi,[1,-1,1]),F.ab.mat4.translate(xi,xi,[-1,-1,0]),F.ab.mat4.scale(xi,xi,[2/this.width,2/this.height,1]),this.glCoordMatrix=xi,this.pixelMatrix=F.ab.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,ri),this._calcFogMatrices(),this._distanceTileDataCache={},xi=F.ab.mat4.invert(new Float64Array(16),this.pixelMatrix),!xi)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=xi,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=F.c3(this);const Ae=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=F.ab.vec3.transformMat4(Ae,Ae,pt),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=xi;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const Ae=this.cameraWorldSizeForFog,Oe=this.cameraPixelsPerMeter,Fe=this._camera.position,Ve=1/this.height/this._pixelsPerMercatorPixel,qe=[Ae,Ae,Oe];F.ab.vec3.scale(qe,qe,Ve),F.ab.vec3.scale(Fe,Fe,-1),F.ab.vec3.multiply(Fe,Fe,qe);const pt=F.ab.mat4.create();F.ab.mat4.translate(pt,pt,Fe),F.ab.mat4.scale(pt,pt,qe),this.mercatorFogMatrix=pt,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(Ae,Oe,Ve)}_computeCameraPosition(F){const Ae=(F=F||this.pixelsPerMeter)/this.pixelsPerMeter,Oe=this._camera.forward(),Fe=this.point,Ve=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*Ae-F/this.worldSize*this._centerAltitude;return[Fe.x/this.worldSize-Oe[0]*Ve,Fe.y/this.worldSize-Oe[1]*Ve,F/this.worldSize*this._centerAltitude-Oe[2]*Ve]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(Ae){const Oe=this._maxCameraBoundsDistance()*Math.cos(this._pitch),Fe=this._camera.position[2],Ve=Ae[2];let qe=1;this.projection.wrap&&(this.center=this.center.wrap()),Ve>0&&(qe=Math.min((Oe-Fe)/Ve,1)),this._camera.position=F.ab.vec3.scaleAndAdd([],this._camera.position,Ae,qe),this._updateStateFromCamera()}_updateStateFromCamera(){const Ae=this._camera.position,Oe=this._camera.forward(),{pitch:Fe,bearing:Ve}=this._camera.getPitchBearing(),qe=F.bH(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,pt=this._mercatorZfromZoom(this._maxZoom)*Math.cos(F.ai(this._maxPitch)),vt=Math.max((Ae[2]-qe)/Math.cos(Fe),pt),zt=this._zoomFromMercatorZ(vt);F.ab.vec3.scaleAndAdd(Ae,Ae,Oe,vt),this._pitch=F.aw(Fe,F.ai(this.minPitch),F.ai(this.maxPitch)),this.angle=F.bF(Ve,-Math.PI,Math.PI),this._setZoom(F.aw(zt,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new F.aa(Ae[0],Ae[1],Ae[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(F){return Math.pow(2,F)*this.tileSize}_mercatorZfromZoom(F){return this.cameraToCenterDistance/this._worldSizeFromZoom(F)}_minimumHeightOverTerrain(){const F=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(F)}_zoomFromMercatorZ(F){return this.scaleZoom(this.cameraToCenterDistance/(F*this.tileSize))}zoomFromMercatorZAdjusted(Ae){let Oe=0,Fe=F.bY,Ve=0,qe=1/0;for(;Fe-Oe>1e-6&&Fe>Oe;){const F=Oe+.5*(Fe-Oe),pt=this.tileSize*Math.pow(2,F),vt=this.getCameraToCenterDistance(this.projection,F,pt),zt=this.scaleZoom(vt/(Ae*this.tileSize)),ri=Math.abs(F-zt);ri<qe&&(qe=ri,Ve=F),F<zt?Oe=F:Fe=F}return Ve}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(F.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(Ae,Oe){const Fe=Math.min(Ae.x,Oe.x),Ve=Math.max(Ae.x,Oe.x),qe=Math.min(Ae.y,Oe.y),pt=Math.max(Ae.y,Oe.y);if(qe<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const vt=[new F.P(Fe,qe),new F.P(Ve,pt),new F.P(Fe,pt),new F.P(Ve,qe)],zt=this.renderWorldCopies?-3:0,ri=this.renderWorldCopies?4:1;for(const F of vt){const Ae=this.pointRayIntersection(F);if(Ae.t<0)return!0;const Oe=this.rayIntersectionCoordinate(Ae);if(Oe.x<zt||Oe.y<0||Oe.x>ri||Oe.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+F.c4(this.fovAboveCenter)>88||this.anyCornerOffEdge(new F.P(0,0),new F.P(this.width,this.height))}zoomDeltaToMovement(Ae,Oe){const Fe=F.ab.vec3.length(F.ab.vec3.sub([],this._camera.position,Ae)),Ve=this._zoomFromMercatorZ(Fe)+Oe;return Fe-this._mercatorZfromZoom(Ve)}getCameraPoint(){if("globe"===this.projection.name){const Ae=function([Ae,Oe,Fe],Ve){const qe=[Ae,Oe,Fe,1];F.ab.vec4.transformMat4(qe,qe,Ve);const pt=qe[3]=Math.max(qe[3],1e-6);return qe[0]/=pt,qe[1]/=pt,qe[2]/=pt,qe}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new F.P(Ae[0],Ae[1])}{const Ae=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new F.P(0,Ae))}}getCameraToCenterDistance(Ae,Oe=this.zoom,Fe=this.worldSize){const Ve=F.b$(Ae,Oe,this.width,this.height,1024),qe=Ae.pixelSpaceConversion(this.center.lat,Fe,Ve);let pt=.5/Math.tan(.5*this._fov)*this.height*qe;return this.isOrthographic&&(pt=Yi(1,pt,Ji(this.pitch>=15?1:this.pitch/15))),pt}getWorldToCameraMatrix(){const Ae=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&F.ab.mat4.multiply(Ae,Ae,this.globeMatrix),Ae}getFrustum(Ae){return F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,Ae,"meters"===this.projection.zAxisUnit)}}const eo=(Ae,Oe)=>{if(Oe>0&&Ae.terrain&&F.w("Cutoff is currently disabled on terrain"),Oe<=0||Ae.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const Fe=Ae.transform,Ve=Math.max(Math.abs(Fe._zoom-(Ae.minCutoffZoom-1)),1),qe=Fe.isLODDisabled(!1)?F.ac(60,45,Fe.pitch):F.ac(30,15,Fe.pitch),pt=Fe._farZ-Fe._nearZ,vt=Oe*Fe.height,zt=((1-(ri=qe))*Fe.cameraToCenterDistance+ri*(Fe._farZ+vt))*Ve;var ri;return{shouldRenderCutoff:qe<1,uniformValues:{u_cutoff_params:[Fe._nearZ,Fe._farZ,(zt-Fe._nearZ)/pt,(zt-vt-Fe._nearZ)/pt]}}},Fh={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class io{constructor(F,Ae){this.aabb=F,this.lastCascade=Ae}}class oo{add(F,Ae){const Oe=this.receivers[F.key];void 0!==Oe?(Oe.aabb.min[0]=Math.min(Oe.aabb.min[0],Ae.min[0]),Oe.aabb.min[1]=Math.min(Oe.aabb.min[1],Ae.min[1]),Oe.aabb.min[2]=Math.min(Oe.aabb.min[2],Ae.min[2]),Oe.aabb.max[0]=Math.max(Oe.aabb.max[0],Ae.max[0]),Oe.aabb.max[1]=Math.max(Oe.aabb.max[1],Ae.max[1]),Oe.aabb.max[2]=Math.max(Oe.aabb.max[2],Ae.max[2])):this.receivers[F.key]=new io(Ae,null)}clear(){this.receivers={}}get(F){return this.receivers[F.key]}computeRequiredCascades(Ae,Oe,Fe){const Ve=F.cd.fromPoints(Ae.points);let qe=0;for(const Ae in this.receivers){const pt=this.receivers[Ae];if(!pt)continue;if(!Ve.intersectsAabb(pt.aabb))continue;pt.aabb.min=Ve.closestPoint(pt.aabb.min),pt.aabb.max=Ve.closestPoint(pt.aabb.max);const vt=pt.aabb.getCorners();for(let Ae=0;Ae<Fe.length;Ae++){let Ve=!0;for(const qe of vt){const pt=[qe[0]*Oe,qe[1]*Oe,qe[2]];if(F.ab.vec3.transformMat4(pt,pt,Fe[Ae].matrix),pt[0]<-1||pt[0]>1||pt[1]<-1||pt[1]>1){Ve=!1;break}}if(pt.lastCascade=Ae,qe=Math.max(qe,Ae),Ve)break}}return qe+1}}class so{constructor(F){this.painter=F,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new oo,this._depthMode=new Bi(F.context.gl.LEQUAL,Bi.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,F.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),F.tp.registerParameter(Fh,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),F.tp.registerParameter(Fh,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),F.tp.registerParameter(Fh,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),F.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const F of this._cascades)F.texture.destroy(),F.framebuffer.destroy();this._cascades=[]}updateShadowParameters(Ae,Oe){const Fe=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!Oe||!Oe.properties)return;const Ve=Oe.properties.get("shadow-intensity");if(!Oe.shadowsEnabled()||Ve<=0)return;if(this._shadowLayerCount=Fe.style.order.reduce(((F,Oe)=>{const Ve=Fe.style._mergedLayers[Oe];return F+(Ve.hasShadowPass()&&!Ve.isHidden(Ae.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled)return;const qe=Fe.context,pt=Fh.shadowMapResolution,vt=Fh.shadowMapResolution;if(0===this._cascades.length||Fh.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let Ae=0;Ae<Fh.cascadeCount;++Ae){const Ae=Fe._shadowMapDebug,Oe=qe.gl,Ve=qe.createFramebuffer(pt,vt,Ae,"texture"),zt=new F.T(qe,{width:pt,height:vt,data:null},Oe.DEPTH_COMPONENT16);if(Ve.depthAttachment.set(zt.texture),Ae){const Ae=new F.T(qe,{width:pt,height:vt,data:null},Oe.RGBA8);Ve.colorAttachment.set(Ae.texture)}this._cascades.push({framebuffer:Ve,texture:zt,matrix:[],far:0,boundingSphereRadius:0,frustum:new F.bR,scale:0})}}this.shadowDirection=ao(Oe);let zt=0;if(Ae.elevation){const F=Ae.elevation,Oe=[1e4,-1e4];F.visibleDemTiles.filter((F=>F.dem)).forEach((F=>{const Ae=F.dem.tree;Oe[0]=Math.min(Oe[0],Ae.minimums[0]),Oe[1]=Math.max(Oe[1],Ae.maximums[0])})),1e4!==Oe[0]&&(zt=(Oe[1]-Oe[0])*F.exaggeration())}const ri=1.5*Ae.cameraToCenterDistance,xi=3*ri,bi=new Float64Array(16);for(let Oe=0;Oe<this._cascades.length;++Oe){const Fe=this._cascades[Oe];let Ve=Ae.height/50,qe=1;1===Fh.cascadeCount?qe=xi:0===Oe?qe=ri:(Ve=ri,qe=xi);const[pt,vt]=lo(Ae,this.shadowDirection,Ve,qe,Fh.shadowMapResolution,zt);Fe.scale=Ae.scale,Fe.matrix=pt,Fe.boundingSphereRadius=vt,F.ab.mat4.invert(bi,Fe.matrix),Fe.frustum=F.bR.fromInvProjectionMatrix(bi,1,0,!0),Fe.far=qe}const wi=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[wi].far,this._cascades[wi].far],this._uniformValues.u_shadow_intensity=Ve,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Fh.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Fh.shadowMapResolution,this._uniformValues.u_shadowmap_0=Oh.ShadowMap0,this._uniformValues.u_shadowmap_1=Oh.ShadowMap0+1,this._groundShadowTiles=Fe.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const dr=Fe.transform.elevation;for(const F of this._groundShadowTiles){let Ae={min:0,max:0};if(dr){const Oe=dr.getMinMaxForTile(F);Oe&&(Ae=Oe)}this.addShadowReceiver(F.toUnwrapped(),Ae.min,Ae.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(F){this._enabled=F}drawShadowPass(Ae,Oe){if(!this.enabled)return;const Fe=this.painter,Ve=Fe.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(Fe.transform.getFrustum(0),Fe.transform.worldSize,this._cascades),Ve.viewport.set([0,0,Fh.shadowMapResolution,Fh.shadowMapResolution]);for(let qe=0;qe<this._numCascadesToRender;++qe){Fe.currentShadowCascade=qe,Ve.bindFramebuffer.set(this._cascades[qe].framebuffer.framebuffer),Ve.clear({color:F.aj.white,depth:1});for(const F of Ae.order){const Ve=Ae._mergedLayers[F];if(!Ve.hasShadowPass()||Ve.isHidden(Fe.transform.zoom))continue;const qe=Ae.getLayerSourceCache(Ve),pt=qe?Oe[qe.id]:void 0;("model"===Ve.type||pt&&pt.length)&&Fe.renderLayer(Fe,qe,Ve,pt)}}Fe.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const F=this.painter,Ae=F.style,Oe=F.context,Fe=Ae.directionalLight,Ve=Ae.ambientLight;if(!Fe||!Ve)return;const qe=[],pt=eo(F,F.longestCutoffRange);pt.shouldRenderCutoff&&qe.push("RENDER_CUTOFF"),qe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&qe.push("NORMAL_OFFSET");const vt=no(Ae,Fe,Ve),zt=new Bi(Oe.gl.LEQUAL,Bi.ReadOnly,F.depthRangeFor3D);for(const Ae of this._groundShadowTiles){const Fe=Ae.toUnwrapped(),Ve=F.isTileAffectedByFog(Ae),ri=F.getOrCreateProgram("groundShadow",{defines:qe,overrideFog:Ve});this.setupShadows(Fe,ri),F.uploadCommonUniforms(Oe,ri,Fe,null,pt);const xi={u_matrix:F.transform.calculateProjMatrix(Fe),u_ground_shadow_factor:vt};ri.draw(F,Oe.gl.TRIANGLES,zt,Ui.disabled,ki.multiply,Vi.disabled,xi,"ground_shadow",F.tileExtentBuffer,F.quadTriangleIndexBuffer,F.tileExtentSegments,{},F.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ki.unblended:ki.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(Ae){const Oe=this.painter.transform,Fe=Oe.calculatePosMatrix(Ae,Oe.worldSize);return F.ab.mat4.multiply(Fe,this._cascades[this.painter.currentShadowCascade].matrix,Fe),Float32Array.from(Fe)}calculateShadowPassMatrixFromMatrix(Ae){return F.ab.mat4.multiply(Ae,this._cascades[this.painter.currentShadowCascade].matrix,Ae),Float32Array.from(Ae)}setupShadows(Ae,Oe,Fe,Ve=0){if(!this.enabled)return;const qe=this.painter.transform,pt=this.painter.context,vt=pt.gl,zt=this._uniformValues,ri=new Float64Array(16),xi=qe.calculatePosMatrix(Ae,qe.worldSize);for(let Ae=0;Ae<this._cascades.length;Ae++)F.ab.mat4.multiply(ri,this._cascades[Ae].matrix,xi),zt[0===Ae?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(ri),pt.activeTexture.set(vt.TEXTURE0+Oh.ShadowMap0+Ae),this._cascades[Ae].texture.bind(vt.NEAREST,vt.CLAMP_TO_EDGE);if(this.useNormalOffset=!!Fe,this.useNormalOffset){const Oe=F.cc(Ae.canonical),pt=2/qe.tileSize*F.ag/Fh.shadowMapResolution,vt=pt*this._cascades[0].boundingSphereRadius,ri=pt*this._cascades[this._cascades.length-1].boundingSphereRadius,xi=("vector-tile"===Fe?1:3)/Math.pow(2,Ve-Ae.canonical.z-(1-qe.zoom+Math.floor(qe.zoom)));zt.u_shadow_normal_offset=[Oe,vt*xi,ri*xi],zt.u_shadow_bias=[6e-5,.0012,.012]}else zt.u_shadow_bias=[36e-5,.0012,.012];Oe.setShadowUniformValues(pt,zt)}setupShadowsFromMatrix(Ae,Oe,Fe=!1){if(!this.enabled)return;const Ve=this.painter.context,qe=Ve.gl,pt=this._uniformValues,vt=new Float64Array(16);for(let Oe=0;Oe<Fh.cascadeCount;Oe++)F.ab.mat4.multiply(vt,this._cascades[Oe].matrix,Ae),pt[0===Oe?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(vt),Ve.activeTexture.set(qe.TEXTURE0+Oh.ShadowMap0+Oe),this._cascades[Oe].texture.bind(qe.NEAREST,qe.CLAMP_TO_EDGE);if(this.useNormalOffset=Fe,Fe){const F=Fh.normalOffset;pt.u_shadow_normal_offset=[1,F,F],pt.u_shadow_bias=[6e-5,.0012,.012]}else pt.u_shadow_bias=[36e-5,.0012,.012];Oe.setShadowUniformValues(Ve,pt)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(Ae,Oe,Fe,Ve){if(Ve[2]>=0)return{};const qe=function(Ae,Oe,Fe){const Ve=Fe/(1<<Ae.canonical.z);return new F.cd([Ae.canonical.x*Ve+Ae.wrap*Fe,Ae.canonical.y*Ve+Ae.wrap*Fe,0],[(Ae.canonical.x+1)*Ve+Ae.wrap*Fe,(Ae.canonical.y+1)*Ve+Ae.wrap*Fe,Oe])}(Ae,Oe,Fe).getCorners(),pt=Oe/-Ve[2];Ve[0]<0?(F.ab.vec3.add(qe[0],qe[0],[Ve[0]*pt,0,0]),F.ab.vec3.add(qe[3],qe[3],[Ve[0]*pt,0,0])):Ve[0]>0&&(F.ab.vec3.add(qe[1],qe[1],[Ve[0]*pt,0,0]),F.ab.vec3.add(qe[2],qe[2],[Ve[0]*pt,0,0])),Ve[1]<0?(F.ab.vec3.add(qe[0],qe[0],[0,Ve[1]*pt,0]),F.ab.vec3.add(qe[1],qe[1],[0,Ve[1]*pt,0])):Ve[1]>0&&(F.ab.vec3.add(qe[2],qe[2],[0,Ve[1]*pt,0]),F.ab.vec3.add(qe[3],qe[3],[0,Ve[1]*pt,0]));const vt={};return vt.vertices=qe,vt.planes=[ro(qe[1],qe[0],qe[4]),ro(qe[2],qe[1],qe[5]),ro(qe[3],qe[2],qe[6]),ro(qe[0],qe[3],qe[7])],vt}addShadowReceiver(Ae,Oe,Fe){this._receivers.add(Ae,F.cd.fromTileIdAndHeight(Ae,Oe,Fe))}getMaxCascadeForTile(F){const Ae=this._receivers.get(F);return Ae&&Ae.lastCascade?Ae.lastCascade:0}}function ro(Ae,Oe,Fe){const Ve=F.ab.vec3.sub([],Fe,Oe),qe=F.ab.vec3.sub([],Ae,Oe),pt=F.ab.vec3.cross([],Ve,qe),vt=F.ab.vec3.length(pt);return 0===vt?[0,0,1,0]:(F.ab.vec3.scale(pt,pt,1/vt),[pt[0],pt[1],pt[2],-F.ab.vec3.dot(pt,Oe)])}function ao(Ae){const Oe=Ae.properties.get("direction"),Fe=F.cb(Oe.x,Oe.y,Oe.z);Fe[2]=F.aw(Fe[2],0,75);const Ve=F.ce([Fe[0],Fe[1],Fe[2]]);return F.ab.vec3.fromValues(Ve.x,Ve.y,Ve.z)}function no(Ae,Oe,Fe){const Ve="none"===Oe.properties.get("color-use-theme"),qe=Oe.properties.get("color"),pt=Oe.properties.get("intensity"),vt=Oe.properties.get("direction"),zt=[vt.x,vt.y,vt.z],ri="none"===Fe.properties.get("color-use-theme"),xi=Fe.properties.get("color"),bi=Fe.properties.get("intensity"),wi=Math.max(F.ab.vec3.dot([0,0,1],zt),0),dr=[0,0,0];F.ab.vec3.scale(dr,xi.toRenderColor(ri?null:Ae.getLut(Oe.scope)).toArray01Linear().slice(0,3),bi);const jr=[0,0,0];return F.ab.vec3.scale(jr,qe.toRenderColor(Ve?null:Ae.getLut(Fe.scope)).toArray01Linear().slice(0,3),wi*pt),F.cf([dr[0]>0?dr[0]/(dr[0]+jr[0]):0,dr[1]>0?dr[1]/(dr[1]+jr[1]):0,dr[2]>0?dr[2]/(dr[2]+jr[2]):0])}function lo(Ae,Oe,Fe,Ve,qe,pt){const vt=Ae.zoom,zt=Ae.scale,ri=Ae.worldSize,xi=1/ri,bi=Ae.aspect,wi=Math.sqrt(1+bi*bi)*Math.tan(.5*Ae.fovX),dr=wi*wi,jr=Ve-Fe,Qr=Ve+Fe;let Xn,ho;dr>jr/Qr?(Xn=Ve,ho=Ve*wi):(Xn=.5*Qr*(1+dr),ho=.5*Math.sqrt(jr*jr+2*(Ve*Ve+Fe*Fe)*dr+Qr*Qr*dr*dr));const yo=Ae.projection.pixelsPerMeter(Ae.center.lat,ri),zo=Ae._camera.getCameraToWorldMercator(),ko=[0,0,-Xn*xi];F.ab.vec3.transformMat4(ko,ko,zo);let Uo=ho*xi;const ia=Ae._edgeInsets;if(!(0===ia.left&&0===ia.top&&0===ia.right&&0===ia.bottom||ia.left===ia.right&&ia.top===ia.bottom)){const Oe=Ae._camera.getWorldToCamera(Ae.worldSize,"meters"===Ae.projection.zAxisUnit?yo:1),qe=Ae._camera.getCameraToClipPerspective(Ae._fov,Ae.width/Ae.height,Fe,Ve);qe[8]=2*-Ae.centerOffset.x/Ae.width,qe[9]=2*Ae.centerOffset.y/Ae.height;const pt=new Float64Array(16);F.ab.mat4.mul(pt,qe,Oe);const xi=new Float64Array(16);F.ab.mat4.invert(xi,pt);const bi=F.bR.fromInvProjectionMatrix(xi,ri,vt,!0);for(const Oe of bi.points){const Fe=((_a=Oe)[0]/=zt,_a[1]/=zt,_a[2]=F.bH(_a[2],Ae._center.lat),_a);Uo=Math.max(Uo,F.ab.vec3.len(F.ab.vec3.subtract([],ko,Fe)))}}var _a;Uo*=qe/(qe-1);const Ma=Math.acos(Oe[2]),Ea=Math.atan2(-Oe[0],-Oe[1]),Ia=new $i;Ia.position=ko,Ia.setPitchBearing(Ma,Ea);const rl=Ia.getWorldToCamera(ri,yo),Sl=Uo*ri,Il=Math.min(Ae._mercatorZfromZoom(17)*ri*-2,-2*Sl),Kl=Ia.getCameraToClipOrthographic(-Sl,Sl,-Sl,Sl,Il,(Sl+pt*yo)/Oe[2]),Jl=new Float64Array(16);F.ab.mat4.multiply(Jl,Kl,rl);const Ql=F.ab.vec3.fromValues(Math.floor(1e6*ko[0])/1e6*ri,Math.floor(1e6*ko[1])/1e6*ri,0),ec=.5*qe,tc=[0,0,0];F.ab.vec3.transformMat4(tc,Ql,Jl),F.ab.vec3.scale(tc,tc,ec);const cc=[Math.floor(tc[0]),Math.floor(tc[1]),Math.floor(tc[2])],uc=[0,0,0];F.ab.vec3.sub(uc,tc,cc),F.ab.vec3.scale(uc,uc,-1/ec);const jc=new Float64Array(16);return F.ab.mat4.identity(jc),F.ab.mat4.translate(jc,jc,uc),F.ab.mat4.multiply(Jl,jc,Jl),[Jl,Sl]}class co extends F.E{constructor(F){super(),this.requestManager=F,this.models={"":{}},this.modelUris={"":{}},this.numModelsLoading={}}loadModel(Ae,Oe){return F.aM(this.requestManager.transformRequest(Oe,F.R.Model).url).then((Oe=>{if(!Oe)return;const Fe=F.aN(Oe),Ve=new F.aO(Ae,void 0,void 0,Fe);return Ve.computeBoundsAndApplyParent(),Ve})).catch((Fe=>{if(Fe&&404===Fe.status)return null;this.fire(new F.y(new Error(`Could not load model ${Ae} from ${Oe}: ${Fe.message}`)))}))}load(Ae,Oe,Fe={keepNumReferences:!1}){this.models[Oe]||(this.models[Oe]={});const Ve=Object.keys(Ae);this.numModelsLoading[Oe]=(this.numModelsLoading[Oe]||0)+Ve.length;const qe=[];for(const F of Ve)qe.push(this.loadModel(F,Ae[F]));Promise.allSettled(qe).then((Ae=>{for(let F=0;F<Ae.length;F++){const{status:qe,value:pt}=Ae[F];if("fulfilled"===qe&&pt){const Ae=this.models[Oe][Ve[F]];this.models[Oe][Ve[F]]={model:pt,numReferences:Fe.keepNumReferences&&Ae?Ae.numReferences:1}}}this.numModelsLoading[Oe]-=Ve.length,this.fire(new F.z("data",{dataType:"style"}))})).catch((Ae=>{this.fire(new F.y(new Error(`Could not load models: ${Ae.message}`)))}))}isLoaded(){for(const F in this.numModelsLoading)if(this.numModelsLoading[F]>0)return!1;return!0}hasModel(F,Ae){return!!this.getModel(F,Ae)}getModel(F,Ae){return this.models[Ae]||(this.models[Ae]={}),this.models[Ae][F]?this.models[Ae][F].model:void 0}addModel(F,Ae,Oe){this.models[Oe]||(this.models[Oe]={}),this.modelUris[Oe]||(this.modelUris[Oe]={}),this.hasModel(F,Oe)&&this.models[Oe][F].numReferences++,this.modelUris[Oe][F]=this.requestManager.normalizeModelURL(Ae),this.load({[F]:this.modelUris[Oe][F]},Oe)}addModels(F,Ae){this.models[Ae]||(this.models[Ae]={}),this.modelUris[Ae]||(this.modelUris[Ae]={});const Oe=this.modelUris[Ae];for(const Fe in F)this.models[Ae][Fe]={},Oe[Fe]=this.requestManager.normalizeModelURL(F[Fe]);this.load(Oe,Ae,{keepNumReferences:!0})}reloadModels(F){this.load(this.modelUris[F],F)}addModelsFromBucket(F,Ae){this.models[Ae]||(this.models[Ae]={}),this.modelUris[Ae]||(this.modelUris[Ae]={});const Oe={};for(const Fe of F)this.hasModel(Fe,Ae)?this.models[Ae][Fe].numReferences++:(this.modelUris[Ae][Fe]=this.requestManager.normalizeModelURL(Fe),Oe[Fe]=this.modelUris[Ae][Fe]);this.load(Oe,Ae)}removeModel(F,Ae){if(this.models[Ae]&&this.models[Ae][F]&&(this.models[Ae][F].numReferences--,0===this.models[Ae][F].numReferences)){const Oe=this.models[Ae][F].model;delete this.models[Ae][F],delete this.modelUris[Ae][F],Oe.destroy()}}listModels(F){return this.models[F]||(this.models[F]={}),Object.keys(this.models[F])}upload(F,Ae){this.models[Ae]||(this.models[Ae]={});for(const Oe in this.models[Ae])this.models[Ae][Oe].model&&this.models[Ae][Oe].model.upload(F.context)}}const Vh=new F.a5({data:new F.a6(F.a3.colorTheme.data)}),Zh={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function _o(F){return F=F||{},Object.assign(F,Zh)}class po extends F.E{constructor(Ae){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},F.aP(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=Ae,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle((Ae=>{Ae.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new F.y(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=Ae.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=Ae.stylesheet.indoor.buildingFeaturesetId,this._scope=Ae.scope))})),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:F=>(F.feature&&F.feature.properties.floorplan&&this.selectFloorplan(F.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(Ae){if(!this._queryFeatureSetId)return;if(!this._map.isStyleLoaded())return;if(this._map.transform.zoom<13)return;this._indoorData&&!function(F,Ae){const[Oe,Fe]=F,{center:Ve,radius:qe}=Ae,[pt,vt]=Ve,zt=Math.abs(Oe-pt);return Math.sqrt((zt>180?360-zt:zt)**2+(Fe-vt)**2)<=qe}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new F.z("floorplangone")));const Oe={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},Fe=new F.P(this._map.transform.width/2,this._map.transform.height/2),Ve=[new F.P(0,0),new F.P(this._map.transform.width,this._map.transform.height)],qe=this._map.queryRenderedFeatures(Ae?Ve:Fe,Oe);qe.length>0&&(this._selectedFloorplan&&qe[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=qe[0],this._floorplanSelected(!1)))}_floorplanSelected(Ae){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(F){const[[Ae,Oe],[Fe,Ve]]=F,qe=(Fe-Ae+360)%360,pt=qe>180?360-qe:qe;return{center:[(Ae+pt/2+360)%360,(Oe+Ve)/2],radius:Math.sqrt(pt**2+(Ve-Oe)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});const Oe=this._floorplanStates[this._indoorData.id].selectedBuilding,Fe=this._floorplanStates[this._indoorData.id].selectedLevel;let Ve;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(const F of this._indoorData.levels)F.id===this._selectedLevel.id&&(Ve=F.id);if(this.fire(new F.z("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:Ve})),Oe){const F=this._indoorData.buildings.find((F=>F.id===Oe));this._buildingSelected(F,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(Fe){const F=this._indoorData.levels.find((F=>F.id===Fe));this._updateLevels(F,Ae)}else Ae&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(Ae,Oe){Oe&&Ae&&Ae.extent&&this._map.fitBounds(Ae.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=Ae?Ae.id:void 0;const Fe=this._indoorData.levels.filter((F=>Ae.levels.includes(F.id)));this.fire(new F.z("buildingselected",{buildingId:Ae.id,levels:Fe}))}_levelSelected(Ae){if("overview"===Ae)this._updateLevels(void 0,!0);else{const F=this._indoorData.levels.find((F=>F.id===Ae));this._updateLevels(F,!0)}this.fire(new F.z("levelselected",{levelId:"overview"===Ae?void 0:Ae}))}_updateLevels(F,Ae){if(!F)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(Ae&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function i(F){const Ae=F.indexOf("/floor/");if(-1===Ae)return F;const Oe=Ae+7,Fe=F.indexOf("/",Oe);return-1===Fe?F.slice(Oe):F.slice(Oe,Fe)}this._selectedLevel=F,this._floorplanStates[this._indoorData.id].selectedLevel=F?F.id:void 0;const Oe=[],Fe={},Ve={},qe={},pt={};for(const Ae of this._indoorData.levels)if(Oe.push(Ae.id),Fe[Ae.id]=Ae.height,Ve[Ae.id]=Ae.base,F){if(this.mergeFloors){const Oe=i(F.id),Fe=i(Ae.id);qe[Ae.id]=Fe===Oe?"true":"false"}else qe[Ae.id]=Ae.id===F.id?"true":"false";pt[Ae.id]=Ae.base<F.base?"true":"false"}else pt[Ae.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",Oe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",Fe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",Ve]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",qe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",pt]),F&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!F.isUnderground),Ae&&F.extent)){const Ae=this._map.cameraForBounds(F.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),Oe=this._map.getZoom(),Fe=Ae.zoom?Math.abs(Oe-Ae.zoom):0;this._map.fitBounds(F.extent,Fe>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:Oe})}}selectFloorplan(Ae){const Oe={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},Fe=[new F.P(0,0),new F.P(this._map.transform.width,this._map.transform.height)],Ve=this._map.queryRenderedFeatures(Fe,Oe);if(Ve.length>0)for(const F of Ve)if(JSON.parse(F.properties["indoor-data"]).floorplanIDs.includes(Ae)){this._selectedFloorplan=F,this._floorplanSelected(!0);break}}selectBuilding(F){const Ae=this._indoorData.buildings.find((Ae=>Ae.id===F));this._buildingSelected(Ae,!0)}selectLevel(F){this._levelSelected(F)}}function fo(Ae){if(!Ae.metadata||!Ae.metadata.content_area)return;const Oe=F.q.devicePixelRatio,{left:Fe,top:Ve,width:qe,height:pt}=Ae.metadata.content_area,vt=Fe*Oe,zt=Ve*Oe;return[vt,zt,vt+qe*Oe,zt+pt*Oe]}function mo(Ae){if(Ae)return Ae.map((([Ae,Oe])=>[Ae*F.q.devicePixelRatio,Oe*F.q.devicePixelRatio]))}const go=(F,Ae)=>Le(F,Ae&&Ae.filter((F=>"source.canvas"!==F.identifier))),eu=F.ay(eh,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport"]),tu=F.ay(eh,["setCenter","setZoom","setBearing","setPitch"]),ou=new Set(["background","sky","slot","custom"]),su={version:8,layers:[],sources:{}},lu={duration:300,delay:0};class To extends F.E{constructor(Ae,Oe={}){super(),this.map=Ae,this.scope=Oe.scope||"",this.globalId=null,this.fragments=[],this.importDepth=Oe.importDepth||0,this.importsCache=Oe.importsCache||new Map,this.resolvedImports=Oe.resolvedImports||new Set,this.transition=F.l({},lu),this._buildingIndex=new Dt(this),this.crossTileSymbolIndex=new Oi,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=Oe.styleChanges||new G,this.dispatcher=Oe.dispatcher?Oe.dispatcher:new F.D(F.ci(),this),Oe.imageManager?this.imageManager=Oe.imageManager:(this.imageManager=new q(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=Oe.glyphManager?Oe.glyphManager:new F.cj(Ae._requestManager,Oe.localFontFamily?F.ck.all:Oe.localIdeographFontFamily?F.ck.ideographs:F.ck.none,Oe.localFontFamily||Oe.localIdeographFontFamily),Oe.modelManager?this.modelManager=Oe.modelManager:(this.modelManager=new co(Ae._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=Oe.configOptions?Oe.configOptions:new Map,this._configDependentLayers=Oe.configDependentLayers?Oe.configDependentLayers:new Set,this._config=Oe.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:Oe.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=Oe.initialConfig,this.dispatcher.broadcast("setReferrer",F.cl());const Fe=this;this._rtlTextPluginCallback=To.registerForPluginStateChange((Ae=>{Fe.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:Ae.pluginStatus,pluginURL:Ae.pluginURL},((Ae,Oe)=>{if(F.cm(Ae),Oe&&Oe.every((F=>F)))for(const F in Fe._sourceCaches){const Ae=Fe._sourceCaches[F],Oe=Ae.getSource().type;"vector"!==Oe&&"geojson"!==Oe||Ae.reload()}}))})),this.on("data",(F=>{if("source"!==F.dataType||"metadata"!==F.sourceDataType)return;const Ae=this.getOwnSource(F.sourceId);if(Ae&&Ae.vectorLayerIds)for(const F in this._layers){const Oe=this._layers[F];Oe.source===Ae.id&&this._validateLayer(Oe)}}))}load(F){return F?("string"==typeof F?this.loadURL(F):this.loadJSON(F),this):this}_getGlobalId(Ae){if(!Ae)return null;if("string"==typeof Ae){if(F.f(Ae))return Ae;const Oe=F.cn(Ae);if(!Oe.startsWith("http"))try{return new URL(Oe,location.href).toString()}catch(F){return Oe}return Oe}return`json://${F.co(JSON.stringify(Ae))}`}_diffStyle(Ae,Oe,Fe){this.globalId=this._getGlobalId(Ae);const s=(F,Ae)=>{try{Ae(null,this.setState(F,Fe))}catch(F){Ae(F,!1)}};if("string"==typeof Ae){const Fe=this.map._requestManager.normalizeStyleURL(Ae),Ve=this.map._requestManager.transformRequest(Fe,F.R.Style);F.n(Ve,((Ae,Fe)=>{Ae?this.fire(new F.y(Ae)):Fe&&s(Fe,Oe)}))}else"object"==typeof Ae&&s(Ae,Oe)}loadURL(Ae,Oe={}){this.fire(new F.z("dataloading",{dataType:"style"}));const Fe="boolean"==typeof Oe.validate?Oe.validate:!F.f(Ae);this.globalId=this._getGlobalId(Ae),Ae=this.map._requestManager.normalizeStyleURL(Ae,Oe.accessToken),this.resolvedImports.add(Ae);const Ve=this.importsCache.get(Ae);if(Ve)return this._load(Ve,Fe);const qe=this.map._requestManager.transformRequest(Ae,F.R.Style);this._request=F.n(qe,((Oe,Ve)=>{if(this._request=null,Oe)this.fire(new F.y(Oe));else if(Ve)return this.importsCache.set(Ae,Ve),this._load(Ve,Fe)}))}loadJSON(Ae,Oe={}){this.fire(new F.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(Ae),this._request=F.q.frame((()=>{this._request=null,this._load(Ae,!1!==Oe.validate)}))}loadEmpty(){this.fire(new F.z("dataloading",{dataType:"style"})),this._load(su,!1)}_loadImports(Ae,Oe,Fe){if(this.importDepth>=4)return F.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const Ve=[];for(const F of Ae){const Ae=this._createFragmentStyle(F),qe=new Promise((F=>{Ae.once("style.import.load",F),Ae.once("error",F)})).then((()=>this.mergeAll()));if(Ve.push(qe),this.resolvedImports.has(F.url)){Ae.loadEmpty();continue}const pt=F.data||this.importsCache.get(F.url);pt?(Ae.loadJSON(pt,{validate:Oe}),this._isInternalStyle(pt)&&(Ae.globalId=null)):F.url?Ae.loadURL(F.url,{validate:Oe}):Ae.loadEmpty();const vt={style:Ae,id:F.id,config:F.config};if(Fe){const F=this.fragments.findIndex((({id:F})=>F===Fe));this.fragments=this.fragments.slice(0,F).concat(vt).concat(this.fragments.slice(F))}else this.fragments.push(vt)}return Promise.allSettled(Ve)}getImportGlobalIds(F=this,Ae=new Set){for(const Oe of F.fragments)Oe.style.globalId&&Ae.add(Oe.style.globalId),this.getImportGlobalIds(Oe.style,Ae);return[...Ae.values()]}_createFragmentStyle(Ae){const Oe=this.scope?F.aC(Ae.id,this.scope):Ae.id;let Fe;const Ve=this._initialConfig&&this._initialConfig[Oe];(Ae.config||Ve)&&(Fe=F.l({},Ae.config,Ve));const qe=new To(this.map,{scope:Oe,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:Fe,configOptions:this.options,colorThemeOverride:Ae["color-theme"],configDependentLayers:this._configDependentLayers});return qe.setEventedParent(this.map,{style:qe}),qe}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(F){return this.isRootStyle()&&(F.fragment||!!F.schema&&!1!==F.fragment)}_load(Ae,Oe){const Fe=Ae.indoor?_o(Ae.schema):Ae.schema;if(this._isInternalStyle(Ae)){const Fe=F.l({},su,{imports:[{id:"basemap",data:Ae,url:""}]});return void this._load(Fe,Oe)}if(this.updateConfig(this._config,Fe),Oe&&go(this,me(Ae)))return;this._loaded=!0,this.stylesheet=F.cp(Ae);const s=()=>{for(const F in Ae.sources)this.addSource(F,Ae.sources[F],{validate:!1,isInitialLoad:!0});Ae.sprite?this._loadIconset(Ae.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(Ae.glyphs,this.scope);const Fe=At(this.stylesheet.layers);if(this._order=Fe.map((F=>F.id)),this.stylesheet.light&&F.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const F=this.stylesheet.lights[0];this.light=new ze(F.properties,F.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new ze(this.stylesheet.light)),this._layers={};for(const Ae of Fe){const Oe=F.cu(Ae,this.scope,this._styleColorTheme.lut,this.options);0!==Oe.configDependencies.size&&this._configDependentLayers.add(Oe.fqid),Oe.setEventedParent(this,{layer:{id:Oe.id}}),this._layers[Oe.id]=Oe;const Fe=this.getOwnLayerSourceCache(Oe),Ve=!!this.directionalLight&&this.directionalLight.shadowsEnabled();Fe&&Oe.canCastShadows()&&Ve&&(Fe.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const Ve=this.stylesheet.terrain;Ve&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(Ve,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new F.z("data",{dataType:"style"}));const qe=this.isRootStyle();Ae.imports?this._loadImports(Ae.imports,Oe).then((()=>{this._reloadImports(),this.fire(new F.z(qe?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new F.z(qe?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const Ve=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(Ve){const Ae=this._evaluateColorThemeData(Ve);this._loadColorTheme(Ae).then((()=>{s()})).catch((Ae=>{F.w(`Couldn't load color theme from the stylesheet: ${Ae}`),s()}))}else this._styleColorTheme.lut=null,s()}isRootStyle(){return 0===this.importDepth}mergeAll(){let Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi;const bi={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((F=>{if(F.stylesheet){if(null!=F.light&&(Ae=F.light),F.stylesheet.lights)for(const Ae of F.stylesheet.lights)"ambient"===Ae.type&&null!=F.ambientLight&&(Oe=F.ambientLight),"directional"===Ae.type&&null!=F.directionalLight&&(Fe=F.directionalLight);Ve=this._prioritizeTerrain(Ve,F.terrain,F.stylesheet.terrain),F.stylesheet.fog&&null!=F.fog&&(qe=F.fog),F.stylesheet.snow&&null!=F.snow&&(pt=F.snow),F.stylesheet.rain&&null!=F.rain&&(vt=F.rain),null!=F.stylesheet.camera&&(xi=F.stylesheet.camera),null!=F.stylesheet.projection&&(zt=F.stylesheet.projection),null!=F.stylesheet.transition&&(ri=F.stylesheet.transition),bi[F.scope]=F._styleColorTheme}})),this.light=Ae,this.ambientLight=Oe,this.directionalLight=Fe,this.fog=qe,this.snow=pt,this.rain=vt,this._styleColorThemeForScope=bi,null===Ve?delete this.terrain:this.terrain=Ve,this.camera=xi||{"camera-projection":"perspective"},this.projection=zt||{name:"mercator"},this.transition=F.l({},lu,ri),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(F){const t=Ae=>{for(const F of Ae.fragments)t(F.style);F(Ae)};t(this)}_prioritizeTerrain(F,Ae,Oe){const Fe=F&&0===F.drapeRenderMode;return null===Oe?Ae&&0===Ae.drapeRenderMode?Ae:Fe?F:null:null!=Ae&&(!F||Fe||Ae&&1===Ae.drapeRenderMode)?Ae:F}mergeTerrain(){let F;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((Ae=>{F=this._prioritizeTerrain(F,Ae.terrain,Ae.stylesheet.terrain)})),null===F?delete this.terrain:this.terrain=F}mergeProjection(){let F;this.forEachFragmentStyle((Ae=>{null!=Ae.stylesheet.projection&&(F=Ae.stylesheet.projection)})),this.projection=F||{name:"mercator"}}mergeSources(){const Ae={},Oe={},Fe={};this.forEachFragmentStyle((Ve=>{for(const Oe in Ve._sourceCaches){const Fe=F.aC(Oe,Ve.scope);Ae[Fe]=Ve._sourceCaches[Oe]}for(const Ae in Ve._otherSourceCaches){const Fe=F.aC(Ae,Ve.scope);Oe[Fe]=Ve._otherSourceCaches[Ae]}for(const Ae in Ve._symbolSourceCaches){const Oe=F.aC(Ae,Ve.scope);Fe[Oe]=Ve._symbolSourceCaches[Ae]}})),this._mergedSourceCaches=Ae,this._mergedOtherSourceCaches=Oe,this._mergedSymbolSourceCaches=Fe}mergeLayers(){const Ae={},Oe=[],Fe={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((Fe=>{for(const Ve of Fe._order){const qe=Fe._layers[Ve];if("slot"===qe.type){const Oe=F.cq(Ve);if(Ae[Oe])continue;Ae[Oe]=[]}qe.slot&&Ae[qe.slot]?Ae[qe.slot].push(qe):Oe.push(qe)}})),this._mergedOrder=[];const s=(Oe=[])=>{for(const Ve of Oe)if("slot"===Ve.type){const Oe=F.cq(Ve.id);Ae[Oe]&&s(Ae[Oe]),this._mergedSlots.push(Oe)}else{const Ae=F.aC(Ve.id,Ve.scope);this._mergedOrder.push(Ae),Fe[Ae]=Ve,Ve.is3D()&&(this._has3DLayers=!0),"circle"===Ve.type&&(this._hasCircleLayers=!0),"symbol"===Ve.type&&(this._hasSymbolLayers=!0),"clip"===Ve.type&&(this._clipLayerPresent=!0)}};s(Oe),this._mergedOrder.sort(((F,Ae)=>{const Oe=Fe[F],Ve=Fe[Ae];return Oe.hasInitialOcclusionOpacityProperties?Ve.is3D()?1:0:Oe.is3D()&&Ve.hasInitialOcclusionOpacityProperties?-1:0})),this._mergedLayers=Fe,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(Ae){return this.stylesheet.camera=F.l({},this.stylesheet.camera,Ae),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(Ae){return Ae.data?function(Ae,Oe,Fe){const Ve=F.l({},Oe);for(const Ae of Object.keys(F.a3.colorTheme))void 0===Ve[Ae]&&(Ve[Ae]=F.a3.colorTheme[Ae].default);const qe=new F.a4(Vh,Ae,new Map(Fe));return qe.setTransitionOrValue(Ve,Fe),qe.untransitioned().possiblyEvaluate(new F.a8(0))}(this.scope,Ae,this.options).get("data"):null}_loadColorTheme(Ae){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const Oe=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((Fe,Ve)=>{const qe="data:image/png;base64,";if(!Ae||0===Ae.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void Fe();let pt=Ae;pt.startsWith(qe)||(pt=qe+pt);const vt="mapbox-reserved-lut",zt=new Image;zt.src=pt,zt.onerror=()=>{this._styleColorTheme.lutLoading=!1,Ve(new Error("Failed to load image data"))},zt.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==Oe)return void Fe();this._styleColorTheme.lutLoading=!1;const{width:qe,height:pt,data:ri}=F.q.getImageData(zt);if(pt>32)return void Ve(new Error("The height of the image must be less than or equal to 32 pixels."));if(qe!==pt*pt)return void Ve(new Error("The width of the image must be equal to the height squared."));this.getImage(vt)&&this.removeImage(vt),this.addImage(vt,{data:new F.r({width:qe,height:pt},ri),pixelRatio:1,sdf:!1,usvg:!1,version:0});const xi=this.imageManager.getImage(vt,this.scope);xi?(this._styleColorTheme.lut={image:xi.data,data:Ae},Fe()):Ve(new Error("Missing LUT image."))}}))}getLut(F){const Ae=this._styleColorThemeForScope[F];return Ae?Ae.lut:null}setProjection(F){F?this.stylesheet.projection=F:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(Ae){this._spriteRequest=function(Ae,Oe,Fe){let Ve,qe,pt;const vt=F.q.devicePixelRatio>1?"@2x":"";let zt=F.n(Oe.transformRequest(Oe.normalizeSpriteURL(Ae,vt,".json"),F.R.SpriteJSON),((F,Ae)=>{zt=null,pt||(pt=F,Ve=Ae,h())})),ri=F.o(Oe.transformRequest(Oe.normalizeSpriteURL(Ae,vt,".png"),F.R.SpriteImage),((F,Ae)=>{ri=null,pt||(pt=F,qe=Ae,h())}));function h(){if(pt)Fe(pt);else if(Ve&&qe){const Ae=F.q.getImageData(qe),Oe={};for(const Fe in Ve){const{width:qe,height:pt,x:vt,y:zt,sdf:ri,pixelRatio:xi,stretchX:bi,stretchY:wi,content:dr}=Ve[Fe],jr=new F.r({width:qe,height:pt});F.r.copy(Ae,jr,{x:vt,y:zt},{x:0,y:0},{width:qe,height:pt},null),Oe[Fe]={data:jr,pixelRatio:xi,sdf:ri,stretchX:bi,stretchY:wi,content:dr,usvg:!1}}Fe(null,Oe)}}return{cancel(){zt&&(zt.cancel(),zt=null),ri&&(ri.cancel(),ri=null)}}}(Ae,this.map._requestManager,((Ae,Oe)=>{if(this._spriteRequest=null,Ae)this.fire(new F.y(Ae));else if(Oe)for(const F in Oe)this.imageManager.addImage(F,this.scope,Oe[F]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new F.z("data",{dataType:"style"}))}))}_loadIconset(Ae){if(!F.f(Ae)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(Ae);const Oe="auto"===this.map._spriteFormat;var Fe,Ve;this._spriteRequest=(Ve=(Fe,Ve)=>{if(this._spriteRequest=null,Fe)Oe?this._loadSprite(Ae):this.fire(new F.y(Fe));else if(Ve)for(const F in Ve)this.imageManager.addImage(F,this.scope,Ve[F]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new F.z("data",{dataType:"style"}))},F.bi((Fe=this.map._requestManager).transformRequest(Fe.normalizeIconsetURL(Ae),F.R.Iconset),((Ae,Oe)=>{if(Ae)return void Ve(Ae);const Fe={},qe=F.cg(new F.bh(Oe));for(const Ae of qe.icons){const Oe={version:1,pixelRatio:F.q.devicePixelRatio,content:fo(Ae),stretchX:Ae.metadata?mo(Ae.metadata.stretch_x_areas):void 0,stretchY:Ae.metadata?mo(Ae.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:Ae};Fe[Ae.name]=Oe}Ve(null,Fe)})))}_validateLayer(Ae){const Oe=this.getOwnSource(Ae.source);if(!Oe)return;const Fe=Ae.sourceLayer;Fe&&("geojson"===Oe.type||Oe.vectorLayerIds&&-1===Oe.vectorLayerIds.indexOf(Fe))&&this.fire(new F.y(new Error(`Source layer "${Fe}" does not exist on source "${Oe.id}" as specified by style layer "${Ae.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const F in this._sourceCaches)if(!this._sourceCaches[F].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(!this.modelManager.isLoaded())return!1;if(this._styleColorTheme.lutLoading)return!1;for(const{style:F}of this.fragments)if(!F.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((F,Ae)=>{const Oe=this.fragments[Ae];return Oe&&Oe.style&&(F.data=Oe.style.serialize()),F}))}_serializeSources(){const F={};for(const Ae in this._sourceCaches){const Oe=this._sourceCaches[Ae].getSource();F[Oe.id]||(F[Oe.id]=Oe.serialize())}return F}_serializeLayers(F){const Ae=[];for(const Oe of F){const F=this._layers[Oe];F&&"custom"!==F.type&&Ae.push(F.serialize())}return Ae}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;if(this.hasSnowTransition())return!0;if(this.hasRainTransition())return!0;for(const F in this._sourceCaches)if(this._sourceCaches[F].hasTransition())return!0;for(const F in this._layers)if(this._layers[F].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(F){return F?this.order:this._mergedOrder}isLayerDraped(F){return!!this.terrain&&F.isDraped(this.getLayerSourceCache(F))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(Ae){const Oe=this.getOwnLayer(Ae);if(Oe)return Oe;this.fire(new F.y(new Error(`The layer '${Ae}' does not exist in the map's style.`)))}_checkSource(Ae){const Oe=this.getOwnSource(Ae);if(Oe)return Oe;this.fire(new F.y(new Error(`The source '${Ae}' does not exist in the map's style.`)))}precompilePrograms(F,Ae){const Oe=this.map.painter;if(Oe)for(let Fe=F.minzoom||0;Fe<(F.maxzoom||25.5);Fe++){const Fe=F.getProgramIds();if(Fe)for(const Ve of Fe){const Fe=F.getDefaultProgramParams(Ve,Ae.zoom,this._styleColorTheme.lut);Fe&&(Oe.style=this,this.fog&&(Oe._fogVisible=!0,Fe.overrideFog=!0,Oe.getOrCreateProgram(Ve,Fe)),Oe._fogVisible=!1,Fe.overrideFog=!1,Oe.getOrCreateProgram(Ve,Fe),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(Fe.overrideRtt=!0,Oe.getOrCreateProgram(Ve,Fe)))}}}update(Ae){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(Ae),this.directionalLight&&this.directionalLight.recalculate(Ae);const Oe=this.calculateLightsBrightness();Ae.brightness=Oe||0,Oe!==this._brightness&&(this._brightness=Oe,this.dispatcher.broadcast("setBrightness",Oe));const Fe=this._changes.isDirty();let Ve=!1;if(this._changes.isDirty()){const F=this._changes.getLayerUpdatesByScope();for(const Ae in F){const{updatedIds:Oe,removedIds:Fe}=F[Ae];(Oe||Fe)&&(this._updateWorkerLayers(Ae,Oe,Fe),Ve=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(Ae),this.light&&this.light.updateTransitions(Ae),this.ambientLight&&this.ambientLight.updateTransitions(Ae),this.directionalLight&&this.directionalLight.updateTransitions(Ae),this.fog&&this.fog.updateTransitions(Ae),this.snow&&this.snow.updateTransitions(Ae),this.rain&&this.rain.updateTransitions(Ae),this._changes.reset()}const qe={};for(const F in this._mergedSourceCaches){const Ae=this._mergedSourceCaches[F];qe[F]=Ae.used,Ae.used=!1,Ae.tileCoverLift=0}for(const F of this._mergedOrder){const Oe=this._mergedLayers[F];if(Oe.recalculate(Ae,this._availableImages),!Oe.isHidden(Ae.zoom)){const F=this.getLayerSourceCache(Oe);F&&(F.used=!0,F.tileCoverLift=Math.max(F.tileCoverLift,Oe.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(Oe,Ae)})):this.precompilePrograms(Oe,Ae))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&Ve&&this.mergeLayers();for(const Ae in qe){const Oe=this._mergedSourceCaches[Ae];qe[Ae]!==Oe.used&&Oe.getSource().fire(new F.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:Oe.getSource().id}))}this.light&&this.light.recalculate(Ae),this.terrain&&this.terrain.recalculate(Ae),this.fog&&this.fog.recalculate(Ae),this.snow&&this.snow.recalculate(Ae),this.rain&&this.rain.recalculate(Ae),this.z=Ae.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),Fe&&this.fire(new F.z("data",{dataType:"style"}))}_updateTilesForChangedImages(){const F=this._changes.getUpdatedImages();if(F.length){for(const Ae in this._sourceCaches)this._sourceCaches[Ae].reloadTilesForDependencies(["icons","patterns"],F);this._changes.resetUpdatedImages()}}_updateWorkerLayers(F,Ae,Oe){const Fe=this.getFragmentStyle(F);Fe&&this.dispatcher.broadcast("updateLayers",{layers:Ae?Fe._serializeLayers(Ae):[],scope:F,removedIds:Oe||[],options:Fe.options})}setState(Ae,Oe){if(this._checkLoaded(),go(this,me(Ae)))return!1;(Ae=F.cp(Ae)).layers=At(Ae.layers);const Fe=function(Ae,Oe){if(!Ae)return[{command:eh.setStyle,args:[Oe]}];let Fe=[];try{if(!F.bn(Ae.version,Oe.version))return[{command:eh.setStyle,args:[Oe]}];if(F.bn(Ae.center,Oe.center)||Fe.push({command:eh.setCenter,args:[Oe.center]}),F.bn(Ae.zoom,Oe.zoom)||Fe.push({command:eh.setZoom,args:[Oe.zoom]}),F.bn(Ae.bearing,Oe.bearing)||Fe.push({command:eh.setBearing,args:[Oe.bearing]}),F.bn(Ae.pitch,Oe.pitch)||Fe.push({command:eh.setPitch,args:[Oe.pitch]}),F.bn(Ae.sprite,Oe.sprite)||Fe.push({command:eh.setSprite,args:[Oe.sprite]}),F.bn(Ae.glyphs,Oe.glyphs)||Fe.push({command:eh.setGlyphs,args:[Oe.glyphs]}),F.bn(Ae.imports,Oe.imports)||function(Ae=[],Oe=[],Fe){Oe=Oe||[];const Ve=(Ae=Ae||[]).map(Bt),qe=Oe.map(Bt),pt=Ae.reduce(Nt,{}),vt=Oe.reduce(Nt,{}),zt=Ve.slice();let ri,xi,bi,wi;for(ri=0,xi=0;ri<Ve.length;ri++)bi=Ve[ri],vt.hasOwnProperty(bi)?xi++:(Fe.push({command:eh.removeImport,args:[bi]}),zt.splice(zt.indexOf(bi,xi),1));for(ri=0,xi=0;ri<qe.length;ri++)bi=qe[qe.length-1-ri],zt[zt.length-1-ri]!==bi&&(pt.hasOwnProperty(bi)?(Fe.push({command:eh.removeImport,args:[bi]}),zt.splice(zt.lastIndexOf(bi,zt.length-xi),1)):xi++,wi=zt[zt.length-ri],Fe.push({command:eh.addImport,args:[vt[bi],wi]}),zt.splice(zt.length-ri,0,bi));for(const Ae of Oe){const Oe=pt[Ae.id];Oe&&!F.bn(Oe,Ae)&&Fe.push({command:eh.updateImport,args:[Ae.id,Ae]})}}(Ae.imports,Oe.imports,Fe),F.bn(Ae.transition,Oe.transition)||Fe.push({command:eh.setTransition,args:[Oe.transition]}),F.bn(Ae.light,Oe.light)||Fe.push({command:eh.setLight,args:[Oe.light]}),F.bn(Ae.fog,Oe.fog)||Fe.push({command:eh.setFog,args:[Oe.fog]}),F.bn(Ae.snow,Oe.snow)||Fe.push({command:eh.setSnow,args:[Oe.snow]}),F.bn(Ae.rain,Oe.rain)||Fe.push({command:eh.setRain,args:[Oe.rain]}),F.bn(Ae.projection,Oe.projection)||Fe.push({command:eh.setProjection,args:[Oe.projection]}),F.bn(Ae.lights,Oe.lights)||Fe.push({command:eh.setLights,args:[Oe.lights]}),F.bn(Ae.camera,Oe.camera)||Fe.push({command:eh.setCamera,args:[Oe.camera]}),!F.bn(Ae["color-theme"],Oe["color-theme"]))return[{command:eh.setStyle,args:[Oe]}];const Ve={},qe=[];!function(Ae,Oe,Fe,Ve){let qe;for(qe in Oe=Oe||{},Ae=Ae||{})Ae.hasOwnProperty(qe)&&(Oe.hasOwnProperty(qe)||Mt(qe,Fe,Ve));for(qe in Oe){if(!Oe.hasOwnProperty(qe))continue;const pt=Oe[qe];Ae.hasOwnProperty(qe)?F.bn(Ae[qe],pt)||("geojson"===Ae[qe].type&&"geojson"===pt.type&&Ft(Ae,Oe,qe)?Fe.push({command:eh.setGeoJSONSourceData,args:[qe,pt.data]}):Ot(qe,Oe,Fe,Ve)):Pt(qe,Oe,Fe)}}(Ae.sources,Oe.sources,qe,Ve);const pt=[];Ae.layers&&Ae.layers.forEach((F=>{F.source&&Ve[F.source]?Fe.push({command:eh.removeLayer,args:[F.id]}):pt.push(F)}));let vt=Ae.terrain;vt&&Ve[vt.source]&&(Fe.push({command:eh.setTerrain,args:[void 0]}),vt=void 0),Fe=Fe.concat(qe),F.bn(vt,Oe.terrain)||Fe.push({command:eh.setTerrain,args:[Oe.terrain]}),function(Ae,Oe,Fe){Oe=Oe||[];const Ve=(Ae=Ae||[]).map(Bt),qe=Oe.map(Bt),pt=Ae.reduce(Nt,{}),vt=Oe.reduce(Nt,{}),zt=Ve.slice(),ri=Object.create(null);let xi,bi,wi,dr,jr,Qr,Xn;for(xi=0,bi=0;xi<Ve.length;xi++)wi=Ve[xi],vt.hasOwnProperty(wi)?bi++:(Fe.push({command:eh.removeLayer,args:[wi]}),zt.splice(zt.indexOf(wi,bi),1));for(xi=0,bi=0;xi<qe.length;xi++)wi=qe[qe.length-1-xi],zt[zt.length-1-xi]!==wi&&(pt.hasOwnProperty(wi)?(Fe.push({command:eh.removeLayer,args:[wi]}),zt.splice(zt.lastIndexOf(wi,zt.length-bi),1)):bi++,Qr=zt[zt.length-xi],Fe.push({command:eh.addLayer,args:[vt[wi],Qr]}),zt.splice(zt.length-xi,0,wi),ri[wi]=!0);for(xi=0;xi<qe.length;xi++)if(wi=qe[xi],dr=pt[wi],jr=vt[wi],!ri[wi]&&!F.bn(dr,jr))if(F.bn(dr.source,jr.source)&&F.bn(dr["source-layer"],jr["source-layer"])&&F.bn(dr.type,jr.type)){for(Xn in kt(dr.layout,jr.layout,Fe,wi,null,eh.setLayoutProperty),kt(dr.paint,jr.paint,Fe,wi,null,eh.setPaintProperty),F.bn(dr.slot,jr.slot)||Fe.push({command:eh.setSlot,args:[wi,jr.slot]}),F.bn(dr.filter,jr.filter)||Fe.push({command:eh.setFilter,args:[wi,jr.filter]}),F.bn(dr.minzoom,jr.minzoom)&&F.bn(dr.maxzoom,jr.maxzoom)||Fe.push({command:eh.setLayerZoomRange,args:[wi,jr.minzoom,jr.maxzoom]}),dr)dr.hasOwnProperty(Xn)&&"layout"!==Xn&&"paint"!==Xn&&"filter"!==Xn&&"metadata"!==Xn&&"minzoom"!==Xn&&"maxzoom"!==Xn&&"slot"!==Xn&&(0===Xn.indexOf("paint.")?kt(dr[Xn],jr[Xn],Fe,wi,Xn.slice(6),eh.setPaintProperty):F.bn(dr[Xn],jr[Xn])||Fe.push({command:eh.setLayerProperty,args:[wi,Xn,jr[Xn]]}));for(Xn in jr)jr.hasOwnProperty(Xn)&&!dr.hasOwnProperty(Xn)&&"layout"!==Xn&&"paint"!==Xn&&"filter"!==Xn&&"metadata"!==Xn&&"minzoom"!==Xn&&"maxzoom"!==Xn&&"slot"!==Xn&&(0===Xn.indexOf("paint.")?kt(dr[Xn],jr[Xn],Fe,wi,Xn.slice(6),eh.setPaintProperty):F.bn(dr[Xn],jr[Xn])||Fe.push({command:eh.setLayerProperty,args:[wi,Xn,jr[Xn]]}))}else Fe.push({command:eh.removeLayer,args:[wi]}),Qr=zt[zt.lastIndexOf(wi)+1],Fe.push({command:eh.addLayer,args:[jr,Qr]})}(pt,Oe.layers,Fe)}catch(F){console.warn("Unable to compute style diff:",F),Fe=[{command:eh.setStyle,args:[Oe]}]}return Fe}(this.serialize(),Ae).filter((F=>!(F.command in tu)));if(0===Fe.length)return!1;const Ve=Fe.filter((F=>!(F.command in eu)));if(Ve.length>0)throw new Error(`Unimplemented: ${Ve.map((F=>F.command)).join(", ")}.`);const qe=[];return Fe.forEach((F=>{qe.push(this[F.command].apply(this,F.args))})),Oe&&Promise.all(qe).then(Oe),this.stylesheet=Ae,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(Ae,Oe){return this.getImage(Ae)?this.fire(new F.y(new Error("An image with this name already exists."))):(this.imageManager.addImage(Ae,this.scope,Oe),this._afterImageUpdated(Ae),this)}updateImage(F,Ae,Oe=!1){this.imageManager.updateImage(F,this.scope,Ae),Oe&&this._afterImageUpdated(F)}getImage(F){return this.imageManager.getImage(F,this.scope)}removeImage(Ae){return this.getImage(Ae)?(this.imageManager.removeImage(Ae,this.scope),this._afterImageUpdated(Ae),this):this.fire(new F.y(new Error("No image with this name exists.")))}_afterImageUpdated(Ae){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(Ae),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new F.z("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(F,Ae,Oe={}){return this._checkLoaded(),this._validate(Re,`models.${F}`,Ae,null,Oe)||(this.modelManager.addModel(F,Ae,this.scope),this._changes.setDirty()),this}hasModel(F){return this.modelManager.hasModel(F,this.scope)}removeModel(Ae){return this.hasModel(Ae)?(this.modelManager.removeModel(Ae,this.scope),this):this.fire(new F.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(Ae,Oe,Fe={}){if(this._checkLoaded(),void 0!==this.getOwnSource(Ae))throw new Error(`There is already a source with ID "${Ae}".`);if(!Oe.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(Oe).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(Oe.type)>=0&&this._validate(ge,`sources.${Ae}`,Oe,null,Fe))return;this.map&&this.map._collectResourceTiming&&(Oe.collectResourceTiming=!0);const Ve=rt(Ae,Oe,this.dispatcher,this);Ve.scope=this.scope,Ve.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(Ve.id),source:Ve.serialize(),sourceId:Ve.id})));const r=Ae=>{const Oe=(Ae?"symbol:":"other:")+Ve.id,Fe=F.aC(Oe,this.scope),qe=this._sourceCaches[Oe]=new St(Fe,Ve,Ae);(Ae?this._symbolSourceCaches:this._otherSourceCaches)[Ve.id]=qe,qe.onAdd(this.map)};r(!1),"vector"!==Oe.type&&"geojson"!==Oe.type||r(!0),Ve.onAdd&&Ve.onAdd(this.map),Fe.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(Ae){this._checkLoaded();const Oe=this.getOwnSource(Ae);if(!Oe)throw new Error("There is no source with this ID");for(const Oe in this._layers)if(this._layers[Oe].source===Ae)return this.fire(new F.y(new Error(`Source "${Ae}" cannot be removed while layer "${Oe}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===Ae)return this.fire(new F.y(new Error(`Source "${Ae}" cannot be removed while terrain is using it.`)));const Fe=this.getOwnSourceCaches(Ae);for(const Ae of Fe){const Oe=F.cq(Ae.id);delete this._sourceCaches[Oe],this._changes.discardSourceCacheUpdate(Ae.id),Ae.fire(new F.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:Ae.getSource().id})),Ae.setEventedParent(null),Ae.clearTiles()}return delete this._otherSourceCaches[Ae],delete this._symbolSourceCaches[Ae],this.mergeSources(),Oe.setEventedParent(null),Oe.onRemove&&Oe.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(F,Ae){this._checkLoaded(),this.getOwnSource(F).setData(Ae),this._changes.setDirty()}getOwnSource(F){const Ae=this.getOwnSourceCache(F);return Ae&&Ae.getSource()}getOwnSources(){const F=[];for(const Ae in this._otherSourceCaches){const Oe=this.getOwnSourceCache(Ae);Oe&&F.push(Oe.getSource())}return F}areTilesLoaded(){const F=this._mergedSourceCaches;for(const Ae in F){const Oe=F[Ae]._tiles;for(const F in Oe){const Ae=Oe[F];if("loaded"!==Ae.state&&"errored"!==Ae.state)return!1}}return!0}setLights(Ae){if(this._checkLoaded(),!Ae)return delete this.ambientLight,void delete this.directionalLight;const Oe=this._getTransitionParameters();for(const Fe of Ae){if(this._validate(ye,"lights",Fe))return;switch(Fe.type){case"ambient":if(this.ambientLight){const F=this.ambientLight;F.set(Fe),F.updateTransitions(Oe)}else this.ambientLight=new $e(Fe,tc||(tc=new F.a5({color:new F.a6(F.a3.properties_light_ambient.color),"color-use-theme":new F.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new F.a6(F.a3.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const F=this.directionalLight;F.set(Fe),F.updateTransitions(Oe)}else this.directionalLight=new $e(Fe,cc||(cc=new F.a5({direction:new F.ak(F.a3.properties_light_directional.direction),color:new F.a6(F.a3.properties_light_directional.color),"color-use-theme":new F.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new F.a6(F.a3.properties_light_directional.intensity),"cast-shadows":new F.a6(F.a3.properties_light_directional["cast-shadows"]),"shadow-quality":new F.a6(F.a3.properties_light_directional["shadow-quality"]),"shadow-intensity":new F.a6(F.a3.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const Fe=new F.a8(this.z||0,Oe);this.ambientLight&&this.ambientLight.recalculate(Fe),this.directionalLight&&this.directionalLight.recalculate(Fe),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const Ae=this.directionalLight,Oe=this.ambientLight;if(!Ae||!Oe)return;const o=F=>.2126*(F[0]<=.03928?F[0]/12.92:Math.pow((F[0]+.055)/1.055,2.4))+.7152*(F[1]<=.03928?F[1]/12.92:Math.pow((F[1]+.055)/1.055,2.4))+.0722*(F[2]<=.03928?F[2]/12.92:Math.pow((F[2]+.055)/1.055,2.4)),Fe=Ae.properties.get("color").toRenderColor(null).toArray01(),Ve=Ae.properties.get("intensity"),qe=Ae.properties.get("direction"),pt=1-F.cb(qe.x,qe.y,qe.z)[2]/90,vt=o(Fe)*Ve*pt,zt=Oe.properties.get("color").toRenderColor(null).toArray01(),ri=Oe.properties.get("intensity"),xi=o(zt)*ri;return Number(((vt+xi)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const F=[];return this.directionalLight&&F.push(this.directionalLight.get()),this.ambientLight&&F.push(this.ambientLight.get()),F}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(Ae){if(!Ae)return this;if(F.cr(Ae)){const Oe=F.cs(Ae),Fe=this.fragments.find((({id:F})=>F===Oe));if(!Fe)throw new Error(`Style import '${Ae}' not found`);const Ve=F.cq(Ae);return Fe.style.getFragmentStyle(Ve)}{const F=this.fragments.find((({id:F})=>F===Ae));return F?F.style:void 0}}setFeaturesetSelectors(Ae){if(!Ae)return;const Oe={},o=(F,Ae="")=>`${F}::${Ae}`;this._featuresetSelectors={};for(const Fe in Ae){const Ve=this._featuresetSelectors[Fe]=[];for(const qe of Ae[Fe].selectors){if(qe.featureNamespace){const Ae=this.getOwnLayer(qe.layer);if(!Ae){F.w(`Layer is undefined for selector: ${qe.layer}`);continue}const Ve=o(Ae.source,Ae.sourceLayer);if(Ve in Oe&&Oe[Ve]!==qe.featureNamespace){F.w(`"featureNamespace ${qe.featureNamespace} of featureset ${Fe}'s selector is not associated to the same source, skip this selector`);continue}Oe[Ve]=qe.featureNamespace}let Ae;if(qe.properties)for(const Oe in qe.properties){const Fe=F.U(qe.properties[Oe]);"success"===Fe.result&&(Ae=Ae||{},Ae[Oe]=Fe.value)}Ve.push({layerId:qe.layer,namespace:qe.featureNamespace,properties:Ae,uniqueFeatureID:qe._uniqueFeatureID})}}}getFeaturesetDescriptors(F){const Ae=this.getFragmentStyle(F);if(!Ae||!Ae.stylesheet.featuresets)return[];const Oe=[];for(const F in Ae.stylesheet.featuresets)Oe.push({featuresetId:F,importId:Ae.scope?Ae.scope:void 0});return Oe}getFeaturesetLayers(Ae,Oe){const Fe=this.getFragmentStyle(Oe),Ve=Fe.stylesheet.featuresets;if(!Ve||!Ve[Ae])return this.fire(new F.y(new Error(`The featureset '${Ae}' does not exist in the map's style and cannot be queried.`))),[];const qe=[];for(const F of Ve[Ae].selectors){const Ae=Fe.getOwnLayer(F.layer);Ae&&qe.push(Ae)}return qe}getConfigProperty(Ae,Oe){const Fe=this.getFragmentStyle(Ae);if(!Fe)return null;const Ve=F.aC(Oe,Fe.scope),qe=Fe.options.get(Ve),pt=qe?qe.value||qe.default:null;return pt?pt.serialize():null}setConfigProperty(Ae,Oe,Fe){const Ve=this.getFragmentStyle(Ae);if(!Ve)return;const qe=Ve.stylesheet.indoor?_o(Ve.stylesheet.schema):Ve.stylesheet.schema;if(!qe||!qe[Oe])return;const pt=F.U(Fe);if("success"!==pt.result)return void go(this,pt.value);const vt=pt.value.expression,zt=F.aC(Oe,Ve.scope),ri=Ve.options.get(zt);if(!ri)return;let xi;const{minValue:bi,maxValue:wi,stepValue:dr,type:jr,values:Qr}=qe[Oe],Xn=F.U(qe[Oe].default);"success"===Xn.result&&(xi=Xn.value.expression),xi?(this.options.set(zt,Object.assign({},ri,{value:vt,default:xi,minValue:bi,maxValue:wi,stepValue:dr,type:jr,values:Qr})),this.updateConfigDependencies(Oe)):this.fire(new F.y(new Error(`No schema defined for the config option "${Oe}" in the "${Ae}" fragment.`)))}getConfig(Ae){const Oe=this.getFragmentStyle(Ae);if(!Oe)return null;const Fe=Oe.stylesheet.schema;if(!Fe)return null;const Ve={};for(const Ae in Fe){const Fe=F.aC(Ae,Oe.scope),qe=Oe.options.get(Fe),pt=qe?qe.value||qe.default:null;Ve[Ae]=pt?pt.serialize():null}return Ve}setConfig(F,Ae){const Oe=this.getFragmentStyle(F);Oe&&(Oe.updateConfig(Ae,Oe.stylesheet.schema),this.updateConfigDependencies())}getSchema(F){const Ae=this.getFragmentStyle(F);return Ae?Ae.stylesheet.schema:null}setSchema(F,Ae){const Oe=this.getFragmentStyle(F);Oe&&(Oe.stylesheet.schema=Ae,Oe.updateConfig(Oe._config,Ae),this.updateConfigDependencies())}updateConfig(Ae,Oe){if(this._config=Ae,Ae||Oe)if(Oe)for(const Fe in Oe){let Ve,qe;const pt=F.U(Oe[Fe].default);if("success"===pt.result&&(Ve=pt.value.expression),Ae&&void 0!==Ae[Fe]){const Oe=F.U(Ae[Fe]);"success"===Oe.result&&(qe=Oe.value.expression)}const{minValue:vt,maxValue:zt,stepValue:ri,type:xi,values:bi}=Oe[Fe];if(Ve){const Ae=F.aC(Fe,this.scope);this.options.set(Ae,{default:Ve,value:qe,minValue:vt,maxValue:zt,stepValue:ri,type:xi,values:bi})}else this.fire(new F.y(new Error(`No schema defined for config option "${Fe}".`)))}else this.fire(new F.y(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(F){for(const Ae of this._configDependentLayers){const Oe=this.getLayer(Ae);if(Oe){if(F&&!Oe.configDependencies.has(F))continue;Oe.possiblyEvaluateVisibility(),this._updateLayer(Oe)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((F=>{const Ae=F._styleColorTheme.colorThemeOverride?F._styleColorTheme.colorThemeOverride:F._styleColorTheme.colorTheme;if(Ae){const Oe=F._evaluateColorThemeData(Ae);(!F._styleColorTheme.lut&&""!==Oe||F._styleColorTheme.lut&&Oe!==F._styleColorTheme.lut.data)&&F.setColorTheme(Ae)}})),this._changes.setDirty()}addLayer(Ae,Oe,Fe={}){this._checkLoaded();const Ve=Ae.id;if(this._layers[Ve])return void this.fire(new F.y(new Error(`Layer with id "${Ve}" already exists on this map`)));let qe;if("custom"===Ae.type){if(go(this,F.ct(Ae)))return;qe=F.cu(Ae,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof Ae.source&&(this.addSource(Ve,Ae.source),Ae=F.cp(Ae),Ae=F.l(Ae,{source:Ve})),this._validate(Ee,`layers.${Ve}`,Ae,{arrayIndex:-1},Fe))return;qe=F.cu(Ae,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(qe),qe.setEventedParent(this,{layer:{id:Ve}})}0!==qe.configDependencies.size&&this._configDependentLayers.add(qe.fqid);let pt=this._order.length;if(Oe){const Ae=this._order.indexOf(Oe);if(-1===Ae)return void this.fire(new F.y(new Error(`Layer with id "${Oe}" does not exist on this map.`)));qe.slot===this._layers[Oe].slot?pt=Ae:F.w(`Layer with id "${Oe}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(pt,0,Ve),this._layerOrderChanged=!0,this._layers[Ve]=qe;const vt=this.getOwnLayerSourceCache(qe),zt=!!this.directionalLight&&this.directionalLight.shadowsEnabled();vt&&qe.canCastShadows()&&zt&&(vt.castsShadows=!0);const ri=this._changes.getRemovedLayer(qe);if(ri&&qe.source&&vt&&"custom"!==qe.type){this._changes.discardLayerRemoval(qe);const Ae=F.aC(qe.source,qe.scope);ri.type!==qe.type?this._changes.updateSourceCache(Ae,"clear"):(this._changes.updateSourceCache(Ae,"reload"),vt.pause())}this._updateLayer(qe),qe.onAdd&&qe.onAdd(this.map),qe.scope=this.scope,this.mergeLayers()}moveLayer(Ae,Oe){this._checkLoaded();const Fe=this._checkLayer(Ae);if(!Fe)return;if(Ae===Oe)return;const Ve=this._order.indexOf(Ae);this._order.splice(Ve,1);let qe=this._order.length;if(Oe){const Ae=this._order.indexOf(Oe);if(-1===Ae)return void this.fire(new F.y(new Error(`Layer with id "${Oe}" does not exist on this map.`)));Fe.slot===this._layers[Oe].slot?qe=Ae:F.w(`Layer with id "${Oe}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(qe,0,Ae),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(F){this._checkLoaded();const Ae=this._checkLayer(F);if(!Ae)return;Ae.setEventedParent(null);const Oe=this._order.indexOf(F);this._order.splice(Oe,1),delete this._layers[F],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(Ae.fqid),this._changes.removeLayer(Ae);const Fe=this.getOwnLayerSourceCache(Ae);if(Fe&&Fe.castsShadows){let F=!1;for(const Oe in this._layers)if(this._layers[Oe].source===Ae.source&&this._layers[Oe].canCastShadows()){F=!0;break}Fe.castsShadows=F}Ae.onRemove&&Ae.onRemove(this.map),this.mergeLayers()}getOwnLayer(F){return this._layers[F]}hasLayer(F){return F in this._mergedLayers}hasLayerType(F){for(const Ae in this._layers)if(this._layers[Ae].type===F)return!0;return!1}setLayerZoomRange(F,Ae,Oe){this._checkLoaded();const Fe=this._checkLayer(F);Fe&&(Fe.minzoom===Ae&&Fe.maxzoom===Oe||(null!=Ae&&(Fe.minzoom=Ae),null!=Oe&&(Fe.maxzoom=Oe),this._updateLayer(Fe)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(F,Ae){this._checkLoaded();const Oe=this._checkLayer(F);Oe&&Oe.slot!==Ae&&(Oe.slot=Ae,this._updateLayer(Oe))}setFilter(Ae,Oe,Fe={}){this._checkLoaded();const Ve=this._checkLayer(Ae);if(Ve&&!F.bn(Ve.filter,Oe))return null==Oe?(Ve.filter=void 0,void this._updateLayer(Ve)):void(this._validate(Se,`layers.${Ve.id}.filter`,Oe,{layerType:Ve.type},Fe)||(Ve.filter=F.cp(Oe),this._updateLayer(Ve)))}getFilter(Ae){const Oe=this._checkLayer(Ae);if(Oe)return F.cp(Oe.filter)}setLayoutProperty(Ae,Oe,Fe,Ve={}){this._checkLoaded();const qe=this._checkLayer(Ae);if(qe&&!F.bn(qe.getLayoutProperty(Oe),Fe)){if(null!=Fe&&(!Ve||!1!==Ve.validate)&&go(qe,Ie.call(me,{key:`layers.${Ae}.layout.${Oe}`,layerType:qe.type,objectKey:Oe,value:Fe,styleSpec:F.a3,style:{glyphs:!0,sprite:!0}})))return;qe.setLayoutProperty(Oe,Fe),0!==qe.configDependencies.size&&this._configDependentLayers.add(qe.fqid),this._updateLayer(qe)}}getLayoutProperty(F,Ae){const Oe=this._checkLayer(F);if(Oe)return Oe.getLayoutProperty(Ae)}setPaintProperty(Ae,Oe,Fe,Ve={}){this._checkLoaded();const qe=this._checkLayer(Ae);if(!qe)return;if(F.bn(qe.getPaintProperty(Oe),Fe))return;if(null!=Fe&&(!Ve||!1!==Ve.validate)&&go(qe,Ce.call(me,{key:`layers.${Ae}.paint.${Oe}`,layerType:qe.type,objectKey:Oe,value:Fe,styleSpec:F.a3})))return;const pt=qe.setPaintProperty(Oe,Fe);0!==qe.configDependencies.size&&this._configDependentLayers.add(qe.fqid),pt&&this._updateLayer(qe),this._changes.updatePaintProperties(qe)}getPaintProperty(F,Ae){const Oe=this._checkLayer(F);if(Oe)return Oe.getPaintProperty(Ae)}setFeatureState(Ae,Oe){if(this._checkLoaded(),"target"in Ae){if("featuresetId"in Ae.target){const{featuresetId:F,importId:Fe}=Ae.target,Ve=this.getFragmentStyle(Fe),qe=Ve.getFeaturesetLayers(F);for(const{source:F,sourceLayer:Fe}of qe)Ve.setFeatureState({id:Ae.id,source:F,sourceLayer:Fe},Oe)}else if("layerId"in Ae.target){const{layerId:F}=Ae.target,Fe=this.getLayer(F);this.setFeatureState({id:Ae.id,source:Fe.source,sourceLayer:Fe.sourceLayer},Oe)}return}const Fe=Ae.source,Ve=Ae.sourceLayer,qe=this._checkSource(Fe);if(!qe)return;const pt=qe.type;if("geojson"===pt&&Ve)return void this.fire(new F.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===pt&&!Ve)return void this.fire(new F.y(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===Ae.id&&this.fire(new F.y(new Error("The feature id parameter must be provided.")));const vt=this.getOwnSourceCaches(Fe);for(const F of vt)F.setFeatureState(Ve,Ae.id,Oe)}removeFeatureState(Ae,Oe){if(this._checkLoaded(),"target"in Ae){if("featuresetId"in Ae.target){const{featuresetId:F,importId:Fe}=Ae.target,Ve=this.getFragmentStyle(Fe),qe=Ve.getFeaturesetLayers(F);for(const{source:F,sourceLayer:Fe}of qe)Ve.removeFeatureState({id:Ae.id,source:F,sourceLayer:Fe},Oe)}else if("layerId"in Ae.target){const{layerId:F}=Ae.target,Fe=this.getLayer(F);this.removeFeatureState({id:Ae.id,source:Fe.source,sourceLayer:Fe.sourceLayer},Oe)}return}const Fe=Ae.source,Ve=this._checkSource(Fe);if(!Ve)return;const qe=Ve.type,pt="vector"===qe?Ae.sourceLayer:void 0;if("vector"===qe&&!pt)return void this.fire(new F.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(Oe&&"string"!=typeof Ae.id&&"number"!=typeof Ae.id)return void this.fire(new F.y(new Error("A feature id is required to remove its specific state property.")));const vt=this.getOwnSourceCaches(Fe);for(const F of vt)F.removeFeatureState(pt,Ae.id,Oe)}getFeatureState(Ae){if(this._checkLoaded(),"target"in Ae){let Oe;if("featuresetId"in Ae.target){const{featuresetId:Fe,importId:Ve}=Ae.target,qe=this.getFragmentStyle(Ve),pt=qe.getFeaturesetLayers(Fe);for(const{source:Fe,sourceLayer:Ve}of pt){const pt=qe.getFeatureState({id:Ae.id,source:Fe,sourceLayer:Ve});if(pt&&!Oe)Oe=pt;else if(!F.bn(Oe,pt))return void this.fire(new F.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in Ae.target){const{layerId:F}=Ae.target,Fe=this.getLayer(F);Oe=this.getFeatureState({id:Ae.id,source:Fe.source,sourceLayer:Fe.sourceLayer})}return Oe}const Oe=Ae.source,Fe=Ae.sourceLayer,Ve=this._checkSource(Oe);if(Ve){if("vector"!==Ve.type||Fe)return void 0===Ae.id&&this.fire(new F.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(Oe)[0].getFeatureState(Fe,Ae.id);this.fire(new F.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(Ae){return this.stylesheet.transition=F.l({},this.stylesheet.transition,Ae),this.transition=this.stylesheet.transition,this}getTransition(){return F.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();const Ae=this.getTerrain(),Oe=Ae&&this.terrain&&this.terrain.scope===this.scope?Ae:this.stylesheet.terrain;return F.cv({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:Oe,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(F=>void 0!==F))}_updateFilteredLayers(F){for(const Ae of Object.values(this._mergedLayers))F(Ae)&&this._updateLayer(Ae)}_updateLayer(Ae){this._changes.updateLayer(Ae);const Oe=this.getLayerSourceCache(Ae),Fe=F.aC(Ae.source,Ae.scope),Ve=this._changes.getUpdatedSourceCaches();Ae.source&&!Ve[Fe]&&Oe&&"raster"!==Oe.getSource().type&&(this._changes.updateSourceCache(Fe,"reload"),Oe.pause()),Ae.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(F){const t=F=>this._mergedLayers[F].is3D(),Ae=this.order,Oe={},Fe=[];for(let Ve=Ae.length-1;Ve>=0;Ve--){const qe=Ae[Ve];if(t(qe)){Oe[qe]=Ve;for(const Ae of F){const F=Ae[qe];if(F)for(const Ae of F)Fe.push(Ae)}}}Fe.sort(((F,Ae)=>Ae.intersectionZ-F.intersectionZ));const Ve=[];for(let qe=Ae.length-1;qe>=0;qe--){const pt=Ae[qe];if(t(pt))for(let F=Fe.length-1;F>=0;F--){const Ae=Fe[F].feature;if(Ae.layer&&Oe[Ae.layer.id]<qe)break;Ve.push(Ae),Fe.pop()}else for(const Ae of F){const F=Ae[pt];if(F)for(const Ae of F)Ve.push(Ae.feature)}}return Ve}queryRenderedFeatures(Ae,Oe,Fe){let Ve;Oe&&!Array.isArray(Oe)&&Oe.filter&&(this._validate(Se,"queryRenderedFeatures.filter",Oe.filter,null,Oe),Ve=F.aZ(Oe.filter));const qe={},a=F=>{if(ou.has(F.type))return;const Ae=this.getOwnLayerSourceCache(F),Oe=qe[Ae.id]=qe[Ae.id]||{sourceCache:Ae,layers:{},has3DLayers:!1};F.is3D()&&(Oe.has3DLayers=!0),Oe.layers[F.fqid]=Oe.layers[F.fqid]||{styleLayer:F,targets:[]},Oe.layers[F.fqid].targets.push({filter:Ve})};if(Oe&&Oe.layers){if(!Array.isArray(Oe.layers))return this.fire(new F.y(new Error("parameters.layers must be an Array."))),[];for(const Ae of Oe.layers){const Oe=this._layers[Ae];if(!Oe)return this.fire(new F.y(new Error(`The layer '${Ae}' does not exist in the map's style and cannot be queried for features.`))),[];a(Oe)}}else for(const F in this._layers)a(this._layers[F]);const pt=this._queryRenderedFeatures(Ae,qe,Fe),vt=this._flattenAndSortRenderedFeatures(pt),zt=[];for(const Ae of vt)F.cs(Ae.layer.id)===this.scope&&zt.push(Ae);return zt}queryRenderedFeatureset(Ae,Oe,Fe){let Ve;Oe&&!Array.isArray(Oe)&&Oe.filter&&(this._validate(Se,"queryRenderedFeatures.filter",Oe.filter,null,Oe),Ve=F.aZ(Oe.filter));const qe="mock",pt=[];if(Oe&&Oe.target)pt.push(Object.assign({},Oe,{targetId:qe,filter:Ve}));else{const F=this.getFeaturesetDescriptors();for(const Ae of F)pt.push({targetId:qe,filter:Ve,target:Ae});for(const{style:F}of this.fragments){const Ae=F.getFeaturesetDescriptors();for(const F of Ae)pt.push({targetId:qe,filter:Ve,target:F})}}const vt=this.queryRenderedTargets(Ae,pt,Fe),zt=[],ri=new Set;for(const Ae of vt)for(const Oe of Ae.variants[qe])nt(Oe,Ae,ri)||zt.push(new F.cw(Ae,Oe));return zt}queryRenderedTargets(Ae,Oe,Fe){const Ve={},r=(F,Ae,Oe,Fe)=>{const qe=Ve[Ae.id]=Ve[Ae.id]||{sourceCache:Ae,layers:{},has3DLayers:!1};if(qe.layers[F.fqid]=qe.layers[F.fqid]||{styleLayer:F,targets:[]},F.is3D()&&(qe.has3DLayers=!0),!Fe)return Oe.uniqueFeatureID=!1,void qe.layers[F.fqid].targets.push(Oe);qe.layers[F.fqid].targets.push(Object.assign({},Oe,{namespace:Fe.namespace,properties:Fe.properties,uniqueFeatureID:Fe.uniqueFeatureID}))};for(const Ae of Oe)if("featuresetId"in Ae.target){const{featuresetId:Oe,importId:Fe}=Ae.target,Ve=this.getFragmentStyle(Fe);if(!Ve||!Ve._featuresetSelectors)continue;const qe=Ve._featuresetSelectors[Oe];if(!qe){this.fire(new F.y(new Error(`The featureset '${Oe}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const F of qe){const Oe=Ve.getOwnLayer(F.layerId);Oe&&!ou.has(Oe.type)&&r(Oe,Ve.getOwnLayerSourceCache(Oe),Ae,F)}}else if("layerId"in Ae.target){const{layerId:F}=Ae.target,Oe=this.getLayer(F);if(!Oe||ou.has(Oe.type))continue;r(Oe,this.getLayerSourceCache(Oe),Ae)}const qe=this._queryRenderedFeatures(Ae,Ve,Fe);return this._flattenAndSortRenderedFeatures(qe)}_queryRenderedFeatures(F,Ae,Oe){const Fe=[],Ve=!!this.map._showQueryGeometry,qe=Xe.createFromScreenPoints(F,Oe);for(const F in Ae){const pt=lt(qe,Ae[F],this._availableImages,Oe,Ve);Object.keys(pt).length&&Fe.push(pt)}if(this.placement)for(const F in Ae){if(!Ae[F].sourceCache._onlySymbols)continue;const Oe=ct(qe.screenGeometry,Ae[F],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(Oe).length&&Fe.push(Oe)}return Fe}querySourceFeatures(F,Ae){const Oe=Ae&&Ae.filter;Oe&&this._validate(Se,"querySourceFeatures.filter",Oe,null,Ae);let Fe=[];const Ve=this.getOwnSourceCaches(F);for(const F of Ve)Fe=Fe.concat(ht(F,Ae));return Fe}addSourceType(F,Ae,Oe){return To.getSourceType(F)?Oe(new Error(`A source type called "${F}" already exists.`)):(To.setSourceType(F,Ae),Ae.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:F,url:Ae.workerSourceURL},Oe):Oe(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(Ae,Oe,Fe={}){this._checkLoaded();const Ve=this.light.getLight();let qe=!1;for(const Oe in Ae)if(!F.bn(Ae[Oe],Ve[Oe])){qe=!0;break}if(!qe)return;const pt=this._getTransitionParameters();this.light.setLight(Ae,Oe,Fe),this.light.updateTransitions(pt)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=F.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&F.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(Ae,Oe=1){if(this._checkLoaded(),!Ae)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===Oe&&delete this.terrain,null===Ae?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let Fe=Ae;const Ve=null==Ae.source;if(1===Oe){if(this.disableElevatedTerrain)return;if("object"==typeof Fe.source){const Ae="terrain-dem-src";this.addSource(Ae,Fe.source),Fe=F.cp(Fe),Fe=F.l(Fe,{source:Ae})}const Ae=F.l({},Fe),Oe={};if(this.terrain&&Ve){Ae.source=this.terrain.get().source;const F=this.terrain?this.getFragmentStyle(this.terrain.scope):null;F&&(Oe.style=F.serialize())}if(this._validate(xe,"terrain",Ae,Oe))return}if(!this.terrain||this.terrain.scope!==this.scope&&!Ve||this.terrain&&Oe!==this.terrain.drapeRenderMode){if(!Fe)return;this._createTerrain(Fe,Oe),this.fire(new F.z("data",{dataType:"style"}))}else{const Oe=this.terrain,Ve=Oe.get();for(const Ae of Object.keys(F.a3.terrain))!Fe.hasOwnProperty(Ae)&&F.a3.terrain[Ae].default&&(Fe[Ae]=F.a3.terrain[Ae].default);for(const Fe in Ae)if(!F.bn(Ae[Fe],Ve[Fe])){Oe.set(Ae,this.options),this.stylesheet.terrain=Ae;const Fe=this._getTransitionParameters({duration:0});Oe.updateTransitions(Fe),this.fire(new F.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(F){const Ae=this.fog=new je(F,this.map.transform,this.scope,this.options);this.stylesheet.fog=Ae.get();const Oe=this._getTransitionParameters({duration:0});Ae.updateTransitions(Oe)}_createSnow(F){const Ae=this.snow=new uc(F,this.map.transform,this.scope,this.options);this.stylesheet.snow=Ae.get();const Oe=this._getTransitionParameters({duration:0});Ae.updateTransitions(Oe)}_createRain(F){const Ae=this.rain=new jc(F,this.map.transform,this.scope,this.options);this.stylesheet.rain=Ae.get();const Oe=this._getTransitionParameters({duration:0});Ae.updateTransitions(Oe)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const F of this.map._markers)F._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(Ae){if(this._checkLoaded(),!Ae)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const Oe=this.fog;if(!F.bn(Oe.get(),Ae)){Oe.set(Ae,this.options),this.stylesheet.fog=Oe.get();const F=this._getTransitionParameters({duration:0});Oe.updateTransitions(F)}}else this._createFog(Ae);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(Ae){if(this._checkLoaded(),!Ae)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const Oe=this.snow;if(!F.bn(Oe.get(),Ae)){Oe.set(Ae,this.options),this.stylesheet.snow=Oe.get();const F=this._getTransitionParameters({duration:0});Oe.updateTransitions(F)}}else this._createSnow(Ae);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(Ae){if(this._checkLoaded(),!Ae)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const Oe=this.rain;if(!F.bn(Oe.get(),Ae)){Oe.set(Ae,this.options),this.stylesheet.rain=Oe.get();const F=this._getTransitionParameters({duration:0});Oe.updateTransitions(F)}}else this._createRain(Ae);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const F in this._layers)this._layers[F].lut=this._styleColorTheme.lut;for(const F in this._sourceCaches)this._sourceCaches[F].clearTiles()},Ae=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!Ae)return this._styleColorTheme.lut=null,void t();const Oe=this._evaluateColorThemeData(Ae);this._loadColorTheme(Oe).then((()=>{this.fire(new F.z("colorthemeset")),t()})).catch((Ae=>{F.w(`Couldn't set color theme: ${Ae}`)}))}setColorTheme(Ae){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&F.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=Ae,this._reloadColorTheme()}setImportColorTheme(F,Ae){const Oe=this.getFragmentStyle(F);Oe&&(Oe._styleColorTheme.colorThemeOverride=Ae,Oe._reloadColorTheme())}_getTransitionParameters(Ae){return{now:F.q.now(),transition:F.l(this.transition,Ae)}}updateDrapeFirstLayers(){if(!this.terrain)return;const F=[],Ae=[];for(const Oe of this._mergedOrder)this.isLayerDraped(this._mergedLayers[Oe])?F.push(Oe):Ae.push(Oe);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...F),this._drapedFirstOrder.push(...Ae)}_createTerrain(F,Ae){const Oe=this.terrain=new Sl(F,Ae,this.scope,this.options);1===Ae&&(this.stylesheet.terrain=F),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const Fe=this._getTransitionParameters({duration:0});Oe.updateTransitions(Fe)}_force3DLayerUpdate(){for(const F in this._layers){const Ae=this._layers[F];"fill-extrusion"===Ae.type&&this._updateLayer(Ae)}}_forceSymbolLayerUpdate(){for(const F in this._layers){const Ae=this._layers[F];"symbol"===Ae.type&&this._updateLayer(Ae)}}_validate(Ae,Oe,Fe,Ve,qe={}){if(qe&&!1===qe.validate)return!1;const pt=F.l({},this.serialize());return go(this,Ae.call(me,F.l({key:Oe,style:pt,value:Fe,styleSpec:F.a3},Ve)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),F.cx.off("pluginStateChange",this._rtlTextPluginCallback);for(const F in this._mergedLayers)this._mergedLayers[F].setEventedParent(null);for(const F in this._mergedSourceCaches)this._mergedSourceCaches[F].clearTiles(),this._mergedSourceCaches[F].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(F){const Ae=this.getSourceCaches(F);for(const F of Ae)F.clearTiles()}clearSources(){for(const F in this._mergedSourceCaches)this._mergedSourceCaches[F].clearTiles()}reloadSource(F){const Ae=this.getSourceCaches(F);for(const F of Ae)F.resume(),F.reload()}reloadSources(){for(const F of this.getSources())F.reload&&F.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle((F=>{F.modelManager.reloadModels(F.scope)}))}updateSources(F){let Ae;this.directionalLight&&(Ae=ao(this.directionalLight));for(const Oe in this._mergedSourceCaches)this._mergedSourceCaches[Oe].update(F,void 0,void 0,Ae)}_generateCollisionBoxes(){for(const F in this._sourceCaches){const Ae=this._sourceCaches[F];Ae.resume(),Ae.reload()}}_updatePlacement(Ae,Oe,Fe,Ve,qe,pt,vt=!1){let zt=!1,ri=!1;const xi={},bi={};for(const Ae of this._mergedOrder){const Fe=this._mergedLayers[Ae];if("symbol"!==Fe.type)continue;const Ve=F.aC(Fe.source,Fe.scope);let qe=xi[Ve];if(!qe){const F=this.getLayerSourceCache(Fe);if(!F)continue;const Ae=F.getRenderableIds(!0).map((Ae=>F.getTileByID(Ae)));bi[Ve]=Ae.slice(),qe=xi[Ve]=Ae.sort(((F,Ae)=>Ae.tileID.overscaledZ-F.tileID.overscaledZ||(F.tileID.isLessThan(Ae.tileID)?-1:1)))}const pt=this.crossTileSymbolIndex.addLayer(Fe,qe,Oe.center.lng,Oe.projection);zt=zt||pt}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),vt=vt||this._layerOrderChanged||0===Ve,this._layerOrderChanged&&this.fire(new F.z("neworder")),(vt||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(F.q.now(),Oe.zoom))&&(this.pauseablePlacement=new Li(Oe,this._mergedOrder,vt,Fe,Ve,qe,this.placement,this.fog&&Oe.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,xi,bi,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(F.q.now()),ri=!0),zt&&this.pauseablePlacement.placement.setStale()),ri||zt){this._buildingIndex.onNewFrame(Oe.zoom);for(let Ae=0;Ae<this._mergedOrder.length;Ae++){const Oe=this._mergedLayers[this._mergedOrder[Ae]];if("symbol"!==Oe.type)continue;const Fe=this.isLayerClipped(Oe);this.placement.updateLayerOpacities(Oe,xi[F.aC(Oe.source,Oe.scope)],Ae,Fe?pt:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(F.q.now())}}_releaseSymbolFadeTiles(){for(const F in this._sourceCaches)this._sourceCaches[F].releaseSymbolFadeTiles()}addImport(Ae,Oe){this._checkLoaded();const Fe=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==Fe.findIndex((({id:F})=>F===Ae.id)))return void this.fire(new F.y(new Error(`Import with id '${Ae.id}' already exists in the map's style.`)));if(!Oe)return Fe.push(Ae),this._loadImports([Ae],!0);const Ve=Fe.findIndex((({id:F})=>F===Oe));return-1===Ve&&this.fire(new F.y(new Error(`Import with id "${Oe}" does not exist on this map.`))),this.stylesheet.imports=Fe.slice(0,Ve).concat(Ae).concat(Fe.slice(Ve)),this._loadImports([Ae],!0,Oe)}updateImport(Ae,Oe){this._checkLoaded();const Fe=this.stylesheet.imports||[],Ve=this.getImportIndex(Ae);return-1===Ve?this:"string"==typeof Oe?(this.setImportUrl(Ae,Oe),this):(Oe.url&&Oe.url!==Fe[Ve].url&&this.setImportUrl(Ae,Oe.url),F.bn(Oe.config,Fe[Ve].config)||this.setImportConfig(Ae,Oe.config,Oe.data.schema),F.bn(Oe.data,Fe[Ve].data)||this.setImportData(Ae,Oe.data),this)}moveImport(F,Ae){this._checkLoaded();let Oe=this.stylesheet.imports||[];const Fe=this.getImportIndex(F);if(-1===Fe)return this;const Ve=this.getImportIndex(Ae);if(-1===Ve)return this;const qe=Oe[Fe],pt=this.fragments[Fe];return Oe=Oe.filter((({id:Ae})=>Ae!==F)),this.fragments=this.fragments.filter((({id:Ae})=>Ae!==F)),this.stylesheet.imports=Oe.slice(0,Ve).concat(qe).concat(Oe.slice(Ve)),this.fragments=this.fragments.slice(0,Ve).concat(pt).concat(this.fragments.slice(Ve)),this.mergeLayers(),this}setImportUrl(F,Ae){this._checkLoaded();const Oe=this.stylesheet.imports||[],Fe=this.getImportIndex(F);if(-1===Fe)return this;Oe[Fe].url=Ae;const Ve=this.fragments[Fe];return Ve.style=this._createFragmentStyle(Oe[Fe]),Ve.style.on("style.import.load",(()=>this.mergeAll())),Ve.style.loadURL(Ae),this}setImportData(F,Ae){this._checkLoaded();const Oe=this.getImportIndex(F),Fe=this.stylesheet.imports||[];return-1===Oe?this:Ae?(this.fragments[Oe].style.setState(Ae),this._reloadImports(),this):(delete Fe[Oe].data,this.setImportUrl(F,Fe[Oe].url))}setImportConfig(F,Ae,Oe){this._checkLoaded();const Fe=this.getImportIndex(F),Ve=this.stylesheet.imports||[];if(-1===Fe)return this;Ae?Ve[Fe].config=Ae:delete Ve[Fe].config;const qe=this.fragments[Fe];Oe&&qe.style.stylesheet&&(qe.style.stylesheet.schema=Oe);const pt=qe.style.stylesheet&&qe.style.stylesheet.schema;return qe.config=Ae,qe.style.updateConfig(Ae,pt),this.updateConfigDependencies(),this}removeImport(F){this._checkLoaded();const Ae=this.stylesheet.imports||[],Oe=this.getImportIndex(F);-1!==Oe&&(Ae.splice(Oe,1),this.fragments[Oe].style._remove(),this.fragments.splice(Oe,1),this._reloadImports())}getImportIndex(Ae){const Oe=(this.stylesheet.imports||[]).findIndex((F=>F.id===Ae));return-1===Oe&&this.fire(new F.y(new Error(`Import '${Ae}' does not exist in the map's style and cannot be updated.`))),Oe}getLayer(F){return this._mergedLayers[F]}getSources(){const F=[];for(const Ae in this._mergedOtherSourceCaches){const Oe=this._mergedOtherSourceCaches[Ae];Oe&&F.push(Oe.getSource())}return F}getSource(F,Ae){const Oe=this.getSourceCache(F,Ae);return Oe&&Oe.getSource()}getLayerSource(F){const Ae=this.getLayerSourceCache(F);return Ae&&Ae.getSource()}getSourceCache(Ae,Oe){const Fe=F.aC(Ae,Oe);return this._mergedOtherSourceCaches[Fe]}getLayerSourceCache(Ae){const Oe=F.aC(Ae.source,Ae.scope);return"symbol"===Ae.type?this._mergedSymbolSourceCaches[Oe]:this._mergedOtherSourceCaches[Oe]}getSourceCaches(F){if(null==F)return Object.values(this._mergedSourceCaches);const Ae=[];return this._mergedOtherSourceCaches[F]&&Ae.push(this._mergedOtherSourceCaches[F]),this._mergedSymbolSourceCaches[F]&&Ae.push(this._mergedSymbolSourceCaches[F]),Ae}updateSourceCaches(){const F=this._changes.getUpdatedSourceCaches();for(const Ae in F){const Oe=F[Ae];"reload"===Oe?this.reloadSource(Ae):"clear"===Oe&&this.clearSource(Ae)}}updateLayers(F){const Ae=this._changes.getUpdatedPaintProperties();for(const Oe of Ae){const Ae=this.getLayer(Oe);Ae&&Ae.updateTransitions(F)}}getImages(F,Ae,Oe){this.imageManager.getImages(Ae.icons,Ae.scope,Oe),this._updateTilesForChangedImages();const o=F=>{F&&F.setDependencies(Ae.tileID.key,Ae.type,Ae.icons)};o(this._otherSourceCaches[Ae.source]),o(this._symbolSourceCaches[Ae.source])}rasterizeImages(F,Ae,Oe){this.imageManager.rasterizeImages(Ae,Oe)}getGlyphs(F,Ae,Oe){this.glyphManager.getGlyphs(Ae.stacks,Ae.scope,Oe)}getResource(Ae,Oe,Fe){return F.cy(Oe,Fe)}getOwnSourceCache(F){return this._otherSourceCaches[F]}getOwnLayerSourceCache(F){return"symbol"===F.type?this._symbolSourceCaches[F.source]:this._otherSourceCaches[F.source]}getOwnSourceCaches(F){const Ae=[];return this._otherSourceCaches[F]&&Ae.push(this._otherSourceCaches[F]),this._symbolSourceCaches[F]&&Ae.push(this._symbolSourceCaches[F]),Ae}_isSourceCacheLoaded(Ae){const Oe=this.getOwnSourceCaches(Ae);return 0===Oe.length?(this.fire(new F.y(new Error(`There is no source with ID '${Ae}'`))),!1):Oe.every((F=>F.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(F,Ae){if(!this._clipLayerPresent&&"fill-extrusion"!==F.type)return!1;const Oe="fill-extrusion"===F.type&&"building"===F.sourceLayer;if(F.is3D()){if(Oe||Ae&&"batched-model"===Ae.type)return!0;if("model"===F.type)return!0}else if("symbol"===F.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((F=>{F.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}To.getSourceType=function(F){return Gc[F]},To.setSourceType=function(F,Ae){Gc[F]=Ae},To.registerForPluginStateChange=F.ch;var cu="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",uu="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",bu="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",Bu="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Uu="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",ju="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",qu="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",Zu="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",$u="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",Hu="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",Ju="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef TEXTURE_GATHER\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const Qu=[];jo(cu,Qu),jo(bu,Qu),jo(uu,Qu);const cd={"_prelude_fog.vertex.glsl":ju,"_prelude_terrain.vertex.glsl":Uu,"_prelude_shadow.vertex.glsl":Hu,"_prelude_fog.fragment.glsl":qu,"_prelude_shadow.fragment.glsl":Ju,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":Zu,"_prelude_raster_particle.glsl":$u},ud={};Go("",Uu),Go(qu,ju),Go(Ju,Hu),Go(Zu,""),Go($u,"");const dd=Go(uu,bu),md=cu;var Td={background:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:Go("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Go('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:Go("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Go("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:Go("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Go("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:Go("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:Go('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:Go("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:Go("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:Go("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:Go("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Go('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Go('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#else\nz+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#endif\n}'),terrainRaster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:Go("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:Go('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Bu),skyboxGradient:Go('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Bu),skyboxCapture:Go("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:Go('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:Go("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:Go("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:Go("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:Go("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:Go("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Go("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function jo(F,Ae){const Oe=F.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let F of Oe)if(F=F.trim(),"#"===F[0]&&F.includes("if")&&!F.includes("endif")){F=F.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const Oe=F.split(" ");for(const F of Oe)Ae.includes(F)||Ae.push(F)}}function Go(F,Ae){const Oe=/#include\s+"([^"]+)"/g,Fe=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let Ve=Ae.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);Ve&&(Ve=Ve.map((F=>{const Ae=F.split(" ");return Ae[Ae.length-1]})),Ve=[...new Set(Ve)]);const qe={},pt=[],vt=[];if(F=F.replace(Oe,((F,Ae)=>(vt.push(Ae),""))),(Ae=Ae.replace(Oe,((F,Ae)=>(pt.push(Ae),"")))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let zt=[...Qu];jo(F,zt),jo(Ae,zt);for(const F of[...pt,...vt])cd[F]||console.error(`Undefined include: ${F}`),ud[F]||(ud[F]=[],jo(cd[F],ud[F])),zt=[...zt,...ud[F]];return{fragmentSource:F=F.replace(Fe,((F,Ae,Oe,Fe,Ve)=>(qe[Ve]=!0,"define"===Ae?`\n#ifndef HAS_UNIFORM_u_${Ve}\nin ${Oe} ${Fe} ${Ve};\n#else\nuniform ${Oe} ${Fe} u_${Ve};\n#endif\n`:"initialize"===Ae?`\n#ifdef HAS_UNIFORM_u_${Ve}\n    ${Oe} ${Fe} ${Ve} = u_${Ve};\n#endif\n`:"define-attribute"===Ae?`\n#ifdef HAS_ATTRIBUTE_a_${Ve}\n    in ${Oe} ${Fe} ${Ve};\n#endif\n`:"initialize-attribute"===Ae?"":void 0))),vertexSource:Ae=Ae.replace(Fe,((F,Ae,Oe,Fe,Ve)=>{const pt="float"===Fe?"vec2":Fe,vt=Ve.match(/color/)?"color":pt;return"define-attribute-vertex-shader-only"===Ae?`\n#ifdef HAS_ATTRIBUTE_a_${Ve}\nin ${Oe} ${Fe} a_${Ve};\n#endif\n`:qe[Ve]?"define"===Ae?`\n#ifndef HAS_UNIFORM_u_${Ve}\nuniform lowp float u_${Ve}_t;\nin ${Oe} ${pt} a_${Ve};\nout ${Oe} ${Fe} ${Ve};\n#else\nuniform ${Oe} ${Fe} u_${Ve};\n#endif\n`:"initialize"===Ae?"vec4"===vt?`\n#ifndef HAS_UNIFORM_u_${Ve}\n    ${Ve} = a_${Ve};\n#else\n    ${Oe} ${Fe} ${Ve} = u_${Ve};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${Ve}\n    ${Ve} = unpack_mix_${vt}(a_${Ve}, u_${Ve}_t);\n#else\n    ${Oe} ${Fe} ${Ve} = u_${Ve};\n#endif\n`:"define-attribute"===Ae?`\n#ifdef HAS_ATTRIBUTE_a_${Ve}\n    in ${Oe} ${Fe} a_${Ve};\n    out ${Oe} ${Fe} ${Ve};\n#endif\n`:"initialize-attribute"===Ae?`\n#ifdef HAS_ATTRIBUTE_a_${Ve}\n    ${Ve} = a_${Ve};\n#endif\n`:void 0:"define"===Ae?`\n#ifndef HAS_UNIFORM_u_${Ve}\nuniform lowp float u_${Ve}_t;\nin ${Oe} ${pt} a_${Ve};\n#else\nuniform ${Oe} ${Fe} u_${Ve};\n#endif\n`:"define-instanced"===Ae?"mat4"===vt?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${Ve}0;\nin vec4 a_${Ve}1;\nin vec4 a_${Ve}2;\nin vec4 a_${Ve}3;\n#else\nuniform ${Oe} ${Fe} u_${Ve};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${Oe} ${pt} a_${Ve};\n#else\nuniform ${Oe} ${Fe} u_${Ve};\n#endif\n`:"initialize-attribute-custom"===Ae?`\n#ifdef HAS_ATTRIBUTE_a_${Ve}\n    ${Oe} ${Fe} ${Ve} = a_${Ve};\n#endif\n`:"vec4"===vt?`\n#ifndef HAS_UNIFORM_u_${Ve}\n    ${Oe} ${Fe} ${Ve} = a_${Ve};\n#else\n    ${Oe} ${Fe} ${Ve} = u_${Ve};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${Ve}\n    ${Oe} ${Fe} ${Ve} = unpack_mix_${vt}(a_${Ve}, u_${Ve}_t);\n#else\n    ${Oe} ${Fe} ${Ve} = u_${Ve};\n#endif\n`})),staticAttributes:Ve,usedDefines:zt,vertexIncludes:pt,fragmentIncludes:vt}}class Vo{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(F,Ae,Oe,Fe,Ve,qe,pt,vt){this.context=F;let zt=this.boundPaintVertexBuffers.length!==Fe.length;for(let F=0;!zt&&F<Fe.length;F++)this.boundPaintVertexBuffers[F]!==Fe[F]&&(zt=!0);let ri=this.boundDynamicVertexBuffers.length!==pt.length;for(let F=0;!ri&&F<pt.length;F++)this.boundDynamicVertexBuffers[F]!==pt[F]&&(ri=!0);if(!this.vao||this.boundProgram!==Ae||this.boundLayoutVertexBuffer!==Oe||zt||ri||this.boundIndexBuffer!==Ve||this.boundVertexOffset!==qe)this.freshBind(Ae,Oe,Fe,Ve,qe,pt,vt);else{F.bindVertexArrayOES.set(this.vao);for(const Oe of pt)Oe&&(Oe.bind(),vt&&Oe.instanceCount&&Oe.setVertexAttribDivisor(F.gl,Ae,vt));Ve&&Ve.dynamicDraw&&Ve.bind()}}freshBind(F,Ae,Oe,Fe,Ve,qe,pt){const vt=F.numAttributes,zt=this.context,ri=zt.gl;this.vao&&this.destroy(),this.vao=zt.gl.createVertexArray(),zt.bindVertexArrayOES.set(this.vao),this.boundProgram=F,this.boundLayoutVertexBuffer=Ae,this.boundPaintVertexBuffers=Oe,this.boundIndexBuffer=Fe,this.boundVertexOffset=Ve,this.boundDynamicVertexBuffers=qe,Ae.enableAttributes(ri,F),Ae.bind(),Ae.setVertexAttribPointers(ri,F,Ve);for(const Ae of Oe)Ae.enableAttributes(ri,F),Ae.bind(),Ae.setVertexAttribPointers(ri,F,Ve);for(const Ae of qe)Ae&&(Ae.enableAttributes(ri,F),Ae.bind(),Ae.setVertexAttribPointers(ri,F,Ve),pt&&Ae.instanceCount&&Ae.setVertexAttribDivisor(ri,F,pt));Fe&&Fe.bind(),zt.currentNumAttributes=vt}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function qo(Ae,Oe){const Fe=Math.pow(2,Oe.canonical.z),Ve=Oe.canonical.y;return[new F.aa(0,Ve/Fe).toLngLat().lat,new F.aa(0,(Ve+1)/Fe).toLngLat().lat]}function Ho(Ae,Oe,Fe,Ve,qe,pt,vt){const zt=Ae.context,ri=zt.gl,xi=Fe.hillshadeFBO;if(!xi)return;Ae.prepareDrawTile();const bi=Ae.isTileAffectedByFog(Oe),wi=Ae.getOrCreateProgram("hillshade",{overrideFog:bi});zt.activeTexture.set(ri.TEXTURE0),ri.bindTexture(ri.TEXTURE_2D,xi.colorAttachment.get());const dr=((Ae,Oe,Fe,Ve)=>{const qe=Fe.paint.get("hillshade-shadow-color"),pt="none"===Fe.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),vt=Fe.paint.get("hillshade-highlight-color"),zt="none"===Fe.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),ri=Fe.paint.get("hillshade-accent-color"),xi="none"===Fe.paint.get("hillshade-accent-color-use-theme").constantOr("default"),bi=Fe.paint.get("hillshade-emissive-strength");let wi=F.ai(Fe.paint.get("hillshade-illumination-direction"));if("viewport"===Fe.paint.get("hillshade-illumination-anchor"))wi-=Ae.transform.angle;else if(Ae.style&&Ae.style.enable3dLights()&&Ae.style.directionalLight){const Oe=Ae.style.directionalLight.properties.get("direction"),Fe=F.cb(Oe.x,Oe.y,Oe.z);wi=F.ai(Fe[1])}const dr=!Ae.options.moving;return{u_matrix:Ve||Ae.transform.calculateProjMatrix(Oe.tileID.toUnwrapped(),dr),u_image:0,u_latrange:qo(0,Oe.tileID),u_light:[Fe.paint.get("hillshade-exaggeration"),wi],u_shadow:qe.toRenderColor(pt?null:Fe.lut),u_highlight:vt.toRenderColor(zt?null:Fe.lut),u_emissive_strength:bi,u_accent:ri.toRenderColor(xi?null:Fe.lut)}})(Ae,Fe,Ve,Ae.terrain?Oe.projMatrix:null);Ae.uploadCommonUniforms(zt,wi,Oe.toUnwrapped());const{tileBoundsBuffer:jr,tileBoundsIndexBuffer:Qr,tileBoundsSegments:Xn}=Ae.getTileBoundsBuffers(Fe);wi.draw(Ae,ri.TRIANGLES,qe,pt,vt,Vi.disabled,dr,Ve.id,jr,Qr,Xn)}function Zo(Ae,Oe,Fe){if(!Oe.needsDEMTextureUpload)return;const Ve=Ae.context,qe=Ve.gl;Ve.pixelStoreUnpackPremultiplyAlpha.set(!1),Oe.demTexture=Oe.demTexture||Ae.getTileTexture(Fe.stride);const pt=Fe.getPixels();Oe.demTexture?Oe.demTexture.update(pt,{premultiply:!1}):Oe.demTexture=new F.T(Ve,pt,qe.R32F,{premultiply:!1}),Oe.needsDEMTextureUpload=!1}function Wo(Ae,Oe,Fe){const Ve=Ae.context,qe=Ve.gl;if(!Oe.dem)return;const pt=Oe.dem;if(Ve.activeTexture.set(qe.TEXTURE1),Zo(Ae,Oe,pt),!Oe.demTexture)return;Oe.demTexture.bind(qe.NEAREST,qe.CLAMP_TO_EDGE);const vt=pt.dim;Ve.activeTexture.set(qe.TEXTURE0);let zt=Oe.hillshadeFBO;if(!zt){const Ae=new F.T(Ve,{width:vt,height:vt,data:null},qe.RGBA8);Ae.bind(qe.LINEAR,qe.CLAMP_TO_EDGE),zt=Oe.hillshadeFBO=Ve.createFramebuffer(vt,vt,!0,"renderbuffer"),zt.colorAttachment.set(Ae.texture)}Ve.bindFramebuffer.set(zt.framebuffer),Ve.viewport.set([0,0,vt,vt]);const{tileBoundsBuffer:ri,tileBoundsIndexBuffer:xi,tileBoundsSegments:bi}=Ae.getMercatorTileBoundsBuffers(),wi=[];Ae.linearFloatFilteringSupported()&&wi.push("TERRAIN_DEM_FLOAT_FORMAT"),Ae.getOrCreateProgram("hillshadePrepare",{defines:wi}).draw(Ae,qe.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,Vi.disabled,((Ae,Oe)=>{const Fe=Oe.stride,Ve=F.ab.mat4.create();return F.ab.mat4.ortho(Ve,0,F.ag,-F.ag,0,0,1),F.ab.mat4.translate(Ve,Ve,[0,-F.ag,0]),{u_matrix:Ve,u_image:1,u_dimension:[Fe,Fe],u_zoom:Ae.overscaledZ}})(Oe.tileID,pt),Fe.id,ri,xi,bi),Oe.needsHillshadePrepare=!1}class $o{constructor(F){this.gl=F.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(F){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Xo extends $o{getDefault(){return F.aj.transparent}set(F){const Ae=this.current;(F.r!==Ae.r||F.g!==Ae.g||F.b!==Ae.b||F.a!==Ae.a||this.dirty)&&(this.gl.clearColor(F.r,F.g,F.b,F.a),this.current=F,this.dirty=!1)}}class Ko extends $o{getDefault(){return 1}set(F){(F!==this.current||this.dirty)&&(this.gl.clearDepth(F),this.current=F,this.dirty=!1)}}class Yo extends $o{getDefault(){return 0}set(F){(F!==this.current||this.dirty)&&(this.gl.clearStencil(F),this.current=F,this.dirty=!1)}}class Jo extends $o{getDefault(){return[!0,!0,!0,!0]}set(F){const Ae=this.current;(F[0]!==Ae[0]||F[1]!==Ae[1]||F[2]!==Ae[2]||F[3]!==Ae[3]||this.dirty)&&(this.gl.colorMask(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}}class Qo extends $o{getDefault(){return!0}set(F){(F!==this.current||this.dirty)&&(this.gl.depthMask(F),this.current=F,this.dirty=!1)}}class es extends $o{getDefault(){return 255}set(F){(F!==this.current||this.dirty)&&(this.gl.stencilMask(F),this.current=F,this.dirty=!1)}}class ts extends $o{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(F){const Ae=this.current;(F.func!==Ae.func||F.ref!==Ae.ref||F.mask!==Ae.mask||this.dirty)&&(this.gl.stencilFunc(F.func,F.ref,F.mask),this.current=F,this.dirty=!1)}}class is extends $o{getDefault(){const F=this.gl;return[F.KEEP,F.KEEP,F.KEEP]}set(F){const Ae=this.current;(F[0]!==Ae[0]||F[1]!==Ae[1]||F[2]!==Ae[2]||this.dirty)&&(this.gl.stencilOp(F[0],F[1],F[2]),this.current=F,this.dirty=!1)}}class os extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;F?Ae.enable(Ae.STENCIL_TEST):Ae.disable(Ae.STENCIL_TEST),this.current=F,this.dirty=!1}}class ss extends $o{getDefault(){return[0,1]}set(F){const Ae=this.current;(F[0]!==Ae[0]||F[1]!==Ae[1]||this.dirty)&&(this.gl.depthRange(F[0],F[1]),this.current=F,this.dirty=!1)}}class rs extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;F?Ae.enable(Ae.DEPTH_TEST):Ae.disable(Ae.DEPTH_TEST),this.current=F,this.dirty=!1}}class as extends $o{getDefault(){return this.gl.LESS}set(F){(F!==this.current||this.dirty)&&(this.gl.depthFunc(F),this.current=F,this.dirty=!1)}}class ns extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;F?Ae.enable(Ae.BLEND):Ae.disable(Ae.BLEND),this.current=F,this.dirty=!1}}class ls extends $o{getDefault(){const F=this.gl;return[F.ONE,F.ZERO,F.ONE,F.ZERO]}set(F){const Ae=this.current;(F[0]!==Ae[0]||F[1]!==Ae[1]||F[2]!==Ae[2]||F[3]!==Ae[3]||this.dirty)&&(this.gl.blendFuncSeparate(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}}class cs extends $o{getDefault(){return F.aj.transparent}set(F){const Ae=this.current;(F.r!==Ae.r||F.g!==Ae.g||F.b!==Ae.b||F.a!==Ae.a||this.dirty)&&(this.gl.blendColor(F.r,F.g,F.b,F.a),this.current=F,this.dirty=!1)}}class hs extends $o{getDefault(){return this.gl.FUNC_ADD}set(F){(F!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(F,F),this.current=F,this.dirty=!1)}}class us extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;F?Ae.enable(Ae.CULL_FACE):Ae.disable(Ae.CULL_FACE),this.current=F,this.dirty=!1}}class ds extends $o{getDefault(){return this.gl.BACK}set(F){(F!==this.current||this.dirty)&&(this.gl.cullFace(F),this.current=F,this.dirty=!1)}}class _s extends $o{getDefault(){return this.gl.CCW}set(F){(F!==this.current||this.dirty)&&(this.gl.frontFace(F),this.current=F,this.dirty=!1)}}let Ed=class extends $o{getDefault(){return null}set(F){(F!==this.current||this.dirty)&&(this.gl.useProgram(F),this.current=F,this.dirty=!1)}};class fs extends $o{getDefault(){return this.gl.TEXTURE0}set(F){(F!==this.current||this.dirty)&&(this.gl.activeTexture(F),this.current=F,this.dirty=!1)}}class ms extends $o{getDefault(){const F=this.gl;return[0,0,F.drawingBufferWidth,F.drawingBufferHeight]}set(F){const Ae=this.current;(F[0]!==Ae[0]||F[1]!==Ae[1]||F[2]!==Ae[2]||F[3]!==Ae[3]||this.dirty)&&(this.gl.viewport(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}}class gs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;Ae.bindFramebuffer(Ae.FRAMEBUFFER,F),this.current=F,this.dirty=!1}}class vs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;Ae.bindRenderbuffer(Ae.RENDERBUFFER,F),this.current=F,this.dirty=!1}}class ys extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;Ae.bindTexture(Ae.TEXTURE_2D,F),this.current=F,this.dirty=!1}}class xs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;Ae.bindBuffer(Ae.ARRAY_BUFFER,F),this.current=F,this.dirty=!1}}class bs extends $o{getDefault(){return null}set(F){const Ae=this.gl;Ae.bindBuffer(Ae.ELEMENT_ARRAY_BUFFER,F),this.current=F,this.dirty=!1}}class ws extends $o{getDefault(){return null}set(F){this.gl&&(F!==this.current||this.dirty)&&(this.gl.bindVertexArray(F),this.current=F,this.dirty=!1)}}class Ts extends $o{getDefault(){return 4}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;Ae.pixelStorei(Ae.UNPACK_ALIGNMENT,F),this.current=F,this.dirty=!1}}class Es extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;Ae.pixelStorei(Ae.UNPACK_PREMULTIPLY_ALPHA_WEBGL,F),this.current=F,this.dirty=!1}}class Ss extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Ae=this.gl;Ae.pixelStorei(Ae.UNPACK_FLIP_Y_WEBGL,F),this.current=F,this.dirty=!1}}class Cs extends $o{constructor(F,Ae){super(F),this.context=F,this.parent=Ae}getDefault(){return null}}class Is extends Cs{setDirty(){this.dirty=!0}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const Ae=this.gl;Ae.framebufferTexture2D(Ae.FRAMEBUFFER,Ae.COLOR_ATTACHMENT0,Ae.TEXTURE_2D,F,0),this.current=F,this.dirty=!1}}class Rs extends Cs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const Ae=this.gl;Ae.framebufferRenderbuffer(Ae.FRAMEBUFFER,this.attachment(),Ae.RENDERBUFFER,F),this.current=F,this.dirty=!1}}class Ds extends Cs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const Ae=this.gl;Ae.framebufferTexture2D(Ae.FRAMEBUFFER,this.attachment(),Ae.TEXTURE_2D,F,0),this.current=F,this.dirty=!1}}class Ls extends Rs{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const As=(F,Ae,Oe)=>({u_matrix:F,u_image0:0,u_skirt_height:Ae,u_ground_shadow_factor:Oe}),zs=(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr)=>({u_proj_matrix:Float32Array.from(F),u_globe_matrix:Ae,u_normalize_matrix:Float32Array.from(Fe),u_merc_matrix:Oe,u_zoom_transition:Ve,u_merc_center:qe,u_image0:0,u_frustum_tl:pt,u_frustum_tr:vt,u_frustum_br:zt,u_frustum_bl:ri,u_globe_pos:xi,u_globe_radius:bi,u_viewport:wi,u_grid_matrix:Qr?Float32Array.from(Qr):new Float32Array(9),u_skirt_height:dr,u_far_z_cutoff:jr});function Ps(F,Ae){return null!=F&&null!=Ae&&!(!F.hasData()||!Ae.hasData())&&null!=F.demTexture&&null!=Ae.demTexture&&F.tileID.key!==Ae.tileID.key}const Ad=new class{constructor(){this.operations={}}newMorphing(F,Ae,Oe,Fe,Ve){if(F in this.operations){const Ae=this.operations[F];Ae.to.tileID.key!==Oe.tileID.key&&(Ae.queued=Oe)}else this.operations[F]={startTime:Fe,phase:0,duration:Ve,from:Ae,to:Oe,queued:null}}getMorphValuesForProxy(F){if(!(F in this.operations))return null;const Ae=this.operations[F];return{from:Ae.from,to:Ae.to,phase:Ae.phase}}update(F){for(const Ae in this.operations){const Oe=this.operations[Ae];for(Oe.phase=(F-Oe.startTime)/Oe.duration;Oe.phase>=1||!this._validOp(Oe);)if(!this._nextOp(Oe,F)){delete this.operations[Ae];break}}}_nextOp(F,Ae){return!!F.queued&&(F.from=F.to,F.to=F.queued,F.queued=null,F.phase=0,F.startTime=Ae,!0)}_validOp(F){return F.from.hasData()&&F.to.hasData()}},Pd={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Fs(F,Ae,Oe){if(0===Ae)return 0;const Fe=Ae<1&&514===Oe?.25/Ae:1;return 6*Math.pow(1.5,22-F)*Math.max(Ae,1)*Fe}function ks(F,Ae){const Oe=1<<F.z;return!Ae&&(0===F.x||F.x===Oe-1)||0===F.y||F.y===Oe-1}const Bs=F=>({u_matrix:F});function Ns(Ae,Oe,Fe,Ve,qe){if(qe>0){const pt=F.q.now(),vt=(pt-Ae.timeAdded)/qe,zt=Oe?(pt-Oe.timeAdded)/qe:-1,ri=Fe.getSource(),xi=Ve.coveringZoomLevel({tileSize:ri.tileSize,roundZoom:ri.roundZoom}),bi=!Oe||Math.abs(Oe.tileID.overscaledZ-xi)>Math.abs(Ae.tileID.overscaledZ-xi),wi=bi&&Ae.refreshedUponExpiration?1:F.aw(bi?vt:1-zt,0,1);return Ae.refreshedUponExpiration&&vt>=1&&(Ae.refreshedUponExpiration=!1),Oe?{opacity:1,mix:1-wi}:{opacity:wi,mix:0}}return{opacity:1,mix:0}}class Us extends St{constructor(Ae){const Oe={type:"raster-dem",maxzoom:Ae.transform.maxZoom},Fe=new F.D(F.ci(),null),Ve=rt("mock-dem",Oe,Fe,Ae.style);super("mock-dem",Ve,!1),Ve.setEventedParent(this),this._sourceLoaded=!0}_loadTile(F,Ae){F.state="loaded",Ae(null)}}class js extends St{constructor(Ae){const Oe=rt("proxy",{type:"geojson",maxzoom:Ae.transform.maxZoom},new F.D(F.ci(),null),Ae.style);super("proxy",Oe,!1),Oe.setEventedParent(this),this.map=this.getSource().map=Ae,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(F,Ae,Oe){if(F.freezeTileCoverage)return;this.transform=F;const Fe=F.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((Ae,Oe)=>{if(Ae[Oe.key]="",!this._tiles[Oe.key]){const Ae=new bt(Oe,this._source.tileSize*Oe.overscaleFactor(),F.tileZoom);Ae.state="loaded",this._tiles[Oe.key]=Ae}return Ae}),{});for(const F in this._tiles)F in Fe||(this.freeFBO(F),this._tiles[F].unloadVectorData(),delete this._tiles[F])}freeFBO(F){const Ae=this.proxyCachedFBO[F];if(void 0!==Ae){const Oe=Object.values(Ae);this.renderCachePool.push(...Oe),delete this.proxyCachedFBO[F]}}deallocRenderCache(){this.renderCache.forEach((F=>F.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Gs extends F.aG{constructor(F,Ae,Oe){super(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y),this.proxyTileKey=Ae,this.projMatrix=Oe}}class Vs extends F.cJ{constructor(Ae,Oe){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},Ae.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),Ae.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),Ae.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=Ae,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[Fe,Ve,qe]=function(){const Ae=new F.b4,Oe=new F.aU,Fe=131;Ae.reserve(17161),Oe.reserve(33800);const Ve=F.ag/128,qe=F.ag+Ve/2,pt=qe+Ve;for(let Oe=-Ve;Oe<pt;Oe+=Ve)for(let Fe=-Ve;Fe<pt;Fe+=Ve){const Ve=Fe<0||Fe>qe||Oe<0||Oe>qe?24575:0,pt=F.aw(Math.round(Fe),0,F.ag),vt=F.aw(Math.round(Oe),0,F.ag);Ae.emplaceBack(pt+Ve,vt)}const l=(F,Ae)=>{const Ve=Ae*Fe+F;Oe.emplaceBack(Ve+1,Ve,Ve+Fe),Oe.emplaceBack(Ve+Fe,Ve+Fe+1,Ve+1)};for(let F=1;F<129;F++)for(let Ae=1;Ae<129;Ae++)l(Ae,F);return[0,129].forEach((F=>{for(let Ae=0;Ae<130;Ae++)l(Ae,F),l(F,Ae)})),[Ae,Oe,32768]}(),pt=Ae.context;this.gridBuffer=pt.createVertexBuffer(Fe,F.b6.members),this.gridIndexBuffer=pt.createIndexBuffer(Ve),this.gridSegments=F.b7.simpleSegment(0,0,Fe.length,Ve.length),this.gridNoSkirtSegments=F.b7.simpleSegment(0,0,Fe.length,qe),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new js(Oe.map),this.orthoMatrix=F.ab.mat4.create(),F.ab.mat4.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,F.ag,0,F.ag,0,1);const vt=pt.gl;this._overlapStencilMode=new Ui({func:vt.GEQUAL,mask:255},0,255,vt.KEEP,vt.KEEP,vt.REPLACE),this._previousZoom=Ae.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=Oe,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Us(Oe.map),this._pendingGroundEffectLayers=[]}set style(F){F.on("data",this._onStyleDataEvent.bind(this)),this._style=F,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(Ae,Oe,Fe){if(Ae&&Ae.terrain){this._style!==Ae&&(this.style=Ae,this._evaluationZoom=void 0);const Ve=Ae.terrain.properties,qe=0===Ae.terrain.drapeRenderMode,pt=Ae.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=F.q.now();const vt=Ae.terrain&&Ae.terrain.scope,zt=Ve.get("source"),ri=qe?this._mockSourceCache:Ae.getSourceCache(zt,vt);if(!ri)return void F.w(`Couldn't find terrain source "${zt}".`);if(this.sourceCache=ri,this._attenuationRange=Ae.terrain.getAttenuationRange(),this._exaggeration=pt?this.calculateExaggeration(Oe):Ve.get("exaggeration"),!Oe.projection.requiresDraping&&pt&&0===this._exaggeration)return void this._disable();this.enabled=!0;const h=()=>{this.sourceCache.used&&F.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const Ae=this.getScaledDemTileSize();this.sourceCache.update(Oe,Ae,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,h(),this._initializing=!0),h(),Oe.updateElevation(!0,Fe),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(Oe),this._emptyDEMTextureDirty=!0,this._previousZoom=Oe.zoom}else this._disable()}calculateExaggeration(Ae){if(this._attenuationRange&&Ae.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(Ae.zoom);const Oe=this._previousCameraAltitude,Fe=Ae.getFreeCameraOptions().position.z/Ae.pixelsPerMeter*Ae.worldSize;this._previousCameraAltitude=Fe;const Ve=null!=Oe?Fe-Oe:Number.MAX_VALUE;if(Math.abs(Ve)<2)return this._exaggeration;const qe=Ae.zoom,pt=this._style.terrain;if(!this._previousUpdateTimestamp)return pt.getExaggeration(qe);let vt=qe-this._previousZoom;const zt=this._previousUpdateTimestamp;let ri=qe;null!=this._evaluationZoom&&(ri=this._evaluationZoom,Math.abs(qe-ri)>.5&&(vt=.5*(qe-ri+vt)),vt*Ve<0&&(ri+=vt)),this._evaluationZoom=ri;const xi=pt.getExaggeration(ri),bi=xi===pt.getExaggeration(Math.max(0,ri-.1));if(bi&&Math.abs(xi-this._exaggeration)<.01)return xi;let wi=Math.min(.1,.00375*(this._updateTimestamp-zt));return(bi||xi<.1||Math.abs(vt)<1e-4)&&(wi=Math.min(.2,4*wi)),F.af(this._exaggeration,xi,wi)}resetTileLookupCache(F){this._findCoveringTileCache[F]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(F){F.coord&&"source"===F.dataType?this._clearRenderCacheForTile(F.sourceCacheId,F.coord):"style"===F.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const F in this._style._mergedSourceCaches)this._style._mergedSourceCaches[F].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((F=>F.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const F=2*this.proxySourceCache.getSource().tileSize;return[F,F]}set useVertexMorphing(F){this._useVertexMorphing=F}updateTileBinding(Ae){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const Oe=this.proxySourceCache,Fe=this.painter.transform;this._initializing&&(this._initializing=0===Fe._centerAltitude&&-1===this.getAtPointOrZero(F.aa.fromLngLat(Fe.center),-1),this._emptyDEMTextureDirty=!this._initializing);const Ve=this.proxyCoords=Oe.getIds().map((F=>{const Ae=Oe.getTileByID(F).tileID;return Ae.projMatrix=Fe.calculateProjMatrix(Ae.toUnwrapped()),Ae}));!function(Ae,Oe){const Fe=Oe.transform.pointCoordinate(Oe.transform.getCameraPoint()),Ve=new F.P(Fe.x,Fe.y);Ae.sort(((Ae,Oe)=>{if(Oe.overscaledZ-Ae.overscaledZ)return Oe.overscaledZ-Ae.overscaledZ;const Fe=new F.P(Ae.canonical.x+(1<<Ae.canonical.z)*Ae.wrap,Ae.canonical.y),qe=new F.P(Oe.canonical.x+(1<<Oe.canonical.z)*Oe.wrap,Oe.canonical.y),pt=Ve.mult(1<<Ae.canonical.z);return pt.x-=.5,pt.y-=.5,pt.distSqr(Fe)-pt.distSqr(qe)}))}(Ve,this.painter);const qe=this.proxyToSource||{};this.proxyToSource={},Ve.forEach((F=>{this.proxyToSource[F.key]={}})),this.terrainTileForTile={};const pt=this._style._mergedSourceCaches;for(const F in pt){const Oe=pt[F];if(!Oe.used)continue;if(Oe!==this.sourceCache&&this.resetTileLookupCache(Oe.id),this._setupProxiedCoordsForOrtho(Oe,Ae[F],qe),Oe.usedForTerrain)continue;const Fe=Ae[F];Oe.getSource().reparseOverscaled&&this._assignTerrainTiles(Fe)}this.proxiedCoords[Oe.id]=Ve.map((F=>new Gs(F,F.key,this.orthoMatrix))),this._assignTerrainTiles(Ve),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(qe),this.renderingToTexture=!1;const vt={};this._visibleDemTiles=[];for(const F of this.proxyCoords){const Ae=this.terrainTileForTile[F.key];if(!Ae)continue;const Oe=Ae.tileID.key;Oe in vt||(this._visibleDemTiles.push(Ae),vt[Oe]=Oe)}}_assignTerrainTiles(F){this._initializing||F.forEach((F=>{if(this.terrainTileForTile[F.key])return;const Ae=this._findTileCoveringTileID(F,this.sourceCache);Ae&&(this.terrainTileForTile[F.key]=Ae)}))}_prepareDEMTextures(){const F=this.painter.context,Ae=F.gl;for(const Oe in this.terrainTileForTile){const Fe=this.terrainTileForTile[Oe],Ve=Fe.dem;!Ve||Fe.demTexture&&!Fe.needsDEMTextureUpload||(F.activeTexture.set(Ae.TEXTURE1),Zo(this.painter,Fe,Ve))}}_prepareDemTileUniforms(F,Ae,Oe,Fe){if(!Ae||null==Ae.demTexture)return!1;const Ve=F.tileID.canonical,qe=Math.pow(2,Ae.tileID.canonical.z-Ve.z),pt=Fe||"";return Oe[`u_dem_tl${pt}`]=[Ve.x*qe%1,Ve.y*qe%1],Oe[`u_dem_scale${pt}`]=qe,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let F=0;const Ae=this._visibleDemTiles.reduce(((Ae,Oe)=>{if(!Oe.dem)return Ae;const Fe=Oe.dem.tree.minimums[0];return Fe>0&&F++,Ae+Fe}),0);return F?Ae/F:0}_updateEmptyDEMTexture(){const Ae=this.painter.context,Oe=Ae.gl;Ae.activeTexture.set(Oe.TEXTURE2);const Fe=this._getLoadedAreaMinimum(),Ve=new F.cK({width:1,height:1},new Float32Array([Fe]));this._emptyDEMTextureDirty=!1;let qe=this._emptyDEMTexture;return qe?qe.update(Ve,{premultiply:!1}):qe=this._emptyDEMTexture=new F.T(Ae,Ve,Oe.R32F,{premultiply:!1}),qe}setupElevationDraw(Ae,Oe,Fe){const Ve=this.painter.context,qe=Ve.gl,pt={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};pt.u_exaggeration=this.exaggeration();let vt=null,zt=null,ri=1;if(Fe&&Fe.morphing&&this._useVertexMorphing){const F=Fe.morphing.srcDemTile,Oe=Fe.morphing.dstDemTile;ri=Fe.morphing.phase,F&&Oe&&(this._prepareDemTileUniforms(Ae,F,pt,"_prev")&&(zt=F),this._prepareDemTileUniforms(Ae,Oe,pt)&&(vt=Oe))}const h=F=>F&&F.demTexture&&this.painter.linearFloatFilteringSupported()?qe.LINEAR:qe.NEAREST;let xi=null;var bi;if(this.enabled?zt&&vt?(xi=vt.demTexture,Ve.activeTexture.set(qe.TEXTURE4),zt.demTexture.bind(h(zt),qe.CLAMP_TO_EDGE),pt.u_dem_lerp=ri):(vt=this.terrainTileForTile[Ae.tileID.key],xi=this._prepareDemTileUniforms(Ae,vt,pt)?vt.demTexture:this.emptyDEMTexture):xi=this.emptyDEMTexture,Ve.activeTexture.set(qe.TEXTURE2),xi&&(pt.u_dem_size=1===(bi=xi).size[0]?1:bi.size[0]-2,xi.bind(h(vt),qe.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(Fe&&Fe.useDepthForOcclusion,Oe,pt),Fe&&Fe.useMeterToDem&&vt){const Ae=(1<<vt.tileID.canonical.z)*F.bH(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;pt.u_meter_to_dem=Ae}if(Fe&&Fe.labelPlaneMatrixInv&&(pt.u_label_plane_matrix_inv=Fe.labelPlaneMatrixInv),Oe.setTerrainUniformValues(Ve,pt),"globe"===this.painter.transform.projection.name){const F=this.globeUniformValues(this.painter.transform,Ae.tileID.canonical,Fe&&Fe.useDenormalizedUpVectorScale);Oe.setGlobeUniformValues(Ve,F)}}globeUniformValues(Ae,Oe,Fe){const Ve=Ae.projection;return{u_tile_tl_up:Ve.upVector(Oe,0,0),u_tile_tr_up:Ve.upVector(Oe,F.ag,0),u_tile_br_up:Ve.upVector(Oe,F.ag,F.ag),u_tile_bl_up:Ve.upVector(Oe,0,F.ag),u_tile_up_scale:Fe?F.cL(1):Ve.upVectorScale(Oe,Ae.center.lat,Ae.worldSize).metersToTile}}renderToBackBuffer(Ae){const Oe=this.painter,Fe=this.painter.context;0!==Ae.length&&(Fe.bindFramebuffer.set(null),Fe.viewport.set([0,0,Oe.width,Oe.height]),Oe.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(Ae,Oe,Fe,Ve,qe){if("globe"===Ae.transform.projection.name)!function(Ae,Oe,Fe,Ve,qe){const pt=Ae.context,vt=pt.gl;let zt,ri;const xi=Ae.transform,bi=F.cC(Ae,pt,xi),d=(F,Oe)=>{if(ri===Oe)return;const Fe=[Pd[Oe],"PROJECTION_GLOBE_VIEW"];bi&&Fe.push("CUSTOM_ANTIALIASING");const Ve=Ae.isTileAffectedByFog(F);zt=Ae.getOrCreateProgram("globeRaster",{defines:Fe,overrideFog:Ve}),ri=Oe},wi=Ae.colorModeForRenderPass(),dr=new Bi(vt.LEQUAL,Bi.ReadWrite,Ae.depthRangeFor3D);Ad.update(qe);const jr=F.cD(xi),Qr=[F.at(xi.center.lng),F.aA(xi.center.lat)],Xn=Ae.globeSharedBuffers,ho=[xi.width*F.q.devicePixelRatio,xi.height*F.q.devicePixelRatio],yo=Float32Array.from(xi.globeMatrix),zo={useDenormalizedUpVectorScale:!0};{const xi=Ae.transform,bi=Fs(xi.zoom,Oe.exaggeration(),Oe.sourceCache._source.tileSize);ri=-1;const ko=vt.TRIANGLES;for(const ri of Ve){const Ve=Fe.getTile(ri),Uo=Ui.disabled,ia=Oe.prevTerrainTileForTile[ri.key],_a=Oe.terrainTileForTile[ri.key];Ps(ia,_a)&&Ad.newMorphing(ri.key,ia,_a,qe,250),pt.activeTexture.set(vt.TEXTURE0),Ve.texture&&Ve.texture.bind(vt.LINEAR,vt.CLAMP_TO_EDGE);const Ma=Ad.getMorphValuesForProxy(ri.key),Ea=Ma?1:0;Ma&&F.J(zo,{morphing:{srcDemTile:Ma.from,dstDemTile:Ma.to,phase:F.cB(Ma.phase)}});const Ia=F.cE(ri.canonical),rl=F.cF(Ia.getCenter().lat),Sl=F.cG(ri.canonical,Ia,rl,xi.worldSize/xi._pixelsPerMercatorPixel),Il=F.bb(F.cH(ri.canonical)),Kl=zs(xi.expandedFarZProjMatrix,yo,jr,Il,F.ae(xi.zoom),Qr,xi.frustumCorners.TL,xi.frustumCorners.TR,xi.frustumCorners.BR,xi.frustumCorners.BL,xi.globeCenterInViewSpace,xi.globeRadius,ho,bi,xi._farZ,Sl);if(d(ri,Ea),zt&&(Oe.setupElevationDraw(Ve,zt,zo),Ae.uploadCommonUniforms(pt,zt,ri.toUnwrapped()),Xn)){const[F,Oe,Fe]=Xn.getGridBuffers(rl,0!==bi);zt.draw(Ae,ko,dr,Uo,wi,Vi.backCCW,Kl,"globe_raster",F,Oe,Fe)}}}if(Xn&&(Ae.renderDefaultNorthPole||Ae.renderDefaultSouthPole)){const qe=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];bi&&qe.push("CUSTOM_ANTIALIASING"),zt=Ae.getOrCreateProgram("globeRaster",{defines:qe});for(const qe of Ve){const{x:Ve,y:ri,z:bi}=qe.canonical,jr=0===ri,yo=ri===(1<<bi)-1,[ko,Uo,ia,_a]=Xn.getPoleBuffers(bi,!1);if(_a&&(jr||yo)){const ri=Fe.getTile(qe);pt.activeTexture.set(vt.TEXTURE0),ri.texture&&ri.texture.bind(vt.LINEAR,vt.CLAMP_TO_EDGE);let Xn=F.cI(bi,Ve,xi);const Ma=F.bb(F.cH(qe.canonical)),S=(F,Oe)=>F.draw(Ae,vt.TRIANGLES,dr,Ui.disabled,wi,Vi.disabled,zs(xi.expandedFarZProjMatrix,Xn,Xn,Ma,0,Qr,xi.frustumCorners.TL,xi.frustumCorners.TR,xi.frustumCorners.BR,xi.frustumCorners.BL,xi.globeCenterInViewSpace,xi.globeRadius,ho,0,xi._farZ),"globe_pole_raster",Oe,ia,_a);Oe.setupElevationDraw(ri,zt,zo),Ae.uploadCommonUniforms(pt,zt,qe.toUnwrapped()),jr&&Ae.renderDefaultNorthPole&&S(zt,ko),yo&&Ae.renderDefaultSouthPole&&(Xn=F.ab.mat4.scale(F.ab.mat4.create(),Xn,[1,-1,1]),S(zt,Uo))}}}}(Ae,Oe,Fe,Ve,qe);else{const pt=Ae.context,vt=pt.gl;let zt,ri;const xi=Ae.shadowRenderer,bi=eo(Ae,Ae.longestCutoffRange),d=F=>{if(ri===F)return;const Oe=[];Oe.push(Pd[F]),bi.shouldRenderCutoff&&Oe.push("RENDER_CUTOFF"),xi&&(Oe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),xi.useNormalOffset&&Oe.push("NORMAL_OFFSET")),zt=Ae.getOrCreateProgram("terrainRaster",{defines:Oe}),ri=F},wi=Ae.colorModeForRenderPass(),dr=new Bi(vt.LEQUAL,Bi.ReadWrite,Ae.depthRangeFor3D);Ad.update(qe);const jr=Ae.transform,Qr=Fs(jr.zoom,Oe.exaggeration(),Oe.sourceCache._source.tileSize);let Xn=[0,0,0];if(xi){const F=Ae.style.directionalLight,Oe=Ae.style.ambientLight;F&&Oe&&(Xn=no(Ae.style,F,Oe))}{ri=-1;const ho=vt.TRIANGLES,[yo,zo]=[Oe.gridIndexBuffer,Oe.gridSegments];for(const ri of Ve){const Ve=Fe.getTile(ri),ko=Ui.disabled,Uo=Oe.prevTerrainTileForTile[ri.key],ia=Oe.terrainTileForTile[ri.key];Ps(Uo,ia)&&Ad.newMorphing(ri.key,Uo,ia,qe,250),pt.activeTexture.set(vt.TEXTURE0),Ve.texture&&Ve.texture.bind(vt.LINEAR,vt.CLAMP_TO_EDGE);const _a=Ad.getMorphValuesForProxy(ri.key),Ma=_a?1:0;let Ea;_a&&(Ea={morphing:{srcDemTile:_a.from,dstDemTile:_a.to,phase:F.cB(_a.phase)}});const Ia=As(ri.projMatrix,ks(ri.canonical,jr.renderWorldCopies)?Qr/10:Qr,Xn);if(d(Ma),!zt)continue;Oe.setupElevationDraw(Ve,zt,Ea);const rl=ri.toUnwrapped();xi&&xi.setupShadows(rl,zt),Ae.uploadCommonUniforms(pt,zt,rl,null,bi),zt.draw(Ae,ho,dr,ko,wi,Vi.backCCW,Ia,"terrain_raster",Oe.gridBuffer,yo,zo)}}}}(Oe,this,this.proxySourceCache,Ae,this._updateTimestamp),this.renderingToTexture=!0,Oe.gpuTimingDeferredRenderEnd(),Ae.splice(0,Ae.length))}renderBatch(Ae){if(0===this._drapedRenderBatches.length)return Ae+1;this.renderingToTexture=!0;const Oe=this.painter,Fe=this.painter.context,Ve=this.proxySourceCache,qe=this.proxiedCoords[Ve.id],pt=this._drapedRenderBatches.shift(),vt=Oe.style.order,zt=[];let ri=0;for(const xi of qe){const qe=Ve.getTileByID(xi.proxyTileKey),bi=Ve.proxyCachedFBO[xi.key]?Ve.proxyCachedFBO[xi.key][Ae]:void 0,wi=void 0!==bi?Ve.renderCache[bi]:this.pool[ri++],dr=void 0!==bi;if(qe.texture=wi.tex,dr&&!wi.dirty){zt.push(qe.tileID);continue}let jr;Fe.bindFramebuffer.set(wi.fb.framebuffer),this.renderedToTile=!1,wi.dirty&&(Fe.clear({color:F.aj.transparent,stencil:0}),wi.dirty=!1);for(let F=pt.start;F<=pt.end;++F){const Ae=Oe.style._mergedLayers[vt[F]];if(Ae.isHidden(Oe.transform.zoom))continue;const Ve=Oe.style.getLayerSourceCache(Ae),qe=Ve?this.proxyToSource[xi.key][Ve.id]:[xi];if(!qe)continue;const pt=qe;Fe.viewport.set([0,0,wi.fb.width,wi.fb.height]),jr!==(Ve?Ve.id:null)&&(this._setupStencil(wi,qe,Ae,Ve),jr=Ve?Ve.id:null),Oe.renderLayer(Oe,Ve,Ae,pt)}if(0===this._drapedRenderBatches.length)for(const F of this._pendingGroundEffectLayers){const Ae=Oe.style._mergedLayers[vt[F]];if(Ae.isHidden(Oe.transform.zoom))continue;const Ve=Oe.style.getLayerSourceCache(Ae),qe=Ve?this.proxyToSource[xi.key][Ve.id]:[xi];if(!qe)continue;const pt=qe;Fe.viewport.set([0,0,wi.fb.width,wi.fb.height]),jr!==(Ve?Ve.id:null)&&(this._setupStencil(wi,qe,Ae,Ve),jr=Ve?Ve.id:null),Oe.renderLayer(Oe,Ve,Ae,pt)}this.renderedToTile?(wi.dirty=!0,zt.push(qe.tileID)):dr||--ri,5===ri&&(ri=0,this.renderToBackBuffer(zt))}return this.renderToBackBuffer(zt),this.renderingToTexture=!1,Fe.bindFramebuffer.set(null),Fe.viewport.set([0,0,Oe.width,Oe.height]),pt.end+1}postRender(){}isLayerOrderingCorrect(F){const Ae=F.order.length;let Oe=-1,Fe=Ae;for(let Ve=0;Ve<Ae;++Ve)this._style.isLayerDraped(F._mergedLayers[F.order[Ve]])?Oe=Math.max(Oe,Ve):Fe=Math.min(Fe,Ve);return Fe>Oe}getMinElevationBelowMSL(){let F=0;return this._visibleDemTiles.filter((F=>F.dem)).forEach((Ae=>{F=Math.min(F,Ae.dem.tree.minimums[0])})),0===F?F:(F-30)*this._exaggeration}raycast(F,Ae,Oe){if(!this._visibleDemTiles)return null;const Fe=this._visibleDemTiles.filter((F=>F.dem)).map((Fe=>{const Ve=Fe.tileID,qe=1<<Ve.overscaledZ,{x:pt,y:vt}=Ve.canonical,zt=pt/qe,ri=(pt+1)/qe,xi=vt/qe,bi=(vt+1)/qe;return{minx:zt,miny:xi,maxx:ri,maxy:bi,t:Fe.dem.tree.raycastRoot(zt,xi,ri,bi,F,Ae,Oe),tile:Fe}}));Fe.sort(((F,Ae)=>(null!==F.t?F.t:Number.MAX_VALUE)-(null!==Ae.t?Ae.t:Number.MAX_VALUE)));for(const Ve of Fe){if(null==Ve.t)return null;const Fe=Ve.tile.dem.tree.raycast(Ve.minx,Ve.miny,Ve.maxx,Ve.maxy,F,Ae,Oe);if(null!=Fe)return Fe}return null}_createFBO(){const Ae=this.painter.context,Oe=Ae.gl,Fe=this.drapeBufferSize;Ae.activeTexture.set(Oe.TEXTURE0);const Ve=new F.T(Ae,{width:Fe[0],height:Fe[1],data:null},Oe.RGBA8);Ve.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE);const qe=Ae.createFramebuffer(Fe[0],Fe[1],!0,null);return qe.colorAttachment.set(Ve.texture),qe.depthAttachment=new Ls(Ae,qe.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=Ae.createRenderbuffer(Ae.gl.DEPTH_STENCIL,Fe[0],Fe[1]),this._stencilRef=0,qe.depthAttachment.set(this._sharedDepthStencil),Ae.clear({stencil:0})):qe.depthAttachment.set(this._sharedDepthStencil),Ae.extTextureFilterAnisotropic&&Oe.texParameterf(Oe.TEXTURE_2D,Ae.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Ae.extTextureFilterAnisotropicMax),{fb:qe,tex:Ve,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache)return!0;if(this._style.hasLightTransitions())return!0;for(const F in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[F].hasTransition())return!0;return this._style.order.some((F=>{const Ae=this._style._mergedLayers[F],Oe=Ae.isHidden(this.painter.transform.zoom);return"hillshade"===Ae.type||"custom"===Ae.type?!Oe&&Ae.shouldRedrape():!Oe&&Ae.hasTransition()}))}_clearLineLayersFromRenderCache(){let Ae=!1;for(const F of this._style.getSources())if(F instanceof tt){Ae=!0;break}if(!Ae)return;const Oe={};for(let Ae=0;Ae<this._style.order.length;++Ae){const Fe=this._style._mergedLayers[this._style.order[Ae]],Ve=this._style.getLayerSourceCache(Fe);if(Ve&&!Oe[Ve.id]&&!Fe.isHidden(this.painter.transform.zoom)&&"line"===Fe.type&&Fe.widthExpression()instanceof F.a9){Oe[Ve.id]=!0;for(const F of this.proxyCoords){const Ae=this.proxyToSource[F.key][Ve.id];if(Ae)for(const F of Ae)this._clearRenderCacheForTile(Ve.id,F)}}}}_clearRasterLayersFromRenderCache(){let F=!1;for(const Ae in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[Ae]._source instanceof it){F=!0;break}if(!F)return;const Ae={};for(let F=0;F<this._style.order.length;++F){const Oe=this._style._mergedLayers[this._style.order[F]],Fe=this._style.getLayerSourceCache(Oe);if(!Fe||Ae[Fe.id])continue;if(Oe.isHidden(this.painter.transform.zoom)||"raster"!==Oe.type)continue;const Ve=Oe.paint.get("raster-fade-duration");for(const F of this.proxyCoords){const Ae=this.proxyToSource[F.key][Fe.id];if(Ae)for(const F of Ae){const Ae=Ns(Fe.getTile(F),Fe.findLoadedParent(F,0),Fe,this.painter.transform,Ve);(1!==Ae.opacity||0!==Ae.mix)&&this._clearRenderCacheForTile(Fe.id,F)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const Ae=this._style.order,Oe=Ae.length;if(0===Oe)return;const Fe=[];this._pendingGroundEffectLayers=[];let Ve,qe=0,pt=this._style._mergedLayers[Ae[qe]];for(;!this._style.isLayerDraped(pt)&&pt.isHidden(this.painter.transform.zoom)&&++qe<Oe;)pt=this._style._mergedLayers[Ae[qe]];for(;qe<Oe;++qe){const F=this._style._mergedLayers[Ae[qe]];F.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(F)?void 0===Ve&&(Ve=qe):("fill-extrusion"===F.type&&this._pendingGroundEffectLayers.push(qe),void 0!==Ve&&(Fe.push({start:Ve,end:qe-1}),Ve=void 0)))}if(void 0!==Ve&&Fe.push({start:Ve,end:qe-1}),0!==Fe.length){const Ae=Fe[Fe.length-1];this._pendingGroundEffectLayers.every((F=>F>Ae.end))||F.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=Fe}_setupRenderCache(F){const Ae=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,Ae.renderCache.length>Ae.renderCachePool.length){const F=Object.values(Ae.proxyCachedFBO);Ae.proxyCachedFBO={};for(let Oe=0;Oe<F.length;++Oe){const Fe=Object.values(F[Oe]);Ae.renderCachePool.push(...Fe)}}return}this._clearRasterLayersFromRenderCache();const Oe=this.proxyCoords,Fe=this._tilesDirty;for(let Ve=Oe.length-1;Ve>=0;Ve--){const qe=Oe[Ve];if(Ae.getTileByID(qe.key),void 0!==Ae.proxyCachedFBO[qe.key]){const Oe=F[qe.key],Ve=this.proxyToSource[qe.key];let pt=0;for(const F in Ve){const Ae=Ve[F],qe=Oe[F];if(!qe||qe.length!==Ae.length||Ae.some(((Ae,Oe)=>Ae!==qe[Oe]||Fe[F]&&Fe[F].hasOwnProperty(Ae.key)))){pt=-1;break}++pt}for(const F in Ae.proxyCachedFBO[qe.key])Ae.renderCache[Ae.proxyCachedFBO[qe.key][F]].dirty=pt<0||pt!==Object.values(Oe).length}}const Ve=[...this._drapedRenderBatches];Ve.sort(((F,Ae)=>Ae.end-Ae.start-(F.end-F.start)));for(const F of Ve)for(const Fe of Oe){if(Ae.proxyCachedFBO[Fe.key])continue;let Oe=Ae.renderCachePool.pop();void 0===Oe&&Ae.renderCache.length<50&&(Oe=Ae.renderCache.length,Ae.renderCache.push(this._createFBO())),void 0!==Oe&&(Ae.proxyCachedFBO[Fe.key]={},Ae.proxyCachedFBO[Fe.key][F.start]=Oe,Ae.renderCache[Oe].dirty=!0)}this._tilesDirty={}}_setupStencil(F,Ae,Oe,Fe){if(!Fe||!this._sourceTilesOverlap[Fe.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const Ve=this.painter.context,qe=Ve.gl;if(Ae.length<=1)return void(this._overlapStencilType=!1);let pt;if(Oe.isTileClipped())pt=Ae.length,this._overlapStencilMode.test={func:qe.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(Ae[0].overscaledZ>Ae[Ae.length-1].overscaledZ))return void(this._overlapStencilType=!1);pt=1,this._overlapStencilMode.test={func:qe.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+pt>255&&(Ve.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=pt,this._overlapStencilMode.ref=this._stencilRef,Oe.isTileClipped()&&this._renderTileClippingMasks(Ae,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(F){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[F.key]),this._overlapStencilMode):Ui.disabled}_renderTileClippingMasks(F,Ae){const Oe=this.painter,Fe=this.painter.context,Ve=Fe.gl;Oe._tileClippingMaskIDs={},Fe.setColorMode(ki.disabled),Fe.setDepthMode(Bi.disabled);const qe=Oe.getOrCreateProgram("clippingMask");for(const Fe of F){const F=Oe._tileClippingMaskIDs[Fe.key]=--Ae;qe.draw(Oe,Ve.TRIANGLES,Bi.disabled,new Ui({func:Ve.ALWAYS,mask:0},F,255,Ve.KEEP,Ve.KEEP,Ve.REPLACE),ki.disabled,Vi.disabled,Bs(Fe.projMatrix),"$clipping",Oe.tileExtentBuffer,Oe.quadTriangleIndexBuffer,Oe.tileExtentSegments)}}pointCoordinate(Ae){const Oe=this.painter.transform;if(Ae.x<0||Ae.x>Oe.width||Ae.y<0||Ae.y>Oe.height)return null;const Fe=[Ae.x,Ae.y,1,1];F.ab.vec4.transformMat4(Fe,Fe,Oe.pixelMatrixInverse),F.ab.vec4.scale(Fe,Fe,1/Fe[3]),Fe[0]/=Oe.worldSize,Fe[1]/=Oe.worldSize;const Ve=Oe._camera.position,qe=F.bH(1,Oe.center.lat),pt=[Ve[0],Ve[1],Ve[2]/qe,0],vt=F.ab.vec3.subtract([],Fe.slice(0,3),pt);F.ab.vec3.normalize(vt,vt);const zt=this.raycast(pt,vt,this._exaggeration);return null!==zt&&zt?(F.ab.vec3.scaleAndAdd(pt,pt,vt,zt),pt[3]=pt[2],pt[2]*=qe,pt):null}_setupProxiedCoordsForOrtho(Ae,Oe,Fe){if(Ae.getSource()instanceof F.aJ)return this._setupProxiedCoordsForImageSource(Ae,Oe,Fe);this._findCoveringTileCache[Ae.id]=this._findCoveringTileCache[Ae.id]||{};const Ve=this.proxiedCoords[Ae.id]=[],qe=this.proxyCoords;for(let F=0;F<qe.length;F++){const Oe=qe[F],pt=this._findTileCoveringTileID(Oe,Ae);if(pt){const F=this._createProxiedId(Oe,pt,Fe[Oe.key]&&Fe[Oe.key][Ae.id]);Ve.push(F),this.proxyToSource[Oe.key][Ae.id]=[F]}}let pt=!1;const vt=new Set;for(let F=0;F<Oe.length;F++){const qe=Ae.getTile(Oe[F]);if(!qe||!qe.hasData())continue;const zt=this._findTileCoveringTileID(qe.tileID,this.proxySourceCache);if(zt&&zt.tileID.canonical.z!==qe.tileID.canonical.z){const F=this.proxyToSource[zt.tileID.key][Ae.id],Oe=this._createProxiedId(zt.tileID,qe,Fe[zt.tileID.key]&&Fe[zt.tileID.key][Ae.id]);F?F.splice(F.length-1,0,Oe):this.proxyToSource[zt.tileID.key][Ae.id]=[Oe];const ri=this.proxyToSource[zt.tileID.key][Ae.id];vt.has(ri)||vt.add(ri),Ve.push(Oe),pt=!0}}if(this._sourceTilesOverlap[Ae.id]=pt,pt&&this._debugParams.sortTilesHiZFirst)for(const F of vt)F.sort(((F,Ae)=>Ae.overscaledZ-F.overscaledZ))}_setupProxiedCoordsForImageSource(Ae,Oe,Fe){if(!Ae.getSource().loaded())return;const Ve=this.proxiedCoords[Ae.id]=[],qe=this.proxyCoords,pt=Ae.getSource(),vt=pt.tileID;if(!vt)return;const zt=new F.P(vt.x,vt.y)._div(1<<vt.z),ri=pt.coordinates.map(F.aa.fromLngLat).reduce(((F,Ae)=>(F.min.x=Math.min(F.min.x,Ae.x-zt.x),F.min.y=Math.min(F.min.y,Ae.y-zt.y),F.max.x=Math.max(F.max.x,Ae.x-zt.x),F.max.y=Math.max(F.max.y,Ae.y-zt.y),F)),{min:new F.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new F.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),h=(Ae,Oe)=>{const Fe=Ae.wrap+Ae.canonical.x/(1<<Ae.canonical.z),Ve=Ae.canonical.y/(1<<Ae.canonical.z),qe=F.ag/(1<<Ae.canonical.z),pt=Oe.wrap+Oe.canonical.x/(1<<Oe.canonical.z),vt=Oe.canonical.y/(1<<Oe.canonical.z);return Fe+qe<pt+ri.min.x||Fe>pt+ri.max.x||Ve+qe<vt+ri.min.y||Ve>vt+ri.max.y};for(let F=0;F<qe.length;F++){const pt=qe[F];for(let F=0;F<Oe.length;F++){const qe=Ae.getTile(Oe[F]);if(!qe||!qe.hasData())continue;if(h(pt,qe.tileID))continue;const vt=this._createProxiedId(pt,qe,Fe[pt.key]&&Fe[pt.key][Ae.id]),zt=this.proxyToSource[pt.key][Ae.id];zt?zt.push(vt):this.proxyToSource[pt.key][Ae.id]=[vt],Ve.push(vt)}}}_createProxiedId(Ae,Oe,Fe){let Ve=this.orthoMatrix;if(Fe){const F=Fe.find((F=>F.key===Oe.tileID.key));if(F)return F}if(Oe.tileID.key!==Ae.key){const Fe=Ae.canonical.z-Oe.tileID.canonical.z;let qe,pt,vt;Ve=F.ab.mat4.create();const zt=Oe.tileID.wrap-Ae.wrap<<Ae.overscaledZ;Fe>0?(qe=F.ag>>Fe,pt=qe*((Oe.tileID.canonical.x<<Fe)-Ae.canonical.x+zt),vt=qe*((Oe.tileID.canonical.y<<Fe)-Ae.canonical.y)):(qe=F.ag<<-Fe,pt=F.ag*(Oe.tileID.canonical.x-(Ae.canonical.x+zt<<-Fe)),vt=F.ag*(Oe.tileID.canonical.y-(Ae.canonical.y<<-Fe))),F.ab.mat4.ortho(Ve,0,qe,0,qe,0,1),F.ab.mat4.translate(Ve,Ve,[pt,vt,0])}return new Gs(Oe.tileID,Ae.key,Ve)}_findTileCoveringTileID(Ae,Oe){let Fe=Oe.getTile(Ae);if(Fe&&Fe.hasData())return Fe;const Ve=this._findCoveringTileCache[Oe.id],qe=Ve[Ae.key];if(Fe=qe?Oe.getTileByID(qe):null,Fe&&Fe.hasData()||null===qe)return Fe;let pt=Fe?Fe.tileID:Ae,vt=pt.overscaledZ;const zt=Oe.getSource().minzoom,ri=[];if(!qe){const Ve=Oe.getSource().maxzoom;if(Ae.canonical.z>=Ve){const Fe=Ae.canonical.z-Ve;Oe.getSource().reparseOverscaled?(vt=Math.max(Ae.canonical.z+2,Oe.transform.tileZoom),pt=new F.aG(vt,Ae.wrap,Ve,Ae.canonical.x>>Fe,Ae.canonical.y>>Fe)):0!==Fe&&(vt=Ve,pt=new F.aG(vt,Ae.wrap,Ve,Ae.canonical.x>>Fe,Ae.canonical.y>>Fe))}pt.key!==Ae.key&&(ri.push(pt.key),Fe=Oe.getTile(pt))}const h=F=>{ri.forEach((Ae=>{Ve[Ae]=F})),ri.length=0};for(vt-=1;vt>=zt&&(!Fe||!Fe.hasData());vt--){Fe&&h(Fe.tileID.key);const F=pt.calculateScaledKey(vt);if(Fe=Oe.getTileByID(F),Fe&&Fe.hasData())break;const Ae=Ve[F];if(null===Ae)break;void 0===Ae?ri.push(F):Fe=Oe.getTileByID(Ae)}return h(Fe?Fe.tileID.key:null),Fe&&Fe.hasData()?Fe:null}findDEMTileFor(F){return this.enabled?this._findTileCoveringTileID(F,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(F,Ae){let Oe=this._tilesDirty[F];Oe||(Oe=this._tilesDirty[F]={}),Oe[Ae.key]=!0}}function qs(Ae,Oe,Fe){const Ve=function(Ae,Oe,Fe){const Ve=F.ab.vec3.dot(Oe,Ae),qe=F.ab.vec3.dot(Fe,[.2126,.7152,.0722]),a=(F,Ae,Oe)=>(1-Oe)*F+Oe*Ae,pt=a(1-.3*Math.min(qe,1),1,Math.min(Ve+1,1));return a(.92,1,Math.asin(F.aw(Oe[2],-1,1))/Math.PI+.5)*pt}(Ae,[0,0,1],Oe),qe=[0,0,0];F.ab.vec3.scale(qe,Fe.slice(0,3),Ve);const pt=[0,0,0];F.ab.vec3.scale(pt,Oe.slice(0,3),Ae[2]);const vt=[0,0,0];return F.ab.vec3.add(vt,qe,pt),F.cf(vt)}const zd=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],kd=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","model","symbol"];class Ws{static cacheKey(F,Ae,Oe,Fe){let Ve=`${Ae}${Fe?Fe.cacheKey:""}`;for(const Ae of Oe)F.usedDefines.includes(Ae)&&(Ve+=`/${Ae}`);return Ve}constructor(Ae,Oe,Fe,Ve,qe,pt){const vt=Ae.gl;this.program=vt.createProgram(),this.configuration=Ve,this.name=Oe,this.fixedDefines=[...pt];const zt=Ve?Ve.getBinderAttributes():[],ri=(Fe.staticAttributes||[]).concat(zt);let xi=Ve?Ve.defines():[];xi=xi.concat(pt.map((F=>`#define ${F}`)));const bi="#version 300 es\n";let wi=bi+xi.concat("precision mediump float;",md,dd.fragmentSource).join("\n");for(const F of Fe.fragmentIncludes)wi+=`\n${cd[F]}`;wi+=`\n${Fe.fragmentSource}`;let dr=bi+xi.concat("precision highp float;",md,dd.vertexSource).join("\n");for(const F of Fe.vertexIncludes)dr+=`\n${cd[F]}`;this.forceManualRenderingForInstanceIDShaders=Ae.forceManualRenderingForInstanceIDShaders&&-1!==Fe.vertexSource.indexOf("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&(dr+="\nuniform int u_instanceID;\n"),dr+=`\n${Fe.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(dr=dr.replaceAll("gl_InstanceID","u_instanceID"));const jr=vt.createShader(vt.FRAGMENT_SHADER);if(vt.isContextLost())return void(this.failedToCreate=!0);vt.shaderSource(jr,wi),vt.compileShader(jr),vt.attachShader(this.program,jr);const Qr=vt.createShader(vt.VERTEX_SHADER);if(vt.isContextLost())this.failedToCreate=!0;else{vt.shaderSource(Qr,dr),vt.compileShader(Qr),vt.attachShader(this.program,Qr),this.attributes={},this.numAttributes=ri.length;for(let F=0;F<this.numAttributes;F++)if(ri[F]){const Ae=ri[F].startsWith("a_")?ri[F]:`a_${ri[F]}`;vt.bindAttribLocation(this.program,F,Ae),this.attributes[Ae]=F}vt.linkProgram(this.program),vt.deleteShader(Qr),vt.deleteShader(jr),this.fixedUniforms=qe(Ae),this.binderUniforms=Ve?Ve.getUniforms(Ae):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(Ae=>({u_instanceID:new F.bN(Ae)}))(Ae)),(pt.includes("TERRAIN")||-1!==Oe.indexOf("symbol")||-1!==Oe.indexOf("circle"))&&(this.terrainUniforms=(Ae=>({u_dem:new F.bN(Ae),u_dem_prev:new F.bN(Ae),u_dem_tl:new F.bK(Ae),u_dem_scale:new F.bM(Ae),u_dem_tl_prev:new F.bK(Ae),u_dem_scale_prev:new F.bM(Ae),u_dem_size:new F.bM(Ae),u_dem_lerp:new F.bM(Ae),u_exaggeration:new F.bM(Ae),u_depth:new F.bN(Ae),u_depth_size_inv:new F.bK(Ae),u_depth_range_unpack:new F.bK(Ae),u_occluder_half_size:new F.bM(Ae),u_occlusion_depth_offset:new F.bM(Ae),u_meter_to_dem:new F.bM(Ae),u_label_plane_matrix_inv:new F.bJ(Ae)}))(Ae)),pt.includes("GLOBE")&&(this.globeUniforms=(Ae=>({u_tile_tl_up:new F.bL(Ae),u_tile_tr_up:new F.bL(Ae),u_tile_br_up:new F.bL(Ae),u_tile_bl_up:new F.bL(Ae),u_tile_up_scale:new F.bM(Ae)}))(Ae)),pt.includes("FOG")&&(this.fogUniforms=(Ae=>({u_fog_matrix:new F.bJ(Ae),u_fog_range:new F.bK(Ae),u_fog_color:new F.ca(Ae),u_fog_horizon_blend:new F.bM(Ae),u_fog_vertical_limit:new F.bK(Ae),u_fog_temporal_offset:new F.bM(Ae),u_frustum_tl:new F.bL(Ae),u_frustum_tr:new F.bL(Ae),u_frustum_br:new F.bL(Ae),u_frustum_bl:new F.bL(Ae),u_globe_pos:new F.bL(Ae),u_globe_radius:new F.bM(Ae),u_globe_transition:new F.bM(Ae),u_is_globe:new F.bN(Ae),u_viewport:new F.bK(Ae)}))(Ae)),pt.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(Ae=>({u_cutoff_params:new F.ca(Ae)}))(Ae)),pt.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(Ae=>({u_lighting_ambient_color:new F.bL(Ae),u_lighting_directional_dir:new F.bL(Ae),u_lighting_directional_color:new F.bL(Ae),u_ground_radiance:new F.bL(Ae)}))(Ae)),pt.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(Ae=>({u_light_matrix_0:new F.bJ(Ae),u_light_matrix_1:new F.bJ(Ae),u_fade_range:new F.bK(Ae),u_shadow_normal_offset:new F.bL(Ae),u_shadow_intensity:new F.bM(Ae),u_shadow_texel_size:new F.bM(Ae),u_shadow_map_resolution:new F.bM(Ae),u_shadow_direction:new F.bL(Ae),u_shadow_bias:new F.bL(Ae),u_shadowmap_0:new F.bN(Ae),u_shadowmap_1:new F.bN(Ae)}))(Ae))}}setTerrainUniformValues(F,Ae){if(!this.terrainUniforms)return;const Oe=this.terrainUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Ae)Oe[F]&&Oe[F].set(this.program,F,Ae[F])}}setGlobeUniformValues(F,Ae){if(!this.globeUniforms)return;const Oe=this.globeUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Ae)Oe[F]&&Oe[F].set(this.program,F,Ae[F])}}setFogUniformValues(F,Ae){if(!this.fogUniforms)return;const Oe=this.fogUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Ae)Oe[F].set(this.program,F,Ae[F])}}setCutoffUniformValues(F,Ae){if(!this.cutoffUniforms)return;const Oe=this.cutoffUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Ae)Oe[F].set(this.program,F,Ae[F])}}setLightsUniformValues(F,Ae){if(!this.lightsUniforms)return;const Oe=this.lightsUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Ae)Oe[F].set(this.program,F,Ae[F])}}setShadowUniformValues(F,Ae){if(this.failedToCreate||!this.shadowUniforms)return;const Oe=this.shadowUniforms;F.program.set(this.program);for(const F in Ae)Oe[F].set(this.program,F,Ae[F])}_drawDebugWireframe(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi){const bi=Ae.options.wireframe;if(!1===bi.terrain&&!1===bi.layers2D&&!1===bi.layers3D)return;const wi=Ae.context;if(!(()=>!(!bi.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!bi.layers2D||Ae._terrain&&Ae._terrain.renderingToTexture||!zd.includes(this.name))||!(!bi.layers3D||!kd.includes(this.name)))())return;const dr=wi.gl,jr=Ae.wireframeDebugCache.getLinesFromTrianglesBuffer(Ae.frameCounter,qe,wi);if(!jr)return;const Qr=[...this.fixedDefines];Qr.push("DEBUG_WIREFRAME");const Xn=Ae.getOrCreateProgram(this.name,{config:this.configuration,defines:Qr});wi.program.set(Xn.program);const g=(F,Ae,Oe)=>{if(Ae[F]&&Oe[F])for(const Fe in Ae[F])Oe[F][Fe]&&Oe[F][Fe].set(Oe.program,Fe,Ae[F][Fe].current)};ri&&ri.setUniforms(Xn.program,wi,Xn.binderUniforms,vt,{zoom:zt}),g("fixedUniforms",this,Xn),g("terrainUniforms",this,Xn),g("globeUniforms",this,Xn),g("fogUniforms",this,Xn),g("lightsUniforms",this,Xn),g("shadowUniforms",this,Xn),jr.bind(),wi.setColorMode(new ki([dr.ONE,dr.ONE_MINUS_SRC_ALPHA,dr.ZERO,dr.ONE],F.aj.transparent,[!0,!0,!0,!1])),wi.setDepthMode(new Bi(Oe.func===dr.LESS?dr.LEQUAL:Oe.func,Bi.ReadOnly,Oe.range)),wi.setStencilMode(Ui.disabled);const ho=3*pt.primitiveLength*2,yo=3*pt.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const F=xi||1;for(let Ae=0;Ae<F;++Ae)Xn.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Ae),dr.drawElements(dr.LINES,ho,dr.UNSIGNED_SHORT,yo)}else xi&&xi>1?dr.drawElementsInstanced(dr.LINES,ho,dr.UNSIGNED_SHORT,yo,xi):dr.drawElements(dr.LINES,ho,dr.UNSIGNED_SHORT,yo);qe.bind(),wi.program.set(this.program),wi.setDepthMode(Oe),wi.setStencilMode(Fe),wi.setColorMode(Ve)}checkUniforms(F,Ae,Oe){if(this.fixedDefines.includes(Ae))for(const Fe of Object.keys(Oe))if(!Oe[Fe].initialized)throw new Error(`Program '${this.name}', from draw '${F}': uniform ${Fe} not set but required by ${Ae} being defined`)}draw(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr){const Xn=F.context,ho=Xn.gl;if(this.failedToCreate)return;Xn.program.set(this.program),Xn.setDepthMode(Oe),Xn.setStencilMode(Fe),Xn.setColorMode(Ve),Xn.setCullFace(qe);for(const F of Object.keys(this.fixedUniforms))this.fixedUniforms[F].set(this.program,F,pt[F]);dr&&dr.setUniforms(this.program,Xn,this.binderUniforms,bi,{zoom:wi});const yo={[ho.POINTS]:1,[ho.LINES]:2,[ho.TRIANGLES]:3,[ho.LINE_STRIP]:1}[Ae];this.checkUniforms(vt,"RENDER_SHADOWS",this.shadowUniforms);const zo=Qr&&Qr>0?1:void 0;for(const qe of xi.get()){const pt=qe.vaos||(qe.vaos={});if((pt[vt]||(pt[vt]=new Vo)).bind(Xn,this,zt,dr?dr.getPaintVertexBuffers():[],ri,qe.vertexOffset,jr||[],zo),this.forceManualRenderingForInstanceIDShaders){const F=Qr||1;for(let Oe=0;Oe<F;++Oe)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Oe),ri?ho.drawElements(Ae,qe.primitiveLength*yo,ho.UNSIGNED_SHORT,qe.primitiveOffset*yo*2):ho.drawArrays(Ae,qe.vertexOffset,qe.vertexLength)}else Qr&&Qr>1?ho.drawElementsInstanced(Ae,qe.primitiveLength*yo,ho.UNSIGNED_SHORT,qe.primitiveOffset*yo*2,Qr):ri?ho.drawElements(Ae,qe.primitiveLength*yo,ho.UNSIGNED_SHORT,qe.primitiveOffset*yo*2):ho.drawArrays(Ae,qe.vertexOffset,qe.vertexLength);Ae===ho.TRIANGLES&&ri&&this._drawDebugWireframe(F,Oe,Fe,Ve,ri,qe,bi,wi,dr,Qr)}}}function $s(Ae,Oe){const Fe=Math.pow(2,Oe.tileID.overscaledZ),Ve=Oe.tileSize*Math.pow(2,Ae.transform.tileZoom)/Fe,qe=Ve*(Oe.tileID.canonical.x+Oe.tileID.wrap*Fe),pt=Ve*Oe.tileID.canonical.y;return{u_image:0,u_texsize:Oe.imageAtlasTexture?Oe.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/F.ar(Oe,1,Ae.transform.tileZoom),u_pixel_coord_upper:[qe>>16,pt>>16],u_pixel_coord_lower:[65535&qe,65535&pt]}}const Fd={terrain:0,flat:1},Nd=F.ab.mat4.create(),Ys=(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo)=>{const zo=Oe.style.light,ko=zo.properties.get("position"),Uo=[ko.x,ko.y,ko.z],ia=F.ab.mat3.create();"viewport"===zo.properties.get("anchor")&&(F.ab.mat3.fromRotation(ia,-Oe.transform.angle),F.ab.vec3.transformMat3(Uo,Uo,ia));const _a=zo.properties.get("color"),Ma=Oe.transform,Ea={u_matrix:Ae,u_lightpos:Uo,u_lightintensity:zo.properties.get("intensity"),u_lightcolor:[_a.r,_a.g,_a.b],u_vertical_gradient:+Fe,u_opacity:Ve,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Nd,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:Fd[xi],u_base_type:Fd[bi],u_ao:qe,u_edge_radius:pt,u_width_scale:vt,u_flood_light_color:Qr,u_vertical_scale:Xn,u_flood_light_intensity:ho,u_ground_shadow_factor:yo};return"globe"===Ma.projection.name&&(Ea.u_tile_id=[zt.canonical.x,zt.canonical.y,1<<zt.canonical.z],Ea.u_zoom_transition=wi,Ea.u_inv_rot_matrix=jr,Ea.u_merc_center=dr,Ea.u_up_dir=Ma.projection.upVector(new F.bT(0,0,0),dr[0]*F.ag,dr[1]*F.ag),Ea.u_height_lift=ri),Ea},Js=(F,Ae,Oe,Fe,Ve,qe)=>({u_matrix:F,u_edge_radius:Ae,u_width_scale:Oe,u_vertical_scale:Fe,u_height_type:Fd[Ve],u_base_type:Fd[qe]}),Qs=(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho)=>{const yo=Ys(Ae,Oe,Fe,Ve,qe,pt,vt,zt,xi,bi,wi,dr,jr,Qr,Xn,ho,1,[0,0,0]),zo={u_height_factor:-Math.pow(2,zt.overscaledZ)/ri.tileSize/8};return F.l(yo,$s(Oe,ri),zo)},er=(F,Ae)=>({u_matrix:F,u_emissive_strength:Ae}),tr=(Ae,Oe,Fe,Ve)=>F.l(er(Ae,Oe),$s(Fe,Ve)),ir=(F,Ae,Oe)=>({u_matrix:F,u_world:Oe,u_emissive_strength:Ae}),or=(Ae,Oe,Fe,Ve,qe)=>F.l(tr(Ae,Oe,Fe,Ve),{u_world:qe}),sr=(Ae,Oe,Fe,Ve)=>{const qe=F.ag/Fe.tileSize;return{u_matrix:Ae,u_camera_to_center_distance:Oe.getCameraToCenterDistance(Ve),u_extrude_scale:[Oe.pixelsToGLUnits[0]/qe,Oe.pixelsToGLUnits[1]/qe]}},rr=(F,Ae,Oe=1)=>({u_matrix:F,u_color:Ae.toRenderColor(null),u_overlay:0,u_overlay_scale:Oe}),Vd=F.ab.mat4.create(),nr=(Ae,Oe,Fe,Ve,qe,pt,vt)=>{const zt=Ae.transform,ri="globe"===zt.projection.name,xi=ri?F.cN(zt.zoom,Oe.canonical)*zt._pixelsPerMercatorPixel:F.ar(Fe,1,pt),bi={u_matrix:Oe.projMatrix,u_extrude_scale:xi,u_intensity:vt,u_inv_rot_matrix:Vd,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(ri){bi.u_inv_rot_matrix=Ve,bi.u_merc_center=qe,bi.u_tile_id=[Oe.canonical.x,Oe.canonical.y,1<<Oe.canonical.z],bi.u_zoom_transition=F.ae(zt.zoom);const Ae=qe[0]*F.ag,Fe=qe[1]*F.ag;bi.u_up_dir=zt.projection.upVector(new F.bT(0,0,0),Ae,Fe)}return bi};function lr(F,[Ae,Oe,Fe,Ve],[qe,pt]){if(qe===pt)return[0,0,0,0];const vt=255*(F-1)/(F*(pt-qe));return[Ae*vt,Oe*vt,Fe*vt,Ve*vt]}function cr(F,Ae,[Oe,Fe]){return Oe===Fe?0:.5/F+(Ae-Oe)*(F-1)/(F*(Fe-Oe))}const hr=(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko,Uo)=>({u_matrix:Ae,u_normalize_matrix:Oe,u_globe_matrix:Fe,u_merc_matrix:Ve,u_grid_matrix:qe,u_tl_parent:pt,u_scale_parent:xi,u_fade_t:bi.mix,u_opacity:bi.opacity*wi.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:wi.paint.get("raster-brightness-min"),u_brightness_high:wi.paint.get("raster-brightness-max"),u_saturation_factor:F.cO(wi.paint.get("raster-saturation")),u_contrast_factor:F.cP(wi.paint.get("raster-contrast")),u_spin_weights:ur(wi.paint.get("raster-hue-rotate")),u_perspective_transform:dr,u_raster_elevation:jr,u_zoom_transition:vt,u_merc_center:zt,u_cutoff_params:ri,u_colorization_mix:lr(F.cQ,Xn,yo),u_colorization_offset:cr(F.cQ,ho,yo),u_color_ramp:Qr,u_texture_offset:[ko/(zo+2*ko),zo/(zo+2*ko)],u_texture_res:[zo+2*ko,zo+2*ko],u_emissive_strength:Uo});function ur(F){F*=Math.PI/180;const Ae=Math.sin(F),Oe=Math.cos(F);return[(2*Oe+1)/3,(-Math.sqrt(3)*Ae-Oe+1)/3,(Math.sqrt(3)*Ae-Oe+1)/3]}const Gd=.05,_r=(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi)=>({u_matrix:F,u_normalize_matrix:Ae,u_globe_matrix:Oe,u_merc_matrix:Fe,u_grid_matrix:Ve,u_tl_parent:qe,u_scale_parent:ri,u_fade_t:xi.mix,u_opacity:xi.opacity,u_image0:0,u_image1:1,u_raster_elevation:bi,u_zoom_transition:pt,u_merc_center:vt,u_cutoff_params:zt}),pr=(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri)=>({u_particle_texture:F,u_particle_texture_side_len:Ae,u_tile_offset:Oe,u_velocity:Fe,u_color_ramp:qe,u_velocity_res:Ve,u_max_speed:pt,u_uv_offset:vt,u_data_scale:[255*zt[0],255*zt[1]],u_data_offset:ri,u_particle_pos_scale:1.1,u_particle_pos_offset:[Gd,Gd]}),fr=(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri)=>({u_particle_texture:F,u_particle_texture_side_len:Ae,u_velocity:Oe,u_velocity_res:Fe,u_max_speed:Ve,u_speed_factor:qe,u_reset_rate:pt,u_rand_seed:Math.random(),u_uv_offset:vt,u_data_scale:[255*zt[0],255*zt[1]],u_data_offset:ri,u_particle_pos_scale:1.1,u_particle_pos_offset:[Gd,Gd]}),Yd=F.ab.mat4.create(),gr=(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo,ko,Uo,ia)=>{const _a=qe.transform,Ma={u_is_size_zoom_constant:+("constant"===Ae||"source"===Ae),u_is_size_feature_constant:+("constant"===Ae||"camera"===Ae),u_size_t:Oe?Oe.uSizeT:0,u_size:Oe?Oe.uSize:0,u_camera_to_center_distance:_a.getCameraToCenterDistance(zo),u_rotate_symbol:+Fe,u_aspect_ratio:_a.width/_a.height,u_fade_change:qe.options.fadeDuration?qe.symbolFadeChange:1,u_matrix:pt,u_label_plane_matrix:vt,u_coord_matrix:zt,u_is_text:+xi,u_elevation_from_sea:ri?1:0,u_pitch_with_map:+Ve,u_texsize:bi,u_texsize_icon:wi,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Yd,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Yd,u_up_vector:[0,-1,0],u_color_adj_mat:ko,u_icon_transition:Uo||0,u_gamma_scale:Ve?qe.transform.getCameraToCenterDistance(zo)*Math.cos(qe.terrain?0:qe.transform._pitch):1,u_device_pixel_ratio:F.q.devicePixelRatio,u_is_halo:+dr,u_scale_factor:ia||1};return"globe"===zo.name&&(Ma.u_tile_id=[jr.canonical.x,jr.canonical.y,1<<jr.canonical.z],Ma.u_zoom_transition=Qr,Ma.u_inv_rot_matrix=ho,Ma.u_merc_center=Xn,Ma.u_camera_forward=_a._camera.forward(),Ma.u_ecef_origin=F.cR(_a.globeMatrix,jr.toUnwrapped()),Ma.u_tile_matrix=Float32Array.from(_a.globeMatrix),Ma.u_up_vector=yo),Ma},vr=(F,Ae,Oe,Fe)=>({u_matrix:F,u_emissive_strength:Ae,u_opacity:Oe,u_color:Fe}),yr=(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri)=>F.l(function(Ae,Oe,Fe,Ve,qe,pt){const{width:vt,height:zt}=Ve.imageManager.getPixelSize(Oe),ri=Math.pow(2,pt.tileID.overscaledZ),xi=pt.tileSize*Math.pow(2,Ve.transform.tileZoom)/ri,bi=xi*(pt.tileID.canonical.x+pt.tileID.wrap*ri),wi=xi*pt.tileID.canonical.y;return{u_image:0,u_pattern_tl:Fe.tl,u_pattern_br:Fe.br,u_texsize:[vt,zt],u_pattern_size:Fe.displaySize,u_pattern_units_to_pixels:qe?[Ve.transform.width,-1*Ve.transform.height]:[1/F.ar(pt,1,Ve.transform.tileZoom),1/F.ar(pt,1,Ve.transform.tileZoom)],u_pixel_coord_upper:[bi>>16,wi>>16],u_pixel_coord_lower:[65535&bi,65535&wi]}}(0,pt,vt,Ve,zt,ri),{u_matrix:Ae,u_emissive_strength:Oe,u_opacity:Fe}),lp=new Float32Array(F.ab.mat4.identity([])),br=(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr=[0,0,0],Qr)=>{const Xn=qe.style.light,ho=Xn.properties.get("position"),yo=[-ho.x,-ho.y,ho.z],zo=F.ab.mat3.create();"viewport"===Xn.properties.get("anchor")&&(F.ab.mat3.fromRotation(zo,-qe.transform.angle),F.ab.vec3.transformMat3(yo,yo,zo));const ko="MASK"===bi.alphaMode,Uo=Xn.properties.get("color").toRenderColor(null),ia=dr.paint.get("model-ambient-occlusion-intensity"),_a=dr.paint.get("model-color").constantOr(F.aj.white).toRenderColor(null),Ma=dr.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:Ae,u_lighting_matrix:Oe,u_normal_matrix:Fe,u_node_matrix:Ve||lp,u_lightpos:yo,u_lightintensity:Xn.properties.get("intensity"),u_lightcolor:[Uo.r,Uo.g,Uo.b],u_camera_pos:jr,u_opacity:pt,u_baseTextureIsAlpha:0,u_alphaMask:+ko,u_alphaCutoff:bi.alphaCutoff,u_baseColorFactor:[vt.r,vt.g,vt.b,vt.a],u_emissiveFactor:[zt[0],zt[1],zt[2],1],u_metallicFactor:ri,u_roughnessFactor:xi,u_baseColorTexture:Oh.BaseColor,u_metallicRoughnessTexture:Oh.MetallicRoughness,u_normalTexture:Oh.Normal,u_occlusionTexture:Oh.Occlusion,u_emissionTexture:Oh.Emission,u_lutTexture:Oh.LUT,u_color_mix:[_a.r,_a.g,_a.b,Ma],u_aoIntensity:ia,u_emissive_strength:wi,u_occlusionTextureTransform:Qr||[0,0,0,0]}},wr=(F,Ae=lp,Oe=lp)=>({u_matrix:F,u_instance:Ae,u_node_matrix:Oe}),up={fillExtrusion:Ae=>({u_matrix:new F.bJ(Ae),u_lightpos:new F.bL(Ae),u_lightintensity:new F.bM(Ae),u_lightcolor:new F.bL(Ae),u_vertical_gradient:new F.bM(Ae),u_opacity:new F.bM(Ae),u_edge_radius:new F.bM(Ae),u_width_scale:new F.bM(Ae),u_ao:new F.bK(Ae),u_height_type:new F.bN(Ae),u_base_type:new F.bN(Ae),u_tile_id:new F.bL(Ae),u_zoom_transition:new F.bM(Ae),u_inv_rot_matrix:new F.bJ(Ae),u_merc_center:new F.bK(Ae),u_up_dir:new F.bL(Ae),u_height_lift:new F.bM(Ae),u_flood_light_color:new F.bL(Ae),u_vertical_scale:new F.bM(Ae),u_flood_light_intensity:new F.bM(Ae),u_ground_shadow_factor:new F.bL(Ae)}),fillExtrusionDepth:Ae=>({u_matrix:new F.bJ(Ae),u_edge_radius:new F.bM(Ae),u_width_scale:new F.bM(Ae),u_vertical_scale:new F.bM(Ae),u_height_type:new F.bN(Ae),u_base_type:new F.bN(Ae)}),fillExtrusionPattern:Ae=>({u_matrix:new F.bJ(Ae),u_lightpos:new F.bL(Ae),u_lightintensity:new F.bM(Ae),u_lightcolor:new F.bL(Ae),u_vertical_gradient:new F.bM(Ae),u_height_factor:new F.bM(Ae),u_edge_radius:new F.bM(Ae),u_width_scale:new F.bM(Ae),u_ao:new F.bK(Ae),u_height_type:new F.bN(Ae),u_base_type:new F.bN(Ae),u_tile_id:new F.bL(Ae),u_zoom_transition:new F.bM(Ae),u_inv_rot_matrix:new F.bJ(Ae),u_merc_center:new F.bK(Ae),u_up_dir:new F.bL(Ae),u_height_lift:new F.bM(Ae),u_image:new F.bN(Ae),u_texsize:new F.bK(Ae),u_pixel_coord_upper:new F.bK(Ae),u_pixel_coord_lower:new F.bK(Ae),u_tile_units_to_pixels:new F.bM(Ae),u_opacity:new F.bM(Ae)}),fillExtrusionGroundEffect:Ae=>({u_matrix:new F.bJ(Ae),u_opacity:new F.bM(Ae),u_ao_pass:new F.bM(Ae),u_meter_to_tile:new F.bM(Ae),u_ao:new F.bK(Ae),u_flood_light_intensity:new F.bM(Ae),u_flood_light_color:new F.bL(Ae),u_attenuation:new F.bM(Ae),u_edge_radius:new F.bM(Ae),u_fb:new F.bN(Ae),u_fb_size:new F.bM(Ae),u_dynamic_offset:new F.bM(Ae)}),fill:Ae=>({u_matrix:new F.bJ(Ae),u_emissive_strength:new F.bM(Ae)}),fillPattern:Ae=>({u_matrix:new F.bJ(Ae),u_emissive_strength:new F.bM(Ae),u_image:new F.bN(Ae),u_texsize:new F.bK(Ae),u_pixel_coord_upper:new F.bK(Ae),u_pixel_coord_lower:new F.bK(Ae),u_tile_units_to_pixels:new F.bM(Ae)}),fillOutline:Ae=>({u_matrix:new F.bJ(Ae),u_emissive_strength:new F.bM(Ae),u_world:new F.bK(Ae)}),fillOutlinePattern:Ae=>({u_matrix:new F.bJ(Ae),u_emissive_strength:new F.bM(Ae),u_world:new F.bK(Ae),u_image:new F.bN(Ae),u_texsize:new F.bK(Ae),u_pixel_coord_upper:new F.bK(Ae),u_pixel_coord_lower:new F.bK(Ae),u_tile_units_to_pixels:new F.bM(Ae)}),circle:F.cS,collisionBox:Ae=>({u_matrix:new F.bJ(Ae),u_camera_to_center_distance:new F.bM(Ae),u_extrude_scale:new F.bK(Ae)}),collisionCircle:Ae=>({u_matrix:new F.bJ(Ae),u_inv_matrix:new F.bJ(Ae),u_camera_to_center_distance:new F.bM(Ae),u_viewport_size:new F.bK(Ae)}),debug:Ae=>({u_color:new F.cz(Ae),u_matrix:new F.bJ(Ae),u_overlay:new F.bN(Ae),u_overlay_scale:new F.bM(Ae)}),clippingMask:Ae=>({u_matrix:new F.bJ(Ae)}),heatmap:Ae=>({u_extrude_scale:new F.bM(Ae),u_intensity:new F.bM(Ae),u_matrix:new F.bJ(Ae),u_inv_rot_matrix:new F.bJ(Ae),u_merc_center:new F.bK(Ae),u_tile_id:new F.bL(Ae),u_zoom_transition:new F.bM(Ae),u_up_dir:new F.bL(Ae)}),heatmapTexture:Ae=>({u_image:new F.bN(Ae),u_color_ramp:new F.bN(Ae),u_opacity:new F.bM(Ae)}),hillshade:Ae=>({u_matrix:new F.bJ(Ae),u_image:new F.bN(Ae),u_latrange:new F.bK(Ae),u_light:new F.bK(Ae),u_shadow:new F.cz(Ae),u_highlight:new F.cz(Ae),u_emissive_strength:new F.bM(Ae),u_accent:new F.cz(Ae)}),hillshadePrepare:Ae=>({u_matrix:new F.bJ(Ae),u_image:new F.bN(Ae),u_dimension:new F.bK(Ae),u_zoom:new F.bM(Ae)}),line:F.cT,linePattern:F.cU,raster:Ae=>({u_matrix:new F.bJ(Ae),u_normalize_matrix:new F.bJ(Ae),u_globe_matrix:new F.bJ(Ae),u_merc_matrix:new F.bJ(Ae),u_grid_matrix:new F.cA(Ae),u_tl_parent:new F.bK(Ae),u_scale_parent:new F.bM(Ae),u_fade_t:new F.bM(Ae),u_opacity:new F.bM(Ae),u_image0:new F.bN(Ae),u_image1:new F.bN(Ae),u_brightness_low:new F.bM(Ae),u_brightness_high:new F.bM(Ae),u_saturation_factor:new F.bM(Ae),u_contrast_factor:new F.bM(Ae),u_spin_weights:new F.bL(Ae),u_perspective_transform:new F.bK(Ae),u_raster_elevation:new F.bM(Ae),u_zoom_transition:new F.bM(Ae),u_merc_center:new F.bK(Ae),u_cutoff_params:new F.ca(Ae),u_colorization_mix:new F.ca(Ae),u_colorization_offset:new F.bM(Ae),u_color_ramp:new F.bN(Ae),u_texture_offset:new F.bK(Ae),u_texture_res:new F.bK(Ae),u_emissive_strength:new F.bM(Ae)}),rasterParticle:Ae=>({u_matrix:new F.bJ(Ae),u_normalize_matrix:new F.bJ(Ae),u_globe_matrix:new F.bJ(Ae),u_merc_matrix:new F.bJ(Ae),u_grid_matrix:new F.cA(Ae),u_tl_parent:new F.bK(Ae),u_scale_parent:new F.bM(Ae),u_fade_t:new F.bM(Ae),u_opacity:new F.bM(Ae),u_image0:new F.bN(Ae),u_image1:new F.bN(Ae),u_raster_elevation:new F.bM(Ae),u_zoom_transition:new F.bM(Ae),u_merc_center:new F.bK(Ae),u_cutoff_params:new F.ca(Ae)}),rasterParticleTexture:Ae=>({u_texture:new F.bN(Ae),u_opacity:new F.bM(Ae)}),rasterParticleDraw:Ae=>({u_particle_texture:new F.bN(Ae),u_particle_texture_side_len:new F.bM(Ae),u_tile_offset:new F.bK(Ae),u_velocity:new F.bN(Ae),u_color_ramp:new F.bN(Ae),u_velocity_res:new F.bK(Ae),u_max_speed:new F.bM(Ae),u_uv_offset:new F.bK(Ae),u_data_scale:new F.bK(Ae),u_data_offset:new F.bM(Ae),u_particle_pos_scale:new F.bM(Ae),u_particle_pos_offset:new F.bK(Ae)}),rasterParticleUpdate:Ae=>({u_particle_texture:new F.bN(Ae),u_particle_texture_side_len:new F.bM(Ae),u_velocity:new F.bN(Ae),u_velocity_res:new F.bK(Ae),u_max_speed:new F.bM(Ae),u_speed_factor:new F.bM(Ae),u_reset_rate:new F.bM(Ae),u_rand_seed:new F.bM(Ae),u_uv_offset:new F.bK(Ae),u_data_scale:new F.bK(Ae),u_data_offset:new F.bM(Ae),u_particle_pos_scale:new F.bM(Ae),u_particle_pos_offset:new F.bK(Ae)}),symbol:Ae=>({u_is_size_zoom_constant:new F.bN(Ae),u_is_size_feature_constant:new F.bN(Ae),u_size_t:new F.bM(Ae),u_size:new F.bM(Ae),u_camera_to_center_distance:new F.bM(Ae),u_rotate_symbol:new F.bN(Ae),u_aspect_ratio:new F.bM(Ae),u_fade_change:new F.bM(Ae),u_matrix:new F.bJ(Ae),u_label_plane_matrix:new F.bJ(Ae),u_coord_matrix:new F.bJ(Ae),u_is_text:new F.bN(Ae),u_elevation_from_sea:new F.bN(Ae),u_pitch_with_map:new F.bN(Ae),u_texsize:new F.bK(Ae),u_texsize_icon:new F.bK(Ae),u_texture:new F.bN(Ae),u_texture_icon:new F.bN(Ae),u_gamma_scale:new F.bM(Ae),u_device_pixel_ratio:new F.bM(Ae),u_tile_id:new F.bL(Ae),u_zoom_transition:new F.bM(Ae),u_inv_rot_matrix:new F.bJ(Ae),u_merc_center:new F.bK(Ae),u_camera_forward:new F.bL(Ae),u_tile_matrix:new F.bJ(Ae),u_up_vector:new F.bL(Ae),u_ecef_origin:new F.bL(Ae),u_is_halo:new F.bN(Ae),u_icon_transition:new F.bM(Ae),u_color_adj_mat:new F.bJ(Ae),u_scale_factor:new F.bM(Ae)}),background:Ae=>({u_matrix:new F.bJ(Ae),u_emissive_strength:new F.bM(Ae),u_opacity:new F.bM(Ae),u_color:new F.cz(Ae)}),backgroundPattern:Ae=>({u_matrix:new F.bJ(Ae),u_emissive_strength:new F.bM(Ae),u_opacity:new F.bM(Ae),u_image:new F.bN(Ae),u_pattern_tl:new F.bK(Ae),u_pattern_br:new F.bK(Ae),u_texsize:new F.bK(Ae),u_pattern_size:new F.bK(Ae),u_pixel_coord_upper:new F.bK(Ae),u_pixel_coord_lower:new F.bK(Ae),u_pattern_units_to_pixels:new F.bK(Ae)}),terrainRaster:Ae=>({u_matrix:new F.bJ(Ae),u_image0:new F.bN(Ae),u_skirt_height:new F.bM(Ae),u_ground_shadow_factor:new F.bL(Ae)}),skybox:Ae=>({u_matrix:new F.bJ(Ae),u_sun_direction:new F.bL(Ae),u_cubemap:new F.bN(Ae),u_opacity:new F.bM(Ae),u_temporal_offset:new F.bM(Ae)}),skyboxGradient:Ae=>({u_matrix:new F.bJ(Ae),u_color_ramp:new F.bN(Ae),u_center_direction:new F.bL(Ae),u_radius:new F.bM(Ae),u_opacity:new F.bM(Ae),u_temporal_offset:new F.bM(Ae)}),skyboxCapture:Ae=>({u_matrix_3f:new F.cA(Ae),u_sun_direction:new F.bL(Ae),u_sun_intensity:new F.bM(Ae),u_color_tint_r:new F.ca(Ae),u_color_tint_m:new F.ca(Ae),u_luminance:new F.bM(Ae)}),globeRaster:Ae=>({u_proj_matrix:new F.bJ(Ae),u_globe_matrix:new F.bJ(Ae),u_normalize_matrix:new F.bJ(Ae),u_merc_matrix:new F.bJ(Ae),u_zoom_transition:new F.bM(Ae),u_merc_center:new F.bK(Ae),u_image0:new F.bN(Ae),u_grid_matrix:new F.cA(Ae),u_skirt_height:new F.bM(Ae),u_far_z_cutoff:new F.bM(Ae),u_frustum_tl:new F.bL(Ae),u_frustum_tr:new F.bL(Ae),u_frustum_br:new F.bL(Ae),u_frustum_bl:new F.bL(Ae),u_globe_pos:new F.bL(Ae),u_globe_radius:new F.bM(Ae),u_viewport:new F.bK(Ae)}),globeAtmosphere:Ae=>({u_frustum_tl:new F.bL(Ae),u_frustum_tr:new F.bL(Ae),u_frustum_br:new F.bL(Ae),u_frustum_bl:new F.bL(Ae),u_horizon:new F.bM(Ae),u_transition:new F.bM(Ae),u_fadeout_range:new F.bM(Ae),u_color:new F.ca(Ae),u_high_color:new F.ca(Ae),u_space_color:new F.ca(Ae),u_temporal_offset:new F.bM(Ae),u_horizon_angle:new F.bM(Ae)}),model:Ae=>({u_matrix:new F.bJ(Ae),u_lighting_matrix:new F.bJ(Ae),u_normal_matrix:new F.bJ(Ae),u_node_matrix:new F.bJ(Ae),u_lightpos:new F.bL(Ae),u_lightintensity:new F.bM(Ae),u_lightcolor:new F.bL(Ae),u_camera_pos:new F.bL(Ae),u_opacity:new F.bM(Ae),u_baseColorFactor:new F.ca(Ae),u_emissiveFactor:new F.ca(Ae),u_metallicFactor:new F.bM(Ae),u_roughnessFactor:new F.bM(Ae),u_baseTextureIsAlpha:new F.bN(Ae),u_alphaMask:new F.bN(Ae),u_alphaCutoff:new F.bM(Ae),u_baseColorTexture:new F.bN(Ae),u_metallicRoughnessTexture:new F.bN(Ae),u_normalTexture:new F.bN(Ae),u_occlusionTexture:new F.bN(Ae),u_emissionTexture:new F.bN(Ae),u_lutTexture:new F.bN(Ae),u_color_mix:new F.ca(Ae),u_aoIntensity:new F.bM(Ae),u_emissive_strength:new F.bM(Ae),u_occlusionTextureTransform:new F.ca(Ae)}),modelDepth:Ae=>({u_matrix:new F.bJ(Ae),u_instance:new F.bJ(Ae),u_node_matrix:new F.bJ(Ae)}),groundShadow:Ae=>({u_matrix:new F.bJ(Ae),u_ground_shadow_factor:new F.bL(Ae)}),stars:Ae=>({u_matrix:new F.bJ(Ae),u_up:new F.bL(Ae),u_right:new F.bL(Ae),u_intensity_multiplier:new F.bM(Ae)}),snowParticle:Ae=>({u_modelview:new F.bJ(Ae),u_projection:new F.bJ(Ae),u_time:new F.bM(Ae),u_cam_pos:new F.bL(Ae),u_velocityConeAperture:new F.bM(Ae),u_velocity:new F.bM(Ae),u_horizontalOscillationRadius:new F.bM(Ae),u_horizontalOscillationRate:new F.bM(Ae),u_boxSize:new F.bM(Ae),u_billboardSize:new F.bM(Ae),u_simpleShapeParameters:new F.bK(Ae),u_screenSize:new F.bK(Ae),u_thinningCenterPos:new F.bK(Ae),u_thinningShape:new F.bL(Ae),u_thinningAffectedRatio:new F.bM(Ae),u_thinningParticleOffset:new F.bM(Ae),u_particleColor:new F.ca(Ae),u_direction:new F.bL(Ae)}),rainParticle:Ae=>({u_modelview:new F.bJ(Ae),u_projection:new F.bJ(Ae),u_time:new F.bM(Ae),u_cam_pos:new F.bL(Ae),u_texScreen:new F.bN(Ae),u_velocityConeAperture:new F.bM(Ae),u_velocity:new F.bM(Ae),u_boxSize:new F.bM(Ae),u_rainDropletSize:new F.bK(Ae),u_distortionStrength:new F.bM(Ae),u_rainDirection:new F.bL(Ae),u_color:new F.ca(Ae),u_screenSize:new F.bK(Ae),u_thinningCenterPos:new F.bK(Ae),u_thinningShape:new F.bL(Ae),u_thinningAffectedRatio:new F.bM(Ae),u_thinningParticleOffset:new F.bM(Ae),u_shapeDirectionalPower:new F.bM(Ae),u_shapeNormalPower:new F.bM(Ae),u_mode:new F.bM(Ae)}),vignette:Ae=>({u_vignetteShape:new F.bL(Ae),u_vignetteColor:new F.ca(Ae)}),occlusion:Ae=>({u_matrix:new F.bJ(Ae),u_anchorPos:new F.bL(Ae),u_screenSizePx:new F.bK(Ae),u_occluderSizePx:new F.bK(Ae),u_color:new F.ca(Ae)})};class Er{constructor(F,Ae,Oe,Fe){this.id=Er.uniqueIdxCounter,Er.uniqueIdxCounter++,this.context=F;const Ve=F.gl;this.buffer=Ve.createBuffer(),this.dynamicDraw=Boolean(Oe),this.context.unbindVAO(),F.bindElementBuffer.set(this.buffer),Ve.bufferData(Ve.ELEMENT_ARRAY_BUFFER,Ae.arrayBuffer,this.dynamicDraw?Ve.DYNAMIC_DRAW:Ve.STATIC_DRAW),this.dynamicDraw||Fe||Ae.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(F){this.id=Er.uniqueIdxCounter,Er.uniqueIdxCounter++;const Ae=this.context.gl;this.context.unbindVAO(),this.bind(),Ae.bufferSubData(Ae.ELEMENT_ARRAY_BUFFER,0,F.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Er.uniqueIdxCounter=0;const dp={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Cr{constructor(F,Ae,Oe,Fe,Ve,qe){this.length=Ae.length,this.attributes=Oe,this.itemSize=Ae.bytesPerElement,this.dynamicDraw=Fe,this.instanceCount=qe,this.context=F;const pt=F.gl;this.buffer=pt.createBuffer(),F.bindVertexBuffer.set(this.buffer),pt.bufferData(pt.ARRAY_BUFFER,Ae.arrayBuffer,this.dynamicDraw?pt.DYNAMIC_DRAW:pt.STATIC_DRAW),this.dynamicDraw||Ve||Ae.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(F){const Ae=this.context.gl;this.bind(),Ae.bufferSubData(Ae.ARRAY_BUFFER,0,F.arrayBuffer)}enableAttributes(F,Ae){for(let Oe=0;Oe<this.attributes.length;Oe++){const Fe=Ae.attributes[this.attributes[Oe].name];void 0!==Fe&&F.enableVertexAttribArray(Fe)}}setVertexAttribPointers(F,Ae,Oe){for(let Fe=0;Fe<this.attributes.length;Fe++){const Ve=this.attributes[Fe],qe=Ae.attributes[Ve.name];void 0!==qe&&F.vertexAttribPointer(qe,Ve.components,F[dp[Ve.type]],!1,this.itemSize,Ve.offset+this.itemSize*(Oe||0))}}setVertexAttribDivisor(F,Ae,Oe){for(let Fe=0;Fe<this.attributes.length;Fe++){const Ve=Ae.attributes[this.attributes[Fe].name];void 0!==Ve&&this.instanceCount&&this.instanceCount>0&&F.vertexAttribDivisor(Ve,Oe)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Ir{constructor(F,Ae,Oe,Fe,Ve){this.context=F,this.width=Ae,this.height=Oe;const qe=this.framebuffer=F.gl.createFramebuffer();Fe&&(this.colorAttachment=new Is(F,qe)),Ve&&(this.depthAttachmentType=Ve,this.depthAttachment="renderbuffer"===Ve?new Rs(F,qe):new Ds(F,qe))}destroy(){const F=this.context.gl;if(this.colorAttachment){const Ae=this.colorAttachment.get();Ae&&F.deleteTexture(Ae)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const Ae=this.depthAttachment.get();Ae&&F.deleteRenderbuffer(Ae)}else{const Ae=this.depthAttachment.get();Ae&&F.deleteTexture(Ae)}F.deleteFramebuffer(this.framebuffer)}}class Rr{constructor(F,Ae){this.gl=F,this.clearColor=new Xo(this),this.clearDepth=new Ko(this),this.clearStencil=new Yo(this),this.colorMask=new Jo(this),this.depthMask=new Qo(this),this.stencilMask=new es(this),this.stencilFunc=new ts(this),this.stencilOp=new is(this),this.stencilTest=new os(this),this.depthRange=new ss(this),this.depthTest=new rs(this),this.depthFunc=new as(this),this.blend=new ns(this),this.blendFunc=new ls(this),this.blendColor=new cs(this),this.blendEquation=new hs(this),this.cullFace=new us(this),this.cullFaceSide=new ds(this),this.frontFace=new _s(this),this.program=new Ed(this),this.activeTexture=new fs(this),this.viewport=new ms(this),this.bindFramebuffer=new gs(this),this.bindRenderbuffer=new vs(this),this.bindTexture=new ys(this),this.bindVertexBuffer=new xs(this),this.bindElementBuffer=new bs(this),this.bindVertexArrayOES=new ws(this),this.pixelStoreUnpack=new Ts(this),this.pixelStoreUnpackPremultiplyAlpha=new Es(this),this.pixelStoreUnpackFlipY=new Ss(this),this.options=Ae?Object.assign({},Ae):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=F.getExtension("EXT_texture_filter_anisotropic")||F.getExtension("MOZ_EXT_texture_filter_anisotropic")||F.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=F.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=F.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=F.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=F.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=Ae&&!!Ae.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=F.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=F.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=F.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=F.getParameter(F.MAX_TEXTURE_SIZE),this.maxPointSize=F.getParameter(F.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(F,Ae,Oe){return new Er(this,F,Ae,Oe)}createVertexBuffer(F,Ae,Oe,Fe,Ve){return new Cr(this,F,Ae,Oe,Fe,Ve)}createRenderbuffer(F,Ae,Oe){const Fe=this.gl,Ve=Fe.createRenderbuffer();return this.bindRenderbuffer.set(Ve),Fe.renderbufferStorage(Fe.RENDERBUFFER,F,Ae,Oe),this.bindRenderbuffer.set(null),Ve}createFramebuffer(F,Ae,Oe,Fe){return new Ir(this,F,Ae,Oe,Fe)}clear({color:F,depth:Ae,stencil:Oe,colorMask:Fe}){const Ve=this.gl;let qe=0;F&&(qe|=Ve.COLOR_BUFFER_BIT,this.clearColor.set(F),this.colorMask.set(Fe||[!0,!0,!0,!0])),void 0!==Ae&&(qe|=Ve.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(Ae),this.depthMask.set(!0)),void 0!==Oe&&(qe|=Ve.STENCIL_BUFFER_BIT,this.clearStencil.set(Oe),this.stencilMask.set(255)),Ve.clear(qe)}setCullFace(F){!1===F.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(F.mode),this.frontFace.set(F.frontFace))}setDepthMode(F){F.func!==this.gl.ALWAYS||F.mask?(this.depthTest.set(!0),this.depthFunc.set(F.func),this.depthMask.set(F.mask),this.depthRange.set(F.range)):this.depthTest.set(!1)}setStencilMode(F){F.test.func!==this.gl.ALWAYS||F.mask?(this.stencilTest.set(!0),this.stencilMask.set(F.mask),this.stencilOp.set([F.fail,F.depthFail,F.pass]),this.stencilFunc.set({func:F.test.func,ref:F.ref,mask:F.test.mask})):this.stencilTest.set(!1)}setColorMode(Ae){F.bn(Ae.blendFunction,ki.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(Ae.blendFunction),this.blendColor.set(Ae.blendColor),Ae.blendEquation?this.blendEquation.set(Ae.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(Ae.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let fp;function Lr(Ae,Oe,Fe,Ve,qe,pt,vt){const zt=Ae.context,ri=zt.gl,xi=Ae.transform,bi=Ae.getOrCreateProgram("collisionBox"),wi=[];let dr=0,jr=0;for(let zt=0;zt<Ve.length;zt++){const Qr=Ve[zt],Xn=Oe.getTile(Qr),ho=Xn.getBucket(Fe);if(!ho)continue;const yo=li(Qr,ho,xi);let zo=yo;0===qe[0]&&0===qe[1]||(zo=Ae.translatePosMatrix(yo,Xn,qe,pt));const ko=vt?ho.textCollisionBox:ho.iconCollisionBox,Uo=ho.collisionCircleArray;if(Uo.length>0){const Ae=F.ab.mat4.create(),Oe=zo;F.ab.mat4.mul(Ae,ho.placementInvProjMatrix,xi.glCoordMatrix),F.ab.mat4.mul(Ae,Ae,ho.placementViewportMatrix),wi.push({circleArray:Uo,circleOffset:jr,transform:Oe,invTransform:Ae,projection:ho.getProjection()}),dr+=Uo.length/4,jr=dr}ko&&(Ae.terrain&&Ae.terrain.setupElevationDraw(Xn,bi),bi.draw(Ae,ri.LINES,Bi.disabled,Ui.disabled,Ae.colorModeForRenderPass(),Vi.disabled,sr(zo,xi,Xn,ho.getProjection()),Fe.id,ko.layoutVertexBuffer,ko.indexBuffer,ko.segments,null,xi.zoom,null,[ko.collisionVertexBuffer,ko.collisionVertexBufferExt]))}if(!vt||!wi.length)return;const Qr=Ae.getOrCreateProgram("collisionCircle"),Xn=new F.cV;Xn.resize(4*dr),Xn._trim();let ho=0;for(const F of wi)for(let Ae=0;Ae<F.circleArray.length/4;Ae++){const Oe=4*Ae,Fe=F.circleArray[Oe+0],Ve=F.circleArray[Oe+1],qe=F.circleArray[Oe+2],pt=F.circleArray[Oe+3];Xn.emplace(ho++,Fe,Ve,qe,pt,0),Xn.emplace(ho++,Fe,Ve,qe,pt,1),Xn.emplace(ho++,Fe,Ve,qe,pt,2),Xn.emplace(ho++,Fe,Ve,qe,pt,3)}(!fp||fp.length<2*dr)&&(fp=function(Ae){const Oe=2*Ae,Fe=new F.aU;Fe.resize(Oe),Fe._trim();for(let F=0;F<Oe;F++){const Ae=6*F;Fe.uint16[Ae+0]=4*F+0,Fe.uint16[Ae+1]=4*F+1,Fe.uint16[Ae+2]=4*F+2,Fe.uint16[Ae+3]=4*F+2,Fe.uint16[Ae+4]=4*F+3,Fe.uint16[Ae+5]=4*F+0}return Fe}(dr));const yo=zt.createIndexBuffer(fp,!0),zo=zt.createVertexBuffer(Xn,F.cW.members,!0);for(const Oe of wi){const Ve={u_matrix:Oe.transform,u_inv_matrix:Oe.invTransform,u_camera_to_center_distance:(ko=xi).getCameraToCenterDistance(Oe.projection),u_viewport_size:[ko.width,ko.height]};Qr.draw(Ae,ri.TRIANGLES,Bi.disabled,Ui.disabled,Ae.colorModeForRenderPass(),Vi.disabled,Ve,Fe.id,zo,yo,F.b7.simpleSegment(0,2*Oe.circleOffset,Oe.circleArray.length,Oe.circleArray.length/2),null,xi.zoom)}var ko;zo.destroy(),yo.destroy()}const mp=F.ab.mat4.create();function zr(Ae){const Oe=Ae._camera.getWorldToCamera(Ae.worldSize,1),Fe=F.ab.mat4.multiply([],Oe,Ae.globeMatrix);F.ab.mat4.invert(Fe,Fe);const Ve=[0,0,0],qe=[0,1,0,0];return F.ab.vec4.transformMat4(qe,qe,Fe),Ve[0]=qe[0],Ve[1]=qe[1],Ve[2]=qe[2],F.ab.vec3.normalize(Ve,Ve),Ve}function Pr({width:Ae,height:Oe,anchor:Fe,textOffset:Ve,textScale:qe},pt){const{horizontalAlign:vt,verticalAlign:zt}=F.bD(Fe),ri=-(vt-.5)*Ae,xi=-(zt-.5)*Oe,bi=F.bC(Fe,Ve);return new F.P((ri/qe+bi[0])*pt,(xi/qe+bi[1])*pt)}function Mr(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi){const wi=Ae.text.placedSymbolArray,dr=Ae.text.dynamicLayoutVertexArray,jr=Ae.icon.dynamicLayoutVertexArray,Qr={},Xn=Ae.getProjection(),ho=ci(zt,Xn,pt),yo=pt.elevation,zo=Xn.upVectorScale(zt.canonical,pt.center.lat,pt.worldSize).metersToTile;dr.clear();for(let jr=0;jr<wi.length;jr++){const ko=wi.get(jr),{tileAnchorX:Uo,tileAnchorY:ia,numGlyphs:_a}=ko,Ma=ko.hidden||!ko.crossTileID||Ae.allowVerticalPlacement&&!ko.placedOrientation?null:Ve[ko.crossTileID];if(Ma){let Ve=0,wi=0,jr=0;if(yo){const F=yo?yo.getAtTileOffset(zt,Uo,ia):0,[Ae,Oe,Fe]=Xn.upVector(zt.canonical,Uo,ia);Ve=F*Ae*zo,wi=F*Oe*zo,jr=F*Fe*zo}let[Ea,Ia,rl,Sl]=Wt(ko.projectedAnchorX+Ve,ko.projectedAnchorY+wi,ko.projectedAnchorZ+jr,Fe?ho:vt);const Il=$t(pt.getCameraToCenterDistance(Xn),Sl);let Kl=qe.evaluateSizeForFeature(Ae.textSizeData,xi,ko)*Il/F.bw;Fe&&(Kl*=Ae.tilePixelRatio/ri);const Jl=Pr(Ma,Kl);Fe?(({x:Ea,y:Ia,z:rl}=Xn.projectTilePoint(Uo+Jl.x,ia+Jl.y,zt.canonical)),[Ea,Ia,rl]=Wt(Ea+Ve,Ia+wi,rl+jr,vt)):(Oe&&Jl._rotate(-pt.angle),Ea+=Jl.x,Ia+=Jl.y,rl=0);const Ql=Ae.allowVerticalPlacement&&ko.placedOrientation===F.bq.vertical?Math.PI/2:0;for(let Ae=0;Ae<_a;Ae++)F.bt(dr,Ea,Ia,rl,Ql);bi&&ko.associatedIconIndex>=0&&(Qr[ko.associatedIconIndex]={x:Ea,y:Ia,z:rl,angle:Ql})}else oi(_a,dr)}if(bi){jr.clear();const Oe=Ae.icon.placedSymbolArray;for(let Ae=0;Ae<Oe.length;Ae++){const Fe=Oe.get(Ae),{numGlyphs:Ve}=Fe,qe=Qr[Ae];if(Fe.hidden||!qe)oi(Ve,jr);else{const{x:Ae,y:Oe,z:Fe,angle:pt}=qe;for(let qe=0;qe<Ve;qe++)F.bt(jr,Ae,Oe,Fe,pt)}}Ae.icon.dynamicLayoutVertexBuffer.updateData(jr)}Ae.text.dynamicLayoutVertexBuffer.updateData(dr)}function Or(Ae,Oe,Fe,Ve,qe,pt,vt={}){const zt=Fe.paint.get("icon-translate"),ri=Fe.paint.get("text-translate"),xi=Fe.paint.get("icon-translate-anchor"),bi=Fe.paint.get("text-translate-anchor"),wi=Fe.layout.get("icon-rotation-alignment"),dr=Fe.layout.get("text-rotation-alignment"),jr=Fe.layout.get("icon-pitch-alignment"),Qr=Fe.layout.get("text-pitch-alignment"),Xn=Fe.layout.get("icon-keep-upright"),ho=Fe.layout.get("text-keep-upright"),yo=Fe.paint.get("icon-color-saturation"),zo=Fe.paint.get("icon-color-contrast"),ko=Fe.paint.get("icon-color-brightness-min"),Uo=Fe.paint.get("icon-color-brightness-max"),ia="sea"===Fe.layout.get("symbol-elevation-reference"),_a=Ae.context,Ma=_a.gl,Ea=Ae.transform,Ia="map"===wi,rl="map"===dr,Sl="map"===jr,Il="map"===Qr,Kl=void 0!==Fe.layout.get("symbol-sort-key").constantOr(1);let Jl=!1;const Ql=Ae.depthModeForSublayer(0,Bi.ReadOnly),ec=[F.at(Ea.center.lng),F.aA(Ea.center.lat)],tc=Fe.layout.get("text-variable-anchor"),cc="globe"===Ea.projection.name,uc=[],jc=[0,-1,0];for(const qe of Ve){const Ve=Oe.getTile(qe),pt=Ve.getBucket(Fe);if(!pt)continue;if("mercator"===pt.projection.name&&cc)continue;if(pt.fullyClipped)continue;const wi="globe"===pt.projection.name,dr=wi?F.ae(Ea.zoom):0,jr=ci(qe,pt.getProjection(),Ea),Qr=Ea.calculatePixelsToTileUnitsMatrix(Ve),_a=tc&&pt.hasTextData(),Ql=pt.hasIconTextFit()&&_a&&pt.hasIconData(),Gc=pt.getProjection().createInversionMatrix(Ea,qe.canonical),N=F=>{Ea.depthOcclusionForSymbolsAndCircles&&(Fe.hasInitialOcclusionOpacityProperties||Ae.terrain)&&(F.push("DEPTH_D24"),F.push("DEPTH_OCCLUSION"))},U=()=>{const Oe=Ia&&"point"!==Fe.layout.get("symbol-placement"),vt=[];N(vt);const ri=Oe||Ql,bi=Fe.paint.get("icon-image-cross-fade").constantOr(0);Ae.terrainRenderModeElevated()&&Sl&&vt.push("PITCH_WITH_MAP_TERRAIN"),wi&&(vt.push("PROJECTION_GLOBE_VIEW"),ri&&vt.push("PROJECTED_POS_ON_VIEWPORT")),bi>0&&vt.push("ICON_TRANSITION"),pt.icon.zOffsetVertexBuffer&&vt.push("Z_OFFSET"),0===yo&&0===zo&&0===ko&&1===Uo||vt.push("COLOR_ADJUSTMENT"),pt.sdfIcons&&vt.push("RENDER_SDF");const ho=pt.icon.programConfigurations.get(Fe.id),_a=Ae.getOrCreateProgram("symbol",{config:ho,defines:vt}),rl=Ve.imageAtlasTexture?Ve.imageAtlasTexture.size:[0,0],Il=pt.iconSizeData,Kl=F.bp(Il,Ea.zoom),Jl=Sl||0!==Ea.pitch,tc=qt(jr,Ve.tileID.canonical,Sl,Ia,Ea,pt.getProjection(),Qr),uc=Zt(jr,Ve.tileID.canonical,Sl,Ia,Ea,pt.getProjection(),Qr),qc=Ae.translatePosMatrix(uc,Ve,zt,xi,!0),$c=Ae.translatePosMatrix(jr,Ve,zt,xi),Hc=ri?mp:tc,Wc=Ia&&!Sl&&!Oe;let Kc=jc;!cc&&!Ea.mercatorFromTransition||Ia||(Kc=zr(Ea));const Jc=wi?Kc:jc,Qc=Fe.getColorAdjustmentMatrix(yo,zo,ko,Uo),eh=gr(Il.kind,Kl,Wc,Sl,Ae,$c,Hc,qc,ia,!1,rl,[0,0],!0,qe,dr,ec,Gc,Jc,pt.getProjection(),Qc,bi),th=Ve.imageAtlasTexture?Ve.imageAtlasTexture:null,ih=1!==Fe.layout.get("icon-size").constantOr(0)||pt.iconsNeedLinear,rh=pt.sdfIcons||Ae.options.rotating||Ae.options.zooming||ih||Jl?Ma.LINEAR:Ma.NEAREST,nh=pt.sdfIcons&&0!==Fe.paint.get("icon-halo-width").constantOr(1),oh=Ae.terrain&&Sl&&Oe?F.ab.mat4.invert(F.ab.mat4.create(),tc):mp;if(Oe&&pt.icon){const F=Ea.elevation,Oe=F?F.getAtTileOffsetFunc(qe,Ea.center.lat,Ea.worldSize,pt.getProjection()):null,Fe=Ht(jr,Ve.tileID.canonical,Sl,Ia,Ea,pt.getProjection(),Qr);Kt(pt,jr,Ae,!1,Fe,uc,Sl,Xn,Oe,qe)}return{program:_a,buffers:pt.icon,uniformValues:eh,atlasTexture:th,atlasTextureIcon:null,atlasInterpolation:rh,atlasInterpolationIcon:null,isSDF:pt.sdfIcons,hasHalo:nh,tile:Ve,labelPlaneMatrixInv:oh}},j=()=>{const Oe=rl&&"point"!==Fe.layout.get("symbol-placement"),vt=[],zt=Oe||tc||Ql;Ae.terrainRenderModeElevated()&&Il&&vt.push("PITCH_WITH_MAP_TERRAIN"),wi&&(vt.push("PROJECTION_GLOBE_VIEW"),zt&&vt.push("PROJECTED_POS_ON_VIEWPORT")),pt.text.zOffsetVertexBuffer&&vt.push("Z_OFFSET"),pt.iconsInText&&vt.push("RENDER_TEXT_AND_SYMBOL"),vt.push("RENDER_SDF"),N(vt);const xi=pt.text.programConfigurations.get(Fe.id),Xn=Ae.getOrCreateProgram("symbol",{config:xi,defines:vt});let yo,zo=[0,0],ko=null;const Uo=pt.textSizeData;pt.iconsInText&&(zo=Ve.imageAtlasTexture?Ve.imageAtlasTexture.size:[0,0],ko=Ve.imageAtlasTexture?Ve.imageAtlasTexture:null,yo=Il||0!==Ea.pitch||Ae.options.rotating||Ae.options.zooming||"composite"===Uo.kind||"camera"===Uo.kind?Ma.LINEAR:Ma.NEAREST);const _a=Ve.glyphAtlasTexture?Ve.glyphAtlasTexture.size:[0,0],Ia=Fe.layout.get("text-size-scale-range"),Sl=F.aw(Ae.scaleFactor,Ia[0],Ia[1]),Kl=F.bp(Uo,Ea.zoom,Sl),Jl=qt(jr,Ve.tileID.canonical,Il,rl,Ea,pt.getProjection(),Qr),uc=Zt(jr,Ve.tileID.canonical,Il,rl,Ea,pt.getProjection(),Qr),qc=Ae.translatePosMatrix(uc,Ve,ri,bi,!0),$c=Ae.translatePosMatrix(jr,Ve,ri,bi),Hc=zt?mp:Jl,Wc=rl&&!Il&&!Oe;let Kc=jc;!cc&&!Ea.mercatorFromTransition||rl||(Kc=zr(Ea));const Jc=gr(Uo.kind,Kl,Wc,Il,Ae,$c,Hc,qc,ia,!0,_a,zo,!0,qe,dr,ec,Gc,wi?Kc:jc,pt.getProjection(),null,null,Sl),Qc=Ve.glyphAtlasTexture?Ve.glyphAtlasTexture:null,eh=Ma.LINEAR,th=0!==Fe.paint.get("text-halo-width").constantOr(1),ih=Ae.terrain&&Il&&Oe?F.ab.mat4.invert(F.ab.mat4.create(),Jl):mp;if(Oe&&pt.text){const F=Ea.elevation,Oe=F?F.getAtTileOffsetFunc(qe,Ea.center.lat,Ea.worldSize,pt.getProjection()):null,Fe=Ht(jr,Ve.tileID.canonical,Il,rl,Ea,pt.getProjection(),Qr);Kt(pt,jr,Ae,!0,Fe,uc,Il,ho,Oe,qe)}return{program:Xn,buffers:pt.text,uniformValues:Jc,atlasTexture:Qc,atlasTextureIcon:ko,atlasInterpolation:eh,atlasInterpolationIcon:yo,isSDF:!0,hasHalo:th,tile:Ve,labelPlaneMatrixInv:ih}},qc=pt.icon.segments.get().length,$c=pt.text.segments.get().length,Hc=qc&&!vt.onlyText?U():null,Wc=$c&&!vt.onlyIcons?j():null,Kc=Fe.paint.get("icon-opacity").constantOr(1),Jc=Fe.paint.get("text-opacity").constantOr(1);if(Kl&&pt.canOverlap){Jl=!0;const Ae=Kc&&!vt.onlyText?pt.icon.segments.get():[],Oe=Jc&&!vt.onlyIcons?pt.text.segments.get():[];for(const Oe of Ae)uc.push({segments:new F.b7([Oe]),sortKey:Oe.sortKey,state:Hc});for(const Ae of Oe)uc.push({segments:new F.b7([Ae]),sortKey:Ae.sortKey,state:Wc})}else vt.onlyText||uc.push({segments:Kc?pt.icon.segments:new F.b7([]),sortKey:0,state:Hc}),vt.onlyIcons||uc.push({segments:Jc?pt.text.segments:new F.b7([]),sortKey:0,state:Wc})}Jl&&uc.sort(((F,Ae)=>F.sortKey-Ae.sortKey));for(const F of uc){const Oe=F.state;if(Oe)if(Ae.terrain?Ae.terrain.setupElevationDraw(Oe.tile,Oe.program,{useDepthForOcclusion:Ea.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Oe.labelPlaneMatrixInv}):Ae.setupDepthForOcclusion(Ea.depthOcclusionForSymbolsAndCircles,Oe.program),_a.activeTexture.set(Ma.TEXTURE0),Oe.atlasTexture&&Oe.atlasTexture.bind(Oe.atlasInterpolation,Ma.CLAMP_TO_EDGE,!0),Oe.atlasTextureIcon&&(_a.activeTexture.set(Ma.TEXTURE1),Oe.atlasTextureIcon&&Oe.atlasTextureIcon.bind(Oe.atlasInterpolationIcon,Ma.CLAMP_TO_EDGE,!0)),Ae.uploadCommonLightUniforms(Ae.context,Oe.program),Oe.hasHalo){const Ve=Oe.uniformValues;Ve.u_is_halo=1,Fr(Oe.buffers,F.segments,Fe,Ae,Oe.program,Ql,qe,pt,Ve,2),Ve.u_is_halo=0}else{if(Oe.isSDF){const Ve=Oe.uniformValues;Oe.hasHalo&&(Ve.u_is_halo=1,Fr(Oe.buffers,F.segments,Fe,Ae,Oe.program,Ql,qe,pt,Ve,1)),Ve.u_is_halo=0}Fr(Oe.buffers,F.segments,Fe,Ae,Oe.program,Ql,qe,pt,Oe.uniformValues,1)}}}function Fr(F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri){const xi=[F.dynamicLayoutVertexBuffer,F.opacityVertexBuffer,F.iconTransitioningVertexBuffer,F.globeExtVertexBuffer,F.zOffsetVertexBuffer];Ve.draw(Fe,Fe.context.gl.TRIANGLES,qe,pt,vt,Vi.disabled,zt,Oe.id,F.layoutVertexBuffer,F.indexBuffer,Ae,Oe.paint,Fe.transform.zoom,F.programConfigurations.get(Oe.id),xi,ri)}function kr(Ae,Oe,Fe,Ve,qe,pt,vt){const zt=Ae.context.gl,ri=Fe.paint.get("fill-pattern"),xi=Fe.is3D(),bi=xi?Ae.stencilModeFor3D():Ui.disabled,wi=ri&&ri.constantOr(1);let dr,jr,Qr,Xn,ho;vt?(jr=wi&&!Fe.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",dr=zt.LINES):(jr=wi?"fillPattern":"fill",dr=zt.TRIANGLES);for(const yo of Ve){const Ve=Oe.getTile(yo);if(wi&&!Ve.patternsLoaded())continue;const zo=Ve.getBucket(Fe);if(!zo)continue;Ae.prepareDrawTile();const ko=zo.programConfigurations.get(Fe.id),Uo=Ae.isTileAffectedByFog(yo),ia=Ae.getOrCreateProgram(jr,{config:ko,overrideFog:Uo});wi&&(Ae.context.activeTexture.set(zt.TEXTURE0),Ve.imageAtlasTexture&&Ve.imageAtlasTexture.bind(zt.LINEAR,zt.CLAMP_TO_EDGE),ko.updatePaintBuffers());const _a=ri.constantOr(null);if(_a&&Ve.imageAtlas){const Ae=Ve.imageAtlas,Oe=F.A.from(_a).getPrimary().scaleSelf(F.q.devicePixelRatio).serialize(),Fe=Ae.patternPositions[Oe];Fe&&ko.setConstantPatternPositions(Fe)}const Ma=Ae.translatePosMatrix(yo.projMatrix,Ve,Fe.paint.get("fill-translate"),Fe.paint.get("fill-translate-anchor")),Ea=Fe.paint.get("fill-emissive-strength");if(vt){Xn=zo.indexBuffer2,ho=zo.segments2;const F=Ae.terrain&&Ae.terrain.renderingToTexture?Ae.terrain.drapeBufferSize:[zt.drawingBufferWidth,zt.drawingBufferHeight];Qr="fillOutlinePattern"===jr&&wi?or(Ma,Ea,Ae,Ve,F):ir(Ma,Ea,F)}else Xn=zo.indexBuffer,ho=zo.segments,Qr=wi?tr(Ma,Ea,Ae,Ve):er(Ma,Ea);Ae.uploadCommonUniforms(Ae.context,ia,yo.toUnwrapped()),ia.draw(Ae,dr,qe,xi?bi:Ae.stencilModeForClipping(yo),pt,Vi.disabled,Qr,Fe.id,zo.layoutVertexBuffer,Xn,ho,Fe.paint,Ae.transform.zoom,ko,void 0)}}function Br(Ae,Oe,Fe,Ve,qe,pt,vt,zt){Fe.resetLayerRenderingStats(Ae);const ri=Ae.context,xi=ri.gl,bi=Ae.transform,wi=Fe.paint.get("fill-extrusion-pattern"),dr=wi.constantOr(1),jr=Fe.paint.get("fill-extrusion-opacity"),Qr=Ae.style.enable3dLights(),Xn=Fe.paint.get(Qr&&!dr?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),ho=[Fe.paint.get("fill-extrusion-ambient-occlusion-intensity"),Xn],yo=Fe.layout.get("fill-extrusion-edge-radius"),zo=yo>0&&!Fe.paint.get("fill-extrusion-rounded-roof"),ko=zo?0:yo,Uo="globe"===bi.projection.name?F.d3():0,ia="globe"===bi.projection.name,_a=ia?F.ae(bi.zoom):0,Ma=[F.at(bi.center.lng),F.aA(bi.center.lat)],Ea="none"===Fe.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),Ia=Fe.paint.get("fill-extrusion-flood-light-color").toRenderColor(Ea?null:Fe.lut).toArray01().slice(0,3),rl=Fe.paint.get("fill-extrusion-flood-light-intensity"),Sl=Fe.paint.get("fill-extrusion-vertical-scale"),Il=0!==Fe.paint.get("fill-extrusion-line-width").constantOr(1),Kl=Fe.paint.get("fill-extrusion-height-alignment"),Jl=Fe.paint.get("fill-extrusion-base-alignment"),Ql=eo(Ae,Fe.paint.get("fill-extrusion-cutoff-fade-range")),ec=[];let tc;ia&&ec.push("PROJECTION_GLOBE_VIEW"),ho[0]>0&&ec.push("FAUX_AO"),zo&&ec.push("ZERO_ROOF_RADIUS"),zt&&ec.push("HAS_CENTROID"),rl>0&&ec.push("FLOOD_LIGHT"),Ql.shouldRenderCutoff&&ec.push("RENDER_CUTOFF"),Il&&ec.push("RENDER_WALL_MODE");const cc="shadow"===Ae.renderPass,uc=Ae.shadowRenderer,jc=cc&&!!uc;Ae.shadowRenderer&&(Ae.shadowRenderer.useNormalOffset=!0);let Gc=[0,0,0];if(uc){const F=Ae.style.directionalLight,Oe=Ae.style.ambientLight;F&&Oe&&(Gc=no(Ae.style,F,Oe)),cc||(ec.push("RENDER_SHADOWS","DEPTH_TEXTURE"),uc.useNormalOffset&&ec.push("NORMAL_OFFSET")),tc=ec.concat(["SHADOWS_SINGLE_CASCADE"])}const qc=jc?"fillExtrusionDepth":dr?"fillExtrusionPattern":"fillExtrusion",$c=Fe.getLayerRenderingStats();for(const Qr of Ve){const Ve=Oe.getTile(Qr),Xn=Ve.getBucket(Fe);if(!Xn||Xn.projection.name!==bi.projection.name)continue;let yo=!1;uc&&(yo=0===uc.getMaxCascadeForTile(Qr.toUnwrapped()));const zo=Ae.isTileAffectedByFog(Qr),Ea=Xn.programConfigurations.get(Fe.id),jc=Ae.getOrCreateProgram(qc,{config:Ea,defines:yo?tc:ec,overrideFog:zo});if(Ae.terrain&&Ae.terrain.setupElevationDraw(Ve,jc,{useMeterToDem:!0}),!Xn.centroidVertexBuffer){const F=jc.attributes.a_centroid_pos;void 0!==F&&xi.vertexAttrib2f(F,0,0)}!cc&&uc&&uc.setupShadows(Ve.tileID.toUnwrapped(),jc,"vector-tile",Ve.tileID.overscaledZ),dr&&(Ae.context.activeTexture.set(xi.TEXTURE0),Ve.imageAtlasTexture&&Ve.imageAtlasTexture.bind(xi.LINEAR,xi.CLAMP_TO_EDGE),Ea.updatePaintBuffers());const Hc=wi.constantOr(null);if(Hc&&Ve.imageAtlas){const Ae=Ve.imageAtlas,Oe=F.A.from(Hc).getPrimary().scaleSelf(F.q.devicePixelRatio),Fe=Ae.patternPositions[Oe.serialize()];Fe&&Ea.setConstantPatternPositions(Fe)}const Wc=Fe.paint.get("fill-extrusion-vertical-gradient"),Kc=1/Xn.tileToMeter;let Jc;if(cc&&uc){if(qr(Ve.tileID,Xn,Ae))continue;const F=uc.calculateShadowPassMatrixFromTile(Ve.tileID.toUnwrapped());Jc=Js(F,ko,Kc,Sl,Kl,Jl)}else{const F=Ae.translatePosMatrix(Qr.expandedProjMatrix,Ve,Fe.paint.get("fill-extrusion-translate"),Fe.paint.get("fill-extrusion-translate-anchor")),Oe=bi.projection.createInversionMatrix(bi,Qr.canonical);Jc=dr?Qs(F,Ae,Wc,jr,ho,ko,Kc,Qr,Ve,Uo,Kl,Jl,_a,Ma,Oe,Ia,Sl):Ys(F,Ae,Wc,jr,ho,ko,Kc,Qr,Uo,Kl,Jl,_a,Ma,Oe,Ia,Sl,rl,Gc)}Ae.uploadCommonUniforms(ri,jc,Qr.toUnwrapped(),null,Ql);let Qc=Xn.segments;if("mercator"===bi.projection.name&&!cc&&(Qc=Xn.getVisibleSegments(Ve.tileID,Ae.terrain,Ae.transform.getFrustum(0)),!Qc.get().length))continue;if($c)if(cc)for(const F of Qc.get())$c.numRenderedVerticesInShadowPass+=F.primitiveLength;else for(const F of Qc.get())$c.numRenderedVerticesInTransparentPass+=F.primitiveLength;const eh=[];(Ae.terrain||zt)&&eh.push(Xn.centroidVertexBuffer),ia&&eh.push(Xn.layoutVertexExtBuffer),Il&&eh.push(Xn.wallVertexBuffer),jc.draw(Ae,ri.gl.TRIANGLES,qe,pt,vt,Vi.backCCW,Jc,Fe.id,Xn.layoutVertexBuffer,Xn.indexBuffer,Qc,Fe.paint,Ae.transform.zoom,Ea,eh)}Ae.shadowRenderer&&(Ae.shadowRenderer.useNormalOffset=!1)}function Nr(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi,dr,jr,Qr,Xn,ho,yo,zo){const ko=Ae.context,Uo=ko.gl,ia=Ae.transform,_a=Ae.transform.zoom,Ma=[],Ea=eo(Ae,Fe.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===xi?(Ma.push("CLEAR_SUBPASS"),zo&&(Ma.push("CLEAR_FROM_TEXTURE"),ko.activeTexture.set(Uo.TEXTURE0),zo.bind(Uo.LINEAR,Uo.CLAMP_TO_EDGE))):"sdf"===xi&&Ma.push("SDF_SUBPASS"),ho&&Ma.push("HAS_CENTROID"),Ea.shouldRenderCutoff&&Ma.push("RENDER_CUTOFF");const Ia=Fe.layout.get("fill-extrusion-edge-radius"),I=(F,Oe,Ve,xi,yo)=>{const Uo=Oe.programConfigurations.get(Fe.id),ia=Ae.isTileAffectedByFog(F),rl=Ae.getOrCreateProgram("fillExtrusionGroundEffect",{config:Uo,defines:Ma,overrideFog:ia}),Sl=((F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi)=>({u_matrix:Ae,u_opacity:Oe,u_ao_pass:Fe?1:0,u_meter_to_tile:Ve,u_ao:qe,u_flood_light_intensity:pt,u_flood_light_color:vt,u_attenuation:zt,u_edge_radius:ri,u_fb:0,u_fb_size:xi,u_dynamic_offset:1}))(0,xi,bi,ri,yo,[wi,dr*yo],jr,Qr,Xn,_a>=17?0:Ia*yo,zo?zo.size[0]:0),Il=[];ho&&Il.push(Oe.hiddenByLandmarkVertexBuffer),Ae.uploadCommonUniforms(ko,rl,F.toUnwrapped(),null,Ea),rl.draw(Ae,ko.gl.TRIANGLES,qe,pt,vt,zt,Sl,Fe.id,Oe.vertexBuffer,Oe.indexBuffer,Ve,Fe.paint,_a,Uo,Il)};for(const qe of Ve){const Ve=Oe.getTile(qe),pt=Ve.getBucket(Fe);if(!pt||pt.projection.name!==ia.projection.name||!pt.groundEffect||pt.groundEffect&&!pt.groundEffect.hasData())continue;const vt=pt.groundEffect,zt=1/pt.tileToMeter;{const F=Ae.translatePosMatrix(qe.projMatrix,Ve,Fe.paint.get("fill-extrusion-translate"),Fe.paint.get("fill-extrusion-translate-anchor")),Oe=vt.getDefaultSegment();I(qe,vt,Oe,F,zt)}if(yo)for(let pt=0;pt<4;pt++){const vt=F.d4[pt](qe),ri=Oe.getTile(vt);if(!ri)continue;const xi=ri.getBucket(Fe);if(!xi||xi.projection.name!==ia.projection.name||!xi.groundEffect||xi.groundEffect&&!xi.groundEffect.hasData())continue;const bi=xi.groundEffect;let wi,dr;0===pt?(wi=[-F.ag,0,0],dr=1):1===pt?(wi=[F.ag,0,0],dr=0):2===pt?(wi=[0,-F.ag,0],dr=3):(wi=[0,F.ag,0],dr=2);const jr=bi.regionSegments[dr];if(!jr)continue;const Qr=new Float32Array(16);F.ab.mat4.translate(Qr,qe.projMatrix,wi),I(qe,bi,jr,Ae.translatePosMatrix(Qr,Ve,Fe.paint.get("fill-extrusion-translate"),Fe.paint.get("fill-extrusion-translate-anchor")),zt)}}}function Ur(Ae,Oe,Fe,Ve,qe,pt,vt){0===Ve.centroidVertexArray.length&&Ve.createCentroidsBuffer();const zt=pt?pt.findDEMTileFor(Fe):null;if(!(zt&&zt.dem||vt))return;pt&&zt&&zt.dem&&Ve.selfDEMTileTimestamp!==zt.dem._timestamp&&(Ve.borderDoneWithNeighborZ=[-1,-1,-1,-1],Ve.selfDEMTileTimestamp=zt.dem._timestamp);const c=Ae=>new F.P(Math.ceil((Ae+F.d7)*F.d8),0),h=F=>{const Ae=Oe.getSource().minzoom,o=F=>{const Ae=Oe.getTileByID(F);if(Ae&&Ae.hasData())return Ae.getBucket(qe)},Fe=[0,-1,1];for(const Oe of Fe){if(F.overscaledZ+Oe<Ae)continue;const Fe=o(F.calculateScaledKey(F.overscaledZ+Oe));if(Fe)return Fe}},ri=[0,0,0],d=(Ae,Oe)=>(ri[0]=Math.min(Ae.min.y,Oe.min.y),ri[1]=Math.max(Ae.max.y,Oe.max.y),ri[2]=F.ag-Oe.min.x>Ae.max.x?Oe.min.x-F.ag:Ae.max.x,ri),_=(Ae,Oe)=>(ri[0]=Math.min(Ae.min.x,Oe.min.x),ri[1]=Math.max(Ae.max.x,Oe.max.x),ri[2]=F.ag-Oe.min.y>Ae.max.y?Oe.min.y-F.ag:Ae.max.y,ri),xi=[(F,Ae)=>d(F,Ae),(F,Ae)=>d(Ae,F),(F,Ae)=>_(F,Ae),(F,Ae)=>_(Ae,F)],f=(Ae,Oe,Ve,qe,vt,ri,xi)=>{if(!pt)return 0;const bi=[[ri?Ve:Ae,ri?Ae:Ve,0],[ri?Ve:Oe,ri?Oe:Ve,0]],wi=xi<0?F.ag+xi:xi,dr=[ri?wi:(Ae+Oe)/2,ri?(Ae+Oe)/2:wi,0];return 0===Ve&&xi<0||0!==Ve&&xi>0?pt.getForTilePoints(vt,[dr],!0,qe):bi.push(dr),pt.getForTilePoints(Fe,bi,!0,zt),Math.max(bi[0][2],bi[1][2],dr[2])/pt.exaggeration()};for(let Ae=0;Ae<4;Ae++){const Oe=Ve.borderFeatureIndices[Ae];if(0===Oe.length)continue;const qe=F.d4[Ae](Fe),zt=h(qe);if(!(zt&&zt instanceof F.d5))continue;const ri=pt?pt.findDEMTileFor(qe):null;if(!(ri&&ri.dem||vt))continue;if(pt&&ri&&ri.dem&&Ve.borderDEMTileTimestamp[Ae]!==ri.dem._timestamp&&(Ve.borderDoneWithNeighborZ[Ae]=-1,Ve.borderDEMTileTimestamp[Ae]=ri.dem._timestamp),Ve.borderDoneWithNeighborZ[Ae]===zt.canonical.z)continue;0===zt.centroidVertexArray.length&&zt.createCentroidsBuffer();const dr=(Ae<2?1:5)-Ae,jr=zt.borderDoneWithNeighborZ[dr]!==Ve.canonical.z,Qr=zt.borderFeatureIndices[dr];let Xn=0;if(Ve.canonical.z!==zt.canonical.z){for(const F of Oe)Ve.showCentroid(Ve.featuresOnBorder[F]);if(jr)for(const F of Qr)zt.showCentroid(zt.featuresOnBorder[F]);Ve.borderDoneWithNeighborZ[Ae]=zt.canonical.z,zt.borderDoneWithNeighborZ[dr]=Ve.canonical.z}for(const Fe of Oe){const Oe=Ve.featuresOnBorder[Fe],pt=Ve.centroidData[Oe.centroidDataIndex],jr=Oe.borders[Ae];let ho;for(;Xn<Qr.length;){ho=zt.featuresOnBorder[Qr[Xn]];const F=ho.borders[dr];if(F[1]>jr[0]+3||F[0]>jr[0]-3)break;zt.showCentroid(ho),Xn++}if(ho&&Xn<Qr.length){const Fe=Xn;let yo=0;for(;!(ho.borders[dr][0]>jr[1]-3)&&(yo++,++Xn!==Qr.length);)ho=zt.featuresOnBorder[Qr[Xn]];ho=zt.featuresOnBorder[Qr[Fe]];let zo=!1;if(yo>=1){const F=ho.borders[dr];Math.abs(jr[0]-F[0])<3&&Math.abs(jr[1]-F[1])<3&&(yo=1,zo=!0,Xn=Fe+1)}else if(0===yo){Ve.showCentroid(Oe);continue}const ko=zt.centroidData[ho.centroidDataIndex];vt&&zo&&(((bi=pt).flags|(wi=ko).flags)&F.d6?(bi.flags|=F.d6,wi.flags|=F.d6):(bi.flags&=~F.d6,wi.flags&=~F.d6));const Uo=Oe.intersectsCount()>1||ho.intersectsCount()>1;if(yo>1)Xn=Fe,pt.centroidXY=ko.centroidXY=new F.P(0,0);else if(ri&&ri.dem&&!Uo){const Oe=xi[Ae](pt,ko),Fe=Ae%2?F.ag-1:0,Ve=f(Oe[0],Math.min(F.ag-1,Oe[1]),Fe,ri,qe,Ae<2,Oe[2]);pt.centroidXY=ko.centroidXY=c(Ve)}else Uo?pt.centroidXY=ko.centroidXY=new F.P(0,0):(pt.centroidXY=Ve.encodeBorderCentroid(Oe),ko.centroidXY=zt.encodeBorderCentroid(ho));Ve.writeCentroidToBuffer(pt),zt.writeCentroidToBuffer(ko)}else Ve.showCentroid(Oe)}Ve.borderDoneWithNeighborZ[Ae]=zt.canonical.z,zt.borderDoneWithNeighborZ[dr]=Ve.canonical.z}var bi,wi;(Ve.needsCentroidUpdate||!Ve.centroidVertexBuffer&&0!==Ve.centroidVertexArray.length)&&Ve.uploadCentroid(Ae)}const _p=[1,0,0],gp=[0,1,0],yp=[0,0,1];function qr(Ae,Oe,Fe){const Ve=Fe.transform,qe=Fe.shadowRenderer;if(!qe)return!0;const pt=Ae.toUnwrapped(),vt=Ve.tileSize*qe._cascades[Fe.currentShadowCascade].scale;let zt=Oe.maxHeight;if(Ve.elevation){const F=Ve.elevation.getMinMaxForTile(Ae);F&&(zt+=F.max)}const ri=[...qe.shadowDirection];ri[2]=-ri[2];const xi=qe.computeSimplifiedTileShadowVolume(pt,zt,vt,ri);if(!xi)return!1;const bi=[_p,gp,yp,ri,[ri[0],0,ri[2]],[0,ri[1],ri[2]]],wi="globe"===Ve.projection.name,dr=Ve.scaleZoom(vt),jr=F.bR.fromInvProjectionMatrix(Ve.invProjMatrix,Ve.worldSize,dr,!wi),Qr=qe.getCurrentCascadeFrustum();return 0===jr.intersectsPrecise(xi.vertices,xi.planes,bi)||0===Qr.intersectsPrecise(xi.vertices,xi.planes,bi)}function Hr(Ae){return[Ae[0]*F.d9,Ae[1]*F.d9,Ae[2]*F.d9,0]}function Zr(Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri){const xi=Ve.getSource(),bi=Fe.globeSharedBuffers;if(!bi)return;let wi,dr,jr;if(Oe&&(wi=Ve.getTile(Oe)),xi instanceof F.aJ?(dr=xi.texture,jr=F.cI(0,0,Fe.transform)):wi&&Oe&&(dr=wi.texture,jr=F.cI(Oe.canonical.z,Oe.canonical.x,Fe.transform)),!dr||!jr)return;Ae||(jr=F.ab.mat4.scale(F.ab.mat4.create(),jr,[1,-1,1]));const Qr=Fe.context,Xn=Qr.gl,ho="nearest"===qe.paint.get("raster-resampling")?Xn.NEAREST:Xn.LINEAR,yo=Fe.colorModeForDrapableLayerRenderPass(pt),zo=vt.defines;zo.push("GLOBE_POLES");const ko=new Bi(Xn.LEQUAL,Bi.ReadWrite,Fe.depthRangeFor3D),Uo=Float32Array.from(Fe.transform.expandedFarZProjMatrix),ia=Float32Array.from(F.bb(F.cH(new F.bT(0,0,0))));Fe.terrain&&Fe.terrain.prepareDrawTile(),Qr.activeTexture.set(Xn.TEXTURE0),dr.bind(ho,Xn.CLAMP_TO_EDGE),Qr.activeTexture.set(Xn.TEXTURE1),dr.bind(ho,Xn.CLAMP_TO_EDGE),dr.useMipmap&&Qr.extTextureFilterAnisotropic&&Fe.transform.pitch>20&&Xn.texParameterf(Xn.TEXTURE_2D,Qr.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Qr.extTextureFilterAnisotropicMax);const[_a,Ma,Ea,Ia]=Oe?bi.getPoleBuffers(Oe.canonical.z,!1):bi.getPoleBuffers(0,!0),rl=qe.paint.get("raster-elevation");let Sl;Ae?(Sl=_a,Fe.renderDefaultNorthPole=0!==rl):(Sl=Ma,Fe.renderDefaultSouthPole=0!==rl);const Il=Hr(vt.mix),Kl=((F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi)=>hr(F,Ae,Oe,new Float32Array(16),new Float32Array(9),[0,0],Fe,[0,0],[0,0,0,0],1,{opacity:1,mix:0},qe,[0,0]||[0,0],vt,2,ri,xi,bi,1,0,wi))(Uo,ia,jr,F.ae(Fe.transform.zoom),0,qe,0,rl,0,Il,vt.offset,vt.range,pt),Jl=Fe.getOrCreateProgram("raster",{defines:zo});Fe.uploadCommonUniforms(Qr,Jl,null),Jl.draw(Fe,Xn.TRIANGLES,ko,ri,yo,zt,Kl,qe.id,Sl,Ea,Ia)}function Wr(F){const Ae=F._nearZ,Oe=F.projection.farthestPixelDistance(F),Fe=Oe-Ae,Ve=.2*F.height,qe=Ae+Ve;return[Ae,Oe,(qe-Ve-Ae)/Fe,(qe-Ae)/Fe]}function $r(F,Ae,Oe,Fe){if(F)return Ae instanceof ot&&F instanceof wt?Ae.getTextureDescriptor(F,Oe,!0):{texture:F.texture,mix:Hr(Fe.mix),offset:Fe.offset,buffer:0,tileSize:1}}var xp=F.da([{name:"a_index",type:"Int16",components:1}]);class Kr{constructor(Ae,Oe,Fe,Ve){const qe={width:Fe[0],height:Fe[1],data:null},pt=Ae.gl;this.targetColorTexture=new F.T(Ae,qe,pt.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new F.T(Ae,qe,pt.RGBA8,{useMipmap:!1}),this.context=Ae,this.updateParticleTexture(Oe,Ve),this.lastInvalidatedAt=0}updateParticleTexture(Ae,Oe){if(this.particleTextureDimension===Oe.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const Fe=this.context.gl,Ve=Oe.width*Oe.height;this.particleTexture0=new F.T(this.context,Oe,Fe.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new F.T(this.context,Oe,Fe.RGBA8,{premultiply:!1,useMipmap:!1});const qe=new F.db;qe.reserve(Ve);for(let F=0;F<Ve;F++)qe.emplaceBack(F);this.particleIndexBuffer=this.context.createVertexBuffer(qe,xp.members,!0),this.particleSegment=F.b7.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=Oe.width}update(Ae){return!(this.lastInvalidatedAt<Ae&&(this.lastInvalidatedAt=F.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Yr(Ae,Oe,Fe){if(!Ae)return null;const Ve=Oe.getTextureDescriptor(Ae,Fe,!0);if(!Ve)return null;let{texture:qe,mix:pt,offset:vt,tileSize:zt,buffer:ri,format:xi}=Ve;if(!qe||!xi)return null;let bi=!1;return"uint32"===xi&&(bi=!0,pt[3]=0,pt=lr(F.dc,pt,[0,Fe.paint.get("raster-particle-max-speed")]),vt=cr(F.dc,vt,[0,Fe.paint.get("raster-particle-max-speed")])),{texture:qe,textureOffset:[ri/(zt+2*ri),zt/(zt+2*ri)],tileSize:zt,scalarData:bi,scale:pt,offset:vt,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[xi]]}}function Jr(F){const Ae=F._nearZ,Oe=F.projection.farthestPixelDistance(F),Fe=Oe-Ae,Ve=.2*F.height,qe=Ae+Ve;return[Ae,Oe,(qe-Ve-Ae)/Fe,(qe-Ae)/Fe]}const vp=new F.aj(1,0,0,1),wp=new F.aj(0,1,0,1),Mp=new F.aj(0,0,1,1),Ip=new F.aj(1,0,1,1),Pp=new F.aj(0,1,1,1);function sa(Ae,Oe,Fe,Ve,qe,pt,vt){const zt=Ae.context,ri=Ae.transform,xi=zt.gl,bi="globe"===ri.projection.name,wi=bi?["PROJECTION_GLOBE_VIEW"]:[];let dr=F.ab.mat4.clone(Fe.projMatrix);if(bi&&F.ae(ri.zoom)>0){const Ae=F.ba(Fe.canonical,ri),Oe=F.dd(Ae);dr=F.ab.mat4.multiply(new Float32Array(16),ri.globeMatrix,Oe),F.ab.mat4.multiply(dr,ri.projMatrix,dr)}const jr=F.ab.mat4.create();jr[12]+=2*qe/(F.q.devicePixelRatio*ri.width),jr[13]+=2*pt/(F.q.devicePixelRatio*ri.height),F.ab.mat4.multiply(dr,jr,dr);const Qr=Ae.getOrCreateProgram("debug",{defines:wi}),Xn=Oe.getTileByID(Fe.key);Ae.terrain&&Ae.terrain.setupElevationDraw(Xn,Qr);const ho=Bi.disabled,yo=Ui.disabled,zo=Ae.colorModeForRenderPass(),ko="$debug";zt.activeTexture.set(xi.TEXTURE0),Ae.emptyTexture.bind(xi.LINEAR,xi.CLAMP_TO_EDGE),bi?Xn._makeGlobeTileDebugBuffers(Ae.context,ri):Xn._makeDebugTileBoundsBuffers(Ae.context,ri.projection);const Uo=Xn._tileDebugBuffer||Ae.debugBuffer,ia=Xn._tileDebugIndexBuffer||Ae.debugIndexBuffer,_a=Xn._tileDebugSegments||Ae.debugSegments;if(Qr.draw(Ae,xi.LINE_STRIP,ho,yo,zo,Vi.disabled,rr(dr,Ve),ko,Uo,ia,_a,null,null,null,[Xn._globeTileDebugBorderBuffer]),vt){const F=Xn.latestRawTileData,Oe=Math.floor((F&&F.byteLength||0)/1024);let Ve=Fe.canonical.toString();Fe.overscaledZ!==Fe.canonical.z&&(Ve+=` => ${Fe.overscaledZ}`),Ve+=` ${Xn.state}`,Ve+=` ${Oe}kb`,function(F,Ae){F.initDebugOverlayCanvas();const Oe=F.debugOverlayCanvas,Fe=F.context.gl,Ve=F.debugOverlayCanvas.getContext("2d");Ve.clearRect(0,0,Oe.width,Oe.height),Ve.shadowColor="white",Ve.shadowBlur=2,Ve.lineWidth=1.5,Ve.strokeStyle="white",Ve.textBaseline="top",Ve.font="bold 36px Open Sans, sans-serif",Ve.fillText(Ae,5,5),Ve.strokeText(Ae,5,5),F.debugOverlayTexture.update(Oe),F.debugOverlayTexture.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE)}(Ae,Ve)}const Ma=Oe.getTile(Fe).tileSize,Ea=512/Math.min(Ma,512)*(Fe.overscaledZ/ri.zoom)*.5,Ia=Xn._tileDebugTextBuffer||Ae.debugBuffer,rl=Xn._tileDebugTextIndexBuffer||Ae.quadTriangleIndexBuffer,Sl=Xn._tileDebugTextSegments||Ae.debugSegments;Qr.draw(Ae,xi.TRIANGLES,ho,yo,ki.alphaBlended,Vi.disabled,rr(dr,F.aj.transparent,Ea),ko,Ia,rl,Sl,null,null,null,[Xn._globeTileDebugTextBuffer])}function ra(F,Ae,Oe,Fe){na(F,0,Ae+Oe/2,F.transform.width,Oe,Fe)}function aa(F,Ae,Oe,Fe){na(F,Ae-Oe/2,0,Oe,F.transform.height,Fe)}function na(Ae,Oe,Fe,Ve,qe,pt){const vt=Ae.context,zt=vt.gl;zt.enable(zt.SCISSOR_TEST),zt.scissor(Oe*F.q.devicePixelRatio,Fe*F.q.devicePixelRatio,Ve*F.q.devicePixelRatio,qe*F.q.devicePixelRatio),vt.clear({color:pt}),zt.disable(zt.SCISSOR_TEST)}const Rp=F.da([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:Op}=Rp;function ha(F,Ae,Oe,Fe){F.emplaceBack(Ae,Oe,Fe)}class ua{constructor(Ae){this.vertexArray=new F.de,this.indices=new F.aU,ha(this.vertexArray,-1,-1,1),ha(this.vertexArray,1,-1,1),ha(this.vertexArray,-1,1,1),ha(this.vertexArray,1,1,1),ha(this.vertexArray,-1,-1,-1),ha(this.vertexArray,1,-1,-1),ha(this.vertexArray,-1,1,-1),ha(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=Ae.createVertexBuffer(this.vertexArray,Op),this.indexBuffer=Ae.createIndexBuffer(this.indices),this.segment=F.b7.simpleSegment(0,0,36,12)}}function da(Ae,Oe,Fe,Ve,qe,pt){const vt=Ae.context.gl,zt=Oe.paint.get("sky-atmosphere-color"),ri=Oe.paint.get("sky-atmosphere-halo-color"),xi=Oe.paint.get("sky-atmosphere-sun-intensity"),bi=((F,Ae,Oe,Fe,Ve)=>({u_matrix_3f:F,u_sun_direction:Ae,u_sun_intensity:Oe,u_color_tint_r:[Fe.r,Fe.g,Fe.b,Fe.a],u_color_tint_m:[Ve.r,Ve.g,Ve.b,Ve.a],u_luminance:5e-5}))(F.ab.mat3.fromMat4(F.ab.mat3.create(),Ve),qe,xi,zt,ri);vt.framebufferTexture2D(vt.FRAMEBUFFER,vt.COLOR_ATTACHMENT0,vt.TEXTURE_CUBE_MAP_POSITIVE_X+pt,Oe.skyboxTexture,0),Fe.draw(Ae,vt.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,Vi.frontCW,bi,"skyboxCapture",Oe.skyboxGeometry.vertexBuffer,Oe.skyboxGeometry.indexBuffer,Oe.skyboxGeometry.segment)}const Np=F.da([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class pa{constructor(Ae){const Oe=new F.df;Oe.emplaceBack(-1,1,1,0,0),Oe.emplaceBack(1,1,1,1,0),Oe.emplaceBack(1,-1,1,1,1),Oe.emplaceBack(-1,-1,1,0,1);const Fe=new F.aU;Fe.emplaceBack(0,1,2),Fe.emplaceBack(2,3,0),this.vertexBuffer=Ae.createVertexBuffer(Oe,Np.members),this.indexBuffer=Ae.createIndexBuffer(Fe),this.segments=F.b7.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Vp=F.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class ma{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class ga{constructor(Ae){this.colorModeAlphaBlendedWriteRGB=new ki([1,Ch,1,Ch],F.aj.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ki([1,0,1,0],F.aj.transparent,[!1,!1,!1,!0]),this.params=new ma,this.updateNeeded=!0,Ae.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),Ae.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),Ae.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),Ae.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(Ae){const Oe=Ae.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new pa(Oe);const Ae=this.params.sizeRange,Fe=this.params.intensityRange,Ve=function(Ae){const Oe=F.di(30),Fe=[];for(let Ve=0;Ve<Ae;++Ve){const Ae=2*Math.PI*Oe(),Ve=Math.acos(1-2*Oe())-.5*Math.PI;Fe.push(F.ab.vec3.fromValues(Math.cos(Ve)*Math.cos(Ae),Math.cos(Ve)*Math.sin(Ae),Math.sin(Ve)))}return Fe}(this.params.starsCount),qe=F.di(300),pt=new F.dg,vt=new F.aU;let zt=0;for(let Oe=0;Oe<Ve.length;++Oe){const ri=F.ab.vec3.scale([],Ve[Oe],200),xi=Math.max(0,1+.01*Ae*(1*qe()-.5)),bi=Math.max(0,1+.01*Fe*(1*qe()-.5));pt.emplaceBack(ri[0],ri[1],ri[2],-1,-1,xi,bi),pt.emplaceBack(ri[0],ri[1],ri[2],1,-1,xi,bi),pt.emplaceBack(ri[0],ri[1],ri[2],1,1,xi,bi),pt.emplaceBack(ri[0],ri[1],ri[2],-1,1,xi,bi),vt.emplaceBack(zt+0,zt+1,zt+2),vt.emplaceBack(zt+0,zt+2,zt+3),zt+=4}this.starsVx=Oe.createVertexBuffer(pt,Vp.members),this.starsIdx=Oe.createIndexBuffer(vt),this.starsSegments=F.b7.simpleSegment(0,0,pt.length,vt.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(Ae,Oe){const Fe=Ae.context,Ve=Fe.gl,qe=Ae.transform,pt=new Bi(Ve.LEQUAL,Bi.ReadOnly,[0,1]),vt=F.ae(qe.zoom),zt=Ae.style.getLut(Oe.scope),ri="none"===Oe.properties.get("color-use-theme"),xi=Oe.properties.get("color").toRenderColor(ri?null:zt).toArray01(),bi="none"===Oe.properties.get("high-color-use-theme"),wi=Oe.properties.get("high-color").toRenderColor(bi?null:zt).toArray01(),dr="none"===Oe.properties.get("space-color-use-theme"),jr=Oe.properties.get("space-color").toRenderColor(dr?null:zt).toArray01PremultipliedAlpha(),Qr=5e-4,Xn=F.dh(Oe.properties.get("horizon-blend"),0,1,Qr,.25),ho=F.cC(Ae,Fe,qe)&&Xn===Qr?qe.worldSize/(2*Math.PI*1.025)-1:qe.globeRadius,yo=Ae.frameCounter/1e3%1,zo=F.ab.vec3.length(qe.globeCenterInViewSpace),ko=Math.sqrt(Math.pow(zo,2)-Math.pow(ho,2)),Uo=Math.acos(ko/zo),w=F=>{const Oe="globe"===qe.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];F&&Oe.push("ALPHA_PASS");const zt=Ae.getOrCreateProgram("globeAtmosphere",{defines:Oe}),ri=((F,Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi)=>({u_frustum_tl:F,u_frustum_tr:Ae,u_frustum_br:Oe,u_frustum_bl:Fe,u_horizon:Ve,u_transition:qe,u_fadeout_range:pt,u_color:vt,u_high_color:zt,u_space_color:ri,u_temporal_offset:xi,u_horizon_angle:bi}))(qe.frustumCorners.TL,qe.frustumCorners.TR,qe.frustumCorners.BR,qe.frustumCorners.BL,qe.frustumCorners.horizon,vt,Xn,xi,wi,jr,yo,Uo);Ae.uploadCommonUniforms(Fe,zt);const bi=this.atmosphereBuffer;bi&&zt.draw(Ae,Ve.TRIANGLES,pt,Ui.disabled,F?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Vi.backCW,ri,F?"atmosphere_glow_alpha":"atmosphere_glow",bi.vertexBuffer,bi.indexBuffer,bi.segments)};w(!1),w(!0)}drawStars(Ae,Oe){const Fe=F.aw(Oe.properties.get("star-intensity"),0,1);if(0===Fe)return;const Ve=Ae.context,qe=Ve.gl,pt=Ae.transform,vt=Ae.getOrCreateProgram("stars"),zt=F.ab.quat.identity([]);F.ab.quat.rotateX(zt,zt,-pt._pitch),F.ab.quat.rotateZ(zt,zt,-pt.angle),F.ab.quat.rotateX(zt,zt,F.ai(pt._center.lat)),F.ab.quat.rotateY(zt,zt,-F.ai(pt._center.lng));const ri=F.ab.mat4.fromQuat(new Float32Array(16),zt),xi=F.ab.mat4.multiply([],pt.starsProjMatrix,ri),bi=F.ab.mat3.fromMat4([],ri),wi=F.ab.mat3.invert([],bi),dr=[0,1,0];F.ab.vec3.transformMat3(dr,dr,wi),F.ab.vec3.scale(dr,dr,this.params.sizeMultiplier);const jr=[1,0,0];F.ab.vec3.transformMat3(jr,jr,wi),F.ab.vec3.scale(jr,jr,this.params.sizeMultiplier);const Qr=(Xn=dr,ho=jr,yo=Fe,{u_matrix:Float32Array.from(xi),u_up:Xn,u_right:ho,u_intensity_multiplier:yo});var Xn,ho,yo;Ae.uploadCommonUniforms(Ve,vt),this.starsVx&&this.starsIdx&&vt.draw(Ae,qe.TRIANGLES,Bi.disabled,Ui.disabled,this.colorModeAlphaBlendedWriteRGB,Vi.disabled,Qr,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function va(Ae,Oe){const Fe=[...Ae],Ve=Oe.cameraWorldSizeForFog/Oe.worldSize,qe=F.ab.mat4.identity([]);return F.ab.mat4.scale(qe,qe,[Ve,Ve,1]),F.ab.mat4.multiply(Fe,qe,Fe),F.ab.mat4.multiply(Fe,Oe.worldToFogMatrix,Fe),Fe}function ya(Ae,Oe,Fe,Ve,qe){const pt=Fe.material,vt=Ve.context,{baseColorTexture:zt,metallicRoughnessTexture:ri}=pt.pbrMetallicRoughness,{normalTexture:xi,occlusionTexture:bi,emissionTexture:wi}=pt;function _(F,Oe,Fe){if(F&&(Ae.push(Oe),vt.activeTexture.set(vt.gl.TEXTURE0+Fe),F.gfxTexture)){const{minFilter:Ae,magFilter:Oe,wrapS:Fe,wrapT:Ve}=F.sampler;F.gfxTexture.bindExtraParam(Ae,Oe,Fe,Ve)}}_(zt,"HAS_TEXTURE_u_baseColorTexture",Oh.BaseColor),_(ri,"HAS_TEXTURE_u_metallicRoughnessTexture",Oh.MetallicRoughness),_(xi,"HAS_TEXTURE_u_normalTexture",Oh.Normal),_(bi,"HAS_TEXTURE_u_occlusionTexture",Oh.Occlusion),_(wi,"HAS_TEXTURE_u_emissionTexture",Oh.Emission),qe&&(qe.texture||(qe.texture=new F.dk(Ve.context,qe.image,[qe.image.height,qe.image.height,qe.image.height],vt.gl.RGBA8)),vt.activeTexture.set(vt.gl.TEXTURE0+Oh.LUT),qe.texture&&qe.texture.bind(vt.gl.LINEAR,vt.gl.CLAMP_TO_EDGE),Ae.push("APPLY_LUT_ON_GPU")),Fe.texcoordBuffer&&(Ae.push("HAS_ATTRIBUTE_a_uv_2f"),Oe.push(Fe.texcoordBuffer)),Fe.colorBuffer&&(Ae.push(12===Fe.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),Oe.push(Fe.colorBuffer)),Fe.normalBuffer&&(Ae.push("HAS_ATTRIBUTE_a_normal_3f"),Oe.push(Fe.normalBuffer)),Fe.pbrBuffer&&(Ae.push("HAS_ATTRIBUTE_a_pbr"),Ae.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),Oe.push(Fe.pbrBuffer)),"OPAQUE"!==pt.alphaMode&&"MASK"!==pt.alphaMode||Ae.push("UNPREMULT_TEXTURE_IN_SHADER"),pt.defined||Ae.push("DIFFUSE_SHADED");const dr=Ve.shadowRenderer;dr&&(Ae.push("RENDER_SHADOWS","DEPTH_TEXTURE"),dr.useNormalOffset&&Ae.push("NORMAL_OFFSET"))}function xa(Ae,Oe,Fe,Ve,qe,pt){const vt=Fe.paint.get("model-opacity").constantOr(1),zt=Oe.context,ri=new Bi(Oe.context.gl.LEQUAL,Bi.ReadWrite,Oe.depthRangeFor3D),xi=Oe.transform,bi=Ae.mesh,wi=bi.material,dr=wi.pbrMetallicRoughness,jr=Oe.style.fog;let Qr;Qr="pixels"===Oe.transform.projection.zAxisUnit?[...Ae.nodeModelMatrix]:F.ab.mat4.multiply([],Ve.zScaleMatrix,Ae.nodeModelMatrix),F.ab.mat4.multiply(Qr,Ve.negCameraPosMatrix,Qr);const Xn=F.ab.mat4.invert([],Qr);F.ab.mat4.transpose(Xn,Xn);const ho="none"===Fe.paint.get("model-color-use-theme").constantOr("default"),yo=Fe.paint.get("model-emissive-strength").constantOr(0),zo=br(new Float32Array(Ae.worldViewProjection),new Float32Array(Qr),new Float32Array(Xn),null,Oe,vt,dr.baseColorFactor.toRenderColor(null),wi.emissiveFactor,dr.metallicFactor,dr.roughnessFactor,wi,yo,Fe),ko={defines:[]},Uo=[],ia=Oe.shadowRenderer;ia&&(ia.useNormalOffset=!1),ya(ko.defines,Uo,bi,Oe,ho?null:Fe.lut);let _a=null;if(jr){const F=va(Ae.nodeModelMatrix,Oe.transform);if(_a=new Float32Array(F),"globe"!==xi.projection.name){const Ae=bi.aabb.min,Oe=bi.aabb.max,[Fe,Ve]=jr.getOpacityForBounds(F,Ae[0],Ae[1],Oe[0],Oe[1]);ko.overrideFog=Fe>=Jl||Ve>=Jl}}const Ma=eo(Oe,Fe.paint.get("model-cutoff-fade-range"));Ma.shouldRenderCutoff&&ko.defines.push("RENDER_CUTOFF");const Ea=Oe.getOrCreateProgram("model",ko);Oe.uploadCommonUniforms(zt,Ea,null,_a,Ma),"shadow"!==Oe.renderPass&&ia&&ia.setupShadowsFromMatrix(Ae.nodeModelMatrix,Ea),Ea.draw(Oe,zt.gl.TRIANGLES,ri,qe,pt,bi.material.doubleSided?Vi.disabled:Vi.backCCW,zo,Fe.id,bi.vertexBuffer,bi.indexBuffer,bi.segments,Fe.paint,Oe.transform.zoom,void 0,Uo)}function ba(Ae,Oe,Fe,Ve,qe,pt,vt){let zt;zt="globe"===Ae.projection.name?F.dl(Fe,Ae):[...Fe],F.ab.mat4.multiply(zt,zt,Oe.matrix);const ri=F.ab.mat4.multiply([],Ve,zt);if(Oe.meshes)for(const Fe of Oe.meshes){if("BLEND"!==Fe.material.alphaMode){vt.push({mesh:Fe,depth:0,modelIndex:qe,worldViewProjection:ri,nodeModelMatrix:zt});continue}const Oe=F.ab.vec3.transformMat4([],Fe.centroid,ri);!Ae.isOrthographic&&Oe[2]<=0||pt.push({mesh:Fe,depth:Oe[2],modelIndex:qe,worldViewProjection:ri,nodeModelMatrix:zt})}if(Oe.children)for(const F of Oe.children)ba(Ae,F,Fe,Ve,qe,pt,vt)}function wa(F,Ae,Oe,Fe){const Ve=Oe.shadowRenderer;if(!Ve)return;const qe=Ve.getShadowPassDepthMode(),pt=Ve.getShadowPassColorMode(),vt=Ve.calculateShadowPassMatrixFromMatrix(Ae),zt=wr(vt);Oe.getOrCreateProgram("modelDepth",{defines:Oe._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(Oe,Oe.context.gl.TRIANGLES,qe,Ui.disabled,pt,Vi.backCCW,zt,Fe.id,F.vertexBuffer,F.indexBuffer,F.segments,Fe.paint,Oe.transform.zoom,void 0,void 0)}function Ta(Ae,Oe,Fe){const Ve=Oe.updateZoomBasedPaintProperties(),qe=function(Ae,Oe,Fe){let Ve,qe,pt,vt=Ae.terrain?Ae.terrain.exaggeration():0;if(Ae.terrain&&vt>0){const Oe=Ae.terrain,qe=Oe.findDEMTileFor(Fe);qe&&qe.dem?Ve=F.dn.create(Oe,Fe,qe):vt=0}if(0===vt&&(Oe.terrainElevationMin=0,Oe.terrainElevationMax=0),vt===Oe.validForExaggeration&&(0===vt||Ve&&Ve._demTile&&Ve._demTile.tileID===Oe.validForDEMTile.id&&Ve._dem._timestamp===Oe.validForDEMTile.timestamp))return!1;for(const F in Oe.instancesPerModel){const Ae=Oe.instancesPerModel[F];for(let F=0;F<Ae.instancedDataArray.length;++F){const Fe=(Ve?vt*Ve.getElevationAt(0|Ae.instancedDataArray.float32[16*F],0|Ae.instancedDataArray.float32[16*F+1],!0,!0):0)+Ae.instancesEvaluatedElevation[F];Ae.instancedDataArray.float32[16*F+6]=Fe,qe=qe?Math.min(Oe.terrainElevationMin,Fe):Fe,pt=pt?Math.max(Oe.terrainElevationMax,Fe):Fe}}return Oe.terrainElevationMin=qe||0,Oe.terrainElevationMax=pt||0,Oe.validForExaggeration=vt,Oe.validForDEMTile=Ve&&Ve._demTile?{id:Ve._demTile.tileID,timestamp:Ve._dem._timestamp}:{id:void 0,timestamp:0},!0}(Ae,Oe,Fe);(Ve||qe)&&(Oe.uploaded=!1,Oe.upload(Ae.context))}const Up={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new F.cd([0,0,0],[F.ag,F.ag,0])};function Sa(Ae,Oe){const Fe=1<<Ae.canonical.z,Ve=Oe.getFreeCameraOptions().position,qe=Oe.elevation,pt=Ae.canonical.x/Fe,vt=(Ae.canonical.x+1)/Fe,zt=Ae.canonical.y/Fe,ri=(Ae.canonical.y+1)/Fe;let xi=Oe._centerAltitude;if(qe){const F=qe.getMinMaxForTile(Ae);F&&F.max>xi&&(xi=F.max)}const bi=F.aw(Ve.x,pt,vt)-Ve.x,wi=F.aw(Ve.y,zt,ri)-Ve.y,dr=F.bH(xi,Oe.center.lat)-Ve.z;return Oe._zoomFromMercatorZ(Math.sqrt(bi*bi+wi*wi+dr*dr))}function Ca(F,Ae,Oe,Fe,Ve,qe,pt){const vt=F.context,zt="shadow"===F.renderPass,ri=F.shadowRenderer,xi=zt&&ri?ri.getShadowPassDepthMode():new Bi(vt.gl.LEQUAL,Bi.ReadWrite,F.depthRangeFor3D),bi=F.isTileAffectedByFog(qe);if(Oe.meshes)for(const wi of Oe.meshes){const dr=["MODEL_POSITION_ON_GPU"],jr=[];let Qr,Xn,ho;Fe.instancedDataArray.length>20&&dr.push("INSTANCED_ARRAYS");const yo=eo(F,Ae.paint.get("model-cutoff-fade-range"));if(yo.shouldRenderCutoff&&dr.push("RENDER_CUTOFF"),zt&&ri)Qr=F.getOrCreateProgram("modelDepth",{defines:dr}),Xn=wr(pt.shadowTileMatrix,pt.shadowTileMatrix,Float32Array.from(Oe.matrix)),ho=ri.getShadowPassColorMode();else{ya(dr,jr,wi,F,"none"===Ae.paint.get("model-color-use-theme").constantOr("default")?null:Ae.lut),Qr=F.getOrCreateProgram("model",{defines:dr,overrideFog:bi});const Fe=wi.material,zt=Fe.pbrMetallicRoughness,xi=Ae.paint.get("model-opacity").constantOr(1),zo=Ae.paint.get("model-emissive-strength").constantOr(0);Xn=br(qe.expandedProjMatrix,Float32Array.from(Oe.matrix),new Float32Array(16),null,F,xi,zt.baseColorFactor.toRenderColor(null),Fe.emissiveFactor,zt.metallicFactor,zt.roughnessFactor,Fe,zo,Ae,Ve),ri&&(pt.shadowUniformsInitialized?Qr.setShadowUniformValues(vt,ri.getShadowUniformValues()):(ri.setupShadows(qe.toUnwrapped(),Qr,"model-tile",qe.overscaledZ),pt.shadowUniformsInitialized=!0)),ho=yo.shouldRenderCutoff||xi<1||"OPAQUE"!==Fe.alphaMode?ki.alphaBlended:ki.unblended}F.uploadCommonUniforms(vt,Qr,qe.toUnwrapped(),null,yo);const zo=wi.material.doubleSided?Vi.disabled:Vi.backCCW;if(Fe.instancedDataArray.length>20)jr.push(Fe.instancedDataBuffer),Qr.draw(F,vt.gl.TRIANGLES,xi,Ui.disabled,ho,zo,Xn,Ae.id,wi.vertexBuffer,wi.indexBuffer,wi.segments,Ae.paint,F.transform.zoom,void 0,jr,Fe.instancedDataArray.length);else{const Oe=zt?"u_instance":"u_normal_matrix";for(let Ve=0;Ve<Fe.instancedDataArray.length;++Ve)Xn[Oe]=new Float32Array(Fe.instancedDataArray.arrayBuffer,64*Ve,16),Qr.draw(F,vt.gl.TRIANGLES,xi,Ui.disabled,ho,zo,Xn,Ae.id,wi.vertexBuffer,wi.indexBuffer,wi.segments,Ae.paint,F.transform.zoom,void 0,jr)}}if(Oe.children)for(const vt of Oe.children)Ca(F,Ae,vt,Fe,Ve,qe,pt)}const jp=[1,-1,1];function Ra(Ae,Oe,Fe,Ve){if(!Fe.modelManager)return!0;const qe=Fe.modelManager;if(!Fe.shadowRenderer)return!0;const pt=Fe.shadowRenderer,vt=Oe.aabb;let zt=!0,ri=Ae.maxHeight;if(0===ri){let F=0;for(const Oe in Ae.instancesPerModel){const Ae=qe.getModel(Oe,Ve);Ae?F=Math.max(F,Math.max(Math.max(Ae.aabb.max[0],Ae.aabb.max[1]),Ae.aabb.max[2])):zt=!1}ri=Ae.maxScale*F*1.41+Ae.maxVerticalOffset,zt&&(Ae.maxHeight=ri)}vt.max[2]=ri,vt.min[2]+=Ae.terrainElevationMin,vt.max[2]+=Ae.terrainElevationMax,F.ab.vec3.transformMat4(vt.min,vt.min,Oe.tileMatrix),F.ab.vec3.transformMat4(vt.max,vt.max,Oe.tileMatrix);const xi=vt.intersects(pt.getCurrentCascadeFrustum());return 0===Fe.currentShadowCascade&&(Ae.isInsideFirstShadowMapFrustum=2===xi),0===xi}function Da(Ae,Oe){const Fe=Ae.uniformValues.u_cutoff_params[0],Ve=Ae.uniformValues.u_cutoff_params[1],qe=Ae.uniformValues.u_cutoff_params[2],pt=Ae.uniformValues.u_cutoff_params[3];return Ve===Fe||pt===qe?1:F.aw(((Oe-Fe)/(Ve-Fe)-qe)/(pt-qe),0,1)}function La(Ae,Oe,Fe,Ve){if(Oe.pitch<20)return 1;const qe=Oe.getWorldToCameraMatrix();F.ab.mat4.multiply(qe,qe,Ae);const pt=F.ab.vec4.fromValues(Fe.min[0],Fe.min[1],Fe.min[2],1);let vt=F.ab.vec4.transformMat4(F.ab.vec4.create(),pt,qe),zt=vt,ri=vt;pt[1]=Fe.max[1],vt=F.ab.vec4.transformMat4(F.ab.vec4.create(),pt,qe),zt=vt[1]<zt[1]?vt:zt,ri=vt[1]>ri[1]?vt:ri,pt[0]=Fe.max[0],vt=F.ab.vec4.transformMat4(F.ab.vec4.create(),pt,qe),zt=vt[1]<zt[1]?vt:zt,ri=vt[1]>ri[1]?vt:ri,pt[1]=Fe.min[1],vt=F.ab.vec4.transformMat4(F.ab.vec4.create(),pt,qe),zt=vt[1]<zt[1]?vt:zt,ri=vt[1]>ri[1]?vt:ri;const xi=F.aw(Ve[0],0,1),bi=100*Oe.pixelsPerMeter*F.aw(Ve[1],0,1),wi=F.aw(Ve[2],0,1),dr=F.ab.vec4.lerp(F.ab.vec4.create(),zt,ri,xi),jr=Math.tan(.5*Oe.fovX),Qr=-dr[2]*jr;if(0===bi)return dr[1]<-Math.abs(Qr)?wi:1;const Xn=(-Math.abs(Qr)-dr[1])/bi,g=(F,Ae,Oe)=>(1-Oe)*F+Oe*Ae,ho=F.aw(g(1,wi,Xn),wi,1);return g(1,ho,F.aw((Oe.pitch-20)/20,0,1))}class Aa{}class za{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(Ae,Oe,Fe){{const F=this._storage.get(Oe.id);if(F)return F.lastUsedFrameIdx=Ae,F.buf}const Ve=Fe.gl,qe=Ve.getBufferParameter(Ve.ELEMENT_ARRAY_BUFFER,Ve.BUFFER_SIZE),pt=new ArrayBuffer(qe),vt=new Int16Array(pt);Ve.getBufferSubData(Ve.ELEMENT_ARRAY_BUFFER,0,new Int16Array(pt));const zt=new F.dq;for(let F=0;F<qe/2;F+=3){const Ae=vt[F],Oe=vt[F+1],Fe=vt[F+2];zt.emplaceBack(Ae,Oe),zt.emplaceBack(Oe,Fe),zt.emplaceBack(Fe,Ae)}const ri=Fe.bindVertexArrayOES.current,xi=new Aa;return xi.buf=new Er(Fe,zt),xi.lastUsedFrameIdx=Ae,this._storage.set(Oe.id,xi),Fe.bindVertexArrayOES.set(ri),xi.buf}update(F){for(const[Ae,Oe]of this._storage)F-Oe.lastUsedFrameIdx>30&&(Oe.buf.destroy(),this._storage.delete(Ae))}destroy(){for(const[F,Ae]of this._storage)Ae.buf.destroy(),this._storage.delete(F)}}class Pa{constructor(F){this.occluderSize=30,this.depthOffset=-1e-4,F.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),F.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const Gp=F.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Oa{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Fa{constructor(F,Ae){this.revealStart=11,this.revealRange=2,F.registerParameter(this,[...Ae,"Reveal"],"revealStart",{min:0,max:17,step:.05}),F.registerParameter(this,[...Ae,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const qp=F.da([{type:"Float32",name:"a_pos_2f",components:2}]);class Ba{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(Ae,Oe){const Fe=Ae.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const Oe=new F.dr,Fe=new F.aU;Oe.emplaceBack(-1,-1),Oe.emplaceBack(1,-1),Oe.emplaceBack(1,1),Oe.emplaceBack(-1,1),Fe.emplaceBack(0,1,2),Fe.emplaceBack(0,2,3),this.vignetteVx=Ae.context.createVertexBuffer(Oe,qp.members),this.vignetteIdx=Ae.context.createIndexBuffer(Fe)}const Ve=F.b7.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){Ae.uploadCommonUniforms(Ae.context,Fe);const F={u_vignetteShape:(qe={vignetteShape:[Oe.start,Oe.range,Math.pow(10,Oe.fadePower)],vignetteColor:[Oe.color.r,Oe.color.g,Oe.color.b,Oe.color.a*Oe.strength]}).vignetteShape,u_vignetteColor:qe.vignetteColor};Fe.draw(Ae,Ae.context.gl.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,Vi.disabled,F,"vignette",this.vignetteVx,this.vignetteIdx,Ve,{})}var qe}}class Na{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(Ae,Oe){const Fe=Ae.getFreeCameraOptions().position,Ve=Fe.toAltitude(),qe=Fe.toLngLat(),pt=F.ai(qe.lng),vt=F.ai(qe.lat),zt=Ae.pixelsPerMeter/Oe,ri=pt*F.ds,xi=F.ds*Math.log(Math.tan(Math.PI/4+vt/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const F=-this._offsetYPrev+xi,Ae=-this._elevationPrev+Ve;this._accumulatedOffsetX+=(-this._offsetXPrev+ri)*zt,this._accumulatedOffsetY+=F*zt,this._accumulatedElevation+=Ae*zt,this._offsetXPrev=ri,this._offsetYPrev=xi,this._elevationPrev=Ve}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Ua(F,Ae){return[-(F[0]-Math.floor(F[0]/Ae)*Ae),-(F[1]-Math.floor(F[1]/Ae)*Ae),-(F[2]-Math.floor(F[2]/Ae)*Ae)]}function ja(Ae){const Oe=F.di(1323123451230),Fe=[];for(let Ve=0;Ve<Ae;++Ve){const Ae=2*Oe()-1,Ve=2*Oe()-1,qe=2*Oe()-1;Fe.push(F.ab.vec3.fromValues(Ae,Ve,qe))}return Fe}function Ga(Ae,Oe,Fe,Ve,qe){const pt=F.aw((qe-Fe)/(Ve-Fe),0,1);return(1-pt)*Ae+pt*Oe}class Va{constructor(F){this._movement=new Na,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Ba,this._ppmScaleFactor=F}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(Ae,Oe){const Fe=Ae.transform;this._movement.update(Fe,this._ppmScaleFactor);const Ve=Fe.starsProjMatrix,qe=F.ab.quat.identity([]);F.ab.quat.rotateX(qe,qe,F.ai(90)-Fe._pitch),F.ab.quat.rotateZ(qe,qe,-Fe.angle);const pt=F.ab.mat4.fromQuat(new Float32Array(16),qe),vt=F.ab.mat4.fromValues(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),zt=F.ab.mat4.transpose([],vt),ri=F.ab.mat4.multiply([],zt,pt),xi=Date.now()/1e3;return this._accumulatedTimeFromStart+=(xi-this._prevTime)*Oe,this._prevTime=xi,{projectionMatrix:Ve,modelviewMatrix:ri}}}class qa extends Va{constructor(F){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Fa(F.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(Ae){const Oe=Ae.context;if(!this.particlesVx){const Ae=ja(this.particlesCount),Fe=new F.dt,Ve=new F.aU;let qe=0;const pt=F.di(1323123451230);for(let F=0;F<Ae.length;++F){const Oe=Ae[F],vt=[2*pt()-1,pt(),pt(),pt()];Fe.emplaceBack(Oe[0],Oe[1],Oe[2],-1,-1,...vt),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],1,-1,...vt),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],1,1,...vt),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],-1,1,...vt),Ve.emplaceBack(qe+0,qe+1,qe+2),Ve.emplaceBack(qe+0,qe+2,qe+3),qe+=4}this.particlesVx=Oe.createVertexBuffer(Fe,Gp.members),this.particlesIdx=Oe.createIndexBuffer(Ve)}}draw(Ae){if(!this._params.overrideStyleParameters&&!Ae.style.rain)return;const Oe=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},Fe=Ae.transform.zoom;if(Oe.revealStart>Fe)return;const Ve=Ga(0,1,Oe.revealStart,Oe.revealStart+Oe.revealRange,Fe);if(!this.particlesVx||!this.particlesIdx)return;const qe=structuredClone(this._params);let pt=[-qe.direction.x,qe.direction.y,-100];F.ab.vec3.normalize(pt,pt);const vt=structuredClone(this._vignetteParams);vt.strength*=Ve,qe.overrideStyleParameters||(qe.intensity=Ae.style.rain.state.density,qe.timeFactor=Ae.style.rain.state.intensity,qe.color=structuredClone(Ae.style.rain.state.color),pt=structuredClone(Ae.style.rain.state.direction),qe.screenThinning.intensity=Ae.style.rain.state.centerThinning,qe.dropletSizeX=Ae.style.rain.state.dropletSize[0],qe.dropletSizeYScale=Ae.style.rain.state.dropletSize[1]/Ae.style.rain.state.dropletSize[0],qe.distortionStrength=100*Ae.style.rain.state.distortionStrength,vt.strength=1,vt.color=structuredClone(Ae.style.rain.state.vignetteColor));const zt=this.updateOnRender(Ae,qe.timeFactor),ri=Ae.context,xi=ri.gl,bi=Ae.transform;this.screenTexture&&this.screenTexture.size[0]===Ae.width&&this.screenTexture.size[1]===Ae.height||(this.screenTexture=new F.T(ri,{width:Ae.width,height:Ae.height,data:null},xi.RGBA8)),qe.distortionStrength>0&&(ri.activeTexture.set(xi.TEXTURE0),this.screenTexture.bind(xi.LINEAR,xi.CLAMP_TO_EDGE),xi.copyTexSubImage2D(xi.TEXTURE_2D,0,0,0,0,0,Ae.width,Ae.height));const wi=Ae.getOrCreateProgram("rainParticle");Ae.uploadCommonUniforms(ri,wi),ri.activeTexture.set(xi.TEXTURE0),this.screenTexture.bind(xi.LINEAR,xi.CLAMP_TO_EDGE);const dr=[qe.color.r,qe.color.g,qe.color.b,qe.color.a],p=(Oe,Fe)=>{const Ve=Ua(this._movement.getPosition(),Oe),vt=qe.dropletSizeX,ri=qe.dropletSizeX*qe.dropletSizeYScale,jr=Ae.width/2,Qr=Ae.height/2,Xn=Ga(0,qe.screenThinning.start,0,1,qe.screenThinning.intensity),ho=Ga(.001,qe.screenThinning.range,0,1,qe.screenThinning.intensity),yo=Ga(0,qe.screenThinning.particleOffset,0,1,qe.screenThinning.intensity),zo=(ko={modelview:zt.modelviewMatrix,projection:zt.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:Ve,velocityConeAperture:qe.velocityConeAperture,velocity:qe.velocity,boxSize:Oe,rainDropletSize:[vt,ri],distortionStrength:qe.distortionStrength,rainDirection:pt,color:dr,screenSize:[bi.width,bi.height],thinningCenterPos:[jr,Qr],thinningShape:[Xn,ho,Math.pow(10,qe.screenThinning.fadePower)],thinningAffectedRatio:qe.screenThinning.affectedRatio,thinningParticleOffset:yo,shapeDirectionalPower:qe.shapeDirPower,shapeNormalPower:qe.shapeNormalPower,mode:Fe?0:1},{u_modelview:Float32Array.from(ko.modelview),u_projection:Float32Array.from(ko.projection),u_time:ko.time,u_cam_pos:ko.camPos,u_texScreen:0,u_velocityConeAperture:ko.velocityConeAperture,u_velocity:ko.velocity,u_boxSize:ko.boxSize,u_rainDropletSize:ko.rainDropletSize,u_distortionStrength:ko.distortionStrength,u_rainDirection:ko.rainDirection,u_color:ko.color,u_screenSize:ko.screenSize,u_thinningCenterPos:ko.thinningCenterPos,u_thinningShape:ko.thinningShape,u_thinningAffectedRatio:ko.thinningAffectedRatio,u_thinningParticleOffset:ko.thinningParticleOffset,u_shapeDirectionalPower:ko.shapeDirectionalPower,u_shapeNormalPower:ko.shapeNormalPower,u_mode:ko.mode});var ko;const Uo=Math.round(qe.intensity*this.particlesCount),ia=F.b7.simpleSegment(0,0,4*Uo,2*Uo);wi.draw(Ae,xi.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,Vi.disabled,zo,"rain_particles",this.particlesVx,this.particlesIdx,ia,{})};qe.distortionStrength>0&&p(qe.boxSize,!0),p(qe.boxSize,!1),this._vignette.draw(Ae,vt)}}const Zp=F.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class Za extends Va{constructor(F){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Fa(F.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(Ae){const Oe=Ae.context;if(!this.particlesVx){const Ae=ja(this.particlesCount),Fe=new F.du,Ve=new F.aU;let qe=0;const pt=F.di(1323123451230);for(let F=0;F<Ae.length;++F){const Oe=Ae[F],vt=pt(),zt=pt(),ri=pt(),xi=[F/Ae.length,vt,zt,ri],bi=[pt(),pt()];Fe.emplaceBack(Oe[0],Oe[1],Oe[2],-1,-1,...xi,...bi),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],1,-1,...xi,...bi),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],1,1,...xi,...bi),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],-1,1,...xi,...bi),Ve.emplaceBack(qe+0,qe+1,qe+2),Ve.emplaceBack(qe+0,qe+2,qe+3),qe+=4}this.particlesVx=Oe.createVertexBuffer(Fe,Zp.members),this.particlesIdx=Oe.createIndexBuffer(Ve)}}draw(Ae){if(!this._params.overrideStyleParameters&&!Ae.style.snow)return;const Oe=structuredClone(this._params);let Fe=[-Oe.direction.x,Oe.direction.y,-100];F.ab.vec3.normalize(Fe,Fe);const Ve=structuredClone(this._vignetteParams),qe=Oe.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},pt=Ae.transform.zoom;if(qe.revealStart>pt)return;const vt=Ga(0,1,qe.revealStart,qe.revealStart+qe.revealRange,pt);Ve.strength*=vt,Oe.overrideStyleParameters||(Oe.intensity=Ae.style.snow.state.density,Oe.timeFactor=Ae.style.snow.state.intensity,Oe.color=structuredClone(Ae.style.snow.state.color),Fe=structuredClone(Ae.style.snow.state.direction),Oe.screenThinning.intensity=Ae.style.snow.state.centerThinning,Oe.billboardSize=2.79*Ae.style.snow.state.flakeSize,Ve.strength=1,Ve.color=structuredClone(Ae.style.snow.state.vignetteColor));const zt=this.updateOnRender(Ae,Oe.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const ri=Ae.context,xi=ri.gl,bi=Ae.transform,wi=Ae.getOrCreateProgram("snowParticle");Ae.uploadCommonUniforms(ri,wi),((Oe,Ve,qe)=>{const pt=Ua(this._movement.getPosition(),Oe),vt=bi.width/2,ri=bi.height/2,dr=Ga(0,qe.screenThinning.start,0,1,qe.screenThinning.intensity),jr=Ga(.001,qe.screenThinning.range,0,1,qe.screenThinning.intensity),Qr=Ga(0,qe.screenThinning.particleOffset,0,1,qe.screenThinning.intensity),Xn=(ho={modelview:zt.modelviewMatrix,projection:zt.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:pt,velocityConeAperture:qe.velocityConeAperture,velocity:qe.velocity,horizontalOscillationRadius:qe.horizontalOscillationRadius,horizontalOscillationRate:qe.horizontalOscillationRate,boxSize:Oe,billboardSize:1*qe.billboardSize,simpleShapeParameters:[qe.shapeFadeStart,qe.shapeFadePower],screenSize:[bi.width,bi.height],thinningCenterPos:[vt,ri],thinningShape:[dr,jr,Math.pow(10,qe.screenThinning.fadePower)],thinningAffectedRatio:qe.screenThinning.affectedRatio,thinningParticleOffset:Qr,color:[qe.color.r,qe.color.g,qe.color.b,qe.color.a],direction:Fe},{u_modelview:Float32Array.from(ho.modelview),u_projection:Float32Array.from(ho.projection),u_time:ho.time,u_cam_pos:ho.camPos,u_velocityConeAperture:ho.velocityConeAperture,u_velocity:ho.velocity,u_horizontalOscillationRadius:ho.horizontalOscillationRadius,u_horizontalOscillationRate:ho.horizontalOscillationRate,u_boxSize:ho.boxSize,u_billboardSize:ho.billboardSize,u_simpleShapeParameters:ho.simpleShapeParameters,u_screenSize:ho.screenSize,u_thinningCenterPos:ho.thinningCenterPos,u_thinningShape:ho.thinningShape,u_thinningAffectedRatio:ho.thinningAffectedRatio,u_thinningParticleOffset:ho.thinningParticleOffset,u_particleColor:ho.color,u_direction:ho.direction});var ho;const yo=Math.round(qe.intensity*this.particlesCount),zo=F.b7.simpleSegment(0,0,4*yo,2*yo);this.particlesVx&&this.particlesIdx&&wi.draw(Ae,xi.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,Vi.disabled,Xn,"snow_particles",this.particlesVx,this.particlesIdx,zo,{})})(Oe.boxSize,0,Oe),this._vignette.draw(Ae,Ve)}}const $p={symbol:function(Ae,Oe,Fe,Ve,qe){if("translucent"!==Ae.renderPass)return;const pt=Ui.disabled,vt=Ae.colorModeForRenderPass(),zt=Fe.layout.get("text-variable-anchor"),ri=Fe.layout.get("text-size-scale-range"),xi=F.aw(Ae.scaleFactor,ri[0],ri[1]);zt&&function(Ae,Oe,Fe,Ve,qe,pt,vt,zt){const ri=Oe.transform,xi="map"===qe,bi="map"===pt;for(const Oe of Ae){const Ae=Ve.getTile(Oe),qe=Ae.getBucket(Fe);if(!qe||!qe.text||!qe.text.segments.get().length)continue;const pt=F.bp(qe.textSizeData,ri.zoom,zt),wi=ci(Oe,qe.getProjection(),ri),dr=ri.calculatePixelsToTileUnitsMatrix(Ae),jr=qt(wi,Ae.tileID.canonical,bi,xi,ri,qe.getProjection(),dr),Qr=qe.hasIconTextFit()&&qe.hasIconData();if(pt){const Fe=Math.pow(2,ri.zoom-Ae.tileID.overscaledZ);Mr(qe,xi,bi,vt,F.cX,ri,jr,Oe,Fe,pt,Qr)}}}(Ve,Ae,Fe,Oe,Fe.layout.get("text-rotation-alignment"),Fe.layout.get("text-pitch-alignment"),qe,xi);const bi=0!==Fe.paint.get("icon-opacity").constantOr(1),wi=0!==Fe.paint.get("text-opacity").constantOr(1);void 0!==Fe.layout.get("symbol-sort-key").constantOr(1)&&(bi||wi)?Or(Ae,Oe,Fe,Ve,pt,vt):(bi&&Or(Ae,Oe,Fe,Ve,pt,vt,{onlyIcons:!0}),wi&&Or(Ae,Oe,Fe,Ve,pt,vt,{onlyText:!0})),Oe.map.showCollisionBoxes&&(Lr(Ae,Oe,Fe,Ve,Fe.paint.get("text-translate"),Fe.paint.get("text-translate-anchor"),!0),Lr(Ae,Oe,Fe,Ve,Fe.paint.get("icon-translate"),Fe.paint.get("icon-translate-anchor"),!1))},circle:function(Ae,Oe,Fe,Ve){if("translucent"!==Ae.renderPass)return;const qe=Fe.paint.get("circle-opacity"),pt=Fe.paint.get("circle-stroke-width"),vt=Fe.paint.get("circle-stroke-opacity"),zt=void 0!==Fe.layout.get("circle-sort-key").constantOr(1),ri=Fe.paint.get("circle-emissive-strength");if(0===qe.constantOr(1)&&(0===pt.constantOr(1)||0===vt.constantOr(1)))return;const xi=Ae.context,bi=xi.gl,wi=Ae.transform,dr=Ae.depthModeForSublayer(0,Bi.ReadOnly),jr=Ui.disabled,Qr=Ae.colorModeForDrapableLayerRenderPass(ri),Xn="globe"===wi.projection.name,ho=[F.at(wi.center.lng),F.aA(wi.center.lat)],yo=[];for(let qe=0;qe<Ve.length;qe++){const pt=Ve[qe],vt=Oe.getTile(pt),ri=vt.getBucket(Fe);if(!ri||ri.projection.name!==wi.projection.name)continue;const xi=ri.programConfigurations.get(Fe.id),bi=F.cY(Fe),dr=Ae.isTileAffectedByFog(pt);Xn&&bi.push("PROJECTION_GLOBE_VIEW"),bi.push("DEPTH_D24"),Ae.terrain&&wi.depthOcclusionForSymbolsAndCircles&&bi.push("DEPTH_OCCLUSION");const jr=Ae.getOrCreateProgram("circle",{config:xi,defines:bi,overrideFog:dr}),Qr=ri.layoutVertexBuffer,zo=ri.globeExtVertexBuffer,ko=ri.indexBuffer,Uo=wi.projection.createInversionMatrix(wi,pt.canonical),ia={programConfiguration:xi,program:jr,layoutVertexBuffer:Qr,globeExtVertexBuffer:zo,indexBuffer:ko,uniformValues:F.cZ(Ae,pt,vt,Uo,ho,Fe),tile:vt};if(zt){const Ae=ri.segments.get();for(const Oe of Ae)yo.push({segments:new F.b7([Oe]),sortKey:Oe.sortKey,state:ia})}else yo.push({segments:ri.segments,sortKey:0,state:ia})}zt&&yo.sort(((F,Ae)=>F.sortKey-Ae.sortKey));const zo={useDepthForOcclusion:wi.depthOcclusionForSymbolsAndCircles};for(const F of yo){const{programConfiguration:Oe,program:Ve,layoutVertexBuffer:qe,globeExtVertexBuffer:pt,indexBuffer:vt,uniformValues:zt,tile:ri}=F.state,Xn=F.segments;Ae.terrain&&Ae.terrain.setupElevationDraw(ri,Ve,zo),Ae.uploadCommonUniforms(xi,Ve,ri.tileID.toUnwrapped()),Ve.draw(Ae,bi.TRIANGLES,dr,jr,Qr,Vi.disabled,zt,Fe.id,qe,vt,Xn,Fe.paint,wi.zoom,Oe,[pt])}},heatmap:function(Ae,Oe,Fe,Ve){if(0!==Fe.paint.get("heatmap-opacity"))if("offscreen"===Ae.renderPass){const qe=Ae.context,pt=qe.gl,vt=Ui.disabled,zt=new ki([pt.ONE,pt.ONE,pt.ONE,pt.ONE],F.aj.transparent,[!0,!0,!0,!0]);!function(F,Ae,Oe,Fe){const Ve=F.gl,qe=Ae.width*Fe,pt=Ae.height*Fe;F.activeTexture.set(Ve.TEXTURE1),F.viewport.set([0,0,qe,pt]);let vt=Oe.heatmapFbo;if(!vt||vt&&(vt.width!==qe||vt.height!==pt)){vt&&vt.destroy();const Ae=Ve.createTexture();Ve.bindTexture(Ve.TEXTURE_2D,Ae),Ve.texParameteri(Ve.TEXTURE_2D,Ve.TEXTURE_WRAP_S,Ve.CLAMP_TO_EDGE),Ve.texParameteri(Ve.TEXTURE_2D,Ve.TEXTURE_WRAP_T,Ve.CLAMP_TO_EDGE),Ve.texParameteri(Ve.TEXTURE_2D,Ve.TEXTURE_MIN_FILTER,Ve.LINEAR),Ve.texParameteri(Ve.TEXTURE_2D,Ve.TEXTURE_MAG_FILTER,Ve.LINEAR),vt=Oe.heatmapFbo=F.createFramebuffer(qe,pt,!0,null),function(F,Ae,Oe,Fe,Ve,qe){const pt=F.gl;pt.texImage2D(pt.TEXTURE_2D,0,F.extRenderToTextureHalfFloat?pt.RGBA16F:pt.RGBA,Ve,qe,0,pt.RGBA,F.extRenderToTextureHalfFloat?pt.HALF_FLOAT:pt.UNSIGNED_BYTE,null),Fe.colorAttachment.set(Oe)}(F,0,Ae,vt,qe,pt)}else Ve.bindTexture(Ve.TEXTURE_2D,vt.colorAttachment.get()),F.bindFramebuffer.set(vt.framebuffer)}(qe,Ae,Fe,"globe"===Ae.transform.projection.name?.5:.25),qe.clear({color:F.aj.transparent});const ri=Ae.transform,xi="globe"===ri.projection.name,bi=xi?["PROJECTION_GLOBE_VIEW"]:[],wi=xi?Vi.frontCCW:Vi.disabled,dr=[F.at(ri.center.lng),F.aA(ri.center.lat)];for(let F=0;F<Ve.length;F++){const jr=Ve[F];if(Oe.hasRenderableParent(jr))continue;const Qr=Oe.getTile(jr),Xn=Qr.getBucket(Fe);if(!Xn||Xn.projection.name!==ri.projection.name)continue;const ho=Ae.isTileAffectedByFog(jr),yo=Xn.programConfigurations.get(Fe.id),zo=Ae.getOrCreateProgram("heatmap",{config:yo,defines:bi,overrideFog:ho}),{zoom:ko}=Ae.transform;Ae.terrain&&Ae.terrain.setupElevationDraw(Qr,zo),Ae.uploadCommonUniforms(qe,zo,jr.toUnwrapped());const Uo=ri.projection.createInversionMatrix(ri,jr.canonical);zo.draw(Ae,pt.TRIANGLES,Bi.disabled,vt,zt,wi,nr(Ae,jr,Qr,Uo,dr,ko,Fe.paint.get("heatmap-intensity")),Fe.id,Xn.layoutVertexBuffer,Xn.indexBuffer,Xn.segments,Fe.paint,Ae.transform.zoom,yo,xi?[Xn.globeExtVertexBuffer]:null)}qe.viewport.set([0,0,Ae.width,Ae.height])}else"translucent"===Ae.renderPass&&(Ae.context.setColorMode(Ae.colorModeForRenderPass()),function(Ae,Oe){const Fe=Ae.context,Ve=Fe.gl,qe=Oe.heatmapFbo;if(!qe)return;Fe.activeTexture.set(Ve.TEXTURE0),Ve.bindTexture(Ve.TEXTURE_2D,qe.colorAttachment.get()),Fe.activeTexture.set(Ve.TEXTURE1);let pt=Oe.colorRampTexture;pt||(pt=Oe.colorRampTexture=new F.T(Fe,Oe.colorRamp,Ve.RGBA8)),pt.bind(Ve.LINEAR,Ve.CLAMP_TO_EDGE),Ae.getOrCreateProgram("heatmapTexture").draw(Ae,Ve.TRIANGLES,Bi.disabled,Ui.disabled,Ae.colorModeForRenderPass(),Vi.disabled,((F,Ae)=>({u_image:0,u_color_ramp:1,u_opacity:Ae.paint.get("heatmap-opacity")}))(0,Oe),Oe.id,Ae.viewportBuffer,Ae.quadTriangleIndexBuffer,Ae.viewportSegments,Oe.paint,Ae.transform.zoom)}(Ae,Fe))},line:function(Ae,Oe,Fe,Ve){if("translucent"!==Ae.renderPass)return;const qe=Fe.paint.get("line-opacity"),pt=Fe.paint.get("line-width");if(0===qe.constantOr(1)||0===pt.constantOr(1))return;const vt=Fe.paint.get("line-emissive-strength"),zt=Fe.paint.get("line-occlusion-opacity"),ri=Fe.layout.get("line-elevation-reference"),xi="meters"===Fe.layout.get("line-width-unit"),bi="sea"===ri,wi=Ae.context,dr=wi.gl;if(Fe.hasElevatedBuckets&&"globe"===Ae.transform.projection.name)return;const jr=Fe.layout.get("line-cross-slope"),Qr=void 0!==jr,Xn=jr<1,ho=Ae.colorModeForDrapableLayerRenderPass(vt),yo=Ae.terrain&&Ae.terrain.renderingToTexture,zo=yo?1:F.q.devicePixelRatio,ko=Fe.paint.get("line-dasharray"),Uo=ko.constantOr(1),ia=Fe.layout.get("line-cap"),_a=ko.constantOr(null),Ma=ia.constantOr(null),Ea=Fe.paint.get("line-pattern"),Ia=Ea.constantOr(1),rl=Ea.constantOr(null),Sl=Fe.paint.get("line-opacity").constantOr(1);let Il=!Ia&&1!==Sl||Ae.depthOcclusion&&zt>0&&zt<1;const Kl=Fe.paint.get("line-gradient"),Jl=Ia?"linePattern":"line",Ql=F.c_(Fe);let ec;if(yo&&Ae.terrain&&Ae.terrain.clipOrMaskOverlapStencilType()&&(Il=!1),0!==zt&&Ae.depthOcclusion){const Ae=Fe.paint._values["line-opacity"];Ae&&Ae.value&&"constant"===Ae.value.kind?ec=Ae.value:F.w(`Occlusion opacity for layer ${Fe.id} is supported only when line-opacity isn't data-driven.`)}"constant"!==pt.value.kind&&!1===pt.value.isLineProgressConstant&&Ql.push("VARIABLE_LINE_WIDTH");const M=(Ve,qe,pt,vt,ri)=>{for(const jr of Ve){const Ve=Oe.getTile(jr);if(Ia&&!Ve.patternsLoaded())continue;const Qr=Ve.getBucket(Fe);if(!Qr)continue;if(Qr.hasZOffset&&!ri||!Qr.hasZOffset&&ri)continue;Ae.prepareDrawTile();const Xn=Qr.programConfigurations.get(Fe.id),ko=Ae.isTileAffectedByFog(jr),ia=Ae.getOrCreateProgram(Jl,{config:Xn,defines:qe,overrideFog:ko,overrideRtt:!ri&&void 0});if(rl&&Ve.imageAtlas){const Ae=F.A.from(rl).getPrimary().scaleSelf(zo).serialize(),Oe=Ve.imageAtlas.patternPositions[Ae];Oe&&Xn.setConstantPatternPositions(Oe)}if(!Ia&&_a&&Ma&&Ve.lineAtlas){const F=Ve.lineAtlas.getDash(_a,Ma);F&&Xn.setConstantPatternPositions(F)}let[Ea,Ql]=Fe.paint.get("line-trim-offset");if("round"===Ma||"square"===Ma){const F=1;Ea!==Ql&&(0===Ea&&(Ea-=F),1===Ql&&(Ql+=F))}const tc=yo?jr.projMatrix:null,cc=xi?1/Qr.tileToMeter/F.ar(Ve,1,Ae.transform.zoom):1,uc=xi?1/Qr.tileToMeter/F.ar(Ve,1,Math.floor(Ae.transform.zoom)):1,jc=Ia?F.c$(Ae,Ve,Fe,tc,zo,cc,uc,[Ea,Ql]):F.d0(Ae,Ve,Fe,tc,Qr.lineClipsArray.length,zo,cc,uc,[Ea,Ql]);if(Kl){const Ve=Qr.gradients[Fe.id];let qe=Ve.texture;if(Fe.gradientVersion!==Ve.version){let pt=256;if(Fe.stepInterpolant){const Fe=Oe.getSource().maxzoom,Ve=jr.canonical.z===Fe?Math.ceil(1<<Ae.transform.maxZoom-jr.canonical.z):1;pt=F.aw(F.d1(Qr.maxLineLength/F.ag*1024*Ve),256,wi.maxTextureSize)}Ve.gradient=F.d2({expression:Fe.gradientExpression(),evaluationKey:"lineProgress",resolution:pt,image:Ve.gradient||void 0,clips:Qr.lineClipsArray}),Ve.texture?Ve.texture.update(Ve.gradient):Ve.texture=new F.T(wi,Ve.gradient,dr.RGBA8),Ve.version=Fe.gradientVersion,qe=Ve.texture}wi.activeTexture.set(dr.TEXTURE1),qe.bind(Fe.stepInterpolant?dr.NEAREST:dr.LINEAR,dr.CLAMP_TO_EDGE)}Uo&&(wi.activeTexture.set(dr.TEXTURE0),Ve.lineAtlasTexture&&Ve.lineAtlasTexture.bind(dr.LINEAR,dr.REPEAT),Xn.updatePaintBuffers()),Ia&&(wi.activeTexture.set(dr.TEXTURE0),Ve.imageAtlasTexture&&Ve.imageAtlasTexture.bind(dr.LINEAR,dr.CLAMP_TO_EDGE),Xn.updatePaintBuffers()),ri&&!bi&&Ae.terrain.setupElevationDraw(Ve,ia),Ae.uploadCommonUniforms(wi,ia,jr.toUnwrapped());const B=F=>{null!=ec&&(ec.value=Sl*zt),ia.draw(Ae,dr.TRIANGLES,pt,F,ho,Vi.disabled,jc,Fe.id,Qr.layoutVertexBuffer,Qr.indexBuffer,Qr.segments,Fe.paint,Ae.transform.zoom,Xn,[Qr.layoutVertexBuffer2,Qr.patternVertexBuffer,Qr.zOffsetVertexBuffer]),null!=ec&&(ec.value=Sl)};if(Il&&!ri){const F=Ae.stencilModeForClipping(jr).ref;0===F&&yo&&wi.clear({stencil:0});const Oe={func:dr.EQUAL,mask:255};jc.u_alpha_discard_threshold=.8,B(new Ui(Oe,F,255,dr.KEEP,dr.KEEP,dr.INVERT)),jc.u_alpha_discard_threshold=0,B(new Ui(Oe,F,255,dr.KEEP,dr.KEEP,dr.KEEP))}else Il&&ri&&(jc.u_alpha_discard_threshold=.001),B(ri?vt:Ae.stencilModeForClipping(jr))}};if(Fe.hasNonElevatedBuckets){const Oe=!yo&&Ae.terrain;0!==zt&&Oe?F.w(`Occlusion opacity for layer ${Fe.id} is supported on terrain only if the layer has line-z-offset enabled.`):Oe?F.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${Fe.id}.`):M(Ve,Ql,Ae.depthModeForSublayer(0,Bi.ReadOnly),Ui.disabled,!1)}if(Fe.hasElevatedBuckets){Ql.push("ELEVATED"),Qr&&Ql.push(Xn?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),bi&&Ql.push("ELEVATION_REFERENCE_SEA");const F=Il?Ae.stencilModeFor3D():Ui.disabled,Oe=new Bi(Ae.depthOcclusion?dr.GREATER:dr.LEQUAL,Bi.ReadOnly,Ae.depthRangeFor3D);Ae.forceTerrainMode=!0,M(Ve,Ql,Oe,F,!0),Ae.forceTerrainMode=!1}Il&&(Ae.resetStencilClippingMasks(),yo&&wi.clear({stencil:0})),0===zt||Ae.depthOcclusion||yo||Ae.layersWithOcclusionOpacity.push(Ae.currentLayer)},fill:function(Ae,Oe,Fe,Ve){const qe=Fe.paint.get("fill-color"),pt=Fe.paint.get("fill-opacity"),vt=Fe.is3D(),zt=new Bi(Ae.context.gl.LEQUAL,Bi.ReadWrite,Ae.depthRangeFor3D);if(0===pt.constantOr(1))return;const ri=Fe.paint.get("fill-emissive-strength"),xi=Ae.colorModeForDrapableLayerRenderPass(ri),bi=Fe.paint.get("fill-pattern"),wi=Ae.opaquePassEnabledForLayer()&&!bi.constantOr(1)&&1===qe.constantOr(F.aj.transparent).a&&1===pt.constantOr(0)?"opaque":"translucent";if(Ae.renderPass===wi){const F=vt?zt:Ae.depthModeForSublayer(1,"opaque"===Ae.renderPass?Bi.ReadWrite:Bi.ReadOnly);kr(Ae,Oe,Fe,Ve,F,xi,!1)}if(!vt&&"translucent"===Ae.renderPass&&Fe.paint.get("fill-antialias")){const F=vt?zt:Ae.depthModeForSublayer(Fe.getPaintProperty("fill-outline-color")?2:0,Bi.ReadOnly);kr(Ae,Oe,Fe,Ve,F,xi,!0)}},"fill-extrusion":function(Ae,Oe,Fe,Ve){const qe=Fe.paint.get("fill-extrusion-opacity"),pt=Ae.context,vt=pt.gl,zt=Ae.terrain,ri=zt&&zt.renderingToTexture;if(0===qe)return;const xi=Ae.conflationActive&&Ae.style.isLayerClipped(Fe,Oe.getSource()),bi=Ae.style.order.indexOf(Fe.fqid);if(xi&&function(F,Ae,Oe,Fe,Ve){for(const qe of Fe){const Fe=Ae.getTile(qe).getBucket(Oe);Fe&&(Fe.updateReplacement(qe,F.replacementSource,Ve),Fe.uploadCentroid(F.context))}}(Ae,Oe,Fe,Ve,bi),zt||xi)for(const F of Ve){const Ve=Oe.getTile(F).getBucket(Fe);Ve&&Ur(Ae.context,Oe,F,Ve,Fe,zt,xi)}if("shadow"===Ae.renderPass&&Ae.shadowRenderer){const pt=Ae.shadowRenderer;if(zt&&qe<.65&&Fe._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof F.a9)return;const vt=pt.getShadowPassDepthMode(),ri=pt.getShadowPassColorMode();Br(Ae,Oe,Fe,Ve,vt,Ui.disabled,ri,xi)}else if("translucent"===Ae.renderPass){const bi=!Fe.paint.get("fill-extrusion-pattern").constantOr(1),wi=Fe.paint.get("fill-extrusion-color").constantOr(F.aj.white);if(!ri&&0!==wi.a){const F=new Bi(Ae.context.gl.LEQUAL,Bi.ReadWrite,Ae.depthRangeFor3D);1===qe&&bi?Br(Ae,Oe,Fe,Ve,F,Ui.disabled,ki.unblended,xi):(Br(Ae,Oe,Fe,Ve,F,Ui.disabled,ki.disabled,xi),Br(Ae,Oe,Fe,Ve,F,Ae.stencilModeFor3D(),Ae.colorModeForRenderPass(),xi),Ae.resetStencilClippingMasks())}if(Ae.style.enable3dLights()&&bi&&(!zt&&"globe"!==Ae.transform.projection.name||ri)){const qe=Fe.paint.get("fill-extrusion-opacity"),bi=Fe.paint.get("fill-extrusion-ambient-occlusion-intensity"),wi=Fe.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),dr=Fe.paint.get("fill-extrusion-flood-light-intensity"),jr="none"===Fe.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),Qr=Fe.paint.get("fill-extrusion-flood-light-color").toRenderColor(jr?null:Fe.lut).toArray01().slice(0,3),Xn=bi>0&&wi>0,ho=dr>0,v=(F,Ae,Oe)=>(1-Oe)*F+Oe*Ae,y=pt=>{const zt=Ae.depthModeForSublayer(1,Bi.ReadOnly,vt.LEQUAL,!0),ri=Fe.paint.get(pt?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),jr=v(.1,3,ri),Xn=Ae._showOverdrawInspector;if(!Xn){const ri=new Ui({func:vt.ALWAYS,mask:255},255,255,vt.KEEP,vt.KEEP,vt.REPLACE),Xn=new ki([vt.ONE,vt.ONE,vt.ONE,vt.ONE],F.aj.transparent,[!1,!1,!1,!0],vt.MIN);Nr(Ae,Oe,Fe,Ve,zt,ri,Xn,Vi.disabled,pt,"sdf",qe,bi,wi,dr,Qr,jr,xi,!1)}{const ri=Xn?Ui.disabled:new Ui({func:vt.EQUAL,mask:255},255,255,vt.KEEP,vt.DECR,vt.DECR),ho=Xn?Ae.colorModeForRenderPass():new ki([vt.ONE_MINUS_DST_ALPHA,vt.DST_ALPHA,vt.ONE,vt.ONE],F.aj.transparent,[!0,!0,!0,!0]);Nr(Ae,Oe,Fe,Ve,zt,ri,ho,Vi.disabled,pt,"color",qe,bi,wi,dr,Qr,jr,xi,!1)}};if(ri){const c=(pt,zt,ri)=>{const jr=Ae.depthModeForSublayer(1,Bi.ReadOnly,vt.LEQUAL,!1),Xn=Fe.paint.get(pt?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ho=v(.1,3,Xn);{const ri=new ki([vt.ONE,vt.ONE,vt.ONE,vt.ONE],F.aj.transparent,[!1,!1,!1,!0]);Nr(Ae,Oe,Fe,Ve,jr,Ui.disabled,ri,Vi.disabled,pt,"clear",qe,bi,wi,dr,Qr,ho,xi,zt)}{const ri=new Ui({func:vt.ALWAYS,mask:255},255,255,vt.KEEP,vt.KEEP,vt.REPLACE),Xn=new ki([vt.ONE,vt.ONE,vt.ONE,vt.ONE],F.aj.transparent,[!1,!1,!1,!0],vt.MIN);Nr(Ae,Oe,Fe,Ve,jr,ri,Xn,Vi.disabled,pt,"sdf",qe,bi,wi,dr,Qr,ho,xi,zt)}{const ri=pt?vt.ZERO:vt.ONE_MINUS_DST_ALPHA,Xn=new Ui({func:vt.EQUAL,mask:255},255,255,vt.KEEP,vt.DECR,vt.DECR),yo=new ki([ri,vt.DST_ALPHA,vt.ONE_MINUS_DST_ALPHA,vt.ZERO],F.aj.transparent,[!0,!0,!0,!0]);Nr(Ae,Oe,Fe,Ve,jr,Xn,yo,Vi.disabled,pt,"color",qe,bi,wi,dr,Qr,ho,xi,zt)}{const Xn=new ki([vt.ONE,vt.ONE,vt.ONE,pt?vt.ZERO:vt.ONE],F.aj.transparent,[!1,!1,!1,!0],pt?vt.FUNC_ADD:vt.MAX);Nr(Ae,Oe,Fe,Ve,jr,Ui.disabled,Xn,Vi.disabled,pt,"clear",qe,bi,wi,dr,Qr,ho,xi,zt,ri)}};if(Xn||ho){let Oe;if(Ae.prepareDrawTile(),zt){const Ae=zt.drapeBufferSize[0],Fe=zt.drapeBufferSize[1];Oe=zt.framebufferCopyTexture,Oe&&(!Oe||Oe.size[0]===Ae&&Oe.size[1]===Fe)||(Oe&&Oe.destroy(),Oe=zt.framebufferCopyTexture=new F.T(pt,new F.r({width:Ae,height:Fe}),vt.RGBA8)),Oe.bind(vt.LINEAR,vt.CLAMP_TO_EDGE),vt.copyTexSubImage2D(vt.TEXTURE_2D,0,0,0,0,0,Ae,Fe)}Xn&&c(!0,!1,Oe),ho&&c(!1,!0,Oe)}}else Xn&&y(!0),ho&&y(!1),(Xn||ho)&&Ae.resetStencilClippingMasks()}}},hillshade:function(F,Ae,Oe,Fe){if("offscreen"!==F.renderPass&&"translucent"!==F.renderPass)return;if(F.style.disableElevatedTerrain)return;const Ve=F.context,qe=F.terrain&&F.terrain.renderingToTexture,[pt,vt]="translucent"!==F.renderPass||qe?[{},Fe]:F.stencilConfigForOverlap(Fe);for(const Fe of vt){const Ve=Ae.getTile(Fe);if(Ve.needsHillshadePrepare&&"offscreen"===F.renderPass)Wo(F,Ve,Oe);else if("translucent"===F.renderPass){const Ae=F.depthModeForSublayer(0,Bi.ReadOnly),vt=Oe.paint.get("hillshade-emissive-strength"),zt=F.colorModeForDrapableLayerRenderPass(vt),ri=qe&&F.terrain?F.terrain.stencilModeForRTTOverlap(Fe):pt[Fe.overscaledZ];Ho(F,Fe,Ve,Oe,Ae,ri,zt)}}Ve.viewport.set([0,0,F.width,F.height]),F.resetStencilClippingMasks()},raster:function(Ae,Oe,Fe,Ve,qe,pt){if("translucent"!==Ae.renderPass)return;if(0===Fe.paint.get("raster-opacity"))return;const vt="globe"===Ae.transform.projection.name,zt=0!==Fe.paint.get("raster-elevation"),ri=zt&&vt;if(Ae.renderElevatedRasterBackface&&!ri)return;const xi=Ae.context,bi=xi.gl,wi=Oe.getSource(),dr=function(Ae,Oe,Fe,Ve){const qe=Oe.paint.get("raster-color"),pt="raster-array"===Ae.type,vt=[],zt=Oe.paint.get("raster-resampling"),ri=Oe.paint.get("raster-color-mix");let xi=Oe.paint.get("raster-color-range");const bi=[ri[0],ri[1],ri[2],0],wi=ri[3];let dr="nearest"===zt?Ve.NEAREST:Ve.LINEAR;if(pt&&(vt.push("RASTER_ARRAY"),qe||vt.push("RASTER_COLOR"),"linear"===zt&&vt.push("RASTER_ARRAY_LINEAR"),dr=Ve.NEAREST,!xi&&Ae.rasterLayers)){const F=Ae.rasterLayers.find((({id:F})=>F===Oe.sourceLayer));F&&F.fields&&F.fields.range&&(xi=F.fields.range)}if(xi=xi||[0,1],qe){vt.push("RASTER_COLOR"),Fe.activeTexture.set(Ve.TEXTURE2),Oe.updateColorRamp(xi);let Ae=Oe.colorRampTexture;Ae||(Ae=Oe.colorRampTexture=new F.T(Fe,Oe.colorRamp,Ve.RGBA8)),Ae.bind(Ve.LINEAR,Ve.CLAMP_TO_EDGE)}return{mix:bi,range:xi,offset:wi,defines:vt,resampling:dr}}(wi,Fe,xi,bi);if(wi instanceof F.aJ&&!Ve.length&&!vt)return;const jr=Fe.paint.get("raster-emissive-strength"),Qr=Ae.colorModeForDrapableLayerRenderPass(jr),Xn=Ae.terrain&&Ae.terrain.renderingToTexture,ho=!Ae.options.moving,yo="nearest"===Fe.paint.get("raster-resampling")?bi.NEAREST:bi.LINEAR;if(wi instanceof F.aJ&&!Ve.length&&(wi.onNorthPole||wi.onSouthPole)){const F=zt?Ae.stencilModeFor3D():Ui.disabled;return void Zr(!!wi.onNorthPole,null,Ae,Oe,Fe,jr,dr,Vi.disabled,F)}if(!Ve.length)return;const[zo,ko]=wi instanceof F.aJ||Xn?[{},Ve]:Ae.stencilConfigForOverlap(Ve),Uo=ko[ko.length-1].overscaledZ;ri&&dr.defines.push("PROJECTION_GLOBE_VIEW"),zt&&dr.defines.push("RENDER_CUTOFF");const w=(Ve,qe,ko)=>{for(const ia of Ve){const Ve=ia.toUnwrapped(),_a=Oe.getTile(ia);if(Xn&&(!_a||!_a.hasData()))continue;xi.activeTexture.set(bi.TEXTURE0);const Ma=$r(_a,wi,Fe,dr);if(!Ma||!Ma.texture)continue;const{texture:Ea,mix:Ia,offset:rl,tileSize:Sl,buffer:Il}=Ma;let Kl,Jl;Xn?(Kl=Bi.disabled,Jl=ia.projMatrix):zt?(Kl=new Bi(bi.LEQUAL,Bi.ReadWrite,Ae.depthRangeFor3D),Jl=vt?Float32Array.from(Ae.transform.expandedFarZProjMatrix):Ae.transform.calculateProjMatrix(Ve,ho)):(Kl=Ae.depthModeForSublayer(ia.overscaledZ-Uo,1===Fe.paint.get("raster-opacity")?Bi.ReadWrite:Bi.ReadOnly,bi.LESS),Jl=Ae.transform.calculateProjMatrix(Ve,ho));const Ql=Ae.terrain&&Xn?Ae.terrain.stencilModeForRTTOverlap(ia):zo[ia.overscaledZ],ec=pt?0:Fe.paint.get("raster-fade-duration");_a.registerFadeDuration(ec);const tc=Oe.findLoadedParent(ia,0),cc=Ns(_a,tc,Oe,Ae.transform,ec);let uc,jc;Ae.terrain&&Ae.terrain.prepareDrawTile(),xi.activeTexture.set(bi.TEXTURE0),Ea.bind(yo,bi.CLAMP_TO_EDGE),xi.activeTexture.set(bi.TEXTURE1),tc?(tc.texture&&tc.texture.bind(yo,bi.CLAMP_TO_EDGE),uc=Math.pow(2,tc.tileID.overscaledZ-_a.tileID.overscaledZ),jc=[_a.tileID.canonical.x*uc%1,_a.tileID.canonical.y*uc%1]):Ea.bind(yo,bi.CLAMP_TO_EDGE),Ea.useMipmap&&xi.extTextureFilterAnisotropic&&Ae.transform.pitch>20&&bi.texParameterf(bi.TEXTURE_2D,xi.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,xi.extTextureFilterAnisotropicMax);const Gc=Ae.transform;let qc;const $c=zt?Wr(Gc):[0,0,0,0];let Hc,Wc,Kc,Jc,Qc,eh=0;if(ri&&wi instanceof F.aJ&&wi.coordinates.length>3)Hc=Float32Array.from(F.bb(F.cH(new F.bT(0,0,0)))),Wc=Float32Array.from(Gc.globeMatrix),Kc=Float32Array.from(F.cD(Gc)),Jc=[F.at(Gc.center.lng),F.aA(Gc.center.lat)],qc=wi.elevatedGlobePerspectiveTransform,Qc=wi.elevatedGlobeGridMatrix||new Float32Array(9);else if(ri){const Ae=F.cE(ia.canonical);eh=F.cF(Ae.getCenter().lat),Hc=Float32Array.from(F.bb(F.cH(ia.canonical))),Wc=Float32Array.from(Gc.globeMatrix),Kc=Float32Array.from(F.cD(Gc)),Jc=[F.at(Gc.center.lng),F.aA(Gc.center.lat)],qc=[0,0],Qc=Float32Array.from(F.cG(ia.canonical,Ae,eh,Gc.worldSize/Gc._pixelsPerMercatorPixel))}else qc=wi instanceof F.aJ?wi.perspectiveTransform:[0,0],Hc=new Float32Array(16),Wc=new Float32Array(9),Kc=new Float32Array(16),Jc=[0,0],Qc=new Float32Array(9);const th=hr(Jl,Hc,Wc,Kc,Qc,jc||[0,0],F.ae(Ae.transform.zoom),Jc,$c,uc||1,cc,Fe,qc,zt?Fe.paint.get("raster-elevation"):0,2,Ia,rl,dr.range,Sl,Il,jr),ih=Ae.isTileAffectedByFog(ia),rh=Ae.getOrCreateProgram("raster",{defines:dr.defines,overrideFog:ih});if(Ae.uploadCommonUniforms(xi,rh,Ve),wi instanceof F.aJ){const Oe=wi.elevatedGlobeVertexBuffer,Ve=wi.elevatedGlobeIndexBuffer;if(Xn||!vt)wi.boundsBuffer&&wi.boundsSegments&&rh.draw(Ae,bi.TRIANGLES,Kl,Ui.disabled,Qr,Vi.disabled,th,Fe.id,wi.boundsBuffer,Ae.quadTriangleIndexBuffer,wi.boundsSegments);else if(Oe&&Ve){const pt=Gc.zoom<=F.c6?wi.elevatedGlobeSegments:wi.getSegmentsForLongitude(Gc.center.lng);pt&&rh.draw(Ae,bi.TRIANGLES,Kl,Ui.disabled,Qr,qe,th,Fe.id,Oe,Ve,pt)}}else if(ri){Kl=new Bi(bi.LEQUAL,Bi.ReadOnly,Ae.depthRangeFor3D);const F=Ae.globeSharedBuffers;if(F){const[Oe,Ve,pt]=F.getGridBuffers(eh,!1);rh.draw(Ae,bi.TRIANGLES,Kl,ko||Ql,Ae.colorModeForRenderPass(),qe,th,Fe.id,Oe,Ve,pt)}}else{const{tileBoundsBuffer:F,tileBoundsIndexBuffer:Oe,tileBoundsSegments:Ve}=Ae.getTileBoundsBuffers(_a);rh.draw(Ae,bi.TRIANGLES,Kl,Ql,Qr,Vi.disabled,th,Fe.id,F,Oe,Ve)}}if(!(wi instanceof F.aJ)&&ri)for(const F of Ve){const Ve=F.canonical.y===(1<<F.canonical.z)-1;0===F.canonical.y&&Zr(!0,F,Ae,Oe,Fe,jr,dr,qe,ko||Ui.disabled),Ve&&Zr(!1,F,Ae,Oe,Fe,jr,dr,qe===Vi.frontCW?Vi.backCW:Vi.frontCW,ko||Ui.disabled)}};ri?w(ko,Ae.renderElevatedRasterBackface?Vi.backCW:Vi.frontCW,Ae.stencilModeFor3D()):w(ko,Vi.disabled,void 0),Ae.resetStencilClippingMasks()},"raster-particle":function(Ae,Oe,Fe,Ve,qe,pt){"offscreen"===Ae.renderPass&&function(Ae,Oe,Fe,Ve){if(!Ve.length)return;const qe=Ae.context,pt=qe.gl,vt=Oe.getSource();if(!(vt instanceof ot))return;const zt=Math.ceil(Math.sqrt(Fe.paint.get("raster-particle-count")));let ri=Fe.particlePositionRGBAImage;if(!ri||ri.width!==zt){const Ae=function(F){const Ae=F*F,Oe=new Uint8Array(4*Ae),o=function(F){return F|=0,F=Math.imul(2747636419^F,2654435769),F=Math.imul(F^F>>>16,2654435769),((F=Math.imul(F^F>>>16,2654435769))>>>0)/4294967296},Fe=1/1.1;for(let F=0;F<Ae;F++){const Ae=Fe*(o(2*F+0)+Gd),Ve=Fe*(o(2*F+1)+Gd),qe=255*Ae%1,pt=255*Ve%1,vt=qe,zt=Ve-pt/255,ri=pt;Oe[4*F+0]=255*(Ae-qe/255),Oe[4*F+1]=255*vt,Oe[4*F+2]=255*zt,Oe[4*F+3]=255*ri}return Oe}(zt);ri=Fe.particlePositionRGBAImage=new F.r({width:zt,height:zt},Ae)}let xi=Fe.particleFramebuffer;xi?xi.width!==zt&&(xi.destroy(),xi=Fe.particleFramebuffer=qe.createFramebuffer(zt,zt,!0,null)):xi=Fe.particleFramebuffer=qe.createFramebuffer(zt,zt,!0,null);const bi=[];for(const F of Ve){const Ae=Oe.getTile(F);if(!(Ae instanceof wt))continue;const Ve=Yr(Ae,vt,Fe);if(!Ve)continue;const pt=[Ae.tileSize,Ae.tileSize];let xi=Fe.tileFramebuffer;xi||(xi=Fe.tileFramebuffer=qe.createFramebuffer(pt[0],pt[1],!0,null));let wi=Ae.rasterParticleState;wi||(wi=Ae.rasterParticleState=new Kr(qe,F,pt,ri));const dr=wi.update(Fe.lastInvalidatedAt);wi.particleTextureDimension!==zt&&wi.updateParticleTexture(F,ri);const jr=wi.targetColorTexture;wi.targetColorTexture=wi.backgroundColorTexture,wi.backgroundColorTexture=jr;const Qr=wi.particleTexture0;wi.particleTexture0=wi.particleTexture1,wi.particleTexture1=Qr,bi.push([F,Ve,wi,dr])}if(0===bi.length)return;const wi=F.q.now(),dr=Fe.previousDrawTimestamp?.001*(wi-Fe.previousDrawTimestamp):.0167;if(Fe.previousDrawTimestamp=wi,Fe.hasColorMap()){qe.activeTexture.set(pt.TEXTURE0+2);let Ae=Fe.colorRampTexture;Ae||(Ae=Fe.colorRampTexture=new F.T(qe,Fe.colorRamp,pt.RGBA8)),Ae.bind(pt.LINEAR,pt.CLAMP_TO_EDGE)}qe.bindFramebuffer.set(Fe.tileFramebuffer.framebuffer),function(Ae,Oe,Fe){const Ve=Ae.context,qe=Ve.gl,pt=Oe.tileFramebuffer;Ve.activeTexture.set(qe.TEXTURE0);const vt={u_texture:0,u_opacity:1.05*(ri=Oe.paint.get("raster-particle-fade-opacity-factor"))/(ri+.05)},zt=Ae.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var ri;for(const ri of Fe){const[,,Fe,xi]=ri;pt.colorAttachment.set(Fe.targetColorTexture.texture),Ve.viewport.set([0,0,pt.width,pt.height]),Ve.clear({color:F.aj.transparent}),xi&&(Fe.backgroundColorTexture.bind(qe.NEAREST,qe.CLAMP_TO_EDGE),zt.draw(Ae,qe.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,Vi.disabled,vt,Oe.id,Ae.viewportBuffer,Ae.quadTriangleIndexBuffer,Ae.viewportSegments))}}(Ae,Fe,bi),function(Ae,Oe,Fe,Ve){const qe=Ae.context,pt=qe.gl,vt=Fe.tileFramebuffer,zt="globe"===Ae.transform.projection.name,ri=Fe.paint.get("raster-particle-max-speed");for(const xi of Ve){const[Ve,bi,wi]=xi;qe.activeTexture.set(pt.TEXTURE0+0),bi.texture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE),vt.colorAttachment.set(wi.targetColorTexture.texture);const dr=Ae.getOrCreateProgram("rasterParticleDraw",{defines:bi.defines,overrideFog:!1});qe.activeTexture.set(pt.TEXTURE0+1);const jr=bi.scalarData?[]:[0,1,2,3].map((Ae=>F.d4[Ae](Ve)));jr.push(Ve);const Qr=Ve.canonical.x,Xn=Ve.canonical.y;for(const F of jr){const qe=Oe.getTile(zt?F.wrapped():F);if(!qe)continue;const vt=qe.rasterParticleState;if(!vt)continue;const xi=F.canonical.x+(1<<F.canonical.z)*(F.wrap-Ve.wrap),wi=F.canonical.y;vt.particleTexture0.bind(pt.NEAREST,pt.CLAMP_TO_EDGE);const jr=pr(1,vt.particleTexture0.size[0],[xi-Qr,wi-Xn],0,bi.texture.size,2,ri,bi.textureOffset,bi.scale,bi.offset);dr.draw(Ae,pt.POINTS,Bi.disabled,Ui.disabled,ki.alphaBlended,Vi.disabled,jr,Fe.id,vt.particleIndexBuffer,void 0,vt.particleSegment)}}}(Ae,Oe,Fe,bi),qe.bindFramebuffer.set(Fe.particleFramebuffer.framebuffer),function(Ae,Oe,Fe,Ve){const qe=Ae.context,pt=qe.gl,vt=Oe.paint.get("raster-particle-max-speed"),zt=Ve*Oe.paint.get("raster-particle-speed-factor")*.15,ri=function(F){return Math.pow(F,6)}(.01+1*Oe.paint.get("raster-particle-reset-rate-factor")),xi=Oe.particleFramebuffer;qe.viewport.set([0,0,xi.width,xi.height]);for(const Ve of Fe){const[,Fe,bi]=Ve;qe.activeTexture.set(pt.TEXTURE0+0),Fe.texture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE),qe.activeTexture.set(pt.TEXTURE0+1);const wi=bi.particleTexture0;wi.bind(pt.NEAREST,pt.CLAMP_TO_EDGE);const dr=fr(1,wi.size[0],0,Fe.texture.size,vt,zt,ri,Fe.textureOffset,Fe.scale,Fe.offset);xi.colorAttachment.set(bi.particleTexture1.texture),qe.clear({color:F.aj.transparent}),Ae.getOrCreateProgram("rasterParticleUpdate",{defines:Fe.defines}).draw(Ae,pt.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,Vi.disabled,dr,Oe.id,Ae.viewportBuffer,Ae.quadTriangleIndexBuffer,Ae.viewportSegments)}}(Ae,Fe,bi,dr)}(Ae,Oe,Fe,Ve),"translucent"===Ae.renderPass&&(function(Ae,Oe,Fe,Ve){const qe=Ae.context,pt=qe.gl,vt=Oe.getSource().tileSize,zt=5*(1-F.ac(F.bY,F.bY+1,Ae.transform.zoom))*vt+Fe.paint.get("raster-particle-elevation"),ri=!Ae.options.moving,xi="globe"===Ae.transform.projection.name;if(!Ve.length)return;const[bi,wi]=Ae.stencilConfigForOverlap(Ve),dr=[];xi&&dr.push("PROJECTION_GLOBE_VIEW");const jr=Ae.stencilModeFor3D();for(const Ve of wi){const vt=Ve.toUnwrapped(),wi=Oe.getTile(Ve);if(!wi.rasterParticleState)continue;const Qr=wi.rasterParticleState,Xn=100;wi.registerFadeDuration(Xn);const ho=Oe.findLoadedParent(Ve,0),yo=Ns(wi,ho,Oe,Ae.transform,Xn);let zo,ko;Ae.terrain&&Ae.terrain.prepareDrawTile(),qe.activeTexture.set(pt.TEXTURE0),Qr.targetColorTexture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE),qe.activeTexture.set(pt.TEXTURE1),ho&&ho.rasterParticleState?(ho.rasterParticleState.targetColorTexture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE),zo=Math.pow(2,ho.tileID.overscaledZ-wi.tileID.overscaledZ),ko=[wi.tileID.canonical.x*zo%1,wi.tileID.canonical.y*zo%1]):Qr.targetColorTexture.bind(pt.LINEAR,pt.CLAMP_TO_EDGE);const Uo=xi?Float32Array.from(Ae.transform.expandedFarZProjMatrix):Ae.transform.calculateProjMatrix(vt,ri),ia=Ae.transform,_a=Jr(ia),Ma=F.cE(Ve.canonical),Ea=F.cF(Ma.getCenter().lat);let Ia,rl,Sl,Il,Kl;xi?(Ia=Float32Array.from(F.bb(F.cH(Ve.canonical))),rl=Float32Array.from(ia.globeMatrix),Sl=Float32Array.from(F.cD(ia)),Il=[F.at(ia.center.lng),F.aA(ia.center.lat)],Kl=Float32Array.from(F.cG(Ve.canonical,Ma,Ea,ia.worldSize/ia._pixelsPerMercatorPixel))):(Ia=new Float32Array(16),rl=new Float32Array(9),Sl=new Float32Array(16),Il=[0,0],Kl=new Float32Array(9));const Jl=_r(Uo,Ia,rl,Sl,Kl,ko||[0,0],F.ae(Ae.transform.zoom),Il,_a,zo||1,yo,zt),Ql=Ae.isTileAffectedByFog(Ve),ec=Ae.getOrCreateProgram("rasterParticle",{defines:dr,overrideFog:Ql});if(Ae.uploadCommonUniforms(qe,ec,vt),xi){const F=new Bi(pt.LEQUAL,Bi.ReadOnly,Ae.depthRangeFor3D),Oe=0,Ve=Ae.globeSharedBuffers;if(Ve){const[qe,vt,zt]=Ve.getGridBuffers(Ea,0!==Oe);ec.draw(Ae,pt.TRIANGLES,F,jr,ki.alphaBlended,Ae.renderElevatedRasterBackface?Vi.frontCCW:Vi.backCCW,Jl,Fe.id,qe,vt,zt)}}else{const F=Ae.depthModeForSublayer(0,Bi.ReadOnly),Oe=bi[Ve.overscaledZ],{tileBoundsBuffer:qe,tileBoundsIndexBuffer:vt,tileBoundsSegments:zt}=Ae.getTileBoundsBuffers(wi);ec.draw(Ae,pt.TRIANGLES,F,Oe,ki.alphaBlended,Vi.disabled,Jl,Fe.id,qe,vt,zt)}}Ae.resetStencilClippingMasks()}(Ae,Oe,Fe,Ve),Ae.style.map.triggerRepaint())},background:function(Ae,Oe,Fe,Ve){const qe=Fe.paint.get("background-color"),pt="none"===Fe.paint.get("background-color-use-theme").constantOr("default"),vt=Fe.paint.get("background-opacity"),zt=Fe.paint.get("background-emissive-strength"),ri="viewport"===Fe.paint.get("background-pitch-alignment");if(0===vt)return;const xi=Ae.context,bi=xi.gl,wi=Ae.transform,dr=wi.tileSize,jr=Fe.paint.get("background-pattern");let Qr;if(void 0!==jr){if(null===jr)return;if(Qr=Ae.imageManager.getPattern(jr.toString(),Fe.scope,Ae.style.getLut(Fe.scope)),!Qr)return}const Xn=!jr&&1===qe.a&&1===vt&&Ae.opaquePassEnabledForLayer()?"opaque":"translucent";if(Ae.renderPass!==Xn)return;const ho=Ui.disabled,yo=Ae.depthModeForSublayer(0,"opaque"===Xn?Bi.ReadWrite:Bi.ReadOnly),zo=Ae.colorModeForDrapableLayerRenderPass(zt),ko=jr?"backgroundPattern":"background";let Uo,ia=Ve;if(ia||(Uo=Ae.getBackgroundTiles(),ia=Object.values(Uo).map((F=>F.tileID))),jr&&(xi.activeTexture.set(bi.TEXTURE0),Ae.imageManager.bind(Ae.context,Fe.scope)),ri){const Oe=Ae.getOrCreateProgram(ko,{overrideFog:!1,overrideRtt:!0}),Ve=new Float32Array(F.ab.mat4.identity([])),xi=new F.aG(0,0,0,0,0),wi=jr?yr(Ve,zt,vt,Ae,0,Fe.scope,Qr,ri,{tileID:xi,tileSize:dr}):vr(Ve,zt,vt,qe.toRenderColor(pt?null:Fe.lut));Oe.draw(Ae,bi.TRIANGLES,yo,ho,zo,Vi.disabled,wi,Fe.id,Ae.viewportBuffer,Ae.quadTriangleIndexBuffer,Ae.viewportSegments)}else for(const F of ia){const Xn=Ae.isTileAffectedByFog(F),ia=Ae.getOrCreateProgram(ko,{overrideFog:Xn}),_a=F.toUnwrapped(),Ma=Ve?F.projMatrix:Ae.transform.calculateProjMatrix(_a);Ae.prepareDrawTile();const Ea=Oe?Oe.getTile(F):Uo?Uo[F.key]:new bt(F,dr,wi.zoom,Ae),Ia=jr?yr(Ma,zt,vt,Ae,0,Fe.scope,Qr,ri,{tileID:F,tileSize:dr}):vr(Ma,zt,vt,qe.toRenderColor(pt?null:Fe.lut));Ae.uploadCommonUniforms(xi,ia,_a);const{tileBoundsBuffer:rl,tileBoundsIndexBuffer:Sl,tileBoundsSegments:Il}=Ae.getTileBoundsBuffers(Ea);ia.draw(Ae,bi.TRIANGLES,yo,ho,zo,Vi.disabled,Ia,Fe.id,rl,Sl,Il)}},sky:function(Ae,Oe,Fe){const Ve=Ae._atmosphere?F.ae(Ae.transform.zoom):1,qe=Fe.paint.get("sky-opacity")*Ve;if(0===qe)return;const pt=Ae.context,vt=Fe.paint.get("sky-type"),zt=new Bi(pt.gl.LEQUAL,Bi.ReadOnly,[0,1]),ri=Ae.frameCounter/1e3%1;"atmosphere"===vt?"offscreen"===Ae.renderPass?Fe.needsSkyboxCapture(Ae)&&(function(Ae,Oe){const Fe=Ae.context,Ve=Fe.gl;let qe=Oe.skyboxFbo;if(!qe){qe=Oe.skyboxFbo=Fe.createFramebuffer(32,32,!0,null),Oe.skyboxGeometry=new ua(Fe),Oe.skyboxTexture=Fe.gl.createTexture(),Ve.bindTexture(Ve.TEXTURE_CUBE_MAP,Oe.skyboxTexture),Ve.texParameteri(Ve.TEXTURE_CUBE_MAP,Ve.TEXTURE_WRAP_S,Ve.CLAMP_TO_EDGE),Ve.texParameteri(Ve.TEXTURE_CUBE_MAP,Ve.TEXTURE_WRAP_T,Ve.CLAMP_TO_EDGE),Ve.texParameteri(Ve.TEXTURE_CUBE_MAP,Ve.TEXTURE_MIN_FILTER,Ve.LINEAR),Ve.texParameteri(Ve.TEXTURE_CUBE_MAP,Ve.TEXTURE_MAG_FILTER,Ve.LINEAR);for(let F=0;F<6;++F)Ve.texImage2D(Ve.TEXTURE_CUBE_MAP_POSITIVE_X+F,0,Ve.RGBA,32,32,0,Ve.RGBA,Ve.UNSIGNED_BYTE,null)}Fe.bindFramebuffer.set(qe.framebuffer),Fe.viewport.set([0,0,32,32]);const pt=Oe.getCenter(Ae,!0),vt=Ae.getOrCreateProgram("skyboxCapture"),zt=new Float64Array(16);F.ab.mat4.identity(zt),F.ab.mat4.rotateY(zt,zt,.5*-Math.PI),da(Ae,Oe,vt,zt,pt,0),F.ab.mat4.identity(zt),F.ab.mat4.rotateY(zt,zt,.5*Math.PI),da(Ae,Oe,vt,zt,pt,1),F.ab.mat4.identity(zt),F.ab.mat4.rotateX(zt,zt,.5*-Math.PI),da(Ae,Oe,vt,zt,pt,2),F.ab.mat4.identity(zt),F.ab.mat4.rotateX(zt,zt,.5*Math.PI),da(Ae,Oe,vt,zt,pt,3),F.ab.mat4.identity(zt),da(Ae,Oe,vt,zt,pt,4),F.ab.mat4.identity(zt),F.ab.mat4.rotateY(zt,zt,Math.PI),da(Ae,Oe,vt,zt,pt,5),Fe.viewport.set([0,0,Ae.width,Ae.height])}(Ae,Fe),Fe.markSkyboxValid(Ae)):"sky"===Ae.renderPass&&function(F,Ae,Oe,Fe,Ve){const qe=F.context,pt=qe.gl,vt=F.transform,zt=F.getOrCreateProgram("skybox");qe.activeTexture.set(pt.TEXTURE0),pt.bindTexture(pt.TEXTURE_CUBE_MAP,Ae.skyboxTexture);const ri=((F,Ae,Oe,Fe,Ve)=>({u_matrix:F,u_sun_direction:Ae,u_cubemap:0,u_opacity:Fe,u_temporal_offset:Ve}))(vt.skyboxMatrix,Ae.getCenter(F,!1),0,Fe,Ve);F.uploadCommonUniforms(qe,zt),zt.draw(F,pt.TRIANGLES,Oe,Ui.disabled,F.colorModeForRenderPass(),Vi.backCW,ri,"skybox",Ae.skyboxGeometry.vertexBuffer,Ae.skyboxGeometry.indexBuffer,Ae.skyboxGeometry.segment)}(Ae,Fe,zt,qe,ri):"gradient"===vt&&"sky"===Ae.renderPass&&function(Ae,Oe,Fe,Ve,qe){const pt=Ae.context,vt=pt.gl,zt=Ae.transform,ri=Ae.getOrCreateProgram("skyboxGradient");Oe.skyboxGeometry||(Oe.skyboxGeometry=new ua(pt)),pt.activeTexture.set(vt.TEXTURE0);let xi=Oe.colorRampTexture;xi||(xi=Oe.colorRampTexture=new F.T(pt,Oe.colorRamp,vt.RGBA8)),xi.bind(vt.LINEAR,vt.CLAMP_TO_EDGE);const bi=((Ae,Oe,Fe,Ve,qe)=>({u_matrix:Ae,u_color_ramp:0,u_center_direction:Oe,u_radius:F.ai(Fe),u_opacity:Ve,u_temporal_offset:qe}))(zt.skyboxMatrix,Oe.getCenter(Ae,!1),Oe.paint.get("sky-gradient-radius"),Ve,qe);Ae.uploadCommonUniforms(pt,ri),ri.draw(Ae,vt.TRIANGLES,Fe,Ui.disabled,Ae.colorModeForRenderPass(),Vi.backCW,bi,"skyboxGradient",Oe.skyboxGeometry.vertexBuffer,Oe.skyboxGeometry.indexBuffer,Oe.skyboxGeometry.segment)}(Ae,Fe,zt,qe,ri)},debug:function(Ae,Oe,Fe,Ve,qe,pt){for(let vt=0;vt<Fe.length;vt++)if(qe){const qe=1,zt=.8,ri=new F.aj(Ve.r*zt,Ve.g*zt,Ve.b*zt,1);sa(Ae,Oe,Fe[vt],Ve,-qe,-qe,pt),sa(Ae,Oe,Fe[vt],Ve,-qe,qe,pt),sa(Ae,Oe,Fe[vt],Ve,qe,qe,pt),sa(Ae,Oe,Fe[vt],Ve,qe,-qe,pt),sa(Ae,Oe,Fe[vt],ri,0,0,pt)}else sa(Ae,Oe,Fe[vt],Ve,0,0,pt)},custom:function(Ae,Oe,Fe,Ve){const qe=Ae.context,pt=Fe.implementation;if(!Ae.transform.projection.unsupportedLayers||!Ae.transform.projection.unsupportedLayers.includes("custom")||Ae.terrain&&(Ae.terrain.renderingToTexture||"offscreen"===Ae.renderPass)&&Fe.isDraped(Oe)){if("offscreen"===Ae.renderPass){const Oe=pt.prerender;if(Oe){if(Ae.setCustomLayerDefaults(),qe.setColorMode(Ae.colorModeForRenderPass()),"globe"===Ae.transform.projection.name){const Fe=Ae.transform.pointMerc;Oe.call(pt,qe.gl,Ae.transform.customLayerMatrix(),Ae.transform.getProjection(),Ae.transform.globeToMercatorMatrix(),F.ae(Ae.transform.zoom),[Fe.x,Fe.y],Ae.transform.pixelsPerMeterRatio)}else Oe.call(pt,qe.gl,Ae.transform.customLayerMatrix());qe.setDirty(),Ae.setBaseState()}}else if("translucent"===Ae.renderPass){if(Ae.terrain&&Ae.terrain.renderingToTexture){const Oe=pt.renderToTile;if(Oe){const Fe=Ve[0].canonical,vt=new F.aa(Fe.x+Ve[0].wrap*(1<<Fe.z),Fe.y,Fe.z);qe.setDepthMode(Bi.disabled),qe.setStencilMode(Ui.disabled),qe.setColorMode(Ae.colorModeForRenderPass()),Ae.setCustomLayerDefaults(),Oe.call(pt,qe.gl,vt),qe.setDirty(),Ae.setBaseState()}return}Ae.setCustomLayerDefaults(),qe.setColorMode(Ae.colorModeForRenderPass()),qe.setStencilMode(Ui.disabled);const Oe="3d"===pt.renderingMode?new Bi(Ae.context.gl.LEQUAL,Bi.ReadWrite,Ae.depthRangeFor3D):Ae.depthModeForSublayer(0,Bi.ReadOnly);if(qe.setDepthMode(Oe),"globe"===Ae.transform.projection.name){const Oe=Ae.transform.pointMerc;pt.render(qe.gl,Ae.transform.customLayerMatrix(),Ae.transform.getProjection(),Ae.transform.globeToMercatorMatrix(),F.ae(Ae.transform.zoom),[Oe.x,Oe.y],Ae.transform.pixelsPerMeterRatio)}else pt.render(qe.gl,Ae.transform.customLayerMatrix());qe.setDirty(),Ae.setBaseState(),qe.bindFramebuffer.set(null)}}else F.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(Ae,Oe,Fe,Ve){if("opaque"===Ae.renderPass)return;const qe=Fe.paint.get("model-opacity").constantOr(1);if(0===qe)return;const pt=Fe.paint.get("model-cast-shadows");if("shadow"===Ae.renderPass){if(!pt)return;if(Ae.terrain&&qe<.65&&Fe._transitionablePaint._values["model-opacity"].value.expression instanceof F.a9)return}const vt=Ae.shadowRenderer,zt=Fe.paint.get("model-receive-shadows");vt&&(vt.useNormalOffset=!0,zt||(vt.enabled=!1));const c=()=>{vt&&(vt.useNormalOffset=!0,zt||(vt.enabled=!0))},ri=Oe.getSource();if("light-beam"===Ae.renderPass&&"batched-model"!==ri.type)return;if("vector"===ri.type||"geojson"===ri.type)return function(Ae,Oe,Fe,Ve,qe){const pt=Ae.transform;if("mercator"!==pt.projection.name)return void F.w(`Drawing 3D models for ${pt.projection.name} projection is not yet implemented`);const vt=pt.getFreeCameraOptions().position;if(!Ae.modelManager)return;const zt=Ae.modelManager;Fe.modelManager=zt;const ri=Ae.shadowRenderer;if(!Fe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const xi=Fe._unevaluatedLayout._values["model-id"],bi=Object.assign({},Fe.layout.get("model-id").parameters),wi=Ae.style.order.indexOf(Fe.fqid);for(const dr of Ve){const Ve=Oe.getTile(dr).getBucket(Fe);if(!Ve||Ve.projection.name!==pt.projection.name)continue;const jr=Ve.getModelUris();jr&&!Ve.modelsRequested&&(zt.addModelsFromBucket(jr,qe),Ve.modelsRequested=!0);const Qr=Sa(dr,pt);bi.zoom=Qr;const Xn=xi.possiblyEvaluate(bi);if(Ta(Ae,Ve,dr),Up.shadowUniformsInitialized=!1,Up.useSingleShadowCascade=!!ri&&0===ri.getMaxCascadeForTile(dr.toUnwrapped()),"shadow"===Ae.renderPass&&ri){if(1===Ae.currentShadowCascade&&Ve.isInsideFirstShadowMapFrustum)continue;const Oe=pt.calculatePosMatrix(dr.toUnwrapped(),pt.worldSize);if(Up.tileMatrix.set(Oe),Up.shadowTileMatrix=Float32Array.from(ri.calculateShadowPassMatrixFromMatrix(Oe)),Up.aabb.min.fill(0),Up.aabb.max[0]=Up.aabb.max[1]=F.ag,Up.aabb.max[2]=0,Ra(Ve,Up,Ae,Fe.scope))continue}const ho=1<<dr.canonical.z,yo=[((vt.x-dr.wrap)*ho-dr.canonical.x)*F.ag,(vt.y*ho-dr.canonical.y)*F.ag,vt.z*ho*F.ag];Ae.conflationActive&&Object.keys(Ve.instancesPerModel).length>0&&Ae.style.isLayerClipped(Fe,Oe.getSource())&&Ve.updateReplacement(dr,Ae.replacementSource,wi,qe)&&(Ve.uploaded=!1,Ve.upload(Ae.context));for(let F in Ve.instancesPerModel){const Oe=Ve.instancesPerModel[F];Oe.features.length>0&&(F=Xn.evaluate(Oe.features[0].feature,{}));const pt=zt.getModel(F,qe);if(pt&&pt.uploaded)for(const F of pt.nodes)Ca(Ae,Fe,F,Oe,yo,dr,Up)}}}(Ae,Oe,Fe,Ve,"vector"===ri.type?Fe.scope:""),void c();if(!ri.loaded())return;if("batched-model"===ri.type)return function(Ae,Oe,Fe,Ve){Fe.resetLayerRenderingStats(Ae);const qe=Ae.context,pt=Ae.transform,vt=Ae.style.fog,zt=Ae.shadowRenderer;if("mercator"!==pt.projection.name)return void F.w(`Drawing 3D landmark models for ${pt.projection.name} projection is not yet implemented`);const ri=Ae.transform.getFreeCameraOptions().position,xi=F.ab.vec3.scale([],[ri.x,ri.y,ri.z],Ae.transform.worldSize),bi=F.ab.vec3.negate([],xi),wi=F.ab.mat4.identity([]),dr=F.dj(pt.center.lat,pt.zoom),jr=F.ab.mat4.fromScaling([],[1,1,1/dr]);F.ab.mat4.translate(wi,wi,bi);const Qr=Fe.paint.get("model-opacity").constantOr(1),Xn=new Bi(qe.gl.LEQUAL,Bi.ReadWrite,Ae.depthRangeFor3D),ho=new Bi(qe.gl.LEQUAL,Bi.ReadOnly,Ae.depthRangeFor3D),yo=new F.cd([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),zo="shadow"===Ae.renderPass,ko=zo&&zt?zt.getCurrentCascadeFrustum():pt.getFrustum(pt.scaleZoom(pt.worldSize)),Uo=Fe.paint.get("model-front-cutoff"),ia=Uo[2]<1,_a=eo(Ae,Fe.paint.get("model-cutoff-fade-range")),Ma=Fe.getLayerRenderingStats();(function(F,Ae,Oe,Fe){const Ve=F.terrain?F.terrain.exaggeration():0,qe=F.transform.zoom;for(const pt of Fe){const Fe=Ae.getTile(pt).getBucket(Oe);Fe&&(F.conflationActive&&Fe.updateReplacement(pt,F.replacementSource),Fe.evaluateScale(F,Oe),F.terrain&&Ve>0&&Fe.elevationUpdate(F.terrain,Ve,pt,Oe.source),Fe.needsReEvaluation(F,qe,Oe)&&Fe.evaluate(Oe))}})(Ae,Oe,Fe,Ve),function(){let ri,bi,Ea;ia?(ri=Ve.length-1,bi=-1,Ea=-1):(ri=0,bi=Ve.length,Ea=1);const Ia=new Float64Array(16),rl=F.ab.vec3.create(),Sl=new F.P(0,0);for(let Il=ri;Il!==bi;Il+=Ea){const ri=Ve[Il],bi=Oe.getTile(ri).getBucket(Fe);if(!bi||!bi.uploaded)continue;let Ea=!1;zt&&(Ea=0===zt.getMaxCascadeForTile(ri.toUnwrapped()));const Kl=pt.calculatePosMatrix(ri.toUnwrapped(),pt.worldSize),Ql=bi.modelTraits;!zo&&ia&&(F.ab.mat4.invert(Ia,Kl),F.ab.vec3.transformMat4(rl,xi,Ia),Sl.x=rl[0],Sl.y=rl[1]);const ec=[];for(const Oe of bi.getNodesInfo()){if(Oe.hiddenByReplacement)continue;if(!Oe.node.meshes)continue;const Fe=Oe.node;let Ve=0;Ae.terrain&&Fe.elevation&&(Ve=Fe.elevation*Ae.terrain.exaggeration());const qe=(()=>{const Ae=Oe.aabb;return yo.min=[...Ae.min],yo.max=[...Ae.max],yo.min[2]+=Ve,yo.max[2]+=Ve,F.ab.vec3.transformMat4(yo.min,yo.min,Kl),F.ab.vec3.transformMat4(yo.max,yo.max,Kl),yo})(),vt=Oe.evaluatedScale;if(vt[0]<=1&&vt[1]<=1&&vt[2]<=1&&0===qe.intersects(ko))continue;if(!zo&&ia){const Ae=1/6;Oe.cameraCollisionOpacity=xi[0]>qe.min[0]&&xi[0]<qe.max[0]&&xi[1]>qe.min[1]&&xi[1]<qe.max[1]&&xi[2]*dr<qe.max[2]&&Fe.footprint&&F.bA(Sl,Fe.footprint)?Math.max(Oe.cameraCollisionOpacity-Ae,0):Math.min(1,Oe.cameraCollisionOpacity+Ae)}const zt=[...Kl],ri=Fe.anchor?Fe.anchor[0]:0,bi=Fe.anchor?Fe.anchor[1]:0;F.ab.mat4.translate(zt,zt,[ri*(vt[0]-1),bi*(vt[1]-1),Ve]),F.ab.vec3.exactEquals(vt,F.dm)||F.ab.mat4.scale(zt,zt,vt);const wi=F.ab.mat4.multiply([],zt,Fe.matrix),jr=F.ab.mat4.multiply([],pt.expandedFarZProjMatrix,wi),Xn=F.ab.mat4.multiply([],pt.expandedFarZProjMatrix,zt),ho=F.ab.vec4.transformMat4([],[ri,bi,Ve,1],jr)[2];Fe.hidden=!1;let Ma=Qr;zo||(ia&&(Ma*=Oe.cameraCollisionOpacity,Ma*=La(zt,pt,Oe.aabb,Uo)),Ma*=Da(_a,ho)),0!==Ma?ec.push({nodeInfo:Oe,depth:ho,opacity:Ma,wvpForNode:jr,wvpForTile:Xn,nodeModelMatrix:wi,tileModelMatrix:zt}):Fe.hidden=!0}zo||ec.sort(((F,Ae)=>!ia||1===F.opacity&&1===Ae.opacity?F.depth<Ae.depth?-1:1:1===F.opacity?-1:1===Ae.opacity?1:F.depth>Ae.depth?-1:1));for(const Oe of ec){const Ve=Oe.nodeInfo,ri=Ve.node;let xi=F.ab.mat4.multiply([],jr,Oe.tileModelMatrix);F.ab.mat4.multiply(xi,wi,xi);const bi=F.ab.mat4.invert([],xi);F.ab.mat4.transpose(bi,bi),F.ab.mat4.scale(bi,bi,jp),xi=F.ab.mat4.multiply(xi,xi,ri.matrix);const dr="light-beam"===Ae.renderPass,Qr="none"===Fe.paint.get("model-color-use-theme").constantOr("default"),yo=Ql&F.dp.HasMapboxMeshFeatures,ko=yo?0:Ve.evaluatedRMEA[0][2];for(let F=0;F<ri.meshes.length;++F){const wi=ri.meshes[F],jr=F===ri.lightMeshIndex;let Uo=Oe.wvpForNode;if(jr){if(!dr&&!Ae.terrain&&Ae.shadowRenderer){Ae.currentLayer<Ae.firstLightBeamLayer&&(Ae.firstLightBeamLayer=Ae.currentLayer);continue}Uo=Oe.wvpForTile}else if(dr)continue;const ia={defines:[]},_a=[];if(!zo&&zt&&(zt.useNormalOffset=!!wi.normalBuffer),ya(ia.defines,_a,wi,Ae,Qr?null:Fe.lut),yo||ia.defines.push("DIFFUSE_SHADED"),Ea&&ia.defines.push("SHADOWS_SINGLE_CASCADE"),Ma&&(zo?Ma.numRenderedVerticesInShadowPass+=wi.vertexArray.length:Ma.numRenderedVerticesInTransparentPass+=wi.vertexArray.length),zo){wa(wi,Oe.nodeModelMatrix,Ae,Fe);continue}let Ia=null;if(vt){const F=va(Oe.nodeModelMatrix,Ae.transform);if(Ia=new Float32Array(F),"globe"!==pt.projection.name){const Ae=wi.aabb.min,Oe=wi.aabb.max,[Fe,Ve]=vt.getOpacityForBounds(F,Ae[0],Ae[1],Oe[0],Oe[1]);ia.overrideFog=Fe>=Jl||Ve>=Jl}}const rl=wi.material;let Sl;rl.occlusionTexture&&rl.occlusionTexture.offsetScale&&(Sl=rl.occlusionTexture.offsetScale,ia.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const Il=Ae.getOrCreateProgram("model",ia);!zo&&zt&&zt.setupShadowsFromMatrix(Oe.tileModelMatrix,Il,zt.useNormalOffset),Ae.uploadCommonUniforms(qe,Il,null,Ia);const Kl=rl.pbrMetallicRoughness;Kl.metallicFactor=.9,Kl.roughnessFactor=.5;const Ql=br(new Float32Array(Uo),new Float32Array(xi),new Float32Array(bi),new Float32Array(ri.matrix),Ae,Oe.opacity,Kl.baseColorFactor.toRenderColor(null),rl.emissiveFactor,Kl.metallicFactor,Kl.roughnessFactor,rl,ko,Fe,[0,0,0],Sl);!jr&&(Ve.hasTranslucentParts||Oe.opacity<1)&&Il.draw(Ae,qe.gl.TRIANGLES,Xn,Ui.disabled,ki.disabled,Vi.backCCW,Ql,Fe.id,wi.vertexBuffer,wi.indexBuffer,wi.segments,Fe.paint,Ae.transform.zoom,void 0,_a),Il.draw(Ae,qe.gl.TRIANGLES,jr?ho:Xn,Ui.disabled,jr||Oe.opacity<1||Ve.hasTranslucentParts?ki.alphaBlended:ki.unblended,Vi.backCCW,Ql,Fe.id,wi.vertexBuffer,wi.indexBuffer,wi.segments,Fe.paint,Ae.transform.zoom,void 0,_a)}}}}()}(Ae,Oe,Fe,Ve),void c();if("model"!==ri.type)return;const xi=ri.getModels(),bi=[],wi=Ae.transform.getFreeCameraOptions().position,dr=F.ab.vec3.scale([],[wi.x,wi.y,wi.z],Ae.transform.worldSize);F.ab.vec3.negate(dr,dr);const jr=[],Qr=[];let Xn=0;for(const Oe of xi){const Ve=Fe.paint.get("model-rotation").constantOr(null),qe=Fe.paint.get("model-scale").constantOr(null),pt=Fe.paint.get("model-translation").constantOr(null);Oe.computeModelMatrix(Ae,Ve,qe,pt,!0,!0,!1);const vt=F.ab.mat4.identity([]),zt=F.dj(Oe.position.lat,Ae.transform.zoom),ri=F.ab.mat4.fromScaling([],[1,1,1/zt]);F.ab.mat4.translate(vt,vt,dr),bi.push({zScaleMatrix:ri,negCameraPosMatrix:vt});for(const F of Oe.nodes)ba(Ae.transform,F,Oe.matrix,Ae.transform.expandedFarZProjMatrix,Xn,jr,Qr);Xn++}if(jr.sort(((F,Ae)=>Ae.depth-F.depth)),"shadow"!==Ae.renderPass){if(1===qe)for(const F of Qr)xa(F,Ae,Fe,bi[F.modelIndex],Ui.disabled,Ae.colorModeForRenderPass());else{for(const F of Qr)xa(F,Ae,Fe,bi[F.modelIndex],Ui.disabled,ki.disabled);for(const F of Qr)xa(F,Ae,Fe,bi[F.modelIndex],Ae.stencilModeFor3D(),Ae.colorModeForRenderPass());Ae.resetStencilClippingMasks()}for(const F of jr)xa(F,Ae,Fe,bi[F.modelIndex],Ui.disabled,Ae.colorModeForRenderPass());c()}else{for(const F of Qr)wa(F.mesh,F.nodeModelMatrix,Ae,Fe);for(const F of jr)wa(F.mesh,F.nodeModelMatrix,Ae,Fe);c()}}},Hp={line:function(F,Ae,Oe){if(F.hasElevatedBuckets=!1,F.hasNonElevatedBuckets=!1,void 0!==F._unevaluatedLayout.getValue("line-elevation-reference")||void 0!==F._unevaluatedLayout.getValue("line-z-offset")){if(Ae){const Oe=Ae.getVisibleCoordinates();for(const Fe of Oe){const Oe=Ae.getTile(Fe).getBucket(F);if(Oe&&(Oe.hasZOffset?F.hasElevatedBuckets=!0:F.hasNonElevatedBuckets=!0,F.hasElevatedBuckets&&F.hasNonElevatedBuckets))break}}}else F.hasNonElevatedBuckets=!0},model:function(F,Ae,Oe){const Fe=Ae.getSource();if(!Fe.loaded())return;if("vector"===Fe.type||"geojson"===Fe.type)return void(Oe.modelManager&&Oe.modelManager.upload(Oe,"vector"===Fe.type?F.scope:""));if("batched-model"===Fe.type)return;if("model"!==Fe.type)return;const Ve=Fe.getModels();for(const F of Ve)F.upload(Oe.context)},raster:function(F,Ae,Oe){const Fe=Ae.getSource();if(!(Fe instanceof ot&&Fe.loaded()))return;const Ve=F.sourceLayer||Fe.rasterLayerIds&&Fe.rasterLayerIds[0];if(!Ve)return;const qe=F.paint.get("raster-array-band")||Fe.getInitialBand(Ve);if(null==qe)return;const pt=Ae.getIds().map((F=>Ae.getTileByID(F)));for(const F of pt)F.updateNeeded(Ve,qe)&&Fe.prepareTile(F,Ve,qe)},"raster-particle":function(F,Ae,Oe){const Fe=Ae.getSource();if(!(Fe instanceof ot&&Fe.loaded()))return;const Ve=F.sourceLayer||Fe.rasterLayerIds&&Fe.rasterLayerIds[0];if(!Ve)return;const qe=F.paint.get("raster-particle-array-band")||Fe.getInitialBand(Ve);if(null==qe)return;const pt=Ae.getIds().map((F=>Ae.getTileByID(F)));for(const F of pt)F.updateNeeded(Ve,qe)&&Fe.prepareTile(F,Ve,qe)}};class Xa{constructor(Ae,Oe,Fe,Ve,qe){this.context=new Rr(Ae,Oe),this.transform=Fe,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=qe,this._timeStamp=F.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const pt=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const F of pt)this._debugParams.enabledLayers[F]=!0;qe.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),qe.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),qe.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),qe.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),qe.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),qe.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const F of pt)qe.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],F);this.occlusionParams=new Pa(qe),this.setup(),this.numSublayers=St.maxUnderzooming+St.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new F.dv,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new so(this),this._wireframeDebugCache=new za,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const vt=new F.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new F.T(this.context,vt,Ae.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=Ve}updateTerrain(F,Ae){const Oe=!!F&&!!F.terrain&&this.transform.projection.supportsTerrain;if(!(Oe||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Vs(this,F));const Fe=this._terrain;this.transform.elevation=Oe?Fe:null,Fe.update(F,this.transform,Ae),this.transform.elevation&&!Fe.enabled&&(this.transform.elevation=null)}_updateFog(F){const Ae=F.fog;if(!Ae||"globe"===this.transform.projection.name||Ae.getOpacity(this.transform.pitch)<1||Ae.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[Oe,Fe]=Ae.getFovAdjustedRange(this.transform._fov);if(Oe>Fe)return void(this.transform.fogCullDistSq=null);const Ve=Oe+.78*(Fe-Oe);this.transform.fogCullDistSq=Ve*Ve}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(F){F&&!this._terrain&&(this._terrain=new Vs(this,this.style)),this._forceTerrainMode=F}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(Ae,Oe){if(this.width=Ae*F.q.devicePixelRatio,this.height=Oe*F.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const F of this.style.order)this.style._mergedLayers[F].resize()}setup(){const Ae=this.context,Oe=new F.b4;Oe.emplaceBack(0,0),Oe.emplaceBack(F.ag,0),Oe.emplaceBack(0,F.ag),Oe.emplaceBack(F.ag,F.ag),this.tileExtentBuffer=Ae.createVertexBuffer(Oe,F.b6.members),this.tileExtentSegments=F.b7.simpleSegment(0,0,4,2);const Fe=new F.b4;Fe.emplaceBack(0,0),Fe.emplaceBack(F.ag,0),Fe.emplaceBack(0,F.ag),Fe.emplaceBack(F.ag,F.ag),this.debugBuffer=Ae.createVertexBuffer(Fe,F.b6.members),this.debugSegments=F.b7.simpleSegment(0,0,4,5);const Ve=new F.b4;Ve.emplaceBack(-1,-1),Ve.emplaceBack(1,-1),Ve.emplaceBack(-1,1),Ve.emplaceBack(1,1),this.viewportBuffer=Ae.createVertexBuffer(Ve,F.b6.members),this.viewportSegments=F.b7.simpleSegment(0,0,4,2);const qe=new F.aT;qe.emplaceBack(0,0,0,0),qe.emplaceBack(F.ag,0,F.ag,0),qe.emplaceBack(0,F.ag,0,F.ag),qe.emplaceBack(F.ag,F.ag,F.ag,F.ag),this.mercatorBoundsBuffer=Ae.createVertexBuffer(qe,F.b9.members),this.mercatorBoundsSegments=F.b7.simpleSegment(0,0,4,2);const pt=new F.aU;pt.emplaceBack(0,1,2),pt.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=Ae.createIndexBuffer(pt);const vt=new F.b5;for(const F of[0,1,3,2,0])vt.emplaceBack(F);this.debugIndexBuffer=Ae.createIndexBuffer(vt),this.emptyTexture=new F.T(Ae,new F.r({width:1,height:1},Uint8Array.of(0,0,0,0)),Ae.gl.RGBA8),this.identityMat=F.ab.mat4.create();const zt=this.context.gl;this.stencilClearMode=new Ui({func:zt.ALWAYS,mask:0},0,255,zt.ZERO,zt.ZERO,zt.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(F){return F._makeTileBoundsBuffers(this.context,this.transform.projection),F._tileBoundsBuffer?{tileBoundsBuffer:F._tileBoundsBuffer,tileBoundsIndexBuffer:F._tileBoundsIndexBuffer,tileBoundsSegments:F._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const F=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,F.TRIANGLES,Bi.disabled,this.stencilClearMode,ki.disabled,Vi.disabled,Bs(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(F,Ae,Oe){if(!Ae||this.currentStencilSource===Ae.id||!F.isTileClipped()||!Oe||0===Oe.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let F=!1;for(const Ae of Oe)if(void 0===this._tileClippingMaskIDs[Ae.key]){F=!0;break}if(!F)return}this.currentStencilSource=Ae.id;const Fe=this.context,Ve=Fe.gl;this.nextStencilID+Oe.length>256&&this.clearStencil(),Fe.setColorMode(ki.disabled),Fe.setDepthMode(Bi.disabled);const qe=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const F of Oe){const Oe=Ae.getTile(F),Fe=this._tileClippingMaskIDs[F.key]=this.nextStencilID++,{tileBoundsBuffer:pt,tileBoundsIndexBuffer:vt,tileBoundsSegments:zt}=this.getTileBoundsBuffers(Oe);qe.draw(this,Ve.TRIANGLES,Bi.disabled,new Ui({func:Ve.ALWAYS,mask:0},Fe,255,Ve.KEEP,Ve.KEEP,Ve.REPLACE),ki.disabled,Vi.disabled,Bs(F.projMatrix),"$clipping",pt,vt,zt)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const F=this.nextStencilID++,Ae=this.context.gl;return new Ui({func:Ae.NOTEQUAL,mask:255},F,255,Ae.KEEP,Ae.KEEP,Ae.REPLACE)}stencilModeForClipping(F){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(F);const Ae=this.context.gl;return new Ui({func:Ae.EQUAL,mask:255},this._tileClippingMaskIDs[F.key],0,Ae.KEEP,Ae.KEEP,Ae.REPLACE)}stencilConfigForOverlap(F){const Ae=this.context.gl,Oe=F.sort(((F,Ae)=>Ae.overscaledZ-F.overscaledZ)),Fe=Oe[Oe.length-1].overscaledZ,Ve=Oe[0].overscaledZ-Fe+1;if(Ve>1){this.currentStencilSource=void 0,this.nextStencilID+Ve>256&&this.clearStencil();const F={};for(let Oe=0;Oe<Ve;Oe++)F[Oe+Fe]=new Ui({func:Ae.GEQUAL,mask:255},Oe+this.nextStencilID,255,Ae.KEEP,Ae.KEEP,Ae.REPLACE);return this.nextStencilID+=Ve,[F,Oe]}return[{[Fe]:Ui.disabled},Oe]}colorModeForRenderPass(){const Ae=this.context.gl;if(this._showOverdrawInspector){const Oe=1/8;return new ki([Ae.CONSTANT_COLOR,Ae.ONE,Ae.CONSTANT_COLOR,Ae.ONE],new F.aj(Oe,Oe,Oe,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?ki.unblended:ki.alphaBlended}colorModeForDrapableLayerRenderPass(Ae){const Oe=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new ki([Oe.ONE,Oe.ONE_MINUS_SRC_ALPHA,Oe.CONSTANT_ALPHA,Oe.ONE_MINUS_SRC_ALPHA],new F.aj(0,0,0,void 0===Ae?0:Ae),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(F,Ae,Oe,Fe=!1){if(this.depthOcclusion)return new Bi(this.context.gl.GREATER,Bi.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!Fe)return Bi.disabled;const Ve=1-((1+this.currentLayer)*this.numSublayers+F)*this.depthEpsilon;return new Bi(Oe||this.context.gl.LEQUAL,Ae,[Ve,Ve])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const Ae=this.context.gl,Oe=Math.ceil(this.width),Fe=Math.ceil(this.height),Ve=this.context.bindFramebuffer.get(),qe=Ae.getParameter(Ae.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===Oe&&this.depthFBO.height===Fe||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==Oe&&0!==Fe&&(this.depthFBO=new Ir(this.context,Oe,Fe,!1,"texture"),this.depthTexture=new F.T(this.context,{width:Oe,height:Fe,data:null},Ae.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(Ve),Ae.bindTexture(Ae.TEXTURE_2D,qe),this.depthFBO&&(Ae.bindFramebuffer(Ae.READ_FRAMEBUFFER,null),Ae.bindFramebuffer(Ae.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),Ae.blitFramebuffer(0,0,Oe,Fe,0,0,Oe,Fe,Ae.DEPTH_BUFFER_BIT,Ae.NEAREST),Ae.bindFramebuffer(Ae.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((F,Ae)=>F+Ae/this._fpsHistory.length),0))}render(Ae,Oe){const Fe=F.q.now();this._dt=Fe-this._timeStamp,this._timeStamp=Fe,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=Ae.map.repaint,this.style=Ae,this.options=Oe;const Ve=this.style._mergedLayers,qe=!(!this.terrain||!this.terrain.enabled),a=()=>this.style._getOrder(qe).filter((F=>{const Ae=Ve[F];return!(Ae.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Ae.type]}));let pt=a(),vt=!1,zt=!1;for(const F of pt){const Ae=Ve[F];"circle"===Ae.type&&(vt=!0),"symbol"===Ae.type&&(Ae.hasInitialOcclusionOpacityProperties?zt=!0:vt=!0)}let ri=pt.map((F=>Ve[F]));const xi=this.style._mergedSourceCaches;this.imageManager=Ae.imageManager,this.modelManager=Ae.modelManager,this.symbolFadeChange=Ae.placement.symbolFadeChange(F.q.now()),this.imageManager.beginFrame();let bi=0,wi=!1;for(const F in xi){const Ae=xi[F];Ae.used&&(Ae.prepare(this.context),Ae.getSource().usedInConflation&&++bi)}let dr=!1;for(const F of ri)F.isHidden(this.transform.zoom)||("clip"===F.type&&(dr=!0),this.prepareLayer(F));const jr={},Qr={},Xn={},ho={},yo={};for(const F in xi){const Ae=xi[F];jr[F]=Ae.getVisibleCoordinates(),Qr[F]=jr[F].slice().reverse(),Xn[F]=Ae.getVisibleCoordinates(!0).reverse(),ho[F]=Ae.getShadowCasterCoordinates(),yo[F]=Ae.sortCoordinatesByDistance(jr[F])}const x=F=>{const Ae=this.style.getLayerSourceCache(F);return Ae&&Ae.used?Ae.getSource():null};if(bi||dr||this._clippingActiveLastFrame){const Ae=[],Oe=[];let Fe=0;for(const F of ri)this.isSourceForClippingOrConflation(F,x(F))&&(Ae.push(F),Oe.push(Fe)),Fe++;if(Ae&&(dr||Ae.length>1)||this._clippingActiveLastFrame){dr=!1;const Fe=[];for(let Ve=0;Ve<Ae.length;Ve++){const qe=Ae[Ve],pt=Oe[Ve],vt=this.style.getLayerSourceCache(qe);if(!vt||!vt.used||!vt.getSource().usedInConflation&&"clip"!==qe.type)continue;let zt=F.dx,ri=F.by.None;const xi=[];let bi=!0;if("clip"===qe.type){zt=pt;for(const Ae of qe.layout.get("clip-layer-types"))ri|="model"===Ae?F.by.Model:"symbol"===Ae?F.by.Symbol:F.by.FillExtrusion;for(const F of qe.layout.get("clip-layer-scope"))xi.push(F);qe.isHidden(this.transform.zoom)?bi=!1:dr=!0}bi&&Fe.push({layer:qe.fqid,cache:vt,order:zt,clipMask:ri,clipScope:xi})}this.replacementSource.setSources(Fe),wi=!0}}this._clippingActiveLastFrame=dr,wi||this.replacementSource.clear(),this.conflationActive=wi,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let F=0;F<ri.length;F++){const Ae=ri[F],Oe=Ae.cutoffRange();if(this.longestCutoffRange=Math.max(Oe,this.longestCutoffRange),Oe>0){const F=x(Ae);F&&(this.minCutoffZoom=Math.max(F.minzoom,this.minCutoffZoom)),Ae.minzoom&&(this.minCutoffZoom=Math.max(Ae.minzoom,this.minCutoffZoom))}Ae.is3D()&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=F),this._lastOcclusionLayer=F)}const zo=this.style&&this.style.fog;zo?(this._fogVisible=0!==zo.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=zo.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Xn),this.opaquePassCutoff=0,pt=a(),ri=pt.map((F=>Ve[F])));const ko=this._shadowRenderer;if(ko){ko.updateShadowParameters(this.transform,this.style.directionalLight);for(const F in xi)for(const Ae of jr[F]){let F={min:0,max:0};this.terrain&&(F=this.terrain.getMinMaxForTile(Ae)||F),ko.addShadowReceiver(Ae.toUnwrapped(),F.min,F.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new F.dw(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new ga(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const Uo=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),ia=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(Uo&&!this._snow&&(this._snow=new Za(this)),!Uo&&this._snow&&(this._snow.destroy(),delete this._snow),ia&&!this._rain&&(this._rain=new qa(this)),!ia&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!Ma.has(this.context.gl))return;this.renderPass="offscreen";for(const F of ri){const Oe=Ae.getLayerSourceCache(F);if(!F.hasOffscreenPass()||F.isHidden(this.transform.zoom))continue;const Fe=Oe?Qr[Oe.id]:void 0;("custom"===F.type||"raster"===F.type||"raster-particle"===F.type||F.isSky()||Fe&&Fe.length)&&this.renderLayer(this,Oe,F,Fe)}this.depthRangeFor3D=[0,1-(ri.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,ho)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const _a="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),Ea=(()=>{if(Oe.showOverdrawInspector)return F.aj.black;const Ae=this.style.fog;if(Ae&&this.transform.projection.supportsFog){const Oe=this.style.getLut(Ae.scope);if(!_a){const Fe="none"===Ae.properties.get("color-use-theme"),Ve=Ae.properties.get("color").toRenderColor(Fe?null:Oe).toArray01();return new F.aj(...Ve)}if(_a){const Fe="none"===Ae.properties.get("space-color-use-theme"),Ve=Ae.properties.get("space-color").toRenderColor(Fe?null:Oe).toArray01();return new F.aj(...Ve)}}return F.aj.transparent})();if(this.context.clear({color:Ea,depth:1}),this.clearStencil(),this._showOverdrawInspector=Oe.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&_a&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=pt.length-1;this.currentLayer>=0;this.currentLayer--){const F=ri[this.currentLayer],Oe=Ae.getLayerSourceCache(F);if(F.isSky())continue;const Fe=Oe?(F.is3D()?yo:Qr)[Oe.id]:void 0;this._renderTileClippingMasks(F,Oe,Fe),this.renderLayer(this,Oe,F,Fe)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&_a&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||F.ae(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<pt.length;this.currentLayer++){const F=ri[this.currentLayer],Oe=Ae.getLayerSourceCache(F);F.isSky()&&this.renderLayer(this,Oe,F,Oe?Qr[Oe.id]:void 0)}function I(F,Ae){let Oe;return Ae&&(Oe=("symbol"===F.type?Xn:F.is3D()?yo:Qr)[Ae.id]),Oe}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<pt.length;){const F=ri[this.currentLayer];if("raster"===F.type||"raster-particle"===F.type){const Oe=Ae.getLayerSourceCache(F);this.renderLayer(this,Oe,F,I(F,Oe))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Ia=0;ko&&(Ia=ko.getShadowCastingLayerCount());let rl=!1,Sl=-1;for(let F=0;F<pt.length;++F){const Ae=ri[F];Ae.isHidden(this.transform.zoom)||Ae.is3D()&&(Sl=F)}for(zt&&-1===Sl&&(vt=!0);this.currentLayer<pt.length;){const F=ri[this.currentLayer],Oe=Ae.getLayerSourceCache(F);if(F.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(F)){if(F.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(vt&&!rl&&this.terrain&&!this.transform.isOrthographic&&(rl=!0,this.blitDepth()),zt&&-1!==Sl&&this.currentLayer===Sl+1&&!this.transform.isOrthographic&&this.blitDepth(),F.is3D()||this.terrain||this._renderTileClippingMasks(F,Oe,Oe?jr[Oe.id]:void 0),this.renderLayer(this,Oe,F,I(F,Oe)),!this.terrain&&ko&&Ia>0&&F.hasShadowPass()&&0==--Ia&&(ko.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const F=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=F;this.currentLayer++){const F=ri[this.currentLayer];if(!F.hasLightBeamPass())continue;const Oe=Ae.getLayerSourceCache(F);this.renderLayer(this,Oe,F,Oe?Qr[Oe.id]:void 0)}this.currentLayer=F,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const F=this.currentLayer;this.depthOcclusion=!0;for(const F of this.layersWithOcclusionOpacity){this.currentLayer=F;const Oe=ri[this.currentLayer],Fe=Ae.getLayerSourceCache(Oe),Ve=Fe?Qr[Fe.id]:void 0;Oe.is3D()||this.terrain||this._renderTileClippingMasks(Oe,Fe,Fe?jr[Fe.id]:void 0),this.renderLayer(this,Fe,Oe,Ve)}this.depthOcclusion=!1,this.currentLayer=F,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Oe=null;ri.forEach((F=>{const Fe=Ae.getLayerSourceCache(F);Fe&&!F.isHidden(this.transform.zoom)&&Fe.getVisibleCoordinates().length&&(!Oe||Oe.getSource().maxzoom<Fe.getSource().maxzoom)&&(Oe=Fe)})),Oe&&this.options.showTileBoundaries&&$p.debug(this,Oe,Oe.getVisibleCoordinates(),F.aj.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&$p.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new F.aj(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(F){const Ae=F.transform.padding;ra(F,F.transform.height-(Ae.top||0),3,vp),ra(F,Ae.bottom||0,3,wp),aa(F,Ae.left||0,3,Mp),aa(F,F.transform.width-(Ae.right||0),3,Ip);const Oe=F.transform.centerPoint;!function(F,Ae,Oe,Fe){na(F,Ae-1,Oe-10,2,20,Fe),na(F,Ae-10,Oe-1,20,2,Fe)}(F,Oe.x,F.transform.height-Oe.y,Pp)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),wi||(this.conflationActive=!1)}prepareLayer(F){this.gpuTimingStart(F);const{unsupportedLayers:Ae}=this.transform.projection,Oe=!Ae||!Ae.includes(F.type);if(Hp[F.type]&&(Oe||this.terrain&&"custom"===F.type)){const Ae=this.style.getLayerSourceCache(F);Hp[F.type](F,Ae,this)}this.gpuTimingEnd()}renderLayer(F,Ae,Oe,Fe){Oe.isHidden(this.transform.zoom)||("background"===Oe.type||"sky"===Oe.type||"custom"===Oe.type||"model"===Oe.type||"raster"===Oe.type||"raster-particle"===Oe.type||Fe&&Fe.length)&&(this.id=Oe.id,this.gpuTimingStart(Oe),F.transform.projection.unsupportedLayers&&F.transform.projection.unsupportedLayers.includes(Oe.type)&&(!F.terrain||"custom"!==Oe.type)||"clip"===Oe.type||$p[Oe.type](F,Ae,Oe,Fe,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(F){if(!this.options.gpuTiming)return;const Ae=this.context.extTimerQuery,Oe=this.context.gl;let Fe=this.gpuTimers[F.id];Fe||(Fe=this.gpuTimers[F.id]={calls:0,cpuTime:0,query:Oe.createQuery()}),Fe.calls++,Oe.beginQuery(Ae.TIME_ELAPSED_EXT,Fe.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const F=this.context.extTimerQuery,Ae=this.context.gl,Oe=Ae.createQuery();this.deferredRenderGpuTimeQueries.push(Oe),Ae.beginQuery(F.TIME_ELAPSED_EXT,Oe)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const F=this.gpuTimers;return this.gpuTimers={},F}collectDeferredRenderGpuQueries(){const F=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],F}queryGpuTimers(F){const Ae={};for(const Oe in F){const Fe=F[Oe],Ve=this.context.extTimerQuery,qe=Ve.getQueryParameter(Fe.query,this.context.gl.QUERY_RESULT)/1e6;Ve.deleteQueryEXT(Fe.query),Ae[Oe]=qe}return Ae}queryGpuTimeDeferredRender(F){if(!this.options.gpuTimingDeferredRender)return 0;const Ae=this.context.gl;let Oe=0;for(const Fe of F)Oe+=Ae.getQueryParameter(Fe,Ae.QUERY_RESULT)/1e6,Ae.deleteQuery(Fe);return Oe}translatePosMatrix(Ae,Oe,Fe,Ve,qe){if(!Fe[0]&&!Fe[1])return Ae;const pt=qe?"map"===Ve?this.transform.angle:0:"viewport"===Ve?-this.transform.angle:0;if(pt){const F=Math.sin(pt),Ae=Math.cos(pt);Fe=[Fe[0]*Ae-Fe[1]*F,Fe[0]*F+Fe[1]*Ae]}const vt=[qe?Fe[0]:F.ar(Oe,Fe[0],this.transform.zoom),qe?Fe[1]:F.ar(Oe,Fe[1],this.transform.zoom),0],zt=new Float32Array(16);return F.ab.mat4.translate(zt,Ae,vt),zt}saveTileTexture(F){const Ae=F.size[0],Oe=this._tileTextures[Ae];Oe?Oe.push(F):this._tileTextures[Ae]=[F]}getTileTexture(F){const Ae=this._tileTextures[F];return Ae&&Ae.length>0?Ae.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(F,Ae,Oe){const Fe=void 0===Oe?this.terrain&&this.terrain.renderingToTexture:Oe,Ve=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===F||"terrainRaster"===F?(Ve.push("LIGHTING_3D_MODE"),Ve.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):Fe||Ve.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||Ve.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(Ve.push("TERRAIN"),this.linearFloatFilteringSupported()&&Ve.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&Ve.push("GLOBE"),!this._fogVisible||Fe||void 0!==Ae&&!Ae||Ve.push("FOG","FOG_DITHERING"),Fe&&Ve.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&Ve.push("OVERDRAW_INSPECTOR"),Ve}getOrCreateProgram(F,Ae){this.cache=this.cache||{};const Oe=Ae&&Ae.defines||[],Fe=Ae&&Ae.config,Ve=this.currentGlobalDefines(F,Ae&&Ae.overrideFog,Ae&&Ae.overrideRtt).concat(Oe),qe=Ws.cacheKey(Td[F],F,Ve,Fe);return this.cache[qe]||(this.cache[qe]=new Ws(this.context,F,Td[F],Fe,up[F],Ve)),this.cache[qe]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const F=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(F.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new F.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(Ae,Oe){if(this.style.enable3dLights()){const Fe=this.style.directionalLight,Ve=this.style.ambientLight;if(Fe&&Ve){const qe=((Ae,Oe,Fe)=>{const Ve=Ae.properties.get("direction"),qe="none"===Ae.properties.get("color-use-theme"),pt=Ae.properties.get("color").toRenderColor(qe?null:Fe.getLut(Ae.scope)).toArray01(),vt=Ae.properties.get("intensity"),zt="none"===Oe.properties.get("color-use-theme"),ri=Oe.properties.get("color").toRenderColor(zt?null:Fe.getLut(Oe.scope)).toArray01(),xi=Oe.properties.get("intensity"),bi=[Ve.x,Ve.y,Ve.z],wi=F.cM(ri,xi),dr=F.cM(pt,vt);return{u_lighting_ambient_color:wi,u_lighting_directional_dir:bi,u_lighting_directional_color:dr,u_ground_radiance:qs(bi,dr,wi)}})(Fe,Ve,this.style);Oe.setLightsUniformValues(Ae,qe)}}}uploadCommonUniforms(Ae,Oe,Fe,Ve,qe){if(this.uploadCommonLightUniforms(Ae,Oe),this.terrain&&this.terrain.renderingToTexture)return;const pt=this.style.fog;if(pt){const qe=pt.getOpacity(this.transform.pitch),vt=((Ae,Oe,Fe,Ve,qe,pt,vt,zt,ri,xi,bi,wi)=>{const dr=Ae.transform,jr="none"===Oe.properties.get("color-use-theme"),Qr=Oe.properties.get("color").toRenderColor(jr?null:Ae.style.getLut(Oe.scope)).toArray01();Qr[3]=Ve;const Xn=Ae.frameCounter/1e3%1,[ho,yo]=Oe.properties.get("vertical-range");return{u_fog_matrix:Fe?dr.calculateFogTileMatrix(Fe):wi||Ae.identityMat,u_fog_range:Oe.getFovAdjustedRange(dr._fov),u_fog_color:Qr,u_fog_horizon_blend:Oe.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(ho,yo),yo],u_fog_temporal_offset:Xn,u_frustum_tl:qe,u_frustum_tr:pt,u_frustum_br:vt,u_frustum_bl:zt,u_globe_pos:ri,u_globe_radius:xi,u_viewport:bi,u_globe_transition:F.ae(dr.zoom),u_is_globe:+("globe"===dr.projection.name)}})(this,pt,Fe,qe,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*F.q.devicePixelRatio,this.transform.height*F.q.devicePixelRatio],Ve);Oe.setFogUniformValues(Ae,vt)}qe&&Oe.setCutoffUniformValues(Ae,qe.uniformValues)}setTileLoadedFlag(F){this.tileLoaded=F}saveCanvasCopy(){const F=this.canvasCopy();F&&(this.frameCopies.push(F),this.tileLoaded=!1)}canvasCopy(){const F=this.context.gl,Ae=F.createTexture();return F.bindTexture(F.TEXTURE_2D,Ae),F.copyTexImage2D(F.TEXTURE_2D,0,F.RGBA,0,0,F.drawingBufferWidth,F.drawingBufferHeight,0),Ae}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const F=this.style&&this.style.fog;return!!F&&0!==F.getOpacity(this.transform.pitch)}getBackgroundTiles(){const F=this._backgroundTiles,Ae=this._backgroundTiles={},Oe=this.transform.coveringTiles({tileSize:512});for(const Fe of Oe)Ae[Fe.key]=F[Fe.key]||new bt(Fe,512,this.transform.tileZoom,this);return Ae}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(F,Ae){return!(!F.is3D()||"clip"!==F.type&&(F.minzoom&&F.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==F.sourceLayer)&&(!Ae||"batched-model"!==Ae.type)))}isTileAffectedByFog(F){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let Ae=this._cachedTileFogOpacities[F.key];return Ae||(this._cachedTileFogOpacities[F.key]=Ae=this.style.fog.getOpacityForTile(F)),Ae[0]>=Jl||Ae[1]>=Jl}setupDepthForOcclusion(F,Ae,Oe){const Fe=this.context,Ve=Fe.gl,qe=!!Oe;var pt;Oe||(Oe={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),Fe.activeTexture.set(Ve.TEXTURE3),F&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(Ve.NEAREST,Ve.CLAMP_TO_EDGE),Oe.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],Oe.u_depth_range_unpack=[2/((pt=this.depthRangeFor3D)[1]-pt[0]),-1-2*pt[0]/(pt[1]-pt[0])],Oe.u_occluder_half_size=.5*this.occlusionParams.occluderSize,Oe.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(Ve.NEAREST,Ve.CLAMP_TO_EDGE),Fe.activeTexture.set(Ve.TEXTURE0),qe||Ae.setTerrainUniformValues(Fe,Oe)}}function Ka(F,Ae){let Oe=!1,Fe=null;const s=()=>{Fe=null,Oe&&(F(),Fe=setTimeout(s,Ae),Oe=!1)};return()=>(Oe=!0,Fe||s(),Fe)}class Ya{constructor(Ae){this._hashName=Ae&&encodeURIComponent(Ae),F.aP(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ka(this._updateHashUnthrottled.bind(this),300)}addTo(F){return this._map=F,window.addEventListener("hashchange",this._onHashChange,!1),F.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const F=this._map;if(!F)return"";const Ae=Ja(F);if(this._hashName){const F=this._hashName;let Oe=!1;const Fe=location.hash.slice(1).split("&").map((Fe=>{const Ve=Fe.split("=")[0];return Ve===F?(Oe=!0,`${Ve}=${Ae}`):Fe})).filter((F=>F));return Oe||Fe.push(`${F}=${Ae}`),`#${Fe.join("&")}`}return`#${Ae}`}_getCurrentHash(){const F=location.hash.replace("#","");if(this._hashName){let Ae;return F.split("&").map((F=>F.split("="))).forEach((F=>{F[0]===this._hashName&&(Ae=F)})),(Ae&&Ae[1]||"").split("/")}return F.split("/")}_onHashChange(){const F=this._map;if(!F)return!1;const Ae=this._getCurrentHash();if(Ae.length>=3&&!Ae.some((F=>isNaN(F)))){const Oe=F.dragRotate.isEnabled()&&F.touchZoomRotate.isEnabled()?+(Ae[3]||0):F.getBearing();return F.jumpTo({center:[+Ae[2],+Ae[1]],zoom:+Ae[0],bearing:Oe,pitch:+(Ae[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Ja(F,Ae){const Oe=F.getCenter(),Fe=Math.round(100*F.getZoom())/100,Ve=Math.ceil((Fe*Math.LN2+Math.log(512/360/.5))/Math.LN10),qe=Math.pow(10,Ve),pt=Math.round(Oe.lng*qe)/qe,vt=Math.round(Oe.lat*qe)/qe,zt=F.getBearing(),ri=F.getPitch();let xi=Ae?`/${pt}/${vt}/${Fe}`:`${Fe}/${vt}/${pt}`;return(zt||ri)&&(xi+="/"+Math.round(10*zt)/10),ri&&(xi+=`/${Math.round(ri)}`),xi}const Xp={linearity:.3,easing:F.dy(0,0,.3,1)},Yp=F.l({deceleration:2500,maxSpeed:1400},Xp),tf=F.l({deceleration:20,maxSpeed:1400},Xp),rf=F.l({deceleration:1e3,maxSpeed:360},Xp),of=F.l({deceleration:1e3,maxSpeed:90},Xp);class rn{constructor(F){this._map=F,this.clear()}clear(){this._inertiaBuffer=[]}record(Ae){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:F.q.now(),settings:Ae})}_drainInertiaBuffer(){const Ae=this._inertiaBuffer,Oe=F.q.now();for(;Ae.length>0&&Oe-Ae[0].time>160;)Ae.shift()}_onMoveEnd(Ae){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const Oe={zoom:0,bearing:0,pitch:0,pan:new F.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:F}of this._inertiaBuffer)Oe.zoom+=F.zoomDelta||0,Oe.bearing+=F.bearingDelta||0,Oe.pitch+=F.pitchDelta||0,F.panDelta&&Oe.pan._add(F.panDelta),F.around&&(Oe.around=F.around),F.pinchAround&&(Oe.pinchAround=F.pinchAround);const Fe=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,Ve={};if(Oe.pan.mag()){const qe=nn(Oe.pan.mag(),Fe,F.l({},Yp,Ae||{}));Ve.offset=Oe.pan.mult(qe.amount/Oe.pan.mag()),Ve.center=this._map.transform.center,an(Ve,qe)}if(Oe.zoom){const F=nn(Oe.zoom,Fe,tf);Ve.zoom=this._map.transform.zoom+F.amount,an(Ve,F)}if(Oe.bearing){const Ae=nn(Oe.bearing,Fe,rf);Ve.bearing=this._map.transform.bearing+F.aw(Ae.amount,-179,179),an(Ve,Ae)}if(Oe.pitch){const F=nn(Oe.pitch,Fe,of);Ve.pitch=this._map.transform.pitch+F.amount,an(Ve,F)}if(Ve.zoom||Ve.bearing){const F=void 0===Oe.pinchAround?Oe.around:Oe.pinchAround;Ve.around=F?this._map.unproject(F):this._map.getCenter()}return this.clear(),Ve.noMoveStart=!0,Ve}}function an(F,Ae){(!F.duration||F.duration<Ae.duration)&&(F.duration=Ae.duration,F.easing=Ae.easing)}function nn(Ae,Oe,Fe){const{maxSpeed:Ve,linearity:qe,deceleration:pt}=Fe,vt=F.aw(Ae*qe/(Oe/1e3),-Ve,Ve),zt=Math.abs(vt)/(pt*qe);return{easing:Fe.easing,duration:1e3*zt,amount:vt*(zt/2)}}class ln extends F.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(Ae,Oe,Fe,Ve={}){const qe=g(Oe.getCanvasContainer(),Fe),pt=Oe.unproject(qe);super(Ae,F.l({point:qe,lngLat:pt,originalEvent:Fe},Ve)),this._defaultPrevented=!1,this.target=Oe}}class cn extends F.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(Ae,Oe,Fe){const Ve="touchend"===Ae?Fe.changedTouches:Fe.touches,qe=v(Oe.getCanvasContainer(),Ve),pt=qe.map((F=>Oe.unproject(F))),vt=qe.reduce(((F,Ae,Oe,Fe)=>F.add(Ae.div(Fe.length))),new F.P(0,0));super(Ae,{points:qe,point:vt,lngLats:pt,lngLat:Oe.unproject(vt),originalEvent:Fe}),this._defaultPrevented=!1}}class hn extends F.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(F,Ae){super("wheel",{originalEvent:Ae}),this._defaultPrevented=!1}}class un{constructor(F,Ae){this._map=F,this._clickTolerance=Ae.clickTolerance}reset(){this._mousedownPos=void 0}wheel(F){return this._firePreventable(new hn(this._map,F))}mousedown(F,Ae){return this._mousedownPos=Ae,this._firePreventable(new ln(F.type,this._map,F))}mouseup(F){this._map.fire(new ln(F.type,this._map,F))}preclick(Ae){const Oe=F.l({},Ae);Oe.type="preclick",this._map.fire(new ln(Oe.type,this._map,Oe))}click(F,Ae){this._mousedownPos&&this._mousedownPos.dist(Ae)>=this._clickTolerance||(this.preclick(F),this._map.fire(new ln(F.type,this._map,F)))}dblclick(F){return this._firePreventable(new ln(F.type,this._map,F))}mouseover(F){this._map.fire(new ln(F.type,this._map,F))}mouseout(F){this._map.fire(new ln(F.type,this._map,F))}touchstart(F){return this._firePreventable(new cn(F.type,this._map,F))}touchmove(F){this._map.fire(new cn(F.type,this._map,F))}touchend(F){this._map.fire(new cn(F.type,this._map,F))}touchcancel(F){this._map.fire(new cn(F.type,this._map,F))}_firePreventable(F){if(this._map.fire(F),F.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class dn{constructor(F){this._map=F}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(F){this._map.fire(new ln(F.type,this._map,F))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ln("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(F){this._delayContextMenu?this._contextMenuEvent=F:this._map.fire(new ln(F.type,this._map,F)),this._map.listens("contextmenu")&&F.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class _n{constructor(F,Ae){this._map=F,this._el=F.getCanvasContainer(),this._container=F.getContainer(),this._clickTolerance=Ae.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(F,Ae){this.isEnabled()&&F.shiftKey&&0===F.button&&(_(),this._startPos=this._lastPos=Ae,this._active=!0)}mousemoveWindow(F,Ae){if(!this._active)return;const Oe=Ae,Fe=this._startPos,Ve=this._lastPos;if(!Fe||!Ve||Ve.equals(Oe)||!this._box&&Oe.dist(Fe)<this._clickTolerance)return;this._lastPos=Oe,this._box||(this._box=l("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",F));const qe=Math.min(Fe.x,Oe.x),pt=Math.max(Fe.x,Oe.x),vt=Math.min(Fe.y,Oe.y),zt=Math.max(Fe.y,Oe.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${qe}px,${vt}px)`,this._box.style.width=pt-qe+"px",this._box.style.height=zt-vt+"px")}))}mouseupWindow(Ae,Oe){if(!this._active)return;const Fe=this._startPos,Ve=Oe;if(Fe&&0===Ae.button){if(this.reset(),m(),Fe.x!==Ve.x||Fe.y!==Ve.y)return this._map.fire(new F.z("boxzoomend",{originalEvent:Ae})),{cameraAnimation:F=>F.fitScreenCoordinates(Fe,Ve,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",Ae)}}keydown(F){this._active&&27===F.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",F))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),p(),delete this._startPos,delete this._lastPos}_fireEvent(Ae,Oe){return this._map.fire(new F.z(Ae,{originalEvent:Oe}))}}function pn(F,Ae){const Oe={};for(let Fe=0;Fe<F.length;Fe++)Oe[F[Fe].identifier]=Ae[Fe];return Oe}class fn{constructor(F){this.reset(),this.numTouches=F.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(Ae,Oe,Fe){(this.centroid||Fe.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=Ae.timeStamp),Fe.length===this.numTouches&&(this.centroid=function(Ae){const Oe=new F.P(0,0);for(const F of Ae)Oe._add(F);return Oe.div(Ae.length)}(Oe),this.touches=pn(Fe,Oe)))}touchmove(F,Ae,Oe){if(this.aborted||!this.centroid)return;const Fe=pn(Oe,Ae);for(const F in this.touches){const Ae=Fe[F];(!Ae||Ae.dist(this.touches[F])>30)&&(this.aborted=!0)}}touchend(F,Ae,Oe){if((!this.centroid||F.timeStamp-this.startTime>500)&&(this.aborted=!0),0===Oe.length){const F=!this.aborted&&this.centroid;if(this.reset(),F)return F}}}class mn{constructor(F){this.singleTap=new fn(F),this.numTaps=F.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(F,Ae,Oe){this.singleTap.touchstart(F,Ae,Oe)}touchmove(F,Ae,Oe){this.singleTap.touchmove(F,Ae,Oe)}touchend(F,Ae,Oe){const Fe=this.singleTap.touchend(F,Ae,Oe);if(Fe){const Ae=F.timeStamp-this.lastTime<500,Oe=!this.lastTap||this.lastTap.dist(Fe)<30;if(Ae&&Oe||this.reset(),this.count++,this.lastTime=F.timeStamp,this.lastTap=Fe,this.count===this.numTaps)return this.reset(),Fe}}}class gn{constructor(){this._zoomIn=new mn({numTouches:1,numTaps:2}),this._zoomOut=new mn({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(F,Ae,Oe){this._zoomIn.touchstart(F,Ae,Oe),this._zoomOut.touchstart(F,Ae,Oe)}touchmove(F,Ae,Oe){this._zoomIn.touchmove(F,Ae,Oe),this._zoomOut.touchmove(F,Ae,Oe)}touchend(F,Ae,Oe){const Fe=this._zoomIn.touchend(F,Ae,Oe),Ve=this._zoomOut.touchend(F,Ae,Oe);return Fe?(this._active=!0,F.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:Ae=>Ae.easeTo({duration:300,zoom:Ae.getZoom()+1,around:Ae.unproject(Fe)},{originalEvent:F})}):Ve?(this._active=!0,F.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:Ae=>Ae.easeTo({duration:300,zoom:Ae.getZoom()-1,around:Ae.unproject(Ve)},{originalEvent:F})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const sf={0:1,2:2};class yn{constructor(F){this.reset(),this._clickTolerance=F.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(F,Ae){return!1}_move(F,Ae){return{}}mousedown(F,Ae){if(this._lastPoint)return;const Oe=y(F);this._correctButton(F,Oe)&&(this._lastPoint=Ae,this._eventButton=Oe)}mousemoveWindow(F,Ae){const Oe=this._lastPoint;if(Oe)if(F.preventDefault(),null!=this._eventButton&&function(F,Ae){const Oe=sf[Ae];return void 0===F.buttons||(F.buttons&Oe)!==Oe}(F,this._eventButton))this.reset();else if(this._moved||!(Ae.dist(Oe)<this._clickTolerance))return this._moved=!0,this._lastPoint=Ae,this._move(Oe,Ae)}mouseupWindow(F){this._lastPoint&&y(F)===this._eventButton&&(this._moved&&m(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class xn extends yn{mousedown(F,Ae){super.mousedown(F,Ae),this._lastPoint&&(this._active=!0)}_correctButton(F,Ae){return 0===Ae&&!F.ctrlKey}_move(F,Ae){return{around:Ae,panDelta:Ae.sub(F)}}}class bn extends yn{_correctButton(F,Ae){return 0===Ae&&F.ctrlKey||2===Ae}_move(F,Ae){const Oe=.8*(Ae.x-F.x);if(Oe)return this._active=!0,{bearingDelta:Oe}}contextmenu(F){F.preventDefault()}}class wn extends yn{_correctButton(F,Ae){return 0===Ae&&F.ctrlKey||2===Ae}_move(F,Ae){const Oe=-.5*(Ae.y-F.y);if(Oe)return this._active=!0,{pitchDelta:Oe}}contextmenu(F){F.preventDefault()}}class Tn{constructor(Ae,Oe){this._map=Ae,this._el=Ae.getCanvasContainer(),this._minTouches=1,this._clickTolerance=Oe.clickTolerance||1,this.reset(),F.aP(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new F.P(0,0)}touchstart(F,Ae,Oe){return this._calculateTransform(F,Ae,Oe)}touchmove(Ae,Oe,Fe){if(this._active&&!(Fe.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===Fe.length&&!F.dz())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return Ae.cancelable&&Ae.preventDefault(),this._calculateTransform(Ae,Oe,Fe)}}touchend(F,Ae,Oe){this._calculateTransform(F,Ae,Oe),this._active&&Oe.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(Ae,Oe,Fe){Fe.length>0&&(this._active=!0);const Ve=pn(Fe,Oe),qe=new F.P(0,0),pt=new F.P(0,0);let vt=0;for(const F in Ve){const Ae=Ve[F],Oe=this._touches[F];Oe&&(qe._add(Ae),pt._add(Ae.sub(Oe)),vt++,Ve[F]=Ae)}if(this._touches=Ve,vt<this._minTouches||!pt.mag())return;const zt=pt.div(vt);return this._sum._add(zt),this._sum.mag()<this._clickTolerance?void 0:{around:qe.div(vt),panDelta:zt}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class En{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(F){}_move(F,Ae,Oe){return{}}touchstart(F,Ae,Oe){this._firstTwoTouches||Oe.length<2||(this._firstTwoTouches=[Oe[0].identifier,Oe[1].identifier],this._start([Ae[0],Ae[1]]))}touchmove(F,Ae,Oe){const Fe=this._firstTwoTouches;if(!Fe)return;F.preventDefault();const[Ve,qe]=Fe,pt=Sn(Oe,Ae,Ve),vt=Sn(Oe,Ae,qe);if(!pt||!vt)return;const zt=this._aroundCenter?null:pt.add(vt).div(2);return this._move([pt,vt],zt,F)}touchend(F,Ae,Oe){if(!this._firstTwoTouches)return;const[Fe,Ve]=this._firstTwoTouches,qe=Sn(Oe,Ae,Fe),pt=Sn(Oe,Ae,Ve);qe&&pt||(this._active&&m(),this.reset())}touchcancel(){this.reset()}enable(F){this._enabled=!0,this._aroundCenter=!!F&&"center"===F.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Sn(F,Ae,Oe){for(let Fe=0;Fe<F.length;Fe++)if(F[Fe].identifier===Oe)return Ae[Fe]}function Cn(F,Ae){return Math.log(F/Ae)/Math.LN2}class In extends En{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(F){this._startDistance=this._distance=F[0].dist(F[1])}_move(F,Ae){const Oe=this._distance;if(this._distance=F[0].dist(F[1]),this._active||!(Math.abs(Cn(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Cn(this._distance,Oe),pinchAround:Ae}}}function Rn(F,Ae){return 180*F.angleWith(Ae)/Math.PI}class Dn extends En{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(F){this._startVector=this._vector=F[0].sub(F[1]),this._minDiameter=F[0].dist(F[1])}_move(F,Ae){const Oe=this._vector;if(this._vector=F[0].sub(F[1]),Oe&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Rn(this._vector,Oe),pinchAround:Ae}}_isBelowThreshold(F){this._minDiameter=Math.min(this._minDiameter,F.mag());const Ae=25/(Math.PI*this._minDiameter)*360,Oe=this._startVector;if(!Oe)return!1;const Fe=Rn(F,Oe);return Math.abs(Fe)<Ae}}function Ln(F){return Math.abs(F.y)>Math.abs(F.x)}class An extends En{constructor(F){super(),this._map=F}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(F){this._lastPoints=F,Ln(F[0].sub(F[1]))&&(this._valid=!1)}_move(Ae,Oe,Fe){const Ve=this._lastPoints;if(!Ve)return;const qe=Ae[0].sub(Ve[0]),pt=Ae[1].sub(Ve[1]);return this._map._cooperativeGestures&&!F.dz()&&Fe.touches.length<3||(this._valid=this.gestureBeginsVertically(qe,pt,Fe.timeStamp),!this._valid)?void 0:(this._lastPoints=Ae,this._active=!0,{pitchDelta:(qe.y+pt.y)/2*-.5})}gestureBeginsVertically(F,Ae,Oe){if(void 0!==this._valid)return this._valid;const Fe=F.mag()>=2,Ve=Ae.mag()>=2;if(!Fe&&!Ve)return;if(!Fe||!Ve)return null==this._firstMove&&(this._firstMove=Oe),Oe-this._firstMove<100&&void 0;const qe=F.y>0==Ae.y>0;return Ln(F)&&Ln(Ae)&&qe}}const lf={panStep:100,bearingStep:15,pitchStep:10};class Pn{constructor(){const F=lf;this._panStep=F.panStep,this._bearingStep=F.bearingStep,this._pitchStep=F.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(F){if(F.altKey||F.ctrlKey||F.metaKey)return;let Ae=0,Oe=0,Fe=0,Ve=0,qe=0;switch(F.keyCode){case 61:case 107:case 171:case 187:Ae=1;break;case 189:case 109:case 173:Ae=-1;break;case 37:F.shiftKey?Oe=-1:(F.preventDefault(),Ve=-1);break;case 39:F.shiftKey?Oe=1:(F.preventDefault(),Ve=1);break;case 38:F.shiftKey?Fe=1:(F.preventDefault(),qe=-1);break;case 40:F.shiftKey?Fe=-1:(F.preventDefault(),qe=1);break;default:return}return this._rotationDisabled&&(Oe=0,Fe=0),{cameraAnimation:pt=>{const vt=pt.getZoom();pt.easeTo({duration:300,easeId:"keyboardHandler",easing:Mn,zoom:Ae?Math.round(vt)+Ae*(F.shiftKey?2:1):vt,bearing:pt.getBearing()+Oe*this._bearingStep,pitch:pt.getPitch()+Fe*this._pitchStep,offset:[-Ve*this._panStep,-qe*this._panStep],center:pt.getCenter()},{originalEvent:F})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Mn(F){return F*(2-F)}const uf=4.000244140625,pf=1/450;class kn{constructor(Ae,Oe){this._map=Ae,this._el=Ae.getCanvasContainer(),this._handler=Oe,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=pf,F.aP(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(F){this._defaultZoomRate=F}setWheelZoomRate(F){this._wheelZoomRate=F}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(F){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!F&&"center"===F.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(Ae){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(Ae.ctrlKey||Ae.metaKey||this.isZooming()||F.dz()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let Oe=Ae.deltaMode===WheelEvent.DOM_DELTA_LINE?40*Ae.deltaY:Ae.deltaY;const Fe=F.q.now(),Ve=Fe-(this._lastWheelEventTime||0);this._lastWheelEventTime=Fe,0!==Oe&&Oe%uf==0?this._type="wheel":0!==Oe&&Math.abs(Oe)<4?this._type="trackpad":Ve>400?(this._type=null,this._lastValue=Oe,this._timeout=window.setTimeout(this._onTimeout,40,Ae)):this._type||(this._type=Math.abs(Ve*Oe)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,Oe+=this._lastValue)),Ae.shiftKey&&Oe&&(Oe/=4),this._type&&(this._lastWheelEvent=Ae,this._delta-=Oe,this._active||this._start(Ae)),Ae.preventDefault()}_onTimeout(F){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(F)}_start(F){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const Ae=g(this._el,F);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:Ae,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const Ae=this._map.transform;"wheel"===this._type&&Ae.projection.wrap&&(Ae._center.lng>=180||Ae._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const i=()=>Ae._terrainEnabled()&&this._aroundCoord?Ae.computeZoomRelativeTo(this._aroundCoord):Ae.zoom;if(0!==this._delta){const F="wheel"===this._type&&Math.abs(this._delta)>uf?this._wheelZoomRate:this._defaultZoomRate;let Oe=2/(1+Math.exp(-Math.abs(this._delta*F)));this._delta<0&&0!==Oe&&(Oe=1/Oe);const Fe=i(),Ve=Math.pow(2,Fe),qe="number"==typeof this._targetZoom?Ae.zoomScale(this._targetZoom):Ve;this._targetZoom=Math.min(Ae.maxZoom,Math.max(Ae.minZoom,Ae.scaleZoom(qe*Oe))),"wheel"===this._type&&(this._startZoom=Fe,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const Oe="number"==typeof this._targetZoom?this._targetZoom:i(),Fe=this._startZoom,Ve=this._easing;let qe,pt=!1;if("wheel"===this._type&&Fe&&Ve){const Ae=Math.min((F.q.now()-this._lastWheelEventTime)/200,1),vt=Ve(Ae);qe=F.af(Fe,Oe,vt),Ae<1?this._frameId||(this._frameId=!0):pt=!0}else qe=Oe,pt=!0;this._active=!0,pt&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let vt=qe-i();return vt*this._lastDelta<0&&(vt=0),{noInertia:!0,needsRenderFrame:!pt,zoomDelta:vt,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(Ae){let Oe=F.dA;if(this._prevEase){const Ae=this._prevEase,Fe=(F.q.now()-Ae.start)/Ae.duration,Ve=Ae.easing(Fe+.01)-Ae.easing(Fe),qe=.27/Math.sqrt(Ve*Ve+1e-4)*.01,pt=Math.sqrt(.0729-qe*qe);Oe=F.dy(qe,pt,.25,1)}return this._prevEase={start:F.q.now(),duration:Ae,easing:Oe},Oe}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class Bn{constructor(F,Ae){this._clickZoom=F,this._tapZoom=Ae}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Nn{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(F,Ae){return F.preventDefault(),{cameraAnimation:Oe=>{Oe.easeTo({duration:300,zoom:Oe.getZoom()+(F.shiftKey?-1:1),around:Oe.unproject(Ae)},{originalEvent:F})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Un{constructor(){this._tap=new mn({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(F,Ae,Oe){this._swipePoint||(this._tapTime&&F.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?Oe.length>0&&(this._swipePoint=Ae[0],this._swipeTouch=Oe[0].identifier):this._tap.touchstart(F,Ae,Oe))}touchmove(F,Ae,Oe){if(this._tapTime){if(this._swipePoint){if(Oe[0].identifier!==this._swipeTouch)return;const Fe=Ae[0],Ve=Fe.y-this._swipePoint.y;return this._swipePoint=Fe,F.preventDefault(),this._active=!0,{zoomDelta:Ve/128}}}else this._tap.touchmove(F,Ae,Oe)}touchend(F,Ae,Oe){this._tapTime?this._swipePoint&&0===Oe.length&&this.reset():this._tap.touchend(F,Ae,Oe)&&(this._tapTime=F.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class jn{constructor(F,Ae,Oe){this._el=F,this._mousePan=Ae,this._touchPan=Oe}enable(F){this._inertiaOptions=F||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Gn{constructor(F,Ae,Oe){this._pitchWithRotate=F.pitchWithRotate,this._mouseRotate=Ae,this._mousePitch=Oe}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Vn{constructor(F,Ae,Oe,Fe){this._el=F,this._touchZoom=Ae,this._touchRotate=Oe,this._tapDragZoom=Fe,this._rotationDisabled=!1,this._enabled=!0}enable(F){this._touchZoom.enable(F),this._rotationDisabled||this._touchRotate.enable(F),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const qn=F=>F.zoom||F.drag||F.pitch||F.rotate;class Hn extends F.z{}class Zn{constructor(){this.constants=[1,1,.01],this.radius=0}setup(Ae,Oe){const Fe=F.ab.vec3.sub([],Oe,Ae);this.radius=F.ab.vec3.length(Fe[2]<0?F.ab.vec3.div([],Fe,this.constants):[Fe[0],Fe[1],0])}projectRay(Ae){F.ab.vec3.div(Ae,Ae,this.constants),F.ab.vec3.normalize(Ae,Ae),F.ab.vec3.mul(Ae,Ae,this.constants);const Oe=F.ab.vec3.scale([],Ae,this.radius);if(Oe[2]>0){const Ae=F.ab.vec3.scale([],[0,0,1],F.ab.vec3.dot(Oe,[0,0,1])),Fe=F.ab.vec3.scale([],F.ab.vec3.normalize([],[Oe[0],Oe[1],0]),this.radius),Ve=F.ab.vec3.add([],Oe,F.ab.vec3.scale([],F.ab.vec3.sub([],F.ab.vec3.add([],Fe,Ae),Oe),2));Oe[0]=Ve[0],Oe[1]=Ve[1]}return Oe}}function Wn(F){return F.panDelta&&F.panDelta.mag()||F.zoomDelta||F.bearingDelta||F.pitchDelta}class $n{constructor(Ae,Oe){this._map=Ae,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new rn(Ae),this._bearingSnap=Oe.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Zn,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(Oe),F.aP(["handleEvent","handleWindowEvent"],this);const Fe=this._el;this._listeners=[[Fe,"touchstart",{passive:!0}],[Fe,"touchmove",{passive:!1}],[Fe,"touchend",void 0],[Fe,"touchcancel",void 0],[Fe,"mousedown",void 0],[Fe,"mousemove",void 0],[Fe,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[Fe,"mouseover",void 0],[Fe,"mouseout",void 0],[Fe,"dblclick",void 0],[Fe,"click",void 0],[Fe,"keydown",{capture:!1}],[Fe,"keyup",void 0],[Fe,"wheel",{passive:!1}],[Fe,"contextmenu",void 0],[window,"blur",void 0]];for(const[F,Ae,Oe]of this._listeners){const Fe=F===document?this.handleWindowEvent:this.handleEvent;F.addEventListener(Ae,Fe,Oe)}}destroy(){for(const[F,Ae,Oe]of this._listeners){const Fe=F===document?this.handleWindowEvent:this.handleEvent;F.removeEventListener(Ae,Fe,Oe)}}_addDefaultHandlers(F){const Ae=this._map,Oe=Ae.getCanvasContainer();this._add("mapEvent",new un(Ae,F));const Fe=Ae.boxZoom=new _n(Ae,F);this._add("boxZoom",Fe);const Ve=new gn,qe=new Nn;Ae.doubleClickZoom=new Bn(qe,Ve),this._add("tapZoom",Ve),this._add("clickZoom",qe);const pt=new Un;this._add("tapDragZoom",pt);const vt=Ae.touchPitch=new An(Ae);this._add("touchPitch",vt);const zt=new bn(F),ri=new wn(F);Ae.dragRotate=new Gn(F,zt,ri),this._add("mouseRotate",zt,["mousePitch"]),this._add("mousePitch",ri,["mouseRotate"]);const xi=new xn(F),bi=new Tn(Ae,F);Ae.dragPan=new jn(Oe,xi,bi),this._add("mousePan",xi),this._add("touchPan",bi,["touchZoom","touchRotate"]);const wi=new Dn,dr=new In;Ae.touchZoomRotate=new Vn(Oe,dr,wi,pt),this._add("touchRotate",wi,["touchPan","touchZoom"]),this._add("touchZoom",dr,["touchPan","touchRotate"]),this._add("blockableMapEvent",new dn(Ae));const jr=Ae.scrollZoom=new kn(Ae,this);this._add("scrollZoom",jr,["mousePan"]);const Qr=Ae.keyboard=new Pn;this._add("keyboard",Qr);for(const Oe of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])F.interactive&&F[Oe]&&Ae[Oe].enable(F[Oe])}_add(F,Ae,Oe){this._handlers.push({handlerName:F,handler:Ae,allowed:Oe}),this._handlersById[F]=Ae}stop(F){if(!this._updatingCamera){for(const{handler:F}of this._handlers)F.reset();this._inertia.clear(),this._fireEvents({},{},F),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:F}of this._handlers)if(F.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!qn(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(F,Ae,Oe){for(const Fe in F)if(Fe!==Oe&&(!Ae||Ae.indexOf(Fe)<0))return!0;return!1}handleWindowEvent(F){this.handleEvent(F,`${F.type}Window`)}_getMapTouches(F){const Ae=[];for(const Oe of F)this._el.contains(Oe.target)&&Ae.push(Oe);return Ae}handleEvent(F,Ae){this._updatingCamera=!0;const Oe="renderFrame"===F.type,Fe=Oe?void 0:F,Ve={needsRenderFrame:!1},qe={},pt={},vt=F.touches?this._getMapTouches(F.touches):void 0,zt=vt?v(this._el,vt):Oe?void 0:g(this._el,F);for(const{handlerName:Oe,handler:ri,allowed:xi}of this._handlers){if(!ri.isEnabled())continue;let bi;this._blockedByActive(pt,xi,Oe)?ri.reset():ri[Ae||F.type]&&(bi=ri[Ae||F.type](F,zt,vt),this.mergeHandlerResult(Ve,qe,bi,Oe,Fe),bi&&bi.needsRenderFrame&&this._triggerRenderFrame()),(bi||ri.isActive())&&(pt[Oe]=ri)}const ri={};for(const F in this._previousActiveHandlers)pt[F]||(ri[F]=Fe);this._previousActiveHandlers=pt,(Object.keys(ri).length||Wn(Ve))&&(this._changes.push([Ve,qe,ri]),this._triggerRenderFrame()),(Object.keys(pt).length||Wn(Ve))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:xi}=Ve;xi&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],xi(this._map))}mergeHandlerResult(Ae,Oe,Fe,Ve,qe){if(!Fe)return;F.l(Ae,Fe);const pt={handlerName:Ve,originalEvent:Fe.originalEvent||qe};void 0!==Fe.zoomDelta&&(Oe.zoom=pt),void 0!==Fe.panDelta&&(Oe.drag=pt),void 0!==Fe.pitchDelta&&(Oe.pitch=pt),void 0!==Fe.bearingDelta&&(Oe.rotate=pt)}_applyChanges(){const Ae={},Oe={},Fe={};for(const[Ve,qe,pt]of this._changes)Ve.panDelta&&(Ae.panDelta=(Ae.panDelta||new F.P(0,0))._add(Ve.panDelta)),Ve.zoomDelta&&(Ae.zoomDelta=(Ae.zoomDelta||0)+Ve.zoomDelta),Ve.bearingDelta&&(Ae.bearingDelta=(Ae.bearingDelta||0)+Ve.bearingDelta),Ve.pitchDelta&&(Ae.pitchDelta=(Ae.pitchDelta||0)+Ve.pitchDelta),void 0!==Ve.around&&(Ae.around=Ve.around),void 0!==Ve.aroundCoord&&(Ae.aroundCoord=Ve.aroundCoord),void 0!==Ve.pinchAround&&(Ae.pinchAround=Ve.pinchAround),Ve.noInertia&&(Ae.noInertia=Ve.noInertia),F.l(Oe,qe),F.l(Fe,pt);this._updateMapTransform(Ae,Oe,Fe),this._changes=[]}_updateMapTransform(Ae,Oe,Fe){const Ve=this._map,qe=Ve.transform,a=F=>[F.x,F.y,F.z];if((()=>{const F=this._eventsInProgress.drag;return F&&!this._handlersById[F.handlerName].isActive()})()&&!Wn(Ae)){const F=qe.zoom;qe.cameraElevationReference="sea",null!=this._originalZoom&&qe._orthographicProjectionAtLowPitch&&"globe"!==qe.projection.name&&0===qe.pitch?(qe.cameraElevationReference="ground",qe.zoom=this._originalZoom):(qe.recenterOnTerrain(),qe.cameraElevationReference="ground"),F!==qe.zoom&&this._map._update(!0)}if(qe._isCameraConstrained&&Ve._stop(!0),!Wn(Ae))return void this._fireEvents(Oe,Fe,!0);let{panDelta:pt,zoomDelta:vt,bearingDelta:zt,pitchDelta:ri,around:xi,aroundCoord:bi,pinchAround:wi}=Ae;qe._isCameraConstrained&&(vt>0&&(vt=0),qe._isCameraConstrained=!1),void 0!==wi&&(xi=wi),(vt||(F=>Oe[F]&&!this._eventsInProgress[F])("drag"))&&xi&&(this._dragOrigin=a(qe.pointCoordinate3D(xi)),this._originalZoom=qe.zoom,this._trackingEllipsoid.setup(qe._camera.position,this._dragOrigin)),qe.cameraElevationReference="sea",Ve._stop(!0),xi=xi||Ve.transform.centerPoint,zt&&(qe.bearing+=zt),ri&&(qe.pitch+=ri),qe._updateCameraState();const dr=[0,0,0];if(pt)if("mercator"===qe.projection.name){const F=this._trackingEllipsoid.projectRay(qe.screenPointToMercatorRay(xi).dir),Ae=this._trackingEllipsoid.projectRay(qe.screenPointToMercatorRay(xi.sub(pt)).dir);dr[0]=Ae[0]-F[0],dr[1]=Ae[1]-F[1]}else{const Ae=qe.pointCoordinate(xi);if("globe"===qe.projection.name){pt=pt.rotate(-qe.angle);const Oe=qe._pixelsPerMercatorPixel/qe.worldSize;dr[0]=-pt.x*F.dB(F.aS(Ae.y))*Oe,dr[1]=-pt.y*F.dB(qe.center.lat)*Oe}else{const F=qe.pointCoordinate(xi.sub(pt));Ae&&F&&(dr[0]=F.x-Ae.x,dr[1]=F.y-Ae.y)}}const jr=qe.zoom,Qr=[0,0,0];if(vt){const Ae=a(bi||qe.pointCoordinate3D(xi)),Oe={dir:F.ab.vec3.normalize([],F.ab.vec3.sub([],Ae,qe._camera.position))};if(Oe.dir[2]<0){const Fe=qe.zoomDeltaToMovement(Ae,vt);F.ab.vec3.scale(Qr,Oe.dir,Fe)}}const Xn=F.ab.vec3.add(dr,dr,Qr);qe._translateCameraConstrained(Xn),vt&&Math.abs(qe.zoom-jr)>1e-4&&qe.recenterOnTerrain(),qe.cameraElevationReference="ground",this._map._update(),Ae.noInertia||this._inertia.record(Ae),this._fireEvents(Oe,Fe,!0)}_fireEvents(Ae,Oe,Fe){const Ve=qn(this._eventsInProgress),qe=qn(Ae),pt={};for(const F in Ae){const{originalEvent:Oe}=Ae[F];this._eventsInProgress[F]||(pt[`${F}start`]=Oe),this._eventsInProgress[F]=Ae[F]}!Ve&&qe&&this._fireEvent("movestart",qe.originalEvent);for(const F in pt)this._fireEvent(F,pt[F]);qe&&this._fireEvent("move",qe.originalEvent);for(const F in Ae){const{originalEvent:Oe}=Ae[F];this._fireEvent(F,Oe)}const vt={};let zt;for(const F in this._eventsInProgress){const{handlerName:Ae,originalEvent:Fe}=this._eventsInProgress[F];this._handlersById[Ae].isActive()||(delete this._eventsInProgress[F],zt=Oe[Ae]||Fe,vt[`${F}end`]=zt)}for(const F in vt)this._fireEvent(F,vt[F]);const ri=qn(this._eventsInProgress);if(Fe&&(Ve||qe)&&!ri){this._updatingCamera=!0;const Ae=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=F=>0!==F&&-this._bearingSnap<F&&F<this._bearingSnap;Ae?(i(Ae.bearing||this._map.getBearing())&&(Ae.bearing=0),this._map.easeTo(Ae,{originalEvent:zt})):(this._map.fire(new F.z("moveend",{originalEvent:zt})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(Ae,Oe){this._map.fire(new F.z(Ae,Oe?{originalEvent:Oe}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((F=>{this._frameId=void 0,this.handleEvent(new Hn("renderFrame",{timeStamp:F})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const ff="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Kn extends F.E{constructor(Ae,Oe){super(),this._moving=!1,this._zooming=!1,this.transform=Ae,this._bearingSnap=Oe.bearingSnap,this._respectPrefersReducedMotion=!1!==Oe.respectPrefersReducedMotion,F.aP(["_renderFrameCallback"],this)}getCenter(){return new F.bO(this.transform.center.lng,this.transform.center.lat)}setCenter(F,Ae){return this.jumpTo({center:F},Ae)}panBy(Ae,Oe,Fe){return Ae=F.P.convert(Ae).mult(-1),this.panTo(this.transform.center,F.l({offset:Ae},Oe),Fe)}panTo(Ae,Oe,Fe){return this.easeTo(F.l({center:Ae},Oe),Fe)}getZoom(){return this.transform.zoom}setZoom(F,Ae){return this.jumpTo({zoom:F},Ae),this}zoomTo(Ae,Oe,Fe){return this.easeTo(F.l({zoom:Ae},Oe),Fe)}zoomIn(F,Ae){return this.zoomTo(this.getZoom()+1,F,Ae),this}zoomOut(F,Ae){return this.zoomTo(this.getZoom()-1,F,Ae),this}getBearing(){return this.transform.bearing}setBearing(F,Ae){return this.jumpTo({bearing:F},Ae),this}getPadding(){return this.transform.padding}setPadding(F,Ae){return this.jumpTo({padding:F},Ae),this}rotateTo(Ae,Oe,Fe){return this.easeTo(F.l({bearing:Ae},Oe),Fe)}resetNorth(Ae,Oe){return this.rotateTo(0,F.l({duration:1e3},Ae),Oe),this}resetNorthPitch(Ae,Oe){return this.easeTo(F.l({bearing:0,pitch:0,duration:1e3},Ae),Oe),this}snapToNorth(F,Ae){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(F,Ae):this}getPitch(){return this.transform.pitch}setPitch(F,Ae){return this.jumpTo({pitch:F},Ae),this}cameraForBounds(Ae,Oe){Ae=F.az.convert(Ae);const Fe=Oe&&Oe.bearing||0,Ve=Oe&&Oe.pitch||0,qe=Ae.getNorthWest(),pt=Ae.getSouthEast();return this._cameraForBounds(this.transform,qe,pt,Fe,Ve,Oe)}_extendPadding(Ae){const Oe={top:0,right:0,bottom:0,left:0};return null==Ae?F.l({},Oe,this.transform.padding):"number"==typeof Ae?{top:Ae,bottom:Ae,right:Ae,left:Ae}:F.l({},Oe,Ae)}_extendCameraOptions(Ae){return(Ae=F.l({offset:[0,0],maxZoom:this.transform.maxZoom},Ae)).padding=this._extendPadding(Ae.padding),Ae}_minimumAABBFrustumDistance(F,Ae){const Oe=Ae.max[0]-Ae.min[0],Fe=Ae.max[1]-Ae.min[1];return Oe/Fe>F.aspect?Oe/(2*Math.tan(.5*F.fovX)*F.aspect):Fe/(2*Math.tan(.5*F.fovY)*F.aspect)}_cameraForBoundsOnGlobe(Ae,Oe,Fe,Ve,qe,pt){const vt=Ae.clone(),zt=this._extendCameraOptions(pt);vt.bearing=Ve,vt.pitch=qe;const ri=F.bO.convert(Oe),xi=F.bO.convert(Fe),bi=.5*(ri.lat+xi.lat),wi=.5*(ri.lng+xi.lng),dr=F.dC(bi,wi),jr=F.ab.vec3.normalize([],dr),Qr=F.ab.vec3.normalize([],F.ab.vec3.cross([],jr,[0,1,0])),Xn=F.ab.vec3.cross([],Qr,jr),ho=[Qr[0],Qr[1],Qr[2],0,Xn[0],Xn[1],Xn[2],0,jr[0],jr[1],jr[2],0,0,0,0,1],yo=[dr,F.dC(ri.lat,ri.lng),F.dC(xi.lat,ri.lng),F.dC(xi.lat,xi.lng),F.dC(ri.lat,xi.lng),F.dC(bi,ri.lng),F.dC(bi,xi.lng),F.dC(ri.lat,wi),F.dC(xi.lat,wi)];let zo=F.cd.fromPoints(yo.map((Ae=>[F.ab.vec3.dot(Qr,Ae),F.ab.vec3.dot(Xn,Ae),F.ab.vec3.dot(jr,Ae)])));const ko=F.ab.vec3.transformMat4([],zo.center,ho);0===F.ab.vec3.squaredLength(ko)&&F.ab.vec3.set(ko,0,0,1),F.ab.vec3.normalize(ko,ko),F.ab.vec3.scale(ko,ko,F.ax),vt.center=F.dD(ko);const Uo=vt.getWorldToCameraMatrix(),ia=F.ab.mat4.invert(new Float64Array(16),Uo);zo=F.cd.applyTransform(zo,F.ab.mat4.multiply([],Uo,ho));const _a=this._extendAABB(zo,vt,zt,Ve);if(!_a)return void F.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");zo=_a,F.ab.vec3.transformMat4(ko,ko,Uo);const Ma=.5*(zo.max[2]-zo.min[2]),Ea=this._minimumAABBFrustumDistance(vt,zo),Ia=F.ab.vec3.scale([],[0,0,1],Ma),rl=F.ab.vec3.add(Ia,ko,Ia),Sl=Ea+(0===vt.pitch?0:F.ab.vec3.distance(ko,rl)),Il=vt.globeCenterInViewSpace,Kl=F.ab.vec3.sub([],ko,[Il[0],Il[1],Il[2]]);F.ab.vec3.normalize(Kl,Kl),F.ab.vec3.scale(Kl,Kl,Sl);const Jl=F.ab.vec3.add([],ko,Kl);F.ab.vec3.transformMat4(Jl,Jl,ia);const Ql=F.ds/F.ax,ec=F.ab.vec3.length(Jl),tc=F.bH(Math.max(ec*Ql-F.ds,Number.EPSILON),0),cc=Math.min(vt.zoomFromMercatorZAdjusted(tc),zt.maxZoom);return cc>.5*(F.c6+F.bY)?(vt.setProjection({name:"mercator"}),vt.zoom=cc,this._cameraForBounds(vt,Oe,Fe,Ve,qe,pt)):{center:vt.center,zoom:cc,bearing:Ve,pitch:qe}}_extendAABB(Ae,Oe,Fe,Ve){const qe=.5*((Fe.padding.left||0)+(Fe.padding.right||0)),pt=.5*((Fe.padding.top||0)+(Fe.padding.bottom||0)),vt=pt,zt=qe,ri=qe,xi=pt,bi=Oe.width-(zt+ri),wi=Oe.height-(vt+xi),dr=F.ab.vec3.sub([],Ae.max,Ae.min),jr=Math.min(bi/dr[0],wi/dr[1]),Qr=Math.min(Oe.scaleZoom(Oe.scale*jr),Fe.maxZoom);if(isNaN(Qr))return null;const Xn=Oe.scale/Oe.zoomScale(Qr),ho=new F.cd([Ae.min[0]-zt*Xn,Ae.min[1]-xi*Xn,Ae.min[2]],[Ae.max[0]+ri*Xn,Ae.max[1]+vt*Xn,Ae.max[2]]),yo=("number"==typeof Fe.offset.x&&"number"==typeof Fe.offset.y?new F.P(Fe.offset.x,Fe.offset.y):F.P.convert(Fe.offset)).rotate(-F.ai(Ve));return ho.center[0]-=yo.x*Xn,ho.center[1]+=yo.y*Xn,ho}queryTerrainElevation(Ae,Oe){const Fe=this.transform.elevation;return Fe?(Oe=F.l({},{exaggerated:!0},Oe),Fe.getAtPoint(F.aa.fromLngLat(Ae),null,Oe.exaggerated)):null}_cameraForBounds(Ae,Oe,Fe,Ve,qe,pt){if("globe"===Ae.projection.name)return this._cameraForBoundsOnGlobe(Ae,Oe,Fe,Ve,qe,pt);const vt=Ae.clone(),zt=this._extendCameraOptions(pt);vt.bearing=Ve,vt.pitch=qe;const ri=F.bO.convert(Oe),xi=F.bO.convert(Fe),bi=new F.bO(ri.lng,xi.lat),wi=new F.bO(xi.lng,ri.lat),dr=vt.project(ri),jr=vt.project(xi),Qr=this.queryTerrainElevation(ri),Xn=this.queryTerrainElevation(xi),ho=this.queryTerrainElevation(bi),yo=this.queryTerrainElevation(wi),zo=[[dr.x,dr.y,Math.min(Qr||0,Xn||0,ho||0,yo||0)],[jr.x,jr.y,Math.max(Qr||0,Xn||0,ho||0,yo||0)]];let ko=F.cd.fromPoints(zo);const Uo=vt.getWorldToCameraMatrix(),ia=F.ab.mat4.invert(new Float64Array(16),Uo);ko=F.cd.applyTransform(ko,Uo);const _a=this._extendAABB(ko,vt,zt,Ve);if(!_a)return void F.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ko=_a;const Ma=.5*F.ab.vec3.sub([],ko.max,ko.min)[2],Ea=this._minimumAABBFrustumDistance(vt,ko),Ia=[0,0,1,0];F.ab.vec4.transformMat4(Ia,Ia,Uo),F.ab.vec4.normalize(Ia,Ia);const rl=F.ab.vec3.scale([],Ia,Ea+Ma),Sl=F.ab.vec3.add([],ko.center,rl);F.ab.vec3.transformMat4(ko.center,ko.center,ia),F.ab.vec3.transformMat4(Sl,Sl,ia);const Il=vt.unproject(new F.P(ko.center[0],ko.center[1])),Kl=F.dE(vt.projection,Il),Jl=Math.pow(2,Kl),Ql=Math.min(vt._zoomFromMercatorZ(Sl[2]*vt.pixelsPerMeter*Jl/vt.worldSize),zt.maxZoom);return vt.mercatorFromTransition&&Ql<.5*(F.c6+F.bY)?(vt.setProjection({name:"globe"}),vt.zoom=Ql,this._cameraForBounds(vt,Oe,Fe,Ve,qe,pt)):{center:Il,zoom:Ql,bearing:Ve,pitch:qe}}fitBounds(F,Ae,Oe){const Fe=this.cameraForBounds(F,Ae);return this._fitInternal(Fe,Ae,Oe)}fitScreenCoordinates(Ae,Oe,Fe,Ve,qe){const pt=F.P.convert(Ae),vt=F.P.convert(Oe),zt=new F.P(Math.min(pt.x,vt.x),Math.min(pt.y,vt.y)),ri=new F.P(Math.max(pt.x,vt.x),Math.max(pt.y,vt.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(pt,vt))return this;const xi=this.transform.pointLocation3D(zt),bi=this.transform.pointLocation3D(ri),wi=this.transform.pointLocation3D(new F.P(zt.x,ri.y)),dr=this.transform.pointLocation3D(new F.P(ri.x,zt.y)),jr=[Math.min(xi.lng,bi.lng,wi.lng,dr.lng),Math.min(xi.lat,bi.lat,wi.lat,dr.lat)],Qr=[Math.max(xi.lng,bi.lng,wi.lng,dr.lng),Math.max(xi.lat,bi.lat,wi.lat,dr.lat)],Xn=Ve&&Ve.pitch?Ve.pitch:this.getPitch(),ho=this._cameraForBounds(this.transform,jr,Qr,Fe,Xn,Ve);return this._fitInternal(ho,Ve,qe)}_fitInternal(Ae,Oe,Fe){return Ae?(Oe=F.l(Ae,Oe)).linear?this.easeTo(Oe,Fe):this.flyTo(Oe,Fe):this}jumpTo(Ae,Oe){this.stop();const Fe=Ae.preloadOnly?this.transform.clone():this.transform;let Ve=!1,qe=!1,pt=!1;"zoom"in Ae&&Fe.zoom!==+Ae.zoom&&(Ve=!0,Fe.zoom=+Ae.zoom),void 0!==Ae.center&&(Fe.center=F.bO.convert(Ae.center)),"bearing"in Ae&&Fe.bearing!==+Ae.bearing&&(qe=!0,Fe.bearing=+Ae.bearing),"pitch"in Ae&&Fe.pitch!==+Ae.pitch&&(pt=!0,Fe.pitch=+Ae.pitch);const vt="number"==typeof Ae.padding?this._extendPadding(Ae.padding):Ae.padding;if(null!=Ae.padding&&!Fe.isPaddingEqual(vt))if(!1===Ae.retainPadding){const F=Fe.clone();F.padding=vt,Fe.setLocationAtPoint(Fe.center,F.centerPoint)}else Fe.padding=vt;return Ae.preloadOnly?(this._preloadTiles(Fe),this):(this.fire(new F.z("movestart",Oe)).fire(new F.z("move",Oe)),Ve&&this.fire(new F.z("zoomstart",Oe)).fire(new F.z("zoom",Oe)).fire(new F.z("zoomend",Oe)),qe&&this.fire(new F.z("rotatestart",Oe)).fire(new F.z("rotate",Oe)).fire(new F.z("rotateend",Oe)),pt&&this.fire(new F.z("pitchstart",Oe)).fire(new F.z("pitch",Oe)).fire(new F.z("pitchend",Oe)),this.fire(new F.z("moveend",Oe)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||F.w(ff),this.transform.getFreeCameraOptions()}setFreeCameraOptions(Ae,Oe){const Fe=this.transform;if(!Fe.projection.supportsFreeCamera)return F.w(ff),this;this.stop();const Ve=Fe.zoom,qe=Fe.pitch,pt=Fe.bearing;Fe.setFreeCameraOptions(Ae);const vt=Ve!==Fe.zoom,zt=qe!==Fe.pitch,ri=pt!==Fe.bearing;return this.fire(new F.z("movestart",Oe)).fire(new F.z("move",Oe)),vt&&this.fire(new F.z("zoomstart",Oe)).fire(new F.z("zoom",Oe)).fire(new F.z("zoomend",Oe)),ri&&this.fire(new F.z("rotatestart",Oe)).fire(new F.z("rotate",Oe)).fire(new F.z("rotateend",Oe)),zt&&this.fire(new F.z("pitchstart",Oe)).fire(new F.z("pitch",Oe)).fire(new F.z("pitchend",Oe)),this.fire(new F.z("moveend",Oe)),this}easeTo(Ae,Oe){this._stop(!1,Ae.easeId),(!1===(Ae=F.l({offset:[0,0],duration:500,easing:F.dA},Ae)).animate||this._prefersReducedMotion(Ae))&&(Ae.duration=0);const Fe=this.transform,Ve=this.getZoom(),qe=this.getBearing(),pt=this.getPitch(),vt=this.getPadding(),zt="zoom"in Ae?+Ae.zoom:Ve,ri="bearing"in Ae?this._normalizeBearing(Ae.bearing,qe):qe,xi="pitch"in Ae?+Ae.pitch:pt,bi=this._extendPadding(Ae.padding),wi=F.P.convert(Ae.offset);let dr,jr,Qr;if("globe"===Fe.projection.name){const Oe=F.aa.fromLngLat(Fe.center),Ve=wi.rotate(-Fe.angle);Oe.x+=Ve.x/Fe.worldSize,Oe.y+=Ve.y/Fe.worldSize;const qe=Oe.toLngLat(),pt=F.bO.convert(Ae.center||qe);this._normalizeCenter(pt),dr=Fe.centerPoint.add(Ve),jr=new F.P(Oe.x,Oe.y).mult(Fe.worldSize),Qr=new F.P(F.at(pt.lng),F.aA(pt.lat)).mult(Fe.worldSize).sub(jr)}else{dr=Fe.centerPoint.add(wi);const Oe=Fe.pointLocation(dr),Ve=F.bO.convert(Ae.center||Oe);this._normalizeCenter(Ve),jr=Fe.project(Oe),Qr=Fe.project(Ve).sub(jr)}const Xn=Fe.zoomScale(zt-Ve);let ho,yo;Ae.around&&(ho=F.bO.convert(Ae.around),yo=Fe.locationPoint(ho));const zo=this._zooming||zt!==Ve,ko=this._rotating||qe!==ri,Uo=this._pitching||xi!==pt,ia=!Fe.isPaddingEqual(bi),_a=!1===Ae.retainPadding?Fe.clone():Fe,E=Fe=>Ma=>{if(zo&&(Fe.zoom=F.af(Ve,zt,Ma)),ko&&(Fe.bearing=F.af(qe,ri,Ma)),Uo&&(Fe.pitch=F.af(pt,xi,Ma)),ia&&(_a.interpolatePadding(vt,bi,Ma),dr=_a.centerPoint.add(wi)),ho)Fe.setLocationAtPoint(ho,yo);else{const F=Fe.zoomScale(Fe.zoom-Ve),Ae=zt>Ve?Math.min(2,Xn):Math.max(.5,Xn),Oe=Math.pow(Ae,1-Ma),qe=Fe.unproject(jr.add(Qr.mult(Ma*Oe)).mult(F));Fe.setLocationAtPoint(Fe.renderWorldCopies?qe.wrap():qe,dr)}return Ae.preloadOnly||this._fireMoveEvents(Oe),Fe};if(Ae.preloadOnly){const F=this._emulate(E,Ae.duration,Fe);return this._preloadTiles(F),this}const Ma={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=zo,this._rotating=ko,this._pitching=Uo,this._padding=ia,this._easeId=Ae.easeId,this._prepareEase(Oe,Ae.noMoveStart,Ma),this._ease(E(Fe),(F=>{"sea"===Fe.cameraElevationReference&&Fe.recenterOnTerrain(),this._afterEase(Oe,F)}),Ae),this}_prepareEase(Ae,Oe,Fe={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),Oe||Fe.moving||this.fire(new F.z("movestart",Ae)),this._zooming&&!Fe.zooming&&this.fire(new F.z("zoomstart",Ae)),this._rotating&&!Fe.rotating&&this.fire(new F.z("rotatestart",Ae)),this._pitching&&!Fe.pitching&&this.fire(new F.z("pitchstart",Ae))}_fireMoveEvents(Ae){this.fire(new F.z("move",Ae)),this._zooming&&this.fire(new F.z("zoom",Ae)),this._rotating&&this.fire(new F.z("rotate",Ae)),this._pitching&&this.fire(new F.z("pitch",Ae))}_afterEase(Ae,Oe){if(this._easeId&&Oe&&this._easeId===Oe)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const Fe=this._zooming,Ve=this._rotating,qe=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,Fe&&this.fire(new F.z("zoomend",Ae)),Ve&&this.fire(new F.z("rotateend",Ae)),qe&&this.fire(new F.z("pitchend",Ae)),this.fire(new F.z("moveend",Ae))}flyTo(Ae,Oe){if(this._prefersReducedMotion(Ae)){const Fe=F.ay(Ae,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Fe,Oe)}this.stop(),Ae=F.l({offset:[0,0],speed:1.2,curve:1.42,easing:F.dA},Ae);const Fe=this.transform,Ve=this.getZoom(),qe=this.getBearing(),pt=this.getPitch(),vt=this.getPadding(),zt="zoom"in Ae?F.aw(+Ae.zoom,Fe.minZoom,Fe.maxZoom):Ve,ri="bearing"in Ae?this._normalizeBearing(Ae.bearing,qe):qe,xi="pitch"in Ae?+Ae.pitch:pt,bi=this._extendPadding(Ae.padding),wi=Fe.zoomScale(zt-Ve),dr=F.P.convert(Ae.offset);let jr=Fe.centerPoint.add(dr);const Qr=Fe.pointLocation(jr),Xn=F.bO.convert(Ae.center||Qr);this._normalizeCenter(Xn);const ho=Fe.project(Qr),yo=Fe.project(Xn).sub(ho);let zo=Ae.curve;const ko=Math.max(Fe.width,Fe.height),Uo=ko/wi,ia=yo.mag();if("minZoom"in Ae){const Oe=F.aw(Math.min(Ae.minZoom,Ve,zt),Fe.minZoom,Fe.maxZoom),qe=ko/Fe.zoomScale(Oe-Ve);zo=Math.sqrt(qe/ia*2)}const _a=zo*zo;function E(F){const Ae=(Uo*Uo-ko*ko+(F?-1:1)*_a*_a*ia*ia)/(2*(F?Uo:ko)*_a*ia);return Math.log(Math.sqrt(Ae*Ae+1)-Ae)}function S(F){return(Math.exp(F)-Math.exp(-F))/2}function C(F){return(Math.exp(F)+Math.exp(-F))/2}const Ma=E(0);let R=function(F){return C(Ma)/C(Ma+zo*F)},D=function(F){return ko*((C(Ma)*(S(Ae=Ma+zo*F)/C(Ae))-S(Ma))/_a)/ia;var Ae},Ea=(E(1)-Ma)/zo;if(Math.abs(ia)<1e-6||!isFinite(Ea)){if(Math.abs(ko-Uo)<1e-6)return this.easeTo(Ae,Oe);const F=Uo<ko?-1:1;Ea=Math.abs(Math.log(Uo/ko))/zo,D=function(){return 0},R=function(Ae){return Math.exp(F*zo*Ae)}}Ae.duration="duration"in Ae?+Ae.duration:1e3*Ea/("screenSpeed"in Ae?+Ae.screenSpeed/zo:+Ae.speed),Ae.maxDuration&&Ae.duration>Ae.maxDuration&&(Ae.duration=0);const Ia=qe!==ri,rl=xi!==pt,Sl=!Fe.isPaddingEqual(bi),Il=!1===Ae.retainPadding?Fe.clone():Fe,O=Fe=>wi=>{const Qr=wi*Ea,zo=1/R(Qr);Fe.zoom=1===wi?zt:Ve+Fe.scaleZoom(zo),Ia&&(Fe.bearing=F.af(qe,ri,wi)),rl&&(Fe.pitch=F.af(pt,xi,wi)),Sl&&(Il.interpolatePadding(vt,bi,wi),jr=Il.centerPoint.add(dr));const ko=1===wi?Xn:Fe.unproject(ho.add(yo.mult(D(Qr))).mult(zo));return Fe.setLocationAtPoint(Fe.renderWorldCopies?ko.wrap():ko,jr),Fe._updateCameraOnTerrain(),Ae.preloadOnly||this._fireMoveEvents(Oe),Fe};if(Ae.preloadOnly){const F=this._emulate(O,Ae.duration,Fe);return this._preloadTiles(F),this}return this._zooming=!0,this._rotating=Ia,this._pitching=rl,this._padding=Sl,this._prepareEase(Oe,!1),this._ease(O(Fe),(()=>this._afterEase(Oe)),Ae),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(F){}_cancelRenderFrame(F){}_stop(F,Ae){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const F=this._onEaseEnd;this._onEaseEnd=void 0,F.call(this,Ae)}if(!F){const F=this.handlers;F&&F.stop(!1)}return this}_ease(Ae,Oe,Fe){!1===Fe.animate||0===Fe.duration?(Ae(1),Oe()):(this._easeStart=F.q.now(),this._easeOptions=Fe,this._onEaseFrame=Ae,this._onEaseEnd=Oe,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const Ae=Math.min((F.q.now()-this._easeStart)/this._easeOptions.duration,1),Oe=this._onEaseFrame;Oe&&Oe(this._easeOptions.easing(Ae)),Ae<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(Ae,Oe){Ae=F.bF(Ae,-180,180);const Fe=Math.abs(Ae-Oe);return Math.abs(Ae-360-Oe)<Fe&&(Ae-=360),Math.abs(Ae+360-Oe)<Fe&&(Ae+=360),Ae}_normalizeCenter(F){const Ae=this.transform;if(Ae.maxBounds)return;if("globe"!==Ae.projection.name&&!Ae.renderWorldCopies)return;const Oe=F.lng-Ae.center.lng;F.lng+=Oe>180?-360:Oe<-180?360:0}_prefersReducedMotion(Ae){return this._respectPrefersReducedMotion&&F.q.prefersReducedMotion&&!(Ae&&Ae.essential)}_emulate(F,Ae,Oe){const Fe=Math.ceil(15*Ae/1e3),Ve=[],qe=F(Oe.clone());for(let F=0;F<=Fe;F++){const Ae=qe(F/Fe);Ve.push(Ae.clone())}return Ve}_preloadTiles(F,Ae){}}class Yn{constructor(Ae={}){this.options=Ae,F.aP(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(F){const Ae=this.options&&this.options.compact,Oe=F._getUIString("AttributionControl.ToggleAttribution");this._map=F,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=l("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",Oe);const Fe=l("span","mapboxgl-ctrl-icon",this._compactButton);return Fe.setAttribute("aria-hidden","true"),Fe.setAttribute("title",Oe),this._innerContainer=l("div","mapboxgl-ctrl-attrib-inner",this._container),Ae&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===Ae&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let Ae=this._editLink;Ae||(Ae=this._editLink=this._container.querySelector(".mapbox-improve-map"));const Oe=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||F.e.ACCESS_TOKEN}];if(Ae){const Fe=Oe.reduce(((F,Ae,Fe)=>(Ae.value&&(F+=`${Ae.key}=${Ae.value}${Fe<Oe.length-1?"&":""}`),F)),"?");Ae.href=`${F.e.FEEDBACK_URL}/${Fe}#${Ja(this._map,!0)}`,Ae.rel="noopener nofollow"}}_updateData(F){!F||"metadata"!==F.sourceDataType&&"visibility"!==F.sourceDataType&&"style"!==F.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let F=[];if(this._map.style.stylesheet){const F=this._map.style.stylesheet;this.styleOwner=F.owner,this.styleId=F.id}const Ae=this._map.style._mergedSourceCaches;for(const Oe in Ae){const Fe=Ae[Oe];if(Fe.used){const Ae=Fe.getSource();Ae.attribution&&F.indexOf(Ae.attribution)<0&&F.push(Ae.attribution)}}F.sort(((F,Ae)=>F.length-Ae.length)),F=F.filter(((Ae,Oe)=>{for(let Fe=Oe+1;Fe<F.length;Fe++)if(F[Fe].indexOf(Ae)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?F=[...this.options.customAttribution,...F]:F.unshift(this.options.customAttribution));const Oe=F.join(" | ");Oe!==this._attribHTML&&(this._attribHTML=Oe,F.length?(this._innerContainer.innerHTML=Oe,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Jn{constructor(){F.aP(["_updateLogo","_updateCompact"],this)}onAdd(F){this._map=F,this._container=l("div","mapboxgl-ctrl");const Ae=l("a","mapboxgl-ctrl-logo");return Ae.target="_blank",Ae.rel="noopener nofollow",Ae.href="https://www.mapbox.com/",Ae.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),Ae.setAttribute("rel","noopener nofollow"),this._container.appendChild(Ae),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(F){F&&"metadata"!==F.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const F=this._map.style._sourceCaches;if(0===Object.entries(F).length)return!0;for(const Ae in F){const Oe=F[Ae].getSource();if(Oe.hasOwnProperty("mapbox_logo")&&!Oe.mapbox_logo)return!1}return!0}_updateCompact(){const F=this._container.children;if(F.length){const Ae=F[0];this._map.getCanvasContainer().offsetWidth<250?Ae.classList.add("mapboxgl-compact"):Ae.classList.remove("mapboxgl-compact")}}}class Qn{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(F){const Ae=++this._id;return this._queue.push({callback:F,id:Ae,cancelled:!1}),Ae}remove(F){const Ae=this._currentlyRunning,Oe=Ae?this._queue.concat(Ae):this._queue;for(const Ae of Oe)if(Ae.id===F)return void(Ae.cancelled=!0)}run(F=0){const Ae=this._currentlyRunning=this._queue;this._queue=[];for(const Oe of Ae)if(!Oe.cancelled&&(Oe.callback(F),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class el{constructor(F){this.jumpTo(F)}getValue(Ae){if(Ae<=this._startTime)return this._start;if(Ae>=this._endTime)return this._end;const Oe=F.cB((Ae-this._startTime)/(this._endTime-this._startTime));return this._start*(1-Oe)+this._end*Oe}isEasing(F){return F>=this._startTime&&F<=this._endTime}jumpTo(F){this._startTime=-1/0,this._endTime=-1/0,this._start=F,this._end=F}easeTo(F,Ae,Oe){this._start=this.getValue(Ae),this._end=F,this._startTime=Ae,this._endTime=Ae+Oe}}const gf={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class il extends F.z{constructor(F,Ae,Oe,Fe){const{point:Ve,lngLat:qe,originalEvent:pt,target:vt}=F;super(F.type,{point:Ve,lngLat:qe,originalEvent:pt,target:vt}),this.preventDefault=()=>{F.preventDefault()},this.id=Ae,this.interaction=Oe,this.feature=Fe}}class ol{constructor(F){this.map=F,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(Ae,Oe){if(this.typeById.has(Ae))throw new Error(`Interaction id "${Ae}" already exists.`);const Fe=Oe.filter;let Ve=Oe.type;Fe&&this.filters.set(Ae,F.aZ(Fe)),"mouseover"===Ve&&(Ve="mouseenter"),"mouseout"===Ve&&(Ve="mouseleave");const qe=this.interactionsByType.get(Ve)||new Map;"mouseenter"===Ve||"mouseleave"===Ve?(0===this.delegatedInteractions.size&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(Ae,Oe)):0===qe.size&&this.map.on(Ve,this.handleType),0===qe.size&&this.interactionsByType.set(Ve,qe),qe.set(Ae,Oe),this.typeById.set(Ae,Ve)}get(F){const Ae=this.typeById.get(F);if(!Ae)return;const Oe=this.interactionsByType.get(Ae);return Oe?Oe.get(F):void 0}remove(F){const Ae=this.typeById.get(F);if(!Ae)return;this.typeById.delete(F),this.filters.delete(F);const Oe=this.interactionsByType.get(Ae);Oe&&(Oe.delete(F),"mouseenter"===Ae||"mouseleave"===Ae?(this.delegatedInteractions.delete(F),0===this.delegatedInteractions.size&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):0===Oe.size&&this.map.off(Ae,this.handleType))}queryTargets(F,Ae){const Oe=[];for(const[F,Fe]of Ae)Fe.target&&Oe.push({targetId:F,target:Fe.target,filter:this.filters.get(F)});return this.map.style.queryRenderedTargets(F,Oe,this.map.transform)}handleMove(F){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const Ae=this.queryTargets(F.point,Array.from(this.delegatedInteractions).reverse());Ae.length&&(F.type="mouseenter",this.handleType(F,Ae));const Oe=new Map;for(const[F,{feature:Ae}]of this.prevHoveredFeatures)this.hoveredFeatures.has(F)||Oe.set(Ae.id,Ae);Oe.size&&(F.type="mouseleave",this.handleType(F,Array.from(Oe.values())))}handleOut(F){const Ae=Array.from(this.hoveredFeatures.values()).map((({feature:F})=>F));Ae.length&&(F.type="mouseleave",this.handleType(F,Ae)),this.hoveredFeatures.clear()}handleType(Ae,Oe){const Fe=Array.from(this.interactionsByType.get(Ae.type)).reverse(),Ve=!!Oe;Oe=Oe||this.queryTargets(Ae.point,Fe);const qe="mouseenter"===Ae.type;let pt=!1;const vt=new Set;for(const zt of Oe){for(const[Oe,ri]of Fe){if(!ri.target)continue;const Fe=zt.variants?zt.variants[Oe]:null;if(Fe){for(const xi of Fe){if(nt(xi,zt,vt,Oe))continue;const Fe=new F.cw(zt,xi),bi=at(xi,zt,Oe);Ve&&(Fe.state=this.map.getFeatureState(Fe));const wi=qe?this.prevHoveredFeatures.get(bi):null,dr=new il(Ae,Oe,ri,Fe),jr=wi?wi.stop:ri.handler(dr);if(qe&&this.hoveredFeatures.set(bi,{feature:zt,stop:jr}),!1!==jr){pt=!0;break}}if(pt)break}}if(pt)break}if(!pt)for(const[F,Oe]of Fe){const{handler:Fe,target:Ve}=Oe;if(!Ve&&!1!==Fe(new il(Ae,F,Oe,null)))break}}}function sl(Ae,Oe){if(Array.isArray(Ae)&&Array.isArray(Oe)){const F=new Set(Ae),Fe=new Set(Oe);return F.size===Fe.size&&Ae.every((F=>Fe.has(F)))}return F.bn(Ae,Oe)}const xf={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},wf={showCompass:!0,showZoom:!0,visualizePitch:!1};class nl{constructor(Ae,Oe,Fe=!1){this._clickTolerance=10,this.element=Oe,this.mouseRotate=new bn({clickTolerance:Ae.dragRotate._mouseRotate._clickTolerance}),this.map=Ae,Fe&&(this.mousePitch=new wn({clickTolerance:Ae.dragRotate._mousePitch._clickTolerance})),F.aP(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),Oe.addEventListener("mousedown",this.mousedown),Oe.addEventListener("touchstart",this.touchstart,{passive:!1}),Oe.addEventListener("touchmove",this.touchmove),Oe.addEventListener("touchend",this.touchend),Oe.addEventListener("touchcancel",this.reset)}down(F,Ae){this.mouseRotate.mousedown(F,Ae),this.mousePitch&&this.mousePitch.mousedown(F,Ae),_()}move(F,Ae){const Oe=this.map,Fe=this.mouseRotate.mousemoveWindow(F,Ae),Ve=Fe&&Fe.bearingDelta;if(Ve&&Oe.setBearing(Oe.getBearing()+Ve),this.mousePitch){const Fe=this.mousePitch.mousemoveWindow(F,Ae),Ve=Fe&&Fe.pitchDelta;Ve&&Oe.setPitch(Oe.getPitch()+Ve)}}off(){const F=this.element;F.removeEventListener("mousedown",this.mousedown),F.removeEventListener("touchstart",this.touchstart,{passive:!1}),F.removeEventListener("touchmove",this.touchmove),F.removeEventListener("touchend",this.touchend),F.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){p(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(Ae){this.down(F.l({},Ae,{ctrlKey:!0,preventDefault:()=>Ae.preventDefault()}),g(this.element,Ae)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(F){this.move(F,g(this.element,F))}mouseup(F){this.mouseRotate.mouseupWindow(F),this.mousePitch&&this.mousePitch.mouseupWindow(F),this.offTemp()}touchstart(F){1!==F.targetTouches.length?this.reset():(this._startPos=this._lastPos=v(this.element,F.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>F.preventDefault()},this._startPos))}touchmove(F){1!==F.targetTouches.length?this.reset():(this._lastPos=v(this.element,F.targetTouches)[0],this.move({preventDefault:()=>F.preventDefault()},this._lastPos))}touchend(F){0===F.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function ll(Ae,Oe,Fe){if(Ae=new F.bO(Ae.lng,Ae.lat),Oe){const Ve=new F.bO(Ae.lng-360,Ae.lat),qe=new F.bO(Ae.lng+360,Ae.lat),pt=360*Math.ceil(Math.abs(Ae.lng-Fe.center.lng)/360),vt=Fe.locationPoint(Ae).distSqr(Oe),zt=Oe.x<0||Oe.y<0||Oe.x>Fe.width||Oe.y>Fe.height;Fe.locationPoint(Ve).distSqr(Oe)<vt&&(zt||Math.abs(Ve.lng-Fe.center.lng)<pt)?Ae=Ve:Fe.locationPoint(qe).distSqr(Oe)<vt&&(zt||Math.abs(qe.lng-Fe.center.lng)<pt)&&(Ae=qe)}for(;Math.abs(Ae.lng-Fe.center.lng)>180;){const F=Fe.locationPoint(Ae);if(F.x>=0&&F.y>=0&&F.x<=Fe.width&&F.y<=Fe.height)break;Ae.lng>Fe.center.lng?Ae.lng-=360:Ae.lng+=360}return Ae}const Mf={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class hl extends F.E{constructor(Ae,Oe){if(super(),(Ae instanceof HTMLElement||Oe)&&(Ae=F.l({element:Ae},Oe)),F.aP(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=Ae&&Ae.anchor||"center",this._color=Ae&&Ae.color||"#3FB1CE",this._scale=Ae&&Ae.scale||1,this._draggable=Ae&&Ae.draggable||!1,this._clickTolerance=Ae&&Ae.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=Ae&&Ae.rotation||0,this._rotationAlignment=Ae&&Ae.rotationAlignment||"auto",this._pitchAlignment=Ae&&Ae.pitchAlignment&&Ae.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=Ae&&Ae.occludedOpacity||.2,Ae&&Ae.element)this._element=Ae.element,this._offset=F.P.convert(Ae&&Ae.offset||[0,0]);else{this._defaultMarker=!0,this._element=l("div");const Oe=41,Fe=27,Ve=c("svg",{display:"block",height:Oe*this._scale+"px",width:Fe*this._scale+"px",viewBox:`0 0 ${Fe} ${Oe}`},this._element),qe=c("radialGradient",{id:"shadowGradient"},c("defs",{},Ve));c("stop",{offset:"10%","stop-opacity":.4},qe),c("stop",{offset:"100%","stop-opacity":.05},qe),c("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},Ve),c("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},Ve),c("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},Ve),c("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},Ve),this._offset=F.P.convert(Ae&&Ae.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(F=>{F.preventDefault()})),this._element.addEventListener("mousedown",(F=>{F.preventDefault()}));const Fe=this._element.classList;for(const F in Mf)Fe.remove(`mapboxgl-marker-anchor-${F}`);Fe.add(`mapboxgl-marker-anchor-${this._anchor}`);const Ve=Ae&&Ae.className?Ae.className.trim().split(/\s+/):[];Fe.add(...Ve),this._popup=null}addTo(F){return F===this._map||(this.remove(),this._map=F,F.getCanvasContainer().appendChild(this._element),F.on("move",this._updateMoving),F.on("moveend",this._update),F.on("remove",this._clearFadeTimer),F._addMarker(this),this.setDraggable(this._draggable),this._update(),F.on("click",this._onMapClick)),this}remove(){const F=this._map;return F&&(F.off("click",this._onMapClick),F.off("move",this._updateMoving),F.off("moveend",this._update),F.off("mousedown",this._addDragHandler),F.off("touchstart",this._addDragHandler),F.off("mouseup",this._onUp),F.off("touchend",this._onUp),F.off("mousemove",this._onMove),F.off("touchmove",this._onMove),F.off("remove",this._clearFadeTimer),F._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(Ae){return this._lngLat=F.bO.convert(Ae),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(F){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),F){if(!("offset"in F.options)){const Ae=38.1,Oe=13.5,Fe=Math.sqrt(Math.pow(Oe,2)/2);F.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-Ae],"bottom-left":[Fe,-1*(Ae-Oe+Fe)],"bottom-right":[-Fe,-1*(Ae-Oe+Fe)],left:[Oe,-1*(Ae-Oe)],right:[-Oe,-1*(Ae-Oe)]}:this._offset}this._popup=F,F._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(F){const Ae=F.code,Oe=F.charCode||F.keyCode;"Space"!==Ae&&"Enter"!==Ae&&32!==Oe&&13!==Oe||this.togglePopup()}_onMapClick(F){const Ae=F.originalEvent.target,Oe=this._element;this._popup&&(Ae===Oe||Oe.contains(Ae))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const F=this._popup;return F?(F.isOpen()?(F.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(F.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const F=this._map,Ae=this._pos;if(!F||!Ae)return!1;const Oe=F.unproject(Ae),Fe=F.getFreeCameraOptions();if(!Fe.position)return!1;const Ve=Fe.position.toLngLat();return Ve.distanceTo(Oe)<.9*Ve.distanceTo(this._lngLat)}_evaluateOpacity(){const Ae=this._map;if(!Ae)return;const Oe=this._pos;if(!Oe||Oe.x<0||Oe.x>Ae.transform.width||Oe.y<0||Oe.y>Ae.transform.height)return void this._clearFadeTimer();const Fe=Ae.unproject(Oe);let Ve;Ae._showingGlobe()&&F.dH(Ae.transform,this._lngLat)?Ve=0:(Ve=1-Ae._queryFogOpacity(Fe),Ae.transform._terrainEnabled()&&Ae.getTerrain()&&this._behindTerrain()&&(Ve*=this._occludedOpacity)),this._element.style.opacity=`${Ve}`,this._element.style.pointerEvents=Ve>0?"auto":"none",this._popup&&this._popup._setOpacity(Ve),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const F=this._pos;if(!F||!this._map)return;const Ae=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${F.x}px,${F.y}px)\n            ${Mf[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${Ae.x}px,${Ae.y}px)\n        `}_calculateXYTransform(){const Ae=this._pos,Oe=this._map,Fe=this.getPitchAlignment();if(!Oe||!Ae||"map"!==Fe)return"";if(!Oe._showingGlobe()){const F=Oe.getPitch();return F?`rotateX(${F}deg)`:""}const Ve=F.c4(F.dI(Oe.transform,this._lngLat)),qe=Ae.sub(F.dJ(Oe.transform)),pt=Math.abs(qe.x)+Math.abs(qe.y);if(0===pt)return"";const vt=Ve/pt;return`rotateX(${-qe.y*vt}deg) rotateY(${qe.x*vt}deg)`}_calculateZTransform(){const Ae=this._pos,Oe=this._map;if(!Oe||!Ae)return"";let Fe=0;const Ve=this.getRotationAlignment();if("map"===Ve)if(Oe._showingGlobe()){const Ae=Oe.project(new F.bO(this._lngLat.lng,this._lngLat.lat+.001)),Ve=Oe.project(new F.bO(this._lngLat.lng,this._lngLat.lat-.001)).sub(Ae);Fe=F.c4(Math.atan2(Ve.y,Ve.x))-90}else Fe=-Oe.getBearing();else if("horizon"===Ve){const Ve=F.ac(4,6,Oe.getZoom()),qe=F.dJ(Oe.transform);qe.y+=Ve*Oe.transform.height;const pt=Ae.sub(qe),vt=F.c4(Math.atan2(pt.y,pt.x));Fe=(vt>90?vt-270:vt+90)*(1-Ve)}return Fe+=this._rotation,Fe?`rotateZ(${Fe}deg)`:""}_update(F){cancelAnimationFrame(this._updateFrameId);const Ae=this._map;Ae&&(Ae.transform.renderWorldCopies&&(this._lngLat=ll(this._lngLat,this._pos,Ae.transform)),this._pos=Ae.project(this._lngLat),!0===F?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),Ae._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(Ae._showingGlobe()||Ae.getTerrain()||Ae.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(Ae){return this._offset=F.P.convert(Ae),this._update(),this}addClassName(F){return this._element.classList.add(F),this}removeClassName(F){return this._element.classList.remove(F),this}toggleClassName(F){return this._element.classList.toggle(F)}_onMove(Ae){const Oe=this._map;if(!Oe)return;const Fe=this._pointerdownPos,Ve=this._positionDelta;if(Fe&&Ve){if(!this._isDragging){const F=this._clickTolerance||Oe._clickTolerance;if(Ae.point.dist(Fe)<F)return;this._isDragging=!0}this._pos=Ae.point.sub(Ve),this._lngLat=Oe.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new F.z("dragstart"))),this.fire(new F.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const Ae=this._map;Ae&&(Ae.off("mousemove",this._onMove),Ae.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new F.z("dragend")),this._state="inactive"}_addDragHandler(F){const Ae=this._map,Oe=this._pos;Ae&&Oe&&this._element.contains(F.originalEvent.target)&&(F.preventDefault(),this._positionDelta=F.point.sub(Oe),this._pointerdownPos=F.point,this._state="pending",Ae.on("mousemove",this._onMove),Ae.on("touchmove",this._onMove),Ae.once("mouseup",this._onUp),Ae.once("touchend",this._onUp))}setDraggable(F){this._draggable=!!F;const Ae=this._map;return Ae&&(F?(Ae.on("mousedown",this._addDragHandler),Ae.on("touchstart",this._addDragHandler)):(Ae.off("mousedown",this._addDragHandler),Ae.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(F){return this._rotation=F||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(F){return this._rotationAlignment=F||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(F){return this._pitchAlignment=F||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(F){return this._occludedOpacity=F||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const qf={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Hf={maxWidth:100,unit:"metric"},Wf={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},Yf={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Jf=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function ml(Ae=new F.P(0,0),Oe="bottom"){if("number"==typeof Ae){const Fe=Math.round(Math.sqrt(.5*Math.pow(Ae,2)));switch(Oe){case"top":return new F.P(0,Ae);case"top-left":return new F.P(Fe,Fe);case"top-right":return new F.P(-Fe,Fe);case"bottom":return new F.P(0,-Ae);case"bottom-left":return new F.P(Fe,-Fe);case"bottom-right":return new F.P(-Fe,-Fe);case"left":return new F.P(Ae,0);case"right":return new F.P(-Ae,0)}return new F.P(0,0)}return Ae instanceof F.P||Array.isArray(Ae)?F.P.convert(Ae):F.P.convert(Ae[Oe]||[0,0])}const em={version:Ae,supported:pt.supported,setRTLTextPlugin:F.dK,getRTLTextPluginStatus:F.dL,Map:class extends Kn{constructor(Ae){Fe.mark(Oe.create);const Ve=Ae;if(null!=(Ae=F.l({},xf,Ae)).minZoom&&null!=Ae.maxZoom&&Ae.minZoom>Ae.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=Ae.minPitch&&null!=Ae.maxPitch&&Ae.minPitch>Ae.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=Ae.minPitch&&Ae.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=Ae.maxPitch&&Ae.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(Ae.antialias&&F.dF(window)&&(Ae.antialias=!1,F.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Qi(Ae.minZoom,Ae.maxZoom,Ae.minPitch,Ae.maxPitch,Ae.renderWorldCopies),Ae),this._repaint=!!Ae.repaint,this._interactive=Ae.interactive,this._minTileCacheSize=Ae.minTileCacheSize,this._maxTileCacheSize=Ae.maxTileCacheSize,this._failIfMajorPerformanceCaveat=Ae.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=Ae.preserveDrawingBuffer,this._antialias=Ae.antialias,this._trackResize=Ae.trackResize,this._bearingSnap=Ae.bearingSnap,this._refreshExpiredTiles=Ae.refreshExpiredTiles,this._fadeDuration=Ae.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=Ae.crossSourceCollisions,this._collectResourceTiming=Ae.collectResourceTiming,this._language=this._parseLanguage(Ae.language),this._worldview=Ae.worldview,this._renderTaskQueue=new Qn,this._domRenderTaskQueue=new Qn,this._controls=[],this._markers=[],this._popups=[],this._mapId=F.aV(),this._locale=F.l({},gf,Ae.locale),this._clickTolerance=Ae.clickTolerance,this._cooperativeGestures=Ae.cooperativeGestures,this._performanceMetricsCollection=Ae.performanceMetricsCollection,this._tessellationStep=Ae.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=Ae.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new el(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=Ae.scaleFactor,this._requestManager=new T(Ae.transformRequest,Ae.accessToken,Ae.testMode),this._silenceAuthErrors=!!Ae.testMode,this._contextCreateOptions=Ae.contextCreateOptions?Object.assign({},Ae.contextCreateOptions):{},"string"==typeof Ae.container){const F=document.getElementById(Ae.container);if(!F)throw new Error(`Container '${Ae.container.toString()}' not found.`);this._container=F}else{if(!(Ae.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=Ae.container}if(this._container.childNodes.length>0&&F.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),Ae.maxBounds&&this.setMaxBounds(Ae.maxBounds),this._spriteFormat=Ae.spriteFormat,F.aP(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Oa),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},(()=>{this.setScaleFactor(this._scaleFactor)})),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new $n(this,Ae),this._localFontFamily=Ae.localFontFamily,this._localIdeographFontFamily=Ae.localIdeographFontFamily,(Ae.style||!Ae.testMode)&&this.setStyle(Ae.style||F.e.DEFAULT_STYLE,{config:Ae.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),Ae.projection&&this.setProjection(Ae.projection),this.indoor=new po(this),Ae.hash&&(this._hash=new Ya("string"==typeof Ae.hash&&Ae.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==Ve.center&&null==Ve.zoom||(this.transform._unmodified=!1),this.jumpTo({center:Ae.center,zoom:Ae.zoom,bearing:Ae.bearing,pitch:Ae.pitch});const Oe=Ae.bounds;Oe&&(this.resize(),this.fitBounds(Oe,F.l({},Ae.fitBoundsOptions,{duration:0})))}this.resize(),Ae.attributionControl&&this.addControl(new Yn({customAttribution:Ae.customAttribution})),this._logoControl=new Jn,this.addControl(this._logoControl,Ae.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()})),this.on("data",(Ae=>{this._update("style"===Ae.dataType),this.fire(new F.z(`${Ae.dataType}data`,Ae))})),this.on("dataloading",(Ae=>{this.fire(new F.z(`${Ae.dataType}dataloading`,Ae))})),this._interactions=new ol(this)}_getMapId(){return this._mapId}addControl(Ae,Oe){if(void 0===Oe&&(Oe=Ae.getDefaultPosition?Ae.getDefaultPosition():"top-right"),!Ae||!Ae.onAdd)return this.fire(new F.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const Fe=Ae.onAdd(this);this._controls.push(Ae);const Ve=this._controlPositions[Oe];return-1!==Oe.indexOf("bottom")?Ve.insertBefore(Fe,Ve.firstChild):Ve.appendChild(Fe),this}removeControl(Ae){if(!Ae||!Ae.onRemove)return this.fire(new F.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const Oe=this._controls.indexOf(Ae);return Oe>-1&&this._controls.splice(Oe,1),Ae.onRemove(this),this}hasControl(F){return this._controls.indexOf(F)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(Ae){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const Oe=!this._moving;return Oe&&this.fire(new F.z("movestart",Ae)).fire(new F.z("move",Ae)),this.fire(new F.z("resize",Ae)),Oe&&this.fire(new F.z("moveend",Ae)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(Ae){return this.transform.setMaxBounds(F.az.convert(Ae)),this._update()}setMinZoom(Ae){if((Ae=Ae??-2)>=-2&&Ae<=this.transform.maxZoom)return this.transform.minZoom=Ae,this._update(),this.getZoom()<Ae?this.setZoom(Ae):this.fire(new F.z("zoomstart")).fire(new F.z("zoom")).fire(new F.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(Ae){if((Ae=Ae??22)>=this.transform.minZoom)return this.transform.maxZoom=Ae,this._update(),this.getZoom()>Ae?this.setZoom(Ae):this.fire(new F.z("zoomstart")).fire(new F.z("zoom")).fire(new F.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(Ae){if((Ae=Ae??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(Ae>=0&&Ae<=this.transform.maxPitch)return this.transform.minPitch=Ae,this._update(),this.getPitch()<Ae?this.setPitch(Ae):this.fire(new F.z("pitchstart")).fire(new F.z("pitch")).fire(new F.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(Ae){if((Ae=Ae??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(Ae>=this.transform.minPitch)return this.transform.maxPitch=Ae,this._update(),this.getPitch()>Ae?this.setPitch(Ae):this.fire(new F.z("pitchstart")).fire(new F.z("pitch")).fire(new F.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(F){return this._scaleFactor=F,this.painter.scaleFactor=F,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers((F=>"symbol"===F.type)),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(F){return this.transform.renderWorldCopies=F,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(F){return"auto"===F?navigator.language:Array.isArray(F)?0===F.length?void 0:F.map((F=>"auto"===F?navigator.language:F)):F}setLanguage(F){const Ae=this._parseLanguage(F);if(!this.style||Ae===this._language)return this;this._language=Ae,this.style.reloadSources();for(const F of this._controls)F._setLanguage&&F._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(F){return this.style&&F!==this._worldview?(this._worldview=F,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(F){return this._lazyInitEmptyStyle(),F?"string"==typeof F&&(F={name:F}):F=null,this._useExplicitProjection=!!F,this._prioritizeAndUpdateProjection(F,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const Ae=this.transform,Oe=Ae.projection.name;let Fe;"globe"===Oe&&Ae.zoom>=F.bY?(Ae.setMercatorFromTransition(),Fe=!0):"mercator"===Oe&&Ae.zoom<F.bY&&(Ae.setProjection({name:"globe"}),Fe=!0),Fe&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(F,Ae){return this._updateProjection(F||Ae||{name:"mercator"})}_updateProjection(Ae){let Oe;return Oe="globe"===Ae.name&&this.transform.zoom>=F.bY?this.transform.setMercatorFromTransition():this.transform.setProjection(Ae),this.style.applyProjectionUpdate(),Oe&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(Ae){return this.transform.locationPoint3D(F.bO.convert(Ae))}unproject(Ae){return this.transform.pointLocation3D(F.P.convert(Ae))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(F,Ae,Oe){const o=F=>{let Oe=[];if(Array.isArray(Ae)){const Fe=Ae.filter((F=>this.getLayer(F)));Oe=Fe.length?this.queryRenderedFeatures(F,{layers:Fe}):[]}else Oe=this.queryRenderedFeatures(F,{target:Ae});return Oe};if("mouseenter"===F||"mouseover"===F){let Fe=!1;const r=Ae=>{const Ve=o(Ae.point);Ve.length?Fe||(Fe=!0,Oe.call(this,new ln(F,this,Ae.originalEvent,{features:Ve}))):Fe=!1};return{listener:Oe,targets:Ae,delegates:{mousemove:r,mouseout:()=>{Fe=!1}}}}if("mouseleave"===F||"mouseout"===F){let Fe=!1;const r=Ae=>{o(Ae.point).length?Fe=!0:Fe&&(Fe=!1,Oe.call(this,new ln(F,this,Ae.originalEvent)))},a=Ae=>{Fe&&(Fe=!1,Oe.call(this,new ln(F,this,Ae.originalEvent)))};return{listener:Oe,targets:Ae,delegates:{mousemove:r,mouseout:a}}}{const s=F=>{const Ae=o(F.point);Ae.length&&(F.features=Ae,Oe.call(this,F),delete F.features)};return{listener:Oe,targets:Ae,delegates:{[F]:s}}}}on(F,Ae,Oe){if("function"==typeof Ae||void 0===Oe)return super.on(F,Ae);if("string"==typeof Ae&&(Ae=[Ae]),!this._areTargetsValid(Ae))return this;const Fe=this._createDelegatedListener(F,Ae,Oe);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[F]=this._delegatedListeners[F]||[],this._delegatedListeners[F].push(Fe);for(const F in Fe.delegates)this.on(F,Fe.delegates[F]);return this}once(F,Ae,Oe){if("function"==typeof Ae||void 0===Oe)return super.once(F,Ae);if("string"==typeof Ae&&(Ae=[Ae]),!this._areTargetsValid(Ae))return this;const Fe=this._createDelegatedListener(F,Ae,Oe);for(const F in Fe.delegates)this.once(F,Fe.delegates[F]);return this}off(F,Ae,Oe){if("function"==typeof Ae||void 0===Oe)return super.off(F,Ae);if("string"==typeof Ae&&(Ae=[Ae]),!this._areTargetsValid(Ae))return this;const Fe=this._delegatedListeners?this._delegatedListeners[F]:void 0;return Fe&&(F=>{for(let Fe=0;Fe<F.length;Fe++){const Ve=F[Fe];if(Ve.listener===Oe&&sl(Ve.targets,Ae)){for(const F in Ve.delegates)this.off(F,Ve.delegates[F]);return F.splice(Fe,1),this}}})(Fe),this}queryRenderedFeatures(Ae,Oe){if(!this.style)return[];if(void 0===Ae||Ae instanceof F.P||Array.isArray(Ae)||void 0!==Oe||(Oe=Ae,Ae=void 0),Ae=Ae||[[0,0],[this.transform.width,this.transform.height]],!Oe){const F=this.style.queryRenderedFeatures(Ae,void 0,this.transform),Oe=this.style.queryRenderedFeatureset(Ae,void 0,this.transform);return F.concat(Oe)}let Fe=!0;if(Oe.target&&(Fe=this._isTargetValid(Oe.target),Fe&&!Oe.layers))return this.style.queryRenderedFeatureset(Ae,Oe,this.transform);let Ve=!0;if(Oe.layers&&Array.isArray(Oe.layers)){for(const F of Oe.layers)if(!this._isValidId(F)){Ve=!1;break}if(Ve&&!Oe.target)return this.style.queryRenderedFeatures(Ae,Oe,this.transform)}let qe=[];return Ve&&(qe=qe.concat(this.style.queryRenderedFeatures(Ae,Oe,this.transform))),Fe&&(qe=qe.concat(this.style.queryRenderedFeatureset(Ae,Oe,this.transform))),qe}querySourceFeatures(F,Ae){return!F||"string"==typeof F&&!this._isValidId(F)?[]:this.style.querySourceFeatures(F,Ae)}isPointOnSurface(Ae){const{name:Oe}=this.transform.projection;return"globe"!==Oe&&"mercator"!==Oe&&F.w(`${Oe} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(F.P.convert(Ae))}addInteraction(F,Ae){return this._interactions.add(F,Ae),this}removeInteraction(F){return this._interactions.remove(F),this}setStyle(Ae,Oe){return Oe=F.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},Oe),this.style&&Ae&&!1!==Oe.diff&&Oe.localFontFamily===this._localFontFamily&&Oe.localIdeographFontFamily===this._localIdeographFontFamily&&!Oe.config?(this.style._diffStyle(Ae,((Fe,Ve)=>{Fe?(F.w(`Unable to perform style diff: ${String(Fe.message||Fe.error||Fe)}. Rebuilding the style from scratch.`),this._updateStyle(Ae,Oe)):Ve&&this._update(!0)}),(()=>{this._postStyleLoadEvent()})),this):(this._localIdeographFontFamily=Oe.localIdeographFontFamily,this._localFontFamily=Oe.localFontFamily,this._updateStyle(Ae,Oe))}_getUIString(F){const Ae=this._locale[F];if(null==Ae)throw new Error(`Missing UI string '${F}'`);return Ae}_updateStyle(Ae,Oe){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),Ae){const Fe=F.l({},Oe);Oe&&Oe.config&&(Fe.initialConfig=Oe.config,delete Fe.config),this.style=new To(this,Fe).load(Ae),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new To(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(F.w("There is no style added to the map."),!1)}_isValidId(Ae){return null==Ae?(this.fire(new F.y(new Error("IDs can't be empty."))),!1):!F.cr(Ae)||(this.fire(new F.y(new Error(`IDs can't contain special symbols: "${Ae}".`))),!1)}_isTargetValid(F){return"featuresetId"in F?this._isValidId("importId"in F?F.importId:F.featuresetId):"layerId"in F&&this._isValidId(F.layerId)}_areTargetsValid(F){if(Array.isArray(F)){for(const Ae of F)if(!this._isValidId(Ae))return!1;return!0}return this._isTargetValid(F)}addSource(F,Ae){return this._isValidId(F)?(this._lazyInitEmptyStyle(),this.style.addSource(F,Ae),this._update(!0)):this}isSourceLoaded(F){return!!this._isValidId(F)&&!!this.style&&this.style._isSourceCacheLoaded(F)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(F,Ae,Oe){this._lazyInitEmptyStyle(),this.style.addSourceType(F,Ae,Oe)}removeSource(F){return this._isValidId(F)?(this.style.removeSource(F),this._updateTerrain(),this._update(!0)):this}getSource(F){return this._isValidId(F)?this.style.getOwnSource(F):null}addImage(Ae,Oe,{pixelRatio:Fe=1,sdf:Ve=!1,stretchX:qe,stretchY:pt,content:vt}={}){if(this._lazyInitEmptyStyle(),Oe instanceof HTMLImageElement||ImageBitmap&&Oe instanceof ImageBitmap){const{width:zt,height:ri,data:xi}=F.q.getImageData(Oe);this.style.addImage(Ae,{data:new F.r({width:zt,height:ri},xi),pixelRatio:Fe,stretchX:qe,stretchY:pt,content:vt,sdf:Ve,version:0,usvg:!1})}else if(void 0===Oe.width||void 0===Oe.height)this.fire(new F.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:zt,height:ri}=Oe,xi=Oe;this.style.addImage(Ae,{data:new F.r({width:zt,height:ri},new Uint8Array(xi.data)),pixelRatio:Fe,stretchX:qe,stretchY:pt,content:vt,sdf:Ve,usvg:!1,version:0,userImage:xi}),xi.onAdd&&xi.onAdd(this,Ae)}}updateImage(Ae,Oe){this._lazyInitEmptyStyle();const Fe=this.style.getImage(Ae);if(!Fe)return void this.fire(new F.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const Ve=Oe instanceof HTMLImageElement||ImageBitmap&&Oe instanceof ImageBitmap?F.q.getImageData(Oe):Oe,{width:qe,height:pt,data:vt}=Ve;if(void 0===qe||void 0===pt)return void this.fire(new F.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(qe!==(Fe.usvg?Fe.icon.usvg_tree.width:Fe.data.width)||pt!==(Fe.usvg?Fe.icon.usvg_tree.height:Fe.data.height))return void this.fire(new F.y(new Error(`The width and height of the updated image (${qe}, ${pt})\n                must be that same as the previous version of the image\n                (${Fe.data.width}, ${Fe.data.height})`)));const zt=!(Oe instanceof HTMLImageElement||ImageBitmap&&Oe instanceof ImageBitmap);let ri=!1;Fe.usvg?(Fe.data=new F.r({width:qe,height:pt},new Uint8Array(vt)),Fe.usvg=!1,Fe.icon=void 0,ri=!0):Fe.data.replace(vt,zt),this.style.updateImage(Ae,Fe,ri)}hasImage(Ae){return Ae?!!this.style&&!!this.style.getImage(Ae):(this.fire(new F.y(new Error("Missing required image id"))),!1)}removeImage(F){this.style.removeImage(F)}loadImage(Ae,Oe){F.o(this._requestManager.transformRequest(Ae,F.R.Image),((Ae,Fe)=>{Oe(Ae,Fe instanceof HTMLImageElement?F.q.getImageData(Fe):Fe)}))}listImages(){return this.style.listImages()}addModel(F,Ae){this._lazyInitEmptyStyle(),this.style.addModel(F,Ae)}hasModel(Ae){return Ae?this.style.hasModel(Ae):(this.fire(new F.y(new Error("Missing required model id"))),!1)}removeModel(F){this.style.removeModel(F)}listModels(){return this.style.listModels()}addLayer(F,Ae){return this._isValidId(F.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(F,Ae),this._update(!0)):this}getSlot(F){const Ae=this.getLayer(F);return Ae&&Ae.slot||null}setSlot(F,Ae){return this.style.setSlot(F,Ae),this.style.mergeLayers(),this._update(!0)}addImport(F,Ae){return this.style.addImport(F,Ae),this}updateImport(F,Ae){return"string"!=typeof Ae&&Ae.id!==F?(this.removeImport(F),this.addImport(Ae)):(this.style.updateImport(F,Ae),this._update(!0))}removeImport(F){return this.style.removeImport(F),this}moveImport(F,Ae){return this.style.moveImport(F,Ae),this._update(!0)}moveLayer(F,Ae){return this._isValidId(F)?(this.style.moveLayer(F,Ae),this._update(!0)):this}removeLayer(F){return this._isValidId(F)?(this.style.removeLayer(F),this._update(!0)):this}getLayer(F){if(!this._isValidId(F))return null;const Ae=this.style.getOwnLayer(F);return Ae?"custom"===Ae.type?Ae.implementation:Ae.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(F,Ae,Oe){return this._isValidId(F)?(this.style.setLayerZoomRange(F,Ae,Oe),this._update(!0)):this}setFilter(F,Ae,Oe={}){return this._isValidId(F)?(this.style.setFilter(F,Ae,Oe),this._update(!0)):this}getFilter(F){return this._isValidId(F)?this.style.getFilter(F):null}setPaintProperty(F,Ae,Oe,Fe={}){return this._isValidId(F)?(this.style.setPaintProperty(F,Ae,Oe,Fe),this._update(!0)):this}getPaintProperty(F,Ae){return this._isValidId(F)?this.style.getPaintProperty(F,Ae):null}setLayoutProperty(F,Ae,Oe,Fe={}){return this._isValidId(F)?(this.style.setLayoutProperty(F,Ae,Oe,Fe),this._update(!0)):this}getLayoutProperty(F,Ae){return this._isValidId(F)?this.style.getLayoutProperty(F,Ae):null}getSchema(F){return this.style.getSchema(F)}setSchema(F,Ae){return this.style.setSchema(F,Ae),this._update(!0)}getConfig(F){return this.style.getConfig(F)}setConfig(F,Ae){return this.style.setConfig(F,Ae),this._update(!0)}getConfigProperty(F,Ae){return this.style.getConfigProperty(F,Ae)}setConfigProperty(F,Ae,Oe){return this.style.setConfigProperty(F,Ae,Oe),this._update(!0)}getFeaturesetDescriptors(F){return this.style.getFeaturesetDescriptors(F)}setLights(F){if(this._lazyInitEmptyStyle(),F&&1===F.length&&"flat"===F[0].type){const Ae=F[0];Ae.properties?this.style.setFlatLight(Ae.properties,Ae.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(F),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const F=this.style.getLights()||[];return 0===F.length&&F.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),F}setLight(F,Ae={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:F}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(F){return this._lazyInitEmptyStyle(),!F&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(F),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(F){return this._lazyInitEmptyStyle(),this.style.setFog(F),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(F){return this._lazyInitEmptyStyle(),this.style.setSnow(F),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(F){return this._lazyInitEmptyStyle(),this.style.setRain(F),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(F){return this._lazyInitEmptyStyle(),this.style.setColorTheme(F),this._update(!0)}setImportColorTheme(F,Ae){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(F,Ae),this._update(!0)}setCamera(F){return this.style.setCamera(F),this._triggerCameraUpdate(F)}_triggerCameraUpdate(F){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===F["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(Ae){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(F.bO.convert(Ae),this.transform):0}setFeatureState(F,Ae){return F.source&&!this._isValidId(F.source)?this:(this.style.setFeatureState(F,Ae),this._update())}removeFeatureState(F,Ae){return F.source&&!this._isValidId(F.source)?this:(this.style.removeFeatureState(F,Ae),this._update())}getFeatureState(F){return F.source&&!this._isValidId(F.source)?null:this.style.getFeatureState(F)}_updateContainerDimensions(){if(!this._container)return;const F=this._container.getBoundingClientRect().width||400,Ae=this._container.getBoundingClientRect().height||300;let Oe,Fe,Ve,qe=this._container;for(;qe&&(!Fe||!Ve);){const F=window.getComputedStyle(qe).transform;F&&"none"!==F&&(Oe=F.match(/matrix.*\((.+)\)/)[1].split(", "),Oe[0]&&"0"!==Oe[0]&&"1"!==Oe[0]&&(Fe=Oe[0]),Oe[3]&&"0"!==Oe[3]&&"1"!==Oe[3]&&(Ve=Oe[3])),qe=qe.parentElement}this._containerWidth=Fe?Math.abs(F/Fe):F,this._containerHeight=Ve?Math.abs(Ae/Ve):Ae}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&F.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const F=this._container;F.classList.add("mapboxgl-map"),(this._missingCSSCanary=l("div","mapboxgl-canary",F)).style.visibility="hidden",this._detectMissingCSS();const Ae=this._canvasContainer=l("div","mapboxgl-canvas-container",F);this._canvas=l("canvas","mapboxgl-canvas",Ae),this._interactive&&(Ae.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const Oe=this._controlContainer=l("div","mapboxgl-control-container",F),Fe=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((F=>{Fe[F]=l("div",`mapboxgl-ctrl-${F}`,Oe)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(Ae,Oe){const Fe=F.q.devicePixelRatio||1;this._canvas.width=Fe*Math.ceil(Ae),this._canvas.height=Fe*Math.ceil(Oe),this._canvas.style.width=`${Ae}px`,this._canvas.style.height=`${Oe}px`}_addMarker(F){this._markers.push(F)}_removeMarker(F){const Ae=this._markers.indexOf(F);-1!==Ae&&this._markers.splice(Ae,1)}_addPopup(F){this._popups.push(F)}_removePopup(F){const Ae=this._popups.indexOf(F);-1!==Ae&&this._popups.splice(Ae,1)}_setupPainter(){const Ae=F.l({},pt.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),Oe=this._canvas.getContext("webgl2",Ae);Oe?(j(Oe,!0),this.painter=new Xa(Oe,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",(F=>{"source"===F.dataType&&this.painter.setTileLoadedFlag(!0)})),F.m.testSupport(Oe)):this.fire(new F.y(new Error("Failed to initialize WebGL")))}_contextLost(Ae){Ae.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new F.z("webglcontextlost",{originalEvent:Ae}))}_contextRestored(Ae){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style.reloadModels(),this.style.clearSources(),this._update(),this.fire(new F.z("webglcontextrestored",{originalEvent:Ae}))}_onMapScroll(F){if(F.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(F){return this.style?(this._styleDirty=this._styleDirty||F,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(F){return this._update(),this._renderTaskQueue.add(F)}_cancelRenderFrame(F){this._renderTaskQueue.remove(F)}_requestDomTask(F){!this.loaded()||this.loaded()&&!this.isMoving()?F():this._domRenderTaskQueue.add(F)}_render(Ae){let Ve;this.fire(new F.z("renderstart")),++this._frameId;const qe=this.painter.context.extTimerQuery,pt=F.q.now(),vt=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(Ve=vt.createQuery(),vt.beginQuery(qe.TIME_ELAPSED_EXT,Ve)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(Ae),this._domRenderTaskQueue.run(Ae),this._removed)return;this._updateProjectionTransition();const zt=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const Ae=this.transform.zoom,Oe=this.transform.pitch,Fe=F.q.now(),Ve=new F.a8(Ae,{now:Fe,fadeDuration:zt,pitch:Oe,transition:this.style.transition});this.style.update(Ve)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let ri=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),ri=this._updateAverageElevation(pt),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):ri=this._updateAverageElevation(pt);const xi=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,zt,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),xi&&(this._placementDirty=xi.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:zt,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new F.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Fe.mark(Oe.load),this.fire(new F.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),Ve){const Ae=F.q.now()-pt;vt.endQuery(qe.TIME_ELAPSED_EXT),setTimeout((()=>{const Oe=vt.getQueryParameter(Ve,vt.QUERY_RESULT)/1e6;vt.deleteQuery(Ve),this.fire(new F.z("gpu-timing-frame",{cpuTime:Ae,gpuTime:Oe}))}),50)}if(this.listens("gpu-timing-layer")){const Ae=this.painter.collectGpuTimers();setTimeout((()=>{const Oe=this.painter.queryGpuTimers(Ae);this.fire(new F.z("gpu-timing-layer",{layerTimes:Oe}))}),50)}if(this.listens("gpu-timing-deferred-render")){const Ae=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const Oe=this.painter.queryGpuTimeDeferredRender(Ae);this.fire(new F.z("gpu-timing-deferred-render",{gpuTime:Oe}))}),50)}const bi=this._sourcesDirty||this._styleDirty||this._placementDirty||ri;if(bi||this._repaint)this.triggerRepaint();else{const Ae=this.idle();if(Ae&&(ri=this._updateAverageElevation(pt,!0)),ri)this.triggerRepaint();else if(this._triggerFrame(!1),Ae&&(this.fire(new F.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const Ae=this._calculateSpeedIndex();this.fire(new F.z("speedindexcompleted",{speedIndex:Ae})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||bi||(this._fullyLoaded=!0,Fe.mark(Oe.fullLoad),this._performanceMetricsCollection&&Uo(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(F){for(const Ae of this._markers)F&&!this.getRenderWorldCopies()&&(Ae._lngLat=Ae._lngLat.wrap()),Ae._update();for(const Ae of this._popups)!F||this.getRenderWorldCopies()||Ae._trackPointer||(Ae._lngLat=Ae._lngLat.wrap()),Ae._update()}_updateAverageElevation(F,Ae=!1){const i=F=>(this.transform.averageElevation=F,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);const Oe=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(Oe||(Ae||F-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(F)){const Ae=this.transform.averageElevation;let Fe=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(Fe)?Fe=0:this._averageElevationLastSampledAt=F;const Ve=Math.abs(Ae-Fe);if(Ve>1){if(this._isInitialLoad||Oe)return this._averageElevation.jumpTo(Fe),i(Fe);this._averageElevation.easeTo(Fe,F,300)}else if(Ve>1e-4)return this._averageElevation.jumpTo(Fe),i(Fe)}return!!this._averageElevation.isEasing(F)&&i(this._averageElevation.getValue(F))}_authenticate(){_a(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(Ae=>{if(Ae&&(Ae.message===bi||401===Ae.status)){const Ae=this.painter.context.gl;j(Ae,!1),this._logoControl instanceof Jn&&this._logoControl._updateLogo(),Ae&&Ae.clear(Ae.DEPTH_BUFFER_BIT|Ae.COLOR_BUFFER_BIT|Ae.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new F.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),ho(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&zo(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const F=this._isDragging();this.painter.updateTerrain(this.style,F)}_calculateSpeedIndex(){const F=this.painter.canvasCopy(),Ae=this.painter.getCanvasCopiesAndTimestamps();Ae.timeStamps.push(performance.now());const Oe=this.painter.context.gl,Fe=Oe.createFramebuffer();function s(F){Oe.framebufferTexture2D(Oe.FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,Oe.TEXTURE_2D,F,0);const Ae=new Uint8Array(Oe.drawingBufferWidth*Oe.drawingBufferHeight*4);return Oe.readPixels(0,0,Oe.drawingBufferWidth,Oe.drawingBufferHeight,Oe.RGBA,Oe.UNSIGNED_BYTE,Ae),Ae}return Oe.bindFramebuffer(Oe.FRAMEBUFFER,Fe),this._canvasPixelComparison(s(F),Ae.canvasCopies.map(s),Ae.timeStamps)}_canvasPixelComparison(F,Ae,Oe){let Fe=Oe[1]-Oe[0];const Ve=F.length/4;for(let qe=0;qe<Ae.length;qe++){const pt=Ae[qe];let vt=0;for(let Ae=0;Ae<pt.length;Ae+=4)pt[Ae]===F[Ae]&&pt[Ae+1]===F[Ae+1]&&pt[Ae+2]===F[Ae+2]&&pt[Ae+3]===F[Ae+3]&&(vt+=1);Fe+=(Oe[qe+2]-Oe[qe+1])*(1-vt/Ve)}return Fe}remove(){this._hash&&this._hash.remove();for(const F of this._controls)F.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const Ae=this.painter.context.gl.getExtension("WEBGL_lose_context");Ae&&Ae.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Ma.delete(this.painter.context.gl),ia.remove(),Xn.remove(),this._removed=!0,this.fire(new F.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(Ae){this._renderNextFrame=this._renderNextFrame||Ae,this.style&&!this._frame&&(this._frame=F.q.frame((F=>{const Ae=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,Ae&&this._render(F)})))}_preloadTiles(Ae){const Oe=this.style?this.style.getSourceCaches():[];return F.bl(Oe,((F,Oe)=>F._preloadTiles(Ae,Oe)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(F){this._trackResize&&this.resize({originalEvent:F})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(F){this._showTileBoundaries!==F&&(this._showTileBoundaries=F,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(F){this._showParseStatus!==F&&(this._showParseStatus=F,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(F){this._showTerrainWireframe!==F&&(this._showTerrainWireframe=F,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(F){this._showLayers2DWireframe!==F&&(this._showLayers2DWireframe=F,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(F){this._showLayers3DWireframe!==F&&(this._showLayers3DWireframe=F,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(F){this._speedIndexTiming!==F&&(this._speedIndexTiming=F,this._update())}get showPadding(){return!!this._showPadding}set showPadding(F){this._showPadding!==F&&(this._showPadding=F,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(F){this._showCollisionBoxes!==F&&(this._showCollisionBoxes=F,this._tp.refreshUI(),F?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(F){this._showOverdrawInspector!==F&&(this._showOverdrawInspector=F,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(F){this._repaint!==F&&(this._repaint=F,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(F){this._vertices=F,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(F){this._showTileAABBs!==F&&(this._showTileAABBs=F,this._tp.refreshUI(),F&&this._update())}_setCacheLimits(Ae,Oe){F.dG(Ae,Oe)}get version(){return Ae}},NavigationControl:class{constructor(Ae={}){this.options=F.l({},wf,Ae),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(F=>F.preventDefault())),this.options.showZoom&&(F.aP(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(F=>{this._map&&this._map.zoomIn({},{originalEvent:F})})),l("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(F=>{this._map&&this._map.zoomOut({},{originalEvent:F})})),l("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(F.aP(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(F=>{const Ae=this._map;Ae&&(this.options.visualizePitch?Ae.resetNorthPitch({},{originalEvent:F}):Ae.resetNorth({},{originalEvent:F}))})),this._compassIcon=l("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const F=this._map;if(!F)return;const Ae=F.getZoom(),Oe=Ae===F.getMaxZoom(),Fe=Ae===F.getMinZoom();this._zoomInButton.disabled=Oe,this._zoomOutButton.disabled=Fe,this._zoomInButton.setAttribute("aria-disabled",Oe.toString()),this._zoomOutButton.setAttribute("aria-disabled",Fe.toString())}_rotateCompassArrow(){const F=this._map;if(!F)return;const Ae=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(F.transform.pitch*(Math.PI/180)),.5)}) rotateX(${F.transform.pitch}deg) rotateZ(${F.transform.angle*(180/Math.PI)}deg)`:`rotate(${F.transform.angle*(180/Math.PI)}deg)`;F._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=Ae)}))}onAdd(F){return this._map=F,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),F.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&F.on("pitch",this._rotateCompassArrow),F.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new nl(F,this._compass,this.options.visualizePitch)),this._container}onRemove(){const F=this._map;F&&(this._container.remove(),this.options.showZoom&&F.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&F.off("pitch",this._rotateCompassArrow),F.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(F,Ae){const Oe=l("button",F,this._container);return Oe.type="button",Oe.addEventListener("click",Ae),Oe}_setButtonTitle(F,Ae){if(!this._map)return;const Oe=this._map._getUIString(`NavigationControl.${Ae}`);F.setAttribute("aria-label",Oe),F.firstElementChild&&F.firstElementChild.setAttribute("title",Oe)}},GeolocateControl:class extends F.E{constructor(Ae={}){super();const Oe=navigator.geolocation;this.options=F.l({geolocation:Oe},qf,Ae),F.aP(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Ka(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(F){return this._map=F,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(F){const t=(Ae=!!this.options.geolocation)=>{this._supportsGeolocation=Ae,F(Ae)};void 0!==this._supportsGeolocation?F(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then((F=>t("denied"!==F.state))).catch((()=>t())):t()}_isOutOfMapMaxBounds(F){const Ae=this._map.getMaxBounds(),Oe=F.coords;return!!Ae&&(Oe.longitude<Ae.getWest()||Oe.longitude>Ae.getEast()||Oe.latitude<Ae.getSouth()||Oe.latitude>Ae.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(Ae){if(this._map){if(this._isOutOfMapMaxBounds(Ae))return this._setErrorState(),this.fire(new F.z("outofmaxbounds",Ae)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=Ae,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(Ae),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(Ae),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new F.z("geolocate",Ae)),this._finish()}}_updateCamera(Ae){const Oe=new F.bO(Ae.coords.longitude,Ae.coords.latitude),Fe=Ae.coords.accuracy,Ve=this._map.getBearing(),qe=F.l({bearing:Ve},this.options.fitBoundsOptions);this._map.fitBounds(Oe.toBounds(Fe),qe,{geolocateSource:!0})}_updateMarker(Ae){if(Ae){const Oe=new F.bO(Ae.coords.longitude,Ae.coords.latitude);this._accuracyCircleMarker.setLngLat(Oe).addTo(this._map),this._userLocationDotMarker.setLngLat(Oe).addTo(this._map),this._accuracy=Ae.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const Ae=this._map.transform,Oe=F.bH(1,Ae._center.lat)*Ae.worldSize,Fe=Math.ceil(2*this._accuracy*Oe);this._circleElement.style.width=`${Fe}px`,this._circleElement.style.height=`${Fe}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(Ae){if(this._map){if(this.options.trackUserLocation)if(1===Ae.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const F=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",F),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",F),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===Ae.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new F.z("error",Ae)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(Ae){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(F=>F.preventDefault())),this._geolocateButton=l("button","mapboxgl-ctrl-geolocate",this._container),l("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===Ae){F.w("Geolocation support is not available so the GeolocateControl will be disabled.");const Ae=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",Ae),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",Ae)}else{const F=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",F),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",F)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=l("div","mapboxgl-user-location"),this._dotElement.appendChild(l("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(l("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new hl({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=l("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new hl({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(Ae=>{Ae.geolocateSource||"ACTIVE_LOCK"!==this._watchState||Ae.originalEvent&&"resize"===Ae.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new F.z("trackuserlocationend")))}))}}_onDeviceOrientation(F){this._userLocationDotMarker&&(F.webkitCompassHeading?this._heading=F.webkitCompassHeading:!0===F.absolute&&(this._heading=-1*F.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return F.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new F.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new F.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new F.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let F;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(F={maximumAge:6e5,timeout:0},this._noTimeout=!0):(F=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,F),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((F=>{"granted"===F&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Yn,ScaleControl:class{constructor(Ae={}){this.options=F.l({},Hf,Ae),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(F){return!1}}(),F.aP(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const F=this.options.maxWidth||100,Ae=this._map,Oe=Ae._containerHeight/2,Fe=Ae._containerWidth/2-F/2,Ve=Ae.unproject([Fe,Oe]),qe=Ae.unproject([Fe+F,Oe]),pt=Ve.distanceTo(qe);if("imperial"===this.options.unit){const Ae=3.2808*pt;Ae>5280?this._setScale(F,Ae/5280,"mile"):this._setScale(F,Ae,"foot")}else"nautical"===this.options.unit?this._setScale(F,pt/1852,"nautical-mile"):pt>=1e3?this._setScale(F,pt/1e3,"kilometer"):this._setScale(F,pt,"meter")}_setScale(F,Ae,Oe){this._map._requestDomTask((()=>{const Fe=function(F){const Ae=Math.pow(10,`${Math.floor(F)}`.length-1);let Oe=F/Ae;return Oe=Oe>=10?10:Oe>=5?5:Oe>=3?3:Oe>=2?2:Oe>=1?1:function(F){const Ae=Math.pow(10,Math.ceil(-Math.log(F)/Math.LN10));return Math.round(F*Ae)/Ae}(Oe),Ae*Oe}(Ae),Ve=Fe/Ae;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==Oe?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:Oe}).format(Fe):`${Fe}&nbsp;${Wf[Oe]}`,this._container.style.width=F*Ve+"px"}))}onAdd(F){return this._map=F,this._language=F.getLanguage(),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-scale",F.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(F){this._language=F,this._update()}setUnit(F){this.options.unit=F,this._update()}},FullscreenControl:class{constructor(Ae={}){this._fullscreen=!1,Ae&&Ae.container&&(Ae.container instanceof HTMLElement?this._container=Ae.container:F.w("Full screen control 'container' must be a DOM element.")),F.aP(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(Ae){return this._map=Ae,this._container||(this._container=this._map.getContainer()),this._controlContainer=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",F.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const F=this._fullscreenButton=l("button","mapboxgl-ctrl-fullscreen",this._controlContainer);l("span","mapboxgl-ctrl-icon",F).setAttribute("aria-hidden","true"),F.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const F=this._getTitle();this._fullscreenButton.setAttribute("aria-label",F),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",F)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends F.E{constructor(Ae){super(),this.options=F.l(Object.create(Yf),Ae),F.aP(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(Ae&&Ae.className?Ae.className.trim().split(/\s+/):[])}addTo(Ae){return this._map&&this.remove(),this._map=Ae,this.options.closeOnClick&&Ae.on("preclick",this._onClose),this.options.closeOnMove&&Ae.on("move",this._onClose),Ae.on("remove",this.remove),this._update(),Ae._addPopup(this),this._focusFirstElement(),this._trackPointer?(Ae.on("mousemove",this._onMouseEvent),Ae.on("mouseup",this._onMouseEvent),Ae._canvasContainer.classList.add("mapboxgl-track-pointer")):Ae.on("move",this._update),this.fire(new F.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const Ae=this._map;return Ae&&(Ae.off("move",this._update),Ae.off("move",this._onClose),Ae.off("preclick",this._onClose),Ae.off("click",this._onClose),Ae.off("remove",this.remove),Ae.off("mousemove",this._onMouseEvent),Ae.off("mouseup",this._onMouseEvent),Ae.off("drag",this._onMouseEvent),Ae._canvasContainer&&Ae._canvasContainer.classList.remove("mapboxgl-track-pointer"),Ae._removePopup(this),this._map=void 0),this.fire(new F.z("close")),this}getLngLat(){return this._lngLat}setLngLat(Ae){this._lngLat=F.bO.convert(Ae),this._pos=null,this._trackPointer=!1,this._update();const Oe=this._map;return Oe&&(Oe.on("move",this._update),Oe.off("mousemove",this._onMouseEvent),Oe._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const F=this._map;return F&&(F.off("move",this._update),F.on("mousemove",this._onMouseEvent),F.on("drag",this._onMouseEvent),F._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(F){return this.setDOMContent(document.createTextNode(F))}setHTML(F){const Ae=document.createDocumentFragment(),Oe=document.createElement("body");let Fe;for(Oe.innerHTML=F;Fe=Oe.firstChild,Fe;)Ae.appendChild(Fe);return this.setDOMContent(Ae)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(F){return this.options.maxWidth=F,this._update(),this}setDOMContent(F){let Ae=this._content;if(Ae)for(;Ae.hasChildNodes();)Ae.firstChild&&Ae.removeChild(Ae.firstChild);else Ae=this._content=l("div","mapboxgl-popup-content",this._container||void 0);if(Ae.appendChild(F),this.options.closeButton){const F=this._closeButton=l("button","mapboxgl-popup-close-button",Ae);F.type="button",F.setAttribute("aria-label","Close popup"),F.innerHTML='<span aria-hidden="true">&#215;</span>',F.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(F){return this._classList.add(F),this._updateClassList(),this}removeClassName(F){return this._classList.delete(F),this._updateClassList(),this}setOffset(F){return this.options.offset=F,this._update(),this}toggleClassName(F){let Ae;return this._classList.delete(F)?Ae=!1:(this._classList.add(F),Ae=!0),this._updateClassList(),Ae}_onMouseEvent(F){this._update(F.point)}_getAnchor(F){if(this.options.anchor)return this.options.anchor;const Ae=this._map,Oe=this._container,Fe=this._pos;if(!Ae||!Oe||!Fe)return"bottom";const Ve=Oe.offsetWidth,qe=Oe.offsetHeight,pt=Fe.x<Ve/2,vt=Fe.x>Ae.transform.width-Ve/2;if(Fe.y+F<qe)return pt?"top-left":vt?"top-right":"top";if(Fe.y>Ae.transform.height-qe){if(pt)return"bottom-left";if(vt)return"bottom-right"}return pt?"left":vt?"right":"bottom"}_updateClassList(){const F=this._container;if(!F)return;const Ae=[...this._classList];Ae.push("mapboxgl-popup"),this._anchor&&Ae.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&Ae.push("mapboxgl-popup-track-pointer"),F.className=Ae.join(" ")}_update(Ae){const Oe=this._map,Fe=this._content;if(!Oe||!this._lngLat&&!this._trackPointer||!Fe)return;let Ve=this._container;if(Ve||(Ve=this._container=l("div","mapboxgl-popup",Oe.getContainer()),this._tip=l("div","mapboxgl-popup-tip",Ve),Ve.appendChild(Fe)),this.options.maxWidth&&Ve.style.maxWidth!==this.options.maxWidth&&(Ve.style.maxWidth=this.options.maxWidth),Oe.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=ll(this._lngLat,this._pos,Oe.transform)),!this._trackPointer||Ae){const Fe=this._pos=this._trackPointer&&Ae instanceof F.P?Ae:Oe.project(this._lngLat),Ve=ml(this.options.offset),qe=this._anchor=this._getAnchor(Ve.y),pt=ml(this.options.offset,qe),vt=Fe.add(pt).round();Oe._requestDomTask((()=>{this._container&&qe&&(this._container.style.transform=`${Mf[qe]} translate(${vt.x}px,${vt.y}px)`)}))}if(!this._marker&&Oe._showingGlobe()){const Ae=F.dH(Oe.transform,this._lngLat)?0:1;this._setOpacity(Ae)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const F=this._container.querySelector(Jf);F&&F.focus()}_onClose(){this.remove()}_setOpacity(F){this._container&&(this._container.style.opacity=`${F}`),this._content&&(this._content.style.pointerEvents=F?"auto":"none")}},Marker:hl,Style:To,LngLat:F.bO,LngLatBounds:F.az,Point:F.P,MercatorCoordinate:F.aa,FreeCameraOptions:Wi,Evented:F.E,config:F.e,prewarm:F.dM,clearPrewarmedResources:F.dN,get accessToken(){return F.e.ACCESS_TOKEN},set accessToken(Ae){F.e.ACCESS_TOKEN=Ae},get baseApiUrl(){return F.e.API_URL},set baseApiUrl(Ae){F.e.API_URL=Ae},get workerCount(){return F.dO.workerCount},set workerCount(Ae){F.dO.workerCount=Ae},get maxParallelImageRequests(){return F.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(Ae){F.e.MAX_PARALLEL_IMAGE_REQUESTS=Ae},clearStorage(Ae){F.dP(Ae)},get workerUrl(){return F.dQ.workerUrl},set workerUrl(Ae){F.dQ.workerUrl=Ae},get workerClass(){return F.dQ.workerClass},set workerClass(Ae){F.dQ.workerClass=Ae},get workerParams(){return F.dQ.workerParams},set workerParams(Ae){F.dQ.workerParams=Ae},get dracoUrl(){return F.dR()},set dracoUrl(Ae){F.dS(Ae)},get meshoptUrl(){return F.dT()},set meshoptUrl(Ae){F.dU(Ae)},setNow:F.q.setNow,restoreNow:F.q.restoreNow};return em}));var Ve=Fe;return Ve}));var Oe=Ae;export{Oe as default};

